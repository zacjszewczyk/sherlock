name: T1048: Exfiltration Over Alternative Protocol
id: 1c2d3e4f-5a6b-4c7d-8e9f-0a1b2c3d4e5f
description: This playbook helps to answer the question, "Is the adversary exfiltrating data using a protocol other than the primary C2 channel?". It focuses on identifying data exfiltration by detecting anomalous network behaviors. Indicators include outbound connections to known malicious destinations, the use of data transfer utilities like certutil.exe or powershell.exe correlated with network activity, unusual DNS or ICMP traffic patterns (such as high-volume TXT queries, high-entropy domain names, or oversized ICMP packets), significant deviations from baselined outbound data volumes, and mismatches between the expected and observed application-layer protocol on well-known ports (e.g., non-DNS traffic on port 53).
type: technique
related:
  - TA0010: Exfiltration
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is an internal asset connecting to or querying a known malicious destination IP or domain?
    context: This question aims to identify direct communication with infrastructure known to be associated with malicious activities such as malware distribution, command and control (C2), or data exfiltration. Matching network traffic against a reputable threat intelligence feed is a high-fidelity method for detecting potential compromises or active threats. A positive match indicates that an internal host is interacting with a destination flagged for malicious behavior, requiring immediate investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Internet Gateway
      - Egress Firewall
      - Corporate DNS Resolvers
      - Cloud Egress Points (e.g., NAT Gateways)
      - Proxy Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN Zeek conn.log destination IPs AND Zeek dns.log queried domains AGAINST threat intelligence feed. ALERT on match.
  - question: Is an internal asset sending an unusually large amount of data to a newly observed destination?
    context: Adversaries often use new or dynamically generated domains and IPs for data exfiltration to evade reputation-based blocking. This question focuses on identifying large data uploads to destinations not previously seen in the network's history. A high ratio of sent-to-received bytes is characteristic of data exfiltration, where data is uploaded with minimal response from the server. By flagging connections with both a large data volume and a high upload/download ratio to a new destination, we can detect potential exfiltration channels that might otherwise be missed.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - Egress Firewall
      - Corporate DNS Resolvers
      - Cloud Egress Points (e.g., NAT Gateways)
      - Proxy Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR new connections to destinations not seen in 30 days, IF sent_bytes > 1MB AND (sent_bytes / received_bytes) is in 99th percentile, THEN ALERT.
  - question: Can machine learning predict if a network connection to an uncategorized destination is likely malicious exfiltration?
    context: This question explores using a predictive model to score the risk of network connections that aren't flagged by traditional signatures or threat intelligence. By training a model on features like connection duration, protocol, byte counts, JA3/JA3S hashes, and domain characteristics, the system can learn the subtle patterns of malicious exfiltration. This allows for the proactive identification of suspicious activity to unknown or uncategorized destinations, providing a layer of defense against novel threats.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - Egress Firewall
      - Corporate DNS Resolvers
      - Cloud Egress Points (e.g., NAT Gateways)
      - Proxy Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY trained classification model to new connections. IF predicted_probability > threshold, THEN ALERT.
  - question: Is a known data transfer utility or script interpreter being used to initiate an outbound network connection to a non-corporate destination?
    context: Adversaries frequently abuse legitimate 'living-off-the-land' binaries (LOLBins) like certutil.exe, bitsadmin.exe, and powershell.exe to download, upload, or execute code. This question seeks to correlate the execution of these tools with command-line arguments indicative of data transfer, followed closely by an outbound network connection from the same host. This temporal correlation strongly suggests that the tool was used for data exfiltration or to retrieve a secondary payload.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - User Workstations
      - Application Servers
      - Domain Controllers
      - Virtual Desktop Infrastructure (VDI)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FIND process creation (certutil, bitsadmin, powershell with upload commands). IF correlated with outbound network connection from same host within 60 seconds, THEN ALERT.
  - question: Is a data transfer utility being executed with an unusually complex or obfuscated command line?
    context: To evade simple keyword-based detections, adversaries may encode or obfuscate the data and commands passed through command-line arguments. High Shannon entropy in a command line is a strong indicator of this, as random-looking or compressed data has higher entropy than plain text. This question aims to baseline the normal complexity of command lines for specific utilities and alert on significant deviations, which could reveal attempts to exfiltrate data or execute obfuscated scripts via command-line parameters.
    answer_sources:
      - Windows Event ID 4688
      - User Workstations
      - Application Servers
      - Domain Controllers
      - Virtual Desktop Infrastructure (VDI)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR executions of curl, certutil, powershell, CALCULATE command-line entropy. IF entropy > (mean + 3 * std_dev), THEN ALERT.
  - question: Is an anomalous sequence of process executions leading to network activity indicative of exfiltration?
    context: Malicious activity often follows a predictable, albeit unusual, chain of events, such as a user document spawning a command shell which then initiates a network connection. This question involves modeling normal process execution sequences and their associated network behaviors to detect deviations. An anomalous chain, like Microsoft Word launching PowerShell to upload data, is a strong indicator of a compromise, likely stemming from a malicious document or macro.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - User Workstations
      - Application Servers
      - Domain Controllers
      - Virtual Desktop Infrastructure (VDI)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL common process execution chains. IF a new chain (e.g., Office -> cmd -> powershell -> network POST) deviates from baseline, THEN ALERT.
  - question: Is an internal host exhibiting DNS or ICMP traffic patterns indicative of tunneling, such as high-frequency TXT queries or oversized ICMP packets?
    context: Adversaries may tunnel data within DNS or ICMP packets to bypass network firewalls that typically permit this traffic. This question looks for two key indicators of this technique a rapid burst of DNS TXT queries to a single domain (used to exfiltrate data in chunks) and ICMP packets with payloads significantly larger than those used for standard network diagnostics. Both are highly anomalous and strong signs of a covert exfiltration channel.
    answer_sources:
      - Zeek dns.log
      - Zeek icmp.log
      - Internal DNS Servers
      - Internet Gateway
      - Network Egress Points
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: IF source sends > 50 DNS TXT queries to one domain in 5 mins, THEN ALERT. IF ICMP packet payload > 128 bytes, THEN ALERT.
  - question: Is a host's DNS query behavior anomalous, showing an unusual distribution of query types or high-entropy domain names?
    context: DNS tunneling often manifests as a statistical anomaly in a host's DNS traffic. This question aims to detect these anomalies by baselining normal behavior. An unusual spike in the proportion of TXT or NULL queries, which are less common in legitimate traffic but ideal for data transfer, is a red flag. Similarly, high-entropy or random-looking subdomain names are characteristic of Domain Generation Algorithms (DGAs) or data encoding within the DNS query itself, both of which are hallmarks of malicious tunneling.
    answer_sources:
      - Zeek dns.log
      - Internal DNS Servers
      - Internet Gateway
      - Network Egress Points
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE DNS query types per host. IF daily TXT/NULL query % > 99th percentile, THEN ALERT. IF subdomain entropy > 3.5, THEN ALERT.
  - question: Can machine learning identify outlier clusters in DNS traffic that correspond to tunneling activity?
    context: This question proposes an unsupervised machine learning approach to find DNS tunneling without pre-existing rules. By clustering DNS requests based on features like query length, entropy, and the mix of query types, normal DNS traffic will form dense clusters. DNS tunneling traffic, with its unique characteristics, will likely form sparse, outlier clusters. This method can uncover novel or sophisticated tunneling techniques that evade threshold-based detections.
    answer_sources:
      - Zeek dns.log
      - Internal DNS Servers
      - Internet Gateway
      - Network Egress Points
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CLUSTER DNS traffic by features (length, entropy, type ratio). INVESTIGATE outlier clusters as potential tunneling.
  - question: Is a client workstation making a large, one-way data upload to an external destination not associated with a known cloud service?
    context: A large, asymmetric data transfer where the amount of data sent far exceeds the data received is a classic sign of bulk data exfiltration. This question focuses on identifying these connections, specifically from client workstations which typically do not perform large data uploads. By setting a high threshold for sent bytes (e.g., >100MB) and a low threshold for received bytes (<1MB), and excluding legitimate services like corporate backups, this query can pinpoint significant and unauthorized data transfers.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek smb_files.log
      - Internet Gateway
      - Core Network Switches
      - Servers Hosting Sensitive Data (e.g., file shares, databases)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FROM client workstations, IF sent_bytes > 100MB AND received_bytes < 1MB AND destination is NOT an approved cloud service, THEN ALERT.
  - question: Has any internal host's daily outbound data volume for a specific protocol or service significantly deviated from its historical baseline?
    context: Adversaries may exfiltrate data over an extended period or use protocols that are common in the environment to blend in. This question aims to detect such activity by establishing a statistical baseline for each host's daily outbound data volume, broken down by protocol (e.g., HTTPS, DNS, SMB). A significant deviation from this established norm (e.g., more than 3 standard deviations) indicates an unusual amount of data is being transferred and warrants investigation, even if the absolute volume isn't massive.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek smb_files.log
      - Internet Gateway
      - Core Network Switches
      - Servers Hosting Sensitive Data (e.g., file shares, databases)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host, CALCULATE baseline daily outbound bytes per service. IF daily total > (mean + 3 * std_dev), THEN ALERT.
  - question: Is a high-value asset exhibiting an un-forecasted spike in outbound data volume?
    context: High-value assets, such as database servers or domain controllers, are prime targets for data theft. This question proposes a more sophisticated monitoring approach for these critical systems using time-series forecasting. By modeling the expected rhythm of outbound traffic on an hourly basis, the system can predict a 'normal' range of data volume. Any observed volume that significantly surpasses the model's prediction (i.e., exceeds the upper confidence bound) is a strong indicator of an anomalous and potentially malicious event, such as a database dump being exfiltrated.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek smb_files.log
      - Internet Gateway
      - Core Network Switches
      - Servers Hosting Sensitive Data (e.g., file shares, databases)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR high-value assets, FORECAST hourly outbound data volume. IF actual volume > forecasted upper confidence bound, THEN ALERT.
  - question: Is there network traffic on a standard port that does not match the expected protocol for that port?
    context: Adversaries often disguise their C2 or exfiltration traffic by running it over common ports like 53 (DNS) or 443 (HTTPS) to bypass restrictive firewall rules. This question uses dynamic protocol detection (DPD) to identify these mismatches. An alert is triggered when the observed application-layer protocol (e.g., SSH) is different from the protocol expected on that port (e.g., HTTPS). A specific, high-confidence check is to find traffic on TCP/443 that is not actually TLS/SSL, which directly points to non-standard protocol usage.
    answer_sources:
      - Zeek conn.log
      - Zeek dpd.log
      - Zeek ssl.log
      - Network Taps/Sensors in the DMZ
      - Internet Gateway
      - Perimeter Firewalls
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ALERT on protocol/analyzer mismatch in dpd.log. ALERT on TCP/443 connections in conn.log that are not in ssl.log.
  - question: Is a rare or never-before-seen application protocol being used on a standard port?
    context: This question aims to detect protocol tunneling by baselining the variety of application protocols (as identified by Zeek's 'service' field) seen on common ports. While some port-protocol mismatches are benign, an adversary using a custom or rare protocol for C2 will appear as a statistical anomaly. By tracking the frequency of each 'service' on a given port over time, we can flag any new connection using a protocol that is exceptionally rare (e.g., <0.01% of historical traffic), suggesting it may be unauthorized.
    answer_sources:
      - Zeek conn.log
      - Network Taps/Sensors in the DMZ
      - Internet Gateway
      - Perimeter Firewalls
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE frequency of services per standard port. IF a new connection uses a service with <0.01% historical frequency on that port, THEN ALERT.
  - question: Can an anomaly detection model distinguish legitimate traffic from tunneled C2 traffic on a specific port like TCP/443?
    context: This question proposes using a one-class classifier, a type of machine learning model ideal for anomaly detection, to identify malicious traffic hiding on a common port. The model is trained exclusively on the characteristics of legitimate traffic for that port (e.g., for TCP/443, features from TLS handshakes, connection duration, packet counts). Any new connection that deviates significantly from this learned 'normal' profile is flagged as an anomaly or outlier. This can effectively detect non-standard traffic, such as a raw TCP socket used for C2, masquerading on a port typically used for encrypted web traffic.
    answer_sources:
      - Zeek conn.log
      - Zeek dpd.log
      - Zeek ssl.log
      - Network Taps/Sensors in the DMZ
      - Internet Gateway
      - Perimeter Firewalls
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN a one-class SVM on legitimate traffic features for a port. USE the model to classify new connections. IF connection is an outlier, THEN ALERT.