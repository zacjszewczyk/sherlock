name: T1137.001: Office Template Macros
id: 5e8f8f0c-1b9c-4e8d-8f2e-1c6a9b4d0e1f
description: This playbook helps investigate whether an adversary is maintaining persistence by abusing Office Template Macros. This involves looking for the creation or modification of malicious Office template files (.dotm, .xltm), unauthorized modifications to registry keys controlling template locations or macro security, suspicious child processes spawned by Office applications (like cmd.exe or powershell.exe), anomalous outbound network connections from Office applications, and correlated sequences of these events occurring in a short time frame on a single host.
type: technique
related:
  - TA0003: Persistence
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a malicious Office template file (.dotm, .xltm) been created or modified based on a known-bad hash?
    context: This question aims to identify the simplest and most direct evidence of this technique: the presence of an Office template file that is already known to be malicious. Matching against a threat intelligence feed of malicious file hashes is a high-confidence way to detect adversaries reusing known tools.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek files.log
      - Sysmon Event ID 11
      - User workstations (specifically %APPDATA%\Microsoft\Templates and %APPDATA%\Microsoft\Excel\XLSTART), File servers hosting shared templates, Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Search for file creation/modification events for .dotm or .xltm files and compare their hash against a known malicious hash list.
  - question: Has there been an anomalous increase in the creation or modification of Office template files on any host?
    context: This question seeks to detect unusual activity by baselining normal behavior. A sudden spike in the creation of template files on a specific host, or by a user who rarely creates them, can indicate that an adversary has established persistence, even if the file itself is not yet known to be malicious.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek files.log
      - Sysmon Event ID 11
      - User workstations (specifically %APPDATA%\Microsoft\Templates and %APPDATA%\Microsoft\Excel\XLSTART), File servers hosting shared templates, Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: For each host, count daily .dotm/.xltm file creations. Compare the count to a historical baseline (e.g., 30-day rolling average) and alert on significant deviations (e.g., >95th percentile).
  - question: Does a newly created Office template file contain features characteristic of malicious macros?
    context: This question uses machine learning to proactively identify potentially malicious templates that are not yet on any hash list. By analyzing file characteristics like the presence of VBA macros, suspicious API calls, and code entropy, this approach can detect novel or obfuscated threats that signature-based methods might miss.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek files.log
      - Sysmon Event ID 11
      - User workstations (specifically %APPDATA%\Microsoft\Templates and %APPDATA%\Microsoft\Excel\XLSTART), File servers hosting shared templates, Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: On new .dotm/.xltm file creation, extract features (macro presence, API calls, entropy) and run through a trained classification model to get a maliciousness score.
  - question: Have any registry keys controlling Office template locations or macro security been modified by an unauthorized process?
    context: Adversaries may modify the registry to point Office applications to a malicious template or to weaken security settings to allow macros to run without warnings. This question focuses on identifying such changes when they are made by processes not associated with legitimate software installation or system administration, which is a strong indicator of malicious activity.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - Windows Registry on all endpoints (user workstations and servers), Group Policy Objects on Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Search for registry modification events for Office template/security keys. Alert if the modifying process is not on an allowlist (e.g., gpupdate.exe, msiexec.exe).
  - question: Has a registry key for Office templates or macro security been set to a rare or unusual value across the enterprise?
    context: This question leverages the power of environmental baselining. A registry value that is extremely rare in the organization is likely not part of a standard configuration. By alerting on these statistical outliers, analysts can uncover unauthorized changes that might otherwise go unnoticed.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - Windows Registry on all endpoints (user workstations and servers), Group Policy Objects on Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Baseline all values for specific Office registry keys across the enterprise. Alert when a modification sets a key to a value that is statistically rare (e.g., present on <1% of hosts).
  - question: Has a registry modification related to Office templates or security occurred that deviates from the learned model of normal administrative activity?
    context: This question applies anomaly detection to registry modifications. A machine learning model is trained on the characteristics of legitimate changes (process, key path, values). Any new modification that falls outside this learned 'normal' boundary is flagged as an outlier, providing a sophisticated way to detect novel or stealthy manipulation techniques.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - Windows Registry on all endpoints (user workstations and servers), Group Policy Objects on Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: For each Office-related registry modification, extract features (process name, key path, values) and check if a one-class SVM model classifies it as an outlier.
  - question: Has an Office application spawned a suspicious child process like a command shell or scripting interpreter?
    context: This is a classic indicator of compromise. Legitimate user activity rarely involves an Office application launching processes like PowerShell or Command Prompt. This question looks for this high-fidelity signal that a malicious macro has executed and is attempting to run commands on the system.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations, remote desktop servers, and virtual desktop infrastructure (VDI) endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Search for process creation events where the parent is an Office application (WINWORD.EXE, etc.) and the child is a suspicious process (cmd.exe, powershell.exe, etc.).
  - question: Has an Office application spawned a child process that is statistically rare or has an unusually complex command line?
    context: Beyond looking for a specific list of bad child processes, this question analyzes the frequency of all child processes and the complexity of their command lines. An Office application spawning a process it has never spawned before, or using a command line with high entropy (a sign of obfuscation), is a strong indicator of malicious macro execution.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations, remote desktop servers, and virtual desktop infrastructure (VDI) endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Baseline child processes for each Office application. Alert on rare child processes or those with high-entropy command lines.
  - question: Has an Office application spawned a child process with a command line that does not fit into any known legitimate activity cluster?
    context: This question uses machine learning to automatically group and identify normal command-line patterns. Any command line that doesn't fit into these established clusters of benign activity is flagged as an outlier. This is effective for detecting novel attack commands that may not be caught by signature-based rules or simple entropy checks.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations, remote desktop servers, and virtual desktop infrastructure (VDI) endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Cluster command lines from Office-spawned child processes. Alert on any new command line that is identified as an outlier by the clustering algorithm.
  - question: Has an Office application made a network connection to a known malicious or suspicious destination?
    context: This question looks for network connections from Office applications to destinations that are inherently suspicious, such as Tor nodes, dynamic DNS domains, or newly registered domains. This is often a sign of a macro attempting to establish a command and control (C2) channel or download a second-stage payload.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Network egress points, DNS resolvers, User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Correlate process and network events. Alert when an Office process connects to an IP/domain on a threat intelligence list (e.g., Tor nodes, DGA, newly registered domains).
  - question: Has an Office application exhibited anomalous network behavior, such as connecting to a new country or transferring an unusual amount of data?
    context: This question establishes a baseline of normal network activity for Office applications and alerts on deviations. A connection to a country or Autonomous System Number (ASN) never seen before, or a session transferring a significantly larger volume of data than usual, can indicate C2 communication or data exfiltration, even if the destination IP is not on a blocklist.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Network egress points, DNS resolvers, User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Baseline network traffic from Office apps (by destination country, ASN, data volume). Alert on connections to new countries/ASNs or on data transfers exceeding historical norms.
  - question: Has the volume of outbound data from Office applications on a host significantly exceeded the predicted normal amount?
    context: This question uses time-series analysis to model the expected rhythm of outbound data from Office applications on a host. By predicting the normal data volume for any given time, the model can accurately identify spikes that significantly exceed this prediction. Such anomalies could represent a data exfiltration attempt orchestrated by a malicious macro.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Network egress points, DNS resolvers, User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Use a time-series model (e.g., ARIMA) to predict hourly outbound data volume from Office apps on a host. Alert if the actual volume significantly exceeds the predicted confidence interval.
  - question: Has a sequence of events occurred on a host, such as a template file write followed by a suspicious process creation, within a short time frame?
    context: Individual events can sometimes be benign, but their occurrence in a specific sequence is often highly indicative of malicious activity. This question looks for a classic attack chain: a template file is written or modified, and then the corresponding Office application spawns a shell, strongly suggesting a malicious macro was triggered.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - User workstations, File servers storing templates, Network and DNS infrastructure
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Create a correlation rule that looks for Event A (template file write) followed by Event B (Office app spawning shell) on the same host within a 5-minute window.
  - question: After a template file was modified, did the host exhibit a series of other suspicious behaviors that accumulate to a high risk score?
    context: This question operationalizes the concept of risk scoring based on event sequences. A template modification itself is a low-fidelity event, but if it is followed by other suspicious activities (like rare processes or anomalous network connections) in a short window, the cumulative risk score increases. Alerting on a high total score helps to filter out noise and focus on the most likely compromises.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - User workstations, File servers storing templates, Network and DNS infrastructure
    range: last 90 days
    queries:
      - technology: pseudocode
        query: After a template file write, monitor the host for 10 minutes. Add risk points for subsequent suspicious events. Alert if the total risk score exceeds a statistical threshold.
  - question: Did a sequence of user and system events on a host deviate significantly from the patterns of normal, benign activity learned by a sequence analysis model?
    context: This question employs advanced machine learning to understand the 'grammar' of normal user activity. A Hidden Markov Model learns the probable sequences of events (e.g., file write -> app launch -> network connection to a corporate server). An attack sequence will likely have very different state transitions, resulting in a low probability score from the model, thus flagging it as a highly anomalous and suspicious chain of events.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - User workstations, File servers storing templates, Network and DNS infrastructure
    range: last 90 days
    queries:
      - technology: pseudocode
        query: Calculate the likelihood of a new sequence of host events (file write, process launch, network connection) under a trained Hidden Markov Model. Alert on sequences with very low likelihood scores.