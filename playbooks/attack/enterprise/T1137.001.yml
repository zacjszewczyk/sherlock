name: T1137.001: Office Template Macros
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps investigate whether an adversary is maintaining persistence by abusing Office Template Macros. This involves detecting the creation or modification of malicious Office template files (.dotm, .xltm), unauthorized changes to Windows Registry keys that control template locations or macro security settings, the spawning of suspicious child processes (e.g., command shells, LOLBins) from Office applications, anomalous outbound network connections initiated by Office processes, and correlated sequences of these events occurring on a host in a short time frame.
type: technique
related:
  - TA0003: Persistence
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
investigative_questions:
  - question: Are malicious Office template files (.dotm, .xltm) being created or modified on endpoints by matching file hashes against a threat intelligence feed?
    context: Adversaries often use known malicious templates to establish persistence. Comparing the hash of newly created or modified template files against a list of known-bad hashes from threat intelligence is a high-fidelity method for detecting these threats. This question focuses on identifying file creation or write events for files with .dotm or .xltm extensions in standard Office template paths and checking if their hash is on a blocklist.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek files.log
      - Sysmon Event ID 11
      - Data from User workstations (specifically %APPDATA%\Microsoft\Templates and %APPDATA%\Microsoft\Excel\XLSTART), File servers hosting shared templates, Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH file_events WHERE (extension IN ['.dotm', '.xltm'] AND path CONTAINS 'Templates' OR 'XLSTART') AND hash IN (threat_intel_hash_list)
  - question: Is there an anomalous volume of Office template file creation or modification on any given host?
    context: This question provides a behavioral approach to detection, moving beyond known indicators. A sudden spike in the creation of template files on a host that normally has very few, or by a user who has never created them before, can indicate malicious activity even if the file hash is unknown. This involves establishing a baseline of normal template creation/modification activity per host and alerting on significant deviations.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek files.log
      - Sysmon Event ID 11
      - Data from User workstations (specifically %APPDATA%\Microsoft\Templates and %APPDATA%\Microsoft\Excel\XLSTART), File servers hosting shared templates, Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE daily_count of .dotm/.xltm files per host. COMPARE daily_count to 30-day rolling baseline. ALERT if daily_count > 95th_percentile.
  - question: Can machine learning be used to classify newly created Office template files as malicious based on their content and structure?
    context: To detect novel threats not yet present in threat intelligence feeds, this question explores using a supervised machine learning model. By training a model on features extracted from both benign and malicious files (e.g., presence of VBA macros, suspicious API calls, code entropy), it's possible to classify newly seen template files as malicious, providing a proactive detection capability.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek files.log
      - Sysmon Event ID 11
      - Data from User workstations (specifically %APPDATA%\Microsoft\Templates and %APPDATA%\Microsoft\Excel\XLSTART), File servers hosting shared templates, Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new .dotm/.xltm file, EXTRACT features (VBA project size, API calls, entropy). INPUT features into ML_model. ALERT if classification is 'malicious'.
  - question: Are registry keys controlling Office template locations or macro security settings being modified by unauthorized processes?
    context: Adversaries can manipulate the registry to either point Office applications to a malicious template (e.g., GlobalDotName) or silently lower security settings to allow macros to run (e.g., VBAWarnings). This question focuses on detecting modifications to these critical registry keys and validating that the change was performed by a legitimate process, such as a Group Policy update or an approved software installer, rather than an unauthorized script or binary.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - Data from Windows Registry on all endpoints (user workstations and servers), Group Policy Objects on Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH registry_events WHERE (key_path CONTAINS 'GlobalDotName' OR 'VBAWarnings') AND process_name NOT IN (allowlist) OR (key_path CONTAINS 'VBAWarnings' AND new_value = '1')
  - question: Are Office-related registry keys being set to rare or unusual values across the enterprise?
    context: This question uses statistical rarity as an indicator of compromise. If a specific registry value for a key like 'VBAWarnings' is observed on only a tiny fraction of endpoints across the enterprise, it is highly suspect. This approach involves baselining the values for key Office registry settings across all hosts and alerting when a machine is configured with a statistically rare value, indicating a potential unauthorized change.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - Data from Windows Registry on all endpoints (user workstations and servers), Group Policy Objects on Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE values for 'VBAWarnings' and 'GlobalDotName' keys across all hosts. CALCULATE frequency of each value. ALERT if a host's key is set to a value with <1% enterprise-wide frequency.
  - question: Can machine learning detect anomalous modification events for Office-related registry keys?
    context: This question proposes using an unsupervised machine learning model, such as a one-class SVM, to learn the boundary of normal administrative and user activity related to registry modifications. By training on features like the modifying process and key path, the model can identify any new modification that falls outside this learned boundary as an outlier, effectively detecting novel or unusual adversary behavior.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - Data from Windows Registry on all endpoints (user workstations and servers), Group Policy Objects on Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each registry modification event, EXTRACT features (process, key path, values). INPUT features into one-class_SVM_model. ALERT if event is classified as an 'outlier'.
  - question: Are Office applications (WINWORD.EXE, EXCEL.EXE) spawning suspicious child processes like command shells or LOLBins?
    context: A primary function of a malicious macro is to execute code, often by spawning a child process like PowerShell, Command Prompt, or another Living-off-the-Land Binary (LOLBin). This question aims to directly detect this behavior by creating a rule that alerts whenever an Office application process is observed as the parent of a known shell, scripting interpreter, or LOLBin.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Data from User workstations, remote desktop servers, and virtual desktop infrastructure (VDI) endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_events WHERE parent_process IN ('WINWORD.EXE', 'EXCEL.EXE', 'POWERPNT.EXE') AND child_process IN ('cmd.exe', 'powershell.exe', 'wscript.exe', etc.)
  - question: Are Office applications spawning statistically rare child processes or using command lines with unusually high entropy?
    context: To detect more evasive techniques, this question looks for behavioral anomalies rather than a static list of bad processes. It involves creating a historical baseline of normal child process activity for Office applications. An alert is generated if a rare process is spawned (e.g., excel.exe spawning bitsadmin.exe for the first time in the environment) or if the command line used is highly complex or obfuscated (high entropy), which suggests malicious intent.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Data from User workstations, remote desktop servers, and virtual desktop infrastructure (VDI) endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE child processes and command-line entropy for Office parent processes. ALERT if a new child process is rare (<0.1% frequency) OR command-line entropy is in the 99th percentile.
  - question: Can unsupervised machine learning identify novel or outlier command lines executed by child processes of Office applications?
    context: This advanced question focuses on using unsupervised clustering algorithms (e.g., DBSCAN) to automatically group legitimate, frequently seen command-line arguments into clusters. Any command line that does not fit into a known cluster is flagged as an outlier or noise. This method allows for the detection of new or unique attack patterns without needing pre-defined rules or signatures.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Data from User workstations, remote desktop servers, and virtual desktop infrastructure (VDI) endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CLUSTER command-lines from Office child processes using DBSCAN. ALERT on any command-line that is flagged as noise/outlier by the algorithm.
  - question: Are Office applications making network connections to known malicious or suspicious destinations?
    context: Malicious macros often require a connection to an external command-and-control (C2) server to receive instructions or exfiltrate data. This question aims to detect this by correlating process data with network data, specifically looking for connections initiated by Office processes to destinations on threat intelligence lists, such as Tor exit nodes, dynamic DNS providers, or recently registered domains.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Data from Network egress points, DNS resolvers, User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH network_connections WHERE process_name IN ('WINWORD.EXE', etc.) AND (destination_ip IN (tor_list) OR destination_domain IN (dyndns_list) OR domain_age < 30_days)
  - question: Are Office applications exhibiting anomalous network behavior, such as connecting to unusual geographic locations or transferring abnormal amounts of data?
    context: Beyond looking for known-bad destinations, this question seeks to identify anomalies in the network patterns of Office applications. This involves baselining normal behavior, including typical destination countries, Autonomous System Numbers (ASNs), and data volumes. An alert would trigger if an application suddenly connects to a country not seen in 90 days or if the data transferred in a session is significantly larger than the historical norm for that host.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Data from Network egress points, DNS resolvers, User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE network traffic per Office app (dest_country, ASN, data_volume). ALERT if connection to new_country/ASN OR data_volume > 98th_percentile.
  - question: Can time-series analysis predict and detect anomalous spikes in outbound data volume from Office processes?
    context: This question proposes a sophisticated method for detecting C2 communication or data exfiltration by modeling the flow of data over time. A time-series forecasting model (like ARIMA or Prophet) learns the normal rhythm of outbound data volume from Office processes on a per-host basis. If the actual observed data volume significantly exceeds the model's predicted upper bound, it signals a statistically significant anomaly worthy of investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Data from Network egress points, DNS resolvers, User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL outbound data volume from Office processes using ARIMA/Prophet. PREDICT expected volume per hour. ALERT if actual_volume >> predicted_volume_upper_bound.
  - question: Is there a correlated sequence of events on a host, such as a template file write followed closely by a suspicious process creation from an Office application?
    context: Individual events may seem benign, but their sequence and timing can be highly indicative of an attack. This question aims to create a stateful rule that detects a classic attack chain: a malicious template file (e.g., Normal.dotm) is written to disk, and within minutes, the corresponding Office application launches a command shell. Correlating these events provides a high-fidelity alert.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - Data from User workstations, File servers storing templates, Network and DNS infrastructure
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CORRELATE events on a single host within 5 minutes. IF (file_write to 'Normal.dotm' or 'XLSTART') THEN (process_creation where parent is Office_app and child is 'powershell.exe' or 'cmd.exe') -> ALERT.
  - question: Can a risk score be calculated based on a sequence of events following a template file modification to identify high-risk activity?
    context: This question proposes a risk-scoring model to help prioritize alerts. When a potential trigger event occurs (e.g., a template file is modified), a monitoring window opens. Subsequent suspicious activities within that window (e.g., a rare child process, a connection to a new ASN) add points to a cumulative risk score. If the total score for the sequence exceeds a dynamically calculated threshold, it is flagged as a high-risk event.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - Data from User workstations, File servers storing templates, Network and DNS infrastructure
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON template_file_modification, START 10-min timer. ADD points for suspicious events (rare process, new ASN, high entropy cmd). ALERT if total_score > threshold (e.g., 3 standard deviations above mean).
  - question: Can a Hidden Markov Model be used to determine if a sequence of user and system events deviates from normal, benign behavior?
    context: This advanced question explores using a Hidden Markov Model (HMM) to learn the normal transition probabilities between different system states (e.g., file write -> app launch -> network connection). By training on vast amounts of benign event sequences, the model can calculate a likelihood score for any new sequence. A sequence with a very low likelihood is considered a significant deviation from normal patterns and is flagged as potentially malicious.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - Data from User workstations, File servers storing templates, Network and DNS infrastructure
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN HMM on benign event sequences. FOR each new event sequence on a host, CALCULATE likelihood score with HMM. ALERT if likelihood is below a low-probability threshold.