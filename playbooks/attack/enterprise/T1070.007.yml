name: "T1070.007: Clear Network Connection History and Configurations"
id: "7f8a1b2c-d3e4-4f5a-b6c7-d8e9f0a1b2c3"
description: "This playbook helps investigate whether an adversary is attempting to evade detection by clearing network history or configurations. This involves looking for evidence of history-clearing utilities, the use of built-in commands to clear event logs or RDP history, anomalous deletion or modification of RDP artifacts, the temporal correlation of RDP logons with cleanup activities, and the unauthorized modification of host-based firewall rules."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a known history-clearing utility been executed on the network?"
    context: "This question aims to identify the execution of well-known tools used for clearing system artifacts, such as SDelete, CCleaner, or BleachBit. Detecting these tools by their file hash is a high-fidelity indicator that an adversary may be attempting to cover their tracks by erasing evidence of their presence or activities."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Zeek files.log"
      - "User workstations, Application servers, and Jump Boxes where remote access is common."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (Sysmon 1, Win 4688). COMPARE process image hash against a threat intelligence list of known history-clearing tools. ALERT on match."
  - question: "Are there any executed processes with abnormally high string entropy in their filenames?"
    context: "This question seeks to uncover obfuscated or randomly named tools that might be used for malicious purposes, including history clearing. Adversaries often rename their tools to avoid simple name-based detection. A statistically significant deviation in filename entropy, especially when executed from temporary or user-specific directories, can indicate such a tool."
    answer_sources:
      - "Sysmon Event ID 1"
      - "User workstations, Application servers, and Jump Boxes where remote access is common."
    range: "last 90 days"
    queries:
      - "CALCULATE Shannon entropy for all new process names. ESTABLISH baseline mean and standard deviation. ALERT if entropy > (mean + 3 * std_dev) AND process path is in a non-standard directory."
  - question: "Can we classify process executions as potentially malicious history-clearing activity using machine learning?"
    context: "This question leverages machine learning to provide a more sophisticated and context-aware detection method. By training a model on various features of a process execution event (e.g., parent process, command line attributes, user), it's possible to identify subtle patterns indicative of history-clearing activities that symbolic or simple statistical methods might miss."
    answer_sources:
      - "Sysmon Event ID 1"
      - "User workstations, Application servers, and Jump Boxes where remote access is common."
    range: "last 90 days"
    queries:
      - "INPUT features (parent process, command-line length/entropy, user) from process creation events into a trained classification model. ALERT if model classifies the event as 'history-clearing'."
  - question: "Are built-in command-line utilities being used to clear event logs or delete RDP connection history?"
    context: "This question focuses on detecting the abuse of legitimate system tools (wevtutil.exe, reg.exe, powershell.exe) for defense evasion. Adversaries use these native utilities to erase their tracks, such as clearing specific event logs or removing registry keys that store RDP connection history. Monitoring for specific command-line patterns associated with these actions is crucial for detection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Windows Event ID 4104"
      - "Domain Controllers, Member Servers, and administrative workstations."
    range: "last 90 days"
    queries:
      - "SEARCH command-line and PowerShell script block logs for regex patterns like 'wevtutil cl', 'Clear-EventLog', 'reg delete .*Terminal Server Client', 'Remove-Item .*.rdp'. ALERT on matches."
  - question: "Is there an anomalous frequency of deletion-related commands being executed by system utilities on any host?"
    context: "This question aims to identify outlier behavior by baselining the normal usage of administrative commands. A sudden, statistically significant spike in commands like 'delete', 'cl', or 'Remove-Item' used with tools like reg.exe or powershell.exe on a specific host or by a specific user can indicate a targeted effort to remove evidence, deviating from routine administrative activity."
    answer_sources:
      - "Sysmon Event ID 1"
      - "Windows Event ID 4104"
      - "Domain Controllers, Member Servers, and administrative workstations."
    range: "last 90 days"
    queries:
      - "BASELINE frequency of deletion commands per host/user. CALCULATE z-score for current activity. ALERT if z-score > 3 compared to baseline."
  - question: "Can the semantic intent of command-line and PowerShell script block executions be classified as 'history clearing'?"
    context: "This question utilizes Natural Language Processing (NLP) to understand the *purpose* of a command, rather than just matching keywords. This advanced approach can identify novel or obfuscated commands designed to clear history, providing a more robust detection capability that is less susceptible to simple evasion techniques."
    answer_sources:
      - "Sysmon Event ID 1"
      - "Windows Event ID 4104"
      - "Domain Controllers, Member Servers, and administrative workstations."
    range: "last 90 days"
    queries:
      - "INPUT command-line strings and script blocks into a fine-tuned NLP model. ALERT if the model classifies the command's intent as 'history clearing'."
  - question: "Is there direct evidence of RDP history artifacts, such as specific registry keys or files, being deleted?"
    context: "This question looks for the most direct evidence of an adversary removing their RDP tracks. By monitoring for the explicit deletion of registry keys under 'HKCU\\Software\\Microsoft\\Terminal Server Client' or the 'Default.rdp' file, security analysts can pinpoint attempts to hide lateral movement activities."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Sysmon Event ID 12"
      - "Sysmon Event ID 13"
      - "Windows Event ID 4660"
      - "Windows Event ID 4663"
      - "Windows Registry and file system on endpoints and servers, particularly those accessed via RDP."
    range: "last 90 days"
    queries:
      - "SEARCH for registry delete events (Sysmon 13) where TargetObject ends with '\\Terminal Server Client\\...' OR file delete events (Sysmon 11) for 'Default.rdp'. ALERT on match."
  - question: "Has any host experienced a statistically unusual burst of modification or deletion events targeting RDP history artifacts?"
    context: "This question aims to detect history-clearing activity by identifying anomalous rates of change. While occasional modifications might be normal, a sudden flurry of deletions or modifications to RDP-related files and registry keys within a short time frame is highly suspicious and deviates from baseline user behavior."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Sysmon Event ID 13"
      - "Windows Registry and file system on endpoints and servers, particularly those accessed via RDP."
    range: "last 90 days"
    queries:
      - "CREATE time-series baseline of modification/deletion events for RDP artifacts per host. USE a moving average to model normal activity. ALERT if event count in a short window exceeds the 98th percentile of the historical distribution."
  - question: "Does the pattern of access to RDP artifacts on any host deviate from the normal rhythm learned by a time-series model?"
    context: "This question uses a sophisticated anomaly detection model to learn the typical 'rhythm' of access to RDP artifacts across the entire organization. This allows it to flag a host whose activity pattern—even if low in volume—is uncharacteristic (e.g., deletions occurring at an unusual time or in an unusual sequence), indicating a potential compromise."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Sysmon Event ID 13"
      - "Windows Registry and file system on endpoints and servers, particularly those accessed via RDP."
    range: "last 90 days"
    queries:
      - "TRAIN an LSTM Autoencoder on the frequency of access events for RDP artifacts. FEED real-time event frequency data into the model. ALERT if the model flags a host's activity pattern as a significant deviation."
  - question: "Is a successful RDP logon immediately followed by the deletion of RDP history artifacts by the same user on the same host?"
    context: "This question seeks to identify a classic 'logon and clean up' attack pattern. By correlating a successful RDP logon event with subsequent history-clearing commands or file/registry deletions within a short time window (e.g., 15 minutes), analysts can detect adversaries attempting to cover their tracks immediately after accessing a system."
    answer_sources:
      - "Windows Event ID 4624"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Sysmon Event ID 13"
      - "Windows Event ID 4104"
      - "Zeek conn.log"
      - "Zeek rdp.log"
      - "Authentication logs, file/registry audit logs on RDP-enabled systems, and network traffic logs at network ingress/egress points."
    range: "last 90 days"
    queries:
      - "CORRELATE RDP logon (Win 4624, type 10) with subsequent history-clearing process/file/registry events (Sysmon 1, 11, 13) on the same host/user within 15 minutes. ALERT on correlation."
  - question: "Has any user account shown a statistically significant increase in the probability of clearing history immediately after an RDP logon?"
    context: "This question establishes a behavioral baseline for what users typically do after an RDP logon. A user who rarely or never clears history but suddenly starts doing so immediately after logging in exhibits a strong deviation from their normal behavior. This statistical anomaly, measured as a sudden jump in conditional probability, is a strong indicator of a compromised account or insider threat."
    answer_sources:
      - "Windows Event ID 4624"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Sysmon Event ID 13"
      - "Authentication logs, file/registry audit logs on RDP-enabled systems, and network traffic logs at network ingress/egress points."
    range: "last 90 days"
    queries:
      - "CALCULATE conditional probability P(Clear | RDP_Login) for each user. ESTABLISH a baseline. ALERT if a user's probability suddenly jumps into the top 99th percentile."
  - question: "Can we detect anomalous sequences of user actions following an RDP logon that are indicative of history clearing?"
    context: "This question uses sequence analysis to model entire user sessions, learning common chains of events (e.g., 'login -> run application -> logout'). An unusual sequence, such as 'RDP logon -> delete registry key -> delete file -> logout', would be identified by the model as a low-probability, anomalous pattern, providing a high-confidence alert for malicious activity."
    answer_sources:
      - "Windows Event ID 4624"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Sysmon Event ID 13"
      - "Authentication logs, file/registry audit logs on RDP-enabled systems, and network traffic logs at network ingress/egress points."
    range: "last 90 days"
    queries:
      - "TRAIN a sequence analysis model (e.g., HMM) on common post-login event sequences. FEED new event sequences into the model. ALERT if the model identifies a sequence as low-probability or anomalous."
  - question: "Have host-based firewall rules been modified or removed by unauthorized users or outside of approved maintenance windows?"
    context: "This question aims to detect adversaries tampering with firewall rules to enable C2 communication, lateral movement, or data exfiltration. By monitoring for firewall modification commands (netsh advfirewall, *-NetFirewallRule) and correlating them with authorized administrator lists and change management schedules, unauthorized and potentially malicious changes can be quickly identified."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Windows Event ID 4104"
      - "Windows Event ID 4947"
      - "Windows Event ID 4950"
      - "Zeek notice.log"
      - "Host-based firewalls on workstations and servers; Centralized logging and SIEM infrastructure; Change management log databases."
    range: "last 90 days"
    queries:
      - "MONITOR for firewall modification commands. CORRELATE with authorized admin list and maintenance windows. ALERT if command is executed outside of defined parameters."
  - question: "Is any host or user exhibiting a statistically anomalous rate of firewall rule modifications?"
    context: "This question helps to identify suspicious activity by focusing on the rate of change. While an administrator might make a few changes, an adversary might make many changes in a short period to open multiple ports or disable protections. A statistically significant spike in firewall modification events for a particular host or user, compared to their own history and their peers, is a strong indicator of malicious activity."
    answer_sources:
      - "Sysmon Event ID 1"
      - "Windows Event ID 4104"
      - "Windows Event ID 4947"
      - "Windows Event ID 4950"
      - "Host-based firewalls on workstations and servers; Centralized logging and SIEM infrastructure; Change management log databases."
    range: "last 90 days"
    queries:
      - "PROFILE the rate of firewall modification events per host/user. ESTABLISH a baseline. USE z-score to detect significant increases in activity. ALERT if z-score > 3."
  - question: "Can machine learning be used to classify firewall changes as legitimate administrative actions or malicious tampering?"
    context: "This question seeks to automate the complex task of vetting firewall changes. A machine learning model can be trained to understand the context of a change—considering the user, time, parent process, and even correlation with a change ticket—to make an intelligent decision about its legitimacy. This reduces false positives and allows analysts to focus on high-probability malicious events."
    answer_sources:
      - "Sysmon Event ID 1"
      - "Windows Event ID 4104"
      - "Host-based firewalls on workstations and servers; Centralized logging and SIEM infrastructure; Change management log databases."
    range: "last 90 days"
    queries:
      - "INPUT features (user role, time of day, parent process, command parameters) from firewall change events into a trained classification model. ALERT if the model classifies the change as malicious."