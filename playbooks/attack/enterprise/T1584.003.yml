name: T1584.003: Virtual Private Server
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: |
  This playbook helps determine if an adversary has established operational infrastructure on a third-party Virtual Private Server (VPS) for use in targeting the organization. It focuses on detecting various indicators of malicious VPS usage, such as outbound connections to known malicious IPs or domains, traffic patterns matching Command and Control (C2) frameworks, unauthorized use of cloud administration tools to connect to VPS providers, DNS queries for suspicious domains resolving to VPS IPs, and network traffic exhibiting beaconing or data exfiltration characteristics.
type: technique
related:
- TA0042: Resource Development
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Have any internal systems communicated with IPs, domains, or TLS certificates identified by threat intelligence as malicious VPS infrastructure?
  context: |
    This question aims to identify direct connections to known-bad infrastructure hosted on Virtual Private Servers. By continuously comparing outbound network traffic logs against a curated threat intelligence feed, analysts can detect initial compromise, command and control (C2) communication, or data exfiltration attempts that leverage adversary-controlled VPS resources. A match provides a high-confidence starting point for an incident response investigation.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Network egress points, proxy server logs, enterprise DNS resolver logs, and network
    security monitoring (NSM) sensor placements.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      JOIN (outbound_network_logs) WITH (threat_intel_vps_feed)
      ON (network.destination.ip == feed.ip OR network.destination.domain == feed.domain OR network.tls.cert_hash == feed.hash)
      WHERE (feed.tag == 'malicious_vps')
      ALERT on match
- question: Are there any outbound connections to known VPS providers that are statistically rare across the enterprise?
  context: |
    Adversaries often use unique, dedicated VPS infrastructure for targeted attacks, which will have a very low prevalence compared to legitimate, widely-used services. This question helps uncover these 'long-tail' connections by identifying destination IPs, domains, or certificates that are accessed by only a small fraction of hosts. Such low-prevalence indicators are suspicious and may represent C2 channels or staging servers.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Network egress points, proxy server logs, enterprise DNS resolver logs, and network
    security monitoring (NSM) sensor placements.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each destination (ip, domain, cert) in (outbound_logs to VPS_IP_ranges) over 30 days:
        CALCULATE prevalence = (COUNT(unique source_hosts) / TOTAL_enterprise_hosts)
      IF prevalence < 0.01:
        FLAG destination for investigation
- question: Can we use machine learning to predict whether a new outbound connection to a VPS provider is malicious?
  context: |
    This question leverages a supervised machine learning model to proactively identify malicious connections that may not appear on traditional indicator lists. By training on features derived from network logs (e.g., duration, protocol, data size, TLS parameters), the model learns the subtle characteristics that distinguish malicious C2 traffic from benign activity. Scoring new connections in real-time allows for the detection of novel threats and zero-day infrastructure.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Network egress points, proxy server logs, enterprise DNS resolver logs, and network
    security monitoring (NSM) sensor placements.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each new_connection to VPS_IP_range:
        EXTRACT features (duration, protocol, bytes, dns_query, tls_version, ja3, etc.)
        SCORE connection using trained_classifier_model
      IF score > 0.85:
        ALERT as potentially malicious
- question: Is any outbound HTTP/S traffic to VPS providers matching known signatures of Command and Control (C2) frameworks?
  context: |
    This question focuses on identifying C2 communications by looking for specific, known patterns within network traffic. C2 frameworks often have unique signatures in their HTTP requests (e.g., specific URI paths or User-Agent strings) or in their TLS handshakes (JA3/JA3S hashes). Detecting a match for these signatures in traffic directed to a VPS provider is a strong indicator that an internal host is communicating with an adversary's C2 server.
  answer_sources:
  - Zeek http.log
  - Zeek ssl.log
  - SSL/TLS inspection appliances, web proxy servers, and network taps at egress points.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each outbound_connection to VPS_IP_range:
        APPLY signature_set (e.g., Suricata, Zeek scripts) for known C2 patterns
        ON (http.uri, http.user_agent, tls.ja3, tls.ja3s)
      IF signature matches:
        TRIGGER alert
- question: Is any host exhibiting statistically anomalous HTTP/S or TLS behavior when connecting to VPS providers?
  context: |
    This question seeks to find C2 activity by identifying deviations from normal behavior, rather than relying on known signatures. Adversary tools may use randomized or unusual URI paths and User-Agent strings, which can be detected by measuring their entropy. Similarly, a client using a rare JA3 hash across the enterprise is anomalous. These statistical outliers can surface novel or customized C2 tools that signature-based methods would miss.
  answer_sources:
  - Zeek http.log
  - Zeek ssl.log
  - SSL/TLS inspection appliances, web proxy servers, and network taps at egress points.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each host:
        CALCULATE 30-day baseline_entropy for (User-Agent, URI_path) to VPS providers
        IF new_request_entropy > (baseline_entropy + 3 * stdev):
          FLAG request
      FOR each connection:
        CALCULATE enterprise_prevalence of connection.ja3_hash
        IF prevalence < 0.01:
          FLAG connection
- question: Can we detect anomalous sequences of client behavior that might indicate a new C2 tool connecting to a VPS?
  context: |
    This question uses machine learning to model the *sequence* of legitimate client software behavior over time, as reflected by their TLS handshakes (JA3 hashes). An anomaly detection model, such as an LSTM autoencoder, can learn the normal patterns of how a user's applications make network connections. A new C2 tool establishing a connection will likely create a sequence of TLS sessions that deviates significantly from this learned pattern, allowing the model to flag it as a high-risk anomaly.
  answer_sources:
  - Zeek http.log
  - Zeek ssl.log
  - SSL/TLS inspection appliances, web proxy servers, and network taps at egress points.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each host:
        TRAIN LSTM_autoencoder on historical sequences of JA3 hashes from connections to VPS providers
      FOR each new_connection_sequence:
        CALCULATE reconstruction_error using trained model
      IF reconstruction_error > anomaly_threshold:
        ALERT for potential new C2 activity
- question: Has a cloud administration CLI tool been run on a non-administrative endpoint to connect to a VPS provider?
  context: |
    This question is designed to detect the misuse of legitimate cloud administration tools for malicious purposes. Adversaries may deploy tools like 'aws.exe' or 'terraform.exe' on a compromised standard user workstation to provision or interact with their own VPS infrastructure. This activity is highly suspicious because these tools should typically only be run by authorized administrators on designated systems. Correlating the unauthorized process execution with an outbound connection to a public VPS IP range creates a high-fidelity alert for investigation.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Zeek conn.log
  - Standard user workstations and servers not part of a designated 'Cloud Administrators'
    group. Domain Controllers are an NAI for retrieving group memberships to correlate
    with host activity.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each process_creation_event:
        IF process_name IN (cloud_cli_tool_list) AND host NOT IN (authorized_admin_group):
          CORRELATE process_id with network_connection_logs
          IF connection.destination_ip IN (public_vps_ip_range):
            ALERT on unauthorized cloud tool usage
- question: Are cloud CLI tools being used with anomalous command-line arguments, even by authorized users?
  context: |
    This question aims to detect malicious activity that might be hidden within seemingly legitimate operations. Even if a cloud CLI tool is run by an authorized admin, the specific commands they use might be abnormal. By establishing a baseline of common command-line argument patterns for legitimate administrative tasks, we can use statistical measures like Jaccard similarity to flag executions that are unusual. A low similarity score could indicate an adversary using the tool for a non-standard, malicious purpose like connecting to their own infrastructure.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Zeek conn.log
  - Standard user workstations and servers not part of a designated 'Cloud Administrators'
    group. Domain Controllers are an NAI for retrieving group memberships to correlate
    with host activity.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CREATE baseline_set of common command-line arguments for cloud CLI tools from authorized admins
      FOR each new_cli_tool_execution:
        CALCULATE jaccard_similarity(new_arguments, baseline_set)
      IF similarity_score < 0.3:
        FLAG execution for investigation
- question: Can we use machine learning to identify outlier executions of cloud CLI tools that may be malicious?
  context: |
    This question leverages an unsupervised machine learning model to find anomalous executions of cloud CLI tools without relying on pre-defined rules or signatures. By training a model like an Isolation Forest on a combination of process features (e.g., parent process, command-line details) and correlated network features (e.g., destination IP, data volume), the model can learn what a 'normal' execution looks like. It can then flag any new execution that deviates significantly from this norm as an outlier, potentially indicating malicious use of the tool to manage adversary VPS infrastructure.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Zeek conn.log
  - Standard user workstations and servers not part of a designated 'Cloud Administrators'
    group. Domain Controllers are an NAI for retrieving group memberships to correlate
    with host activity.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      TRAIN outlier_detection_model (e.g., Isolation Forest) on legitimate cloud tool executions
      (Features: process_name, parent, cmd_line_length, dest_ip, data_volume)
      FOR each new_cloud_tool_execution:
        CALCULATE anomaly_score with model
      IF score is high:
        FLAG execution as an outlier for review
- question: Are any internal hosts querying for suspicious domains that resolve to a VPS provider IP?
  context: |
    This question targets the setup phase of C2 communication. Before connecting, a compromised host must resolve the adversary's domain. This query looks for DNS requests for domains that are characteristic of malicious infrastructure—such as being newly registered (NRD) or having algorithmically generated (DGA) names—and also resolve to an IP address within a known VPS provider's network. A match on both criteria strongly suggests an attempt to contact adversary-controlled infrastructure.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Enterprise DNS resolvers, DNS forwarder logs, network taps monitoring DNS traffic
    (port 53).
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each dns_query_log:
        ENRICH domain with threat_intel (is_nrd, is_dga)
        IF (domain.is_nrd OR domain.is_dga) AND dns_answer.ip IN (vps_provider_ranges):
          GENERATE alert
- question: Are there any DNS queries for domains hosted on VPS providers that are statistically anomalous?
  context: |
    This question aims to find malicious domains without relying on threat intelligence feeds. It uses two statistical methods. First, it looks for high-entropy domain names, which are a hallmark of Domain Generation Algorithms (DGAs) used by malware to find C2 servers. Second, it identifies domains that are queried by very few hosts in the enterprise. A targeted attacker's C2 domain will have a very low query count compared to a legitimate service, making it a statistical outlier worth investigating.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Enterprise DNS resolvers, DNS forwarder logs, network taps monitoring DNS traffic
    (port 53).
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each dns_query where answer_ip in VPS_range:
        CALCULATE shannon_entropy of subdomain
        IF entropy > 3.5:
          FLAG as potential DGA
      FOR each domain resolving to VPS_IP:
        CALCULATE unique_queriers over 24 hours
        IF unique_queriers < 5:
          FLAG for review
- question: Is there an anomalous spike in the volume of DNS queries to VPS-hosted domains from any single host?
  context: |
    This question uses time-series analysis to detect abnormal DNS behavior from a specific host. A forecasting model learns the expected hourly volume of DNS queries to VPS-hosted domains for each host. A sudden, significant spike in query volume that exceeds the model's prediction could indicate a C2 client starting up, a DGA burst trying to find a live C2 server, or other automated malicious activity. This method can catch preparatory C2 activity before a connection is even established.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Enterprise DNS resolvers, DNS forwarder logs, network taps monitoring DNS traffic
    (port 53).
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each host:
        TRAIN time-series model (e.g., SARIMA) on hourly DNS query volume to VPS domains
      FOR each hour:
        PREDICT expected_query_volume and confidence_interval
        IF actual_volume > upper_bound of 99% confidence_interval:
          ALERT on anomalous query volume
- question: Are there any long-lived, low-data connections to VPS providers that could be idle C2 channels?
  context: |
    This question seeks to identify C2 heartbeat or idle communication channels. Adversary implants often maintain a persistent connection to their C2 server to await commands. These connections are typically very long in duration but involve transmitting a minimal amount of data (just enough to keep the connection alive). A simple rule that flags connections to VPS providers lasting over an hour with less than 2KB of data transferred can effectively uncover these covert channels.
  answer_sources:
  - Zeek conn.log
  - Network flow data sources at all egress points, including firewalls and core
    routers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each connection_log to VPS provider IP:
        IF connection.duration > 1 hour AND (connection.orig_bytes + connection.resp_bytes) < 2048:
          ALERT as potential idle C2 channel
- question: Are any connections to VPS providers exhibiting highly regular timing (beaconing) or high outbound data ratios (exfiltration)?
  context: |
    This question uses statistical properties of network flows to find two key malicious behaviors. First, it looks for beaconing, where a C2 client contacts its server at a precise, regular interval. This machine-generated traffic has a very low standard deviation in its inter-arrival times. Second, it looks for data exfiltration by calculating the ratio of outbound to inbound data. A very high ratio in a long-lived connection is a strong indicator that data is being stolen from the network.
  answer_sources:
  - Zeek conn.log
  - Network flow data sources at all egress points, including firewalls and core
    routers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each source-destination pair (dest is VPS):
        COLLECT connection start_times over 1 hour
        CALCULATE stdev of inter-arrival times
        IF stdev < 1.5 seconds:
          ALERT as C2 beaconing
      FOR each connection > 5 minutes:
        CALCULATE ratio = orig_bytes / (resp_bytes + 1)
        IF ratio > 50:
          ALERT as potential data exfiltration
- question: Can we automatically cluster network traffic to VPS providers to isolate anomalous C2 communications?
  context: |
    This question applies unsupervised machine learning to group network connections based on their behavioral characteristics. The vast majority of connections to VPS providers will be normal web traffic, which will form a large, dense cluster. Malicious C2 traffic (beaconing, heartbeats, exfiltration) will have different characteristics (duration, data volume, timing) and will therefore form small, separate clusters or be classified as noise by an algorithm like DBSCAN. Investigating these small, anomalous clusters is an efficient way to hunt for C2 activity.
  answer_sources:
  - Zeek conn.log
  - Network flow data sources at all egress points, including firewalls and core
    routers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      GATHER active connections to VPS providers
      FEATURES = [duration, total_bytes, byte_ratio, stdev_inter_arrival_time]
      APPLY DBSCAN clustering algorithm on feature set
      INVESTIGATE small clusters and points classified as noise