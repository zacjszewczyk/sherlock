name: T1584.003: Virtual Private Server
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: >-
  This playbook helps determine if an adversary has established operational infrastructure on a third-party Virtual Private Server (VPS) for use in targeting the organization. Investigative focus is placed on identifying outbound network connections from internal assets that exhibit malicious characteristics. This includes communications with known malicious IPs, domains, or certificates associated with VPS infrastructure; traffic that matches signatures of Command and Control (C2) frameworks (e.g., specific URIs, User-Agents, or JA3/JA3S hashes); unauthorized use of cloud administration CLI tools connecting to external VPS IPs; DNS queries for suspicious domains (Newly Registered, DGA) that resolve to VPS providers; and network traffic patterns indicative of C2, such as periodic beaconing, long-duration/low-data heartbeats, or high-volume data exfiltration.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are any internal assets communicating with IPs, domains, or certificates known to be associated with malicious VPS infrastructure?
    context: This question aims to detect direct communication with known-bad infrastructure hosted on Virtual Private Servers (VPS). Adversaries often rent VPS services for command and control (C2) or data staging. Matching outbound network traffic against a threat intelligence feed of malicious VPS indicators provides a high-fidelity signal that an internal asset may be compromised or communicating with an adversary-controlled system.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network egress points
      - proxy server logs
      - enterprise DNS resolver logs
      - network security monitoring (NSM) sensor placements.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH outbound_network_logs JOIN threat_intel_feed ON (destination_ip OR destination_domain OR cert_hash) WHERE threat_intel_feed.tag = 'malicious_vps'
  - question: Are there any outbound connections to known VPS providers that are statistically rare within the enterprise?
    context: Adversaries often use unique or low-prevalence infrastructure to target specific organizations, which will stand out against common traffic patterns. This question identifies anomalous connections by flagging destinations (IPs, domains, certificates) within known VPS provider ranges that are contacted by a very small percentage of internal hosts. Such low-prevalence connections are less likely to be legitimate, widely-used services and more likely to be targeted adversary infrastructure.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network egress points
      - proxy server logs
      - enterprise DNS resolver logs
      - network security monitoring (NSM) sensor placements.
    range: last 30 days
    queries:
      - technology: Pseudocode
        query: CALCULATE prevalence of destination_ip, domain, cert_subject IN outbound_connections_to_vps_ranges GROUP BY destination OVER 30_days. RETURN connections WHERE prevalence < 1st_percentile.
  - question: Can machine learning models identify outbound connections to VPS providers that exhibit characteristics of malicious activity?
    context: This question leverages a supervised machine learning model to proactively identify malicious connections that may not appear on traditional indicator lists. By training a model on features extracted from network logs (like connection duration, protocol, data volume, and TLS parameters), it can learn the subtle differences between benign and malicious traffic to VPS providers. A high 'malicious' probability score from the model indicates a connection that strongly matches patterns of known C2 or data exfiltration channels.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network egress points
      - proxy server logs
      - enterprise DNS resolver logs
      - network security monitoring (NSM) sensor placements.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SCORE new_outbound_connections_to_vps_ranges USING trained_classifier_model. ALERT IF malicious_probability > 0.85.
  - question: Are there any outbound HTTP/S connections to VPS providers that match known signatures for Command and Control (C2) frameworks?
    context: C2 frameworks often use distinct patterns in their network communications. This question seeks to identify these patterns by monitoring traffic to VPS providers for specific signatures, such as unique URI paths, User-Agent strings, or JA3/JA3S hashes associated with known malware or offensive security tools. A match provides a strong indication of an active C2 channel on the network.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - SSL/TLS inspection appliances
      - web proxy servers
      - network taps at egress points.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH http_ssl_logs_to_vps_ranges FOR http_uri, user_agent, ja3_hash MATCHING known_c2_signatures. ALERT ON match.
  - question: Are there any outbound connections to VPS providers exhibiting statistically anomalous User-Agent strings, URI paths, or JA3 hashes?
    context: This question identifies potential C2 activity by looking for statistical outliers in HTTP/S traffic. C2 tools may use randomized or unusual URI paths and User-Agents, resulting in high entropy. They may also use unique client software, leading to rare JA3 hashes. By baselining normal activity for each host, significant deviations in entropy or the use of a globally rare JA3 hash can reveal a client behaving differently from its peers, which may indicate a C2 implant.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - SSL/TLS inspection appliances
      - web proxy servers
      - network taps at egress points.
    range: last 30 days
    queries:
      - technology: Pseudocode
        query: FOR each host, BASELINE entropy of user_agent, uri_path IN requests_to_vps. ALERT IF new_request_entropy > 3_std_dev_from_baseline. SEPARATELY, CALCULATE prevalence of ja3_hash. ALERT IF ja3_hash_prevalence < 1%.
  - question: Can a time-series anomaly detection model detect deviations in a host's sequence of TLS client behaviors when connecting to VPS providers?
    context: Legitimate applications on a host typically exhibit consistent sequences of TLS client behavior (represented by JA3 hashes) over time. This question uses a machine learning model to learn these normal sequences. A new or unexpected sequence of connections, such as a browser suddenly making a connection with a JA3 hash typical of a PowerShell script, would result in a high anomaly score. This can detect the execution of a new C2 implant or tool that communicates differently than the host's usual applications.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - SSL/TLS inspection appliances
      - web proxy servers
      - network taps at egress points.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each host, TRAIN LSTM_autoencoder ON sequences_of_ja3_hashes_to_vps. SCORE new_ja3_sequence. ALERT IF reconstruction_error > threshold.
  - question: Is a cloud administration command-line tool being run on a non-administrative endpoint to connect to a public VPS or cloud provider IP?
    context: Cloud administration tools (like aws.exe, az.exe) are powerful and should only be used by authorized personnel on designated administrative workstations. This question aims to detect the misuse of these tools by an adversary who has compromised a standard user endpoint. By correlating process execution events with user group membership and subsequent network connections, we can identify unauthorized execution of these tools that communicate with external, non-corporate IP addresses, which is highly indicative of malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Standard user workstations and servers not part of a designated 'Cloud Administrators' group.
      - Domain Controllers are an NAI for retrieving group memberships to correlate with host activity.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH process_events FOR process_name IN (cloud_cli_tools). IF user NOT IN (cloud_admin_group), CORRELATE process_id with network_connections. ALERT IF destination_ip IN (public_vps_ranges).
  - question: Are cloud administration tools being executed with anomalous command-line arguments, especially by non-admin users or on non-standard machines?
    context: Even when a cloud tool is executed, the way it is used can indicate malicious intent. Legitimate administrators typically use a recurring set of commands and arguments. This question establishes a baseline of these common command-line patterns. Any execution, particularly by an unauthorized user or on an unusual machine, that has very different arguments (measured by low Jaccard similarity) is flagged as suspicious. This could detect an adversary using the tool for reconnaissance or data exfiltration in a way that deviates from normal administrative use.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Standard user workstations and servers not part of a designated 'Cloud Administrators' group.
      - Domain Controllers are an NAI for retrieving group memberships to correlate with host activity.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: BASELINE command_line_patterns for authorized_cloud_admins. FOR new_cloud_cli_execution BY non_admin OR on non_standard_host, CALCULATE jaccard_similarity with baseline. ALERT IF similarity_score < 0.3.
  - question: Can an outlier detection model identify anomalous executions of cloud administration tools based on process, user, and network characteristics?
    context: This question applies machine learning to build a holistic profile of 'normal' cloud tool usage. The model considers not just the command itself, but also its context - who ran it (user), what process spawned it (parent process), the complexity of the command-line, and the nature of the resulting network connection (destination, data volume). Executions that the model flags as outliers (high anomaly score) are strong candidates for investigation, as they deviate from the established multi-faceted pattern of legitimate administrative activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Standard user workstations and servers not part of a designated 'Cloud Administrators' group.
      - Domain Controllers are an NAI for retrieving group memberships to correlate with host activity.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: TRAIN isolation_forest_model ON legitimate_cloud_tool_executions (features: process_name, parent_process, cmd_line_length, network_dest, data_volume). SCORE new_executions. ALERT on high_anomaly_score.
  - question: Are internal hosts querying for Newly Registered Domains (NRDs) or domains matching DGA patterns that resolve to a VPS provider's IP address?
    context: Adversaries frequently use newly registered or algorithmically generated domains for their C2 infrastructure to evade reputation-based blocking. This question seeks to identify DNS queries for such domains. By enriching DNS logs with threat intelligence and checking if the resolved IP falls within a known VPS provider's range, we can detect attempts to contact potentially malicious, short-lived infrastructure, which is a common TTP for initial C2 setup.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Enterprise DNS resolvers
      - DNS forwarder logs
      - network taps monitoring DNS traffic (port 53).
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: ENRICH dns_logs with threat_intel (NRD, DGA_patterns). IF domain_matches_intel AND resolved_ip IN (vps_provider_ranges), GENERATE alert.
  - question: Are there any DNS queries for domains resolving to a VPS provider that exhibit high entropy or have an extremely low query count across the enterprise?
    context: This question uses statistical properties of DNS queries to find suspicious domains. Domain Generation Algorithms (DGAs) often create random-looking, high-entropy domain names. Separately, adversary infrastructure used for targeted attacks will likely be queried by only one or a few compromised hosts, resulting in a very low enterprise-wide query count. Identifying domains that resolve to a VPS and fit either of these statistical profiles helps uncover potential C2 domains that are not yet on threat intelligence lists.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Enterprise DNS resolvers
      - DNS forwarder logs
      - network taps monitoring DNS traffic (port 53).
    range: last 24 hours
    queries:
      - technology: Pseudocode
        query: CALCULATE entropy for subdomains resolving to VPS_ips; ALERT if entropy > 3.5. SEPARATELY, COUNT unique hosts querying domains resolving to VPS_ips over 24_hours; ALERT if count < 5.
  - question: Is there an unpredicted spike in the volume of DNS queries to VPS-hosted domains from any given host?
    context: This question uses time-series forecasting to establish a baseline for the normal rhythm of DNS activity for each host. A compromised machine, when a C2 implant is activated, might suddenly start making a burst of DNS queries as it tries to resolve its C2 domain (especially if it uses a DGA). A sudden, large spike in query volume that significantly exceeds the model's prediction for that time period is a strong anomaly, indicating a potential C2 registration event or DGA burst.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Enterprise DNS resolvers
      - DNS forwarder logs
      - network taps monitoring DNS traffic (port 53).
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each host, FORECAST hourly_dns_query_volume_to_vps_domains using SARIMA. ALERT if actual_volume exceeds 99%_confidence_interval_of_forecast.
  - question: Are there any long-duration connections to VPS providers with minimal data transfer, indicative of an idle C2 heartbeat?
    context: Command and control implants often maintain a connection to their server to await instructions. To remain stealthy, these 'heartbeat' connections can last for a very long time (hours or days) but transfer very little data. This question seeks to identify these specific patterns by looking for outbound connections to VPS IPs that exceed a long duration threshold while having a very low byte count. Finding such a connection is a strong indicator of a potential C2 channel.
    answer_sources:
      - Zeek conn.log
      - Network flow data sources at all egress points, including firewalls and core routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH network_logs for connections to VPS_ips. ALERT IF connection_duration > 1_hour AND total_bytes < 2KB.
  - question: Are there any connections to VPS providers that show highly regular, periodic timing (beaconing) or a very high outbound-to-inbound data ratio (exfiltration)?
    context: This question identifies two common C2 behaviors through statistical analysis. First, automated C2 implants check in at precise intervals, creating a connection pattern with a very low standard deviation in timing (beaconing). Second, when an adversary steals data, the amount of data sent out is significantly larger than the data received. By calculating the inter-arrival time deviation and the outbound/inbound data ratio for connections to VPS providers, we can detect these machine-like communication patterns that are uncharacteristic of normal user behavior.
    answer_sources:
      - Zeek conn.log
      - Network flow data sources at all egress points, including firewalls and core routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each source-dest_pair to VPS, CALCULATE std_dev of connection_inter-arrival_times over 1_hour; ALERT if std_dev < 1.5s. SEPARATELY, for long connections, CALCULATE data_ratio = outbound_bytes / (inbound_bytes + 1); ALERT if ratio > 50.
  - question: Can clustering algorithms identify small, distinct groups of network connections to VPS providers that represent anomalous C2 communications?
    context: The vast majority of network traffic to VPS providers (e.g., normal web browsing to hosted sites) will share similar characteristics, forming a large, dense cluster. Adversary C2 traffic, however, often has different properties (e.g., long duration, periodic timing, unusual byte ratios). This question uses an unsupervised clustering algorithm like DBSCAN to automatically group connections based on these features. Small, isolated clusters that are separated from the main 'normal' traffic cluster are highly likely to be anomalous and warrant investigation as potential C2 activity.
    answer_sources:
      - Zeek conn.log
      - Network flow data sources at all egress points, including firewalls and core routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: APPLY DBSCAN clustering to active_connections_to_VPS using features (duration, bytes, ratio, timing_std_dev). INVESTIGATE connections in small, outlier clusters.