name: "T1021.007: Cloud Services"
id: "f5e1c3a0-6b7d-4f8e-9a1b-2c3d4e5f6a7b"
description: "This playbook helps investigate whether an adversary has leveraged federated or synchronized identities to pivot from an on-premises host to a cloud service, and subsequently used that access to move laterally to another on-premises system. It focuses on detecting suspicious authentications from on-prem to cloud, misuse of cloud CLI tools, anomalous API activity followed by internal connections, federated authentication from rare IPs leading to inbound cloud connections, and insecure network configuration changes made via cloud APIs."
type: "technique"
related:
  - "TA0008: Lateral Movement"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a potentially compromised host authenticated and then connected to a cloud service?"
    context: "This question aims to identify a common adversary pattern where a compromised on-premises system is used as a pivot point to access cloud resources. By correlating a successful network authentication with a subsequent connection to a known cloud provider from the same source IP, analysts can detect potential breaches, especially if the source host is already on a watchlist."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "NAI: Domain Controllers, ADFS Servers, Network Egress Points, Endpoint devices"
    range: "last 90 days"
    queries:
      - "SEARCH Windows Event ID 4624 (Logon Type 3) AND Zeek conn.log | JOIN source_ip within 5 minutes | WHERE source_ip IN compromised_watchlist AND destination_ip IN cloud_provider_ranges"
  - question: "Is a user authenticating from an unusual IP address and then immediately connecting to a cloud service?"
    context: "This question helps detect credential theft or account takeover by identifying deviations from a user's normal behavior. Adversaries often use stolen credentials from locations unfamiliar to the user. By baselining a user's typical source IP addresses for authentication, any login from a rare IP followed by a cloud connection can be flagged as a high-risk anomaly requiring investigation."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "NAI: Domain Controllers, ADFS Servers, Network Egress Points, Endpoint devices"
    range: "last 90 days"
    queries:
      - "SEARCH Windows Event ID 4624 (Logon Type 3) | BASELINE user, source_ip frequency over 90 days | DETECT new authentication where source_ip_frequency < 1st_percentile | JOIN with Zeek conn.log where destination_ip IN cloud_provider_ranges"
  - question: "Can machine learning classify a combined on-prem authentication and subsequent cloud connection event as suspicious?"
    context: "This question leverages machine learning to automate the detection of sophisticated attacks that may not be caught by simple rules. By training a model on various features like geolocation, time of day, and destination service, the system can learn the subtle characteristics of both legitimate and malicious activity, providing a probabilistic risk score for new events and reducing analyst fatigue."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "NAI: Domain Controllers, ADFS Servers, Network Egress Points, Endpoint devices"
    range: "last 90 days"
    queries:
      - "MODEL (Random Forest) on features (user, source_geo, time_of_day, cloud_service) from Windows Event ID 4624 and Zeek conn.log | PREDICT new events | ALERT where prediction is 'suspicious' AND confidence > 0.9"
  - question: "Has a cloud CLI tool been executed with command-line arguments indicative of remote execution or credential access?"
    context: "Adversaries frequently use legitimate cloud command-line interface (CLI) tools for malicious purposes. This question focuses on detecting the misuse of these tools by searching for specific high-risk commands related to running code on other systems, accessing credentials, or modifying resources. Monitoring for these specific keywords within process creation events is a direct way to identify lateral movement or credential access attempts."
    answer_sources:
      - "Windows Event ID 4688"
      - "NAI: User Workstations, Management Servers, CI/CD Pipeline Servers, Developer Endpoints"
    range: "last 90 days"
    queries:
      - "SEARCH Windows Event ID 4688 | WHERE process_name IN ('aws.exe', 'az.exe', 'gcloud.cmd', etc.) AND command_line CONTAINS ('run-command', 'get-session-token', etc.)"
  - question: "Is a cloud CLI tool being executed with an unusually long or complex command line?"
    context: "Malicious command lines, particularly those involving obfuscation or complex scripts passed as arguments, are often longer or have higher entropy (randomness) than typical administrative commands. This question aims to detect such anomalies by baselining the normal length and entropy of commands for each cloud CLI tool and alerting on significant deviations, which could indicate an adversary's attempt to hide their actions."
    answer_sources:
      - "Windows Event ID 4688"
      - "NAI: User Workstations, Management Servers, CI/CD Pipeline Servers, Developer Endpoints"
    range: "last 90 days"
    queries:
      - "SEARCH Windows Event ID 4688 | BASELINE command_length, command_entropy per process_name over 30 days | DETECT new execution where length OR entropy > 98th_percentile"
  - question: "Can a machine learning model classify the intent of a cloud CLI command as malicious based on its arguments?"
    context: "This question seeks to apply machine learning for more nuanced detection of malicious CLI usage. By training a model on the text of command-line arguments (using TF-IDF to convert text to numerical features), the system can learn to differentiate between benign administrative tasks, reconnaissance, and outright malicious execution, allowing for more precise and automated threat identification."
    answer_sources:
      - "Windows Event ID 4688"
      - "NAI: User Workstations, Management Servers, CI/CD Pipeline Servers, Developer Endpoints"
    range: "last 90 days"
    queries:
      - "MODEL (Logistic Regression) on TF-IDF vectors of command_line from Windows Event ID 4688 | PREDICT new commands | ALERT where prediction is 'malicious_execution'"
  - question: "Has a host performed cloud API enumeration and then attempted to move laterally to another internal system?"
    context: "This question targets a specific attack chain: an adversary first enumerates cloud resources via API calls to gather information, and then uses that information to pivot to another target within the on-premises network. This stateful rule correlates the initial reconnaissance activity (high volume of unique API calls) with the subsequent lateral movement attempt (connection on common ports like RDP, SSH, or SMB), connecting the two stages of the attack."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "NAI: Network Egress Points, Internal network segments (East-West traffic), DNS servers"
    range: "last 90 days"
    queries:
      - "SEARCH Zeek http.log for >50 unique URIs to cloud APIs from one source_ip in 10 mins | IF true, WATCHLIST source_ip for 1 hour | ALERT if watchlisted_ip connects to internal_ip on ports (22, 445, 3389, 5985, 5986) in Zeek conn.log"
  - question: "Is an internal host making an anomalously high number of unique requests to cloud APIs?"
    context: "A sudden spike in the variety of cloud API endpoints being contacted by a single host can be a strong indicator of reconnaissance. This question uses statistical methods (moving average and standard deviation) to define 'normal' for each host and automatically flags significant deviations. This approach helps to detect enumeration activity without relying on fixed thresholds, adapting to the unique behavior of each system."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "NAI: Network Egress Points, Internal network segments (East-West traffic), DNS servers"
    range: "last 90 days"
    queries:
      - "SEARCH Zeek http.log | BASELINE hourly count of unique cloud API URIs per source_ip over 30 days | DETECT new hour where count > (moving_average + 3 * std_dev)"
  - question: "Can unsupervised machine learning identify outlier API access patterns that are linked to subsequent lateral movement?"
    context: "This question uses a clustering algorithm (DBSCAN) to find hosts whose API access patterns don't fit in with any group of 'normal' activity. These outliers are, by definition, anomalous. The second step is to investigate if these anomalous hosts are also involved in suspicious internal network traffic, effectively using machine learning to surface high-priority leads for lateral movement investigations."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "NAI: Network Egress Points, Internal network segments (East-West traffic), DNS servers"
    range: "last 90 days"
    queries:
      - "MODEL (DBSCAN) on 15-min windows of Zeek http.log features (src_ip, dest_host, user_agent) | IDENTIFY outlier source_ips | QUERY Zeek conn.log for subsequent connections from outliers to internal assets on lateral movement ports"
  - question: "Did a user authenticate from a new IP, followed by an inbound connection from a cloud provider to a different internal host?"
    context: "This question aims to detect a 'cloud-to-on-prem' pivot. The scenario is that an attacker compromises a user's account, authenticates from a new location, uses the cloud access to compromise a cloud resource, and then uses that cloud resource to attack a different system back in the on-premises network. This rule explicitly looks for this A -> B -> C attack path."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "NAI: Domain Controllers, ADFS Servers, Bastion Hosts, Network Firewalls/Gateways"
    range: "last 90 days"
    queries:
      - "MAINTAIN lookup of (user, source_ip) from past 90 days of Win Event 4624 | DETECT new auth where (user, source_ip) is NOT in lookup | FLAG session for 60 mins | ALERT if cloud_ip connects to internal_ip (that is not the original source_ip) in Zeek conn.log"
  - question: "Can we create a risk score for a potential cloud-to-on-prem pivot based on the rarity of the initial authentication and the sensitivity of the final target?"
    context: "This question enhances the previous detection by adding a risk scoring layer. Instead of a binary alert, it quantifies the risk. An authentication from a very rare IP is riskier. An inbound connection to a highly sensitive server (like a domain controller) is riskier. By combining these factors into a score, analysts can prioritize the most critical potential incidents."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "NAI: Domain Controllers, ADFS Servers, Bastion Hosts, Network Firewalls/Gateways"
    range: "last 90 days"
    queries:
      - "CALCULATE rarity_score for new auth from Win Event 4624 based on source_ip frequency | IF followed by inbound cloud connection (Zeek conn.log) to internal host, CALCULATE risk_score = rarity_score * destination_host_sensitivity | ALERT if risk_score > threshold"
  - question: "Can graph-based anomaly detection identify improbable paths of activity flowing from a user, through the cloud, and back to an on-prem host?"
    context: "This question proposes a sophisticated graph analytics approach to model complex relationships between users, hosts, and cloud services. By representing all interactions as a graph, algorithms can identify entire attack paths that are statistically unlikely compared to the baseline of normal activity. This can uncover novel or complex adversary behaviors that rule-based or simpler statistical methods might miss."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "NAI: Domain Controllers, ADFS Servers, Bastion Hosts, Network Firewalls/Gateways"
    range: "last 90 days"
    queries:
      - "CREATE GRAPH with nodes (users, hosts, cloud_ips) and edges (auth_from, connects_to) | APPLY graph anomaly detection algorithm | ALERT on low-probability paths like user -> host1 -> cloud_ip -> host2"
  - question: "Has a cloud firewall or network security group rule been created that exposes a sensitive port to the entire internet?"
    context: "This is a direct, high-fidelity detection question. Adversaries who gain access to a cloud environment may try to create backdoors or expose internal services by opening firewall ports (like SSH, RDP, or WinRM) to the world (0.0.0.0/0). This question looks for the specific audit log events that correspond to this highly dangerous action, providing a clear and immediate signal of a potential breach or misconfiguration."
    answer_sources:
      - "Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Log)"
      - "Zeek http.log"
      - "NAI: Cloud audit log aggregation platform, Network Egress Points, Cloud Management Consoles/APIs, Virtual Private Cloud (VPC) Flow Logs"
    range: "last 90 days"
    queries:
      - "SEARCH cloud audit logs (CloudTrail, Azure Activity Log) | ALERT where eventName is 'AuthorizeSecurityGroupIngress' or 'CreateFirewall' AND source_range is '0.0.0.0/0' AND port is in (22, 3389, 5985, 5986)"
  - question: "Is a user or service principal making an unusual number or type of network security changes in the cloud?"
    context: "This question aims to detect anomalous behavior at the user level. An administrator might make occasional security group changes, but a sudden flurry of changes, or a user making a type of change they've never made before, could indicate a compromised account. Baselining individual user behavior provides a more tailored and less noisy approach than global thresholds."
    answer_sources:
      - "Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Log)"
      - "Zeek http.log"
      - "NAI: Cloud audit log aggregation platform, Network Egress Points, Cloud Management Consoles/APIs, Virtual Private Cloud (VPC) Flow Logs"
    range: "last 90 days"
    queries:
      - "SEARCH cloud audit logs | BASELINE frequency and type of network changes per user over 90 days | DETECT new change where count > 99th_percentile OR type is new for that user"
  - question: "Can an anomaly detection model identify suspicious cloud network configuration changes based on a combination of factors?"
    context: "This question uses an unsupervised machine learning model (Isolation Forest) to find rare and unusual network changes. The model considers multiple features simultaneously—who made the change, from where, at what time, and the specifics of the rule itself. This multi-dimensional analysis can identify suspicious changes that might look normal if each factor is considered in isolation, providing a powerful tool for finding novel threats."
    answer_sources:
      - "Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Log)"
      - "Zeek http.log"
      - "NAI: Cloud audit log aggregation platform, Network Egress Points, Cloud Management Consoles/APIs, Virtual Private Cloud (VPC) Flow Logs"
    range: "last 90 days"
    queries:
      - "MODEL (Isolation Forest) on features (user, source_ASN, time_of_day, change_params) from cloud audit logs | SCORE all new network changes | ALERT on events flagged as anomalies"