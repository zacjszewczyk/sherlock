name: "T1021.007: Cloud Services"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook addresses the threat of adversaries leveraging federated or synchronized identities to pivot from an on-premises host to a cloud service, and subsequently using that access to move laterally to another on-premises system. It provides investigative questions to detect this activity by monitoring for several key indicators: successful on-premises authentication followed by immediate connections to cloud services, particularly from rare or watchlisted IPs; the execution of cloud CLI tools with suspicious arguments or anomalous command-line characteristics; high-volume enumeration of cloud APIs followed by internal lateral movement attempts; and insecure cloud network configuration changes that expose sensitive ports to the internet."
type: "technique"
related: 
    - "TA0008: Lateral Movement"
contributors:
    - "Zachary Szewczyk"
    - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
    - question: "Has a known compromised host authenticated to the network and immediately connected to a cloud service provider?"
      context: "This question aims to detect the initial pivot from a compromised on-premises system to the cloud. An adversary, having gained a foothold on a host, may use its credentials to access cloud resources. Correlating a network authentication from a watchlisted (compromised) IP with a subsequent, quick connection to a cloud provider is a strong indicator of this lateral movement technique."
      answer_sources:
          - "Windows Event ID 4624"
          - "Zeek conn.log"
          - "Domain Controllers"
          - "ADFS Servers"
          - "Network Egress Points"
          - "Endpoint devices"
      range: "Last 90 days"
      queries:
          - "SEARCH Windows Event ID 4624 (Logon Type 3) AND source_ip IN watchlist | JOIN source_ip, time (within 5 mins) with (SEARCH Zeek conn.log WHERE dest_ip IN cloud_provider_ranges) | RETURN user, source_ip, dest_ip, timestamp"
    - question: "Has a user authenticated from an IP address that is historically rare for them and then immediately connected to a cloud service?"
      context: "This question identifies anomalous user behavior that could indicate account compromise or session hijacking. Adversaries may use stolen credentials from locations unfamiliar to the user. By baselining normal authentication sources for each user, we can flag logins from rare IPs, especially when they are immediately followed by cloud activity, as suspicious."
      answer_sources:
          - "Windows Event ID 4624"
          - "Zeek conn.log"
          - "Domain Controllers"
          - "ADFS Servers"
          - "Network Egress Points"
          - "Endpoint devices"
      range: "Last 90 days"
      queries:
          - "FOR each user, BASELINE source_ips from Windows Event ID 4624 over 90 days | SEARCH Windows Event ID 4624 (Logon Type 3) WHERE source_ip_rarity < 1st_percentile_for_user | JOIN user, time (within 5 mins) with (SEARCH Zeek conn.log WHERE dest_ip IN cloud_provider_ranges) | ALERT on match"
    - question: "Does a machine learning model classify a combined on-premises authentication and subsequent cloud connection event as suspicious?"
      context: "This leverages machine learning to detect complex, non-obvious patterns of malicious activity. By training a model on various features like geolocation, time, and destination service from both authentication and network logs, we can identify events that, while not violating a simple rule, collectively appear suspicious based on historical data. This is useful for finding novel or evasive attack patterns."
      answer_sources:
          - "Windows Event ID 4624"
          - "Zeek conn.log"
          - "Domain Controllers"
          - "ADFS Servers"
          - "Network Egress Points"
          - "Endpoint devices"
      range: "Last 90 days"
      queries:
          - "INPUT features (user, source_geo, time_of_day, dest_cloud_service) from joined auth and network logs INTO trained_model | IF model_output == 'suspicious' AND confidence_score > 0.9 | ALERT event_details"
    - question: "Has a cloud command-line tool been executed with command-line arguments indicating high-risk activities like remote execution or credential access?"
      context: "Adversaries often use legitimate cloud CLI tools for malicious purposes. This question focuses on detecting the use of these tools with specific commands or arguments that are rarely used in normal administrative tasks but are common in attacks, such as running commands on remote instances, accessing secrets, or modifying resources."
      answer_sources:
          - "Windows Event ID 4688"
          - "User Workstations"
          - "Management Servers"
          - "CI/CD Pipeline Servers"
          - "Developer Endpoints"
      range: "Last 90 days"
      queries:
          - "SEARCH Windows Event ID 4688 WHERE process_name IN ('aws.exe', 'az.exe', 'gcloud.cmd', 'Connect-AZAccount', 'Connect-MgGraph') AND command_line CONTAINS ('run-command', 'get-session-token', 'compute ssh', 'Invoke-Command') | RETURN hostname, user, process_name, command_line"
    - question: "Has a cloud command-line tool been executed with an unusually long or complex (high entropy) command line compared to its historical baseline?"
      context: "Malicious commands, especially those that are obfuscated or contain embedded scripts/payloads, are often significantly longer or more random-looking (higher entropy) than typical administrative commands. By baselining the normal length and complexity for each CLI tool, we can flag outliers that may represent obfuscated or malicious usage."
      answer_sources:
          - "Windows Event ID 4688"
          - "User Workstations"
          - "Management Servers"
          - "CI/CD Pipeline Servers"
          - "Developer Endpoints"
      range: "Last 90 days"
      queries:
          - "FOR each cloud_cli_tool, BASELINE command_line_length and command_line_entropy over 30 days | SEARCH Windows Event ID 4688 | IF command_line_length > 98th_percentile OR command_line_entropy > 98th_percentile for that tool | ALERT process_details"
    - question: "Does a machine learning model classify a specific cloud CLI execution as malicious based on its command-line arguments?"
      context: "This question uses a more sophisticated, content-aware approach to analyzing command lines. By converting the command-line arguments into numerical features (TF-IDF vectors), a model can learn the nuanced differences between benign and malicious commands, allowing it to detect threats that don't rely on simple keyword matching or length/entropy anomalies."
      answer_sources:
          - "Windows Event ID 4688"
          - "User Workstations"
          - "Management Servers"
          - "CI/CD Pipeline Servers"
          - "Developer Endpoints"
      range: "Last 90 days"
      queries:
          - "INPUT TF-IDF_vector of command_line from Windows Event ID 4688 INTO trained_model | IF model_output == 'malicious_execution' | ALERT process_details"
    - question: "Did an internal host perform extensive cloud API enumeration and then attempt to connect to another internal host using a common lateral movement protocol?"
      context: "This question aims to detect a specific attack chain: an adversary first uses cloud APIs to discover resources and gather information (enumeration), and then uses that information to pivot to another target within the on-premises network. The sequence of high-volume API calls followed by an internal connection on a high-risk port is a strong indicator of this behavior."
      answer_sources:
          - "Zeek conn.log"
          - "Zeek http.log"
          - "Zeek dns.log"
          - "Network Egress Points"
          - "Internal network segments (East-West traffic)"
          - "DNS servers"
      range: "Last 90 days"
      queries:
          - "SEARCH Zeek http.log for source_ip with >50 unique URIs to cloud_api_hosts within 10 mins | WATCHLIST source_ip for 1 hour | IF watchlisted_ip connects to internal_dest_ip on ports (22, 445, 3389, 5985, 5986) in Zeek conn.log | HIGH_SEVERITY_ALERT"
    - question: "Has an internal host exhibited a sudden, anomalous spike in the number of unique cloud API endpoints it is contacting?"
      context: "This question focuses on detecting the reconnaissance phase of an attack. A sudden burst of requests to many different API endpoints from a single host is abnormal and strongly suggests an adversary is enumerating cloud resources. This provides an early warning of potential malicious activity before lateral movement occurs."
      answer_sources:
          - "Zeek conn.log"
          - "Zeek http.log"
          - "Zeek dns.log"
          - "Network Egress Points"
          - "Internal network segments (East-West traffic)"
          - "DNS servers"
      range: "Last 90 days"
      queries:
          - "FOR each source_ip, BASELINE hourly unique_cloud_api_uri_count over 30 days (moving average + std dev) | SEARCH Zeek http.log | IF current_hour_count > (moving_average + 3 * std_dev) | ALERT source_ip, count"
    - question: "Has a host exhibiting outlier behavior in its cloud API access patterns subsequently connected to other internal assets on lateral movement ports?"
      context: "This uses unsupervised machine learning (clustering) to find hosts that 'don't fit in' with normal patterns of cloud API access. Instead of just looking at volume, this can identify anomalies across multiple dimensions (e.g., a strange User-Agent accessing a rare set of endpoints). Linking these outlier hosts to subsequent internal lateral movement attempts provides a powerful, data-driven detection method."
      answer_sources:
          - "Zeek conn.log"
          - "Zeek http.log"
          - "Zeek dns.log"
          - "Network Egress Points"
          - "Internal network segments (East-West traffic)"
          - "DNS servers"
      range: "Last 90 days"
      queries:
          - "APPLY DBSCAN to (source_ip, dest_hostname, user_agent) from Zeek http.log in 15-min windows | IDENTIFY outlier source_ips | FOR each outlier_ip, SEARCH Zeek conn.log within next 60 mins for connections to internal_dest_ip on ports (22, 445, 3389, 5985, 5986) | ALERT on match"
    - question: "After a user authenticated from a brand-new source IP, did an inbound connection from a cloud provider connect to a different internal system?"
      context: "This detects a potential 'pivot back' from the cloud. The scenario is: an adversary compromises a user's credentials, authenticates from a new location, uses the cloud access to initiate an action (like Run Command), which then results in a connection from the cloud provider's infrastructure back into the on-premises network, but to a different machine (the target)."
      answer_sources:
          - "Windows Event ID 4624"
          - "Zeek conn.log"
          - "Domain Controllers"
          - "ADFS Servers"
          - "Bastion Hosts"
          - "Network Firewalls/Gateways"
      range: "Last 90 days"
      queries:
          - "MAINTAIN lookup of (user, source_ip) from last 90 days of auth logs | ON new auth, IF (user, source_ip) is new, FLAG session for 60 mins | IF inbound connection from cloud_ip_range to internal_ip_B (where internal_ip_B != flagged source_ip) occurs in window | ALERT"
    - question: "Has a risk score, combining the rarity of a user's authentication source IP with the sensitivity of a target host, exceeded a defined threshold following an inbound connection from a cloud provider?"
      context: "This question enhances the previous one by adding risk scoring. Instead of a binary 'new/not new' check, it quantifies the rarity of the authentication source. It then combines this with the importance of the target system. This allows for more nuanced alerting, focusing analyst attention on events that pose the greatest potential risk."
      answer_sources:
          - "Windows Event ID 4624"
          - "Zeek conn.log"
          - "Domain Controllers"
          - "ADFS Servers"
          - "Bastion Hosts"
          - "Network Firewalls/Gateways"
      range: "Last 90 days"
      queries:
          - "ON new auth, CALCULATE rarity_score = (1 / frequency of source_ip for user) | IF inbound connection from cloud_ip to internal_ip_B within 30 mins | GET sensitivity_score for internal_ip_B | CALCULATE final_risk = rarity_score * sensitivity_score | IF final_risk > threshold | ALERT"
    - question: "Does a graph-based anomaly detection model identify a low-probability path representing a user authenticating from an on-prem host, connecting to the cloud, and the cloud then connecting back to a different on-prem host?"
      context: "This question models the entire attack chain as a path in a graph database. By representing entities (users, hosts, cloud IPs) as nodes and actions (authentication, connections) as edges, we can use powerful graph algorithms to find anomalous paths that don't conform to normal operational patterns. This is highly effective at visualizing and detecting complex, multi-stage lateral movement."
      answer_sources:
          - "Windows Event ID 4624"
          - "Zeek conn.log"
          - "Domain Controllers"
          - "ADFS Servers"
          - "Bastion Hosts"
          - "Network Firewalls/Gateways"
      range: "Last 90 days"
      queries:
          - "CONSTRUCT graph with nodes (users, hosts, cloud_ips) and edges (authenticates_from, connects_to) | APPLY graph anomaly detection algorithm | IF path (user -> host_A -> cloud_ip -> host_B) has low probability score | ALERT path_details"
    - question: "Has a network security configuration change been made in the cloud that opens a sensitive port (e.g., RDP, SSH, WinRM) to the entire internet?"
      context: "Adversaries who gain access to cloud management consoles may try to create backdoors or expose internal services by modifying firewall or network security group rules. Opening sensitive management ports like SSH or RDP to the world (`0.0.0.0/0`) is a high-risk action and a common misconfiguration that adversaries exploit."
      answer_sources:
          - "Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Log)"
          - "Zeek http.log"
          - "Cloud audit log aggregation platform"
          - "Network Egress Points"
          - "Cloud Management Consoles/APIs"
          - "Virtual Private Cloud (VPC) Flow Logs"
      range: "Last 90 days"
      queries:
          - "SEARCH cloud_audit_logs WHERE event_name IN ('AuthorizeSecurityGroupIngress', 'CreateFirewall') AND source_range == '0.0.0.0/0' AND destination_port IN (22, 3389, 5985, 5986) | ALERT event_details"
    - question: "Has a user or service principal made an anomalously high number of network security changes, or a type of change they have never made before?"
      context: "This question seeks to detect unusual behavior by a specific identity. While a single security group change might be legitimate, a flurry of changes by a user who rarely performs them, or a user making a type of change they've never made before, is highly suspicious and could indicate a compromised account."
      answer_sources:
          - "Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Log)"
          - "Zeek http.log"
          - "Cloud audit log aggregation platform"
          - "Network Egress Points"
          - "Cloud Management Consoles/APIs"
          - "Virtual Private Cloud (VPC) Flow Logs"
      range: "Last 90 days"
      queries:
          - "FOR each user, BASELINE frequency and type of network_config_changes over 90 days | SEARCH cloud_audit_logs for network_config_change | IF change_count_in_24h > 99th_percentile OR change_type is new for user | ALERT user, change_details"
    - question: "Does a machine learning model, trained on historical network configuration changes, flag a new change as an anomaly?"
      context: "This question applies unsupervised machine learning to detect suspicious network changes that may not be caught by simple rules. The model can learn the normal combinations of who makes changes, from where, at what time, and to what resources. Any change that significantly deviates from this learned norm will be flagged as an anomaly for investigation."
      answer_sources:
          - "Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Log)"
          - "Zeek http.log"
          - "Cloud audit log aggregation platform"
          - "Network Egress Points"
          - "Cloud Management Consoles/APIs"
          - "Virtual Private Cloud (VPC) Flow Logs"
      range: "Last 90 days"
      queries:
          - "INPUT features (user, source_ASN, time_of_day, change_parameters) from cloud_audit_log into Isolation Forest model | IF model flags event as anomaly | ALERT event_details"