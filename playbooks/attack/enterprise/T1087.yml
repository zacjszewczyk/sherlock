name: 'T1087: Account Discovery'
id: 'f5d8a8a4-3b7c-4c0e-8d1a-9f6b3e2c1d0b'
description: 'This playbook helps analysts investigate whether an adversary is attempting to discover local, domain, or cloud accounts. This is a common reconnaissance activity where attackers try to understand the user and administrative landscape of a compromised network. Detections focus on identifying the execution of known discovery tools (e.g., AdFind, SharpHound), the use of built-in command-line utilities for enumeration (`net user`, `Get-ADUser`), unusual process chains (e.g., an Office application spawning PowerShell), anomalous network traffic patterns against domain controllers (LDAP, SAMR), and access to decoy accounts or files (honeytokens).'
type: 'technique'
related:
  - 'TA0007: Discovery'
contributors:
  - 'Zachary Szewczyk, Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Has a known malicious account discovery tool been executed, identified by its file hash or original filename?'
    context: 'This question aims to detect the use of well-known hacking tools like AdFind or SharpHound. By comparing process execution logs against a threat intelligence feed of known malicious file hashes and names, analysts can quickly identify blatant discovery attempts. A match provides high-confidence evidence of malicious intent.'
    answer_sources:
      - 'Windows Event ID 4688 from Domain Controllers, Member Servers, Privileged Access Workstations'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_events (event_id=4688) WHERE (process_hash IN known_discovery_tool_hashes OR original_filename IN known_discovery_tool_names)'
  - question: 'Has a statistically rare or never-before-seen process been executed that is not on the corporate allow-list?'
    context: 'Adversaries may rename common discovery tools to evade name-based detections. This question addresses that by focusing on rarity. It helps analysts find processes that are statistical outliers within the environment. By baselining normal application usage, any process that is exceptionally rare becomes suspicious, potentially indicating a custom or renamed malicious tool.'
    answer_sources:
      - 'Windows Event ID 4688 from Domain Controllers, Member Servers, Privileged Access Workstations'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_events (event_id=4688) | CALCULATE prevalence of original_filename per host | FILTER prevalence < 0.01% AND original_filename NOT IN (enterprise_app_allowlist)'
  - question: 'Does a machine learning model classify a new process execution as a malicious discovery activity based on its combined features?'
    context: 'This question moves beyond single indicators to a more holistic, context-aware detection. By training a model on a variety of features—such as command-line complexity, the process parent, user context, and rarity—analysts can identify suspicious activity that might not trigger simpler rules. This approach is effective at finding novel or obfuscated tools.'
    answer_sources:
      - 'Windows Event ID 4688 from Domain Controllers, Member Servers, Privileged Access Workstations'
    range: 'last 90 days'
    queries:
      - 'STREAM process_creation_events (event_id=4688) | SCORE with classification_model (features: cmd_entropy, parent_process, user, rarity) | ALERT if score > high_probability_threshold'
  - question: 'Has a command-line interpreter been used with arguments specific to user, group, or access enumeration?'
    context: 'This question targets the "living off the land" technique, where adversaries use built-in system utilities like `net.exe` or `powershell.exe` to perform discovery. By searching for specific command-line patterns (e.g., `net user /domain`, `Get-ADUser`), analysts can pinpoint when these utilities are being leveraged for reconnaissance rather than routine administration.'
    answer_sources:
      - 'Windows Event ID 4688 from All Windows Endpoints, Domain Controllers, Application Servers, Cloud Tenant Environments'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_events (event_id=4688) WHERE command_line MATCHES REGEX (`net user`, `net group`, `Get-ADUser`, `az ad user list`)'
  - question: 'Is a user or system executing an anomalously high number of enumeration commands compared to their historical baseline?'
    context: 'While a single enumeration command might be legitimate, a rapid succession of them is highly suspicious. This question helps detect this by establishing a "normal" baseline of command usage for each user and host. An alert is triggered when activity exceeds this baseline by a significant margin (e.g., 3 standard deviations), catching attackers who are systematically mapping out the environment.'
    answer_sources:
      - 'Windows Event ID 4688 from All Windows Endpoints, Domain Controllers, Application Servers, Cloud Tenant Environments'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_events (event_id=4688) with enumeration_commands | AGGREGATE count by user, host, time_window | ALERT if count > (historical_average + 3 * std_dev)'
  - question: 'Has an unsupervised machine learning model identified a command-line execution as a statistical outlier?'
    context: 'Adversaries often obfuscate commands to bypass simple keyword or regex-based detections. This question uses unsupervised learning (like an Isolation Forest) to find these hidden threats. The model analyzes the structure of command lines, flagging those that are statistically different from the vast majority of legitimate commands, uncovering novel or obfuscated techniques.'
    answer_sources:
      - 'Windows Event ID 4688 from All Windows Endpoints, Domain Controllers, Application Servers, Cloud Tenant Environments'
    range: 'last 90 days'
    queries:
      - 'STREAM process_creation_events (event_id=4688) | VECTORIZE command_line (e.g., TF-IDF) | SCORE with anomaly_detection_model (e.g., Isolation Forest) | ALERT if command is outlier'
  - question: 'Has a command-line interpreter (like cmd.exe or powershell.exe) been launched by an unusual parent process, such as an Office application or web browser?'
    context: 'This question targets a common sign of compromise from phishing or web-based exploits. Legitimate administrative activity rarely involves launching a command prompt from within Microsoft Word. Detecting these high-risk parent-child process relationships (e.g., `WINWORD.EXE` -> `powershell.exe`) provides a high-fidelity signal of malicious code execution.'
    answer_sources:
      - 'Windows Event ID 4688 from User Workstations, Web Servers, Microsoft Exchange Servers, Virtual Desktop Infrastructure (VDI)'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_events (event_id=4688) WHERE parent_process IN (`WINWORD.EXE`, `chrome.exe`, `w3wp.exe`) AND child_process IN (`cmd.exe`, `powershell.exe`)'
  - question: 'Has a parent-child process relationship occurred that is statistically rare across the entire enterprise?'
    context: 'This question expands on the previous one by using data-driven analysis instead of a manually curated list of "bad" parents. By profiling all parent-child process relationships, a probability can be assigned to each pair. Any new process creation that represents an extremely low-probability pairing is flagged as suspicious, uncovering novel attack chains.'
    answer_sources:
      - 'Windows Event ID 4688 from User Workstations, Web Servers, Microsoft Exchange Servers, Virtual Desktop Infrastructure (VDI)'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_events (event_id=4688) | CALCULATE conditional_probability(child|parent) for all pairs | ALERT if new event has probability < 0.001%'
  - question: 'Did a user''s session contain a sequence of process creations that a machine learning model deems anomalous?'
    context: 'Attacks often unfold as a sequence of actions. This question uses a model (like an LSTM Autoencoder) to learn what "normal" sequences of process creations look like. It can then spot deviations from this norm, such as a sequence like `OUTLOOK.EXE` -> `powershell.exe` -> `net.exe`, which breaks from typical user behavior.'
    answer_sources:
      - 'Windows Event ID 4688 from User Workstations, Web Servers, Microsoft Exchange Servers, Virtual Desktop Infrastructure (VDI)'
    range: 'last 90 days'
    queries:
      - 'GROUP process_creation_events by user_session | MODEL sequence with LSTM_Autoencoder | ALERT if reconstruction_error > threshold'
  - question: 'Have specific, high-risk directory service enumeration operations (like SAMR EnumDomainUsers) been observed on the network?'
    context: 'This question focuses on detecting discovery at the network level by monitoring protocols like SAMR and Kerberos. Certain RPC calls (`EnumDomainUsers`) and Kerberos errors (from Kerberoasting) are almost exclusively used for malicious reconnaissance. Alerting on these provides a strong indication that an attacker is mapping Active Directory.'
    answer_sources:
      - 'Zeek conn.log, Zeek ldap.log, Zeek dce_rpc.log, Zeek kerberos.log, Windows Event ID 4662 from Network segments fronting Domain Controllers, The Domain Controllers themselves'
    range: 'last 90 days'
    queries:
      - 'SEARCH dce_rpc_logs WHERE endpoint=`samr` AND operation IN (`EnumDomainUsers`, `QueryDisplayInfo`) OR SEARCH kerberos_logs WHERE error_code=`KDC_ERR_S_PRINCIPAL_UNKNOWN`'
  - question: 'Has a host sent an unusually high volume or variety of LDAP queries to a domain controller?'
    context: 'Tools like BloodHound generate a large volume of diverse LDAP queries. This question detects this behavior statistically. By baselining the normal volume and measuring the "randomness" (entropy) of LDAP filters from each host, analysts can spot sudden spikes and broad, non-standard queries that indicate enumeration.'
    answer_sources:
      - 'Zeek conn.log, Zeek ldap.log, Zeek dce_rpc.log, Zeek kerberos.log, Windows Event ID 4662 from Network segments fronting Domain Controllers, The Domain Controllers themselves'
    range: 'last 90 days'
    queries:
      - 'SEARCH ldap_logs | CALCULATE requests_per_10min and filter_entropy by source_ip | ALERT if requests > 95th_percentile OR entropy shows spike'
  - question: 'Is a host''s directory service query behavior anomalous compared to its functionally similar peers?'
    context: 'This question enhances anomaly detection with peer group analysis. Systems with similar roles should have similar network behavior. By clustering hosts into peer groups, a model can build a more accurate baseline. An alert is triggered if one host starts behaving differently from its peers, indicating a potential compromise.'
    answer_sources:
      - 'Zeek conn.log, Zeek ldap.log, Zeek dce_rpc.log, Zeek kerberos.log, Windows Event ID 4662 from Network segments fronting Domain Controllers, The Domain Controllers themselves'
    range: 'last 90 days'
    queries:
      - 'CLUSTER hosts into peer_groups based on network_traffic | For each host, MODEL query_volume with time_series_forecast | ALERT if actual_volume deviates significantly from peer_group_forecast'
  - question: 'Has any activity been detected involving a decoy user account, file, or other honeytoken?'
    context: 'This question represents a high-fidelity detection method. Honeytokens are decoy assets (like a fake user account) that have no legitimate reason to be accessed. By placing these traps and enabling auditing, any access attempt becomes an immediate, high-priority alert, as it almost certainly indicates an adversary is snooping.'
    answer_sources:
      - 'Windows Event ID 4663, Windows Event ID 5145, Windows Event ID 4720 from File Servers, SharePoint Sites, Network-accessible Script Repositories, Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'SEARCH audit_logs WHERE target_object IN (decoy_file_list, decoy_user_list) | ALERT on any access'
  - question: 'Has a single user or process accessed an anomalously high number of unique user home directories or profile folders in a short period?'
    context: 'Adversaries often iterate through user directories on file servers to find data. This behavior is distinct from normal activity. This question establishes a baseline for how many unique user directories are normally accessed per hour. An alert is triggered when this number is significantly exceeded, suggesting automated enumeration.'
    answer_sources:
      - 'Windows Event ID 4663, Windows Event ID 5145, Windows Event ID 4720 from File Servers, SharePoint Sites, Network-accessible Script Repositories, Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'SEARCH file_access_logs (event_id=4663/5145) | AGGREGATE count of unique_user_directories_accessed by user, process, per_hour | ALERT if count > (historical_average + 3 * std_dev)'
  - question: 'Does a machine learning model classify a sequence of file access events as anomalous?'
    context: 'This question uses machine learning to find subtle signs of discovery within file access logs. By training a model on features of "normal" file access, it can identify outlier events that do not fit the pattern. This can catch sophisticated attackers who try to "blend in" by accessing data slowly, an activity that might be missed by simple threshold-based alerts.'
    answer_sources:
      - 'Windows Event ID 4663, Windows Event ID 5145, Windows Event ID 4720 from File Servers, SharePoint Sites, Network-accessible Script Repositories, Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'STREAM file_access_logs (event_id=4663/5145) | SCORE with One-Class_SVM_model (features: process, user, path_entropy) | ALERT if event is outlier'