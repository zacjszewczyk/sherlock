name: T1564.008: Email Hiding Rules
id: 3c9b1f2a-8d7e-4b6c-9f0a-1e2d3c4b5a6b
description: This playbook helps investigate whether an adversary is using email hiding rules to evade detection or facilitate malicious activities. It focuses on detecting the creation of suspicious inbox and transport rules via PowerShell cmdlets (`New-InboxRule`, `Set-InboxRule`, `New-TransportRule`, `Set-TransportRule`), particularly those with parameters matching known malicious indicators, containing security-related keywords, or created under anomalous user contexts. The playbook also looks for suspicious post-rule-creation activity, such as anomalous network traffic, and direct modification of Outlook rule files (.rwz, .pst, .ost) by non-standard processes.
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: How can we detect the creation of new inbox rules that contain known malicious indicators in their parameters?
  context: Adversaries may create inbox rules using PowerShell to automatically delete or move emails containing certain keywords, such as those from security teams or related to their malicious campaigns. This question aims to identify such rules by comparing their parameters (like subject, body, or sender) against a high-confidence list of known malicious domains, email addresses, or keywords. A match strongly indicates a defense evasion attempt.
  answer_sources:
  - Windows Event ID 4104
  - Mail Servers
  - User Endpoints
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SEARCH EventID=4104 AND ScriptBlock CONTAINS ("New-InboxRule" OR "Set-InboxRule") | PARSE rule_parameters FROM ScriptBlock | JOIN rule_parameters WITH threat_intel_feed ON value | IF match FOUND, ALERT
- question: Are there any newly created inbox rules with condition parameters that are statistically similar to a known set of malicious keywords?
  context: Instead of exact matches to IOCs, adversaries might use terms thematically related to malicious activity. This question uses Jaccard similarity to measure the overlap between words in a new rule's conditions and a curated set of malicious keywords. A high similarity score, especially one that is an outlier compared to normal rule creations, suggests a cleverly crafted malicious rule.
  answer_sources:
  - Windows Event ID 4104
  - Mail Servers
  - User Endpoints
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FOR each new_rule_event | EXTRACT words FROM rule_conditions | CALCULATE jaccard_similarity(words, malicious_keyword_set) | IF jaccard_similarity > 95th_percentile_baseline, ALERT
- question: Can we use a machine learning model to assign a real-time risk score to new inbox rule creation events based on their characteristics?
  context: This question proposes a proactive, predictive approach. By training a logistic regression model on historical data, we can learn the patterns of both benign and malicious rule creations. The model considers features like the presence of IOCs, rule name length, and the rule's action (e.g., delete vs. move). This allows for the automatic flagging of new rules that exhibit characteristics associated with past malicious activity.
  answer_sources:
  - Windows Event ID 4104
  - Mail Servers
  - User Endpoints
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: ON new_rule_event | FEATURE_ENGINEER (has_ioc, name_length, action_type, etc.) | PREDICT risk_score with logistic_regression_model | IF risk_score > threshold, ALERT
- question: Are service accounts not on an allow-list executing PowerShell commands to create or modify inbox rules?
  context: Inbox rule modification is typically a user-level action. When a service account, which should have a predictable and limited set of permissions, is observed creating email rules, it is highly anomalous. This question correlates process creation events with script block logs to detect if a non-allow-listed service account is performing this suspicious activity, which could indicate credential compromise or misuse.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Domain Controllers
  - Mail Servers
  - User Endpoints
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SEARCH EventID=4688 AND CommandLine CONTAINS ("New-InboxRule" OR "Set-InboxRule") AND UserAccount IS service_account | JOIN on ProcessID with EventID=4104 | IF UserAccount NOT IN (exchange_admin_allowlist), ALERT
- question: Are users creating inbox rules at unusual times or from non-standard source hosts?
  context: Adversaries operating with stolen credentials may not be aware of the user's typical behavior patterns. This question establishes a baseline of normal activity for each user (e.g., working hours, typical workstations) and uses a Z-score to flag rule creation events that deviate significantly from this baseline. Such deviations are strong indicators of account misuse.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Domain Controllers
  - Mail Servers
  - User Endpoints
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FOR each rule_creation_event | GET user, time_of_day, source_host | CALCULATE z_score(time_of_day, source_host) against user_baseline | IF z_score > 3, ALERT
- question: Can an anomaly detection model identify outlier inbox rule creation events based on user role, time, and source host?
  context: This question uses an unsupervised machine learning model (Isolation Forest) to find the "odd one out" among rule creation events. By considering multiple dimensions at once—like the user's role, the time of day, and the type of machine used—the model can identify complex anomalies that might be missed by single-variable statistical checks. It's effective at finding novel or previously unseen attack patterns.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Domain Controllers
  - Mail Servers
  - User Endpoints
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: ON new_rule_event | FEATURE_ENGINEER (user_role, time_of_day, day_of_week, source_host_role) | PREDICT anomaly_score with isolation_forest_model | IF anomaly_score indicates outlier, ALERT
- question: Are there any transport rules being created to delete or redirect emails that contain security-related keywords?
  context: Adversaries may create transport rules on a mail server to intercept security alerts or reports before they reach the security team. This question looks for the explicit creation of rules that target keywords like 'phishing' or 'breach' and whose action is to delete the message or redirect it, effectively blinding the organization to an ongoing attack.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Mail Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SEARCH EventID=4104 AND ScriptBlock CONTAINS ("New-TransportRule" OR "Set-TransportRule") AND ScriptBlock CONTAINS security_keywords AND ScriptBlock CONTAINS ("DeleteMessage" OR "RedirectMessage"), ALERT
- question: Are new transport rules being created using unusually rare or specific keywords in their conditions?
  context: Common transport rules often use broad, frequently seen terms. An adversary might use very specific or rare keywords to precisely target their communications while avoiding detection. This question uses Inverse Document Frequency (IDF) to score the rarity of words in a rule's conditions. A high cumulative IDF score suggests the rule is an outlier and warrants investigation.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Mail Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FOR each new_transport_rule | EXTRACT keywords FROM conditions | CALCULATE cumulative_idf(keywords) | IF cumulative_idf > 99th_percentile_baseline, ALERT
- question: Can a machine learning classifier predict whether a new transport rule is malicious based on its content and action?
  context: This question leverages a Naive Bayes classifier, which is well-suited for text classification, to automatically assess the maliciousness of new transport rules. By training on a labeled dataset, the model learns the probability that certain words or actions (like 'Delete' or 'Redirect') are associated with malicious rules, providing a scalable way to flag suspicious server-level changes.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Mail Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: ON new_transport_rule_event | FEATURE_ENGINEER (bag_of_words, action_type) | PREDICT probability_malicious with naive_bayes_model | IF probability_malicious > threshold, ALERT
- question: Are inbox rules being created to automatically delete or hide emails related to common business themes like 'invoice' or 'password reset'?
  context: This is a classic adversary technique used in Business Email Compromise (BEC) and other phishing schemes. The adversary creates a rule to hide their malicious emails (e.g., replies from the victim's contacts) by moving them to an obscure folder like 'RSS Feeds' or deleting them outright. This question searches for the creation of such rules.
  answer_sources:
  - Windows Event ID 4104
  - User Endpoints
  - Mail Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SEARCH EventID=4104 AND ScriptBlock CONTAINS "New-InboxRule" AND ScriptBlock CONTAINS high_risk_keywords AND (ScriptBlock CONTAINS "-DeleteMessage $true" OR ScriptBlock CONTAINS low_visibility_folders), ALERT
- question: Are inbox rules being created that move emails to folders with unusually random or obfuscated names?
  context: To avoid detection, an adversary might create a rule that moves emails to a folder with a high-entropy name (e.g., 'a1x3v_'). Such names are difficult for a user to spot during a casual review. This question calculates the Shannon entropy of destination folder names to statistically identify and flag these likely-malicious, obfuscated folders.
  answer_sources:
  - Windows Event ID 4104
  - User Endpoints
  - Mail Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FOR each rule_creation_event with "-MoveToFolder" | EXTRACT folder_name | CALCULATE shannon_entropy(folder_name) | IF shannon_entropy > 95th_percentile_baseline, ALERT
- question: Is there an anomalous spike in the daily number of email-deleting rules being created across the organization?
  context: While a single user creating a deleting rule might be normal, a sudden, enterprise-wide increase in the creation of these rules is highly suspicious and could indicate a widespread, coordinated campaign. This question uses a time-series model (like ARIMA) to forecast the expected number of such rules and alerts when the actual count significantly exceeds the prediction.
  answer_sources:
  - Windows Event ID 4104
  - User Endpoints
  - Mail Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: AGGREGATE daily count of rules with "DeleteMessage" action | APPLY ARIMA model to time_series | IF actual_count > forecasted_upper_bound, ALERT
- question: Following the creation of an email rule, is the associated host observed making a large data transfer to a newly seen domain?
  context: Creating an email hiding rule is often a precursor to another action, such as data exfiltration or C2 communication. A connection to a domain never before seen, followed by a significant data transfer, occurring shortly after a rule is created, is a strong signal of post-compromise activity.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 4104
  - Network Egress Points
  - User Endpoints
  - DNS Servers
  range: within 60 minutes after the event
  queries:
  - search_technology: Pseudocode
    query: ON rule_creation_event | GET source_ip, timestamp | SEARCH dns.log for source_ip in next 60_mins | IF resolved_domain is new (not seen in 30 days) | SEARCH conn.log for connection to resolved_ip | IF sum(orig_bytes) > 10MB, ALERT
- question: After an email rule is created on a host, does that host initiate an unusually large data transfer to a country it doesn't normally communicate with?
  context: This question focuses on identifying anomalous network behavior based on geolocation and data volume. A connection to a new country combined with a data transfer volume that is statistically significant (e.g., >3 standard deviations above the mean) after a rule is created points to potential data exfiltration or C2 activity.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 4104
  - Network Egress Points
  - User Endpoints
  - DNS Servers
  range: within 60 minutes after the event
  queries:
  - search_technology: Pseudocode
    query: ON rule_creation_event | GET source_ip, user | SEARCH conn.log for source_ip in next 60_mins | GET dest_country, data_volume | IF dest_country is new for user AND data_volume > 3_std_devs above user_average, ALERT
- question: Can a sequence-based ML model detect an anomalous chain of events that begins with an email rule creation?
  context: Adversary actions often follow a logical sequence (e.g., create rule -> launch process -> connect to C2). This question uses an LSTM autoencoder, a model designed to learn normal sequences of events. When it encounters an unusual sequence following a rule creation, it will fail to reconstruct it accurately, resulting in a high reconstruction error and triggering an alert.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 4104
  - Network Egress Points
  - User Endpoints
  - DNS Servers
  range: within 60 minutes after the event
  queries:
  - search_technology: Pseudocode
    query: ON rule_creation_event | CAPTURE sequence of subsequent events (process_create, network_conn, etc.) | PREDICT reconstruction_error with LSTM_autoencoder | IF reconstruction_error > threshold, ALERT
- question: Are processes other than approved mail clients attempting to write to Outlook rule files (.pst, .ost, .rwz)?
  context: Outlook rule files should only be modified by the Outlook client itself or specific, approved utilities. This question monitors for file write attempts on these sensitive files and checks if the process performing the write is on an allow-list. Any unapproved process, such as a malicious script or binary, attempting to modify these files is a major red flag for direct rule manipulation.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - User Endpoints
  - File Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SEARCH EventID=4663 AND ObjectName ENDS WITH (".pst", ".ost", ".rwz") AND AccessMask indicates Write | JOIN on ProcessID with EventID=4688 | GET ProcessName | IF ProcessName NOT IN (approved_mail_client_list), ALERT
- question: Are Outlook rule files being modified by a process that has an unusually rare parent process?
  context: Malicious code is often launched through an unusual execution chain (e.g., a Word macro spawning PowerShell which then launches a malicious binary). This question analyzes the parent process of any process that modifies an Outlook rule file. If the parent process is statistically rare (e.g., `winword.exe` instead of `explorer.exe`), it suggests an anomalous and potentially malicious execution chain.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - User Endpoints
  - File Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FOR each outlook_file_write_event | GET writing_process_id | GET parent_process_name from writing_process_id | CALCULATE rarity_score(parent_process_name) | IF rarity_score is high (<1% historical), ALERT
- question: Can a one-class SVM model identify anomalous modification events on Outlook rule files?
  context: This question uses a one-class SVM to create a tight boundary around what constitutes "normal" modification activity for Outlook rule files, based on features like the process name, parent process, and user. Any new event that falls outside this learned boundary of normalcy is flagged as an anomaly. This is useful for detecting novel attack vectors that don't match predefined rules.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - User Endpoints
  - File Servers
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: ON outlook_file_write_event | FEATURE_ENGINEER (process_name, parent_process, user, time_of_day) | PREDICT anomaly_score with one_class_SVM | IF event is outside normal boundary, ALERT