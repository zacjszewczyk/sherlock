name: T1564.008: Email Hiding Rules
id: d27b9c9a-5b1e-4f0a-8a5d-1c6e7f8b9a0c
description: This playbook helps determine if an adversary is using email hiding rules to evade detection or facilitate other malicious activities. This involves looking for the execution of PowerShell cmdlets like `New-InboxRule`, `Set-InboxRule`, `New-TransportRule`, and `Set-TransportRule` with parameters containing malicious indicators or targeting security-related keywords. It also covers investigations into the context of rule creation, such as anomalous user accounts, unusual source hosts, or execution outside of normal hours. Further indicators include the creation of inbox rules with common phishing keywords that delete or move messages to low-visibility folders, anomalous network traffic following rule creation, and direct file or registry modifications to Outlook rule storage by non-standard processes.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there any new or modified inbox rules created via PowerShell that contain known malicious indicators (domains, email addresses, keywords) in their parameters?
    context: Adversaries may use PowerShell to create inbox rules that automatically handle emails from compromised accounts or containing specific keywords. This question aims to detect such rules by cross-referencing their parameters (`-SubjectContainsWords`, `-BodyContainsWords`, `-From`) with high-confidence threat intelligence feeds, providing a direct method for spotting known malicious activity.
    answer_sources:
      - Windows Event ID 4104
      - Mail Servers
      - User Endpoints
      - Threat Intelligence Feeds
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH event_id=4104 AND script_block CONTAINS ('New-InboxRule' OR 'Set-InboxRule') | EXTRACT rule_parameters | MATCH rule_parameters AGAINST threat_intel_feed
  - question: Are there any newly created inbox rules with condition parameters that are statistically similar to a known set of malicious keywords?
    context: This question helps identify potentially malicious rules that don't match known IOCs exactly. By calculating the Jaccard similarity between the words used in a new rule's conditions and a curated list of malicious terms (e.g., 'phish', 'hack'), we can flag rules that are thematically suspicious. Alerting on high similarity scores helps uncover novel or obfuscated attack patterns.
    answer_sources:
      - Windows Event ID 4104
      - Mail Servers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH event_id=4104 AND script_block CONTAINS 'New-InboxRule' | EXTRACT rule_condition_words | CALCULATE jaccard_similarity(rule_condition_words, malicious_keywords_set) | FILTER similarity_score > 95th_percentile_baseline
  - question: Can a machine learning model identify high-risk inbox rule creation events based on features like rule name, action, target folder, and the presence of IOCs?
    context: This question leverages a logistic regression model to provide a probabilistic risk score for each new rule. By training on a labeled dataset of past benign and malicious rules, the model learns to weigh various features (rule name length, action type, target folder, IOC presence) to predict malicious intent. This allows for a more nuanced and automated detection mechanism than simple symbolic checks.
    answer_sources:
      - Windows Event ID 4104
      - Mail Servers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT event_id=4104 with 'New-InboxRule' | FEATURE_ENGINEER (ioc_present, rule_name_length, action_type, target_folder) | PREDICT risk_score with logistic_regression_model | FILTER risk_score > threshold
  - question: Is a non-approved service account using PowerShell to create or modify inbox rules?
    context: Service accounts typically have specific, automated functions. The creation or modification of inbox rules by a service account not explicitly designated for Exchange management is highly anomalous and could indicate that the account has been compromised and is being used to establish persistence or evade detection. This question correlates process creation events with script block logs to detect this specific misuse.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers
      - Mail Servers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN (event_id=4688 AND process_name='powershell.exe') with (event_id=4104 AND script_block CONTAINS ('New-InboxRule' OR 'Set-InboxRule')) ON process_id | FILTER user_is_service_account AND user NOT IN allowlist
  - question: Has a user created an inbox rule from an unusual host or at an abnormal time of day compared to their established baseline?
    context: Adversaries often operate outside of normal business hours or from compromised systems that are not a user's typical workstation. This question aims to detect such deviations by establishing a baseline of each user's normal rule creation activity (source hosts, time of day). By calculating a Z-score for new events, we can flag statistically significant anomalies that may represent malicious behavior.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers
      - Mail Servers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR_EACH user, CREATE baseline of rule_creation_time and source_host | FOR new_rule_creation, CALCULATE z_score(time_of_day, source_host) from baseline | FILTER z_score > 3
  - question: Can an Isolation Forest model detect anomalous inbox rule creation events based on user role, time, day, and source host role?
    context: This question applies an unsupervised machine learning model, the Isolation Forest, to identify outliers in rule creation activity. The model analyzes events in a multi-dimensional space defined by features like user role, time, and source host type. It is effective at finding unusual combinations of these features (e.g., a standard user creating a rule on a domain controller on a weekend) without needing pre-labeled data.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers
      - Mail Servers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT rule_creation_events | FEATURE_ENGINEER (user_role, time_features, day_of_week, source_host_role) | PREDICT anomaly_score with isolation_forest_model | FILTER is_anomaly
  - question: Has a new transport rule been created to delete or redirect emails containing security-related keywords like 'phishing' or 'incident'?
    context: Adversaries may create transport rules on mail servers to intercept and delete security alerts or reports sent via email. This action would prevent security teams from being notified of malicious activity. This question looks for the explicit creation of such rules by monitoring for specific keywords and actions (`DeleteMessage`, `RedirectMessage`).
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Mail Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH event_id=4104 AND script_block CONTAINS ('New-TransportRule' OR 'Set-TransportRule') AND rule_keywords IN ('phishing', 'incident', 'suspicious') AND rule_action IN ('DeleteMessage', 'RedirectMessage')
  - question: Has a new transport rule been created that uses unusually rare or specific keywords in its conditions?
    context: While some transport rules use common terms, a rule created by an adversary for a targeted purpose might use very specific or rare keywords. This question uses the inverse document frequency (IDF) concept to score the rarity of terms in a new rule's conditions. A high cumulative IDF score suggests the rule is highly specific and warrants investigation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Mail Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MAINTAIN historical_frequency of transport_rule_keywords | FOR new_transport_rule, CALCULATE sum_idf_score for its keywords | FILTER sum_idf_score > 99th_percentile
  - question: Can a Naive Bayes classifier predict whether a new transport rule is malicious based on its keywords and action type?
    context: This question proposes using a Naive Bayes classifier, which is well-suited for text classification tasks, to score new transport rules. By training on a labeled dataset, the model learns the probability that certain words and actions are associated with malicious rules. This provides an automated method for flagging suspicious transport rules for further review.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Mail Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT new_transport_rule | FEATURE_ENGINEER (bag_of_words_from_conditions, action_type) | PREDICT probability_malicious with naive_bayes_model | FILTER probability_malicious > threshold
  - question: Has an inbox rule been created that searches for high-risk business terms (e.g., 'invoice', 'password') and then deletes the email or moves it to a low-visibility folder?
    context: This is a classic adversary technique used in Business Email Compromise (BEC) attacks. The adversary creates a rule to hide their malicious communication from the legitimate user by automatically deleting emails with certain keywords or moving them to an infrequently checked folder like 'RSS Feeds'. This question directly searches for this pattern.
    answer_sources:
      - Windows Event ID 4104
      - User Endpoints
      - Mail Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH event_id=4104 AND script_block CONTAINS 'New-InboxRule' AND rule_keywords IN ('invoice', 'payment', 'password reset') AND (rule_action IS 'DeleteMessage' OR rule_destination IN ('RSS Feeds', 'Junk E-mail'))
  - question: Has an inbox rule been created that moves emails to a folder with a name that appears to be random or obfuscated?
    context: To avoid detection, an adversary might create a rule that moves emails to a folder with a randomly generated name (e.g., 'asdfqwer'). Such names have high Shannon entropy compared to human-created names ('Invoice Archive'). This question identifies suspicious rules by calculating the entropy of the destination folder name and flagging unusually high values.
    answer_sources:
      - Windows Event ID 4104
      - User Endpoints
      - Mail Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH event_id=4104 AND script_block CONTAINS '-MoveToFolder' | EXTRACT folder_name | CALCULATE shannon_entropy(folder_name) | FILTER entropy_score > 95th_percentile
  - question: Is there a statistically significant spike in the daily number of inbox rules that delete messages across the enterprise?
    context: A widespread attack campaign might involve creating message-deleting rules on many user accounts in a short period. This question uses a time-series anomaly detection model (like ARIMA) to monitor the daily volume of such rule creations. A sudden spike that deviates from the forecasted trend could indicate a large-scale, coordinated attack.
    answer_sources:
      - Windows Event ID 4104
      - User Endpoints
      - Mail Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: AGGREGATE daily_count of rules with 'DeleteMessage' action | APPLY arima_model to time_series | DETECT anomalies where actual_count exceeds forecasted_confidence_interval
  - question: Did a host connect to a newly-seen domain and transfer a large amount of data shortly after an email hiding rule was created on it?
    context: Creating an email rule can be a preparatory step for data exfiltration or C2 communication. This question correlates rule creation events with subsequent network activity. A connection to a brand new domain followed by a significant data transfer is a strong indicator that the rule is part of a larger malicious operation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4104
      - Network Egress Points
      - User Endpoints
      - DNS Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CORRELATE event_id=4104 with zeek_logs in next 60 mins | FILTER dns_query for domain_not_seen_in_30_days AND subsequent_data_transfer > 10MB to that domain
  - question: Following a rule creation, did the host initiate a high-volume data transfer to a country it doesn't normally communicate with?
    context: This question seeks to identify anomalous network behavior by looking at the destination country of network traffic. If, after a rule is created, a user's host sends an unusually large amount of data to a country it has not connected to recently, it could be a sign of data exfiltration. This method adds a geopolitical context to network anomaly detection.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4104
      - Network Egress Points
      - User Endpoints
      - DNS Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR host, CREATE baseline of outbound_volume_per_country | AFTER rule_creation on host, CHECK for connection to new_country | FILTER data_volume > (mean_daily_volume + 3 * stdev)
  - question: Can an LSTM autoencoder model detect an anomalous sequence of user activities following the creation of an email rule?
    context: Malicious activity often follows a specific sequence of events (e.g., rule creation -> new process -> network connection). This question uses a sequence-based LSTM autoencoder, a type of recurrent neural network, to learn normal sequences of user activity. When the model is fed a sequence containing a malicious pattern, it will fail to reconstruct it accurately, resulting in a high reconstruction error that flags the sequence as anomalous.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4104
      - Network Egress Points
      - User Endpoints
      - DNS Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT sequence of user_events (process, file, network) after rule_creation | APPLY lstm_autoencoder_model | FILTER reconstruction_error > threshold
  - question: Is a process other than a standard mail client (e.g., outlook.exe) writing to Outlook rule files (.pst, .ost, .rwz)?
    context: Outlook rules are typically stored in specific files. While `outlook.exe` and some maintenance utilities legitimately modify these files, any other process doing so is highly suspicious. It could indicate malware directly manipulating rule files to bypass standard APIs and logging mechanisms. This question monitors for such unauthorized file writes.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - User Endpoints
      - File Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH event_id=4663 AND object_name ends with ('.pst', '.ost', '.rwz') AND access_type is 'Write' | JOIN with event_id=4688 on process_id | FILTER process_name NOT IN ('outlook.exe', 'scanpst.exe')
  - question: Was a write to an Outlook file initiated by a process with a rare or unusual parent process?
    context: Examining the parent process provides context for an action. A legitimate write to an Outlook file by `outlook.exe` will likely have `explorer.exe` or no parent. If the parent process is something unusual, like `cmd.exe` or a script host, it suggests an anomalous execution chain. This question flags file writes where the parent process is statistically rare.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - User Endpoints
      - File Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR Outlook file writes, ESTABLISH baseline of parent_process rarity | FOR new write_event, LOOKUP parent_process_rarity | FILTER rarity_score indicates parent seen < 1% of time
  - question: Can a one-class SVM model identify anomalous modification events on Outlook files based on the process, user, and time?
    context: This question uses a one-class SVM, an unsupervised learning algorithm, to create a model of "normal" modification events for Outlook files. The model learns the typical boundaries of activity based on features like the writing process, user account, and time of day. Any new event that falls outside this learned boundary is classified as an anomaly, potentially indicating malicious tampering.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - User Endpoints
      - File Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN one-class_svm on legitimate outlook_file_mod_events (features: process, parent_process, user, time) | PREDICT anomaly for new events | FILTER prediction is anomaly