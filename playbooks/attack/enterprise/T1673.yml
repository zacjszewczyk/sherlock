name: T1673: Virtual Machine Discovery
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary is attempting to discover virtual machines. This can be observed through several indicators, such as network connections from malicious IPs to hypervisor management ports, the execution of known VM discovery commands (e.g., `esxcli`, `Get-VM`), network sweeps against hypervisor subnets, unauthorized use of legitimate management tools, or a sequence of failed logins followed by a successful login and subsequent discovery commands.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any known malicious IP addresses connected to our hypervisor management interfaces?
    context: This question seeks to identify if IPs from threat intelligence feeds are communicating with critical hypervisor management ports (like 443, 902, 5988, 5989). Such activity is a strong indicator of targeted reconnaissance or an attempted compromise of the virtual infrastructure.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - Core network switches
      - Virtual infrastructure management servers (e.g., vCenter, SCVMM)
      - Internet gateways
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          JOIN (conn_logs WHERE dest_port IN [443, 902, 5988, 5989] AND dest_ip IS hypervisor) WITH (malicious_ip_watchlist) ON source_ip
  - question: Are there any rare or first-time connections to our hypervisor management interfaces?
    context: This question aims to detect unusual connections by baselining normal traffic patterns. A source IP connecting to a hypervisor management interface for the first time, or with a frequency that is a statistical anomaly compared to the last 30 days, could represent an attacker's initial access or internal reconnaissance.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - Core network switches
      - Virtual infrastructure management servers (e.g., vCenter, SCVMM)
      - Internet gateways
    range: last 30 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each new connection to hypervisor_management_port:
            CALCULATE frequency of (source_ip, dest_ip) pair over last 30 days
            IF frequency < 5th_percentile_of_all_pairs:
              ALERT
  - question: Has a machine learning model identified any anomalous network connections to hypervisor management interfaces?
    context: This question leverages a one-class SVM model trained on the characteristics of normal network traffic to hypervisors. It helps to identify sophisticated or subtle anomalies that simple thresholding might miss, such as unusual protocols, byte counts, or time-of-day activity, flagging them for investigation.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - Core network switches
      - Virtual infrastructure management servers (e.g., vCenter, SCVMM)
      - Internet gateways
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each new connection to hypervisor_management_port:
            EXTRACT features (subnet, time, bytes, protocol)
            SCORE connection with pre-trained One-Class SVM model
            IF score is anomalous:
              ALERT
  - question: Have any known virtual machine discovery commands been executed on our hosts?
    context: This question looks for direct evidence of an adversary running commands to enumerate virtual machines. Detecting the execution of tools like `esxcli`, `Get-VM`, `virsh`, or even `systeminfo` piped to find "virtual" provides a high-fidelity signal that an actor is mapping the virtual environment.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Hypervisor hosts (ESXi, Hyper-V)
      - Virtualization management servers
      - Domain Controllers
      - Administrator workstations
      - Jump boxes
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          SEARCH process_creation_logs (WinEvent 4688, Sysmon 1)
          WHERE command_line MATCHES regex_list_of_vm_discovery_tools
  - question: Has any user executed an unusually rare or complex command associated with system enumeration?
    context: This question aims to find abnormal command-line activity by baselining what is normal for each user. An adversary attempting to discover VMs might use legitimate tools in unusual ways. This can be detected as a command that the user has rarely or never run before, or one with unusually complex or obfuscated arguments, which can be measured by entropy.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Hypervisor hosts (ESXi, Hyper-V)
      - Virtualization management servers
      - Domain Controllers
      - Administrator workstations
      - Jump boxes
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each new process_creation_event:
            CALCULATE historical probability of command for that user
            CALCULATE entropy of command_line_arguments
            IF probability < 1st_percentile OR entropy is anomalous:
              ALERT
  - question: Has a machine learning model flagged any executed command lines as likely being malicious VM discovery attempts?
    context: This question utilizes a sophisticated classification model that has been trained to distinguish between benign and malicious command lines. By analyzing features derived from Natural Language Processing (NLP), the model can identify novel or obfuscated discovery commands that might evade simple signature-based detection.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Hypervisor hosts (ESXi, Hyper-V)
      - Virtualization management servers
      - Domain Controllers
      - Administrator workstations
      - Jump boxes
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each new process_creation_event:
            EXTRACT NLP features from command_line
            SCORE command with pre-trained classification model
            IF score > malicious_threshold:
              ALERT
  - question: Has any single host initiated connections to an abnormally high number of distinct hosts in the hypervisor network segment in a short time?
    context: This question is designed to detect network scanning or sweeping activity. An adversary attempting to discover live hosts within a hypervisor VLAN will often connect to many different IPs in rapid succession. A simple threshold rule (e.g., >20 unique IPs in 60 seconds) can be an effective way to catch this behavior.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - DMZ
      - Core network switches
      - VLANs containing virtual infrastructure
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          COUNT distinct dest_ip from conn_logs
          WHERE dest_ip in hypervisor_vlan
          GROUP BY source_ip, 60_second_window
          HAVING count > 20
  - question: Has any host's connection activity to the hypervisor network segment statistically deviated from its normal baseline?
    context: This question provides a more robust, adaptive method for detecting network sweeps compared to a fixed threshold. By creating a historical baseline of activity for each source IP over 30 days, it can identify when a host suddenly starts contacting significantly more destination IPs or ports than it normally does, flagging it as an anomaly that exceeds the 99th percentile of its typical behavior.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - DMZ
      - Core network switches
      - VLANs containing virtual infrastructure
    range: last 30 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each source_ip in 5_minute_window:
            CALCULATE count_distinct_dest_ip and count_distinct_dest_port
            COMPARE counts to 30-day baseline for that source_ip
            IF counts > 99th_percentile:
              ALERT
  - question: Has a time-series model detected an anomalous rate of new connections from any host to the hypervisor subnets?
    context: This question employs an advanced time-series model (like ARIMA or LSTM) to understand the normal rhythm (e.g., daily, weekly cycles) of connection rates to hypervisor subnets. This allows for the detection of scanning activity that might not be a simple burst, but rather a deviation from the expected pattern at a specific time of day or day of the week.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - DMZ
      - Core network switches
      - VLANs containing virtual infrastructure
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each host, monitor connection_rate_to_hypervisor_subnet
          INPUT rate into pre-trained time-series model (ARIMA/LSTM)
          IF observed_rate significantly deviates from predicted_rate:
            ALERT
  - question: Have any hypervisor management tools been executed by an unauthorized user or from an unapproved host?
    context: This question enforces a strict access control policy by checking every execution of a sensitive hypervisor management tool against an allow-list of authorized users and workstations. Any execution that does not match the list is a clear policy violation and a strong indicator of malicious activity or privilege misuse.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Zeek http.log
      - ESXi /var/log/hostd.log
      - ESXi /var/log/vobd.log
      - Virtualization management servers (vCenter, SCVMM)
      - Administrator workstations
      - Jump boxes/bastion hosts
      - Hypervisor hosts
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          SEARCH process_creation_logs for hypervisor_cli_tools
          FOR each event:
            IF user NOT IN authorized_user_list OR hostname NOT IN authorized_host_list:
              ALERT
  - question: Has an authorized administrator executed an unusually high number of hypervisor management commands?
    context: This question helps detect compromised administrative accounts or insider threats. Even authorized users have predictable patterns of behavior. By baselining the frequency of their management command usage, we can detect when an account is suddenly being used to issue commands at a rate that is statistically abnormal (e.g., more than 3 standard deviations above their average), suggesting automation or malicious intent.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Zeek http.log
      - ESXi /var/log/hostd.log
      - ESXi /var/log/vobd.log
      - Virtualization management servers (vCenter, SCVMM)
      - Administrator workstations
      - Jump boxes/bastion hosts
      - Hypervisor hosts
    range: last 30 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each authorized_admin:
            CALCULATE command_frequency_in_last_hour
            COMPARE to user's 30-day moving_average and standard_deviation
            IF frequency > (average + 3 * std_dev):
              ALERT
  - question: Is any administrator's hypervisor management activity a statistical outlier compared to their peers?
    context: This question uses peer group analysis to find anomalies. It automatically groups administrators with similar roles and access patterns. If one user's activity suddenly deviates from the established norm of their peer group, it flags them as an outlier. This is effective for detecting when an account is used for tasks outside its typical role, a sign of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Zeek http.log
      - ESXi /var/log/hostd.log
      - ESXi /var/log/vobd.log
      - Virtualization management servers (vCenter, SCVMM)
      - Administrator workstations
      - Jump boxes/bastion hosts
      - Hypervisor hosts
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          DEFINE peer groups of admins via k-means clustering on historical activity
          FOR each admin's new activity:
            COMPARE activity to the behavioral profile of their peer group
            IF activity is a statistical outlier:
              ALERT
  - question: Has a successful login to a hypervisor, preceded by multiple failures, been immediately followed by VM discovery commands?
    context: This question seeks to identify a classic brute-force or password-spraying attack pattern. The sequence of many failed logins (Event ID 4625), followed by a single success (Event ID 4624), and then immediate execution of discovery commands (Event ID 4688) is a very strong signal of a compromised account being used for reconnaissance.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Hypervisor management servers
      - Domain Controllers
      - RADIUS/TACACS+ servers
      - Identity and access management systems
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          TRIGGER on successful_login (Event 4624) to hypervisor
          IF source_ip had >10 failed_logins (Event 4625) prior to success
            AND IF logged-in user executes discovery_command (Event 4688) within 10 mins:
              ALERT
  - question: Has a high-risk login session on a hypervisor been followed by VM discovery activity?
    context: This question uses a risk-scoring model to evaluate logins. Instead of a simple rule, it combines multiple weak signals (unusual location, odd time of day, previous failed logins) into a single risk score. A login session that is deemed high-risk (e.g., in the 98th percentile) and is then followed by discovery commands provides a context-rich, high-confidence alert for an analyst.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Hypervisor management servers
      - Domain Controllers
      - RADIUS/TACACS+ servers
      - Identity and access management systems
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          FOR each login to hypervisor:
            CALCULATE risk_score based on (geo_rarity, time_anomaly, failed_login_ratio)
            IF risk_score > 98th_percentile:
              FLAG session as high-risk
          IF high-risk session is followed by discovery_command:
            ESCALATE ALERT
  - question: Has a sequence of login and command events matched a probabilistic model of an attack chain?
    context: This question applies a Hidden Markov Model (HMM) to detect a sequence of events that fits a known attack pattern. The model is trained to recognize the likely progression from failed logins, to a successful login, to discovery commands. It calculates the probability that an observed sequence of events in the logs matches this malicious path, allowing it to detect the entire attack chain as a single, high-probability event.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Hypervisor management servers
      - Domain Controllers
      - RADIUS/TACACS+ servers
      - Identity and access management systems
    range: last 90 days
    queries:
      - query_tech: pseudocode
        query: |
          FEED real-time event stream (4625, 4624, 4688) into HMM
          MODEL states: (Failed Logins) -> (Successful Login) -> (Discovery Command)
          IF probability of observed sequence matching model > threshold:
            ALERT