name: "T1586: Compromise Accounts"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps determine if an adversary is compromising external or internal accounts for operational support or targeting. It provides investigative steps for identifying various account compromise techniques, including the use of breached credentials, password spraying, credential stuffing, and brute-force attacks. The playbook also covers detecting successful compromises through anomalous login patterns like impossible travel, analyzing suspicious inbound emails from potentially compromised partner accounts, and identifying social media impersonation or account takeovers."
type: "technique"
related:
    - "TA0042: Resource Development"
contributors:
    - "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
    - question: "Are there any login attempts using usernames from known credential breaches or originating from IPs on credential abuse threat feeds?"
      context: "This question aims to proactively detect the use of compromised credentials. Adversaries often acquire lists of usernames and passwords from previous data breaches and use them to attempt to access systems. By correlating login events in real-time with threat intelligence feeds and lists of known breached accounts, we can identify these initial access attempts before a successful compromise occurs or quickly respond if one does."
      answer_sources:
          - "Windows Event ID 4624"
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "Threat Intelligence Feeds"
          - "Public-facing authentication services (e.g., VPN, OWA, M365)"
          - "internal authentication servers (e.g., Domain Controllers)"
          - "network egress points"
          - "threat intelligence platforms"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "JOIN login_events ON username WITH breached_credential_list. OR JOIN login_events ON source_ip WITH credential_abuse_threat_feed. ALERT if match found."
    - question: "Is there an anomalous rate of login attempts originating from IPs known to be associated with malicious activity?"
      context: "Even if an IP is on a watchlist (e.g., a TOR exit node), not all traffic from it is malicious. This question focuses on identifying a change in behavior. By baselining the 'normal' login attempt rate from these suspicious IP categories, we can detect when an attacker starts actively using one for a targeted attack against our infrastructure, indicated by a statistically significant spike in activity."
      answer_sources:
          - "Windows Event ID 4624"
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "Threat Intelligence Feeds"
          - "Public-facing authentication services (e.g., VPN, OWA, M365)"
          - "internal authentication servers (e.g., Domain Controllers)"
          - "network egress points"
          - "threat intelligence platforms"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR each IP on threat_feed: CALCULATE hourly_login_rate (success + fail). BASELINE normal_rate over 30 days. ALERT if current_rate > 95th_percentile_of_baseline."
    - question: "Can we use machine learning to assign a risk score to login events based on multiple weak indicators of compromise?"
      context: "This question moves beyond simple rules to a more holistic, risk-based approach. A single indicator, like a login from a new location, might be benign. However, when combined with other features—such as the username being in a breach list, the IP being on a threat feed, and an unusual user agent—the probability of malicious activity increases significantly. A machine learning model can learn these complex patterns and flag high-risk logins that would be missed by individual rules."
      answer_sources:
          - "Windows Event ID 4624"
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "Threat Intelligence Feeds"
          - "Public-facing authentication services (e.g., VPN, OWA, M365)"
          - "internal authentication servers (e.g., Domain Controllers)"
          - "network egress points"
          - "threat intelligence platforms"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR each login_event: FEATURE_ENGINEER (is_breached, is_threat_ip, etc.). INPUT features to classification_model. ALERT if risk_score > threshold."
    - question: "Is any single external IP address attempting to log in to many different user accounts in a short period, potentially using a known attack tool?"
      context: "This question targets the classic password spraying or credential stuffing pattern: one source IP, many target accounts, and a high failure rate. This is distinct from a brute-force attack which targets one account. By setting thresholds (e.g., >20 failures, >10 accounts, 5 minutes) and correlating with web log data for known malicious user agents, we can create a high-fidelity alert for this specific attack technique."
      answer_sources:
          - "Windows Event ID 4625"
          - "Zeek http.log"
          - "Zeek conn.log"
          - "Public web application servers"
          - "API gateways"
          - "VPN concentrators"
          - "network perimeter firewalls"
          - "cloud identity provider log streams"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "GROUP failed_logins by source_ip in 5_min_window. ALERT if count(failed_logins) > 20 AND count(distinct_users) > 10. INCREASE_SCORE if user_agent in attack_tool_list."
    - question: "Are we observing any source IPs exhibiting a high 'spray ratio', where failed login attempts are spread across many unique accounts?"
      context: "This question provides a more statistical method to detect password spraying. A legitimate user who forgot their password will generate many failed logins for a single account (low spray ratio). An attacker trying one password against many accounts will have a spray ratio close to 1.0 (one failure per unique account). By calculating this ratio and comparing it to a baseline, we can identify spraying behavior even if it stays below simple volume-based thresholds."
      answer_sources:
          - "Windows Event ID 4625"
          - "Zeek http.log"
          - "Zeek conn.log"
          - "Public web application servers"
          - "API gateways"
          - "VPN concentrators"
          - "network perimeter firewalls"
          - "cloud identity provider log streams"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR each source_ip in 5_min_window: CALCULATE ratio = count(distinct_failed_users) / count(total_failed_logins). ALERT if ratio > 99th_percentile_of_all_IPs AND count(distinct_failed_users) > 5."
    - question: "Can we use unsupervised machine learning to automatically discover clusters of activity that look like a coordinated password spraying attack?"
      context: "This question explores an advanced detection method that doesn't rely on pre-defined rules or thresholds. Density-based clustering can automatically group related login failures in a multi-dimensional space (source IP, username, time). A password spray will naturally form a dense cluster: many points (failures) close together in time, originating from one IP but spread across the username dimension. This can uncover attacks that are too slow or distributed to be caught by simple rules."
      answer_sources:
          - "Windows Event ID 4625"
          - "Zeek http.log"
          - "Zeek conn.log"
          - "Public web application servers"
          - "API gateways"
          - "VPN concentrators"
          - "network perimeter firewalls"
          - "cloud identity provider log streams"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "INPUT failed_logins (source_ip, username_hash, timestamp) to DBSCAN model. ALERT on clusters identified by the model as dense and containing a high ratio of unique users to a single source IP."
    - question: "Is any single user account being targeted by a high volume of failed login attempts from a geographically and network-diverse set of sources?"
      context: "This question aims to detect a distributed brute-force attack. To evade IP-based blocking, attackers use botnets or proxies spread across many different networks (ASNs). A simple rule looking for many failures from one IP would miss this. By counting failures against a single account and enriching the source IPs to find the number of unique ASNs, we can effectively identify these distributed attacks."
      answer_sources:
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "Authentication servers (Domain Controllers, RADIUS)"
          - "public-facing application servers"
          - "cloud identity provider logs (e.g., Azure AD Sign-in logs)"
          - "network perimeter flow logs"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "GROUP failed_logins by target_user in 5_min_window. ALERT if count(failures) > 20 AND count(distinct_source_ASNs) > 5."
    - question: "Is there a statistically significant increase in the number or diversity of sources for failed logins against any single user account?"
      context: "This question uses statistical baselining to detect brute-force attacks. The first part identifies a simple volume-based anomaly (more failures than usual). The second part, using Shannon entropy, specifically detects a shift from a simple to a distributed attack. Entropy measures randomness; a low entropy of source IPs means failures come from one or two IPs, while a high entropy means they come from many different IPs. A sudden spike in entropy for a user's failed logins is a strong signal of a distributed attack."
      answer_sources:
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "Authentication servers (Domain Controllers, RADIUS)"
          - "public-facing application servers"
          - "cloud identity provider logs (e.g., Azure AD Sign-in logs)"
          - "network perimeter flow logs"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR each user: BASELINE hourly_failed_logins (mean, stddev). ALERT if current_hour_fails > mean + 3*stddev. ALSO, CALCULATE entropy of source_ips for fails in 5_min_window. ALERT on entropy spike."
    - question: "Can a time-series model predict the normal pattern of failed logins for high-value accounts and alert on deviations indicative of a brute-force attack?"
      context: "This question applies advanced time-series analysis for high-fidelity detection, especially for critical accounts (e.g., admins, executives). Models like ARIMA or LSTM can learn complex temporal patterns, including seasonality (e.g., fewer failures at night) and trends. They can then detect anomalies that simple statistical baselines might miss, such as a low-and-slow brute-force attack that doesn't trigger a simple volume threshold but represents a clear deviation from the learned pattern."
      answer_sources:
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "Authentication servers (Domain Controllers, RADIUS)"
          - "public-facing application servers"
          - "cloud identity provider logs (e.g., Azure AD Sign-in logs)"
          - "network perimeter flow logs"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR each high_value_user: TRAIN time-series_model on historical failed_login_counts_per_minute. FEED live stream of counts to model. ALERT if model flags current sequence as anomalous."
    - question: "Has a successful login occurred from an IP address that was just seen conducting a brute-force attempt against the same account?"
      context: "This is a classic and highly effective correlation. A string of failed logins followed by a success from the same source is a textbook indicator of a successful password guess. This question aims to directly identify the culmination of a brute-force or password guessing attack, providing a high-confidence alert that a compromise has likely just occurred."
      answer_sources:
          - "Windows Event ID 4624"
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "GeoIP Enrichment Database"
          - "Domain Controller and member server security logs"
          - "VPN access logs"
          - "internet gateway flow logs (Zeek conn.log)"
          - "geolocation data enrichment services"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "ON successful_login(user, ip): QUERY for failed_logins(user, ip) in last 15 minutes. ALERT if count(failed_logins) > 10."
    - question: "Has a user successfully logged in from a location that is physically impossible to reach in the time since their last login, or from a network they have never used before?"
      context: "This question seeks to identify account compromise through geographic and network anomalies. 'Impossible travel' is a strong indicator that two different entities are using the same credentials from different parts of the world. Similarly, a login from a country or Autonomous System (network) never before used by that user, while not impossible, is highly suspicious and warrants investigation. This helps catch compromises even without prior failed login attempts."
      answer_sources:
          - "Windows Event ID 4624"
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "GeoIP Enrichment Database"
          - "Domain Controller and member server security logs"
          - "VPN access logs"
          - "internet gateway flow logs (Zeek conn.log)"
          - "geolocation data enrichment services"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "ON successful_login(user, ip, time): GET last_login(user, last_ip, last_time). CALCULATE speed = distance(ip, last_ip) / (time - last_time). ALERT if speed > 1000 km/h. ALSO, CHECK if country(ip) or ASN(ip) is new for user in last 90 days. ALERT if new."
    - question: "Can a machine learning model provide a consolidated risk score for each successful login based on multiple behavioral and contextual features?"
      context: "This question proposes a sophisticated approach to detecting compromised account usage. Instead of relying on a single rule like 'impossible travel', a model can weigh multiple factors simultaneously (time since last login, distance, new country, new device, preceding failures, etc.). This allows it to flag logins that are subtly anomalous across several dimensions, providing a more nuanced and potentially more accurate detection capability than individual hard-coded rules."
      answer_sources:
          - "Windows Event ID 4624"
          - "Windows Event ID 4625"
          - "Zeek conn.log"
          - "GeoIP Enrichment Database"
          - "Domain Controller and member server security logs"
          - "VPN access logs"
          - "internet gateway flow logs (Zeek conn.log)"
          - "geolocation data enrichment services"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "ON successful_login: FEATURE_ENGINEER (time_diff, distance, new_country, prior_fails, etc.). INPUT features to classification_model. ALERT if predicted_probability > 0.9."
    - question: "Are we receiving emails that appear to be from trusted partners but fail email authentication checks or contain known malicious links?"
      context: "This question targets the abuse of a compromised partner account for phishing or malware delivery. A failure in DMARC, SPF, or DKIM means the email likely did not originate from the partner's legitimate mail servers, a strong sign of spoofing or compromise. The presence of a known malicious URL is an even more direct indicator of malicious intent. This helps detect threats that leverage the trust established with partners."
      answer_sources:
          - "Email Gateway Logs"
          - "Zeek dns.log"
          - "Zeek http.log"
          - "WHOIS lookup data"
          - "Mail Transfer Agents (MTAs)"
          - "email security gateways"
          - "network DNS resolvers"
          - "web proxies"
          - "external domain intelligence services"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR inbound_email from partner_domain: ALERT if DMARC_result == 'fail'. ALSO, FOR url in email_body: ALERT if domain(url) in malicious_domain_feed."
    - question: "Are emails from important senders (partners, executives) directing users to newly created websites?"
      context: "This question leverages the fact that attackers often use newly registered domains (NRDs) for phishing and malware campaigns, as they have not yet been blacklisted. A legitimate email from a partner is highly unlikely to contain links to a website created just days ago. By checking the age of all domains in an email, especially from high-value senders, we can detect suspicious links that might otherwise appear benign."
      answer_sources:
          - "Email Gateway Logs"
          - "Zeek dns.log"
          - "Zeek http.log"
          - "WHOIS lookup data"
          - "Mail Transfer Agents (MTAs)"
          - "email security gateways"
          - "network DNS resolvers"
          - "web proxies"
          - "external domain intelligence services"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR inbound_email from partner_or_exec: EXTRACT urls. FOR each url: GET domain_registration_date. ALERT if age(domain) < 30 days."
    - question: "Does the writing style or topic of an inbound email from a known partner deviate significantly from their historical communication patterns?"
      context: "This question uses Natural Language Processing (NLP) to detect a 'human' anomaly. Every person has a unique writing style (stylometry)—their vocabulary, sentence length, use of punctuation, etc. An attacker who has compromised an account is unlikely to perfectly mimic the legitimate owner's style. By creating a baseline of a partner's normal style and topics, we can flag emails that 'don't sound like them', which can be a subtle but powerful indicator of account takeover."
      answer_sources:
          - "Email Gateway Logs"
          - "Zeek dns.log"
          - "Zeek http.log"
          - "WHOIS lookup data"
          - "Mail Transfer Agents (MTAs)"
          - "email security gateways"
          - "network DNS resolvers"
          - "web proxies"
          - "external domain intelligence services"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR inbound_email from key_partner: EXTRACT text. CALCULATE stylometric_and_topic_features. COMPARE features to sender's historical_baseline using cosine_similarity. ALERT if similarity_score < threshold."
    - question: "Are new, potentially imposter social media accounts being created for our executives or brands and used to spread suspicious links?"
      context: "This question focuses on detecting brand impersonation and typosquatting on social media. Adversaries create fake profiles to defraud customers, spread disinformation, or launch phishing attacks. By proactively monitoring for the creation of these accounts and checking the links they post for suspicious characteristics (newly registered, on a threat feed), we can quickly identify and report these impersonation attempts."
      answer_sources:
          - "OSINT Monitoring Platform Data"
          - "Social Media Site APIs"
          - "Zeek dns.log"
          - "Zeek http.log"
          - "Public social media platforms (e.g., LinkedIn, X/Twitter)"
          - "OSINT data aggregation services"
          - "brand protection services"
          - "internal web proxy logs"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "MONITOR social_media for new_profiles matching executive_names. ON new_profile_creation: CHECK links in posts. ALERT if link_domain_age < 60 days OR link_domain_on_threat_feed."
    - question: "Have any of our monitored, legitimate social media accounts started exhibiting anomalous behavior in terms of posting frequency, content, or engagement patterns?"
      context: "This question aims to detect the takeover of a legitimate company or executive social media account. An attacker, once in control, is likely to behave differently than the original owner. This could manifest as posting at unusual times, a sudden change in topic (monitored via keywords or hashtags), or an abnormal spike in activity. By baselining normal behavior across multiple metrics, we can detect these deviations that signal a potential compromise."
      answer_sources:
          - "OSINT Monitoring Platform Data"
          - "Social Media Site APIs"
          - "Zeek dns.log"
          - "Zeek http.log"
          - "Public social media platforms (e.g., LinkedIn, X/Twitter)"
          - "OSINT data aggregation services"
          - "brand protection services"
          - "internal web proxy logs"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR monitored_account: BASELINE posting_frequency, content_keywords, etc. over 90 days. ALERT if current_activity > 3 * stddev from baseline. CALCULATE Jaccard_similarity of hashtags in new_post vs historical_posts. ALERT on sudden drop."
    - question: "Does the writing style of new posts on our official social media accounts match the established style of the legitimate author or brand voice?"
      context: "Similar to the email analysis, this question uses stylometry and author attribution to detect account takeover. A corporate brand or an executive has a distinct 'voice' or style. A machine learning model can be trained to recognize this style. If a new post is published that the model identifies as being written by someone else, it serves as a strong, albeit subtle, indicator that the account may be controlled by an unauthorized party."
      answer_sources:
          - "OSINT Monitoring Platform Data"
          - "Social Media Site APIs"
          - "Zeek dns.log"
          - "Zeek http.log"
          - "Public social media platforms (e.g., LinkedIn, X/Twitter)"
          - "OSINT data aggregation services"
          - "brand protection services"
          - "internal web proxy logs"
      range: "last 90 days"
      queries:
          - technology: "pseudocode"
            query: "FOR monitored_account: TRAIN author_attribution_model on historical posts. FOR each new_post: CLASSIFY author using model. ALERT if classification is 'unknown' or not the expected author."