name: 'T1558.004: AS-REP Roasting'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: |
  This playbook helps determine if an adversary is attempting to gain access to credentials using the AS-REP Roasting technique. This attack targets user accounts that do not require Kerberos pre-authentication. An adversary can request an Authentication Service (AS) reply, or TGT, for these accounts and then attempt to crack the encrypted portion of the ticket offline to recover the user's password. This playbook identifies this activity by detecting Kerberos requests without pre-authentication originating from known malicious IPs or rare network locations, observing the execution of known AS-REP Roasting tools (e.g., Rubeus, PowerView), identifying requests for non-approved accounts configured without pre-auth, detecting a single source IP enumerating many accounts, and flagging a suspicious increase in the use of weak RC4 encryption ciphers.
type: 'technique'
related:
  - 'TA0006: Credential Access'
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: '1.0'
tags: 'none'
questions:
  - question: 'Has a Kerberos AS-REQ without pre-authentication originated from a known malicious IP address?'
    context: |
      This question aims to identify classic AS-REP Roasting attempts from threat actor infrastructure or previously compromised systems. By joining authentication logs with threat intelligence, we can detect high-confidence malicious activity. An AS-REQ without pre-authentication ('Pre-Authentication Type' is '0' or preauth_required='F') allows an attacker to receive an encrypted TGT for a user, which can then be cracked offline to recover the user's password. When this request comes from a known bad IP, it strongly indicates a targeted attack.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'Zeek conn.log'
      - 'Threat Intelligence Feed'
      - 'NAI: Active Directory Domain Controllers, Network Egress/Ingress Points with Zeek Sensors'
    range: 'last 90 days'
    queries:
      - 'JOIN (Windows Event ID 4768 WHERE ''Pre-Authentication Type'' == ''0'' OR Zeek kerberos.log WHERE success == ''T'' AND preauth_required == ''F'') WITH Threat_Intelligence_Feed ON source_ip. TRIGGER ALERT IF match.'
  - question: 'Is an AS-REQ without pre-authentication originating from a historically rare Autonomous System Number (ASN)?'
    context: |
      This question seeks to uncover AS-REP Roasting attempts from unusual network locations. Legitimate Kerberos traffic typically originates from a predictable set of corporate and partner networks. An attacker might use a temporary VPS or a compromised host in an obscure network space. By analyzing the ASN of the source IP and flagging attempts from ASNs that rarely interact with the Kerberos infrastructure, we can identify statistically anomalous and potentially malicious authentication attempts.
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek kerberos.log'
      - 'NAI: Active Directory Domain Controllers, Network Egress/Ingress Points with Zeek Sensors'
    range: 'last 90 days'
    queries:
      - 'FOR each AS-REQ without pre-auth, get source IP''s ASN from Zeek conn.log. CALCULATE historical frequency of all ASNs over 90 days. FLAG if source ASN is in the bottom 1st percentile of traffic.'
  - question: 'Does a machine learning model classify an AS-REQ without pre-authentication as malicious based on its features?'
    context: |
      This question leverages a machine learning model to provide a probabilistic assessment of an AS-REQ event. By training a classifier on features like source IP reputation, ASN rarity, time of day, and whether the target account is privileged, the model can learn the subtle patterns that differentiate between benign and malicious activity. This approach is effective at detecting novel or evasive attack variations that might not be caught by static rules or simple statistical thresholds.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'Source IP Reputation Data'
      - 'Internal User Privilege Data'
      - 'NAI: Active Directory Domain Controllers, Network Egress/Ingress Points with Zeek Sensors'
    range: 'last 90 days'
    queries:
      - 'INPUT features (source IP reputation, ASN rarity, time of day, target user privilege) of AS-REQ event into trained logistic regression model. SCORE the event. ALERT if probability > 0.85.'
  - question: 'Has a process been executed with command-line arguments indicative of known AS-REP Roasting tools like Rubeus or PowerView?'
    context: |
      This question looks for direct evidence of an attacker running specific tools to perform AS-REP Roasting. By monitoring process creation events (Event ID 4688) and PowerShell script block logs (Event ID 4104) for tell-tale command lines (e.g., 'Rubeus.exe asreproast', 'Get-ADUser -Filter {DoesNotRequirePreAuth -eq $true}'), we can detect the attack with very high fidelity. A match provides a strong signal that an adversary is actively attempting to harvest credentials on a compromised host.
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4104'
      - 'NAI: Active Directory Domain Controllers, Member Servers, User Workstations'
    range: 'last 90 days'
    queries:
      - 'SEARCH process creation logs (4688) and PowerShell logs (4104) for command lines containing ''Rubeus.exe asreproast'' OR ''Get-ADUser -Filter {DoesNotRequirePreAuth -eq $true}''. TRIGGER ALERT on match.'
  - question: 'Has a PowerShell process been observed with an unusual parent process and a high-entropy command line?'
    context: |
      This question aims to detect obfuscated or in-memory PowerShell-based AS-REP Roasting attacks. Attackers often execute malicious scripts from unexpected parent processes (like a web server or a generic service host) to evade detection. Furthermore, their command-line arguments may be encoded or compressed, leading to high character entropy. Flagging PowerShell instances with anomalous parent-child relationships and high-entropy commands can uncover these stealthy execution methods.
    answer_sources:
      - 'Windows Event ID 4688'
      - 'NAI: Active Directory Domain Controllers, Member Servers, User Workstations'
    range: 'last 90 days'
    queries:
      - 'PROFILE normal parent-child process relationships. CALCULATE command-line entropy for PowerShell.exe. FLAG if PowerShell.exe has an unusual parent AND its command entropy is in the >98th percentile.'
  - question: 'Has an anomaly detection model flagged a process creation event as a potential AS-REP Roasting tool execution?'
    context: |
      This question uses an autoencoder or similar anomaly detection model to identify unusual process execution behavior that may correspond to AS-REP Roasting. By training on a baseline of normal process creation events and their command lines, the model can learn what 'normal' looks like. When a new, potentially malicious tool is executed, it will deviate from this baseline, resulting in a high reconstruction error from the model, thereby flagging it as an anomaly for investigation.
    answer_sources:
      - 'Windows Event ID 4688'
      - 'NAI: Active Directory Domain Controllers, Member Servers, User Workstations'
    range: 'last 90 days'
    queries:
      - 'INPUT process creation event (4688) features into a trained autoencoder model. CALCULATE reconstruction error. FLAG if error is anomalously high.'
  - question: 'Has an AS-REP message been requested for a user account that has pre-authentication disabled but is not on the approved allow-list for this configuration?'
    context: |
      This question provides a high-confidence method for detecting AS-REP Roasting by enforcing policy. Certain legacy service accounts may require pre-authentication to be disabled. These should be documented on an explicit allow-list. Any authentication request for an account with this setting that is *not* on the list is an unauthorized and highly suspicious event, almost certainly indicating an attack or a severe misconfiguration that an attacker could exploit.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'Internal Allow-List for Accounts'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'FILTER Windows Event ID 4768 for ''Pre-Authentication Type'' == ''0''. CROSS-REFERENCE ''Account Name'' with an allow-list. ALERT if the account is not on the list.'
  - question: 'Is a specific client host requesting a statistically unusual ratio of tickets for accounts with pre-authentication disabled?'
    context: |
      This question aims to identify a host that is performing reconnaissance or a targeted AS-REP Roasting attack. A normal client has a very low (often zero) ratio of requests for pre-auth disabled accounts compared to its total authentication requests. A compromised host being used for an attack will exhibit a much higher ratio. By baselining this ratio across all hosts and alerting when a host deviates significantly (e.g., 3 standard deviations above the mean), we can spot suspicious enumeration or attack activity.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'FOR each client host, calculate ratio of (AS-REQs with pre-auth disabled) / (total AS-REQs) in a 1-hour window. ESTABLISH baseline mean and standard deviation. ALERT if a host''s ratio is > (mean + 3 * std_dev).'
  - question: 'Has the observed hourly volume of AS-REPs for pre-auth disabled accounts significantly exceeded the forecasted volume?'
    context: |
      This question uses time-series forecasting to detect a widespread, large-scale AS-REP Roasting attack. The model learns the normal rhythm and volume of these requests over time, accounting for daily and weekly patterns. A sudden, sharp increase in volume that significantly surpasses the model's predicted upper confidence bound suggests an abnormal event, such as an adversary attempting to roast a large number of accounts simultaneously.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'USE a time-series model (e.g., ARIMA) to forecast the expected hourly volume of AS-REPs for pre-auth disabled accounts. ALERT if the observed count significantly exceeds the model''s upper confidence interval.'
  - question: 'Has a single source IP address requested tickets for more than 10 distinct users without pre-authentication within a 5-minute window?'
    context: |
      This question uses a simple threshold-based rule to detect brute-force or enumeration-style AS-REP Roasting. A legitimate user or system will almost never request tickets for many different accounts in a very short period. This behavior is a classic indicator of an automated script attempting to find and exploit all accounts with pre-authentication disabled. The thresholds (10 users, 5 minutes) can be tuned to balance sensitivity and false positives.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'TRIGGER if a single ''Client Address'' in Event ID 4768 is associated with > 10 distinct ''Account Name''s where ''Pre-Authentication Type'' is ''0'' within a 5-minute window.'
  - question: 'Has a single source IP exceeded the 99th percentile for both the number of AS-REQs and the number of distinct accounts targeted within a 10-minute window?'
    context: |
      This question refines the simple threshold logic by using statistical baselines. Instead of a fixed number, it identifies what is truly anomalous for the specific environment. By calculating the 99th percentile for both the raw request count and the distinct user count from a source IP over a 30-day baseline, we create a dynamic threshold. An attacker must stay below both thresholds to remain undetected, making this a more robust detection than a single static rule.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'CALCULATE 99th percentile for request_count and distinct_account_count per source IP over 30 days. In a 10-min sliding window, ALERT if a source IP exceeds both percentile thresholds.'
  - question: 'Has a clustering algorithm identified a small group of AS-REQ events as outliers, indicating a targeted AS-REP Roasting attack?'
    context: |
      This question uses unsupervised machine learning to find 'lone wolf' attacks. A clustering algorithm like DBSCAN will group dense, similar (i.e., normal) activity together. A targeted attack, which might involve a single source IP requesting tickets for a few specific high-value accounts, won't fit into the large clusters of normal behavior. The algorithm will classify these events as noise or outliers, making them stand out for an analyst to investigate.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'APPLY DBSCAN clustering to AS-REQ events over a 15-minute window using features like source IP and distinct target count. IDENTIFY events classified as noise/outliers as potential attacks.'
  - question: 'Has a Kerberos authentication event been observed that uses weak RC4-HMAC encryption and also has pre-authentication disabled?'
    context: |
      This question targets a classic signature of an AS-REP Roasting attack. Attackers prefer to request tickets encrypted with RC4-HMAC ('Ticket Encryption Type' of '0x17') because the keys are derived directly from the user's NTLM password hash, making them much faster to crack offline. The combination of disabling pre-authentication (to get the ticket without providing a password) and requesting weak RC4 encryption is a textbook attack pattern and a very high-confidence indicator of malicious intent.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'CREATE high-severity alert for any event where ''Ticket Encryption Type'' is ''0x17'' (RC4-HMAC) AND ''Pre-Authentication Type'' is ''0''.'
  - question: 'Has there been a statistical deviation from baseline, such as a user suddenly requesting an RC4 ticket or a spike in the environment''s overall RC4-to-AES ratio?'
    context: |
      This question looks for anomalous changes in encryption type usage. In a modern, secure environment, RC4 should be rare. We can detect suspicious activity in two ways: first, by profiling individual users and alerting if a user who always uses strong AES ciphers suddenly requests a weak RC4 ticket; second, by monitoring the environment-wide ratio of RC4-to-AES requests and alerting if this ratio spikes above its historical norm. Both methods can indicate an attacker forcing a downgrade to a weaker cipher.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'PROFILE normal ''Ticket Encryption Types'' per user; ALERT on deviation to RC4 (0x17). Also, MONITOR hourly RC4:AES ratio for the environment; ALERT if ratio exceeds 95th percentile of historical values.'
  - question: 'Does a decision tree model classify an AS-REQ as malicious, particularly when it involves RC4 encryption and no pre-authentication?'
    context: |
      This question uses a supervised machine learning model, like a decision tree, to formalize the detection logic. The model can be trained to recognize that the combination of features like 'Pre-Authentication Type' = '0' and 'Ticket Encryption Type' = '0x17' is highly indicative of a malicious event, especially when combined with other factors like poor source IP reputation. This provides an automated and scalable way to classify events and prioritize alerts for an analyst.
    answer_sources:
      - 'Windows Event ID 4768'
      - 'Zeek kerberos.log'
      - 'Source IP Reputation Data'
      - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
    range: 'last 90 days'
    queries:
      - 'INPUT features (''Pre-Authentication Type'', ''Ticket Encryption Type'', IP reputation, etc.) into a trained decision tree. ALERT if the event is classified as malicious.'