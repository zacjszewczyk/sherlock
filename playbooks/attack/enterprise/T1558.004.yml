name: T1558.004: AS-REP Roasting
id: d8a1b5d1-e9c4-4b8f-9a7c-6e0d3f2a1b9c
description: This playbook aims to detect AS-REP Roasting attacks, a credential access technique where an attacker requests a Kerberos Ticket Granting Ticket (TGT) for a user account that does not require pre-authentication. The received TGT contains a portion encrypted with the user's NTLM hash, which can be cracked offline. This playbook identifies this activity by monitoring for Kerberos authentication events (AS-REQs) without pre-authentication, especially from suspicious IP addresses, for non-approved accounts, in high volumes from a single source, or using weak RC4 encryption. It also looks for the execution of common AS-REP Roasting tools like Rubeus or specific PowerShell commands.
type: technique
related:
- TA0006: Credential Access
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a Kerberos authentication request (AS-REQ) without pre-authentication originated from a known malicious IP address?
  context: This question seeks to identify a high-confidence indicator of an AS-REP Roasting attack. When an AS-REQ for a user account that does not require pre-authentication comes from an IP address listed on a threat intelligence feed or an internal list of compromised systems, it strongly suggests an external or already-breached attacker is attempting to harvest credentials. Correlating authentication logs with threat intelligence provides a direct and actionable detection.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - Zeek conn.log
  - 'NAI: Active Directory Domain Controllers, Network Egress/Ingress Points with Zeek Sensors'
  - Threat Intelligence Feed
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH (Windows Event ID 4768 WHERE Pre-Auth_Type=0) OR (Zeek kerberos.log WHERE success=T AND preauth_required=F) | JOIN Client_IP with Threat_Intelligence_IP_List | RETURN matching events
- question: Is an AS-REQ without pre-authentication originating from an IP address belonging to a statistically rare Autonomous System Number (ASN)?
  context: This question aims to uncover AS-REP Roasting attempts from unusual network locations that might not yet be on a threat intelligence list. Legitimate Kerberos traffic typically originates from a predictable set of ASNs. An authentication attempt from an ASN that rarely, if ever, communicates with the network is anomalous and suspicious, warranting investigation as a potential reconnaissance or attack attempt.
  answer_sources:
  - Zeek conn.log
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Egress/Ingress Points with Zeek Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Zeek kerberos.log WHERE preauth_required=F | GET source_IP | LOOKUP ASN for source_IP from conn.log | CALCULATE historical frequency of ASN for all Kerberos traffic | ALERT if ASN frequency < 1st percentile
- question: Does a machine learning model classify a new AS-REQ event as malicious based on features like source IP reputation, ASN rarity, and time of day?
  context: This question leverages a machine learning model to score the likelihood of an AS-REQ event being malicious in real-time. By training a classifier on various features from historical data, the model can identify subtle patterns and combinations of factors that are indicative of an AS-REP Roasting attack, even if no single feature is suspicious on its own. This provides a probabilistic and automated approach to detection.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Egress/Ingress Points with Zeek Sensors'
  - IP Reputation Data
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new AS-REQ event | EXTRACT features (source_IP_rep, ASN_rarity, time_of_day, target_user_privilege) | INPUT features into trained logistic regression model | ALERT if model_score > 0.85
- question: Has a process been created or a PowerShell script executed that matches the signature of a known AS-REP Roasting tool?
  context: This question looks for direct evidence of an attacker using specific tools on an endpoint to perform AS-REP Roasting. By monitoring process creation and PowerShell script block logs for known tool names (e.g., `Rubeus.exe`) or command-line patterns (e.g., `Get-ADUser -Filter {DoesNotRequirePreAuth...}`), defenders can detect the attack technique at the point of execution. This is a high-fidelity indicator of compromise.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - 'NAI: Active Directory Domain Controllers, Member Servers, User Workstations'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH (Event ID 4688) OR (Event ID 4104) WHERE CommandLine CONTAINS ("Rubeus.exe asreproast" OR "Get-ADUser -Filter {DoesNotRequirePreAuth -eq $true}")
- question: Has a PowerShell process been spawned from an unusual parent process or with an abnormally complex command-line argument?
  context: This question aims to detect obfuscated or novel tool usage that might not match a specific signature. Attackers often use living-off-the-land binaries like PowerShell, launched from unexpected parent processes (e.g., a web server process like w3wp.exe) to evade detection. High command-line entropy can indicate complex, obfuscated, or one-liner scripts often used in attacks. Flagging these statistical outliers can uncover malicious PowerShell activity related to AS-REP Roasting.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - 'NAI: Active Directory Domain Controllers, Member Servers, User Workstations'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Event ID 4688 WHERE ProcessName="powershell.exe" | PROFILE parent-child relationships and CALCULATE command-line entropy | ALERT if parent is unusual OR entropy > 98th percentile
- question: Has an anomaly detection model identified a process creation event as anomalous based on its command-line arguments?
  context: This question uses an unsupervised machine learning model, like an autoencoder, to establish a baseline of normal process creation activity. When a new process event occurs that the model cannot accurately reconstruct (resulting in a high reconstruction error), it is flagged as an anomaly. This can detect novel or highly obfuscated AS-REP Roasting tools and techniques that would be missed by signature-based or simple statistical methods.
  answer_sources:
  - Windows Event ID 4688
  - 'NAI: Active Directory Domain Controllers, Member Servers, User Workstations'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new Event ID 4688 | INPUT event into trained autoencoder model | CALCULATE reconstruction_error | ALERT if reconstruction_error is high
- question: Has a Kerberos ticket been requested for a user account that requires no pre-authentication and is not on the approved allow-list for this configuration?
  context: This question provides a very high-confidence method for detecting AS-REP Roasting by enforcing policy. Organizations should maintain a strict list of accounts (typically service accounts) that are permitted to have Kerberos pre-authentication disabled. Any AS-REQ for an account with this setting that is not on the allow-list is an immediate and severe security violation, indicating either a misconfiguration or an active attack.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  - Internal Allow-List
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Windows Event ID 4768 WHERE Pre-Auth_Type=0 | CHECK if Account_Name is NOT IN Allow-List | ALERT on any match
- question: Is a specific source host generating a statistically unusual ratio of requests for pre-auth disabled accounts compared to its total authentication requests?
  context: This question aims to identify hosts that are performing enumeration or targeted AS-REP Roasting. A normal client's authentication traffic will have a low, stable ratio of requests for pre-auth disabled accounts. A compromised host or an attacker's machine actively searching for vulnerable accounts will likely exhibit a sudden spike in this ratio. Monitoring for hosts that deviate significantly from the established baseline can pinpoint malicious activity.
  answer_sources:
  - Windows Event ID 4768
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: AGGREGATE Event ID 4768 by Client_Address over 1-hour window | CALCULATE ratio = (count where Pre-Auth_Type=0) / (total count) | ESTABLISH baseline mean and stddev for this ratio across all hosts | ALERT if a host's ratio > (mean + 3 * stddev)
- question: Has the observed hourly volume of AS-REP requests for pre-auth disabled accounts significantly exceeded the volume predicted by a time-series forecasting model?
  context: This question seeks to detect large-scale or environment-wide AS-REP Roasting attempts. By modeling the normal ebb and flow of these specific authentication requests over time, a forecasting model can predict the expected volume for any given hour. A sudden, sharp increase in observed volume that falls outside the model's prediction indicates an anomalous event, potentially a widespread attack, that warrants immediate investigation.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: COUNT AS-REPs for pre-auth disabled accounts per hour | USE ARIMA model to predict expected count for current hour | ALERT if observed_count > predicted_upper_confidence_interval
- question: Has a single client IP address requested tickets for more than 10 distinct user accounts without pre-authentication within a 5-minute window?
  context: This question uses a simple threshold-based rule to detect brute-force AS-REP Roasting enumeration. Legitimate activity from a single host is unlikely to involve requesting tickets for many different users in such a short period. This behavior is a classic indicator of an attacker using a tool to iterate through a list of usernames to find accounts vulnerable to AS-REP Roasting.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Event ID 4768 WHERE Pre-Auth_Type=0 | AGGREGATE by Client_Address over 5-minute window | COUNT distinct Account_Name | ALERT if distinct_count > 10
- question: Has a single source IP exceeded the 99th percentile for both the total number of AS-REQs and the number of distinct user accounts targeted within a 10-minute window?
  context: This question improves upon the simple threshold by using a dynamic, statistically derived baseline. Instead of a fixed number, it identifies what is truly anomalous for the specific environment. By requiring a host to be an outlier in both the volume of requests and the breadth of targets, this method reduces false positives from potentially noisy but legitimate services, focusing on behavior that is exceptionally rare and highly indicative of an attack.
  answer_sources:
  - Windows Event ID 4768
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: AGGREGATE Event ID 4768 by Client_Address over 10-minute window | COUNT total_requests and distinct_users | CALCULATE 99th percentile for both metrics from 30-day baseline | ALERT if total_requests > 99th_percentile_requests AND distinct_users > 99th_percentile_users
- question: Has a clustering algorithm identified a small group of AS-REQ events as outliers based on source IP, target user count, and pre-auth disabled count?
  context: This question applies unsupervised machine learning to find "lonely" or anomalous patterns of activity without pre-defined rules. A clustering algorithm like DBSCAN will naturally group together normal, high-volume user and system authentications. A targeted AS-REP Roasting attack, often originating from a single source against multiple targets in a short burst, will not fit into these large clusters and will be flagged as noise or an outlier, effectively pinpointing the suspicious activity.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: GATHER AS-REQ events over 15-min window | CREATE feature vectors (source_IP, distinct_target_count, pre-auth_disabled_count) | APPLY DBSCAN clustering algorithm | ALERT on any events classified as noise/outliers
- question: Has a Kerberos authentication event been observed that combines the use of the weak RC4-HMAC cipher with a lack of pre-authentication?
  context: This question targets a classic signature of older or less sophisticated AS-REP Roasting tools. The combination of disabling pre-authentication (the core of the vulnerability) and requesting a ticket encrypted with the weak, fast-to-crack RC4 cipher is a red flag. Modern, secure environments should primarily use AES ciphers. The presence of this specific combination is a high-confidence indicator of a malicious attempt to acquire an easily crackable credential hash.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH (Event ID 4768) OR (Zeek kerberos.log) WHERE Pre-Auth_Type=0 AND Ticket_Encryption_Type="0x17" | ALERT on any match
- question: Has a user account that normally uses strong AES encryption suddenly requested a ticket using weak RC4, or has the overall environment-wide ratio of RC4 to AES requests abnormally increased?
  context: This question looks for behavioral deviations related to encryption types. An individual user's behavior should be consistent; a sudden downgrade in encryption strength for a single account is highly suspicious. On a broader scale, a sudden increase in the overall ratio of RC4 requests across the entire network can indicate a widespread attack campaign where adversaries are forcing the use of weaker ciphers to facilitate offline credential cracking.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: PROFILE historical encryption types per user; ALERT if user requests RC4 after only using AES. ALSO, CALCULATE hourly ratio of RC4/AES requests environment-wide; ALERT if ratio > 95th percentile of historical ratios.
- question: Does a decision tree classifier flag an AS-REQ as malicious, particularly when the request involves RC4 encryption and no pre-authentication?
  context: This question employs a supervised machine learning model, such as a decision tree, that has been explicitly trained to recognize the characteristics of a malicious AS-REQ. Features like the lack of pre-authentication and the use of RC4 encryption would be strong predictors in such a model. This provides an automated way to weigh multiple factors and make a classification, alerting when the combination of evidence points strongly towards an AS-REP Roasting attack.
  answer_sources:
  - Windows Event ID 4768
  - Zeek kerberos.log
  - 'NAI: Active Directory Domain Controllers, Network Security Monitoring Sensors'
  - IP Reputation Data
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new AS-REQ | EXTRACT features (Pre-Auth_Type, Ticket_Encryption_Type, time_of_day, source_IP_rep) | INPUT features into trained decision tree model | ALERT if model classifies as malicious