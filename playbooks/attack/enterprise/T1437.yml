name: "T1437: Application Layer Protocol"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: |
  This playbook helps determine if an adversary is using standard application protocols for command and control (C2) on mobile devices. It focuses on detecting C2 communications by analyzing network traffic for three key patterns: 1) C2 beaconing behavior, characterized by highly periodic connections, small and uniform payload sizes, and low URI diversity. 2) DNS-based C2 channels, identified by high query volumes, high-entropy subdomains indicative of DGAs, unusual query type ratios (e.g., TXT/CNAME vs. A/AAAA), and large DNS response payloads. 3) Malicious or rare client signatures in HTTP/S traffic, including User-Agent strings and JA3/S/JA4+ hashes that are either known to be malicious or are statistically uncommon across the mobile device fleet.
type: "technique"
related:
  - "TA0037: Command and Control"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a mobile device communicating with a known command and control (C2) IP, domain, or URI?"
    context: |
      This question aims to identify straightforward C2 communication by matching network traffic destinations (IPs, domains, URIs) from mobile devices against a curated threat intelligence feed. A match is a strong indicator of compromise, as it suggests the device is connecting to infrastructure already identified as malicious.
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Network egress points"
      - "Corporate Wi-Fi infrastructure"
      - "VPN concentrators"
      - "Mobile Device Management (MDM) platforms"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each connection in (conn.log, http.log) FROM mobile_device_IP_range
          CHECK destination_IP, destination_domain, URI against threat_intelligence_feed
          IF match, GENERATE alert
  - question: "Is a mobile device exhibiting non-human, automated communication patterns indicative of C2 beaconing?"
    context: |
      This question seeks to detect C2 activity by analyzing the statistical properties of network connections. C2 beacons are often automated and highly regular, unlike typical human-driven traffic. By calculating the coefficient of variation for connection timing and the standard deviation of data payloads over a 1-hour window, we can identify machine-like patterns (low variation) that point to potential malware.
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Network egress points"
      - "Corporate Wi-Fi infrastructure"
      - "VPN concentrators"
      - "Mobile Device Management (MDM) platforms"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each mobile_source_IP
          GROUP connections by destination over 1-hour window
          CALCULATE time_variation_coefficient and payload_size_stdev
          IF time_variation_coefficient < 0.2 AND payload_size_stdev < 100 bytes, GENERATE alert
  - question: "Can we identify anomalous clusters of mobile device traffic that represent C2 beaconing?"
    context: |
      This question applies unsupervised machine learning (DBSCAN) to group network traffic into clusters. Normal user activity forms large, diffuse clusters, while C2 beaconing, with its consistent features (port, protocol, timing, payload), will form small, dense clusters. Identifying these outlier clusters allows for the discovery of novel or unknown C2 channels not present in threat intelligence feeds.
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Network egress points"
      - "Corporate Wi-Fi infrastructure"
      - "VPN concentrators"
      - "Mobile Device Management (MDM) platforms"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          EXTRACT features (dest_port, protocol, time_variance, payload_stats, URI_diversity) from mobile traffic logs
          APPLY DBSCAN clustering algorithm
          INVESTIGATE small, dense clusters identified as outliers
  - question: "Is a mobile device performing DNS queries to domains associated with known Domain Generation Algorithms (DGAs) or DNS tunneling C2 frameworks?"
    context: |
      This question focuses on detecting C2 communication that leverages the DNS protocol. By matching DNS queries in real-time against a threat intelligence feed of known malicious domains (used for DGAs or tunneling), we can quickly identify compromised mobile devices attempting to contact their C2 servers.
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers"
      - "DNS forwarders"
      - "Network egress points"
      - "Corporate Wi-Fi infrastructure"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          IN real-time, SCAN 'query' field in dns.log FROM mobile_device_IPs
          MATCH against threat_intel_feed of DGA/tunneling domains
          IF match, GENERATE high_severity_alert
  - question: "Does DNS traffic from a mobile device show statistical anomalies, such as high subdomain entropy or an unusual ratio of TXT to A queries?"
    context: |
      This question aims to uncover C2 over DNS by looking for statistical red flags. DGAs often produce random-looking, high-entropy subdomains. DNS tunneling can use TXT records to exfiltrate data, leading to a high ratio of TXT to A queries. By baselining normal DNS behavior and alerting on significant deviations, we can detect these covert channels.
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers"
      - "DNS forwarders"
      - "Network egress points"
      - "Corporate Wi-Fi infrastructure"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each mobile_source_IP over 1-hour window
          CALCULATE shannon_entropy of subdomains and TXT_to_A_query_ratio
          ESTABLISH baseline
          IF entropy > 4.5 OR query_ratio > 3_sigma_from_baseline, GENERATE alert
  - question: "Can a machine learning model classify DNS queries from mobile devices as benign or malicious?"
    context: |
      This question proposes using a supervised machine learning model (Random Forest) to proactively identify malicious DNS queries. By training a model on features like query length, entropy, and character ratios from known good and bad DNS traffic, we can automate the detection of DGA and DNS tunneling, even for previously unseen domains.
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers"
      - "DNS forwarders"
      - "Network egress points"
      - "Corporate Wi-Fi infrastructure"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          ENGINEER features (length, entropy, char_ratio, type) from dns.log
          DEPLOY trained Random Forest model
          CLASSIFY live DNS queries from mobile devices
          FLAG 'malicious' classifications for review
  - question: "Is a mobile device making an HTTP/S connection using a client signature (User-Agent, JA3/S, JA4+) known to be malicious?"
    context: |
      This question targets known malware by matching client-side TLS/HTTP fingerprints. Malware often uses hardcoded or specific client signatures (User-Agent, JA3/S, or JA4+ hash). Comparing these signatures from mobile device connections against a threat intelligence feed provides a high-fidelity method for detecting specific malware families.
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Zeek ja4.log"
      - "Web Application Firewalls (WAFs)"
      - "Reverse proxies"
      - "Internet gateways"
      - "MDM/UEM platforms for device context"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SCAN http.log (user_agent), ssl.log (ja3, ja3s), ja4.log (ja4_hash) from mobile_IPs
          MATCH against threat_intel_feed of malicious signatures
          IF match, GENERATE immediate_alert
  - question: "Is a mobile device using a statistically rare client signature (User-Agent, JA3, JA4+)?"
    context: |
      This question aims to find unknown or custom malware by identifying outlier client signatures. Most legitimate mobile applications are widely used, creating a common baseline of signatures. A client signature that is extremely rare (e.g., seen in less than 0.1% of the device fleet over a 30-day window) is anomalous and could indicate a custom C2 implant or an unusual tool requiring investigation.
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Zeek ja4.log"
      - "Web Application Firewalls (WAFs)"
      - "Reverse proxies"
      - "Internet gateways"
      - "MDM/UEM platforms for device context"
    range: "Last 30 days"
    queries:
      - technology: "pseudocode"
        query: |
          OVER a 30-day window, COMPUTE frequency distribution of all User-Agent, JA3, and JA4+ hashes from mobile devices
          CALCULATE prevalence
          IF connection uses signature with prevalence < 0.1%, GENERATE alert
  - question: "Can an anomaly detection model identify mobile client traffic that deviates significantly from the norm?"
    context: |
      This question uses unsupervised machine learning (Isolation Forest) to detect anomalous client signatures without prior knowledge of what is 'bad'. The model learns the characteristics of normal, benign mobile client traffic. Any new connection that deviates significantly from this learned baseline, based on features like User-Agent length and JA3/JA4+ components, is flagged as an anomaly for further analysis.
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Zeek ja4.log"
      - "Web Application Firewalls (WAFs)"
      - "Reverse proxies"
      - "Internet gateways"
      - "MDM/UEM platforms for device context"
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          TRAIN Isolation Forest model on features from benign mobile client signatures (UA length, JA3/JA4+ components)
          SCORE new connections in real-time
          FLAG connections with high anomaly scores