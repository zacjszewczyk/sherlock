name: T1135: Network Share Discovery
id: 5e9d9b6c-6a0e-4f7d-8d9b-2c3f4a5b6c7d
description: Helps determine if an adversary is enumerating network shares to identify data for collection or hosts for lateral movement. This is achieved by detecting known discovery tool hashes, identifying unusual parent processes executing discovery commands (e.g., net view, Get-SmbShare), flagging high-volume SMB scanning activity, identifying users accessing shares inconsistent with their baseline, and alerting on non-administrative access to administrative shares (C$, ADMIN$).
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are processes or scripts executing that have file hashes matching known network discovery tools?
    context: This question aims to identify the use of known malicious or dual-use network discovery tools like PowerView or BloodHound. By comparing file and script block hashes against a list of known IOCs, analysts can quickly detect the presence of specific threats without relying on behavioral analysis. A match provides a high-confidence indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each new process (Event 4688) or script block (Event 4104)
          CALCULATE hash (SHA256)
          IF hash IN known_discovery_tool_hashes
            ALERT (high-severity)
  - question: Have any rare or previously unseen executables or scripts, not on an allowlist, been executed?
    context: This question seeks to uncover unknown or modified discovery tools by focusing on rarity. Adversaries often use custom or slightly altered tools to evade signature-based detection. By baselining all hashes in the environment and flagging those with low prevalence (e.g., seen on only a few hosts), analysts can surface suspicious binaries that warrant further investigation, even without a prior IOC match.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each unique hash observed
          CALCULATE prevalence = (hosts_with_hash / total_hosts)
          IF prevalence < threshold (e.g., 0.1%) AND hash NOT IN allowlist
            FLAG for investigation
  - question: Can machine learning models classify any newly observed, low-prevalence files as potential network discovery tools?
    context: This question leverages machine learning to proactively identify novel threats. Instead of relying on exact hash matches or simple rarity, a classifier can analyze static file properties (like entropy, API imports, and strings) to determine if an unknown file's characteristics are similar to those of known discovery tools. This helps detect completely new malware families or heavily obfuscated versions of existing tools.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each new, low-prevalence executable
          EXTRACT static features (entropy, imports, strings)
          INPUT features into pre-trained classifier
          IF classifier_prediction == 'discovery tool'
            ALERT for analysis
  - question: Have network share discovery commands (e.g., 'net view', 'Get-SmbShare') been executed by an unusual parent process like an Office application or web server?
    context: This question focuses on identifying suspicious execution context. Legitimate administrative activity typically involves running discovery commands from a standard command shell. When these same commands are spawned by a process like Microsoft Word or an IIS web server (w3wp.exe), it is a strong indicator of compromise, suggesting an adversary has gained code execution through an exploit or a malicious document.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
      - Web Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each process creation event
          IF process_name MATCHES 'net.exe' OR 'powershell.exe'
          AND command_line MATCHES 'view', 'share', 'Get-SmbShare'
          AND parent_process NOT IN ['cmd.exe', 'powershell.exe', 'explorer.exe']
            ALERT (high-severity)
  - question: Have any network share discovery commands been executed by a parent process that is statistically rare for that child process?
    context: This question uses statistical analysis to find anomalous parent-child process relationships without a predefined 'bad' list. By baselining all process executions across the network, the system can learn that 'cmd.exe' commonly spawns 'net.exe'. An execution where 'outlook.exe' spawns 'net.exe' would have a very low probability and be flagged as an anomaly, even if this specific pattern was not pre-programmed as a rule.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
      - Web Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN baseline of P(child | parent) probabilities
          FOR each new execution of 'net view', 'Get-SmbShare', etc.
          CALCULATE probability for its parent-child pair
          IF P(child | parent) < threshold (e.g., 1%)
            FLAG as anomalous
  - question: Has a user executed a sequence of commands that is statistically unlikely but characteristic of reconnaissance, such as 'whoami' followed by 'ipconfig' and then 'net view'?
    context: This question aims to detect adversary behavior by analyzing the *sequence* of commands, not just individual events. A user running 'net view' might be normal. However, a sequence-aware model (like an LSTM) can learn that a rapid succession of system enumeration, network configuration, and then network discovery commands is highly abnormal for a typical user session and more indicative of an attacker's hands-on-keyboard reconnaissance.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
      - Web Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each user session
          INPUT command sequence into trained LSTM model
          IF model flags sequence as anomalous
            ALERT on suspicious command chain
  - question: Has any single host connected to an excessive number of other hosts over SMB (port 445) in a short period, suggesting scanning activity?
    context: This question seeks to detect network-level scanning for open shares. Adversaries often perform a broad sweep of a subnet to find accessible systems. A simple, stateful rule can detect this behavior by counting the number of unique destinations a single source connects to on port 445 within a short time frame. Exceeding a fixed threshold (e.g., 20 hosts in 5 minutes) is a strong indicator of an SMB scan.
    answer_sources:
      - Zeek conn.log
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Firewall Logs
      - Network TAPs and SPAN ports on core switches
      - Network Egress/Ingress points
      - File Servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each source_ip
          COUNT unique destination_ips on port 445 in a 5-minute window
          IF count > 20
            ALERT on potential SMB scan
  - question: Has any host accessed a number of unique shares or hosts via SMB that is statistically significant compared to its peers?
    context: This question refines the detection of scanning by using a dynamic, peer-based threshold instead of a fixed one. Some servers (like patch management servers) might legitimately connect to many hosts. By calculating a percentile (e.g., 98th) of activity across all hosts, the system can identify true outliers. A workstation that suddenly starts behaving like a management server would be flagged, while the actual management server's behavior would be considered normal.
    answer_sources:
      - Zeek conn.log
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Firewall Logs
      - Network TAPs and SPAN ports on core switches
      - Network Egress/Ingress points
      - File Servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE 98th percentile of unique SMB destinations per host over 10 minutes
          FOR each source host
          COUNT unique destinations accessed in last 10 minutes
          IF count > 98th_percentile_threshold
            ALERT on statistical outlier
  - question: Can machine learning models, such as time-series or clustering algorithms, identify hosts exhibiting anomalous SMB connection patterns indicative of scanning?
    context: This question applies more advanced ML techniques to find scanning. A time-series model can learn the normal rhythm ('heartbeat') of SMB activity for each host and flag sudden spikes. Alternatively, a clustering algorithm like DBSCAN can group hosts based on their connection behavior (e.g., number of connections, unique destinations). Hosts that don't fit into any normal cluster are labeled as outliers, effectively identifying scanners without pre-defined rules.
    answer_sources:
      - Zeek conn.log
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Firewall Logs
      - Network TAPs and SPAN ports on core switches
      - Network Egress/Ingress points
      - File Servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          // Time-series approach
          FOR each host
          MODEL SMB connection rate with ARIMA/Prophet
          ALERT on deviations from forecast
          // Clustering approach
          CLUSTER all hosts using DBSCAN on features (unique_dest_count, total_connections)
          ALERT on hosts classified as noise/outliers
  - question: Has any user accessed a network share they have never accessed before?
    context: This question aims to detect the initial stages of data discovery or lateral movement by flagging first-time access events. While not always malicious, a user suddenly accessing a share outside their normal duties (e.g., an engineer accessing an HR share) is suspicious. By maintaining a baseline of known good (user, share) access pairs, any deviation can be flagged for correlation with other suspicious events.
    answer_sources:
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Windows Event ID 4624
      - File Servers
      - Domain Controllers (for authentication correlation)
      - Application Servers with sensitive shares
      - HR and Finance department servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN state table of (user, share) pairs seen in last 60 days
          FOR each new share access
          IF (user, share) pair is NOT IN state table
            ALERT (low-severity) on first-time access
            ADD pair to state table
  - question: Has the diversity of network shares accessed by any user increased dramatically, suggesting broad discovery activity?
    context: This question uses information theory to quantify unusual access patterns. A user typically accesses a small, consistent set of shares (low entropy). An adversary performing reconnaissance will likely browse many different and unrelated shares, causing a sharp spike in the mathematical entropy of their access patterns. This method can detect broad, unfocused browsing that might be missed by simple first-time access rules.
    answer_sources:
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Windows Event ID 4624
      - File Servers
      - Domain Controllers (for authentication correlation)
      - Application Servers with sensitive shares
      - HR and Finance department servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each user
          CALCULATE historical baseline of share access entropy
          ON a daily basis, recalculate entropy for recent activity
          IF current_entropy is significantly higher than baseline
            ALERT on anomalous access diversity
  - question: Can a graph-based machine learning model identify user access to network shares that is inconsistent with the user's learned role or community cluster?
    context: This question applies graph machine learning to understand the relationships between users and the data they access. The model can learn 'communities' of users and resources (e.g., the 'Finance' user cluster accesses the 'Finance' share cluster). An access attempt by a 'Sales' user to a 'Source Code' share would be identified as a structural anomaly in the graph, indicating a high probability of malicious intent, as it violates the learned organizational roles.
    answer_sources:
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Windows Event ID 4624
      - File Servers
      - Domain Controllers (for authentication correlation)
      - Application Servers with sensitive shares
      - HR and Finance department servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL users and shares as a graph
          TRAIN GraphSAGE model on normal access patterns
          FOR each new access event (new edge)
          CALCULATE anomaly score for the new edge
          IF score > threshold
            ALERT on graph-based anomaly
  - question: Has a non-administrative user account attempted to access an administrative share (e.g., C$, ADMIN$, IPC$)?
    context: This question seeks to detect a common and high-fidelity indicator of lateral movement or privilege escalation. Administrative shares are intended for remote system management by privileged accounts only. Access attempts from standard user accounts are almost always unauthorized and malicious. This is a simple but highly effective rule to detect adversary activity.
    answer_sources:
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
      - Privileged Access Workstations (PAWs)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each SMB access event
          IF share_name MATCHES 'C$', 'ADMIN$', 'IPC$'
          AND source_user NOT IN privileged_user_group
            ALERT (high-severity)
  - question: Has an administrative share been accessed from a host that is not an approved management server or jump box?
    context: This question adds another layer to detecting admin share abuse by focusing on the source host. Even if a compromised administrative account is used, the activity may originate from an unusual location (e.g., a standard user workstation instead of a designated admin server). By baselining which hosts normally connect to admin shares, any connection from a non-baselined host can be flagged as suspicious, helping to detect the misuse of stolen credentials.
    answer_sources:
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
      - Privileged Access Workstations (PAWs)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN baseline of hosts that access admin shares
          FOR each admin share access event
          IF source_host NOT IN baseline_host_set
            ALERT on anomalous source for admin access
  - question: Can a machine learning classifier score the risk of an administrative share access event based on multiple contextual features?
    context: This question moves beyond simple rules to a more holistic, risk-based assessment using machine learning. A classifier can weigh multiple factors simultaneously—is the user an admin? Is the source a known management host? Is the access happening at 3 AM? Is this the first time this host has ever accessed this share? By combining these features, the model can produce a probabilistic risk score, allowing analysts to prioritize the most suspicious events over those that might be borderline or benign.
    answer_sources:
      - Zeek smb_mapping.log
      - Windows Event ID 5140
      - Endpoint Workstation Subnets
      - Server Subnets
      - Domain Controllers
      - Privileged Access Workstations (PAWs)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each admin share access event
          GATHER features (is_privileged, is_mgmt_host, time_of_day, etc.)
          INPUT features into trained classifier
          IF prediction_score > risk_threshold
            ALERT on high-risk admin share access