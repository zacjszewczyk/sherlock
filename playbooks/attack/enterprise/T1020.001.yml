name: T1020.001: Traffic Duplication
id: 3c5a61b2-8f9e-4b9e-9d2c-1a0e8f7d6c5b
description: This playbook helps to answer the question, "Is the adversary exfiltrating data using traffic duplication?". It provides investigative questions and queries to detect indicators of this technique. These indicators include outbound network flows to known malicious destinations identified via threat intelligence; the use of command-line tools on network management hosts to configure traffic mirroring (e.g., SPAN, ERSPAN); the presence of encapsulated traffic to unauthorized external IPs; abnormally large outbound data flows from a host or subnet that exceed historical baselines; high-volume outbound traffic associated with network anomalies (e.g., Zeek 'weird' logs) or DNS queries for algorithmically generated domains (DGA); and anomalous logins to network management hosts followed by high-volume outbound data transfers.
type: technique
related:
- TA0010: Exfiltration
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are any internal hosts communicating with external IP addresses or domains known to be malicious?
  context: This question seeks to identify direct communication with known command and control (C2) or exfiltration dropzone infrastructure. A match against a high-confidence threat intelligence feed is a strong indicator of compromise. By joining connection logs with DNS logs, we can correlate traffic to specific domains, even if the IP address changes, providing a more robust detection method.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Network egress points
  - DNS resolvers
  - Cloud virtual network gateways
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek conn.log AND Zeek dns.log
      JOIN on connection UID
      WHERE destination_ip OR resolved_domain IN threat_intelligence_feed
      RETURN source_ip, destination_ip, resolved_domain, bytes_sent
- question: Are there any connections to newly seen external IP addresses exhibiting a highly asymmetric data transfer ratio?
  context: A high ratio of data sent to data received (e.g., 100:1) suggests a one-way data dump, which is anomalous for most interactive protocols. Adversaries often use new infrastructure for data exfiltration, so focusing on newly observed destination IPs helps to filter out legitimate, established connections and highlights potentially suspicious new communication channels.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Network egress points
  - DNS resolvers
  - Cloud virtual network gateways
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek conn.log
      IDENTIFY destination_ips not seen in last 30 days
      FOR each connection to a new IP:
        CALCULATE ratio = bytes_sent / bytes_received
        CALCULATE percentile_bytes_sent for all new IP connections
        IF ratio > 100 AND bytes_sent > 95th_percentile:
          ALERT source_ip, destination_ip, bytes_sent, ratio
- question: Are internal hosts attempting to resolve domain names that appear to be algorithmically generated (DGA)?
  context: Domain Generation Algorithms (DGAs) are used by malware to create a large number of potential command and control domains, making it difficult to block them using static lists. Detecting and flagging domains with a high probability of being algorithmically generated can proactively identify C2 channels before they are added to threat intelligence feeds.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Network egress points
  - DNS resolvers
  - Cloud virtual network gateways
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek dns.log
      FOR each unique domain_query:
        APPLY DGA classification model
        IF DGA_score > 0.9:
          ALERT client_ip, domain_query, DGA_score
- question: Are any commands being executed on network management hosts that could configure traffic mirroring or duplication?
  context: Adversaries may gain access to network devices or management servers to configure traffic duplication at the infrastructure level. This question looks for the specific command-line arguments used to set up port mirroring (SPAN), ERSPAN, or other duplication technologies. Detecting these commands on critical network management hosts is a high-fidelity indicator of an attempt to intercept and exfiltrate data.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Network management servers
  - Core switches/routers
  - Virtual network control planes (Cloud)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Windows Event ID 4688
      WHERE host is tagged 'Network Management'
      AND command_line contains ('monitor session', 'port-mirroring', 'span', 'erspan', 'gre', 'vTap', 'create-traffic-mirror')
      ALERT host, user, command_line
- question: Is there any encapsulated traffic (e.g., GRE) being sent to an external destination that is not on the approved allowlist?
  context: Encapsulated traffic protocols like GRE can be used to tunnel network traffic to an external location for collection. Legitimate uses are typically limited to specific partners. By maintaining an allowlist of authorized destinations, any GRE traffic to an unknown external IP becomes highly suspicious, especially if it involves a large volume of data.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Network management servers
  - Core switches/routers
  - Virtual network control planes (Cloud)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek conn.log
      WHERE protocol is 'GRE' (IP protocol 47)
      AND destination_ip is external
      AND destination_ip NOT IN approved_gre_destinations_allowlist
      ALERT source_ip, destination_ip, bytes_sent, duration
- question: Are network administrators executing sequences of commands that are anomalous compared to their normal behavior?
  context: Adversaries who have compromised an administrator account may perform actions that deviate from the user's typical workflow. This question aims to detect such deviations by modeling normal command sequences. An anomalous sequence could indicate an attacker is exploring the system or configuring a subtle exfiltration mechanism, such as traffic duplication.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Network management servers
  - Core switches/routers
  - Virtual network control planes (Cloud)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Windows Event ID 4688
      GROUP commands by user and session
      APPLY anomaly detection model to command sequences
      IF anomaly_score > threshold:
        ALERT user, host, session_commands, anomaly_score
- question: Has any single outbound connection from a user workstation exceeded a high-volume data transfer threshold?
  context: This question acts as a simple tripwire to catch egregious, high-volume data transfers that are highly unlikely to be legitimate for a standard user workstation. Setting a hard limit (e.g., 1 GB) can quickly identify significant exfiltration events without the complexity of dynamic baselining.
  answer_sources:
  - Zeek conn.log
  - Network egress points
  - Server subnets
  - User workstation subnets
  - Database server segments
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek conn.log
      WHERE source_ip in user_workstation_subnets
      AND bytes_sent > 1GB
      ALERT source_ip, destination_ip, bytes_sent
- question: Has any host's daily outbound data volume significantly deviated from its historical baseline?
  context: This question seeks to identify hosts that are suddenly sending out much more data than they normally do. By calculating a rolling baseline for each host, this method can detect anomalous behavior that is specific to that host's role, catching significant increases in data transfer that might be missed by static thresholds. A deviation of 3 standard deviations is a strong statistical indicator of an anomaly.
  answer_sources:
  - Zeek conn.log
  - Network egress points
  - Server subnets
  - User workstation subnets
  - Database server segments
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each source_ip:
        CALCULATE 30-day_mean and standard_deviation of daily_bytes_sent
      SEARCH Zeek conn.log
      AGGREGATE daily_bytes_sent by source_ip
      IF daily_bytes_sent > (mean + 3 * std_dev):
        ALERT source_ip, daily_bytes_sent, mean, std_dev
- question: Is the aggregate outbound traffic from a critical network segment significantly higher than forecasted levels?
  context: Critical segments, like database server subnets, have relatively predictable traffic patterns. A significant deviation from a time-series forecast (e.g., ARIMA model) suggests an unexpected event impacting the entire segment, such as a large-scale data exfiltration effort targeting multiple servers simultaneously.
  answer_sources:
  - Zeek conn.log
  - Network egress points
  - Server subnets
  - User workstation subnets
  - Database server segments
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      MODEL aggregate outbound traffic for critical_subnet using ARIMA
      FORECAST expected traffic volume and 99% confidence interval
      SEARCH Zeek conn.log for actual traffic from critical_subnet
      IF actual_volume > forecasted_confidence_interval_upper_bound:
        ALERT critical_subnet, actual_volume, forecasted_volume
- question: Are there any high-volume outbound connections associated with anomalous network behavior?
  context: Zeek's 'weird.log' flags network activity that is unusual or violates protocol expectations. Correlating these 'weird' events (like 'inappropriate_FIN' or 'data_before_established') with high-volume data transfers can surface connections where an adversary might be using non-standard or malformed traffic to exfiltrate data, potentially to evade less sophisticated security controls.
  answer_sources:
  - Zeek conn.log
  - Zeek weird.log
  - Zeek dns.log
  - Network egress points
  - Application servers
  - DNS resolvers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek weird.log for weird_event
      JOIN with Zeek conn.log on connection UID
      WHERE conn.bytes_sent > 100MB
      ALERT conn.source_ip, conn.destination_ip, conn.bytes_sent, weird_event.name
- question: Are there any DNS queries for domain names with unusually high randomness (Shannon entropy)?
  context: This is another method for detecting Domain Generation Algorithms (DGAs). DGA domains often have a random, non-linguistic structure, which results in a high Shannon entropy score. Flagging queries with entropy scores in the top percentile can identify potential C2 domains that are not yet on any threat intelligence feed.
  answer_sources:
  - Zeek conn.log
  - Zeek weird.log
  - Zeek dns.log
  - Network egress points
  - Application servers
  - DNS resolvers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CALCULATE 98th percentile for Shannon entropy of all domain_queries
      SEARCH Zeek dns.log
      FOR each domain_query:
        CALCULATE shannon_entropy
        IF shannon_entropy > 98th_percentile_threshold:
          ALERT client_ip, domain_query, shannon_entropy
- question: Are there any outbound connections classified as obfuscated or tunneled traffic?
  context: Adversaries may attempt to hide exfiltrated data within what appears to be legitimate encrypted traffic (like TLS) or use custom tunneling protocols. A machine learning model trained on network flow characteristics (packet sizes, timings, etc.) can distinguish these malicious patterns from normal traffic, providing a way to detect hidden exfiltration channels.
  answer_sources:
  - Zeek conn.log
  - Zeek weird.log
  - Zeek dns.log
  - Network egress points
  - Application servers
  - DNS resolvers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek conn.log
      FOR each outbound connection:
        EXTRACT features (packet sizes, timings, byte counts)
        APPLY classification model
        IF classification is 'obfuscated' with confidence > 0.9:
          ALERT source_ip, destination_ip, confidence_score
- question: Has a brute-force login attempt followed by a successful login on a network management host been observed, immediately preceding the execution of a traffic mirroring command?
  context: This question correlates multiple suspicious events into a high-confidence attack chain. A failed login series (brute force), followed by a success, followed by the execution of a sensitive command to configure traffic mirroring, strongly indicates a compromised account is being used to set up data exfiltration.
  answer_sources:
  - Windows Event ID 4624
  - Windows Event ID 4625
  - Windows Event ID 4688
  - Zeek conn.log
  - Authentication servers (Active Directory)
  - Network management servers
  - VPN concentrators
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH for Windows Event ID 4625 (failed login)
      CORRELATE with Windows Event ID 4624 (successful login) from same source_ip within 5 mins
      CORRELATE with Windows Event ID 4688 on same host within 15 mins
      WHERE command_line contains ('port-mirror', 'erspan')
      ALERT source_ip, user, host, command_line
- question: Has an anomalous administrative login been followed by outlier network behavior?
  context: This question aims to detect when a compromised administrative account is used for malicious activity. It first identifies a risky login by comparing it to the user's normal behavior profile (e.g., unusual time, location). It then monitors for subsequent anomalous network activity, such as unusually large or long-lasting connections, originating from the network segments managed by that user, which could indicate data exfiltration.
  answer_sources:
  - Windows Event ID 4624
  - Windows Event ID 4625
  - Windows Event ID 4688
  - Zeek conn.log
  - Authentication servers (Active Directory)
  - Network management servers
  - VPN concentrators
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each admin user:
        BUILD profile of normal login behavior (hours, source_ips, etc.)
      SCORE each new login for risk
      IF login_risk_score > threshold:
        MONITOR for outlier network flows (volume, duration) from related segments
        ALERT user, login_details, network_flow_details
- question: Has an unusual access path been identified in the network graph (e.g., user's first login to a device, followed by a large data transfer to a new external IP)?
  context: Visualizing user, host, and network activity as a graph can reveal attack paths that are difficult to see in log lists. A graph-based anomaly detection algorithm can automatically flag unusual sequences, such as a user accessing a sensitive network device for the first time and that device immediately initiating a large data transfer to an unknown external destination. This pattern is highly indicative of data exfiltration.
  answer_sources:
  - Windows Event ID 4624
  - Windows Event ID 4625
  - Windows Event ID 4688
  - Zeek conn.log
  - Authentication servers (Active Directory)
  - Network management servers
  - VPN concentrators
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CONSTRUCT graph with nodes (users, hosts, external_ips) and edges (logs_into, sends_traffic_to)
      APPLY graph anomaly detection algorithm
      IDENTIFY unusual paths, e.g., (user)-[logs_into]->(new_host)-[sends_traffic_to]->(new_external_ip)
      ALERT on anomalous paths and associated entities