name: T1573.002: Asymmetric Cryptography
id: f8d5e8a0-432a-4b2a-874e-59c279c13b2e
description: >
  This playbook helps determine if an adversary has established an encrypted Command and Control (C2) channel using asymmetric cryptography. 
  It focuses on identifying malicious SSL/TLS connections by correlating network data with threat intelligence, detecting suspicious certificate attributes like self-signed status or generic subjects, analyzing traffic for behavioral anomalies such as beaconing or data exfiltration, observing non-browser processes initiating encrypted connections, and finding evidence of Domain Generation Algorithms (DGAs) used for C2 rendezvous.
type: technique
related:
  - TA0011: Command and Control
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any outbound SSL/TLS connections matched known malicious indicators from threat intelligence feeds?
    context: >
      Matching outbound connection data against high-confidence threat intelligence is a primary method for detecting known-bad C2 activity. This query looks for matches against IP addresses, domains (SNI), certificate details, and JA3/JA3S hashes to provide a high-fidelity signal of compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek x509.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          JOIN conn.log, ssl.log, x509.log
          WHERE dest_ip IN threat_feed_ips
             OR sni IN threat_feed_domains
             OR cert_serial IN threat_feed_serials
             OR cert_fingerprint IN threat_feed_fingerprints
             OR ja3 IN threat_feed_ja3s
             OR ja3s IN threat_feed_ja3s
          ALERT on match with connection details.
  - question: Are any identified malicious indicators being contacted by only a very small number of internal hosts?
    context: >
      Widespread benign traffic can sometimes be directed to a compromised site, leading to false positives. By checking the internal prevalence of a matched indicator, we can distinguish between widespread activity and targeted C2. A very low internal host count suggests the connection is more likely to be malicious and targeted.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Internet Gateway/Egress Points
    range: last 7 days
    queries:
      - search: pseudocode
        query: |
          FOR each IOC_match (dest_ip or sni)
            COUNT unique source_ips connecting to IOC_match over 7 days
            IF count is low (e.g., < 3 hosts)
              ESCALATE alert priority.
  - question: Can a machine learning model identify high-risk SSL/TLS connections that resemble known malicious traffic?
    context: >
      This proactive approach uses a supervised machine learning model to score new connections based on features that often distinguish malicious C2 from benign traffic. By training on labeled historical data, the model can learn subtle patterns and identify emerging threats that may not yet be in threat intelligence feeds.
    answer_sources:
      - Zeek ssl.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          TRAIN XGBoost model on historical labeled SSL data (JA3, cert details, ASN, etc.)
          DEPLOY model for real-time scoring of new connections.
          ALERT on connection_score > probability_threshold.
  - question: Are there any outbound SSL/TLS connections using self-signed certificates, generic subject names, or non-standard ports?
    context: >
      Legitimate services typically use certificates issued by trusted Certificate Authorities and operate on standard ports (like 443). Adversaries often use self-signed certificates or certificates with generic, non-descriptive subject information for their C2 infrastructure. Detecting these anomalies, especially on non-standard ports, can reveal covert C2 channels.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Zeek conn.log
      - Internet Gateway/Egress Points
      - Internal Server Segments
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          FROM x509.log
            ALERT IF certificate.issuer == certificate.subject
            ALERT IF certificate.subject.CN IN ('localhost', 'test', 'ACME', ...)
          CORRELATE alerts with conn.log where service is 'ssl' and dest_port NOT IN (443, 8443, 993, 995, 465, 587).
  - question: Can a risk score be calculated for outbound SSL/TLS connections to flag the most suspicious activity?
    context: >
      Instead of relying on a single indicator, this method aggregates multiple suspicious attributes into a single risk score. By assigning points for self-signed status, generic subjects, non-standard ports, and the rarity of the connection's JA3 hash, we can create a more robust detection that identifies connections exhibiting several C2-like characteristics.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Zeek conn.log
      - Internet Gateway/Egress Points
      - Internal Server Segments
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          FOR each SSL connection
            CALCULATE risk_score = (is_self_signed * 3) + (is_generic_subject * 2) + (is_non_standard_port * 1) + (ja3_rarity_score)
            ALERT IF risk_score > threshold.
  - question: Can unsupervised clustering identify anomalous groups of SSL/TLS connections that deviate from normal traffic patterns?
    context: >
      This approach assumes that most network traffic is legitimate and will form large, dense clusters based on its characteristics. Malicious C2 traffic, being different, will likely appear as small, isolated clusters or statistical outliers. Using an algorithm like DBSCAN can automatically surface these anomalies for investigation without prior knowledge of what is "bad."
    answer_sources:
      - Zeek ssl.log
      - Internet Gateway/Egress Points
      - Internal Server Segments
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          APPLY DBSCAN clustering to SSL connection features (cert validity, key length, JA3, etc.)
          INVESTIGATE small clusters and outlier points identified by the algorithm.
  - question: Are there any long-lived encrypted connections where the amount of data sent significantly exceeds the data received?
    context: >
      This pattern is a classic indicator of data exfiltration over a C2 channel. An adversary may establish an encrypted session to upload stolen data from a compromised host. By looking for SSL/TLS connections with a high upload-to-download ratio and a long duration, especially to destinations not associated with legitimate file transfer services, we can detect this activity.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          FROM conn.log where service is 'ssl'
            CALCULATE ratio = orig_bytes / resp_bytes
            ALERT IF ratio > 1.5 AND duration > 10_minutes AND dest_ip NOT IN allowlist.
  - question: Has any host exhibited a sudden, significant deviation from its normal outbound SSL/TLS traffic behavior?
    context: >
      Every host establishes a baseline of normal network activity. A compromise can cause a dramatic shift in this behavior. By creating a statistical baseline for each host's connection duration, data volume, and upload/download ratio, we can detect when a new connection is a significant outlier (e.g., 3+ standard deviations from the mean), indicating a potential C2 event.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Internet Gateway/Egress Points
    range: last 30 days for baseline, current for detection
    queries:
      - search: pseudocode
        query: |
          FOR each host
            CALCULATE 30-day baseline (mean, stddev) for SSL conn duration, bytes, ratio.
          FOR each new connection
            ALERT IF value > (mean + 3 * stddev) for any metric.
  - question: Is any host making periodic, regularly timed connections to an external destination, indicative of C2 beaconing?
    context: >
      Malware often "beacons" out to its C2 server at regular intervals to check for new commands. This automated activity results in connections with very low jitter (i.e., a highly consistent time delta between connections). By analyzing the time series of connections from a source to a destination, we can identify this machine-like regularity and detect covert C2 channels.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Internet Gateway/Egress Points
    range: last 1 hour
    queries:
      - search: pseudocode
        query: |
          FOR each source_ip, dest_ip pair
            CALCULATE time deltas between consecutive connections over 1 hour.
            CALCULATE stddev of time deltas.
            ALERT IF stddev is very low AND connection_count >= 5.
  - question: Has a non-browser application, such as a scripting engine, initiated an outbound SSL/TLS connection?
    context: >
      While web browsers are expected to make many SSL/TLS connections, it is highly suspicious when command-line tools (like powershell.exe) or other system processes (rundll32.exe) do so. This is a common technique for malware to establish C2. Correlating process creation events with network connection events on an endpoint allows for the detection of this anomalous behavior.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Endpoint Devices (User Workstations, Servers)
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          JOIN WinEvent:4688 (Process Creation) with WinEvent:5156 (Network Connection) on ProcessID.
          ALERT IF process_name NOT IN browser_allowlist AND dest_port IN (443, ...).
  - question: Have any network connections been initiated by processes involved in statistically rare parent-child relationships?
    context: >
      Adversaries often use legitimate processes to launch malicious ones in an attempt to hide. For example, Microsoft Word spawning PowerShell is highly unusual and suspicious. By baselining normal parent-child process relationships across the enterprise, we can identify and score rare chains of execution, and flag network connections originating from them as high-risk.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Endpoint Devices (User Workstations, Servers)
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          BUILD frequency table of all parent-child process relationships from Event 4688.
          SCORE network connections from Event 5156 based on rarity of its process's parent.
          ALERT on high combined risk scores.
  - question: Can graph-based analysis identify a high-risk chain of events, such as an Office application spawning a shell that connects to a rare IP?
    context: >
      Attack sequences can be modeled as a graph, connecting processes, files, and network destinations. This provides a holistic view of activity. Using graph analytics or a Graph Neural Network (GNN) can automatically identify suspicious subgraphs that represent a full attack chain, which is a much stronger signal than any single event in isolation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Endpoint Devices (User Workstations, Servers)
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          CONSTRUCT graph of processes, files, network destinations.
          USE GNN or graph anomaly detection to find high-risk subgraphs (e.g., word.exe -> powershell.exe -> rare_ip).
          ALERT on high-risk subgraphs.
  - question: Has a host made DNS queries for domains that appear to be algorithmically generated (DGA)?
    context: >
      Domain Generation Algorithms (DGAs) are used by malware to periodically generate a large number of domain names that can be used for C2, with the adversary only needing to register one to establish contact. These domains often have a random appearance. By scanning DNS queries for known DGA patterns, we can proactively identify potential C2 rendezvous attempts.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Zeek conn.log
      - Internal DNS Resolvers
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          SCAN dns.log query names against DGA regex patterns.
          IF match, CORRELATE resolved IP with conn.log to confirm connection.
  - question: Are any hosts exhibiting DNS or connection behavior indicative of DGA, such as querying high-entropy domains or connecting to an unusually large number of unique IPs?
    context: >
      Besides matching specific patterns, DGA activity can be detected through statistical anomalies. Algorithmically generated domains tend to have high character-level entropy (randomness). Additionally, some malware may rapidly cycle through many potential C2 IPs (domain fluxing). Monitoring for high-entropy DNS queries or a sudden spike in unique destination IPs can reveal this behavior.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Zeek conn.log
      - Internal DNS Resolvers
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          FOR each DNS query, CALCULATE Shannon entropy of hostname; ALERT if > 4.0.
          FOR each host, COUNT unique destination IPs on port 443 in 5-min window; ALERT if count > 99.5th percentile.
  - question: Is any host querying a number of new, unique domains that significantly exceeds its normal behavior?
    context: >
      This question uses time series forecasting to model a host's normal rate of discovering new domains. A host infected with DGA-based malware might suddenly start querying hundreds or thousands of new, never-before-seen domains in a short period. A forecasting model can automatically detect when this activity significantly deviates from the predicted normal range, signaling a likely compromise.
    answer_sources:
      - Zeek dns.log
      - Internal DNS Resolvers
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: pseudocode
        query: |
          FOR each host, MODEL hourly count of new unique FQDNs with SARIMA/Prophet.
          ALERT if actual count exceeds upper bound of 99% prediction interval.