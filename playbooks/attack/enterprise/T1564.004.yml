name: "T1564.004: NTFS File Attributes"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps to answer the question: Is the adversary evading defenses by using NTFS file attributes? It provides investigative steps to detect malicious use of Alternate Data Streams (ADS). Detections focus on identifying processes created from ADS paths that match threat intelligence, exhibit anomalous frequency or characteristics, or are part of a 'write-and-execute' sequence. The playbook also looks for unusual process lineages, such as Office applications spawning processes that use ADS, and correlates ADS execution with suspicious outbound network activity like connections to known bad IPs or C2 beaconing."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a process being created with a command line containing an Alternate Data Stream (ADS) path that matches a known malicious indicator from threat intelligence?"
    context: "This question aims to detect the most straightforward and high-confidence indicator of malicious ADS usage. Adversaries may use known malicious tools or scripts hidden in ADS. By comparing command line arguments against a curated list of known-bad ADS paths and stream names from threat intelligence, analysts can quickly identify and respond to confirmed threats."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows Endpoints and Servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process_creation_events (e.g., WinEventID:4688) WHERE command_line CONTAINS ':' AND command_line MATCHES threat_intel_ads_list"
  - question: "Is a process being created from an unusually rare combination of a parent file path and an Alternate Data Stream (ADS) name?"
    context: "Adversaries often use unique or randomized names for ADS streams and place them in uncommon file locations to avoid detection. Benign ADS usage (e.g., by browsers) is typically repetitive and predictable. This question identifies statistical outliers by looking for combinations of parent files and stream names that have rarely or never been seen before, which can indicate an attempt to hide malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows Endpoints and Servers"
    range: "last 30 days"
    queries:
      - technology: "pseudocode"
        query: "ANALYZE process_creation_events (e.g., WinEventID:4688) with ADS paths. CALCULATE frequency of (parent_path, stream_name) pairs over 30 days. ALERT if a new event's pair falls in the bottom 5th percentile of frequency."
  - question: "Does a process command line involving an Alternate Data Stream (ADS) exhibit characteristics similar to known malicious activity, based on a machine learning model?"
    context: "This question leverages machine learning to move beyond simple string matching and frequency analysis. By training a model on features like command line length, entropy, and the presence of specific keywords (e.g., 'powershell', 'certutil'), it can learn the subtle patterns that distinguish malicious ADS usage from benign activity. This provides a more sophisticated and adaptable detection method for novel threats."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows Endpoints and Servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each process_creation_event with ADS: EXTRACT features (length, entropy, keywords). SCORE with trained ML model. ALERT if score > malicious_threshold."
  - question: "Is a process that is not on the approved allow-list creating, accessing, or executing from an Alternate Data Stream (ADS)?"
    context: "Only a limited number of legitimate applications (like web browsers and file explorers) typically interact with ADS. This question helps to quickly filter out expected noise by maintaining an allow-list of these known-good processes. Any process not on this list that is observed interacting with an ADS is inherently suspicious and warrants investigation, as it may indicate an unauthorized tool or script."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "User Workstations, Web Servers, and Application Servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process_creation_events (4688) or file_access_events (4663) WHERE (command_line OR object_name) CONTAINS ':' AND process_name NOT IN (ads_allow_list)."
  - question: "Is a specific process on a given host showing an anomalous spike in Alternate Data Stream (ADS) related activity compared to its own historical baseline?"
    context: "Even legitimate processes can be hijacked or abused. This question aims to detect changes in behavior for a single process on a specific machine. By establishing a baseline of normal ADS activity for each process/host pair, a sudden, statistically significant increase (e.g., more than three standard deviations from the mean) can signal a potential compromise or a change in the process's function, such as an adversary using it to write or execute malicious code."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "User Workstations, Web Servers, and Application Servers"
    range: "last 30 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each (process_name, host): CALCULATE daily_avg and std_dev of ADS events over 30 days. ALERT if current_day_count > (daily_avg + 3 * std_dev)."
  - question: "Does an event involving an Alternate Data Stream (ADS) appear as a statistical anomaly when clustered with other similar events?"
    context: "This question uses unsupervised machine learning to find 'unknown unknowns'. By grouping all ADS-related events based on their contextual features (process, parent, user, time, etc.), the algorithm can identify normal, high-volume activity. Events that do not fit into any large, common cluster are flagged as outliers. This is effective for detecting novel attack techniques that don't match any pre-defined rules or signatures."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "User Workstations, Web Servers, and Application Servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CLUSTER all ADS events using features (process, parent, user, time). IDENTIFY outliers/small clusters. ALERT on outlier events."
  - question: "Has a file write to an Alternate Data Stream (ADS) been immediately followed by a process execution from that same ADS path on the same host?"
    context: "This question targets a classic 'write-and-execute' pattern, which is a strong indicator of malware deployment. Adversaries often write a malicious payload to a hidden ADS and then immediately execute it. By correlating a file write event with a subsequent process creation event from the exact same ADS path within a very short time window (e.g., 5 minutes), analysts can detect this high-confidence attack sequence."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Critical System Directories (e.g., C:\\Windows\\System32), User Profile Directories, and Temporary File Directories"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CORRELATE file_write_events (4663) with ADS path AND process_creation_events (4688) from same ADS path ON same host WITHIN 5 minutes. ALERT on match."
  - question: "Is the time delay between a file write to an Alternate Data Stream (ADS) and its subsequent execution an outlier compared to normal behavior?"
    context: "This question adds another layer of analysis to the 'write-and-execute' pattern. While some legitimate software might exhibit this behavior, it often happens with a consistent time delay. Adversaries might use immediate execution (very short delta) or scheduled tasks (very long delta). By baselining the typical time differences and flagging statistical outliers, analysts can distinguish between routine software updates and potentially malicious activity."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Critical System Directories (e.g., C:\\Windows\\System32), User Profile Directories, and Temporary File Directories"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE time_delta between correlated write-execute events. BASELINE distribution of deltas. ALERT if new delta is an outlier (e.g., <1st or >99th percentile)."
  - question: "Is there a widespread, anomalous spike in 'write-and-execute' activity involving Alternate Data Streams (ADS) across the entire enterprise?"
    context: "This question seeks to identify large-scale, coordinated attacks, such as a worm or a ransomware outbreak, that might use ADS for propagation. By monitoring the total volume of 'write-and-execute' events over time, a time-series anomaly detection model can learn the normal rhythm of the organization. A sudden, significant deviation from this predicted rhythm would indicate a widespread event that requires immediate, high-level attention."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Critical System Directories (e.g., C:\\Windows\\System32), User Profile Directories, and Temporary File Directories"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "AGGREGATE count of write-execute events per hour. APPLY time-series anomaly detection model. ALERT if observed count significantly deviates from forecast."
  - question: "Is a high-risk parent process, such as an Office application or web server, spawning a child process that interacts with an Alternate Data Stream (ADS)?"
    context: "This question targets a common attack vector where adversaries exploit vulnerabilities in document-handling applications or web servers to gain initial execution. These parent processes should almost never spawn child processes that manipulate ADS. An alert on this behavior is a strong indicator of a successful exploit, such as a malicious macro or a web shell, being used to drop and run a secondary payload."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Microsoft Office Servers (e.g., Exchange), Web Servers (e.g., IIS), and User Workstations running Office applications"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process_creation_events (4688) WHERE parent_process_name IN (high_risk_office_web_list) AND child_command_line CONTAINS ':'."
  - question: "Has a rare or never-before-seen parent-child process relationship been observed where the child process is interacting with an Alternate Data Stream (ADS)?"
    context: "Adversaries often create novel execution chains to evade defenses based on known parent-child relationships. This question focuses on identifying these unusual process lineages. By baselining all parent-child process pairs that involve ADS, any new pair that is extremely rare is flagged as suspicious. This helps detect attacker activity that deviates from established software behavior."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Microsoft Office Servers (e.g., Exchange), Web Servers (e.g., IIS), and User Workstations running Office applications"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE frequency of (parent_process, child_process) pairs for ADS events over 90 days. ALERT if a new pair's frequency is below a rarity threshold (e.g., < 5)."
  - question: "Does a new process creation involving an Alternate Data Stream (ADS) represent an anomalous link in the overall process execution graph of the environment?"
    context: "This question takes a holistic, graph-based view of process relationships. Normal activity forms dense, well-connected communities in a process graph. An adversary's actions might create an unusual edge that bridges two otherwise disconnected parts of the graph. Detecting such structurally significant changes can uncover complex, multi-stage attack chains."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Microsoft Office Servers (e.g., Exchange), Web Servers (e.g., IIS), and User Workstations running Office applications"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "MAINTAIN a process lineage graph. FOR new ADS-related process creation: ADD edge to graph. CALCULATE graph metrics (e.g., centrality, community structure). ALERT if the new edge causes a significant structural change."
  - question: "Is a process launched from an Alternate Data Stream (ADS) making a network connection to a known malicious IP address?"
    context: "This question correlates file-based execution with network-based indicators to find high-confidence signs of command-and-control (C2) or data exfiltration. An adversary may hide their tool in an ADS and then use it to connect to their infrastructure. By joining the process creation event with the network connection event and checking against threat intelligence, analysts can pinpoint active compromises."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "DMZ Servers, Internet Gateways, and Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "JOIN process_creation_events (4688) with ADS path TO network_connection_events (5156/Zeek) ON ProcessID. ALERT if destination_ip MATCHES threat_intel_ip_list."
  - question: "Is a process launched from an Alternate Data Stream (ADS) connecting to an unusual port or exhibiting port scanning behavior?"
    context: "This question seeks to identify suspicious network behavior from processes hidden in ADS, even without threat intelligence matches. Adversaries may use non-standard ports for C2 or scan for open ports. By baselining normal port usage and flagging connections to rare ports or a sudden increase in the variety of ports being contacted (high entropy), analysts can detect these reconnaissance or C2 activities."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "DMZ Servers, Internet Gateways, and Domain Controllers"
    range: "last 24 hours"
    queries:
      - technology: "pseudocode"
        query: "FOR connections from ADS processes: CALCULATE port entropy per host over 24h; ALERT on spikes. SEPARATELY, ALERT on connections to statistically rare ports across the enterprise."
  - question: "Does the network traffic from a process launched from an Alternate Data Stream (ADS) exhibit characteristics of C2 beaconing or other anomalous patterns?"
    context: "This question applies advanced analysis to network traffic to find covert command-and-control channels. Malware often 'beacons' out at regular intervals. A time-series model can detect this periodicity. For more sophisticated C2, an anomaly detection model can analyze features like connection duration, data volume, and the rarity of the TLS/SSL client fingerprint (JA3/JA3S hash) to identify unusual traffic."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "DMZ Servers, Internet Gateways, and Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR connections from ADS processes: MODEL time/size to detect beaconing. SEPARATELY, MODEL connection features (duration, bytes, JA3 rarity) to detect other anomalies. ALERT on findings."