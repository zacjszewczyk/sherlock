name: T1566.001: Spearphishing Attachment
id: 5a1b3c8d-9e0f-4a2b-8c7d-6e5f4a3b2c1d
description: |
  This playbook helps investigate whether an adversary has gained initial access to the network via a spearphishing attachment. The investigation focuses on identifying indicators such as malicious file hashes, sender IPs, or domains in emails; suspicious process creation from email client cache directories, especially those with double extensions; high-entropy or keyword-laden command lines indicating obfuscation or downloaders; Microsoft Office applications spawning shell processes; and anomalous network connections to new or malicious destinations shortly after an email is delivered.
type: technique
related:
- TA0001: Initial Access
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are file hashes, sender IP addresses, or domains from incoming emails matching known malicious indicators on our threat intelligence feeds?
  context: |
    This question aims to perform a direct match of email artifacts against high-confidence threat intelligence. A match provides a strong signal that a known malicious email has been received. This is a fundamental, high-fidelity check for known threats.
  answer_sources:
  - Zeek files.log
  - Zeek smtp.log
  - Zeek intel.log
  - Email gateway
  - network perimeter firewalls
  - network security monitoring sensors (e.g., Zeek sensors at the internet gateway).
  range: Continuously
  queries:
  - technology: Pseudocode
    query: SEARCH Zeek intel.log WHERE intel_source = 'high_confidence_feed' AND seen_where IN ('SMTP::IN', 'FILES')
- question: Are we receiving emails from domains that are historically rare for our organization and have a structurally random subdomain, suggesting potential domain generation algorithms?
  context: |
    Adversaries often use newly registered or algorithmically generated domains for phishing campaigns. This question seeks to identify such domains by analyzing their historical frequency and structural complexity (entropy). A domain that is both rare and appears random is highly suspicious and warrants investigation.
  answer_sources:
  - Zeek files.log
  - Zeek smtp.log
  - Zeek intel.log
  - Email gateway
  - network perimeter firewalls
  - network security monitoring sensors (e.g., Zeek sensors at the internet gateway).
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Zeek smtp.log | GROUP BY sender_domain | CALCULATE frequency, subdomain_entropy | WHERE frequency < 5th_percentile AND subdomain_entropy > 90th_percentile
- question: Is a machine learning model classifying any incoming sender domains as likely malicious based on their characteristics?
  context: |
    This question leverages a machine learning model to proactively identify malicious domains that may not yet be on threat intelligence feeds. The model analyzes various features of a domain (e.g., length, character randomness, age) to predict its likelihood of being malicious, providing a more sophisticated and forward-looking detection capability.
  answer_sources:
  - Zeek files.log
  - Zeek smtp.log
  - Zeek intel.log
  - Email gateway
  - network perimeter firewalls
  - network security monitoring sensors (e.g., Zeek sensors at the internet gateway).
  range: Real-time
  queries:
  - technology: Pseudocode
    query: SEARCH email_logs | INVOKE domain_classification_model(sender_domain) | WHERE model_score > 0.9
- question: Has a process with a suspicious double file extension (e.g., 'report.pdf.exe') been launched from a known email client's temporary file directory?
  context: |
    Adversaries often disguise executable files by giving them a double extension to trick users into thinking they are harmless documents. This question looks for this specific TTP by checking for processes with deceptive names that are executed from a location where email attachments are typically saved, which is a strong indicator of a user being tricked into running a malicious file.
  answer_sources:
  - Windows Event ID 4688
  - User workstations, particularly those of executives, finance, and HR personnel who are common targets for spearphishing.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH EventID=4688 WHERE NewProcessName MATCHES_REGEX '.*\\.(pdf|docx|xlsx|jpg|zip)\\.(exe|scr|bat|ps1)$' AND ProcessPath CONTAINS 'Content.Outlook'
- question: Have any statistically rare or previously unseen process execution patterns (parent process, process name, path) been observed on user workstations?
  context: |
    This question aims to identify anomalous process executions by baselining normal activity. Malicious activity often involves processes running from unusual locations or being spawned by unexpected parent processes. By flagging executions that are statistically rare (e.g., in the 1st percentile of frequency), analysts can uncover novel or evasive malware behavior that rule-based detections might miss.
  answer_sources:
  - Windows Event ID 4688
  - User workstations, particularly those of executives, finance, and HR personnel who are common targets for spearphishing.
  range: last 30 days
  queries:
  - technology: Pseudocode
    query: SEARCH EventID=4688 | CREATE unique_id(ParentProcessName, NewProcessName, ProcessPath) | CALCULATE frequency(unique_id) over last 30d | WHERE frequency < 1st_percentile
- question: Is an anomaly detection model identifying any process executions that significantly deviate from the established baseline of normal behavior?
  context: |
    This question applies an unsupervised machine learning model to detect anomalous process behavior. The model learns a profile of 'normal' based on features like process path, name entropy, and parent process. It can then identify outliers that deviate from this profile, which could represent malicious activity from a spearphishing attachment that does not conform to any known patterns.
  answer_sources:
  - Windows Event ID 4688
  - User workstations, particularly those of executives, finance, and HR personnel who are common targets for spearphishing.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH EventID=4688 | INVOKE process_anomaly_model(ProcessPath, NewProcessName, ParentProcessName) | WHERE is_anomaly = true
- question: Do any process command lines or PowerShell script blocks contain keywords or patterns indicative of download cradles or obfuscation techniques (e.g., 'IEX', 'FromBase64String')?
  context: |
    Malware dropped from a phishing attachment often uses command-line tools or PowerShell to download the next stage of the attack. This question uses signature-based detection to look for common keywords and patterns (like 'Invoke-Expression' or 'DownloadString') within command lines and script blocks, which are strong indicators of malicious follow-on activity.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - User workstations
  - VDI environments
  - terminal servers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH (EventID=4688 OR EventID=4104) WHERE (CommandLine CONTAINS 'IEX' OR 'DownloadString' OR 'FromBase64String')
- question: Are there any command lines, particularly for scripting hosts, that exhibit unusually high entropy or length compared to their historical baselines, suggesting obfuscation?
  context: |
    Adversaries heavily obfuscate their commands to evade signature-based detection. This often results in long, random-looking strings (high entropy). This question seeks to detect this obfuscation by calculating the entropy and length of command lines and flagging those that are statistical outliers compared to the established baseline for that specific process (e.g., powershell.exe).
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - User workstations
  - VDI environments
  - terminal servers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH EventID=4688 WHERE ProcessName IN ('powershell.exe', 'cmd.exe') | CALCULATE entropy(CommandLine), length(CommandLine) | WHERE entropy > 99th_percentile OR length > 99th_percentile
- question: Is a natural language processing model classifying any captured command lines or script blocks as having a high probability of being malicious?
  context: |
    This question moves beyond simple keyword matching and statistical measures by applying a sophisticated text classification model. By training on a vast dataset of benign and malicious scripts, the model can learn the nuanced characteristics of malicious code and classify new, unseen command lines in real-time, catching novel and complex threats.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - User workstations
  - VDI environments
  - terminal servers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH (EventID=4688 OR EventID=4104) | INVOKE commandline_nlp_model(CommandLine) | WHERE probability_malicious > 0.9
- question: Has a Microsoft Office application (e.g., Word, Excel) spawned a command-line interpreter or scripting host (e.g., cmd.exe, powershell.exe)?
  context: |
    It is highly irregular for a Microsoft Office application to directly spawn a shell or scripting engine. This behavior is a classic indicator of a malicious macro or embedded object executing code. This question looks for this specific, high-fidelity parent-child process relationship to detect the initial execution of code from a weaponized document.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - User workstations, and network egress/ingress points for correlating host and network events.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH EventID=4688 WHERE ParentProcessName IN ('winword.exe', 'excel.exe', 'powerpnt.exe') AND NewProcessName IN ('cmd.exe', 'powershell.exe', 'wscript.exe')
- question: Have any statistically rare parent-child process chains been observed, especially if the child process initiates a network connection to a new domain?
  context: |
    This question identifies suspicious activity by focusing on the rarity of process creation chains. A process chain that has never or rarely been seen before (e.g., Excel spawning a PowerShell script) is inherently suspicious. The suspicion level is greatly increased if that child process then makes an outbound network connection to a domain that is also new to the organization.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - User workstations, and network egress/ingress points for correlating host and network events.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH EventID=4688 | CREATE chain(ParentProcessName, NewProcessName) | CALCULATE rarity(chain) | WHERE rarity < 1st_percentile
- question: Is a graph-based anomaly detection model identifying unlikely process creation sequences, such as an Office application spawning a shell that connects to a new external IP?
  context: |
    This question models process activity as a graph to understand the entire chain of events, not just isolated parent-child relationships. By analyzing the sequence of process creations and subsequent network connections as a single path, a graph-based model can identify statistically improbable chains of behavior that represent a full attack sequence, from initial execution to C2 communication.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - User workstations, and network egress/ingress points for correlating host and network events.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH process_creation_events | BUILD process_graph | INVOKE graph_anomaly_detection() | SHOW anomalous_chains
- question: Has a host initiated a network connection to a known malicious IP address within 10 minutes of receiving an email?
  context: |
    This question aims to directly link a received email to malicious network activity. By correlating an email delivery event with a subsequent outbound connection from the same host to an IP on a threat feed, it creates a high-confidence alert. The tight time window (10 minutes) strongly suggests the user opened a malicious attachment or link that initiated the connection.
  answer_sources:
  - Zeek smtp.log
  - Zeek conn.log
  - Zeek dns.log
  - Zeek intel.log
  - Email gateway
  - DNS resolvers
  - network egress/ingress points.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: JOIN (SEARCH smtp.log) as email, (SEARCH conn.log) as conn ON email.recipient_ip = conn.source_ip WHERE conn.timestamp < email.timestamp + 10m | JOIN (SEARCH intel.log) as threat ON conn.dest_ip = threat.indicator
- question: Following an email delivery, is a host exhibiting periodic, low-jitter outbound network connections to a single destination, indicative of C2 beaconing?
  context: |
    After initial compromise, malware often establishes a command and control (C2) channel, which frequently manifests as periodic 'beaconing' traffic. This question looks for this pattern by analyzing the timing between connections to a single destination after an email is received. A low standard deviation in the time intervals (low jitter) is a key characteristic of automated, machine-generated traffic like C2 beacons.
  answer_sources:
  - Zeek smtp.log
  - Zeek conn.log
  - Zeek dns.log
  - Zeek intel.log
  - Email gateway
  - DNS resolvers
  - network egress/ingress points.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH conn.log | GROUP BY dest_ip | CALCULATE stdev(time_delta) | WHERE stdev < 1.0
- question: Did a host's outbound network traffic volume or connection count significantly deviate from its forecasted baseline in the hour following an email delivery?
  context: |
    This question uses time-series analysis to detect anomalous network behavior. A model learns the normal pattern of a host's outbound traffic. If, after receiving an email, the host's traffic volume or connection count dramatically deviates from what the model forecasted, it signals a potential anomaly. This could represent data exfiltration or the downloading of additional malicious payloads.
  answer_sources:
  - Zeek smtp.log
  - Zeek conn.log
  - Zeek dns.log
  - Zeek intel.log
  - Email gateway
  - DNS resolvers
  - network egress/ingress points.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH conn.log | FORECAST traffic_volume, connection_count FOR each host | COMPARE actual vs forecast | WHERE residual_error > 3 * stdev