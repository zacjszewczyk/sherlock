name: T1583.008: Malvertising
id: 552c6f1a-641e-4f81-8077-1111a851e44a
description: This playbook helps identify evidence of adversaries leveraging malvertising
  infrastructure against the organization's environment or users. It focuses on
  detecting direct connections to known malvertising indicators, analyzing suspicious
  HTTP redirect chains leading to newly registered or low-reputation domains, identifying
  low-prevalence files downloaded from ad-related referers, spotting non-browser
  processes spawned by browsers after visiting high-risk sites, and monitoring for
  unusual spikes in DNS queries for newly registered domains that are correlated
  with traffic from ad networks.
type: technique
related:
- TA0042: Resource Development
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are internal hosts connecting to or resolving known malvertising indicators
    (IPs, domains, URLs) from our threat intelligence feeds?
  context: This question aims to detect direct communication with malicious infrastructure
    identified by high-confidence threat intelligence. A match indicates a potential
    compromise or an attempt to lure a user to a malicious site via a malvertising
    campaign. Early detection of such connections is crucial for preventing further
    malicious activity.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Zeek http.log
  - User Workstations
  - Internet Gateway
  - Internal DNS Resolvers
  range: last 90 days
  queries:
  - search: pseudocode
    query: JOIN network_logs (conn, dns, http) WITH threat_intel_list ON (destination_ip,
      domain, url) WHERE indicator_type = 'malvertising'. ALERT on match.
- question: Is there an unusual concentration of internal hosts contacting the same
    malvertising indicator within a short timeframe?
  context: This question seeks to identify widespread activity related to a single
    malvertising indicator. A sudden increase in the number of unique hosts contacting
    the same malicious domain or IP compared to historical norms can signify a large-scale,
    coordinated attack campaign rather than an isolated incident, warranting a higher-priority
    response.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Zeek http.log
  - User Workstations
  - Internet Gateway
  - Internal DNS Resolvers
  range: last 90 days
  queries:
  - search: pseudocode
    query: FROM malvertising_matches, GROUP BY indicator, 1_hour_window. COUNT unique
      source_ip. IF count > 95th_percentile_baseline(indicator), ESCALATE priority.
- question: Is the overall volume of connections to known malvertising indicators
    significantly higher than forecasted levels?
  context: This question uses time series forecasting to detect anomalies in the
    aggregate volume of malvertising activity. A significant deviation from the predicted
    volume, even if spread across multiple indicators, can signal the start of a
    new or intensified malvertising campaign that might be missed by per-indicator
    thresholds.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Zeek http.log
  - User Workstations
  - Internet Gateway
  - Internal DNS Resolvers
  range: last 90 days
  queries:
  - search: pseudocode
    query: APPLY SARIMA model to hourly_count(malvertising_matches). IF observed_count
      > 99_percent_confidence_interval(forecast), TRIGGER investigation.
- question: Are users being redirected through a chain of ad network domains to a
    newly registered or low-reputation website?
  context: This question looks for a common malvertising pattern where users are
    passed through multiple redirects, often starting from a legitimate ad network,
    to obscure the final malicious destination. Identifying chains that land on newly
    registered domains (NRDs) or sites with poor reputation is a strong indicator
    of a malvertising attack.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Web Proxies
  - Internet Gateway
  - User Workstations
  range: last 90 days
  queries:
  - search: pseudocode
    query: TRACK session by uid in http_logs. IF referer IN ad_network_list AND count(http_redirect)
      >= 3 AND final_destination IN nrd_list OR final_destination_reputation < 20,
      ALERT.
- question: Does the final URL in a suspicious redirect chain contain an unusually
    high degree of randomness in its query string?
  context: This question provides additional evidence for maliciousness by analyzing
    the complexity of the destination URL. Adversaries often use high-entropy (random-looking)
    query strings to pass unique identifiers or obfuscated commands. A URL with significantly
    higher entropy than typical for your environment is more likely to be malicious.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Web Proxies
  - Internet Gateway
  - User Workstations
  range: last 90 days
  queries:
  - search: pseudocode
    query: FOR each flagged_redirect_chain, CALCULATE shannon_entropy(final_url_query_string).
      IF entropy > 95th_percentile_baseline(all_urls_24h), INCREASE risk_score.
- question: Can a machine learning model identify redirect chains that are highly
    likely to be malicious based on their characteristics?
  context: This question leverages a classification model to score the risk of any
    given redirect chain. By combining multiple features like the number of hops,
    domain age, reputation, and URL complexity, the model can identify malicious
    redirect chains with greater accuracy and fewer false positives than a simple
    rule-based approach.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Web Proxies
  - Internet Gateway
  - User Workstations
  range: last 90 days
  queries:
  - search: pseudocode
    query: INPUT redirect_chain_features INTO gradient_boosting_model. IF model_score
      > 0.8, ALERT.
- question: Has a known malicious file been downloaded to an endpoint from a session
    that originated from an ad network?
  context: This question seeks to find the 'payload' delivery stage of a malvertising
    attack. It directly links a file download to an ad-related web session and confirms
    its maliciousness using signature-based detection, providing high-confidence
    evidence of a compromise.
  answer_sources:
  - Zeek http.log
  - Zeek files.log
  - Windows Event ID 4688
  - Windows Event ID 11 (Sysmon)
  - User Workstations
  - Internet Gateway
  - Download Servers
  range: last 90 days
  queries:
  - search: pseudocode
    query: CORRELATE http_log (referer IN ad_network_list) with files_log (file_download)
      on session_uid. CORRELATE file_hash with endpoint_log (file_creation). IF file_hash
      IN malware_signatures, ALERT.
- question: Has a rare or highly complex file been downloaded from a session originating
    from an ad network?
  context: This question helps uncover unknown or polymorphic malware delivered via
    malvertising. A file that has been seen on very few endpoints (low prevalence)
    is suspicious. When combined with high entropy (a measure of randomness common
    in packed or encrypted malware) and an ad-related origin, it becomes a strong
    candidate for investigation.
  answer_sources:
  - Zeek http.log
  - Zeek files.log
  - Windows Event ID 4688
  - Windows Event ID 11 (Sysmon)
  - User Workstations
  - Internet Gateway
  - Download Servers
  range: last 90 days
  queries:
  - search: pseudocode
    query: FOR files downloaded from ad_referer, CALCULATE prevalence(file_hash)
      over 30_days. IF prevalence < 10 AND shannon_entropy(file) > 7.0, FLAG as suspicious.
- question: Is there an anomalous spike in the rate of executable file downloads
    originating from ad networks?
  context: This question aims to detect a mass payload distribution campaign. By
    monitoring the rate of executable downloads linked to ad referers, a time series
    model can flag sudden, anomalous increases that deviate from the established
    baseline, indicating that an adversary may be pushing malware to a large number
    of users simultaneously.
  answer_sources:
  - Zeek http.log
  - Zeek files.log
  - Windows Event ID 4688
  - Windows Event ID 11 (Sysmon)
  - User Workstations
  - Internet Gateway
  - Download Servers
  range: last 90 days
  queries:
  - search: pseudocode
    query: APPLY anomaly_detection_model to hourly_rate(executable_downloads from
      ad_referer). IF rate > 99th_percentile_baseline, ALERT.
- question: Is a browser process spawning a command-line interpreter or scripting
    engine shortly after visiting a known malvertising site?
  context: This question looks for evidence of post-exploitation activity immediately
    following a suspected malvertising compromise. Legitimate websites rarely cause
    a browser to spawn processes like PowerShell or cmd.exe. Correlating this endpoint
    behavior with recent network traffic to a malvertising IOC provides strong evidence
    of successful code execution on the endpoint.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Zeek http.log
  - Zeek conn.log
  - User Workstations
  - Active Directory Domain Controllers
  range: last 90 days
  queries:
  - search: pseudocode
    query: ON process_creation (parent=browser, child=scripting_engine), QUERY network_logs
      for source_ip in last 60s. IF host connected to malvertising_ioc, ALERT.
- question: Is a process spawned by a browser using command-line arguments that are
    unusually complex or random?
  context: This question analyzes the command-line arguments of processes launched
    by browsers to find signs of obfuscation. Adversaries often use encoded or randomized
    arguments to hide their commands. A command line with abnormally high entropy
    compared to the baseline for that specific parent-child process pair is highly
    suspicious and indicative of malicious intent.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Zeek http.log
  - Zeek conn.log
  - User Workstations
  - Active Directory Domain Controllers
  range: last 90 days
  queries:
  - search: pseudocode
    query: FOR process_creation (parent=browser), CALCULATE entropy(command_line).
      IF entropy > 98th_percentile_baseline(parent_child_pair), FLAG.
- question: Can a machine learning model identify browser-spawned processes that
    are likely to be malicious?
  context: This question uses a classification model to score the risk of a browser
    spawning another process. By analyzing features like the process names, command-line
    characteristics, and recent network activity, the model can provide a probabilistic
    assessment of whether the activity is malicious, allowing analysts to focus on
    the highest-risk events.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Zeek http.log
  - Zeek conn.log
  - User Workstations
  - Active Directory Domain Controllers
  range: last 90 days
  queries:
  - search: pseudocode
    query: INPUT process_features (name, parent, cmd_line_entropy, etc.) INTO random_forest_model.
      IF model_score is high, ALERT.
- question: Are internal hosts querying for newly registered domains immediately
    after visiting known ad-serving platforms?
  context: This question attempts to link the initial stage of a malvertising chain
    (visiting an ad platform) to a potential malicious destination (an NRD). Since
    adversaries frequently use new domains for their campaigns, correlating DNS queries
    for NRDs with preceding HTTP traffic from ad networks can proactively identify
    suspicious redirect chains.
  answer_sources:
  - Zeek dns.log
  - Zeek http.log
  - Zeek conn.log
  - Internal DNS Resolvers
  - Internet Gateway
  - Web Proxies
  range: last 90 days
  queries:
  - search: pseudocode
    query: ON dns_query (domain IN nrd_list), CHECK for http_request from same source_ip
      in last 5s. IF http_referer IN ad_network_list, ALERT.
- question: Is there an anomalous increase in the number of unique hosts querying
    for newly registered domains?
  context: This question looks for enterprise-wide anomalies in DNS traffic to detect
    a large-scale malvertising campaign. A sudden spike in the number of distinct
    clients resolving NRDs, exceeding the historical baseline for that time of day,
    suggests a widespread event that should be investigated, even without direct
    correlation to ad referers.
  answer_sources:
  - Zeek dns.log
  - Zeek http.log
  - Zeek conn.log
  - Internal DNS Resolvers
  - Internet Gateway
  - Web Proxies
  range: last 90 days
  queries:
  - search: pseudocode
    query: CALCULATE hourly_count(unique source_ips querying nrd_list). IF count
      > (mean + 3 * std_dev) of 30-day_baseline, ALERT.
- question: Can an unsupervised machine learning model detect anomalous patterns
    in DNS queries that might indicate malvertising activity?
  context: This question applies unsupervised learning to find unusual clusters or
    periods of DNS activity without relying on predefined rules. By analyzing features
    like the ratio of NRD queries, domain entropy, and TLD distribution in short
    time windows, an Isolation Forest or similar algorithm can identify novel or subtle
    attack patterns that might otherwise be missed.
  answer_sources:
  - Zeek dns.log
  - Zeek http.log
  - Zeek conn.log
  - Internal DNS Resolvers
  - Internet Gateway
  - Web Proxies
  range: last 90 days
  queries:
  - search: pseudocode
    query: INPUT 5-min_dns_features (nrd_ratio, entropy, tld_count) INTO isolation_forest_model.
      FLAG time_windows with high anomaly_score.