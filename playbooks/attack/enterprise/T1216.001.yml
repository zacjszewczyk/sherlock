name: 'T1216.001: PubPrn'
id: c5d1e8f0-5b7a-4c1d-9f3a-8e2b7c6d4a1b
description: This playbook investigates the malicious use of PubPrn.vbs for defense evasion, focusing on identifying suspicious script execution patterns. This includes detecting PubPrn.vbs launched with URLs pointing to malicious, newly registered, or high-entropy domains; the use of non-standard protocol handlers like http/https instead of ldap; the spawning of anomalous child processes such as command shells or other LOLBins; subsequent suspicious outbound network connections; and executions by non-administrative users or on non-print-server systems.
type: technique
related:
  - 'TA0005: Defense Evasion'
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is `pubprn.vbs` being executed with a URL that matches a known malicious indicator from threat intelligence?
    context: This question aims to identify the most direct evidence of malicious activity. Adversaries often use `pubprn.vbs` to download and execute payloads from servers they control. By comparing the URL used in the command line against a curated list of known malicious domains and IPs, analysts can quickly confirm if the execution is tied to a known threat campaign.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Endpoint devices (workstations and servers)
      - Enterprise DNS resolvers
      - Network egress points (e.g., firewalls, proxies)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process creation logs (EID 4688)
          WHERE process_name in ('cscript.exe', 'wscript.exe') AND command_line contains 'pubprn.vbs' AND command_line contains 'script:'
          EXTRACT URL from command_line
          JOIN URL's domain/IP with threat_intelligence_feed
          RETURN matching events
  - question: Is `pubprn.vbs` being used to contact a newly registered or algorithmically generated domain?
    context: Threat actors frequently use newly registered domains (NRDs) or domain generation algorithms (DGAs) to host malicious payloads, as these domains are less likely to be on static blocklists. Identifying executions that contact NRDs or high-entropy domains serves as a strong statistical indicator of suspicious activity, even without a direct threat intelligence match.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Endpoint devices (workstations and servers)
      - Enterprise DNS resolvers
      - Network egress points (e.g., firewalls, proxies)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process creation logs (EID 4688) for pubprn.vbs executions
          EXTRACT domain from URL in command_line
          FOR each domain:
            QUERY WHOIS data for registration_date
            CALCULATE domain entropy
            ALERT if registration_date < 60 days OR entropy > baseline_95th_percentile
  - question: Does the URL associated with a `pubprn.vbs` execution exhibit characteristics of a malicious URL based on a machine learning model?
    context: This question leverages machine learning to detect subtle malicious patterns in URLs that may not be caught by symbolic or simple statistical methods. By analyzing features like domain length, character distribution, and n-grams, a classification model can identify URLs that are structurally similar to known malicious ones, providing a probabilistic assessment of risk.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Endpoint devices (workstations and servers)
      - Enterprise DNS resolvers
      - Network egress points (e.g., firewalls, proxies)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON pubprn.vbs execution events:
            EXTRACT URL from command_line
            GENERATE features (length, TLD, char_frequency, n-grams) from URL
            INPUT features into malicious_url_classifier_model
            ALERT if model_score > 0.90
  - question: Is `pubprn.vbs` being executed with a non-LDAP protocol handler like 'http:' or 'https:'?
    context: The legitimate use of `pubprn.vbs` involves publishing a printer to Active Directory using the 'ldap:' protocol handler. The use of any other handler, particularly 'http:' or 'https:', is a high-fidelity indicator of abuse, as it signifies an attempt to fetch a remote script from a web server instead of interacting with a directory service.
    answer_sources:
      - Windows Event ID 4688
      - All enterprise workstations and servers, particularly legacy systems (Windows < 10) where this technique is viable.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process creation logs (EID 4688)
          WHERE process_name in ('cscript.exe', 'wscript.exe')
          AND command_line contains 'pubprn.vbs'
          AND (command_line contains 'script:http' OR command_line contains 'script:https')
          ALERT on any match
  - question: Are there any observed executions of `pubprn.vbs` using a protocol handler that deviates from the established baseline of 'ldap:'?
    context: This question applies a statistical lens to detect abuse. By establishing that the only legitimate protocol handler used with `pubprn.vbs` in the environment is 'ldap:', any deviation from this norm becomes a zero-frequency event. This makes it a statistically significant anomaly that is highly indicative of malicious intent.
    answer_sources:
      - Windows Event ID 4688
      - All enterprise workstations and servers, particularly legacy systems (Windows < 10) where this technique is viable.
    range: last 30 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process creation logs (EID 4688) for 'pubprn.vbs' executions over 30 days
          EXTRACT protocol_handler after 'script:'
          CALCULATE frequency of each handler
          ALERT if any handler is not 'ldap:'
  - question: Can a machine learning model classify `pubprn.vbs` command lines as malicious based on the presence of specific keywords?
    context: This question explores using a simple classifier to automate the detection of malicious `pubprn.vbs` usage. By training a model on binary features representing the presence or absence of keywords like 'pubprn.vbs', 'script:', 'http:', and 'ldap:', the model can learn the simple rule that 'script:' without 'ldap:' is malicious, providing a fast and efficient real-time detection capability.
    answer_sources:
      - Windows Event ID 4688
      - All enterprise workstations and servers, particularly legacy systems (Windows < 10) where this technique is viable.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON process creation events:
            EXTRACT command_line
            GENERATE binary features for keywords ('pubprn.vbs', 'script:', 'http:', 'ldap:')
            INPUT features to command_line_classifier
            ALERT if classification is 'malicious'
  - question: Did a `cscript.exe` process executing `pubprn.vbs` spawn a known LOLBin or command shell?
    context: After `pubprn.vbs` executes a remote script, the next step is often to launch another tool to continue the attack chain. This question looks for this follow-on activity by checking if the `cscript.exe` process that ran `pubprn.vbs` spawns suspicious child processes like `powershell.exe`, `cmd.exe`, or `rundll32.exe`. This is a strong indicator that the initial execution was malicious.
    answer_sources:
      - Windows Event ID 4688
      - All enterprise workstations and servers with process relationship logging enabled.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process creation logs (EID 4688) for parent-child relationships
          WHERE parent_process_name is 'cscript.exe' AND parent_command_line contains 'pubprn.vbs'
          AND child_process_name is in watchlist ('powershell.exe', 'cmd.exe', 'rundll32.exe', 'regsvr32.exe', 'certutil.exe', 'mshta.exe')
          ALERT on match
  - question: Is the child process spawned by a `pubprn.vbs` execution a statistically rare event in the environment?
    context: This question aims to find malicious activity by identifying unusual process behaviors. Legitimate software tends to have predictable process relationships. By baselining all parent-child process pairs, an analyst can spot when a `cscript.exe` process running `pubprn.vbs` spawns a child process that has rarely or never been seen before, flagging it as a potential anomaly worth investigating.
    answer_sources:
      - Windows Event ID 4688
      - All enterprise workstations and servers with process relationship logging enabled.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN baseline of all parent-child process pair frequencies over 90 days
          ON a 'cscript.exe' ('pubprn.vbs') -> child_process event:
            CALCULATE the pair's historical frequency
            ALERT if frequency is below a rarity threshold (e.g., < 1st percentile or seen on < 3 hosts)
  - question: Is the process execution chain initiated by `pubprn.vbs` considered improbable or anomalous by a machine learning model?
    context: This question models process activity as sequences of events to detect sophisticated attacks. By treating process names as 'words' in a sentence, an n-gram model can learn the probability of certain sequences. A malicious sequence, like `cscript.exe` (running `pubprn.vbs`) followed by `powershell.exe`, would likely have a very low probability compared to benign sequences, allowing the model to flag it as anomalous.
    answer_sources:
      - Windows Event ID 4688
      - All enterprise workstations and servers with process relationship logging enabled.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL process execution sequences using n-gram analysis to establish probabilities
          ON a new sequence starting with 'cscript.exe' ('pubprn.vbs'):
            CALCULATE its probability
            ALERT if probability is below a learned threshold
  - question: Following a `pubprn.vbs` execution, did the `cscript.exe` process make a network connection to a known malicious IP or domain?
    context: This question connects endpoint process activity with network logs to confirm malicious communication. An adversary using `pubprn.vbs` will cause the `cscript.exe` process to connect to a command-and-control (C2) server. By correlating the process execution with outbound network connections and checking the destination against threat intelligence, analysts can verify that the process is communicating with a known malicious entity.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Endpoint devices (workstations and servers)
      - Network egress points (e.g., firewalls, proxies)
      - Network TAPs/SPANs generating Zeek data.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH for 'cscript.exe' ('pubprn.vbs') process events (EID 4688)
          WITHIN 2 minutes of event, SEARCH network logs (Zeek conn.log) for connections from the same source_ip
          JOIN destination_ip/domain with threat_intelligence_feed
          ALERT on match
  - question: Did the network connection following a `pubprn.vbs` execution involve a statistically anomalous destination port, country, or file download size?
    context: This question seeks to identify suspicious network behavior by baselining normal activity for the `cscript.exe` process. Malicious C2 communication or payload downloads may occur over unusual ports, to servers in atypical geographic locations, or involve unexpectedly large files. Alerting on deviations from the established baseline for a host can uncover malicious activity without prior knowledge of the destination's reputation.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Endpoint devices (workstations and servers)
      - Network egress points (e.g., firewalls, proxies)
      - Network TAPs/SPANs generating Zeek data.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          AFTER a 'pubprn.vbs' execution, monitor the associated network connection
          COMPARE destination_port, destination_country, and downloaded_file_size against historical baselines for the host/process
          ALERT if any value is statistically rare (e.g., > 95th percentile)
  - question: Was there an anomalous spike in outbound network traffic from a host shortly after a `pubprn.vbs` execution?
    context: This question uses time-series analysis to detect data exfiltration or large payload downloads. A sudden, unexpected spike in a host's outbound network traffic volume that is temporally correlated with a `pubprn.vbs` execution is highly suspicious. A time-series anomaly detection model can automatically identify such spikes against the host's normal traffic patterns, signaling a potential malicious event.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Endpoint devices (workstations and servers)
      - Network egress points (e.g., firewalls, proxies)
      - Network TAPs/SPANs generating Zeek data.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          APPLY time-series anomaly detection model to host's outbound traffic (bytes_out from Zeek conn.log)
          CORRELATE process creation events (EID 4688) for 'pubprn.vbs'
          ALERT if an anomalous traffic spike occurs within 2 minutes after the process execution
  - question: Was `pubprn.vbs` executed by an unauthorized user or on a system not designated as a print server?
    context: This question focuses on policy and role-based access control to identify abuse. The legitimate use of `pubprn.vbs` is typically restricted to printer administrators and performed on print servers. Any execution that violates this policy—such as by a standard user on a regular workstation—is a strong indication of misuse or compromise.
    answer_sources:
      - Windows Event ID 4688
      - Active Directory security logs
      - All enterprise workstations and servers
      - Domain Controllers
      - Identity and Access Management (IAM) systems
      - Asset Inventory Database.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON 'pubprn.vbs' execution (EID 4688):
            GET user and hostname
            CHECK if user is in 'Printer Administrators' AD group
            CHECK if hostname is in 'Print Servers' asset list
            ALERT if either check fails
  - question: Is the frequency of `pubprn.vbs` execution by a specific user or on a host statistically unusual?
    context: This question uses frequency analysis to detect anomalous behavior. Even if a user is authorized, a sudden burst of `pubprn.vbs` executions could indicate a compromised account or a malicious script running in a loop. By baselining the normal execution frequency for each user and host, analysts can detect significant deviations (e.g., exceeding 3 standard deviations) or first-time executions, which warrant investigation.
    answer_sources:
      - Windows Event ID 4688
      - Active Directory security logs
      - All enterprise workstations and servers
      - Domain Controllers
      - Identity and Access Management (IAM) systems
      - Asset Inventory Database.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN 90-day rolling baseline of 'pubprn.vbs' execution counts per user and per host
          ON new execution:
            COMPARE count to user/host baseline
            ALERT if count > (mean + 3 * stdev) OR if baseline count is zero
  - question: Does a `pubprn.vbs` execution fall outside the cluster of normal administrative activity as determined by a machine learning model?
    context: This question uses unsupervised machine learning to define 'normal' behavior based on multiple features simultaneously. By clustering executions based on user role, host type, time of day, and parent process, a model can identify the typical pattern of legitimate printer administration. Any `pubprn.vbs` execution that does not fit into this dense cluster is flagged as an outlier, representing a deviation from normalcy that requires analyst review.
    answer_sources:
      - Windows Event ID 4688
      - Active Directory security logs
      - All enterprise workstations and servers
      - Domain Controllers
      - Identity and Access Management (IAM) systems
      - Asset Inventory Database.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CLUSTER historical process execution events using features (user_role, host_role, time_of_day, parent_process)
          APPLY model to new 'pubprn.vbs' executions
          ALERT if an execution is classified as an outlier or noise by the clustering algorithm (e.g., DBSCAN)