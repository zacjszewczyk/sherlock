name: T1584.008: Network Devices
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps investigate whether adversaries are compromising and using third-party network devices for their operations, as part of the resource development phase. It focuses on detecting communications with known compromised infrastructure like routers and proxies, identifying traffic patterns indicative of malware-infected devices (e.g., specific JA3/S hashes, beaconing to residential ISPs), uncovering scanning activity from suspicious external IPs, and spotting traffic funneling or proxying behavior where DNS and HTTP/TLS destinations do not align.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are we ingesting and appropriately tagging threat intelligence feeds for compromised network devices, botnet C2s, and anonymous proxies?
    context: This question verifies that the foundational data required for detection is available. Without properly ingested and categorized threat intelligence, rules designed to detect communication with known malicious infrastructure will fail.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH threat_intelligence_platform FOR feeds related to ('compromised router', 'botnet C2', 'anonymous proxy')
  - question: Are alerts being triggered when internal hosts communicate with external IPs listed in our threat intelligence feeds for compromised network devices?
    context: This question checks for direct communication with known malicious endpoints. A successful match is a strong indicator of compromise or an attempt to leverage compromised infrastructure.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN network_flow_logs ON destination_ip WITH threat_intelligence_list ON ip_address WHERE source_ip is internal
  - question: Are alerts for connections to known malicious IPs being enriched with data volume and duration percentiles to assess their anomaly level?
    context: This question aims to prioritize alerts by identifying outlier behavior. A connection to a malicious IP that also involves an unusually large data transfer or long duration is more suspicious and warrants faster investigation.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each alert, CALCULATE percentile_rank(connection_bytes, connection_duration) against 30-day baseline for internal_host
  - question: Is there an anomalous spike in traffic volume to any specific category of compromised infrastructure (e.g., botnets, proxies)?
    context: This question moves beyond individual connections to look for broader trends. A sudden, unexpected increase in traffic to a category like 'botnet C2' could indicate a widespread infection or a coordinated campaign.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FORECAST traffic_volume by threat_category; ALERT if actual_volume > 99% confidence_interval_upper_bound
  - question: Are we detecting outbound connections that use JA3/JA3S hashes, TLS SNIs, or User-Agents known to be associated with network device malware?
    context: This question focuses on identifying specific malware families by their network fingerprints. Matching these low-prevalence indicators provides high-fidelity evidence of a specific type of infection.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Zeek files.log
      - Windows Event ID 4688
      - Internet Gateway
      - DNS Resolvers
      - Endpoint EDR Logs
      - Web Proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH outbound_traffic_logs (ssl, http) FOR JA3S_hash, SNI, UserAgent IN known_malicious_indicator_list
  - question: Have any internal hosts exhibited an unusual drop in the diversity (entropy) of their JA3S hashes or User-Agent strings, suggesting a shift to single-malware communication?
    context: This question seeks to identify hosts that have become monoliths in their communication patterns. A sudden drop in entropy can indicate that a single malicious process with a fixed signature is dominating the host's outbound traffic.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Zeek files.log
      - Windows Event ID 4688
      - Internet Gateway
      - DNS Resolvers
      - Endpoint EDR Logs
      - Web Proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host, CALCULATE entropy(JA3S_hashes, User_Agents) over 24h; ALERT if entropy < 5th_percentile_of_baseline
  - question: Has our machine learning model flagged any outbound connections with a high maliciousness score based on their network characteristics?
    context: This question leverages a machine learning model to find connections that are suspicious based on a combination of features, even if no single feature is a definitive indicator. It helps find novel or unknown threats that don't match static IOCs.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Zeek files.log
      - Windows Event ID 4688
      - Internet Gateway
      - DNS Resolvers
      - Endpoint EDR Logs
      - Web Proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH model_predictions FOR connection_score > 0.9; RETURN connection_details and top_features
  - question: Are any internal hosts maintaining long-running connections to IPs in residential ISP networks on non-standard ports?
    context: This question targets a common C2 pattern where compromised devices connect to other compromised home or mobile devices. Long durations on unusual ports are highly indicative of malicious tunneling or C2 channels, as legitimate traffic to residential IPs is typically brief and on standard ports.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - VPN Concentrators
      - Core Switches
      - Egress points of the network
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH network_flows WHERE destination_asn_type = 'residential' AND port NOT IN (80, 443) AND cumulative_duration > 1_hour IN 24_hours
  - question: Are any internal hosts beaconing to a residential IP, characterized by highly regular time intervals and consistent data transfer sizes?
    context: This question looks for the classic 'heartbeat' of malware. Automated C2 communication is often highly periodic and uniform, resulting in very low standard deviation in timing and data size, unlike human-generated traffic.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - VPN Concentrators
      - Core Switches
      - Egress points of the network
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each connection_pair to residential_ASN, CALCULATE stdev(time_delta), stdev(bytes); ALERT if stdev(time) < 2s AND stdev(bytes) < 10
  - question: Has an anomaly detection model identified any internal hosts exhibiting unusual connection patterns to residential ASNs, such as a sudden shift to periodic beaconing?
    context: This question uses machine learning to find deviations from a host's normal behavior when communicating with residential networks. It can catch beaconing or other C2 activity without relying on fixed thresholds, by learning what is 'normal' for each host.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - VPN Concentrators
      - Core Switches
      - Egress points of the network
    range: last 90 days
    queries:
      - technology: pseudocode
        query: RUN isolation_forest on time_series_features(connection_frequency, duration, bytes) for residential_ASN_traffic; ALERT on anomalous clusters
  - question: Has an external IP address been identified as scanning the network and subsequently attempting to use a known exploit?
    context: This question correlates reconnaissance activity (scanning) with exploitation attempts. An IP that first scans for open ports and then immediately tries to exploit a vulnerability is a clear and high-confidence indicator of a targeted attack.
    answer_sources:
      - Zeek conn.log
      - Zeek scan.log
      - Zeek http.log
      - Zeek notice.log
      - DMZ
      - Internet-facing Web Servers
      - External Firewall
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for external_ip in scan_logs; CORRELATE same external_ip in exploit_attempt_logs within 15 minutes
  - question: Has any single external IP address attempted to connect to an anomalously high number of internal hosts or ports in a short time frame?
    context: This question identifies network scanning behavior. A single external IP connecting to hundreds of different internal IPs or ports in a few minutes is not normal traffic and is almost certainly a reconnaissance scan.
    answer_sources:
      - Zeek conn.log
      - Zeek scan.log
      - Zeek http.log
      - Zeek notice.log
      - DMZ
      - Internet-facing Web Servers
      - External Firewall
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each external_ip, COUNT distinct(internal_ip), distinct(destination_port) in 5_min_window; ALERT if counts > 99.9th_percentile
  - question: Has a clustering algorithm identified a dense group of connections originating from a single external IP to many internal destinations, indicative of scanning?
    context: This question uses a machine learning approach (DBSCAN) to automatically identify scanning activity as a 'dense cluster' in the data, without needing to pre-define thresholds. It's an effective way to find 'one-to-many' (scanner) and 'many-to-one' (DDoS) relationships.
    answer_sources:
      - Zeek conn.log
      - Zeek scan.log
      - Zeek http.log
      - Zeek notice.log
      - DMZ
      - Internet-facing Web Servers
      - External Firewall
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: RUN DBSCAN on stream of (source_ip, dest_ip, dest_port); ALERT on dense clusters with a single source_ip
  - question: Are there instances where an internal host resolves a domain but then connects to a different IP address, particularly one in a residential ASN?
    context: This question seeks to uncover domain fronting or traffic proxying. A mismatch between the IP resolved via DNS and the IP actually connected to suggests that the connection is being redirected, possibly through a compromised device acting as a proxy.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek http.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Endpoint Network Logs
      - Core Network Taps
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN DNS_logs on domain WITH Connection_logs on SNI/Host_header; ALERT if DNS_resolved_IP != connection_destination_IP AND destination_IP_ASN = 'residential'
  - question: Have any internal hosts shown a significant drop in their 'Traffic Funneling Ratio', indicating many resolved domains are leading to very few destination IPs?
    context: This question quantifies the proxying behavior. A host that normally connects to 100 different IPs for 100 different domains (ratio ~1.0) but suddenly connects to only 2 IPs for 100 domains (ratio 0.02) is likely having its traffic funneled through a proxy or C2 infrastructure.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek http.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Endpoint Network Logs
      - Core Network Taps
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host, CALCULATE ratio = count(distinct_dest_ips) / count(distinct_fqdns); ALERT if ratio < 5th_percentile_of_baseline
  - question: Has graph analysis revealed a community of internal hosts and FQDNs whose traffic is being funneled through an anomalous external hub IP?
    context: This question uses advanced graph analytics to visualize and detect traffic funneling at a larger scale. It can identify campaigns where multiple compromised internal hosts are all being routed through the same small set of external proxy nodes.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek http.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Endpoint Network Logs
      - Core Network Taps
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BUILD graph of (internal_hosts, FQDNs); RUN community_detection; FOR each community, CHECK for concentration of destination_IPs on a few hubs