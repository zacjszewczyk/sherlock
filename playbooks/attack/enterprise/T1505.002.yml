name: T1505.002: Transport Agent
id: f4a8e2b1-c6d9-4b8f-9e7a-1b3c5d7e9a0f
description: This playbook helps determine if an adversary is maintaining persistence through a malicious Microsoft Exchange Transport Agent. It focuses on detecting the installation of new agents via new DLLs in specific directories, the use of installation cmdlets, or direct registry modifications. It also investigates anomalous behavior stemming from a compromised agent, such as the `edgetransport.exe` process writing suspicious files, making unusual outbound network connections for C2 or exfiltration, or causing measurable disruptions in normal email flow metrics like sudden drops in received mail or increases in outbound mail with encrypted attachments.
type: technique
related:
  - TA0003: Persistence
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a new DLL been created in a Microsoft Exchange transport agent directory that matches a known malicious hash?
    context: Adversaries can install malicious DLLs as Exchange transport agents to intercept, modify, or exfiltrate email. This question aims to detect this persistence mechanism by monitoring transport agent directories for new DLLs and checking their hashes against threat intelligence feeds. A match indicates a high probability of a known threat.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - File systems of Microsoft Exchange Servers, specifically the transport agent directories (e.g., %ExchangeInstallPath%TransportRoles\agents\).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH file creation events (Sysmon EID 11) in Exchange transport agent directories. FOREACH new DLL, hash the file and CHECK against threat intelligence database. ALERT on match.
  - question: Has a statistically rare DLL been created in a Microsoft Exchange transport agent directory?
    context: Targeted or custom malware may not have a known hash in threat intelligence databases. By calculating the prevalence of each new DLL's hash across the enterprise, we can identify files that are unique or exist on very few hosts. Such rarity is a strong indicator of a potential custom tool or targeted implant that warrants manual investigation.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - File systems of Microsoft Exchange Servers, specifically the transport agent directories (e.g., %ExchangeInstallPath%TransportRoles\agents\).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH file creation events (Sysmon EID 11) in Exchange transport agent directories. FOREACH new DLL, hash the file and CALCULATE prevalence across all enterprise hosts over 30 days. ALERT if count is below a rarity threshold (e.g., < 2).
  - question: Has a newly created DLL in a Microsoft Exchange transport agent directory been classified as malicious by a machine learning model?
    context: To detect novel or zero-day malware, static analysis using machine learning can be effective. This question leverages a model that analyzes Portable Executable (PE) file characteristics (like imports, sections, and entropy) to predict maliciousness. An alert based on a high-confidence score can uncover threats that signature-based methods would miss.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - File systems of Microsoft Exchange Servers, specifically the transport agent directories (e.g., %ExchangeInstallPath%TransportRoles\agents\).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON file creation event (Sysmon EID 11) in Exchange transport agent directories, ANALYZE the new DLL with a PE classification ML model. ALERT if malicious confidence score > 0.90.
  - question: Has the 'Install-TransportAgent' cmdlet been executed or has the corresponding registry path been modified?
    context: The most direct way to install a transport agent is by using the `Install-TransportAgent` PowerShell cmdlet, which in turn modifies specific registry keys. Monitoring for the execution of this cmdlet or direct modification of the transport agent registry configuration (`HKLM\SOFTWARE\Microsoft\ExchangeServer\v15\TransportRoles\agents\`) provides a high-fidelity signal for a new agent being registered.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 13
      - Windows Event ID 4657
      - Microsoft Exchange Servers (Command-line interface, PowerShell script block logs, and Windows Registry); Domain Controller Security Logs.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for "Install-TransportAgent" in PowerShell logs (EID 4104) or process logs (EID 4688). ALSO, MONITOR for registry key creation/modification (Sysmon EID 13) under 'HKLM\...\TransportRoles\agents\'. ALERT on any event.
  - question: Was a transport agent installed using a highly randomized name or assembly path?
    context: Adversaries often use randomization or obfuscation in command-line parameters to evade simple signature-based detections. By calculating the Shannon entropy of the agent name and assembly path strings used with `Install-TransportAgent`, we can identify unusually complex or random-looking values. High entropy can indicate an attempt to hide the agent's true purpose.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft Exchange Servers (Command-line interface, PowerShell script block logs, and Windows Registry); Domain Controller Security Logs.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON "Install-TransportAgent" execution event, EXTRACT -AssemblyPath and -Name parameters. CALCULATE Shannon entropy for both strings. ALERT if entropy > 4.0.
  - question: Does the installation of a new transport agent have a high risk score based on its execution context?
    context: Not all transport agent installations are malicious. This question uses a risk-based approach, employing a model to score each installation event. The model considers contextual features like the parent process, the user account, the time of day, and the file path location. A high risk score suggests the installation is anomalous and likely malicious, allowing analysts to focus on the most suspicious events.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft Exchange Servers (Command-line interface, PowerShell script block logs, and Windows Registry); Domain Controller Security Logs.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON "Install-TransportAgent" execution event, GATHER features (parent process, user, time, path entropy). INPUT into logistic regression model. ALERT if risk score > 0.85.
  - question: Has the `edgetransport.exe` process written a high-risk file to a non-standard directory?
    context: A compromised transport agent running within the `edgetransport.exe` process might be used to drop other malicious payloads or stage exfiltrated data. This question seeks to detect such activity by monitoring for file writes from `edgetransport.exe` to unexpected locations (like C:\Temp or user profiles) or involving high-risk file types (like .exe, .ps1, .zip), which is highly indicative of malicious behavior.
    answer_sources:
      - Sysmon Event ID 11
      - File systems on Microsoft Exchange Servers, focusing on non-standard temporary directories (C:\Temp, C:\Windows\Temp), user profile directories, and internet-accessible web server directories.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for file creation events (Sysmon EID 11) WHERE process is "edgetransport.exe" AND (target path is NOT in allow-list OR target extension IS in block-list). ALERT on match.
  - question: Has the `edgetransport.exe` process written a file to an unusual path or with an uncommon extension?
    context: Rather than relying on static allow/block lists, this question uses behavioral analysis. By baselining the normal file write activities of `edgetransport.exe`, we can detect deviations. A write event involving a path/extension pair that is statistically rare (e.g., in the bottom 1st percentile of observed activity) is flagged as an anomaly, potentially revealing a novel malicious action.
    answer_sources:
      - Sysmon Event ID 11
      - File systems on Microsoft Exchange Servers, focusing on non-standard temporary directories (C:\Temp, C:\Windows\Temp), user profile directories, and internet-accessible web server directories.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR EACH file write by "edgetransport.exe", CREATE a tuple of (path, extension). BASELINE frequency of all tuples over 30 days. ALERT if a new tuple's frequency is in the bottom 1st percentile.
  - question: Has an anomalous file write event by `edgetransport.exe` been detected by an unsupervised machine learning model?
    context: This question applies an unsupervised anomaly detection model, like Isolation Forest, to identify outlier file write events that don't conform to established patterns. The model considers multiple features simultaneously (path depth, filename entropy, time of day, etc.) to find complex deviations that might be missed by single-variable statistical methods, providing a more robust way to detect novel malicious behavior.
    answer_sources:
      - Sysmon Event ID 11
      - File systems on Microsoft Exchange Servers, focusing on non-standard temporary directories (C:\Temp, C:\Windows\Temp), user profile directories, and internet-accessible web server directories.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON EACH file write by "edgetransport.exe", EXTRACT features (path depth, filename entropy, time). INPUT into Isolation Forest model. ALERT if anomaly score exceeds threshold.
  - question: Has an Exchange transport process connected to a known malicious IP address or domain?
    context: A malicious transport agent may establish a command-and-control (C2) channel or exfiltrate data. This question aims to detect this by comparing destination IPs and domains from `edgetransport.exe` network connections against threat intelligence feeds. A match is a high-confidence indicator of compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Sysmon Event ID 3
      - Network egress points (e.g., firewalls, proxies) monitoring traffic from the Exchange server DMZ; Network sensor logs on Microsoft Exchange Servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH network connections (Sysmon EID 3, Zeek conn.log) from "edgetransport.exe". CHECK destination IP/domain against threat intelligence feeds. ALERT on match.
  - question: Has an Exchange transport process made an outbound connection with anomalous characteristics (e.g., port, data volume, duration)?
    context: C2 traffic can often be distinguished from benign traffic by its characteristics. This question involves baselining normal outbound connections from `edgetransport.exe` and looking for statistical outliers. A connection to an unusual port, with an abnormally large amount of data sent, or an unusually long duration could indicate malicious activity that doesn't match known indicators.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Sysmon Event ID 3
      - Network egress points (e.g., firewalls, proxies) monitoring traffic from the Exchange server DMZ; Network sensor logs on Microsoft Exchange Servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE outbound connections from "edgetransport.exe" by destination port, tracking mean/std dev of bytes sent and duration. ALERT if new connection's value > mean + 3 * std dev.
  - question: Has an anomalous outbound network connection from an Exchange transport process been identified as an outlier by a clustering model?
    context: This question uses unsupervised machine learning (DBSCAN) to group similar network connections into clusters of normal behavior. Connections that do not fit into any cluster (identified as noise) are flagged as anomalies. This approach can detect novel C2 channels by identifying traffic that is fundamentally different from the established norms across multiple dimensions (port, protocol, data volume, TLS fingerprint).
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Sysmon Event ID 3
      - Network egress points (e.g., firewalls, proxies) monitoring traffic from the Exchange server DMZ; Network sensor logs on Microsoft Exchange Servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CLUSTER "edgetransport.exe" network connections using DBSCAN on features (port, protocol, volume, JA3). ALERT on connections classified as noise/outliers.
  - question: Is an Exchange server sending outbound emails with encrypted attachments to unapproved domains?
    context: Adversaries may use malicious transport agents to exfiltrate data by intercepting emails, packaging sensitive information into encrypted archives (like .zip or .7z), and sending them to an external address. This question specifically looks for this pattern, as sending encrypted data to unknown or non-partner domains is highly suspicious.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Network traffic at the Mail Transfer Agent (MTA) layer; Network egress points capturing SMTP traffic.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek logs for outbound SMTP traffic where associated file magic indicates encrypted archive AND destination domain is NOT in approved partner list. ALERT on match.
  - question: Has a user sent an anomalous volume of outbound email or an attachment of an unusual type?
    context: A compromised account or a malicious transport agent could alter a user's normal email sending behavior. This question establishes a baseline of activity for each user, including their typical daily email volume and the types of attachments they send. A significant deviation, such as a sudden spike in outbound emails or the appearance of a novel attachment type, is flagged as a potential indicator of compromise.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Network traffic at the Mail Transfer Agent (MTA) layer; Network egress points capturing SMTP traffic.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR EACH user, BASELINE daily outbound email volume and attachment MIME types. ALERT if today's volume > 98th percentile OR a new MIME type is seen.
  - question: Has there been a statistically significant and anomalous drop in the inbound email rate for a high-value mailbox?
    context: A sophisticated transport agent might be configured to intercept and delete or redirect incoming emails to prevent a target from receiving specific information (e.g., security warnings, password resets). This question applies time series analysis to monitor the inbound email flow for critical mailboxes. A sudden, unexplained drop flagged by the model could indicate that an agent is tampering with mail delivery.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Network traffic at the Mail Transfer Agent (MTA) layer; Network egress points capturing SMTP traffic.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR hourly inbound email count for high-value mailboxes using a time series anomaly detection model. ALERT if a statistically significant trough/drop is detected.