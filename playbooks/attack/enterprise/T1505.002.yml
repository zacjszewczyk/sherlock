name: 'T1505.002: Transport Agent'
id: 'f47ac10b-58cc-4372-a567-0e02b2c3d479'
description: This playbook helps investigate whether an adversary is maintaining persistence through a malicious Microsoft Exchange Transport Agent. It focuses on detecting the installation and execution of malicious agents by monitoring for new DLLs in transport agent directories, the use of the 'Install-TransportAgent' cmdlet, and associated registry modifications. The playbook also covers behavioral anomalies, such as the 'edgetransport.exe' process writing suspicious files to non-standard locations, making anomalous outbound network connections to potential C2 servers, and causing measurable disruptions in email flow, like message interception or data exfiltration via attachments.
type: technique
related:
- 'TA0003: Persistence'
contributors:
- Zachary Szewczyk
- Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
- question: Has a new DLL been created in a Microsoft Exchange transport agent directory that matches a known malicious hash?
  context: This question seeks to identify the most direct evidence of a malicious transport agent: a known-bad DLL file. Adversaries may drop pre-compiled malicious agents onto the file system. By monitoring file creation events (Sysmon Event ID 11) in specific Exchange directories and checking the file's hash against threat intelligence feeds, analysts can quickly detect known threats.
  answer_sources:
  - Windows Event ID 4663
  - Sysmon Event ID 11
  - 'File systems of Microsoft Exchange Servers, specifically the transport agent directories (e.g., %ExchangeInstallPath%TransportRoles\agents\).'
  range: last 90 days
  queries:
  - 'SEARCH file creation events (Sysmon 11) in Exchange agent directories. FOR EACH new DLL, HASH file. QUERY hash against threat intel. ALERT on match.'
- question: Is there a new DLL in an Exchange transport agent directory that is statistically rare within the enterprise?
  context: This question addresses the use of custom or targeted malware that won't have a known signature. By calculating the prevalence of file hashes across all systems, a DLL appearing on only one or a very small number of Exchange servers becomes highly suspicious. This technique helps uncover novel or targeted malicious agents that would otherwise be missed by signature-based detection.
  answer_sources:
  - Windows Event ID 4663
  - Sysmon Event ID 11
  - 'File systems of Microsoft Exchange Servers, specifically the transport agent directories (e.g., %ExchangeInstallPath%TransportRoles\agents\).'
  range: last 90 days
  queries:
  - 'SEARCH file creation events (Sysmon 11) in Exchange agent directories. FOR EACH new DLL, HASH file. COUNT prevalence of hash across enterprise over 30 days. ALERT if count is below threshold (e.g., 1).'
- question: Has a newly created DLL in an Exchange transport agent directory been classified as malicious by a machine learning model?
  context: This question leverages machine learning to detect novel malware based on its static properties, even without a known hash. By analyzing the structure of new DLLs (e.g., PE headers, imported functions, entropy), a model can identify characteristics common to malware. This provides a proactive detection capability against zero-day threats that don't match any existing intelligence.
  answer_sources:
  - Windows Event ID 4663
  - Sysmon Event ID 11
  - 'File systems of Microsoft Exchange Servers, specifically the transport agent directories (e.g., %ExchangeInstallPath%TransportRoles\agents\).'
  range: last 90 days
  queries:
  - 'SEARCH file creation events (Sysmon 11) in Exchange agent directories. FOR EACH new DLL, ANALYZE with PE file ML model. ALERT if malicious score > 0.90.'
- question: Has the 'Install-TransportAgent' cmdlet been executed or have the corresponding transport agent registry keys been modified?
  context: This question focuses on the explicit registration of a new transport agent. The execution of 'Install-TransportAgent' via PowerShell or command line, or direct manipulation of the registry at `HKLM\SOFTWARE\Microsoft\ExchangeServer\v15\TransportRoles\agents\`, are definitive actions for installing an agent. Alerting on these activities provides a clear signal of a potential persistence attempt.
  answer_sources:
  - Windows Event ID 4104
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Sysmon Event ID 13
  - Windows Event ID 4657
  - 'Microsoft Exchange Servers (Command-line interface, PowerShell script block logs, and Windows Registry); Domain Controller Security Logs.'
  range: last 90 days
  queries:
  - 'SEARCH PowerShell logs (EID 4104) or process logs (EID 4688) for ''Install-TransportAgent''. SEARCH registry events (Sysmon 13) for modifications under `HKLM\...\agents\`. ALERT on any finding.'
- question: Was an 'Install-TransportAgent' command executed with highly randomized name or path parameters?
  context: This question aims to detect evasion techniques. Adversaries often use randomized strings for agent names and file paths to avoid simple signature-based detections. By calculating the Shannon entropy of these parameters, we can identify commands that use an unusually high degree of randomness ($$ H(X) > 4.0 $$), which is a strong indicator of malicious and evasive activity.
  answer_sources:
  - Windows Event ID 4104
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Sysmon Event ID 13
  - Windows Event ID 4657
  - 'Microsoft Exchange Servers (Command-line interface, PowerShell script block logs, and Windows Registry); Domain Controller Security Logs.'
  range: last 90 days
  queries:
  - 'SEARCH PowerShell logs (EID 4104) for ''Install-TransportAgent''. FOR EACH event, CALCULATE entropy of -AssemblyPath and -Name values. ALERT if entropy > 4.0.'
- question: Has an 'Install-TransportAgent' execution received a high risk score from a behavioral model?
  context: This question uses a machine learning model to assess the overall risk of an agent installation by considering its full context. Factors like the parent process, the user account, the time of day, and the directory path are combined to produce a risk score. An installation by a non-standard user or process outside of business hours would be flagged, providing a more nuanced detection than a simple string match.
  answer_sources:
  - Windows Event ID 4104
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Sysmon Event ID 13
  - Windows Event ID 4657
  - 'Microsoft Exchange Servers (Command-line interface, PowerShell script block logs, and Windows Registry); Domain Controller Security Logs.'
  range: last 90 days
  queries:
  - 'SEARCH ''Install-TransportAgent'' events. FOR EACH event, SCORE with logistic regression model based on user, parent process, time, path, etc. ALERT if score > 0.85.'
- question: Has the 'edgetransport.exe' process written a high-risk file (e.g., .exe, .ps1) to a non-standard directory?
  context: This question looks for secondary actions taken by a compromised transport agent, such as dropping payloads or staging data. The 'edgetransport.exe' process should normally only write to specific Exchange-related directories. Any file creation activity outside of an allow-list, especially involving executable or script files, is highly suspicious and could indicate that the agent is being used to further an attack.
  answer_sources:
  - Sysmon Event ID 11
  - 'File systems on Microsoft Exchange Servers, focusing on non-standard temporary directories (C:\Temp, C:\Windows\Temp), user profile directories, and internet-accessible web server directories.'
  range: last 90 days
  queries:
  - 'SEARCH file creation events (Sysmon 11) where process is ''edgetransport.exe''. ALERT if file extension is on block-list (e.g., .exe, .ps1) OR if file path is outside allow-list.'
- question: Has 'edgetransport.exe' written a file to a location or with an extension that is statistically rare based on historical behavior?
  context: This question identifies anomalous file write activity by comparing it to a learned baseline of normal behavior. By baselining the typical file paths and extensions associated with 'edgetransport.exe', we can detect outliers. An event falling into a low-frequency percentile suggests a deviation from the norm and could represent a malicious action that doesn't involve a known bad file type.
  answer_sources:
  - Sysmon Event ID 11
  - 'File systems on Microsoft Exchange Servers, focusing on non-standard temporary directories (C:\Temp, C:\Windows\Temp), user profile directories, and internet-accessible web server directories.'
  range: last 90 days
  queries:
  - 'SEARCH file creation events (Sysmon 11) from ''edgetransport.exe''. COMPARE (path, extension) pair against historical 30-day baseline. ALERT if pair is in a low-frequency percentile (e.g., bottom 1%).'
- question: Has 'edgetransport.exe' performed a file write operation that has been flagged as an anomaly by an unsupervised machine learning model?
  context: This question uses unsupervised learning (Isolation Forest) to detect novel, anomalous file write events without a pre-defined baseline. The model considers multiple features simultaneously (path depth, filename entropy, time of day) to identify outliers. This is effective at catching sophisticated attackers who attempt to blend in by avoiding simple, single-feature detection rules.
  answer_sources:
  - Sysmon Event ID 11
  - 'File systems on Microsoft Exchange Servers, focusing on non-standard temporary directories (C:\Temp, C:\Windows\Temp), user profile directories, and internet-accessible web server directories.'
  range: last 90 days
  queries:
  - 'INGEST ''edgetransport.exe'' file creation events into Isolation Forest model. FEATURES include path depth, filename entropy, extension, time. ALERT on events with high anomaly scores.'
- question: Has the 'edgetransport.exe' process initiated a network connection to a destination IP or domain on a threat intelligence feed?
  context: This question seeks to identify communication with known command-and-control (C2) infrastructure. A malicious transport agent may be used to exfiltrate data or receive commands. By checking the destination IPs and domains from network connections made by 'edgetransport.exe' against threat intelligence, analysts can directly link the activity to a known threat actor or malware family.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Sysmon Event ID 3
  - 'Network egress points (e.g., firewalls, proxies) monitoring traffic from the Exchange server DMZ; Network sensor logs on Microsoft Exchange Servers.'
  range: last 90 days
  queries:
  - 'SEARCH network connections (Sysmon 3, Zeek) from ''edgetransport.exe''. QUERY destination IP/domain against threat intel. ALERT on match.'
- question: Did an outbound connection from 'edgetransport.exe' exhibit anomalous characteristics in data volume or duration compared to a statistical baseline?
  context: 'This question aims to detect C2 communication or data exfiltration by looking for statistical outliers in network traffic. By establishing a baseline for normal connection metrics (like bytes sent and duration) per destination port, any significant deviation (e.g., $$ value > \mu + 3\sigma $$) can indicate abnormal behavior. For instance, a large data transfer over a port normally used for brief communications would be highly suspicious.'
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Sysmon Event ID 3
  - 'Network egress points (e.g., firewalls, proxies) monitoring traffic from the Exchange server DMZ; Network sensor logs on Microsoft Exchange Servers.'
  range: last 90 days
  queries:
  - 'FOR EACH destination port, BASELINE mean/std dev of bytes sent and duration for ''edgetransport.exe'' connections. ALERT if new connection exceeds threshold (e.g., mean + 3 * std dev).'
- question: Did a network connection from 'edgetransport.exe' get classified as a noise point or a rare cluster by a clustering algorithm?
  context: This question uses unsupervised clustering (DBSCAN) to find novel C2 channels that don't fit established patterns. The model groups connections based on multiple features like port, protocol, and JA3/JA3s hashes. Connections that don't belong to any large, dense cluster of 'normal' activity are flagged as anomalies. This can uncover unique or previously unseen communication methods used by adversaries.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Sysmon Event ID 3
  - 'Network egress points (e.g., firewalls, proxies) monitoring traffic from the Exchange server DMZ; Network sensor logs on Microsoft Exchange Servers.'
  range: last 90 days
  queries:
  - 'CLUSTER ''edgetransport.exe'' network connections using DBSCAN. FEATURES include port, protocol, data volume, JA3 hash. ALERT on connections classified as noise or belonging to a small, sparse cluster.'
- question: Has an outbound email been sent containing an encrypted archive to a domain not on an approved partner list?
  context: This question targets a common data exfiltration technique where a malicious transport agent intercepts data and sends it out concealed in an encrypted attachment. By monitoring for outbound emails with encrypted archives (like .zip or .7z) going to untrusted domains, security teams can catch potential data theft attempts.
  answer_sources:
  - Zeek smtp.log
  - Zeek files.log
  - 'Network traffic at the Mail Transfer Agent (MTA) layer; Network egress points capturing SMTP traffic.'
  range: last 90 days
  queries:
  - 'SEARCH outbound email logs (Zeek). IF attachment is encrypted archive AND destination domain is NOT on allow-list, ALERT.'
- question: Has a user sent an unusually high volume of email or an attachment type they have never sent before?
  context: This question seeks to identify anomalous user email behavior that may be driven by a malicious transport agent. A sudden spike in a user's outbound email volume or the appearance of a novel attachment type (e.g., an archive file from a user who never sends them) can indicate that their account is being used to exfiltrate data. This relies on baselining individual user activity to spot deviations.
  answer_sources:
  - Zeek smtp.log
  - Zeek files.log
  - 'Network traffic at the Mail Transfer Agent (MTA) layer; Network egress points capturing SMTP traffic.'
  range: last 90 days
  queries:
  - 'FOR EACH user, BASELINE daily outbound email volume and attachment MIME types. ALERT if volume exceeds 98th percentile OR if a new, unseen MIME type is used.'
- question: Has a high-value mailbox experienced a statistically significant drop in its inbound email rate?
  context: This question addresses the possibility of a malicious agent intercepting and deleting incoming emails before they reach the user's inbox. By applying a time series anomaly detection model to the inbound mail flow of critical mailboxes, a sudden, unexpected drop in received emails can be flagged. This could indicate that an agent is silently redirecting or deleting messages as part of an attack, such as preventing a user from receiving security warnings.
  answer_sources:
  - Zeek smtp.log
  - Zeek files.log
  - 'Network traffic at the Mail Transfer Agent (MTA) layer; Network egress points capturing SMTP traffic.'
  range: last 90 days
  queries:
  - 'MONITOR inbound email count per hour for high-value mailboxes using a time series model (e.g., Seasonal-Hybrid ESD). ALERT if a statistically significant negative anomaly (trough) is detected.'