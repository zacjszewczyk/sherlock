name: "T1666: Modify Cloud Resource Hierarchy"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps investigate whether an adversary is attempting to evade defenses by modifying the cloud resource hierarchy. It focuses on detecting the use of offensive cloud security tools linked to C2 traffic, unauthorized execution of sensitive hierarchy modification commands, suspicious activity from unusual geolocations, sequences of credential access followed by API calls, and the co-occurrence of hierarchy changes with defense evasion techniques like disabling security services or clearing logs."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a known offensive cloud security tool being executed on a host that is also communicating with a known command-and-control (C2) server?"
    context: "This question aims to identify the direct use of malicious tools like Pacu or Cloudsploit. Correlating tool execution with C2 traffic within a short time window provides a high-confidence indicator that an adversary is actively operating on the endpoint to manipulate cloud resources."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Endpoint event logs from administrative workstations, developer workstations, and CI/CD servers"
      - "Network traffic logs from internet gateways and VPN concentrators"
    range: "Last 90 days"
    queries:
      - technology: "SIEM"
        query: |
          SEARCH process_events (e.g., WinEvent:4688) WHERE (process_hash IN (offensive_tool_hashes) OR command_line CONTAINS (offensive_tool_signatures))
          JOIN network_events (e.g., Zeek:conn) ON source_ip WHERE destination_ip IN (c2_watchlist)
          WITHIN 10 minutes of each other.
  - question: "Is a host executing cloud CLI tools also making DNS queries to high-entropy domains, potentially indicating the use of a Domain Generation Algorithm (DGA) for C2?"
    context: "This question looks for a more subtle indicator of C2. Adversaries often use DGAs to evade static blocklists. A spike in domain entropy correlated with cloud tool usage suggests the tool might be communicating with a DGA-based C2 infrastructure."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Endpoint event logs from administrative workstations, developer workstations, and CI/CD servers"
      - "Network traffic logs from internet gateways and VPN concentrators"
    range: "Last 90 days"
    queries:
      - technology: "SIEM/Data Analytics"
        query: |
          FOR each host:
            CALCULATE baseline of domain_entropy from dns_logs (e.g., Zeek:dns) for known cloud CLI processes.
            SEARCH for new dns_logs FROM same host WHERE entropy(dns_query) > 98th_percentile(baseline)
            AND process_events (e.g., WinEvent:4688) for cloud CLI tools occurred concurrently.
  - question: "Can we predict malicious cloud activity by analyzing features from process execution and network connection events using a machine learning model?"
    context: "This question leverages machine learning to identify complex patterns that are difficult to define with simple rules. By training a model on features like parent process, command line characteristics, and network connection details, it can learn to distinguish between benign and malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Endpoint event logs from administrative workstations, developer workstations, and CI/CD servers"
      - "Network traffic logs from internet gateways and VPN concentrators"
    range: "Last 90 days"
    queries:
      - technology: "Machine Learning"
        query: |
          MODEL Random_Forest_Classifier
          FEATURES = [parent_process_name, command_line_length, command_line_entropy, destination_port, connection_duration, is_known_c2_ip]
          FROM process_events and network_events.
          PREDICT 'Malicious Cloud Activity'.
          ALERT if confidence_score > 0.9.
  - question: "Has a sensitive cloud hierarchy modification command been executed by a user who is not part of an authorized 'Cloud Administrators' group?"
    context: "This is a high-fidelity check for unauthorized activity. Commands that alter the fundamental structure of a cloud environment (like leaving an organization or transferring a subscription) should only be executed by a small, well-defined group of administrators. Execution by any other user is a major red flag."
    answer_sources:
      - "Windows Event ID 4688"
      - "Active Directory Logs"
      - "Zeek conn.log"
      - "Administrative workstations, CI/CD pipeline servers, Bastion hosts, and servers with cloud management SDKs installed"
    range: "Last 90 days"
    queries:
      - technology: "SIEM"
        query: |
          SEARCH process_events (e.g., WinEvent:4688) WHERE command_line IN (sensitive_hierarchy_commands_watchlist).
          ENRICH with user_group from Active Directory logs.
          ALERT if user_group NOT IN ('Cloud Administrators').
  - question: "Is an authorized cloud administrator executing sensitive hierarchy commands with an unusual frequency or at an abnormal time of day?"
    context: "This question seeks to detect account compromise or insider threat. Even if an authorized user is performing the action, the context of *when* and *how often* they do it can be anomalous. A sudden burst of activity or actions at 3 AM from a 9-to-5 employee warrants investigation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Active Directory Logs"
      - "Zeek conn.log"
      - "Administrative workstations, CI/CD pipeline servers, Bastion hosts, and servers with cloud management SDKs installed"
    range: "Last 90 days"
    queries:
      - technology: "SIEM/Data Analytics"
        query: |
          FOR each user IN 'Cloud Administrators':
            PROFILE baseline frequency and time-of-day for sensitive command execution.
            SEARCH for new executions of sensitive commands.
            ALERT if execution_time is > 3 standard_deviations from user's baseline OR daily_frequency > 99th_percentile of user's baseline.
  - question: "Is a sensitive hierarchy modification command being executed as part of an anomalous sequence of actions?"
    context: "This question uses machine learning to understand the 'grammar' of normal administrative workflows. A sensitive command that appears out of its usual context (e.g., not preceded by typical planning or review commands) could indicate a malicious actor who does not know the standard operating procedures."
    answer_sources:
      - "Windows Event ID 4688"
      - "Active Directory Logs"
      - "Zeek conn.log"
      - "Administrative workstations, CI/CD pipeline servers, Bastion hosts, and servers with cloud management SDKs installed"
    range: "Last 90 days"
    queries:
      - technology: "Machine Learning"
        query: |
          MODEL LSTM (Sequence Analysis) trained on benign administrative command sequences.
          INPUT sequence of commands from a single host/user.
          ALERT if sequence containing a sensitive hierarchy command has a low probability score from the model.
  - question: "Is a cloud CLI tool being executed on a host following a user logon from a geographically unapproved location?"
    context: "This question helps detect 'impossible travel' scenarios or access from nations that are not part of normal business operations. Correlating a risky login with the subsequent execution of powerful cloud tools provides a strong signal of a potential account takeover."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "All corporate endpoints and servers with cloud SDKs/CLIs installed, VPN access logs, Domain Controllers, and network egress points"
    range: "Last 90 days"
    queries:
      - technology: "SIEM"
        query: |
          SEARCH process_events (e.g., WinEvent:4688) for cloud CLI tools.
          CORRELATE with recent logon_events (e.g., WinEvent:4624, Type 3 or 10) for the same user.
          ENRICH logon_event with source_ip_geolocation.
          ALERT if geolocation_country NOT IN (approved_country_list for user's role).
  - question: "Is a cloud CLI tool being used after a user logged in from a historically anomalous network (ASN) or at an unusual time?"
    context: "This is a statistical approach to detecting anomalous access. Instead of a static list of approved countries, this method builds a dynamic baseline for each user. A login from a new internet service provider or at an odd hour for that specific user, followed by cloud admin activity, is highly suspicious."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "All corporate endpoints and servers with cloud SDKs/CLIs installed, VPN access logs, Domain Controllers, and network egress points"
    range: "Last 90 days"
    queries:
      - technology: "SIEM/Data Analytics"
        query: |
          FOR each user:
            PROFILE baseline of source_ASNs and login_times from logon_events (e.g., WinEvent:4624).
            SEARCH for process_events (e.g., WinEvent:4688) of cloud CLI tools.
            CORRELATE with recent logon_event for the same user.
            ALERT if logon_ASN is new for user OR logon_time is in bottom 5th_percentile of user's activity distribution.
  - question: "Has there been an anomalous spike in the volume of outbound network traffic to cloud management API endpoints?"
    context: "This question aims to detect large-scale or unusual administrative activity at the network level. A sudden, significant increase in traffic to cloud management endpoints, as predicted by a time-series model, could indicate an adversary performing bulk modifications or exfiltration, deviating from the normal operational rhythm."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "All corporate endpoints and servers with cloud SDKs/CLIs installed, VPN access logs, Domain Controllers, and network egress points"
    range: "Last 90 days"
    queries:
      - technology: "Machine Learning"
        query: |
          MODEL SARIMA (Time-Series Anomaly Detection) on hourly aggregated traffic volume to cloud_management_endpoints from network_logs (e.g., Zeek:conn).
          ALERT if observed_traffic_volume significantly exceeds the model's predicted upper confidence interval.
  - question: "Has a process accessed local cloud credential files and then, within 30 minutes, has a scripting engine on the same host connected to a cloud management API?"
    context: "This question traces a common adversary workflow: find credentials, then use them. By creating a stateful rule that looks for this specific sequence—credential access followed by a script connecting to a cloud API—we can detect credential theft and immediate misuse on an endpoint."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Developer workstations, Administrator workstations, servers hosting automation scripts, and CI/CD runners"
    range: "Last 90 days"
    queries:
      - technology: "SIEM"
        query: |
          TRIGGER on process_event (e.g., WinEvent:4688) where command_line accesses cloud_credential_paths.
          LOOK for a subsequent process_event on same host for a scripting_engine (powershell.exe, python.exe) within 30 mins.
          LOOK for a subsequent network_event (e.g., Zeek:conn) from same host to a cloud_api_endpoint within 30 mins.
          ALERT if all three events in sequence are found.
  - question: "Are scripting engines that connect to cloud APIs being executed with unusually high-entropy command lines?"
    context: "Adversaries often use obfuscation to hide their commands within scripts. A high-entropy command line can indicate encoded commands, long randomized arguments, or other obfuscation techniques. This is a statistical way to flag suspicious script execution even if the script's content is unknown."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Developer workstations, Administrator workstations, servers hosting automation scripts, and CI/CD runners"
    range: "Last 90 days"
    queries:
      - technology: "SIEM/Data Analytics"
        query: |
          SEARCH process_events (e.g., WinEvent:4688) for scripting_engines that have network connections to cloud APIs.
          CALCULATE shannon_entropy of the command_line field.
          ALERT if entropy_score is in the 95th_percentile or higher for that process type.
  - question: "Is a sequence of events, such as reading a config file and running a script that connects to a cloud API, highly improbable according to a model of benign activity?"
    context: "This question uses a Hidden Markov Model (HMM) to learn the typical 'states' an administrator's workflow goes through (e.g., 'Read Config', 'Run Script'). An observed sequence of events that has a very low probability of being generated by this 'benign' model indicates a deviation from normal procedures and is likely malicious."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Developer workstations, Administrator workstations, servers hosting automation scripts, and CI/CD runners"
    range: "Last 90 days"
    queries:
      - technology: "Machine Learning"
        query: |
          MODEL HMM (Hidden Markov Model) trained on event sequences from benign administrative sessions.
          INPUT observed sequence of events (process creation, network connection) from a host.
          ALERT if the probability of the sequence being generated by the benign model is below a set threshold.
  - question: "Is a sensitive cloud hierarchy modification command being executed within 5 minutes of an attempt to clear logs or disable a security service on the same host?"
    context: "This is a classic combination of attack and defense evasion. An adversary makes a significant, malicious change and then immediately tries to cover their tracks. Correlating these two distinct event types in a short time window is a very strong indicator of malicious intent."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1102"
      - "Windows Event ID 7040"
      - "Endpoint event logs on administrative workstations and servers, Domain Controller security logs, and centralized logging infrastructure"
    range: "Last 90 days"
    queries:
      - technology: "SIEM"
        query: |
          SEARCH for process_event (e.g., WinEvent:4688) with sensitive_cloud_command.
          CORRELATE with any of the following on the same host within 5 minutes:
            - Log clear event (e.g., WinEvent:1102)
            - Security service stop event (e.g., WinEvent:7040)
            - Process event for a defense evasion tool (e.g., wevtutil.exe, sc.exe)
          ALERT if correlation is found.
  - question: "Is a cloud hierarchy modification command being executed from a host that has recently been flagged for defense evasion activities?"
    context: "This approach uses risk scoring. Rather than requiring events to be simultaneous, it flags a host as 'high-risk' if it exhibits statistically rare defense evasion behavior (like clearing logs). Any subsequent sensitive action from that tainted host, even an hour later, is immediately escalated for critical review."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1102"
      - "Windows Event ID 7040"
      - "Endpoint event logs on administrative workstations and servers, Domain Controller security logs, and centralized logging infrastructure"
    range: "Last 90 days"
    queries:
      - technology: "SIEM/Data Analytics"
        query: |
          PROFILE baseline frequency of defense evasion commands (e.g., wevtutil cl) per host.
          ASSIGN high-risk score to host if a rare defense evasion command is executed.
          IF a cloud_hierarchy_modification_command is executed from a high-risk host within the next 60 minutes:
            ESCALATE to critical alert.
  - question: "Is a cloud administrative command originating from a host that a machine learning model has classified as being in a 'Defense Evasion State'?"
    context: "This question uses a classifier to make a judgment about the overall state of a host. The model learns to identify a 'Defense Evasion State' based on a combination of features. Once a host is in this state, all its actions, especially privileged ones like cloud administration, are considered highly suspect and are automatically prioritized for investigation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1102"
      - "Windows Event ID 7040"
      - "Endpoint event logs on administrative workstations and servers, Domain Controller security logs, and centralized logging infrastructure"
    range: "Last 90 days"
    queries:
      - technology: "Machine Learning"
        query: |
          MODEL Logistic Regression Classifier to predict 'Host Defense Evasion State'.
          FEATURES = [count of wevtutil executions, log clear events, security service stop events in last X minutes].
          IF host is classified as 'Defense Evasion State':
            AUTOMATICALLY escalate priority of any subsequent cloud administrative commands from that host for the next 60 minutes.