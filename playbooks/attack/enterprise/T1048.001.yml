name: T1048.001: Exfiltration Over Symmetric Encrypted Non-C2 Protocol
id: 5e9d3b4f-8a21-4f7c-9b1d-6a3f2e8c0b7a
description: This playbook helps identify if an adversary is exfiltrating data using a custom or non-standard symmetric encryption scheme over a common protocol. It focuses on detecting anomalies in network traffic, such as connections to known malicious infrastructure, payloads with high entropy suggesting encryption, abnormally high data transfer volumes, suspicious processes initiating network connections, and non-standard use of common protocols like DNS and HTTP.
type: technique
related:
- TA0010: Exfiltration
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is an internal host making an outbound connection to a destination IP, domain, or ASN known to be malicious based on threat intelligence?
  context: This question aims to identify direct connections to known adversary infrastructure. A match provides a high-confidence indicator of compromise, suggesting that an internal system is communicating with a command-and-control (C2) server or a known exfiltration point.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Network Security Monitoring (NSM) Sensors
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek conn.log and dns.log
      JOIN conn.log.id.resp_h with dns.log.answers
      WHERE conn.log.id.resp_h IN Threat_Intel_DB OR dns.log.answers IN Threat_Intel_DB
      ALERT on match
- question: Is an internal host connecting to an externally-facing destination that is rare across the enterprise and exhibits a high ratio of sent-to-received data?
  context: Adversaries often set up new or temporary infrastructure for data exfiltration. Connections to destinations that are rarely visited by other hosts in the organization, especially when combined with a large amount of data being sent, can indicate targeted exfiltration activity rather than legitimate browsing or service usage.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Network Security Monitoring (NSM) Sensors
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      PROFILE destination domains/ASNs over 30 days
      COUNT unique source hosts per destination
      CALCULATE sent_to_received_ratio = orig_bytes / resp_bytes
      ALERT where unique_source_hosts < 5 AND sent_to_received_ratio > 10
- question: Has a graph-based anomaly detection model identified a new or rare connection from an internal host to an external subnet/ASN, especially one with high data volume?
  context: This question uses machine learning to model the 'normal' network graph of the enterprise. It can detect subtle, anomalous connections that might be missed by statistical thresholds, flagging new relationships between internal assets and external entities that could represent the initial stages of data exfiltration.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Network Security Monitoring (NSM) Sensors
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      MODEL internal-to-external connections as a graph
      APPLY anomaly detection algorithm (e.g., community detection)
      SCORE new or rare edges based on data volume and connection frequency
      ALERT on high-scoring anomalous edges
- question: Is an internal host sending a DNS TXT record query with unusually high Shannon entropy and a long query length?
  context: This question looks for evidence of DNS tunneling, a common exfiltration technique. Adversaries encode data into DNS queries. High entropy suggests the data is encrypted or compressed, not plain text, and a long query length is needed to transport a meaningful amount of data. This is a strong indicator of non-standard protocol use for data exfiltration.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Zeek files.log
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Network Taps with Full Packet Capture
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek dns.log
      WHERE query_type = 'TXT'
      CALCULATE Shannon entropy of query payload
      ALERT where entropy > 7.5 AND query_length > 200
- question: Has a connection's payload entropy and outbound data volume both significantly exceeded their historical baselines for a specific host and protocol?
  context: This question establishes a behavioral baseline for each host's network traffic. An alert is triggered only when a connection is anomalous in two dimensions: the data appears encrypted (high entropy) and the amount of data sent is unusually large compared to the host's normal behavior. This dual condition reduces false positives from legitimate encrypted traffic.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Zeek files.log
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Network Taps with Full Packet Capture
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each source host and protocol
      CALCULATE 30-day rolling baseline of payload entropy and orig_bytes
      ALERT when new_entropy > 99th_percentile(baseline_entropy) AND new_orig_bytes > 99th_percentile(baseline_orig_bytes)
- question: Has a machine learning model, trained on network features, assigned a high probability score for exfiltration to a new connection?
  context: This question leverages a supervised machine learning model (Random Forest) to classify network connections. By training the model on features like protocol, port, entropy, and data volumes from both legitimate and known malicious traffic, it can provide a probabilistic score, offering a more nuanced and accurate detection of potential exfiltration than simple rules.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Zeek files.log
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Network Taps with Full Packet Capture
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      TRAIN Random Forest classifier with features: proto, resp_p, entropy, orig_bytes, resp_bytes, duration
      APPLY model to new connections
      ALERT where probability_score > 0.9
- question: Has any single network session from a user-zone asset to an external destination exceeded a large, static data transfer threshold?
  context: This question acts as a simple, high-water mark detector for massive data exfiltration events. While unsophisticated, it is effective at catching 'smash and grab' data theft where an adversary attempts to exfiltrate a large volume of data in a single connection, such as a large database backup or file archive.
  answer_sources:
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Critical Asset Subnets (e.g., Database Servers, File Servers)
  - User Workstation Subnets
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek conn.log
      WHERE source_ip is in user_zone
      AND destination_ip is external
      ALERT where orig_bytes > 500MB
- question: Has the total daily outbound data volume for a source-destination pair exceeded its historical average by a statistically significant amount (e.g., 4 standard deviations)?
  context: This question focuses on detecting slow-and-low exfiltration that might occur over a full day. By aggregating data over 24 hours and comparing it to a 30-day statistical baseline, it can identify significant deviations that indicate a sustained data leak, even if no single connection is large enough to trigger a threshold alert.
  answer_sources:
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Critical Asset Subnets (e.g., Database Servers, File Servers)
  - User Workstation Subnets
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each source-destination pair
      CALCULATE 30-day mean and std_dev of daily total orig_bytes
      AGGREGATE orig_bytes over last 24 hours
      ALERT where 24h_total > (mean + 4 * std_dev)
- question: Has a time-series model detected a significant, unexplainable spike in a host's hourly outbound traffic?
  context: This question uses advanced time-series analysis to understand the normal rhythm (trend, seasonality) of a host's network traffic. By decomposing the time-series, the model can isolate the residual 'noise'. A large spike in this residual component is a strong indicator of an anomalous event that doesn't fit the host's normal patterns, such as an exfiltration event.
  answer_sources:
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Critical Asset Subnets (e.g., Database Servers, File Servers)
  - User Workstation Subnets
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      MODEL hourly aggregated outbound bytes per host using SARIMA
      DECOMPOSE time-series into trend, seasonality, and residual
      ALERT on residual values that exceed a predefined threshold
- question: Did a process from a watchlist of suspicious tools (e.g., certutil.exe, powershell.exe) create an outbound network connection shortly after it was started?
  context: This question correlates process activity with network activity on an endpoint. It specifically looks for 'living-off-the-land' binaries (LOLBins)—legitimate system tools that are often abused by adversaries—making network connections. This behavior is highly suspicious, as these tools are often used to download secondary payloads or exfiltrate data.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Windows Event ID 5156
  - Sysmon Event ID 3
  - Zeek conn.log
  - Endpoint Devices (Workstations and Servers)
  - Domain Controllers
  - Application Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH for Sysmon Event ID 1 (Process Creation)
      WHERE ProcessName is in ('certutil.exe', 'bitsadmin.exe', 'powershell.exe')
      CORRELATE with Sysmon Event ID 3 (Network Connection) from the same ProcessGUID within 60 seconds
      WHERE DestinationIP is external
      ALERT on match
- question: Did an uncommon or rare process on an endpoint initiate a network connection that resulted in a very large data transfer?
  context: This question aims to find outliers in process behavior. A process that rarely runs or is not typically associated with network activity (e.g., a system utility) that suddenly initiates a large outbound transfer is highly anomalous. This could indicate that malware is masquerading as a legitimate process or that a legitimate tool has been hijacked for exfiltration.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Windows Event ID 5156
  - Sysmon Event ID 3
  - Zeek conn.log
  - Endpoint Devices (Workstations and Servers)
  - Domain Controllers
  - Application Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      PROFILE frequency of all processes that make outbound connections
      IDENTIFY processes in bottom 5% of frequency
      PROFILE volume of all outbound connections (orig_bytes)
      IDENTIFY connections in top 5% of volume
      ALERT when a rare process initiates a large-volume connection
- question: Has an Isolation Forest model identified an anomalous combination of process and network characteristics, such as a rare process path, high command line entropy, and a large data transfer?
  context: This question uses an unsupervised machine learning model (Isolation Forest) that is particularly good at identifying outliers. It examines a combination of features from both process and network events to find unusual behaviors that don't fit any normal pattern, without needing prior knowledge of what is 'bad'. This can uncover novel or sophisticated adversary techniques.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Windows Event ID 5156
  - Sysmon Event ID 3
  - Zeek conn.log
  - Endpoint Devices (Workstations and Servers)
  - Domain Controllers
  - Application Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CREATE feature set from process/network events (path rarity, cmdline entropy, dest port, bytes sent)
      APPLY Isolation Forest model to the feature set
      ALERT on data points identified as anomalous
- question: Is an internal host making DNS queries that appear to be chunking data, characterized by TXT/NULL types, numerous subdomains, and long query names?
  context: This is a specific signature for DNS tunneling where data is broken into 'chunks' and encoded into a series of DNS queries. The use of many subdomains (e.g., chunk1.data.domain.com, chunk2.data.domain.com) is a common pattern for this technique. Detecting this structure is a high-fidelity indicator of data exfiltration over DNS.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Web Proxies
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH Zeek dns.log
      WHERE query_type IN ('TXT', 'NULL')
      AND subdomain_count(query_name) > 10
      AND length(query_name) > 100
      ALERT on match
- question: Is an internal host exhibiting an abnormally high ratio of HTTP POST requests to GET requests compared to its own historical baseline?
  context: Normal web browsing involves a high number of GET requests (downloading content) and a relatively low number of POST requests (uploading data). An inverted or unusually high POST-to-GET ratio for a host suggests it is primarily sending data rather than receiving it, which can be a sign of data exfiltration over HTTP/S.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Web Proxies
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each source IP
      CALCULATE 30-day baseline of (POST_count / GET_count) ratio
      CALCULATE 1-hour rolling average of the same ratio
      ALERT when 1h_ratio > 98th_percentile(baseline_ratio)
- question: Has a sequence-to-sequence autoencoder model detected a high reconstruction error for a connection's protocol event sequence?
  context: This question applies deep learning to model the normal 'conversation' of a protocol. The autoencoder learns the typical sequence of events (e.g., for HTTP: a GET is followed by a 200 OK). When an adversary tunnels traffic, the sequence of protocol events is often abnormal. The model will fail to reconstruct this abnormal sequence accurately, resulting in a high reconstruction error that signals an anomaly.
  answer_sources:
  - Zeek http.log
  - Zeek dns.log
  - Zeek conn.log
  - Internet Gateway/Egress Firewalls
  - Internal DNS Servers
  - Web Proxies
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      TRAIN LSTM autoencoder on sequences of protocol events within connections
      APPLY model to new connection event sequences
      CALCULATE reconstruction error
      ALERT when reconstruction_error is high