name: T1048.001: Exfiltration Over Symmetric Encrypted Non-C2 Protocol
id: 3c1a0b5d-9f3e-4b2a-8d7c-6e5f4a3b2c1d
description: This playbook helps investigate whether an adversary is exfiltrating data using a custom or non-standard symmetric encryption scheme over a common protocol. Detection focuses on identifying outbound connections to known malicious infrastructure, analyzing application-layer payloads for abnormally high entropy (suggesting encryption), monitoring for anomalously high data transfer volumes, flagging network connections initiated by unusual processes, and detecting violations in standard protocol conversational structures (e.g., HTTP, DNS).
type: technique
related:
  - TA0010: Exfiltration
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is an internal host making an outbound connection to a known malicious destination identified by a threat intelligence feed?
    context: This question aims to identify direct communication with known adversary infrastructure. A match against a high-confidence cyber threat intelligence (CTI) feed is a strong indicator of compromise, potentially related to data exfiltration staging or direct transfer. The query joins network connection logs with DNS lookups to provide context and directly compares them against the CTI database in real-time.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Network Security Monitoring (NSM) Sensors
    range: last 90 days
    queries:
      - pseudocode: JOIN conn_logs ON destination_ip WITH dns_logs ON resolved_ip. CHECK IF destination_ip OR domain IN threat_intel_feed. ALERT if match.
  - question: Are internal hosts connecting to rare external destinations with a high ratio of sent-to-received data?
    context: This question helps uncover potential exfiltration channels that are not yet part of known threat intelligence. Adversaries often use newly established or obscure infrastructure. By profiling destination popularity (domains and ASNs) across the enterprise and flagging connections that are both rare and exhibit a high upload-to-download ratio, we can spot suspicious data staging or exfiltration activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Network Security Monitoring (NSM) Sensors
    range: last 90 days
    queries:
      - pseudocode: PROFILE destination domains/ASNs over 30 days. COUNT unique source hosts per destination. ALERT if destination_host_count < 5 AND (sent_bytes / received_bytes) > 10.
  - question: Can we identify anomalous network connections to new or rare subnets/ASNs that are part of a broader malicious infrastructure pattern?
    context: This question uses machine learning to move beyond simple statistical outliers. By modeling the entire graph of internal-to-external connections, a graph-based anomaly detection algorithm can identify not just individual rare connections, but also connections that, while seemingly isolated, are part of a larger, loosely connected 'community' of malicious infrastructure. This approach is effective at finding coordinated, distributed exfiltration points.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Network Security Monitoring (NSM) Sensors
    range: last 90 days
    queries:
      - pseudocode: MODEL internal-to-external connections as a graph. APPLY community detection and anomaly scoring to edges. ALERT on new/rare edges with high anomaly scores and high data volume.
  - question: Is an internal host sending DNS TXT queries with high entropy and large payloads, suggesting data encapsulation?
    context: This question targets a specific exfiltration technique, DNS tunneling, where adversaries encode data into long DNS queries. High Shannon entropy indicates the data is likely encrypted or compressed. By setting a static threshold for entropy and query length, we can create a simple but effective rule to detect this specific abuse of the DNS protocol.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek files.log
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Network Taps with Full Packet Capture
    range: last 90 days
    queries:
      - pseudocode: FOR each DNS TXT query, CALCULATE payload entropy. ALERT if entropy > 7.5 AND payload_length > 200 bytes.
  - question: Is a host exhibiting a sudden, statistically significant increase in both payload entropy and outbound data volume for a specific protocol?
    context: This question aims to detect when a host's traffic pattern changes to become more indicative of encrypted data exfiltration. This approach establishes a dynamic baseline of normal entropy and data volume for each host and protocol. An alert is generated only when a new connection is anomalous in both entropy and volume compared to the host's own history, reducing false positives.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek files.log
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Network Taps with Full Packet Capture
    range: last 90 days
    queries:
      - pseudocode: BASELINE payload entropy and sent_bytes per host/protocol over 30 days. ALERT if new_connection_entropy > 99th_percentile_entropy AND new_connection_sent_bytes > 99th_percentile_sent_bytes.
  - question: Can we use a machine learning model to classify network connections as potential exfiltration based on a combination of protocol features, entropy, and data volume?
    context: This question leverages a supervised machine learning model (Random Forest) to make a holistic judgment about a network connection. By training the model on known good and bad traffic, it learns the complex interplay between features like protocol, port, entropy, and byte counts. This allows it to assign a probability score to new connections, providing a more nuanced detection capability.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek files.log
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Network Taps with Full Packet Capture
    range: last 90 days
    queries:
      - pseudocode: TRAIN Random Forest classifier with features (protocol, port, entropy, bytes, duration) on labeled data. PREDICT probability score for new connections. ALERT if score > 0.9.
  - question: Has a user workstation sent an unusually large amount of data (e.g., >500MB) to an external destination in a single session?
    context: This question establishes a simple, high-water mark for data transfer volume from user endpoints. While servers might legitimately transfer large files, a single session from a user workstation sending hundreds of megabytes is highly abnormal and warrants investigation. This rule acts as a safety net to catch blatant, large-scale data theft.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Critical Asset Subnets (e.g., Database Servers, File Servers)
      - User Workstation Subnets
    range: last 90 days
    queries:
      - pseudocode: FOR each connection log from user_zone to external_zone, ALERT if sent_bytes > 500MB.
  - question: Has the total daily data sent between a specific internal host and an external destination significantly deviated from its historical average?
    context: This question looks for anomalous data volumes on an aggregate level (daily) between specific host pairs. Adversaries may exfiltrate data in smaller chunks over time to evade single-session thresholds. By calculating a baseline (mean and standard deviation) over a 30-day window, we can detect when the total volume over 24 hours is statistically unusual.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Critical Asset Subnets (e.g., Database Servers, File Servers)
      - User Workstation Subnets
    range: last 90 days
    queries:
      - pseudocode: For each source-destination pair, CALCULATE 30-day mean and stddev of daily_sent_bytes. ALERT if new_daily_sent_bytes > (mean + 4 * stddev).
  - question: Can a time-series model detect anomalous spikes in a host's outbound traffic that are inconsistent with its normal daily and weekly patterns?
    context: This question applies time-series analysis to detect exfiltration. Many hosts have regular traffic patterns. A time-series model like SARIMA can learn these trend and seasonality components. By decomposing the traffic, we can isolate the 'residual' or unexplained noise. A large, unexpected spike in this residual component is a strong indicator of an anomalous event like exfiltration.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Critical Asset Subnets (e.g., Database Servers, File Servers)
      - User Workstation Subnets
    range: last 90 days
    queries:
      - pseudocode: MODEL hourly outbound bytes per host using SARIMA. DECOMPOSE into trend, seasonality, residual. ALERT if any point in the residual component exceeds a predefined threshold.
  - question: Is a suspicious process (e.g., certutil.exe, powershell.exe) creating a network connection to an external address shortly after being launched?
    context: This question correlates process activity with network activity on an endpoint. It targets 'Living off the Land' binaries (LOLBins) that are legitimate system tools but are often abused by adversaries. A correlation rule that detects a known LOLBin starting and immediately making an external network connection is a high-fidelity indicator of malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 5156
      - Sysmon Event ID 3
      - Zeek conn.log
      - Endpoint Devices (Workstations and Servers)
      - Domain Controllers
      - Application Servers
    range: last 90 days
    queries:
      - pseudocode: CORRELATE ProcessCreation (Sysmon EID 1) with NetworkConnection (Sysmon EID 3) on ProcessGUID. ALERT if process_name in watchlist AND destination_ip is external AND time_delta < 60s.
  - question: Is a rarely used process initiating an outbound network connection with an unusually high data transfer volume?
    context: This question seeks to identify anomalous behavior by combining two statistical measures, process rarity and data volume. When a process that rarely makes network connections suddenly initiates a connection that transfers a large amount of data, it is highly suspicious. This approach helps find novel or custom malware not on any watchlist.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 5156
      - Sysmon Event ID 3
      - Zeek conn.log
      - Endpoint Devices (Workstations and Servers)
      - Domain Controllers
      - Application Servers
    range: last 90 days
    queries:
      - pseudocode: PROFILE frequency of processes making outbound connections. PROFILE volume of outbound data. ALERT if process_frequency is in bottom 5% AND connection_data_volume is in top 5%.
  - question: Can we use an unsupervised machine learning model to identify anomalous combinations of process and network characteristics on a host?
    context: This question uses an unsupervised model (Isolation Forest) to find outliers without needing pre-labeled data. It examines a combination of features—such as process path rarity, command line complexity, parent process, and network destination. The model is effective at identifying 'weird' combinations that a human analyst or a simple rule might miss.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 5156
      - Sysmon Event ID 3
      - Zeek conn.log
      - Endpoint Devices (Workstations and Servers)
      - Domain Controllers
      - Application Servers
    range: last 90 days
    queries:
      - pseudocode: APPLY Isolation Forest model to feature set (process_path_rarity, cmdline_entropy, parent_process, dest_port, dest_ASN, bytes_sent). ALERT on instances with high anomaly scores.
  - question: Is the DNS protocol being abused to tunnel data by chunking it into an excessive number of subdomains or long TXT records?
    context: This question focuses on detecting DNS tunneling through malformed queries. Adversaries often encode exfiltrated data into the subdomain portion of a DNS query. This rule creates a specific signature to look for queries that have an abnormally high number of subdomains or are excessively long, which are strong indicators of this data chunking technique.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Web Proxies
    range: last 90 days
    queries:
      - pseudocode: FOR each DNS query, ALERT if query_type in (TXT, NULL) AND subdomain_count > 10 AND query_length > 100.
  - question: Is an internal host uploading a statistically anomalous amount of data via HTTP POST requests compared to its normal browsing behavior?
    context: This question aims to detect exfiltration over HTTP. Normal web browsing involves a high ratio of GET requests to POST requests. An adversary might use repeated POST requests to exfiltrate data. By monitoring the ratio of POST to GET volume for each host and comparing it to its own historical baseline, we can flag a significant shift towards uploading.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Web Proxies
    range: last 90 days
    queries:
      - pseudocode: For each source IP, CALCULATE 30-day baseline of (POST_volume / GET_volume) ratio. ALERT if 1-hour rolling average of ratio > 98th percentile of baseline.
  - question: Can we detect non-standard protocol usage by identifying sequences of protocol events that deviate from a learned model of normal conversation?
    context: This question uses a deep learning approach to model the 'grammar' of a network protocol. An autoencoder learns the typical patterns of events within a connection. When it encounters a sequence it cannot reconstruct accurately (e.g., hundreds of POSTs with no GETs), it flags it as an anomaly. This is powerful for detecting tunneling or other protocol abuse.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek conn.log
      - Internet Gateway/Egress Firewalls
      - Internal DNS Servers
      - Web Proxies
    range: last 90 days
    queries:
      - pseudocode: TRAIN LSTM autoencoder on sequences of protocol events. For new connections, CALCULATE reconstruction error. ALERT if error is high.