name: T1505.005: Terminal Services DLL
id: 2c8d7e6f-9a0b-4c1d-8e5f-6a7b8c9d0e1f
description: This playbook helps investigate whether an adversary has achieved persistence by modifying the Terminal Services DLL (termsrv.dll). This technique involves an adversary replacing the legitimate termsrv.dll file or altering the 'HKLM\System\CurrentControlSet\services\TermService\Parameters\ServiceDll' registry key to point to a malicious DLL. This allows the adversary's code to be executed by the Terminal Services service. Investigative focus includes analyzing the file hash of the DLL, monitoring for unauthorized command-line executions that modify the file or registry key, identifying non-standard processes that perform these modifications, and detecting an anomalous number of concurrent RDP sessions, which could be a side effect of this modification.
type: technique
related:
  - "TA0003: Persistence"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has the `termsrv.dll` file or a custom Terminal Services DLL been replaced with a file matching a known-bad hash?
    context: This question aims to detect a direct replacement of the Terminal Services DLL with a known malicious implant. Adversaries may use this technique for persistence. By comparing the file hash against a threat intelligence database, we can quickly identify known threats. A match is a strong indicator of compromise.
    answer_sources:
      - "Windows Event ID 1 (Sysmon)"
      - "Windows Event ID 7 (Sysmon)"
      - "Windows Event ID 11 (Sysmon)"
      - "Windows Event ID 13 (Sysmon)"
      - "File systems and registries of all Windows endpoints and servers, especially Remote Desktop Gateway servers and multi-user session hosts."
    range: last 90 days
    queries:
      - "SEARCH for file modification (Sysmon EID 11) on 'termsrv.dll' OR registry modification (Sysmon EID 13) on 'ServiceDll' value. EXTRACT file hash. JOIN hash with threat intelligence database. ALERT on match."
  - question: Is the hash of the `termsrv.dll` file statistically rare or new within the enterprise?
    context: This question identifies potential zero-day or custom malware not present in threat intelligence feeds. A `termsrv.dll` file hash that is unique or present on a very small number of systems is anomalous, as legitimate versions are typically widespread due to standardized OS builds and patching. This could indicate a targeted attack.
    answer_sources:
      - "Windows Event ID 1 (Sysmon)"
      - "Windows Event ID 7 (Sysmon)"
      - "Windows Event ID 11 (Sysmon)"
      - "Windows Event ID 13 (Sysmon)"
      - "File systems and registries of all Windows endpoints and servers, especially Remote Desktop Gateway servers and multi-user session hosts."
    range: last 90 days
    queries:
      - "COLLECT all 'termsrv.dll' file hashes across the environment. CALCULATE frequency of each hash. ALERT on hashes with prevalence below a defined threshold (e.g., < 0.1%)."
  - question: Does a machine learning model classify a new or modified `termsrv.dll` file as malicious based on its static features?
    context: This question uses a predictive model to assess the likelihood of a DLL being malicious, even without prior knowledge of its hash. The model analyzes intrinsic file properties (like entropy, imports, and header information) that often distinguish malicious files from benign ones. This provides a proactive detection capability against novel threats.
    answer_sources:
      - "Windows Event ID 1 (Sysmon)"
      - "Windows Event ID 7 (Sysmon)"
      - "Windows Event ID 11 (Sysmon)"
      - "Windows Event ID 13 (Sysmon)"
      - "File systems and registries of all Windows endpoints and servers, especially Remote Desktop Gateway servers and multi-user session hosts."
    range: last 90 days
    queries:
      - "ON file creation/modification of 'termsrv.dll', EXTRACT static file features. INPUT features into ML classification model. ALERT if malicious probability > threshold (e.g., 0.85)."
  - question: Have any commands been executed to take ownership or modify permissions of `termsrv.dll` or the associated `ServiceDll` registry value?
    context: Before an adversary can modify the protected `termsrv.dll` file or its registry configuration, they must first take ownership and grant themselves permissions. This question looks for the preparatory steps of the attack by monitoring for specific command-line utilities (`takeown`, `icacls`, `reg.exe`) used to manipulate these assets. Detecting this sequence is a strong indicator of malicious intent.
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1 (Sysmon)"
      - "Command-line and process execution logs from all Windows endpoints and servers, particularly administrative workstations and servers."
    range: last 90 days
    queries:
      - "SEARCH process creation logs for command lines containing ('takeown' OR 'icacls' OR 'reg.exe add') AND ('TermService' OR 'termsrv.dll'). CORRELATE 'takeown' followed by 'icacls' on 'termsrv.dll' within 2 minutes. ALERT on match."
  - question: Were commands used to modify `termsrv.dll` or its registry key obfuscated or initiated by a statistically rare parent process?
    context: Adversaries often obfuscate commands to evade simple signature-based detection. High command-line entropy can reveal this obfuscation. Furthermore, legitimate system modifications are typically performed by standard administrative tools, not by applications like Microsoft Word (`winword.exe`). This question seeks to identify these statistical anomalies, which are strong indicators of a compromise.
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1 (Sysmon)"
      - "Command-line and process execution logs from all Windows endpoints and servers, particularly administrative workstations and servers."
    range: last 90 days
    queries:
      - "FOR commands modifying 'termsrv.dll' or 'TermService' registry, CALCULATE command-line entropy and parent process rarity. ALERT on high entropy OR if parent process is statistically rare for that action."
  - question: Does the sequence of commands leading up to the modification of `termsrv.dll` or its registry key deviate from normal administrative behavior as determined by a sequence analysis model?
    context: This question moves beyond single commands to analyze the entire chain of actions performed by a user or process. A machine learning model trained on normal administrative command sequences can identify when a series of actions, even if individually benign, collectively represents a deviation from the norm. This helps detect sophisticated attackers who try to blend in by mimicking legitimate activities.
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1 (Sysmon)"
      - "Command-line and process execution logs from all Windows endpoints and servers, particularly administrative workstations and servers."
    range: last 90 days
    queries:
      - "INPUT sequences of command-line activity into a trained sequence analysis model (e.g., LSTM). ALERT if a sequence leading to modification of 'termsrv.dll' or its registry key is flagged as anomalous."
  - question: Was the `termsrv.dll` file or `ServiceDll` registry value modified by a process not on the established allowlist of trusted system updaters?
    context: Legitimate modifications to critical system files like `termsrv.dll` are typically performed by a very small set of trusted OS processes, such as `TrustedInstaller.exe`, during system updates. This question checks if the process that made the change is on an approved list. Any modification by a process not on this allowlist (e.g., `powershell.exe`, `cmd.exe`, or an unknown process) is highly suspicious and warrants immediate investigation.
    answer_sources:
      - "Windows Event ID 4657"
      - "Windows Event ID 11 (Sysmon)"
      - "Windows Event ID 13 (Sysmon)"
      - "File system and registry audit logs on all Windows hosts, particularly Remote Desktop servers and domain controllers."
    range: last 90 days
    queries:
      - "MONITOR for file writes (Sysmon EID 11) to 'termsrv.dll' or registry writes (Sysmon EID 13) to 'ServiceDll'. EXTRACT the modifying process name. ALERT if process is NOT in the trusted updater allowlist."
  - question: Was the `termsrv.dll` file or `ServiceDll` registry value modified by a statistically rare process?
    context: This question helps identify unusual activity by focusing on the rarity of the modifying process. Even if a process isn't explicitly disallowed, if it has rarely or never been observed modifying these specific assets before, its activity is anomalous. This approach can catch legitimate tools being used for malicious purposes (living-off-the-land techniques).
    answer_sources:
      - "Windows Event ID 4657"
      - "Windows Event ID 11 (Sysmon)"
      - "Windows Event ID 13 (Sysmon)"
      - "File system and registry audit logs on all Windows hosts, particularly Remote Desktop servers and domain controllers."
    range: last 90 days
    queries:
      - "MAINTAIN a frequency distribution of processes that modify 'termsrv.dll' or 'ServiceDll'. ALERT if a modification is performed by a process in a low-frequency percentile (e.g., bottom 5%)."
  - question: Does a machine learning model flag the event of modifying `termsrv.dll` or its registry key as an anomaly based on its context (e.g., process, user, time)?
    context: This question uses a multi-faceted approach to anomaly detection. A machine learning model considers not just the process name, but also its parent process, the user account that executed it, and the time of the event. By training on a baseline of normal modification events, the model can identify subtle deviations that signal malicious activity, providing a more robust detection capability than single-factor analysis.
    answer_sources:
      - "Windows Event ID 4657"
      - "Windows Event ID 11 (Sysmon)"
      - "Windows Event ID 13 (Sysmon)"
      - "File system and registry audit logs on all Windows hosts, particularly Remote Desktop servers and domain controllers."
    range: last 90 days
    queries:
      - "ON modification of 'termsrv.dll' or 'ServiceDll', EXTRACT features (process, parent, user, time). INPUT to anomaly detection model (e.g., Isolation Forest). ALERT if the event is flagged as an anomaly."
  - question: Are there multiple concurrent interactive RDP sessions active on a single Windows client operating system?
    context: Standard Windows client operating systems (like Windows 11) are not designed to support more than one active RDP session. A common modification made by a malicious `termsrv.dll` is to patch this limitation, allowing multiple users to connect simultaneously. Therefore, detecting more than one active Logon Type 10 session on a client OS is a very strong indicator that the `termsrv.dll` has been tampered with.
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4634"
      - "Windows Event ID 4778"
      - "Windows Event ID 4779"
      - "Zeek conn.log"
      - "Authentication logs from Domain Controllers and member servers/workstations, and network flow logs from network sensors at egress points and key internal segments."
    range: last 90 days
    queries:
      - "TRACK active RDP sessions (Logon Type 10) per host using logon/logoff events. IF host is a client OS, ALERT if active session count > 1."
  - question: Is there a statistically anomalous number of concurrent RDP sessions active on a Windows Server?
    context: While Windows Servers are designed for multiple RDP sessions, a sudden, sharp increase in the number of concurrent sessions can indicate malicious activity. This could result from an attacker using a patched `termsrv.dll` to enable more sessions than licensed or to facilitate lateral movement. This question aims to detect such spikes by comparing current session counts against a dynamically calculated baseline of normal activity.
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4634"
      - "Windows Event ID 4778"
      - "Windows Event ID 4779"
      - "Zeek conn.log"
      - "Authentication logs from Domain Controllers and member servers/workstations, and network flow logs from network sensors at egress points and key internal segments."
    range: last 90 days
    queries:
      - "FOR each Windows Server, CALCULATE a moving average and standard deviation of concurrent RDP sessions. ALERT if current session count exceeds the moving average by a set threshold (e.g., 3 standard deviations)."
  - question: Does the observed number of concurrent RDP sessions on a critical server significantly deviate from the number predicted by a time-series forecasting model?
    context: This question provides a more sophisticated method for detecting anomalous session counts on critical servers. A time-series forecasting model (like ARIMA) can learn complex patterns, including seasonality (e.g., time of day, day of week), from historical data. It then predicts the expected range of sessions for a future time. An alert is triggered only when the actual count falls outside this predicted range, reducing false positives and more accurately identifying true anomalies.
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4634"
      - "Windows Event ID 4778"
      - "Windows Event ID 4779"
      - "Zeek conn.log"
      - "Authentication logs from Domain Controllers and member servers/workstations, and network flow logs from network sensors at egress points and key internal segments."
    range: last 90 days
    queries:
      - "FOR each critical server, USE a trained time-series model (e.g., ARIMA) to predict expected concurrent RDP sessions. ALERT if the observed session count significantly deviates from the prediction's confidence interval."