name: 'T1589.002: Email Addresses'
id: 'a7b1c2d3-e4f5-4a6b-8c9d-0e1f2a3b4c5d'
description: "This playbook helps determine if an adversary is actively gathering the organization's email addresses for targeting. It focuses on detecting reconnaissance activities such as an unusual volume of connections from threat-intelligence-flagged IPs, the use of automated email harvesting tools identified by their User-Agent strings, significant deviations in authentication success/failure ratios indicative of credential testing, web scraping behaviors targeting employee directories, and subsequent targeted authentication attacks against specific user groups following a suspected reconnaissance event."
type: 'technique'
related:
  - 'TA0043: Reconnaissance'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Are any external IP addresses connecting to our public services also listed on high-confidence threat intelligence feeds as malicious?'
    context: 'This question aims to identify connections from known malicious actors, such as documented C2 servers, scanners, or anonymizing services like TOR exit nodes. A match provides a high-fidelity indicator that the activity is not benign and requires immediate investigation, as it could be the precursor to an attack.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'Threat Intelligence Feed'
      - 'Internet gateway'
      - 'network DMZ'
      - 'public-facing web servers'
      - 'external-facing authentication services (e.g., M365, VPN concentrators)'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "SEARCH Zeek conn.log WHERE source_ip IN (high_confidence_threat_feed) AND is_external(source_ip) | ALERT"
  - question: 'Are any external IP addresses from lower-confidence threat feeds connecting to our services at a rate that is statistically anomalous compared to normal traffic?'
    context: 'This question helps detect suspicious activity from sources that are not confirmed as malicious but are associated with higher-risk services like generic VPNs. By calculating a baseline of normal connection rates and flagging significant deviations (e.g., exceeding the 99th percentile), we can identify potential reconnaissance efforts that would otherwise be missed by simple signature-based detection.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'Threat Intelligence Feed'
      - 'Internet gateway'
      - 'network DMZ'
      - 'public-facing web servers'
      - 'external-facing authentication services (e.g., M365, VPN concentrators)'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "SEARCH Zeek conn.log WHERE source_ip IN (low_confidence_feed) | STATS count BY source_ip, dest_port over 10m | WHERE count > percentile(all_external_traffic_to_port, 99, 24h) | ALERT"
  - question: 'Is the total volume of connections from known anonymizing services significantly exceeding forecasted seasonal trends?'
    context: "This question uses machine learning to establish a sophisticated baseline of expected traffic from anonymizing services, accounting for regular patterns like day-of-week or time-of-day variations. A significant spike above the model's prediction suggests a coordinated, large-scale reconnaissance campaign that might be distributed across many IPs and would be difficult to detect with per-IP statistical methods."
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'Threat Intelligence Feed'
      - 'Internet gateway'
      - 'network DMZ'
      - 'public-facing web servers'
      - 'external-facing authentication services (e.g., M365, VPN concentrators)'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "COMPARE current_connection_volume(anonymizing_services) with forecast_model(90d_history) | IF current_volume > prediction_interval(95%) THEN ALERT"
  - question: 'Are any HTTP requests to our web services using User-Agent strings associated with known email harvesting or reconnaissance tools?'
    context: "This question seeks to identify overt reconnaissance attempts where the adversary uses common OSINT or hacking tools. These tools often have unique User-Agent strings (e.g., 'theHarvester', 'sqlmap', 'Nmap Scripting Engine'). Detecting these signatures provides direct evidence of targeted information gathering."
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek weird.log'
      - "Public-facing web servers (e.g., company 'About Us' or 'Contact' pages)"
      - 'SharePoint sites'
      - 'web application frontends'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "SEARCH Zeek http.log WHERE user_agent MATCHES (recon_tool_regex_list) AND NOT source_ip IN (benign_scanners) | ALERT"
  - question: 'Are any source IPs exhibiting signs of automated directory enumeration, characterized by a high request rate combined with low URI entropy?'
    context: "This question is designed to detect automated scraping that doesn't use a known malicious User-Agent. A low Shannon entropy score in the requested URIs indicates that the client is accessing very similar, predictable paths, which is characteristic of enumeration. Combining this with a high request rate helps distinguish automated tools from normal user browsing."
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek weird.log'
      - "Public-facing web servers (e.g., company 'About Us' or 'Contact' pages)"
      - 'SharePoint sites'
      - 'web application frontends'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "CALCULATE uri_entropy and request_rate per source_ip over 5m | IF uri_entropy < 1.0 AND request_rate > 30/min THEN ALERT"
  - question: 'Can any HTTP requests be classified with high confidence as automated scraping based on a machine learning model of their header and URI structure?'
    context: 'This question leverages a classification model to provide a more nuanced detection of automated activity. The model can learn the subtle combinations of features (headers, URI patterns, request method) that distinguish scrapers from legitimate users and benign bots (like search engine crawlers). This allows for more accurate identification of malicious scraping with fewer false positives.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek weird.log'
      - "Public-facing web servers (e.g., company 'About Us' or 'Contact' pages)"
      - 'SharePoint sites'
      - 'web application frontends'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "SCORE each http_request with classification_model | IF score > 0.9 for 'automated' AND source_ip NOT IN (benign_crawlers) THEN ALERT"
  - question: 'Has any single external IP address generated a high number of failed logon attempts across multiple user accounts in a short time frame?'
    context: 'This question aims to detect a classic password spraying or credential stuffing attack. An adversary, having harvested a list of potential email addresses/usernames, will try a common password against many accounts. A rule that triggers on a threshold of failures (e.g., >10) across multiple accounts (e.g., >5) from one IP is a strong indicator of this technique.'
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Domain Controllers'
      - 'Active Directory Federation Services (ADFS) servers'
      - 'Remote Desktop Gateway servers'
      - 'VPN concentrators'
      - 'Microsoft 365 / Entra ID tenant'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "SEARCH failed_logons (EventID 4625) | STATS distinct_count(user) by source_ip over 1m | WHERE distinct_count(user) > 5 AND event_count > 10 AND is_external(source_ip) | ALERT"
  - question: 'Is the ratio of failed-to-successful logon attempts from any single external IP statistically significantly higher than the established baseline?'
    context: 'This question provides a more adaptive way to detect password spraying. Instead of fixed thresholds, it compares the behavior of a single IP to the normal behavior of all external traffic. An IP whose failure ratio is multiple standard deviations above the norm is highly suspect, even if the absolute number of failures is not high. This helps detect slower, more methodical attacks.'
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Domain Controllers'
      - 'Active Directory Federation Services (ADFS) servers'
      - 'Remote Desktop Gateway servers'
      - 'VPN concentrators'
      - 'Microsoft 365 / Entra ID tenant'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "CALCULATE failure_ratio per external_ip over 15m | COMPARE ratio to baseline_ratio(3_std_dev) | IF ratio > baseline AND involves > 3 users THEN ALERT"
  - question: 'Does an unsupervised machine learning model identify any anomalous clusters of authentication activity indicative of enumeration or password spraying?'
    context: "This question uses unsupervised learning to find novel or unusual attack patterns that don't fit predefined rules. By clustering authentication events based on features like source IP, number of target users, and timing between attempts, the model can automatically surface outliers that represent coordinated malicious activity without prior knowledge of the specific attack method."
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Domain Controllers'
      - 'Active Directory Federation Services (ADFS) servers'
      - 'Remote Desktop Gateway servers'
      - 'VPN concentrators'
      - 'Microsoft 365 / Entra ID tenant'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "RUN IsolationForest/DBSCAN on auth_log_features (source_ip, user_count, success_rate, timing_variance) | INVESTIGATE anomalous_clusters"
  - question: 'Has any single external IP address requested an unusually high number of pages from employee directory or contact-related sections of our website?'
    context: "This question targets a common method of harvesting email addresses: scraping public-facing employee directories. By setting a high threshold for requests to URIs containing keywords like '/staff/', '/profile/', or '/contact/' within a short time, we can pinpoint automated scraping activity aimed at collecting personnel information."
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek conn.log'
      - 'Zeek files.log'
      - 'Public-facing websites, especially those with employee directories, contact lists, or profile pages.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "SEARCH http_logs WHERE uri contains ('/profile/', '/staff/', '/contact/') AND is_external(source_ip) AND NOT is_benign_crawler(user_agent) | STATS count by source_ip over 5m | WHERE count > 100 | ALERT"
  - question: 'Are any external user sessions exceeding baseline thresholds for requests-per-minute and total pages viewed, while also showing signs of sequential URI traversal?'
    context: 'This question identifies sophisticated scrapers by looking at multiple behavioral indicators. It combines session-length anomalies (exceeding the 95th percentile for requests) with evidence of non-human navigation, such as systematically traversing URIs with minimal changes (low Levenshtein distance). This combination creates a strong signal for automated scraping.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek conn.log'
      - 'Zeek files.log'
      - 'Public-facing websites, especially those with employee directories, contact lists, or profile pages.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "FOR each external_session: IF requests_per_min > baseline_95p AND total_pages > baseline_95p AND avg_uri_levenshtein_dist < 2 THEN ALERT"
  - question: 'Can a session-based machine learning classifier identify any traffic sessions as malicious bots or scrapers?'
    context: 'This question applies machine learning at the session level to provide a holistic assessment of a visitor''s behavior. By training a model on features like request frequency, URI entropy, and timing, it can learn to distinguish between human users, benign bots, and malicious scrapers with high accuracy, enabling real-time classification and alerting.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek conn.log'
      - 'Zeek files.log'
      - 'Public-facing websites, especially those with employee directories, contact lists, or profile pages.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "FOR each session: CLASSIFY session with Random_Forest_model | IF classification is 'malicious_bot' or 'scraper' THEN ALERT"
  - question: 'Have we observed any failed authentication attempts from an IP address that was recently flagged for reconnaissance activity?'
    context: "This question directly links reconnaissance to a subsequent attack attempt. When an IP is flagged for scraping or using recon tools, it should be considered 'tainted'. Any authentication attempt, especially a failure, from that same IP within a follow-up window (e.g., 72 hours) is highly suspicious and indicates the adversary is now acting on the gathered intelligence."
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'HR Information System Data'
      - 'Domain Controllers'
      - 'ADFS servers'
      - 'VPN concentrators'
      - 'SIEM correlation environment'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "IF recon_alert(source_ip): MONITOR source_ip for 72h | IF failed_logon(source_ip) in 72h window THEN ESCALATE_ALERT"
  - question: 'Has any specific department or user group experienced a statistically significant increase in failed logon attempts compared to their 30-day moving average?'
    context: 'This question aims to detect targeted password spraying against a specific group within the organization (e.g., the Finance department). By enriching authentication logs with HR data and establishing a baseline of normal failed logons for each group, a sudden spike that exceeds several standard deviations from the average points to a focused attack, likely resulting from successful reconnaissance.'
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'HR Information System Data'
      - 'Domain Controllers'
      - 'ADFS servers'
      - 'VPN concentrators'
      - 'SIEM correlation environment'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "GROUP users by department | FOR each department: CALCULATE 30d_moving_avg(failed_logons) | IF current_failed_logons(1h) > moving_avg + 3_std_dev THEN ALERT"
  - question: 'Has a graph-based clustering algorithm detected a dense community of failed authentications linking one or more source IPs to a specific group of internal users?'
    context: 'This question uses advanced analytics to visualize and detect targeted attacks. By modeling authentication attempts as a graph, we can apply community detection algorithms to find unusually dense clusters of activity. Discovering a cluster where a few external IPs are connected to many internal users—who are later confirmed to be from the same department via HR data—provides powerful evidence of a targeted campaign.'
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'HR Information System Data'
      - 'Domain Controllers'
      - 'ADFS servers'
      - 'VPN concentrators'
      - 'SIEM correlation environment'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: "CREATE graph from auth_logs (nodes=users,ips; edges=failed_logons) | RUN Louvain_community_detection | INVESTIGATE dense clusters connecting external IPs to internal user communities"