name: T1132.002: Non-Standard Encoding
id: e8f9a0b1-c2d3-4e5f-6a7b-8c9d0e1f2a3b
description: This playbook helps investigate whether an adversary is using non-standard encoding for command and control (C2) communications. It focuses on identifying malicious activity by analyzing network traffic for several key indicators: JA3/JA3S hashes or HTTP headers matching known C2 frameworks; patterned data channels such as abnormally long, high-entropy DNS queries or custom HTTP headers; statistically anomalous ratios of sent-to-received bytes compared to historical baselines; outlier Shannon entropy scores within protocol fields like HTTP URIs or DNS queries; and correlating these network indicators with suspicious host-level process activity, such as processes running from temporary or user-writable directories.
type: technique
related:
  - TA0011: Command and Control
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has any network traffic matched known malicious JA3/JA3S hashes or HTTP header signatures from threat intelligence feeds?
    context: This question aims to detect known command and control (C2) frameworks that use non-standard encoding. By comparing observed network metadata (JA3/JA3S hashes and HTTP headers) against a curated list of malicious indicators, an analyst can quickly identify connections to known bad infrastructure without needing to inspect payload data.
    answer_sources:
      - Zeek ssl.log
      - Zeek http.log
      - Internet gateways
      - Web proxies
      - TLS-terminating load balancers
    range: last 90 days
    queries:
      - pseudocode: SEARCH Zeek ssl.log and http.log WHERE (ja3_hash IN threat_intel_watchlist) OR (http_headers IN threat_intel_watchlist)
  - question: Are there any rare JA3/JA3S hashes or HTTP User-Agents associated with persistent, beacon-like connections?
    context: This question helps uncover potentially new or unknown malicious clients by focusing on rarity. Legitimate software is typically widespread, while custom malware may only be present on a few compromised hosts. Identifying rare client signatures (JA3/JA3S, User-Agents) that also exhibit beaconing behavior (persistent, regular connections) can reveal covert C2 channels.
    answer_sources:
      - Zeek ssl.log
      - Zeek http.log
      - Internet gateways
      - Web proxies
      - TLS-terminating load balancers
    range: last 90 days
    queries:
      - pseudocode: CALCULATE frequency of ja3_hash and user_agent. FILTER for frequency < 5 hosts. CORRELATE with connection logs to FIND beaconing behavior.
  - question: Can we identify outlier client sessions that do not cluster with known good applications like Chrome or Firefox?
    context: This question uses unsupervised machine learning to find anomalous client behavior without relying on pre-existing signatures. By clustering sessions based on TLS and HTTP features, we can group common, legitimate clients together. Small, isolated clusters or individual outlier points often represent non-standard clients, which could be custom malware using unusual communication patterns.
    answer_sources:
      - Zeek ssl.log
      - Zeek http.log
      - Internet gateways
      - Web proxies
      - TLS-terminating load balancers
    range: last 90 days
    queries:
      - pseudocode: EXTRACT features from ssl.log and http.log. APPLY DBSCAN clustering. IDENTIFY and investigate small clusters or outliers.
  - question: Is any network traffic using known-bad custom HTTP headers associated with C2 frameworks, particularly in beaconing patterns?
    context: Adversaries often use custom HTTP headers to pass commands or data within seemingly normal web traffic. This question focuses on detecting specific, known-bad headers used by popular C2 frameworks. Correlating the presence of these headers with periodic, beacon-like connection patterns strengthens the evidence of a C2 channel.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Internal DNS resolvers
      - Web proxies
      - Egress firewalls
    range: last 90 days
    queries:
      - pseudocode: SEARCH http.log FOR known_bad_headers. CORRELATE with conn.log to FIND beaconing behavior.
  - question: Are any internal hosts generating DNS queries with unusually long, high-entropy, and fixed-length names?
    context: This question aims to detect DNS tunneling, a technique where data is encoded into DNS query names. Such traffic often exhibits distinct statistical properties: high entropy (random-looking data), long query names (to carry more data), and low standard deviation in length (fixed-size chunks). Identifying hosts that generate DNS queries with this combination of characteristics is a strong indicator of a covert data channel.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Internal DNS resolvers
      - Web proxies
      - Egress firewalls
    range: last 90 days
    queries:
      - pseudocode: CALCULATE stats (stdev_length, avg_entropy, avg_length) for DNS queries per host over 1 hour. ALERT if stdev_length < 1.0 AND avg_length > 32 AND avg_entropy > 3.5.
  - question: Can a machine learning model classify any outbound DNS queries as malicious based on features associated with DGA or DNS tunneling?
    context: This question leverages a supervised machine learning approach to proactively identify malicious DNS activity. By training a classifier on the structural features of known-bad and known-good DNS queries (e.g., length, entropy, character ratios), the model can learn to distinguish between them and score new, unseen queries in real-time. This provides a more sophisticated and adaptable detection method than static rules.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Internal DNS resolvers
      - Web proxies
      - Egress firewalls
    range: last 90 days
    queries:
      - pseudocode: TRAIN classifier on labeled DNS data. DEPLOY model to score real-time DNS queries. ALERT on high-confidence malicious classifications.
  - question: Are there any connections to known-bad IPs where the amount of data sent is significantly greater than the data received?
    context: This question helps identify data exfiltration or non-standard C2 heartbeats over common web ports. A highly asymmetric data ratio (many bytes sent, few received) is abnormal for typical web browsing or DNS lookups. When this anomaly is directed at an IP address already flagged by threat intelligence, it becomes a high-confidence indicator of malicious activity.
    answer_sources:
      - Zeek conn.log
      - Internet gateways
      - Internal network core switches
      - Firewall egress points
    range: last 90 days
    queries:
      - pseudocode: SEARCH conn.log WHERE (dest_port IN [80, 443, 53]) AND (orig_bytes > 10 * resp_bytes) AND (dest_ip IN threat_intel_watchlist).
  - question: Are there any network connections with a sent-to-received byte ratio that is a statistical outlier compared to the historical baseline for that port?
    context: This question uses historical data to define 'normal' behavior for a given network service (port) and then flags significant deviations. By establishing a baseline for the ratio of uploaded to downloaded bytes, this method can detect anomalous data transfers without relying on known-bad indicators. A connection that is statistically unusual in this manner is a strong candidate for investigation.
    answer_sources:
      - Zeek conn.log
      - Internet gateways
      - Internal network core switches
      - Firewall egress points
    range: last 90 days
    queries:
      - pseudocode: CALCULATE baseline (mean, stdev) of (orig_bytes / resp_bytes) per port over 30 days. ALERT on new connections where ratio > (mean + 3 * stdev).
  - question: Has any host exhibited a sudden, unforeseen spike in outbound data transfer that deviates from its predicted normal behavior?
    context: This question aims to detect anomalous data exfiltration by modeling the typical outbound traffic patterns for each individual host. Using a time-series forecasting model, we can predict the expected range of outbound data for any given hour. An actual data volume that significantly exceeds this prediction (i.e., falls outside the upper confidence interval) suggests a new, unexpected activity, such as a large data upload, that warrants investigation.
    answer_sources:
      - Zeek conn.log
      - Internet gateways
      - Internal network core switches
      - Firewall egress points
    range: last 90 days
    queries:
      - pseudocode: MODEL time series of outbound bytes per host. ALERT when actual hourly bytes > predicted upper confidence interval.
  - question: Are any HTTP requests, particularly POST requests, using long, Base64-encoded strings in the URI?
    context: This question targets a common C2 technique where data is exfiltrated by encoding it with Base64 and placing it in the URI of an HTTP request. Legitimate URIs are rarely long and Base64-encoded. Finding such a pattern, especially within a POST request (which is typically used for uploading data), is a strong signal of a covert data channel.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxies
      - Internal DNS resolvers
      - Internet gateways
    range: last 90 days
    queries:
      - pseudocode: SEARCH http.log WHERE uri matches regex for long Base64 strings. PRIORITIZE if http_method is 'POST'.
  - question: Is the Shannon entropy of any HTTP URI or DNS query a statistical outlier compared to the 99th percentile of recent historical data?
    context: This question seeks to identify encoded or encrypted data hidden within unencrypted protocol fields (HTTP URIs, DNS queries). Such data appears random and has high entropy compared to normal, human-readable text. By establishing a dynamic baseline (the 99th percentile) of entropy from recent traffic, this method can automatically flag new requests that are unusually random, indicating potential C2 communication.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxies
      - Internal DNS resolvers
      - Internet gateways
    range: last 90 days
    queries:
      - pseudocode: CALCULATE 99th percentile entropy for URI and DNS query fields over 30 days. ALERT in real-time if new entry's entropy > threshold.
  - question: Can an anomaly detection model, trained only on known-good traffic, identify any HTTP URIs or DNS queries as anomalous based on their entropy scores?
    context: This question uses a one-class machine learning model to define a boundary around 'normal' entropy levels for HTTP and DNS traffic. The model is trained exclusively on data known to be benign. Any new data point that falls outside this learned boundary is flagged as an anomaly. This is a powerful technique for detecting novel threats, as it does not require prior knowledge of malicious patterns, only a solid baseline of what is considered normal.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxies
      - Internal DNS resolvers
      - Internet gateways
    range: last 90 days
    queries:
      - pseudocode: TRAIN One-Class SVM on entropy scores from known-good traffic. DEPLOY model to score new events. ALERT on events flagged as anomalies.
  - question: Is a living-off-the-land binary (like powershell.exe) running from a user-writable path and making a network connection to a known-bad IP address?
    context: This question links suspicious host activity with suspicious network activity. Adversaries often use legitimate system tools ('living-off-the-land' binaries) to evade detection. When such a tool is executed from an unusual location (like a user's download folder) and communicates with an IP on a threat intel list, it is a very strong indicator of compromise. Correlating process creation and network connection events is key to this detection.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - User workstations
      - Critical application servers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: JOIN Event ID 4688 and 5156 on Process ID. ALERT if process_name IN ['powershell.exe', 'rundll32.exe', 'mshta.exe'] AND path is user-writable AND remote_ip IN threat_intel_watchlist.
  - question: Is any outbound network connection being initiated by an application from an executable path that is rare across the enterprise?
    context: This question helps find malware by identifying the rarity of the process that is making a network connection. Most legitimate applications (e.g., browsers, office suites) will be found on many systems. A process that initiates network traffic but exists on only a handful of endpoints is suspicious. The suspicion level is higher if the process is running from a temporary or user-specific directory, as this is a common location for malware to be dropped.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - User workstations
      - Critical application servers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: CALCULATE frequency of application paths from Event ID 5156. ALERT if frequency < 10 hosts. PRIORITIZE if path is in temp/user directory.
  - question: Can a machine learning model, trained on both host and network features, classify any new outbound connections as malicious with high confidence?
    context: This question represents a sophisticated, holistic approach to detection by combining host and network telemetry. By training a model on features like the process path, parent process, connection duration, and data volumes, the system can learn the complex patterns that differentiate malicious from benign activity. This integrated view allows for more accurate and resilient detection than analyzing host or network data in isolation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - User workstations
      - Critical application servers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: JOIN host events (process path, parent) and network events (data volume, duration). TRAIN classifier on labeled data. DEPLOY model to score new connections. ALERT if score > 0.9.