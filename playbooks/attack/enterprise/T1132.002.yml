name: "T1132.002: Non-Standard Encoding"
id: "9e8a7f6d-5c4b-4a3e-8d2f-1c0b9a8e7d6f"
description: "This playbook focuses on detecting adversary command and control (C2) communications that use non-standard encoding to evade detection. It provides investigative questions and queries to identify these covert channels by analyzing network traffic for various indicators. These include matching traffic against threat intelligence feeds of known malicious fingerprints (JA3/JA3S, HTTP headers), detecting statistical anomalies in data patterns (high entropy, unusual data volume ratios, patterned DNS queries), and correlating suspicious network activity with host-level process execution data (e.g., processes running from rare or temporary file paths)."
type: "technique"
related:
  - "TA0011: Command and Control"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Are we observing JA3/JA3S hashes or HTTP headers that match known malicious C2 frameworks?"
    context: "Threat intelligence provides a high-fidelity way to detect known threats by matching specific network fingerprints (JA3/JA3S for TLS, headers for HTTP) against a curated list of malicious indicators. A match suggests a direct connection to a known C2 infrastructure."
    answer_sources:
      - "Zeek ssl.log"
      - "Zeek http.log"
      - "Internet gateways, Web proxies, TLS-terminating load balancers"
      - "Threat intelligence feed"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH Zeek ssl.log and http.log WHERE (ja3_hash IN threat_intel_watchlist) OR (http_headers IN threat_intel_watchlist)"
  - question: "Are there any rare JA3/JA3S hashes or User-Agent strings associated with beacon-like activity?"
    context: "Attackers often use custom or uncommon clients, resulting in network fingerprints that are rare within an enterprise. Identifying these rare indicators, especially when they exhibit periodic, automated 'beaconing' behavior, can uncover novel or customized C2 channels that are not yet in threat intelligence feeds."
    answer_sources:
      - "Zeek ssl.log"
      - "Zeek http.log"
      - "Internet gateways, Web proxies, TLS-terminating load balancers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE population frequency of JA3/JA3S hashes and User-Agents. ISOLATE values seen on < 5 hosts. ANALYZE traffic patterns for those hosts for beaconing."
  - question: "Can we use unsupervised machine learning to identify anomalous client sessions that deviate from known good browser traffic?"
    context: "By converting TLS and HTTP session properties into numerical features, machine learning algorithms can automatically cluster sessions. Sessions that do not fit into large, well-understood clusters (like standard web browsers) are outliers and may represent non-standard C2 clients that require investigation."
    answer_sources:
      - "Zeek ssl.log"
      - "Zeek http.log"
      - "Internet gateways, Web proxies, TLS-terminating load balancers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FEATURE_ENGINEER Zeek logs into numerical vectors. APPLY DBSCAN clustering. INVESTIGATE small clusters and outlier points."
  - question: "Is any network traffic using custom HTTP headers known to be associated with C2 frameworks, especially if it exhibits beaconing behavior?"
    context: "Malware often uses unique, non-standard HTTP headers to communicate with its C2 server. Detecting these specific headers, particularly when combined with the rhythmic, periodic connection patterns of C2 beaconing, provides strong evidence of a malicious implant."
    answer_sources:
      - "Zeek http.log"
      - "Zeek conn.log"
      - "Internal DNS resolvers, Web proxies, Egress firewalls"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH http.log for known-bad custom headers (e.g., 'X-Config'). CORRELATE positive results with periodic connections in conn.log from the same source IP."
  - question: "Are there any DNS queries that suggest a data channel, characterized by long, high-entropy, and fixed-length query names?"
    context: "DNS tunneling is a technique where data is encoded into DNS queries. This often manifests as queries that are unusually long, contain random-looking characters (high entropy), and have a consistent length (low standard deviation). Identifying hosts making such queries can reveal covert C2 communication."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Web proxies, Egress firewalls"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each source IP, CALCULATE stats on DNS queries over 1-hour windows. ALERT if (std_dev(length) < 1.0) AND (avg(length) > 32) AND (avg(entropy) > 3.5)."
  - question: "Can we use a machine learning classifier to distinguish between legitimate DNS traffic and malicious DNS tunneling or DGA queries?"
    context: "By training a model on the statistical properties of known-good and known-bad DNS queries (e.g., length, entropy, character ratios), we can create an automated system to score and flag new, unseen queries that are likely malicious, providing a scalable way to detect sophisticated DNS-based C2."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Web proxies, Egress firewalls"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "TRAIN a Random Forest classifier on labeled DNS query features. DEPLOY model to score outbound DNS queries in real-time. ALERT on high-confidence malicious classifications."
  - question: "Are there any connections to known malicious IPs on common ports (80, 443, 53) where the amount of data sent is anomalously higher than the data received?"
    context: "A significantly imbalanced ratio of uploaded to downloaded data, especially on ports typically used for browsing, can indicate data exfiltration or a non-standard communication protocol. When the destination is a known-bad IP from a threat feed, this is a high-confidence indicator of compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Internet gateways, Internal network core switches, Firewall egress points"
      - "Threat intelligence feed"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH conn.log WHERE (orig_bytes > 10 * resp_bytes) AND (dest_port IN [80, 443, 53]) AND (dest_ip IN threat_intel_blocklist)."
  - question: "Are there any network connections where the ratio of sent-to-received bytes is a statistical outlier compared to the historical baseline for that destination port?"
    context: "This approach moves beyond fixed thresholds to find what is anomalous for a specific environment. By establishing a normal baseline for data flow ratios on different ports, we can detect deviations that might signal C2 heartbeats or data exfiltration, even to unknown destinations. A connection that is a statistical outlier (e.g., more than 3 standard deviations from the mean) warrants investigation."
    answer_sources:
      - "Zeek conn.log"
      - "Internet gateways, Internal network core switches, Firewall egress points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE historical mean and std_dev of (orig_bytes / resp_bytes) per port over 30 days. ALERT on new connections where the ratio > (mean + 3 * std_dev) for its port."
  - question: "Has any host exhibited a sudden, unexpected spike in outbound data transfer that cannot be explained by historical patterns?"
    context: "Time-series forecasting models can learn the normal rhythm of a host's network activity. When the actual amount of data sent by a host significantly exceeds the model's prediction, it indicates an anomalous event. This could be the start of a large data exfiltration or a change in C2 behavior."
    answer_sources:
      - "Zeek conn.log"
      - "Internet gateways, Internal network core switches, Firewall egress points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "MODEL time series of outbound bytes per hour for each host. ALERT if actual outbound bytes > predicted 99% confidence interval."
  - question: "Are there any long, Base64-encoded strings present in HTTP request URIs, particularly in POST requests?"
    context: "Adversaries often encode data or commands within the URI of an HTTP request to bypass simple signature-based detection. Base64 is a common encoding scheme. Searching for long, Base64-like patterns, especially in POST requests which are used for uploading data, can uncover this covert communication channel."
    answer_sources:
      - "Zeek http.log"
      - "Web proxies, Internal DNS resolvers, Internet gateways"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH http.log WHERE uri MATCHES_REGEX 'base64_pattern' AND length(uri) > 50. PRIORITIZE where http_method is 'POST'."
  - question: "Are we observing HTTP URIs or DNS queries with entropy scores that are statistical outliers compared to our environment's baseline?"
    context: "Shannon entropy measures the randomness or unpredictability of data. Encoded or encrypted data has high entropy compared to normal text. By establishing a dynamic baseline (e.g., the 99th percentile) for entropy in fields like URIs and DNS queries, we can create a high-fidelity alert for any new request that exceeds this threshold, indicating potentially encoded C2 data."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Web proxies, Internal DNS resolvers, Internet gateways"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE 99th percentile of entropy for URI and DNS query fields from last 30 days. ALERT if new event's entropy > this threshold."
  - question: "Can we use an anomaly detection model, trained only on known-good traffic, to identify HTTP URIs or DNS queries with abnormal entropy scores?"
    context: "One-Class SVM is a machine learning algorithm ideal for anomaly detection. By training it exclusively on the entropy characteristics of legitimate traffic, it learns to define a 'normal' boundary. Any future traffic that falls outside this boundary is flagged as an anomaly, providing a powerful way to detect novel or unknown encoding techniques without needing examples of malicious traffic."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Web proxies, Internal DNS resolvers, Internet gateways"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "TRAIN a One-Class SVM model on entropy scores from a baseline of good traffic. DEPLOY model to score new events and flag anomalies."
  - question: "Are suspicious processes like 'powershell.exe' or 'rundll32.exe', running from user-writable locations, making network connections to known malicious destinations?"
    context: "Linking a network connection (Event 5156) to the process that created it (Event 4688) provides critical context. When a 'living-off-the-land' binary (LOLBin) initiates a connection from an unusual path (e.g., a user's download folder) to an IP on a threat list, it is a very strong indicator of malicious execution."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "User workstations, Critical application servers, Domain Controllers"
      - "Threat intelligence feed"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "JOIN WinEvent:4688 with WinEvent:5156 on ProcessID. ALERT WHERE (ProcessName IN ['powershell.exe', 'rundll32.exe']) AND (ProcessPath CONTAINS 'C:\\Users\\') AND (RemoteAddress IN threat_intel_blocklist)."
  - question: "Is any outbound network connection being initiated by an application running from a file path that is extremely rare across the enterprise?"
    context: "Malware is often dropped in temporary or user-specific directories, making its execution path rare. By identifying processes that make network connections from these statistically uncommon paths, we can hunt for previously unknown malware."
    answer_sources:
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "User workstations, Critical application servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE frequency of 'Application' path in WinEvent:5156 over 30 days. ALERT on connections where Application path is seen on < 10 endpoints."
  - question: "Can a machine learning model, trained on both host and network features, automatically identify and score malicious outbound connections with high confidence?"
    context: "This advanced analytic combines host-based indicators (process path, parent process) with network-based indicators (data volumes, duration) to create a rich feature set. A supervised model trained on this combined data can learn the complex patterns that distinguish malicious C2 from benign traffic, enabling automated detection with high accuracy."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "User workstations, Critical application servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "JOIN host events (process path) with network events (data volume). TRAIN a Gradient Boosting model on labeled dataset. DEPLOY model to score new connections and ALERT on confidence > 0.9."