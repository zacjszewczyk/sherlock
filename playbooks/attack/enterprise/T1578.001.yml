name: T1578.001: Create Snapshot
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary is creating cloud snapshots to evade defenses or prepare for data exfiltration. The playbook identifies suspicious snapshot creation through several indicators, including API calls from malicious IPs or with rare User-Agents, execution of snapshot commands via endpoint CLI tools, rapid permission changes to make snapshots public, creation by unauthorized or first-time users, and creation that is temporally linked to other malicious precursor activities like credential dumping or discovery.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: "Has a cloud snapshot creation API call been initiated from a known malicious IP address?"
    context: "This question aims to detect snapshot creation activities originating from IP addresses listed in threat intelligence feeds. Such activity is a strong indicator of an external attacker who has compromised credentials and is now using them to create snapshots, potentially for data exfiltration or to create a backup of a system before making destructive changes."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Zeek conn.log
      - Zeek http.log
      - Zeek dns.log
      - Threat Intelligence Feeds
      - Cloud Management Plane
      - Internet Gateway
      - DNS Resolvers
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "JOIN (cloud_api_logs WHERE action='create_snapshot') OR (network_logs WHERE destination_is_cloud_api) WITH threat_intel_feed ON source_ip;"
  - question: "Is a cloud snapshot being created using a User-Agent string that is rare or unseen in the environment?"
    context: "Adversaries may use custom scripts or non-standard tools to interact with cloud APIs, which often result in unique or infrequent User-Agent strings. This question helps identify such anomalies by baselining normal User-Agent frequencies and flagging outliers. A rare User-Agent associated with a snapshot creation event could indicate the use of a malicious tool."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Zeek http.log
      - Cloud Management Plane
      - Internet Gateway
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "CALCULATE frequency of user_agent in snapshot_creation_logs over a 30-day baseline; ALERT if user_agent_frequency < 1st_percentile;"
  - question: "Does a cloud snapshot creation event exhibit a combination of anomalous characteristics (source ASN, geolocation, User-Agent, IAM role) when compared to historical norms?"
    context: "This question uses a machine learning model to detect subtle deviations from normal behavior that might be missed by simple statistical checks. By analyzing multiple features together (like the user, their location, and the tool they're using), the model can identify sophisticated attacks where an adversary attempts to blend in but deviates in several minor ways that collectively form a significant anomaly."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Cloud Management Plane
      - Internet Gateway
      - DNS Resolvers
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SCORE snapshot_creation_event using one-class_svm_model(features=[source_asn, geo, user_agent, iam_role]); ALERT if anomaly_score is high;"
  - question: "Was a process executed on an endpoint with command-line arguments indicating the creation or modification of a cloud snapshot?"
    context: "This question searches for direct evidence of an adversary using command-line interface (CLI) tools (like aws.exe, az.cmd, gcloud.cmd) on a compromised host to manage snapshots. Detecting the specific commands used for creating, modifying, or sharing snapshots can provide high-fidelity alerts about malicious activity."
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Administrator Workstations
      - CI/CD Pipeline Servers
      - Developer Endpoints
      - Jump Boxes/Bastion Hosts
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SEARCH process_creation_logs WHERE command_line MATCHES REGEX ('aws ec2 create-snapshot', 'az snapshot create', 'gcloud compute snapshots create', 'modify-snapshot-attribute');"
  - question: "Did a cloud CLI command related to snapshots have an unusually complex or random set of arguments, potentially indicating obfuscation?"
    context: "Adversaries might use obfuscated scripts or long, complex one-liners to execute commands, which can result in a higher-than-normal Shannon entropy for the command-line string. This question establishes a baseline for command-line entropy for specific user-host pairs and flags significant deviations, which could indicate an attempt to hide malicious actions."
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Administrator Workstations
      - CI/CD Pipeline Servers
      - Developer Endpoints
      - Jump Boxes/Bastion Hosts
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "CALCULATE shannon_entropy of command_line for cloud_cli_processes; ALERT if entropy > 3 * stdev(baseline_entropy) for user_host_pair;"
  - question: "Can the command-line arguments used with a cloud CLI tool be classified as suspicious by a natural language processing (NLP) model?"
    context: "This question applies advanced NLP techniques to understand the intent behind a command line, beyond simple keyword matching. A pre-trained model can differentiate between benign administrative commands and those structured in a way that suggests malicious intent, such as preparation for data exfiltration or defense evasion, providing a more nuanced detection capability."
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Administrator Workstations
      - CI/CD Pipeline Servers
      - Developer Endpoints
      - Jump Boxes/Bastion Hosts
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "CLASSIFY command_line using NLP_model; ALERT if classification is 'suspicious-snapshot-command' with high_confidence;"
  - question: "Was a newly created cloud snapshot made public or shared with an unknown external account shortly after its creation?"
    context: "A common adversary tactic is to create a snapshot and then immediately change its permissions to make it accessible for exfiltration. This question uses a correlation rule to detect this specific sequence of events—a 'create' followed by a 'modify permissions' action on the same resource within a short time window (e.g., 15 minutes)—which is highly indicative of malicious activity."
    answer_sources:
      - AWS CloudTrail (CreateSnapshot, ModifySnapshotAttribute)
      - Azure Activity Logs (Microsoft.Compute/snapshots/write, Microsoft.Compute/snapshots/beginGetAccess/action)
      - Google Cloud Audit Logs (compute.snapshots.insert, compute.snapshots.setIamPolicy)
      - Cloud Management Plane
      - Cloud IAM Service
      - Cloud Storage Services
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "CORRELATE create_snapshot_event with modify_snapshot_permissions_event on same_resource_id within 15 minutes; ALERT if shared with 'public' or non-allowlisted_account;"
  - question: "Did a user create and then share or copy a snapshot in an unusually short amount of time compared to their normal behavior?"
    context: "While administrators may perform these actions, automated scripts used by attackers often execute them much faster than a human would. This question establishes a baseline for the time delta between snapshot creation and sharing/copying for each user. A significantly shorter-than-usual time delta can indicate automated, and therefore potentially malicious, activity."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Cloud Management Plane
      - Cloud IAM Service
      - Cloud Storage Services
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "CALCULATE time_delta between create and share/copy events per user; ALERT if time_delta < 5th_percentile of user's historical distribution;"
  - question: "Does the sequence of API calls leading to snapshot creation and sharing deviate from established normal administrative workflows?"
    context: "This question models entire administrative sessions as sequences of events using a Hidden Markov Model (HMM). The model learns what normal sequences look like. An alert is generated when a sequence of API calls, such as 'create-snapshot' followed by 'share-publicly', has a low probability of occurring based on the learned model, indicating it is not a standard, legitimate workflow."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Cloud Management Plane
      - Cloud IAM Service
      - Cloud Storage Services
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SCORE api_call_sequence using HMM; ALERT if sequence containing 'create-snapshot' -> 'share-publicly' has low probability;"
  - question: "Was a snapshot created by a user or role not explicitly authorized to do so, or is this the first time this user has ever performed this action?"
    context: "This question helps enforce security policies and detect privilege escalation or credential misuse. It checks if the user/role creating a snapshot is on a pre-defined allow-list. Additionally, it flags the very first time any user performs this action, as this 'first seen' behavior could represent a new administrator's legitimate first action or an attacker's first use of a compromised account."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Cloud IAM Service
      - Cloud Management Plane
      - Authentication Servers
      - VPN Concentrators
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "ALERT if user/role NOT IN snapshot_creator_allowlist; Also, ALERT on 'first-seen' snapshot creation for any user;"
  - question: "Did a snapshot creation event originate from a source ASN or occur at a time of day that is anomalous for that specific user?"
    context: "This question builds a behavioral baseline for each administrative user, profiling their typical source locations (ASN, subnets) and working hours. An alert is triggered when a snapshot is created by a user, but the context (e.g., coming from a new country's ASN, happening at 3 AM for a 9-to-5 user) deviates significantly from their established pattern, suggesting account compromise."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Windows Event ID 4624
      - Zeek conn.log
      - Cloud IAM Service
      - Cloud Management Plane
      - Authentication Servers
      - VPN Concentrators
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "PROFILE user activity (source_asn, time_of_day) over 90 days; ALERT if snapshot_creation_event has new ASN and occurs in zero-activity time bucket;"
  - question: "Does a snapshot creation event register as a significant anomaly based on a model of the user's typical behavior across multiple features (IP, User Agent, Time)?"
    context: "This question employs an Isolation Forest model, an effective algorithm for anomaly detection, to score snapshot creation events. The model learns a user's normal multi-dimensional behavior. An event that is easily 'isolated' by the model is considered an anomaly, indicating a deviation from the user's established patterns and warranting investigation for potential account takeover."
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - Google Cloud Audit Logs
      - Cloud IAM Service
      - Cloud Management Plane
      - Authentication Servers
      - VPN Concentrators
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SCORE snapshot_creation_event using Isolation Forest model trained on user's historical activity; ALERT if anomaly score is high;"
  - question: "Did a snapshot creation event occur on a host shortly after other high-confidence suspicious activities, such as credential dumping or malware download?"
    context: "This question links snapshot creation to the broader attack lifecycle. By using a multi-stage correlation rule, it connects a potentially legitimate action (snapshot creation) with a definitively malicious precursor event (e.g., Mimikatz execution, access to lsass.exe). This contextual link elevates the priority of the snapshot event, treating it as a likely part of a larger intrusion."
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 10
      - Zeek conn.log
      - Zeek files.log
      - Endpoint Devices
      - CI/CD Pipeline Servers
      - Internet Gateway
      - Internal Network Segments
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "CORRELATE high-confidence_precursor_alert (e.g., credential_dumping) with subsequent snapshot_creation_command from same_host within 24 hours;"
  - question: "Did a snapshot creation event occur on a host that has accumulated a high risk score from other suspicious activities within the last 24 hours?"
    context: "This question operationalizes the idea of 'death by a thousand cuts'. Instead of relying on a single high-fidelity indicator, it assigns risk points to various lower-confidence suspicious events (e.g., running discovery commands, downloading new tools). If a snapshot creation occurs on a host that has crossed a risk score threshold, it is escalated for review, contextualizing the action within a pattern of suspicious behavior."
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 10
      - Zeek conn.log
      - Zeek files.log
      - Endpoint Devices
      - CI/CD Pipeline Servers
      - Internet Gateway
      - Internal Network Segments
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SUM risk_points for host events over 24h; IF snapshot_creation_occurs on host AND host_risk_score > 95th_percentile, ALERT;"
  - question: "Can a machine learning model classify the sequence of events preceding a snapshot creation as malicious?"
    context: "This question uses a powerful classification model (Gradient Boosting) to analyze a time-window of host and network events leading up to a snapshot creation. The model is trained to recognize patterns of precursor activities (discovery, credential access, tool download) that are indicative of a malicious campaign. It provides a probabilistic score on whether the snapshot creation is part of a malicious sequence."
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 10
      - Zeek conn.log
      - Zeek files.log
      - Endpoint Devices
      - CI/CD Pipeline Servers
      - Internet Gateway
      - Internal Network Segments
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "PREDICT probability of maliciousness for event_sequence_preceding_snapshot using Gradient_Boosting_model; ALERT if probability is high;"