name: T1597.002: Purchase Technical Data
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: |
  This playbook helps identify adversaries who have purchased technical data, such as credentials or infrastructure details, and are using it to perform reconnaissance or gain initial access. It provides investigative questions to detect various attack vectors, including the use of breached credentials in authentication attempts, spikes in network scanning following threat intelligence reports of data sales, targeted port probing against non-public services, impossible travel logins, exploit attempts against vulnerable internal applications, and anomalous data access in cloud environments following a suspicious login.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is an account from a known data breach attempting to authenticate on our network?
    context: |
      This question uses a symbolic matching approach to provide a direct alert when a known compromised credential is used. By comparing active login attempts against a continuously updated threat intelligence feed of breached usernames and hashes, we can immediately identify and respond to the most basic form of credential stuffing or password reuse, which are common follow-on actions after an adversary purchases technical data.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Threat Intelligence Feed (Breached Credentials)
      - Authentication servers (Domain Controllers, ADFS)
      - VPN Concentrators
      - Cloud Identity Providers (e.g., Azure AD)
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH authentication_logs (EventID=4624 OR EventID=4625) 
          | JOIN username with breached_credential_database 
          | ALERT if match_found
  - question: Is a breached account experiencing an unusually high number of failed logins, possibly indicating a password spray attack?
    context: |
      This question applies statistical analysis to accounts already identified as compromised. By establishing a baseline for normal failed login activity per user, we can detect significant deviations. An account exceeding its 95th percentile of failed logins from distinct IPs suggests a targeted, automated attack like password spraying, moving beyond a simple one-off attempt to a more persistent effort to gain access.
    answer_sources:
      - Windows Event ID 4625
      - Threat Intelligence Feed (Breached Credentials)
      - Authentication servers (Domain Controllers, ADFS)
      - VPN Concentrators
      - Cloud Identity Providers (e.g., Azure AD)
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH failed_logins (EventID=4625) WHERE username IN breached_credential_list 
          | GROUPBY username, source_ip 
          | CALCULATE daily_failed_count 
          | ALERT if daily_failed_count > 95th_percentile_baseline
  - question: Can we use machine learning to determine if a successful login by a known breached account is suspicious based on its behavioral context?
    context: |
      This question leverages a machine learning model to add a layer of intelligence to successful logins from breached accounts. A successful login isn't always malicious (the user may have changed their password), but a model can assess contextual features like time, location, and ASN to determine the likelihood of compromise. A high confidence 'suspicious' classification provides a strong signal for immediate incident response, filtering out benign activity.
    answer_sources:
      - Windows Event ID 4624
      - Threat Intelligence Feed (Breached Credentials)
      - Authentication servers (Domain Controllers, ADFS)
      - VPN Concentrators
      - Cloud Identity Providers (e.g., Azure AD)
    range: last 90 days
    queries:
      - pseudocode: |
          INPUT successful_logins (EventID=4624) 
          | ENRICH with geolocation, ASN, breach_status 
          | APPLY logistic_regression_model 
          | ALERT if classification='suspicious' AND confidence > 0.8
  - question: Are we seeing network or authentication activity from indicators of compromise (IOCs) mentioned in a recent threat intelligence report about our data being for sale?
    context: |
      This question provides a direct, time-sensitive response to specific threat intelligence. When a report indicates that an organization's data has been sold, it often includes IOCs associated with the threat actor. This rule-based approach immediately checks for any interaction from these specific malicious IPs or domains, providing the fastest possible confirmation that the threat actor is now acting on the purchased data.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4625
      - Threat Intelligence Report
      - Internet Gateways
      - Demilitarized Zone (DMZ) Servers
      - Threat Intelligence Platforms
    range: last 7 days
    queries:
      - pseudocode: |
          SEARCH (network_connections OR failed_logins) within 7_days_of_intel_report 
          | WHERE source_ip IN intel_report_iocs 
          | ALERT on match
  - question: Has there been a statistically significant increase in scanning or failed logins shortly after we learned our technical data was sold?
    context: |
      This question moves beyond specific IOCs to detect broader anomalous patterns. Adversaries may not use the exact IOCs from a report. By establishing a rolling baseline of normal network traffic and authentication failures, a change point detection algorithm can identify a sudden, significant shift in activity. An alert within 72 hours of an intelligence report strongly suggests a causal link and indicates the start of a reconnaissance or access campaign.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4625
      - Threat Intelligence Report
      - Internet Gateways
      - Demilitarized Zone (DMZ) Servers
      - Threat Intelligence Platforms
    range: last 30 days
    queries:
      - pseudocode: |
          MONITOR timeseries_of_connection_attempts AND failed_logins 
          | APPLY CUSUM_algorithm 
          | ALERT if significant_upward_change_detected within 72_hours_of_intel_report
  - question: Is the current volume of scanning traffic or authentication failures exceeding the levels predicted by a machine learning forecasting model?
    context: |
      This question uses a more sophisticated statistical method, time series forecasting (e.g., SARIMA), to predict expected traffic volumes, accounting for seasonality and trends. When the actual observed traffic significantly and persistently exceeds the model's 99% confidence interval, it provides a high-fidelity alert that is less prone to false positives from normal fluctuations. This is particularly powerful when contextualized with a recent intelligence trigger.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4625
      - Threat Intelligence Report
      - Internet Gateways
      - Demilitarized Zone (DMZ) Servers
      - Threat Intelligence Platforms
    range: last 90 days
    queries:
      - pseudocode: |
          FORECAST expected_traffic_volume using SARIMA_model 
          | COMPARE actual_volume with forecast_confidence_interval 
          | ALERT if actual_volume > upper_99_percent_CI for >1_hour post-intel_trigger
  - question: Is an external entity successfully connecting to internal services that are not supposed to be public-facing?
    context: |
      This question uses a simple but effective list-based approach. By maintaining an accurate inventory of authorized public services and ports, any successful connection to a port not on that list is inherently suspicious. This can reveal misconfigurations or targeted attempts to access internal-only services, a common action after an adversary has purchased infrastructure data.
    answer_sources:
      - Zeek conn.log
      - Asset Inventory Database
      - Windows Event ID 3
      - Network Taps at Internet Egress/Ingress Points
      - Firewall Log Aggregators
      - Critical Servers
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH successful_connections (conn_state='SF') 
          | WHERE destination_port NOT IN public_services_list 
          | ALERT on match
  - question: Is an external IP address scanning a small, specific set of ports rather than scanning randomly across the internet?
    context: |
      This question uses Shannon entropy to differentiate between random internet noise and targeted reconnaissance. Random port scanning has high entropy, while an adversary who has purchased technical data will probe a small, specific set of ports, resulting in low entropy. Alerting on IPs with entropy below a baseline threshold helps identify attackers who are deliberately testing specific services they believe to be present.
    answer_sources:
      - Zeek conn.log
      - Asset Inventory Database
      - Windows Event ID 3
      - Network Taps at Internet Egress/Ingress Points
      - Firewall Log Aggregators
      - Critical Servers
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each source_ip in 5min_window 
          | CALCULATE shannon_entropy of destination_ports 
          | ALERT if entropy < 5th_percentile_of_baseline
  - question: Can we use clustering to automatically identify small, coordinated groups of anomalous connections that indicate a targeted scan?
    context: |
      This question applies an unsupervised machine learning algorithm (DBSCAN) to group network connections based on their attributes. The vast majority of traffic will form a large 'background noise' cluster. Small, dense clusters that are separate from this main group represent anomalous, coordinated activity, such as a single actor scanning a specific subnet or service. This method can uncover stealthy scans that might be missed by simple thresholding.
    answer_sources:
      - Zeek conn.log
      - Asset Inventory Database
      - Windows Event ID 3
      - Network Taps at Internet Egress/Ingress Points
      - Firewall Log Aggregators
      - Critical Servers
    range: last 90 days
    queries:
      - pseudocode: |
          INPUT connection_logs 
          | APPLY DBSCAN_clustering on (src_ip, dst_ip, dst_port) 
          | INVESTIGATE small, dense clusters flagged as 'noise' or separate from main cluster
  - question: Has a user successfully logged in from a high-risk or non-business-related country?
    context: |
      This question provides a basic, rule-based check for potentially suspicious logins. By maintaining a denylist of countries where the organization has no business presence or which are known sources of malicious activity, any successful login from these locations can be flagged for review. While prone to false positives (e.g., employee travel), it serves as a useful first-pass filter.
    answer_sources:
      - Windows Event ID 4624
      - IP Geolocation Database
      - Cloud Provider Audit Logs
      - Authentication Servers (Domain Controllers)
      - VPN Concentrators
      - Cloud Identity Providers (e.g., Azure AD)
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH successful_logins 
          | ENRICH source_ip with geolocation 
          | ALERT if country IN high_risk_denylist
  - question: Has a user account logged in from two different locations in a time frame that would require physically impossible travel speeds?
    context: |
      This question implements the classic 'impossible travel' or 'superman' detection. It is a high-fidelity indicator of credential compromise, as it's based on physical laws. By calculating the required speed between two consecutive successful login locations for a single user, we can definitively flag scenarios where an account is being used by two entities in different places simultaneously. This is a strong sign that purchased credentials are being actively used.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - IP Geolocation Database
      - Cloud Provider Audit Logs
      - Authentication Servers (Domain Controllers)
      - VPN Concentrators
      - Network Flow Collectors
      - Cloud Identity Providers (e.g., Azure AD)
    range: last 90 days
    queries:
      - pseudocode: |
          ON successful_login for user 
          | GET location_A, time_A 
          | GET previous_login location_B, time_B 
          | CALCULATE speed = distance(A,B) / (time_A - time_B) 
          | ALERT if speed > 600_mph
  - question: Does a user's successful login deviate significantly from their established behavioral profile of normal login activity?
    context: |
      This question uses machine learning to create a sophisticated behavioral baseline for each user, including their typical login times, source countries, and ASNs. An algorithm like Isolation Forest can then score new logins against this profile. A login that is flagged as a major outlier, even if it doesn't trigger a specific rule like impossible travel, is highly suspicious and warrants investigation. This can catch attackers using proxies or VPNs in countries not on a denylist but that are still anomalous for that specific user.
    answer_sources:
      - Windows Event ID 4624
      - IP Geolocation Database
      - Cloud Provider Audit Logs
      - Authentication Servers (Domain Controllers)
      - VPN Concentrators
      - Cloud Identity Providers (e.g., Azure AD)
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each user, build profile of (countries, ASNs, times) 
          | ON new_login 
          | APPLY Isolation_Forest_model 
          | ALERT if login is scored as significant outlier
  - question: Are we observing known exploit patterns targeting internal, non-public services that are known to be vulnerable?
    context: |
      This question correlates internal vulnerability data with real-time network traffic. An adversary who has purchased technical data may know about specific internal applications and their patch levels. This highly targeted symbolic rule alerts only when a known attack signature is seen targeting a specific internal service that the organization knows is unpatched, providing a very high-confidence alert that an active, targeted exploitation attempt is underway.
    answer_sources:
      - Zeek http.log
      - Zeek notice.log
      - Vulnerability Scan Data
      - Web Application Servers (DMZ and Internal)
      - Intrusion Detection System (IDS) Sensors
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH traffic_logs for known_exploit_patterns 
          | WHERE destination_service IN known_vulnerable_nonpublic_services_list 
          | ALERT on match
  - question: Is an external entity requesting extremely rare or unique URIs on our non-public web applications?
    context: |
      This question uses statistical rarity to uncover reconnaissance or exploitation of hidden application endpoints. Normal users access a common set of URIs. An attacker, however, will often probe for unlinked or forgotten pages, backup files, or administrative interfaces. A request for a URI that is statistically very rare (e.g., in the bottom 1% of all requests) is a strong indicator of enumeration or an attempt to access a non-standard entry point.
    answer_sources:
      - Zeek http.log
      - Web Application Servers (DMZ and Internal)
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each non-public_app 
          | BUILD frequency_distribution of URIs over 90_days 
          | ON new_request 
          | ALERT if requested_URI_frequency < 1st_percentile
  - question: Is a user session on a web application following a navigation path that is anomalous compared to normal user behavior?
    context: |
      This question models user interaction as a sequence of events. Machine learning models like LSTM autoencoders can learn the 'grammar' of normal user navigation flows. An attacker's session, which might involve forced browsing, directory traversal, or jumping between unrelated functions, will not conform to these learned patterns. A session that produces a high reconstruction error is anomalous and likely represents malicious activity rather than legitimate use.
    answer_sources:
      - Zeek http.log
      - Web Application Servers (DMZ and Internal)
    range: last 90 days
    queries:
      - pseudocode: |
          MODEL user_sessions as URI_sequences 
          | TRAIN LSTM_autoencoder on normal_sequences 
          | ON new_session 
          | CALCULATE reconstruction_error 
          | ALERT if error is high
  - question: Following a cloud login from a new country or ASN, is the user's machine making DNS requests for known data exfiltration or file-sharing sites?
    context: |
      This question creates a correlation rule to link a suspicious cloud login to potential data staging or exfiltration. A login from a new geographic location or network is a weak signal on its own, but when it is immediately followed by network activity to domains associated with malicious behavior (e.g., paste sites, anonymous file sharing), the combination becomes a strong indicator of an account compromise and active data theft.
    answer_sources:
      - Zeek dns.log
      - Cloud Provider Audit Logs
      - Cloud Log Aggregator (SIEM)
      - Cloud Identity Provider
    range: last 90 days
    queries:
      - pseudocode: |
          ON successful_cloud_login from new_country_or_ASN 
          | MONITOR source_ip for 1_hour 
          | ALERT if DNS_request for domain in exfil_domain_list
  - question: Has a user's daily data egress volume from a key cloud repository significantly exceeded their personal historical baseline?
    context: |
      This question focuses on detecting bulk data theft by establishing a personal baseline for each user's data access patterns. A sudden spike in data egress (e.g., more than 4 standard deviations above their moving average) is a classic sign of data exfiltration. This statistical alert is especially powerful when it occurs after an anomalous login event, connecting the suspicious access to the suspicious data movement.
    answer_sources:
      - Cloud Provider Audit Logs (e.g., AWS CloudTrail)
      - Cloud Log Aggregator (SIEM)
    range: last 30 days
    queries:
      - pseudocode: |
          FOR each user, calculate 30-day_moving_avg_and_std_dev of daily_data_egress 
          | ON new_day 
          | ALERT if daily_egress > (moving_avg + 4*std_dev)
  - question: Is a user's activity in the cloud significantly different from the typical activity of their peers with similar roles?
    context: |
      This question uses peer group analysis to provide contextual anomaly detection. A user's behavior might not be anomalous compared to their own history (e.g., if the account was just compromised), but it can be highly anomalous compared to others in the same role. For example, an HR employee suddenly accessing engineering code repositories is suspicious. This method flags deviations from the 'normal' for a specific job function, catching insider threats or compromised accounts being used for lateral movement and data access outside of their expected scope.
    answer_sources:
      - Cloud Provider Audit Logs
      - Cloud Log Aggregator (SIEM)
      - Cloud Identity Provider
    range: last 90 days
    queries:
      - pseudocode: |
          CLUSTER users into peer_groups based on role/activity 
          | CALCULATE centroid_profile for each group 
          | ON new_user_activity 
          | ALERT if activity deviates significantly from their group's centroid