name: "T1562.009: Safe Mode Boot"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps investigate attempts by an adversary to evade defenses by booting a system into Safe Mode. Adversaries modify boot configurations using tools like bcdedit.exe or by directly altering registry keys under HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SafeBoot\\. After forcing a reboot, the system starts in a degraded state where security software may not be running, allowing the adversary to execute payloads, establish persistence, or perform other malicious actions unimpeded. This playbook focuses on detecting the preparatory actions, the reboot itself, and the anomalous process and network activity that occurs post-reboot in the compromised environment."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a process been executed whose file hash matches a known malicious tool used for safe mode boot configuration?"
    context: "This question aims to identify the initial execution of known malicious tools. By correlating process execution events with threat intelligence feeds, we can detect the presence of malware designed to manipulate the system's boot process to evade defenses. A match is a strong indicator of compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Threat Intelligence Feed"
      - "All Windows Endpoints, Critical Application Servers, Domain Controllers, Executive Workstations"
    range: "last 90 days"
    queries:
      - "SEARCH Process_Creation_Events (e.g., WinEventID 4688) | CALCULATE file_hash | JOIN with Threat_Intelligence_Feed ON file_hash | WHERE match_found"
  - question: "If a malicious process associated with safe mode boot was executed, was it spawned by an uncommon parent process?"
    context: "Malicious processes are often spawned by legitimate applications (e.g., a Word document macro spawning a tool). This question helps prioritize alerts by identifying statistically rare parent-child process relationships. A common process like explorer.exe spawning bcdedit.exe might be normal, but winword.exe doing so is highly suspicious."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows Endpoints, Critical Application Servers, Domain Controllers, Executive Workstations"
    range: "last 90 days"
    queries:
      - "SEARCH Process_Creation_Events with malicious_child_hash | GROUPBY parent_process, child_process | CALCULATE historical_prevalence | WHERE prevalence < 10th_percentile"
  - question: "Can we predict if a new process execution is part of a 'Safe Mode Boot' attack using a machine learning model?"
    context: "This leverages a supervised model trained on various features (process name, parent, command line, user, threat intel match) to provide a probabilistic score of maliciousness. It goes beyond simple rules to identify complex patterns indicative of an attack, even with previously unseen tools or variations."
    answer_sources:
      - "Windows Event ID 4688"
      - "Threat Intelligence Feed"
      - "All Windows Endpoints, Critical Application Servers, Domain Controllers, Executive Workstations"
    range: "last 90 days"
    queries:
      - "STREAM Process_Creation_Events | ENRICH with features (parent_process, command_line_args, user_context, threat_intel_match) | APPLY classification_model | WHERE prediction == 'Safe Mode Boot Attack'"
  - question: "Has a boot configuration utility like 'bcdedit.exe' been executed with command-line arguments to enable safe mode?"
    context: "This is a direct method adversaries use to configure the system for a safe mode boot. Monitoring for the specific execution of 'bcdedit.exe' or 'bootcfg.exe' with the 'safeboot' argument provides a high-fidelity indicator of this technique."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows Endpoints, Domain Controllers, Infrastructure Servers"
    range: "last 90 days"
    queries:
      - "SEARCH Process_Creation_Events (e.g., WinEventID 4688) | WHERE process_name IN ('bcdedit.exe', 'bootcfg.exe') AND command_line CONTAINS 'safeboot'"
  - question: "Has there been an anomalous spike in 'bcdedit.exe' executions for a specific user or host, or has it been used with rare command-line arguments?"
    context: "While 'bcdedit.exe' can be used for legitimate administration, its frequent or unusual use can indicate malicious activity. This question establishes a baseline of normal usage and flags deviations, such as a user who never uses the tool suddenly executing it multiple times, or the use of an argument combination never seen before in the environment."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows Endpoints, Domain Controllers, Infrastructure Servers"
    range: "last 90 days"
    queries:
      - "SEARCH Process_Creation_Events for 'bcdedit.exe' | BASELINE execution_count per user, per host over 30 days | ALERT if current_day_count > 99th_percentile | ANALYZE command_line_prevalence | FLAG if args_prevalence < 5th_percentile"
  - question: "Does a recent execution of 'bcdedit.exe' appear anomalous when compared to historical, legitimate administrative activity?"
    context: "This uses an unsupervised anomaly detection model to distinguish between normal and suspicious 'bcdedit.exe' usage. By modeling features like command-line properties, parent process, and user context, it can identify outliers that don't fit the pattern of typical administrative tasks, even if the command doesn't explicitly contain 'safeboot'."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows Endpoints, Domain Controllers, Infrastructure Servers"
    range: "last 90 days"
    queries:
      - "STREAM 'bcdedit.exe' executions | EXTRACT features (cmdline_length, arg_count, parent_process, user_type, time_of_day) | APPLY anomaly_detection_model | ALERT on high_anomaly_score"
  - question: "Has the Windows Registry been modified to add a new service/driver to the SafeBoot configuration or to add a program to run in safe mode?"
    context: "Adversaries can achieve persistence in safe mode by directly manipulating the registry. This question targets specific, high-fidelity modifications, such as adding entries to 'HKLM\\...\\Control\\SafeBoot\\' or creating a 'Run' key value prefixed with an asterisk, which forces execution in safe mode."
    answer_sources:
      - "Windows Event ID 4657"
      - "All Windows Endpoints, Critical Application Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - "SEARCH Registry_Modification_Events (e.g., WinEventID 4657) | WHERE object_name CONTAINS '\\Control\\SafeBoot\\' OR (object_name CONTAINS '\\Run' AND value_name STARTSWITH '*')"
  - question: "Was a 'SafeBoot' registry key modified by a process that does not typically perform such actions?"
    context: "System updates and software installations might legitimately modify these keys. This question helps reduce false positives by creating an allowlist of known-good processes (like 'TrustedInstaller.exe'). Any modification by a process not on this list is considered suspicious, especially if that process has rarely or never modified the registry before."
    answer_sources:
      - "Windows Event ID 4657"
      - "All Windows Endpoints, Critical Application Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - "SEARCH 'SafeBoot'_Registry_Modifications | FILTER process_name NOT IN allowlist | CALCULATE historical_modification_frequency for process_name | FLAG if frequency is novel or > 3_std_dev_from_baseline"
  - question: "Can a machine learning model classify a registry modification to 'SafeBoot' keys as benign or malicious?"
    context: "This question applies a supervised model to differentiate between legitimate system changes and malicious tampering. By analyzing features like the modifying process and its lineage, the model can learn the nuances of benign activity and more accurately identify malicious modifications, reducing analyst fatigue from false positives."
    answer_sources:
      - "Windows Event ID 4657"
      - "All Windows Endpoints, Critical Application Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - "STREAM 'SafeBoot'_Registry_Modifications | EXTRACT features (process_name, parent_process, user_context, data_written) | APPLY classification_model | ALERT if prediction == 'Malicious'"
  - question: "After a system boot, in a state where security tools appear disabled, are there any suspicious process executions or network connections?"
    context: "A key goal of booting into safe mode is to disable security software. This question looks for the combination of a system reboot followed by the absence of expected security agent activity. In this degraded state, the presence of scripting engines or connections to low-reputation IPs is highly indicative of malicious activity."
    answer_sources:
      - "Windows Event ID 6009"
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "All Windows Endpoints, Network Egress Points, Authentication Servers"
    range: "last 90 days"
    queries:
      - "DETECT boot_event (WinEventID 6009) | CHECK for absence of security_agent_starts | IF absent, MONITOR for subsequent execution of ('powershell.exe', 'cscript.exe') OR network_connection to low_reputation_IP"
  - question: "Does the process or network activity immediately following a system boot deviate statistically from that host's normal boot behavior?"
    context: "Every host has a typical 'boot profile' of processes and network activity. This question establishes a baseline for the first 15 minutes after a boot. A sudden increase in the number of unique processes or a significant change in the variety of outbound network ports can indicate that a malicious payload is executing post-reboot."
    answer_sources:
      - "Windows Event ID 6009"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "All Windows Endpoints, Network Egress Points, Authentication Servers"
    range: "last 90 days"
    queries:
      - "FOR each host, BASELINE post-boot (first 15min) unique_process_count and destination_port_entropy | AFTER new boot_event, CALCULATE metrics | ALERT if metrics > 95th_percentile_of_baseline"
  - question: "Does the time-series data signature of a system's boot sequence match the pattern of a known malicious boot?"
    context: "This uses a sophisticated time-series model (LSTM Autoencoder) to learn the complex, multi-variate signature of a normal boot sequence (CPU, network, process creation rate, etc.). A high reconstruction error from the model indicates that the current boot sequence is a significant outlier from all previously observed normal boots, suggesting a deep system compromise."
    answer_sources:
      - "Windows Event ID 6009"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "All Windows Endpoints, Network Egress Points, Authentication Servers"
    range: "last 90 days"
    queries:
      - "STREAM post-boot time-series_data (process_rate, network_io, cpu_usage) | APPLY LSTM_autoencoder_model | ALERT on high_reconstruction_error"
  - question: "Has a boot configuration modification been followed by a system reboot on the same host within a short time frame?"
    context: "This question chains together the preparatory action (modifying boot config) with the execution action (rebooting). Observing this specific sequence (`bcdedit` or registry write -> reboot) on a single host within 30 minutes is a very high-fidelity indicator of a Safe Mode Boot attack in progress."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4657"
      - "Windows Event ID 1074"
      - "All Windows Endpoints and Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - "CORRELATE on host over 30min: (Event A: 'bcdedit /set safeboot' OR 'SafeBoot' registry_write) FOLLOWED BY (Event B: user-initiated_reboot) | GENERATE high-fidelity_alert"
  - question: "Can we create a cumulative risk score for a sequence of events related to a potential safe mode boot?"
    context: "This moves beyond a single trigger to a multi-stage risk assessment. It assigns points for each suspicious event in a chain: an initial `bcdedit` command, extra points if the parent process is rare, and more points if the subsequent reboot is followed by anomalous network traffic. An alert is only fired if the total risk score crosses a threshold, reducing noise from isolated, low-risk events."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4657"
      - "Windows Event ID 1074"
      - "Zeek conn.log"
      - "All Windows Endpoints and Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - "DEFINE risk_score_model | ON trigger_event (e.g., 'bcdedit'), assign base_score | ADD points for rare_parent_process | ADD points for post-reboot_network_anomaly | ALERT if cumulative_score > threshold"
  - question: "Does a sequence of events on a host match the state transitions of a Hidden Markov Model trained to detect the full Safe Mode Boot attack pattern?"
    context: "This question applies sequence analysis to model the entire attack lifecycle. The HMM learns the probable transitions between states (e.g., from 'Benign' to 'Defense Evasion Setup' to 'Reboot'). It can then calculate the probability that a new, incoming sequence of events from a host matches this malicious pattern, providing a sophisticated, context-aware detection method."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4657"
      - "Windows Event ID 1074"
      - "All Windows Endpoints and Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - "STREAM host_event_sequences | APPLY Hidden_Markov_Model | CALCULATE probability of matching 'malicious' state_transition_path | ALERT if probability > threshold"