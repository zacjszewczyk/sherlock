name: T1598.001: Spearphishing Service
id: 57d81f1e-3c5e-4c7b-8b1a-9e0f6d3a2c4b
description: This playbook helps determine if an adversary is using spearphishing services for reconnaissance against the enterprise. It focuses on identifying malicious inbound emails by analyzing their metadata against threat intelligence, detecting impersonation of key personnel, analyzing subject lines for suspicious information-gathering keywords, monitoring for unusual sending patterns from new domains, and detecting coordinated clicks on malicious links by multiple users.
type: technique
related:
- TA0043: Reconnaissance
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are inbound emails matching known malicious indicators from threat intelligence feeds?
  context: This question aims to detect phishing attempts by directly matching inbound email metadata (sender IP, HELO string, sender domain) against a high-confidence threat intelligence feed. A positive match is a strong indicator of a targeted attack and should be investigated immediately. This is a foundational, high-fidelity detection method.
  answer_sources:
  - Zeek conn.log
  - Zeek smtp.log
  - Corporate Email Gateway
  - Network Perimeter Firewalls
  - Threat Intelligence Feed
  range: last 90 days
  queries:
  - symbolic: |
      JOIN smtp.log and conn.log on UID.
      FOR each email:
        CHECK if smtp.helo, smtp.from domain, or conn.id.orig_h is IN threat_intel_list.
        IF true, GENERATE high-priority alert.
- question: Has a historically benign sender IP address started sending a high ratio of malicious emails?
  context: This question seeks to identify compromised or newly malicious infrastructure. It establishes a baseline for each sender IP's ratio of "clean" vs "malicious" (threat-intel matched) emails. A significant deviation from this baseline, such as a sudden increase in malicious emails from a previously trusted IP, indicates a change in the sender's posture and a potential threat.
  answer_sources:
  - Zeek conn.log
  - Zeek smtp.log
  - Corporate Email Gateway
  - Network Perimeter Firewalls
  - Threat Intelligence Feed
  range: last 90 days
  queries:
  - statistical: |
      FOR each sender_ip:
        CALCULATE ratio = (count_emails_matching_ti / total_emails) over 30 days.
        CALCULATE rolling 30-day baseline and standard deviation of this ratio.
        IF current_ratio > (baseline + 3 * std_dev), GENERATE alert.
- question: Can a machine learning model predict if a new, unseen email is malicious based on its metadata?
  context: This question leverages a predictive approach to catch novel or sophisticated threats that may not have known IOCs. By training a classification model on various features from email logs (e.g., HELO string entropy, sender TLD, IP ASN), the system can assign a probability score of maliciousness to new emails, enabling detection of previously unseen attack patterns.
  answer_sources:
  - Zeek conn.log
  - Zeek smtp.log
  - Corporate Email Gateway
  - Network Perimeter Firewalls
  - Threat Intelligence Feed
  range: last 90 days
  queries:
  - machine_learning: |
      FOR each new email:
        EXTRACT features (HELO entropy, sender TLD, IP ASN, etc.).
        APPLY pre-trained classification model.
        IF predicted_probability > 0.90, GENERATE alert.
- question: Are we receiving emails where the sender's display name matches a key employee, but the email address is from a public webmail provider?
  context: This question addresses a common Business Email Compromise (BEC) and spearphishing tactic. Attackers often spoof the display name of an executive or key employee while sending the email from a free webmail account. This query performs a direct check to catch these blatant impersonation attempts.
  answer_sources:
  - Zeek smtp.log
  - Corporate Email Gateway
  - Human Resources Information System (for key personnel list)
  range: last 90 days
  queries:
  - symbolic: |
      MAINTAIN key_personnel_list and public_webmail_domain_list.
      FOR each email in smtp.log:
        IF display_name IN key_personnel_list AND sender_domain IN public_webmail_domain_list:
          FLAG for review.
- question: Are we receiving emails from public webmail providers with display names that are highly similar, but not identical, to key personnel?
  context: This question aims to detect more subtle impersonation attempts where an attacker uses a slightly altered name (e.g., 'John Do' instead of 'John Doe'). By calculating the string similarity (e.g., Jaro-Winkler distance) between the sender's display name and a directory of key personnel, it can flag potential impersonations that exact matching would miss.
  answer_sources:
  - Zeek smtp.log
  - Corporate Email Gateway
  - Human Resources Information System (for key personnel list)
  range: last 90 days
  queries:
  - statistical: |
      FOR each inbound email:
        CALCULATE Jaro-Winkler similarity between sender_display_name and all names in key_personnel_directory.
        IF similarity > 0.95 AND sender_domain IS public AND no_prior_history with sender_email in 180 days:
          FLAG for review.
- question: Can a machine learning model generate a risk score for Business Email Compromise (BEC) based on sender impersonation signals?
  context: This question uses a holistic machine learning approach to assess BEC risk. The model considers multiple factors simultaneously—such as display name similarity, sender domain reputation, use of urgent language, and historical communication patterns—to produce a nuanced risk score. This allows for more accurate detection of sophisticated impersonation attempts compared to single-factor rules.
  answer_sources:
  - Zeek smtp.log
  - Corporate Email Gateway
  - Human Resources Information System (for key personnel list)
  range: last 90 days
  queries:
  - machine_learning: |
      FOR each inbound email:
        EXTRACT features (name_similarity, domain_category, subject_keywords, etc.).
        APPLY trained model to generate 'BEC Risk Score'.
        IF score > threshold, GENERATE alert.
- question: Do inbound email subjects from external sources contain keyword patterns associated with reconnaissance?
  context: This question focuses on the content of the email subject line to identify intent. By using regular expressions to search for patterns and keywords commonly used in reconnaissance (e.g., 'urgent', 'request', 'directory', 'confirm'), this query can flag emails that are likely part of an information-gathering campaign, even if other metadata appears benign.
  answer_sources:
  - Zeek smtp.log
  - Corporate Email Gateway
  range: last 90 days
  queries:
  - symbolic: |
      APPLY regex `/(urgent|confirm|verify).*(request|details|chart|directory)/i` to smtp.log subject field.
      IF match AND sender_domain is external and not whitelisted:
        GENERATE medium-priority alert.
- question: Are inbound emails using statistically uncommon words or phrases that are known to be associated with reconnaissance?
  context: This question uses TF-IDF (Term Frequency-Inverse Document Frequency) to find subject lines containing words that are rare in normal corporate email traffic but are common in a predefined list of reconnaissance-related terms. This statistical method helps to surface unusual language that might indicate a targeted social engineering attempt.
  answer_sources:
  - Zeek smtp.log
  - Corporate Email Gateway
  range: last 90 days
  queries:
  - statistical: |
      CALCULATE TF-IDF scores for all terms in inbound email subjects over a 30-day window.
      MAINTAIN a reconnaissance_lexicon.
      IF email contains terms with high TF-IDF scores AND those terms are IN reconnaissance_lexicon:
        GENERATE alert.
- question: Can topic modeling identify clusters of emails related to information gathering or credential harvesting themes?
  context: This question uses unsupervised machine learning (e.g., Latent Dirichlet Allocation) to automatically discover thematic topics within the subject lines of all inbound emails. An analyst can then review these topics to identify clusters of emails that revolve around reconnaissance themes (e.g., requests for information, credential verification), potentially revealing a coordinated campaign without needing predefined keywords.
  answer_sources:
  - Zeek smtp.log
  - Corporate Email Gateway
  range: last 90 days
  queries:
  - machine_learning: |
      APPLY LDA topic modeling algorithm to all inbound email subjects.
      ANALYZE generated topics for clusters of keywords like 'request', 'info', 'confirm', 'password'.
      IF reconnaissance-themed topic is found, ALERT on the associated email cluster.
- question: Is a newly observed domain sending emails to a large number of internal recipients in a short time?
  context: This question aims to detect a common reconnaissance pattern where an attacker uses a new domain to send a large volume of phishing emails. This rule sets a static threshold to alert when a domain, not seen in the last 90 days, sends emails to an abnormally high number of unique recipients (e.g., >25) within an hour. Enriching with WHOIS data for domain age adds confidence.
  answer_sources:
  - Zeek smtp.log
  - Zeek dns.log
  - Corporate Email Gateway
  - Internal DNS Resolvers
  range: last 90 days
  queries:
  - symbolic: |
      FOR sending_domain not seen in last 90 days:
        IF unique_recipients > 25 within 1 hour:
          ENRICH with WHOIS data.
          GENERATE alert, especially if domain is newly registered.
- question: Is a new sending domain's email activity exceeding the established statistical baseline for 'new sender' behavior?
  context: This question provides a more dynamic way to detect volume-based attacks from new domains. Instead of a fixed threshold, it establishes a statistical baseline (the 99th percentile) for the number of recipients targeted by a typical new sender. An alert is triggered when a new sender exceeds this dynamically calculated threshold, making the detection more resilient to changes in attack patterns.
  answer_sources:
  - Zeek smtp.log
  - Zeek dns.log
  - Corporate Email Gateway
  - Internal DNS Resolvers
  range: last 90 days
  queries:
  - statistical: |
      CALCULATE 99th percentile of unique_recipients_per_hour for all new senders.
      FOR each new sender:
        IF recipient_count_per_hour > 99th_percentile_threshold:
          GENERATE alert.
- question: Can a time-series anomaly detection model identify a sudden spike in email volume indicative of a coordinated campaign?
  context: This question uses a two-stage machine learning process to detect large-scale phishing campaigns. First, a time-series model detects anomalous spikes in the overall email volume. When a spike is detected, a secondary clustering process is triggered to group the emails within that spike by features like sender and subject, confirming if the anomaly was caused by a single, coordinated campaign.
  answer_sources:
  - Zeek smtp.log
  - Zeek dns.log
  - Corporate Email Gateway
  - Internal DNS Resolvers
  range: last 90 days
  queries:
  - machine_learning: |
      APPLY ARIMA/Prophet model to total email volume per minute.
      IF anomaly is flagged:
        APPLY DBSCAN clustering to emails in the anomalous window.
        IDENTIFY clusters based on sender, subject, etc. to confirm campaign.
- question: Are multiple distinct hosts simultaneously accessing the same newly-observed domain via a web browser?
  context: This question identifies the successful outcome of a phishing campaign—multiple users clicking on a malicious link. It correlates process creation events for web browsers with subsequent DNS queries from those same hosts. An alert is generated if a critical mass of endpoints (e.g., 10+) all resolve the same new, un-categorized domain within a short time window.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 4688
  - User Endpoints
  - Internal DNS Resolvers
  - Network Egress Points
  range: last 90 days
  queries:
  - symbolic: |
      CORRELATE Win Event 4688 (browser process) with subsequent dns.log query from same host.
      IF >= 10 hosts query for the same domain (not on allow list, not seen in 90 days) within 5 minutes:
        GENERATE alert.
- question: Is there a statistically significant spike in the number of hosts querying for 'first-seen' domains?
  context: This question provides a statistical method for detecting coordinated link-clicking. It establishes a baseline for the normal rate of 'first-seen' domain lookups across the network. An alert is triggered when the number of unique hosts querying for new domains in a short period exceeds a high statistical threshold (e.g., the 99.5th percentile), indicating an abnormal, likely coordinated event.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 4688
  - User Endpoints
  - Internal DNS Resolvers
  - Network Egress Points
  range: last 90 days
  queries:
  - statistical: |
      BASELINE the count of unique hosts querying 'first-seen' domains per minute.
      IF current_count > 99.5th percentile of 30-day baseline:
        GENERATE alert.
- question: Can graph analysis reveal communities of users being directed to a common malicious domain?
  context: This question leverages graph analysis to visualize and detect coordinated spearphishing. It builds a graph connecting users, the browser processes they launch, and the domains those processes access. By applying community detection algorithms, it can automatically highlight dense subgraphs where many different users are all connected to a single, uncommon domain, providing strong evidence of a successful campaign.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 4688
  - User Endpoints
  - Internal DNS Resolvers
  - Network Egress Points
  range: last 90 days
  queries:
  - machine_learning: |
      BUILD a graph with nodes for users, processes, and domains.
      CREATE edges for 'user launched process' and 'process resolved domain'.
      APPLY community detection algorithm (e.g., Louvain).
      IDENTIFY and alert on dense communities centered around a single, uncommon domain.