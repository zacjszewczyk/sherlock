name: T1069.002: Domain Groups
id: a1b9c8d0-f7e6-4d5c-b4a3-2e1f0a9b8c7d
description: This playbook helps investigate whether an adversary is attempting to discover domain groups and their permissions. This is often done by using known malicious tools like AdFind or PowerView, executing a rapid sequence of native discovery commands (e.g., 'net group /domain'), generating anomalous LDAP queries against Active Directory, attempting to read the membership of sensitive groups like Domain Admins, or performing these actions from user accounts or hosts that have no legitimate reason for such activity.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there command line executions or PowerShell scripts that match signatures of known malicious domain enumeration tools?
    context: This question seeks to identify the direct use of well-known adversary tools like AdFind, PowerView, or the BloodHound ingestor. Detecting these tools by their unique command-line arguments or function names provides high-fidelity evidence of malicious reconnaissance activity. A match indicates an attacker is likely mapping out the domain's group structure to find privileged accounts or access pathways.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, Privileged User Workstations
    range: last 90 days
    queries:
      - "SEARCH process_creation_logs OR powershell_script_logs WHERE command_line CONTAINS 'AdFind.exe -f objectCategory=group' OR command_line CONTAINS 'Get-NetGroup' OR command_line CONTAINS 'SharpHound.exe' OR command_line CONTAINS 'Get-BloodHoundData'"
  - question: Are there any PowerShell scripts with unusually high entropy, suggesting potential obfuscation?
    context: Adversaries often obfuscate their PowerShell scripts to evade signature-based detections. High Shannon entropy in a script block is a strong indicator of packed or encoded content, which is a common obfuscation technique. This question helps detect potentially malicious scripts even if their specific content doesn't match a known signature.
    answer_sources:
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, Privileged User Workstations
    range: last 90 days
    queries:
      - "CALCULATE entropy for all powershell_script_logs. ESTABLISH baseline entropy from known-good scripts. ALERT where entropy > 95th percentile of baseline."
  - question: Can we detect malicious domain enumeration commands using a machine learning model trained on command line features?
    context: This question leverages a machine learning model to identify malicious command line activity that might not be caught by simple string matching. By analyzing features like command length, character frequency, and n-grams, the model can learn the subtle characteristics of enumeration commands and distinguish them from benign administrative activity, providing a more robust and adaptable detection method.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers, Member Servers, Privileged User Workstations
    range: last 90 days
    queries:
      - "EXTRACT features (length, char_frequency, n-grams) from process_creation_logs. APPLY trained classification model. ALERT where classification is 'malicious' with high confidence."
  - question: Has any single user or process executed an unusual number of distinct domain group enumeration commands in a short time frame?
    context: While a single discovery command might be legitimate, a rapid succession of different enumeration commands (e.g., 'net group', 'dsquery group', 'Get-ADGroupMember') from one source is highly suspicious. This behavior, often called 'chaining', is characteristic of automated reconnaissance scripts or manual exploration by an attacker and deviates significantly from normal administrative patterns.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - All Endpoints and Servers, especially Domain Controllers and administrative workstations
    range: last 90 days
    queries:
      - "GROUP process_creation_logs and powershell_script_logs by user, host, and 5-minute window. COUNT distinct enumeration commands. ALERT where count > 3."
  - question: Has any user account exhibited a statistically significant spike in the frequency of discovery-related commands compared to their own baseline?
    context: This question aims to detect anomalous behavior on a per-user basis. By establishing a baseline of normal command execution for each user, we can spot when an account is being used for an uncharacteristic burst of reconnaissance activity. This is effective for detecting compromised accounts that are suddenly used for discovery, even if the total volume is low.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - All Endpoints and Servers, especially Domain Controllers and administrative workstations
    range: last 90 days
    queries:
      - "For each user, CALCULATE moving average and standard deviation of discovery commands per hour over 30 days. ALERT when hourly count > (moving_average + 3 * std_dev)."
  - question: Does a sequence of executed commands indicate a high probability of a 'Reconnaissance' state according to a Hidden Markov Model?
    context: This question uses a more advanced model to understand the context of commands, not just their individual occurrence. A Hidden Markov Model (HMM) can learn the typical sequences of commands associated with different adversary phases (like reconnaissance). It can flag a series of seemingly benign actions as malicious if they match a learned pattern for reconnaissance, providing insight into attacker intent.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - All Endpoints and Servers, especially Domain Controllers and administrative workstations
    range: last 90 days
    queries:
      - "INPUT sequence of commands into a trained HMM. CALCULATE probability of being in 'Reconnaissance' state. ALERT if probability > threshold."
  - question: Are there any LDAP queries that contain filters known to be used by specific reconnaissance tools like BloodHound?
    context: This question focuses on detecting specific, high-fidelity indicators of tool usage at the network level. Tools like BloodHound use very particular LDAP filters to efficiently gather Active Directory data. These filters are rarely, if ever, used in legitimate applications, making their presence in network traffic a strong signal of a targeted reconnaissance campaign.
    answer_sources:
      - Zeek ldap.log
      - Zeek conn.log
      - Network segments monitoring traffic to and from Domain Controllers
    range: last 90 days
    queries:
      - "SEARCH zeek_ldap_logs WHERE ldap_filter CONTAINS '(|(samaccounttype=268435456)...)' OR ldap_filter CONTAINS '(objectCategory=group)'. ALERT on match."
  - question: Has any source IP address generated an anomalous volume of LDAP search requests compared to its own history or its peer group?
    context: This question helps identify reconnaissance activity by looking for statistical outliers in LDAP traffic. An attacker enumerating AD will generate a much higher volume of LDAP queries than a typical host. By comparing a host's activity against its own baseline and the baseline of similar hosts (its peers), we can detect suspicious spikes that indicate enumeration, even without a specific tool signature.
    answer_sources:
      - Zeek ldap.log
      - Zeek conn.log
      - Network segments monitoring traffic to and from Domain Controllers
    range: last 90 days
    queries:
      - "For each source_ip, CALCULATE hourly LDAP search count. ALERT if count > 99th percentile of host's 30-day baseline. OR, ALERT if host's count > 3 standard deviations from its peer group's mean."
  - question: Has the volume of LDAP queries from a source host significantly deviated from its forecasted behavior?
    context: This question applies time-series forecasting to detect anomalies in LDAP traffic. By modeling the normal, rhythmic patterns of a host's communication with domain controllers, a forecasting model can predict the expected volume of queries. A sudden, large deviation from this prediction suggests an unplanned and potentially malicious event, such as an adversary initiating a discovery scan.
    answer_sources:
      - Zeek ldap.log
      - Zeek conn.log
      - Network segments monitoring traffic to and from Domain Controllers
    range: last 90 days
    queries:
      - "MODEL LDAP query volume per host as a time series. FORECAST expected volume for the next interval. ALERT if actual volume significantly exceeds the predicted upper confidence bound."
  - question: Has the membership of a highly sensitive Active Directory group been read by a user or from a host that is not on an explicit allow list?
    context: This question focuses on protecting the most critical AD groups (e.g., Domain Admins). Access to the membership of these groups is a key goal for attackers. By enabling specific auditing (Event ID 4662) and maintaining a strict allow list of who can perform this action and from where, any unauthorized access attempt becomes a high-severity, actionable alert.
    answer_sources:
      - Windows Event ID 4662
      - Windows Event ID 4624
      - Domain Controllers
    range: last 90 days
    queries:
      - "ENABLE 'Audit Directory Service Access' on sensitive AD groups. MAINTAIN allow list of users/hosts. SEARCH for Event ID 4662 for these groups. ALERT if SubjectUserName or SourceAddress is NOT in the allow list."
  - question: Has an authorized administrator accessed sensitive group memberships at an unusual time or from an unfamiliar workstation?
    context: Even legitimate administrators can have their accounts compromised. This question seeks to detect such a compromise by baselining the normal behavior of privileged users. An alert is generated if a privileged account is used to access sensitive group data outside of their normal working hours or from a machine they don't typically use, which could indicate an attacker is using their stolen credentials.
    answer_sources:
      - Windows Event ID 4662
      - Windows Event ID 4624
      - Domain Controllers
    range: last 90 days
    queries:
      - "For authorized users, PROFILE normal access hours and source workstations from Event 4662/4624. ALERT if an access event occurs outside the profiled hours (e.g., z-score > 3) or from a new workstation."
  - question: Does an access event for a sensitive group's membership appear anomalous when compared to a model of legitimate administrative behavior?
    context: This question uses an anomaly detection model (like a one-class SVM) to create a sophisticated, multi-dimensional profile of 'normal' privileged access. The model considers factors like user, source host, time of day, and logon type simultaneously. Any access event that falls outside this learned boundary of normal behavior is flagged as an anomaly, providing a powerful way to detect novel or subtle attacker techniques.
    answer_sources:
      - Windows Event ID 4662
      - Windows Event ID 4624
      - Domain Controllers
    range: last 90 days
    queries:
      - "TRAIN anomaly detection model (e.g., Isolation Forest) on features from legitimate access events (Event 4662/4624). DEPLOY model to score new access events. ALERT on events flagged as anomalous."
  - question: Has a domain group enumeration command been executed from a user account or host whose role does not require this capability?
    context: This question leverages organizational context to identify suspicious activity. A user in the marketing department or a production web server has no legitimate reason to enumerate domain groups. By mapping assets and users to their business roles, any execution of a discovery command from an unauthorized role becomes a high-confidence indicator of a security breach or policy violation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Zeek ldap.log
      - All Endpoints and Servers, particularly non-IT/developer workstations and single-function servers like Web Servers or Database Servers
    range: last 90 days
    queries:
      - "MAINTAIN an inventory of user/host roles. CREATE a rule that looks for enumeration commands (e.g., 'net group /domain'). ALERT if the source user/host role is not 'IT-Admin' or another authorized role."
  - question: Is a user's discovery activity score a statistical outlier compared to others in their same role or department?
    context: This question helps find anomalous behavior within peer groups. While some discovery activity might be normal for an IT administrator, one administrator performing significantly more than their peers could be a sign of a compromised account or insider threat. Comparing an individual's activity to their peer group provides context that is missed when looking at the individual in isolation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Zeek ldap.log
      - All Endpoints and Servers, particularly non-IT/developer workstations and single-function servers like Web Servers or Database Servers
    range: last 90 days
    queries:
      - "GROUP users by role/department. CALCULATE a weekly 'discovery score' for each user. ALERT if a user's score is an outlier (e.g., > 95th percentile) within their group."
  - question: Has a host, automatically clustered into a specific functional role, performed actions (like domain enumeration) that are inconsistent with that role?
    context: This question uses unsupervised machine learning to automatically define and enforce host roles. By clustering hosts based on their typical network and process activity, the algorithm can identify, for example, a group of 'web servers'. If a host in that cluster suddenly starts executing discovery commands, it is flagged as an outlier, indicating a severe deviation from its established function, likely due to compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Zeek ldap.log
      - All Endpoints and Servers, particularly non-IT/developer workstations and single-function servers like Web Servers or Database Servers
    range: last 90 days
    queries:
      - "CLUSTER hosts using DBSCAN based on activity features (processes, network traffic). IDENTIFY clusters representing functional roles. ALERT if a host in a cluster performs an action (e.g., domain enumeration) that is anomalous for that cluster."