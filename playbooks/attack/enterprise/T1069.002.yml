name: "T1069.002: Domain Groups"
id: "c1e2f3a4-b5c6-4d7e-8f9a-0b1c2d3e4f5a"
description: "This playbook helps investigate whether an adversary is attempting to discover domain groups and their permissions within an Active Directory environment. This is a common reconnaissance activity used to map out the network, identify privileged accounts, and find potential targets for lateral movement. The investigation focuses on detecting known enumeration tool signatures, anomalous sequences or volumes of native discovery commands, suspicious LDAP query patterns, unauthorized access to sensitive group memberships, and enumeration activity originating from users or hosts whose roles do not justify such actions."
type: "technique"
related:
  - "TA0007: Discovery"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a known malicious domain enumeration tool being used, based on specific command-line arguments or PowerShell function names?"
    context: "This question aims to find direct, high-fidelity evidence of malicious reconnaissance. Tools like AdFind, PowerView, and BloodHound have unique command signatures. Detecting these signatures is a strong indicator of an adversary actively mapping out the domain's group structure."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Domain Controllers, Member Servers, Privileged User Workstations"
    range: "last 90 days"
    queries:
      - "Search process command lines (4688) and PowerShell script blocks (4104) for known malicious tool signatures (e.g., 'AdFind.exe -f', 'Get-NetGroup', 'SharpHound.exe')."
  - question: "Is a PowerShell script exhibiting unusually high entropy, potentially indicating obfuscation of domain enumeration activity?"
    context: "Adversaries often obfuscate their scripts to evade signature-based detection. High Shannon entropy can be a statistical indicator of obfuscation. This question helps uncover hidden malicious scripts by focusing on their structure rather than their exact content."
    answer_sources:
      - "Windows Event ID 4104"
      - "Domain Controllers, Member Servers, Privileged User Workstations"
    range: "last 90 days"
    queries:
      - "For each PowerShell script block (4104), calculate Shannon entropy. Alert if entropy exceeds the 95th percentile of the established baseline."
  - question: "Does a process command line exhibit characteristics of malicious domain enumeration, as identified by a machine learning model?"
    context: "This question uses a machine learning model to classify command-line activity. The model is trained on features like command length, character frequency, and keywords to distinguish between benign administrative commands and malicious enumeration attempts that might not use a known tool signature."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers, Member Servers, Privileged User Workstations"
    range: "last 90 days"
    queries:
      - "Classify new process command lines (4688) using a trained model. Alert on commands classified as malicious with high confidence."
  - question: "Has a single user or process executed an unusual sequence of native domain group discovery commands in a short period?"
    context: "While single discovery commands can be legitimate, a rapid succession of different enumeration commands (e.g., 'net group /domain' followed by 'Get-ADGroupMember') by one entity is highly suspicious and indicative of automated or scripted reconnaissance."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "All Endpoints and Servers, especially Domain Controllers and administrative workstations"
    range: "last 90 days"
    queries:
      - "Correlate process (4688) and PowerShell (4104) logs. Alert if a single user/process runs >3 distinct enumeration commands from one host within 5 minutes."
  - question: "Is a user executing discovery-related commands at a rate that is statistically anomalous compared to their own historical baseline?"
    context: "This question aims to detect changes in individual user behavior. An administrator might run discovery commands occasionally, but a sudden, sharp increase in this activity for that specific user, deviating from their normal pattern, can signal a compromised account or insider threat."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "All Endpoints and Servers, especially Domain Controllers and administrative workstations"
    range: "last 90 days"
    queries:
      - "For each user, baseline their command frequency. Alert if the hourly count of discovery commands exceeds 3 standard deviations above their moving average."
  - question: "Does a sequence of command-line executions match a pattern classified as 'Reconnaissance' by a Hidden Markov Model?"
    context: "This question models the *sequence* of actions rather than just the volume. An HMM can learn the typical transitions between different types of commands. An observed sequence that has a high probability of being in a 'Reconnaissance' state suggests a structured attack is underway."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "All Endpoints and Servers, especially Domain Controllers and administrative workstations"
    range: "last 90 days"
    queries:
      - "Using a trained HMM, calculate the probability that an observed command sequence corresponds to a 'Reconnaissance' state. Alert if the probability exceeds a threshold."
  - question: "Is an LDAP query targeting Active Directory group objects using a filter known to be associated with reconnaissance tools like BloodHound?"
    context: "This question looks for highly specific, malicious LDAP query patterns. BloodHound and other tools use unique, complex filters to efficiently gather AD data. These filters are almost never used in legitimate operations, making them a very high-fidelity indicator of compromise."
    answer_sources:
      - "Zeek ldap.log"
      - "Zeek conn.log"
      - "Network segments monitoring traffic to and from Domain Controllers"
    range: "last 90 days"
    queries:
      - "Scan Zeek ldap.log for LDAP queries with filters known to be used by BloodHound or for broad queries like '(objectCategory=group)'."
  - question: "Is a host generating a volume of LDAP search requests that is anomalous compared to its own history or its peer group?"
    context: "This question identifies reconnaissance by looking for unusual network traffic patterns. A sudden spike in LDAP queries from a single host, or a host that queries far more than its functional peers (e.g., other workstations), points to large-scale enumeration."
    answer_sources:
      - "Zeek ldap.log"
      - "Zeek conn.log"
      - "Network segments monitoring traffic to and from Domain Controllers"
    range: "last 90 days"
    queries:
      - "For each source IP in Zeek ldap.log, calculate hourly LDAP search counts. Alert if a host's count exceeds the 99th percentile of its baseline or is an outlier in its peer group."
  - question: "Is the volume of LDAP queries from a host significantly exceeding the predicted volume from a time-series forecasting model?"
    context: "This question uses a forecasting model to predict what 'normal' LDAP traffic volume should look like for a given host. An alert is generated when the actual traffic volume is significantly higher than the prediction's upper confidence limit, indicating a sudden, unexpected burst of activity that is likely malicious."
    answer_sources:
      - "Zeek ldap.log"
      - "Zeek conn.log"
      - "Network segments monitoring traffic to and from Domain Controllers"
    range: "last 90 days"
    queries:
      - "Model LDAP query volume for each host as a time series. Alert if observed volume significantly exceeds the forecasted upper confidence bound."
  - question: "Has a sensitive Active Directory group's membership been read by a user or from a host that is not on an explicit allow list?"
    context: "This question provides a high-fidelity alert by tightly controlling access to critical groups like Domain Admins. By pre-defining who *should* be accessing these groups, any access from an unauthorized user or system is immediately flagged as a high-priority security event. This requires enabling specific audit policies (SACLs) on the AD objects."
    answer_sources:
      - "Windows Event ID 4662"
      - "Windows Event ID 4624"
      - "Domain Controllers"
    range: "last 90 days"
    queries:
      - "After enabling SACLs on sensitive AD groups, alert on Event ID 4662 if the access is from a user or host not on the predefined allow list."
  - question: "Is an authorized administrator accessing sensitive groups at an unusual time or from an unfamiliar workstation?"
    context: "Even legitimate users can have their credentials stolen. This question helps detect such a compromise by baselining the normal behavior of privileged accounts. If an authorized admin suddenly accesses a sensitive group at 3 AM from a marketing team's PC, it's a strong anomaly worth investigating, even if the account itself is on the allow list."
    answer_sources:
      - "Windows Event ID 4662"
      - "Windows Event ID 4624"
      - "Domain Controllers"
    range: "last 90 days"
    queries:
      - "For authorized users, baseline access patterns (hours, workstations). Alert if access occurs outside normal profiled hours or from a new workstation."
  - question: "Does an access event to a sensitive group show anomalous characteristics when compared to a model of legitimate administrative behavior?"
    context: "This question uses an anomaly detection model (like a one-class SVM) to learn a complex, multi-dimensional profile of 'normal' privileged access. The model considers user, host, logon type, time, and day simultaneously. Any access event that doesn't fit this learned profile is flagged as anomalous, catching subtle deviations that rule-based systems might miss."
    answer_sources:
      - "Windows Event ID 4662"
      - "Windows Event ID 4624"
      - "Domain Controllers"
    range: "last 90 days"
    queries:
      - "Train a one-class SVM or Isolation Forest on legitimate access events (4662, 4624). Score new access events and alert on any flagged as an anomaly."
  - question: "Is domain group enumeration activity originating from a user or host whose business function does not require it?"
    context: "This question leverages organizational knowledge to detect suspicious activity. A web server or a user from the finance department has no legitimate reason to be enumerating domain groups. By creating rules based on user/host roles, this approach can quickly identify out-of-place actions that strongly suggest a compromised asset."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Zeek ldap.log"
      - "All Endpoints and Servers, particularly non-IT/developer workstations and single-function servers like Web Servers or Database Servers"
    range: "last 90 days"
    queries:
      - "Maintain a user/host role inventory. Alert if enumeration commands (4688, 4104) originate from a user/host not in an authorized role."
  - question: "Is a user's discovery activity score a statistical outlier compared to their peer group?"
    context: "This question identifies anomalous behavior within a functional group. While some discovery activity might be normal for a group of system administrators, if one admin's activity score is dramatically higher than their peers', it could indicate that their account is being used for broader, more aggressive reconnaissance."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Zeek ldap.log"
      - "All Endpoints and Servers, particularly non-IT/developer workstations and single-function servers like Web Servers or Database Servers"
    range: "last 90 days"
    queries:
      - "Group users by role. Calculate a weekly discovery activity score for each user. Alert if a user's score is an outlier (e.g., >95th percentile) within their group."
  - question: "Has a host, automatically clustered into a specific functional role, performed an action (like domain enumeration) that deviates from its cluster's typical behavior?"
    context: "This question uses unsupervised machine learning to automatically define host roles based on behavior. A clustering algorithm can group servers based on their network traffic and running processes. If a host in the 'web server' cluster suddenly starts running 'net group /domain', the model flags it as an outlier, indicating a significant and suspicious deviation from its established role."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Zeek ldap.log"
      - "All Endpoints and Servers, particularly non-IT/developer workstations and single-function servers like Web Servers or Database Servers"
    range: "last 90 days"
    queries:
      - "Use a clustering algorithm (e.g., DBSCAN) on host activity data to define functional roles. Flag any host that executes enumeration commands as an outlier if it deviates from its cluster's profile."