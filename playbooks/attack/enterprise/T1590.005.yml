name: T1590.005: IP Addresses
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps determine if an adversary is actively gathering the organization's IP address information for targeting. It covers several reconnaissance methods, including identifying high-volume connections from known malicious IPs, detecting the use of scanning tools like Nmap or Masscan through signatures and behavioral analysis, recognizing network scanning patterns such as high connection failure rates, spotting targeted service fingerprinting probes, analyzing anomalous DNS queries like zone transfer attempts or subdomain brute-forcing, and detecting compromised internal hosts being used for external scanning.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are known malicious IP addresses from our threat intelligence feeds connecting to or querying our network?
    context: This question aims to identify initial contact from IP addresses that are already known to be malicious (e.g., part of a botnet, a C2 server, a TOR exit node, or a known scanner). A match provides a strong, early indicator of targeted or opportunistic reconnaissance, allowing for immediate blocking or further investigation.
    answer_sources: [Zeek conn.log, Zeek dns.log, Perimeter Firewalls, Internet Gateway, External DNS Servers, Cloud Network Gateways]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each event in (conn.log, dns.log)
          WHERE source_ip is external
          AND source_ip is in (CTI_feed_of_malicious_IPs)
          RETURN event
  - question: Which of the identified malicious IPs are exhibiting the highest volume of activity against our network?
    context: After identifying connections from known malicious IPs, it's crucial to prioritize the most active ones. An IP generating an unusually high volume of traffic compared to other malicious actors could indicate a more aggressive or dedicated reconnaissance effort. This helps focus investigative resources on the most immediate threats.
    answer_sources: [Zeek conn.log, Zeek dns.log, Perimeter Firewalls, Internet Gateway, External DNS Servers, Cloud Network Gateways]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          DEFINE matched_ips AS IPs from previous query
          FOR each ip in matched_ips:
            CALCULATE count(events) in 5-minute windows
          CALCULATE 95th_percentile of counts for all matched_ips over last 24 hours
          RETURN ip WHERE count > 95th_percentile
  - question: Is the overall volume of reconnaissance activity from known malicious sources deviating from expected patterns, suggesting a large-scale campaign?
    context: This question moves from single-source analysis to a holistic view. By forecasting the expected volume of malicious activity, we can detect significant deviations that might signal a coordinated, large-scale campaign. A sudden spike above the predicted norm is a strong indicator that a widespread attack or reconnaissance phase is underway.
    answer_sources: [Zeek conn.log, Zeek dns.log, Perimeter Firewalls, Internet Gateway, External DNS Servers, Cloud Network Gateways]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          AGGREGATE count of CTI-matched events per hour
          APPLY time series model (e.g., ARIMA) to generate forecast and confidence interval
          IF current_hour_count > upper_confidence_interval:
            ALERT "Anomalous spike in CTI-matched activity"
  - question: Are external sources interacting with our services using signatures associated with known reconnaissance tools?
    context: This question focuses on detecting the specific tools used by attackers. Tools like Nmap, Masscan, or Nuclei often leave behind unique fingerprints (e.g., specific User-Agent strings, JA3/JA3S hashes, or DNS query structures). Identifying these signatures provides direct evidence of active reconnaissance.
    answer_sources: [Zeek http.log, Zeek conn.log, Zeek dns.log, Zeek ssl.log, Public-facing Web Servers, Application Delivery Controllers, External DNS Servers, VPN Concentrators]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH logs FOR user_agent, ja3_hash, or dns_query_pattern IN (recon_tool_signature_list)
          GENERATE alert on match
  - question: Are any external IP addresses exhibiting port scanning behavior, either broad or targeted?
    context: This question uses information theory to identify scanning behavior. A high entropy in destination ports indicates a wide, indiscriminate scan (trying many different ports). A very low entropy (approaching zero) suggests a focus on a single port across many hosts. Both extremes are anomalous and warrant investigation, representing different scanning strategies.
    answer_sources: [Zeek conn.log, Public-facing Web Servers, Application Delivery Controllers, External DNS Servers, VPN Concentrators]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each external source_ip:
            CALCULATE Shannon entropy of destination_ports in 1-minute windows
          FLAG IPs in top and bottom 5th percentile of entropy scores for review
  - question: Can we use machine learning to proactively identify network sessions that are likely reconnaissance activities?
    context: This question leverages machine learning to move beyond simple signatures and identify complex reconnaissance patterns that may not be obvious to a human analyst. By training a model on features of known benign and malicious sessions, we can score new, unknown connections in real-time to detect sophisticated or novel scanning techniques.
    answer_sources: [Zeek http.log, Zeek conn.log, Public-facing Web Servers, Application Delivery Controllers, External DNS Servers, VPN Concentrators]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          APPLY trained classification model (e.g., Random Forest) to new network sessions
          USE features like tcp_flags, payload_size, duration, user_agent
          ALERT on sessions classified as 'reconnaissance'
  - question: Is any single external IP address generating a large number of failed connections to many different internal hosts?
    context: This question seeks to identify horizontal scanning. A high volume of failed connections (e.g., TCP resets or unanswered SYN packets) from one source to many destinations is a classic indicator of a host discovery scan, where an attacker is trying to find live hosts on the network.
    answer_sources: [Zeek conn.log, Network DMZ, Perimeter Firewalls, Cloud Security Groups, VPC Flow Logs]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ALERT if an external source_ip has conn_state ('REJ', 'RSTO', 'S0')
          TO > 100 unique destination_ips
          WITHIN a 10-minute window
  - question: Are any external IP addresses showing an anomalously high ratio of failed-to-successful connections?
    context: This question identifies scanners by their characteristic inefficiency. Legitimate clients usually have a low connection failure rate. Scanners, however, often attempt to connect to closed ports or non-existent hosts, resulting in a statistically significant, high ratio of failed connections. This method can detect scanners even if their total traffic volume is low.
    answer_sources: [Zeek conn.log, Network DMZ, Perimeter Firewalls, Cloud Security Groups, VPC Flow Logs]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each external source_ip over a 5-minute interval:
            CALCULATE ratio = count(failed_connections) / count(total_connections)
          CALCULATE mean_ratio and stdev for all external traffic
          FLAG source_ip if its ratio > (mean_ratio + 3 * stdev)
  - question: Can we use unsupervised machine learning to group and identify external IPs that are behaving like scanners?
    context: This question uses clustering to automatically group IPs with similar behaviors. Normal user traffic will form dense clusters, while scanners—with their high number of unique destinations, ports, and failed connections—will be identified as outliers or small, distinct clusters. This is effective for finding attackers who deviate from typical user behavior.
    answer_sources: [Zeek conn.log, Network DMZ, Perimeter Firewalls, Cloud Security Groups, VPC Flow Logs]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          APPLY clustering algorithm (e.g., DBSCAN) to external source_ips
          USE features: count(distinct destination_ips), count(distinct destination_ports), failed_connection_ratio
          INVESTIGATE IPs identified as anomalies or noise clusters
  - question: Is our network monitoring system (Zeek) generating specific notices related to scanning or protocol violations from external IPs?
    context: This question leverages the built-in intelligence of network security monitoring tools like Zeek. Zeek's Notice Framework is designed to flag suspicious activity. Specifically looking for notices like 'Scan::Port_Scan' or 'SSL::Invalid_Server_Cert', and correlating them with Dynamic Protocol Detection (DPD) violations, provides high-fidelity alerts for reconnaissance.
    answer_sources: [Zeek conn.log, Zeek dpd.log, Zeek notice.log, Public-facing Application Servers (e.g., Web, VPN, RDP), Internet Gateway, External-facing Container Platforms]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ALERT on notice.log events where note is ('Scan::Port_Scan', 'SSL::Invalid_Server_Cert', 'PacketFilter::Drop') and source is external
          CORRELATE with dpd.log for 'protocol_violation' notices from the same source
  - question: Are there unusually short-lived, low-data connections to our high-value service ports?
    context: This question aims to detect service fingerprinting. Attackers often make very brief connections to a service port just to grab the banner or initial handshake data to identify the service and version, without establishing a full, legitimate session. These connections will have an anomalously short duration and low data transfer compared to normal user activity.
    answer_sources: [Zeek conn.log, Public-facing Application Servers (e.g., Web, VPN, RDP), Internet Gateway, External-facing Container Platforms]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          DEFINE high_value_ports (e.g., 443, 3389, 22)
          FOR each port in high_value_ports:
            CALCULATE 10th percentile for duration and total_bytes for all connections
            FOR each external source_ip connecting to port:
              CALCULATE median duration and total_bytes
              FLAG if source metrics are below the 10th percentile
  - question: Is there a spike in protocol mismatches on standard ports, indicating attempts to fingerprint services?
    context: This question looks for attempts to evade simple port-based firewalls by running a service on a non-standard port. Zeek's Dynamic Protocol Detection (DPD) can identify when the traffic on a port doesn't match the expected protocol (e.g., SSH traffic on port 443). A sudden increase in these mismatches from a single source strongly suggests an attacker is probing for misconfigured or hidden services.
    answer_sources: [Zeek dpd.log, Public-facing Application Servers (e.g., Web, VPN, RDP), Internet Gateway, External-facing Container Platforms]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          APPLY time series analysis to dpd.log event counts for protocol mismatches on standard ports
          ALERT on anomalous spikes associated with a specific external source IP
  - question: Are there any attempts to perform a DNS zone transfer for our domains?
    context: This question looks for one of the loudest and most effective DNS reconnaissance techniques. A DNS zone transfer (AXFR/IXFR) requests a full copy of a domain's DNS records. If allowed, it hands an attacker a complete map of an organization's servers. Any attempt from an unauthorized source is a high-confidence indicator of reconnaissance and should be a high-priority alert.
    answer_sources: [Zeek dns.log, Authoritative External DNS Servers, Recursive DNS Resolvers, Cloud DNS Services (e.g., Route 53)]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ALERT on dns.log event
          WHERE query_type is 'AXFR' or 'IXFR'
          AND query targets an internal organizational domain
  - question: Is any external IP receiving an extremely high number of 'domain not found' (NXDOMAIN) responses?
    context: This question aims to detect subdomain brute-force attacks. Attackers use large wordlists to guess subdomains (e.g., 'dev', 'test', 'vpn'). Most of these guesses will fail, resulting in a high number of NXDOMAIN responses from the DNS server. A source IP with a very high NXDOMAIN ratio is almost certainly performing subdomain enumeration.
    answer_sources: [Zeek dns.log, Authoritative External DNS Servers, Recursive DNS Resolvers, Cloud DNS Services (e.g., Route 53)]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each external source_ip querying organizational domains over a 15-minute window:
            CALCULATE ratio = count(NXDOMAIN_responses) / count(total_queries)
          FLAG source_ip if its ratio exceeds the 98th percentile of all source ratios
  - question: Can we use anomaly detection to identify unusual DNS query patterns indicative of reconnaissance?
    context: This question uses unsupervised machine learning to find novel or subtle DNS-based reconnaissance. By modeling what normal DNS traffic looks like, we can flag any activity that deviates significantly. This can catch techniques that don't trigger simple ratio or signature rules, such as slow enumeration or queries with unusual character patterns.
    answer_sources: [Zeek dns.log, Authoritative External DNS Servers, Recursive DNS Resolvers, Cloud DNS Services (e.g., Route 53)]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN a one-class SVM or Isolation Forest model on features of normal DNS queries
          APPLY the model to new external DNS query patterns to detect outliers
  - question: Is any internal host, not authorized to scan, connecting to a large number of external IPs on unusual ports?
    context: This question shifts focus to detecting reconnaissance originating from a compromised internal host. A compromised machine might be used to scan other external targets. This behavior is highly anomalous for a typical user workstation or server and is a strong signal of a breach. Correlating with process creation logs (Event ID 4688) can pinpoint the malicious software responsible.
    answer_sources: [Zeek conn.log, Windows Event ID 5156, Windows Event ID 4688, Endpoint Devices, Internal Server Segments, Egress Firewalls, Cloud Compute Instances (e.g., EC2)]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          DEFINE non_standard_ports AS any port NOT in (80, 443)
          ALERT when an internal_host (not in authorized_scanner_list)
          INITIATES connections to > 50 unique external_ips on non_standard_ports
          WITHIN a 1-hour window
          CORRELATE with process creation logs (WEF 4688) on the host
  - question: Has any internal host suddenly started contacting a significantly higher number of external IPs than its normal baseline?
    context: This question uses historical baselining to detect behavioral changes on internal hosts. Every host has a typical pattern of external communication. A sudden, drastic increase in the number of unique external IPs it connects to is a strong statistical indicator that its function has changed, possibly due to a compromise and subsequent use for scanning or C2.
    answer_sources: [Zeek conn.log, Endpoint Devices, Internal Server Segments, Egress Firewalls, Cloud Compute Instances (e.g., EC2)]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each internal host:
            ESTABLISH baseline: 30-day moving average and stdev of distinct external IPs contacted per day
          ALERT if a host's daily count > (moving_average + 4 * stdev)
  - question: Are there sudden, unexplained spikes in outbound connection activity from internal hosts after accounting for normal patterns?
    context: This question applies a more sophisticated statistical method to find anomalies. Time series decomposition breaks down a host's activity into its normal patterns (trend and seasonality, e.g., daily backups) and its random noise (residuals). A large spike in the residuals represents activity that cannot be explained by normal behavior, making it a high-fidelity signal for potential scanning.
    answer_sources: [Zeek conn.log, Endpoint Devices, Internal Server Segments, Egress Firewalls, Cloud Compute Instances (e.g., EC2)]
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each internal host:
            DECOMPOSE time series of outbound connection count into trend, seasonality, and residuals
          APPLY anomaly detection (e.g., Z-score) to the residual component
          ALERT on significant spikes