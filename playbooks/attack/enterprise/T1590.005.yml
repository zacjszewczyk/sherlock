name: T1590.005: IP Addresses
id: 1e9f8b0a-7b3c-4e5d-8f6a-9c8d7e6f5a4b
description: This playbook helps determine if an adversary is actively gathering the organization's IP address information for targeting. This involves identifying reconnaissance activity through several means: detecting traffic from known malicious IPs via threat intelligence feeds; recognizing signatures of common scanning tools (e.g., Nmap, Masscan); identifying statistical anomalies in network traffic, such as a high ratio of failed connections or broad port scanning; detecting targeted service fingerprinting probes; monitoring for anomalous DNS queries like zone transfer attempts or high rates of NXDOMAIN responses; and flagging internal hosts that may be compromised and used for external scanning.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a known malicious IP address communicating with our network?
    context: Matching network traffic against a high-confidence Cyber Threat Intelligence (CTI) feed is a fundamental method for detecting known threats. This question aims to identify if any IP addresses associated with malicious infrastructure (like C2 servers, scanners, or TOR exit nodes) are interacting with the organization's network perimeter, providing an early warning of targeted interest.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Perimeter Firewalls
      - Internet Gateway
      - External DNS Servers
      - Cloud Network Gateways
    range: last 90 days
    queries:
      - "Pseudocode: JOIN network_logs ON destination_ip WITH cti_feed ON malicious_ip WHERE timestamp > now() - 90d"
  - question: Which of the identified malicious IPs are most active against our network?
    context: Not all threat intelligence matches carry the same weight. By isolating the CTI-matched IPs and ranking them by activity volume (connections, queries), analysts can prioritize their investigative efforts on the most persistent or aggressive threats, which may indicate a more determined adversary.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Perimeter Firewalls
      - Internet Gateway
      - External DNS Servers
      - Cloud Network Gateways
    range: last 90 days
    queries:
      - "Pseudocode: FROM cti_matched_events | GROUP BY source_ip | COUNT connections, queries | FILTER count > 95th_percentile_of_all_matched_sources_last_24h"
  - question: Is there an anomalous spike in overall reconnaissance activity from known malicious sources?
    context: Individual malicious connections can be lost in the noise. By applying a time series forecast to the aggregate volume of CTI-matched events, we can establish a baseline of expected 'background radiation' from known bad IPs. A significant deviation from this forecast signals a potential large-scale or coordinated campaign that requires immediate attention.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Perimeter Firewalls
      - Internet Gateway
      - External DNS Servers
      - Cloud Network Gateways
    range: last 90 days
    queries:
      - "Pseudocode: APPLY time_series_forecast(ARIMA) to hourly_cti_event_count | ALERT if current_count > upper_confidence_bound"
  - question: Are external sources using known reconnaissance tools against our public-facing services?
    context: Adversaries frequently use off-the-shelf scanning tools like Nmap, Masscan, or Nuclei. These tools often leave distinct fingerprints, such as unique User-Agent strings in HTTP headers or specific JA3/JA3S hashes in SSL/TLS handshakes. Detecting these signatures provides direct evidence of active reconnaissance.
    answer_sources:
      - Zeek http.log
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Public-facing Web Servers
      - Application Delivery Controllers
      - External DNS Servers
      - VPN Concentrators
    range: last 90 days
    queries:
      - "Pseudocode: SEARCH http_logs, ssl_logs, dns_logs FOR recon_tool_signatures (regex on user_agent, JA3/JA3S hash match, suspicious query patterns)"
  - question: Are any external IPs exhibiting port scanning behavior (either broad or targeted)?
    context: The pattern of port connections from a source IP can reveal its intent. Calculating the Shannon entropy of destination ports helps quantify this pattern. A high entropy (many random ports) suggests a broad scan to find any open service, while a very low entropy (one or two ports repeated across many hosts) can indicate a targeted probe for a specific vulnerability.
    answer_sources:
      - Zeek conn.log
      - Public-facing Web Servers
      - Application Delivery Controllers
      - External DNS Servers
      - VPN Concentrators
    range: last 90 days
    queries:
      - "Pseudocode: FOR each source_ip | CALCULATE shannon_entropy(destination_ports) over 1min window | FLAG if entropy is in top_5_percentile OR bottom_5_percentile"
  - question: Can we use machine learning to proactively identify network sessions that are likely reconnaissance?
    context: Signature-based methods can be brittle and easy to evade. A machine learning classification model can learn the subtle, multi-faceted patterns of reconnaissance from features like TCP flags, payload sizes, and connection durations. This allows for the detection of novel or obfuscated scanning techniques that static rules might miss.
    answer_sources:
      - Zeek http.log
      - Zeek conn.log
      - Public-facing Web Servers
      - Application Delivery Controllers
      - External DNS Servers
      - VPN Concentrators
    range: last 90 days
    queries:
      - "Pseudocode: DEPLOY classification_model(features: tcp_flags, payload_size, duration, user_agent) | SCORE new network sessions | ALERT if score > recon_threshold"
  - question: Is any single external IP address attempting to connect to a large number of our internal hosts unsuccessfully?
    context: A high volume of failed connections (e.g., TCP resets or timeouts) from a single external source to many distinct internal destinations is a classic indicator of a network sweep. This simple, threshold-based alert is highly effective at detecting this common and noisy reconnaissance technique.
    answer_sources:
      - Zeek conn.log
      - Network DMZ
      - Perimeter Firewalls
      - Cloud Security Groups
      - VPC Flow Logs
    range: last 90 days
    queries:
      - "Pseudocode: ALERT if source_ip generates > 100 failed_connections (REJ, RSTO, S0) to unique destination_ips within 10 minutes"
  - question: Which external IP addresses have an anomalously high ratio of failed-to-successful connections?
    context: Legitimate clients usually establish connections successfully. In contrast, scanners often generate a high ratio of failed connections as they probe for open ports. By calculating this ratio for each source and flagging statistical outliers (e.g., those 3+ standard deviations from the mean), we can dynamically identify scanning behavior without relying on fixed thresholds.
    answer_sources:
      - Zeek conn.log
      - Network DMZ
      - Perimeter Firewalls
      - Cloud Security Groups
      - VPC Flow Logs
    range: last 90 days
    queries:
      - "Pseudocode: FOR each source_ip | CALCULATE failed_connection_ratio over 5min | FLAG if ratio > (mean_ratio + 3 * stdev_ratio) for all external traffic"
  - question: Can we identify groups of external scanners based on their connection patterns?
    context: Unsupervised machine learning, such as DBSCAN clustering, can group external IP addresses with similar behaviors (e.g., number of hosts scanned, port ranges, failure rates). This can reveal coordinated scanning campaigns from multiple sources or, by identifying 'noise' points, highlight unique scanners with highly anomalous behavior that warrants investigation.
    answer_sources:
      - Zeek conn.log
      - Network DMZ
      - Perimeter Firewalls
      - Cloud Security Groups
      - VPC Flow Logs
    range: last 90 days
    queries:
      - "Pseudocode: APPLY DBSCAN clustering to source_ips with features (distinct_dest_ips, distinct_dest_ports, failure_ratio) | INVESTIGATE anomalous clusters and noise points"
  - question: Is our network monitoring system (Zeek) generating notices related to scanning or protocol violations from external sources?
    context: Zeek's Notice Framework is designed to flag suspicious activity based on its deep protocol analysis. Alerting directly on high-fidelity notices like 'Scan::Port_Scan' or 'SSL::Invalid_Server_Cert' leverages the tool's built-in expertise to provide reliable alerts for reconnaissance activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dpd.log
      - Zeek notice.log
      - Public-facing Application Servers (e.g., Web, VPN, RDP)
      - Internet Gateway
      - External-facing Container Platforms
    range: last 90 days
    queries:
      - "Pseudocode: ALERT on notice.log events where note IN (Scan::Port_Scan, SSL::Invalid_Server_Cert, PacketFilter::Drop) AND source_ip is external"
  - question: Are external sources making unusually short or low-data connections to our high-value services?
    context: Service fingerprinting probes are often quick "hit-and-run" connections, designed only to grab a service banner or identify a version, not to engage in a full session. By baselining normal connection duration and data transfer sizes for critical services (e.g., RDP, SSH, VPN), we can flag sources whose connections are anomalously short and small, indicating a likely fingerprinting attempt.
    answer_sources:
      - Zeek conn.log
      - Public-facing Application Servers (e.g., Web, VPN, RDP)
      - Internet Gateway
      - External-facing Container Platforms
    range: last 90 days
    queries:
      - "Pseudocode: FOR each source_ip to high_value_port | CALCULATE median_duration, total_bytes | FLAG if metrics < 10th_percentile of all connections to that port"
  - question: Is there a sudden increase in traffic that doesn't match the expected protocol for a given port?
    context: An adversary might send non-HTTP traffic to port 80/443 to fingerprint a web server or check for vulnerabilities. Zeek's Dynamic Protocol Detection (DPD) identifies such mismatches. An anomalous spike in DPD violation events, especially from a single source, strongly suggests a coordinated service fingerprinting or evasion attempt.
    answer_sources:
      - Zeek dpd.log
      - Public-facing Application Servers (e.g., Web, VPN, RDP)
      - Internet Gateway
      - External-facing Container Platforms
    range: last 90 days
    queries:
      - "Pseudocode: APPLY time_series_analysis to count of dpd.log mismatches per hour | ALERT if anomalous spike is detected from a specific source_ip"
  - question: Is anyone attempting to perform a DNS zone transfer of our domains?
    context: A DNS zone transfer (AXFR/IXFR query) is an attempt to download all DNS records for a domain. If initiated by an unauthorized external source, it is a blatant and highly effective reconnaissance technique to map an organization's entire named infrastructure. Such an event should always be a high-priority alert.
    answer_sources:
      - Zeek dns.log
      - Authoritative External DNS Servers
      - Recursive DNS Resolvers
      - Cloud DNS Services (e.g., Route 53)
    range: last 90 days
    queries:
      - "Pseudocode: ALERT if dns.log shows query_type is 'AXFR' or 'IXFR' for an organizational domain from an external source"
  - question: Are any external sources generating an unusually high number of failed DNS lookups for our domains?
    context: A high ratio of NXDOMAIN (Non-Existent Domain) responses for a single source IP is a strong indicator of subdomain brute-forcing or dictionary attacks. The adversary is guessing hostnames (e.g., vpn.corp.com, dev.corp.com), and the high failure rate reveals their activity.
    answer_sources:
      - Zeek dns.log
      - Authoritative External DNS Servers
      - Recursive DNS Resolvers
      - Cloud DNS Services (e.g., Route 53)
    range: last 90 days
    queries:
      - "Pseudocode: FOR each external source_ip | CALCULATE ratio of NXDOMAIN_responses to total_queries over 15min | FLAG if ratio > 98th_percentile"
  - question: Can we use anomaly detection to identify abnormal DNS query patterns from external sources?
    context: Sophisticated DNS reconnaissance can be subtle. An unsupervised anomaly detection model (like One-Class SVM or Isolation Forest) can learn the profile of 'normal' external DNS query behavior across multiple features (e.g., query rate, type distribution, name complexity). It can then flag outliers that represent novel or slow-and-low enumeration techniques that simpler rules would miss.
    answer_sources:
      - Zeek dns.log
      - Authoritative External DNS Servers
      - Recursive DNS Resolvers
      - Cloud DNS Services (e.g., Route 53)
    range: last 90 days
    queries:
      - "Pseudocode: DEPLOY one_class_svm_model(features: query_freq, type_dist, name_len, nxdomain_rate) | SCORE new DNS query patterns | ALERT on outliers"
  - question: Is a compromised internal host being used to scan external networks?
    context: Adversaries often use a compromised internal host to pivot and conduct reconnaissance against other external targets. An internal workstation or server (that is not an authorized scanner) initiating connections to a high number of unique external IPs is a major red flag. Correlating this with process execution logs can help pinpoint the malicious binary responsible.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Endpoint Devices
      - Internal Server Segments
      - Egress Firewalls
      - Cloud Compute Instances (e.g., EC2)
    range: last 90 days
    queries:
      - "Pseudocode: ALERT if internal_host connects to > 50 unique external_ips on non-standard_ports in 1hr | CORRELATE with process_creation_logs on that host"
  - question: Has any internal host suddenly started contacting a significantly higher number of external IPs than it normally does?
    context: Most hosts have a stable, predictable pattern of outbound communication. By creating a dynamic baseline (moving average and standard deviation) of distinct external IPs contacted per day for each host, we can detect a sharp, statistically significant increase. Such an anomaly is a strong indicator that the host has been compromised and is being used for scanning.
    answer_sources:
      - Zeek conn.log
      - Endpoint Devices
      - Internal Server Segments
      - Egress Firewalls
      - Cloud Compute Instances (e.g., EC2)
    range: last 90 days
    queries:
      - "Pseudocode: FOR each internal_host | CALCULATE daily_distinct_external_ip_count | ALERT if daily_count > (30day_moving_avg + 4 * 30day_stdev)"
  - question: Can we statistically separate normal outbound connection patterns from anomalous scanning spikes on a per-host basis?
    context: A host's network traffic has normal rhythms (trends, seasonality). Time series decomposition allows us to filter out these predictable patterns and focus on the 'residual' or unexplained noise. Applying anomaly detection to this residual data provides a very sensitive method for finding sudden bursts of outbound scanning that are not part of the host's normal behavior.
    answer_sources:
      - Zeek conn.log
      - Endpoint Devices
      - Internal Server Segments
      - Egress Firewalls
      - Cloud Compute Instances (e.g., EC2)
    range: last 90 days
    queries:
      - "Pseudocode: FOR each internal_host | DECOMPOSE outbound_connection_count_timeseries | APPLY z-score_on_residuals | ALERT on high z-score"