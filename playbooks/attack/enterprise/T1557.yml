name: T1557: Adversary-in-the-Middle
id: f8a5c3d2-1b6e-4f9a-8c7d-0e4b1a2c3d4e
description: This playbook helps investigate Adversary-in-the-Middle (AiTM) attacks, where an adversary positions themself in a communication channel to intercept, manipulate, and steal data. It focuses on two primary goals of AiTM: credential access and data collection. The investigation covers detecting malicious SSL/TLS certificates, network spoofing (ARP, DNS), protocol downgrade attacks, credential submission to suspicious sites, and the subsequent collection of sensitive data through traffic interception, content manipulation, or routing traffic through a compromised internal node. By analyzing network and endpoint data, analysts can identify signs of traffic manipulation, unauthorized data aggregation, and credential theft attempts.
type: technique
related:
  - TA0006: Credential Access
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there SSL/TLS certificates with fingerprints matching known malicious lists associated with AiTM campaigns?
    context: Adversaries often use SSL/TLS certificates with known malicious fingerprints or issuer details as part of their AiTM phishing infrastructure. This question aims to identify connections to sensitive services that use these known-bad certificates, which is a high-confidence indicator of an AiTM attack.
    answer_sources:
      - Zeek x509.log
      - Zeek ssl.log
      - Network Egress Points
      - Servers hosting SSO/VPN/email
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          search zeek_x509_logs
          | join certificate_sha1 with known_malicious_cert_feed on sha1
          | if match, alert high severity
  - question: Has a new or statistically rare certificate issuer appeared for a high-value service like SSO, VPN, or O365?
    context: High-value services typically use a consistent and limited set of certificate issuers. The sudden appearance of a new or very rare issuer for one of these services can indicate that traffic is being intercepted by an adversary using a fraudulent certificate. This question helps detect such anomalies by baselining normal issuer behavior.
    answer_sources:
      - Zeek x509.log
      - Zeek ssl.log
      - Network Egress Points
      - Servers hosting SSO/VPN/email
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          baseline zeek_ssl_logs for server_name, calculate frequency of certificate_issuer
          | search zeek_ssl_logs where server_name is high_value_service
          | if issuer_frequency < 0.1% of baseline, alert
  - question: Have any SSL/TLS certificates been classified as malicious by a predictive model?
    context: This question uses a machine learning approach to proactively identify malicious certificates that may not yet be on threat intelligence lists. By analyzing various certificate features (e.g., validity period, key length, self-signed status), a model can score certificates for maliciousness, helping to uncover novel AiTM infrastructure.
    answer_sources:
      - Zeek x509.log
      - Zeek ssl.log
      - Network Egress Points
      - Servers hosting SSO/VPN/email
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each new certificate in zeek_x509_logs:
            score = classification_model(certificate_features)
            if score > 0.9, alert
  - question: Are there any explicit network spoofing alerts or executions of known AiTM tools on endpoints?
    context: This question looks for direct evidence of AiTM activity, either through network security monitoring alerts (like ARP or DNS spoofing) or the execution of common AiTM tools (e.g., Responder, Ettercap) on endpoints. A positive finding is a strong indicator of an active AiTM attempt on the local network.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Windows Event ID 4688
      - Windows Event ID 4776
      - Core Network Switches
      - Client Workstation Segments
      - Domain Controllers
      - Wireless Access Points
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          search zeek_notices for notice_type in ["ARP_Spoofing", "DNS_Spoofing_Attack"] OR
          search process_creation_logs (EID 4688) for process_name in ["responder.py", "ettercap", "bettercap.exe"]
          | if match, alert high severity
  - question: Has a default gateway's MAC address changed, or is a single MAC address rapidly claiming multiple IP addresses?
    context: In a classic ARP spoofing attack, an adversary's machine will illegitimately claim the IP address of the default gateway. Monitoring for changes to the gateway's MAC address can detect this. Additionally, an attacker's host may respond to many ARP requests, causing its MAC to be associated with numerous IPs in a short period.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Windows Event ID 4688
      - Windows Event ID 4776
      - Core Network Switches
      - Client Workstation Segments
      - Domain Controllers
      - Wireless Access Points
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          baseline gateway_mac_per_subnet
          | monitor for changes to baseline, alert on change
          | for each 5_minute_window:
              count unique_ips per mac_address
              if count > 99th_percentile_threshold, alert
  - question: Is there an anomalous volume of LLMNR or NBT-NS traffic from a non-authoritative host?
    context: Tools like Responder poison LLMNR and NBT-NS responses to trick clients into sending credentials to an attacker-controlled machine. This poisoning activity often creates a "storm" of traffic from the attacker's host. This question aims to detect such anomalies by modeling normal traffic volumes for these protocols.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Windows Event ID 4688
      - Windows Event ID 4776
      - Core Network Switches
      - Client Workstation Segments
      - Domain Controllers
      - Wireless Access Points
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          forecast expected_llmnr_nbtns_traffic_volume per host
          | for each host:
              if observed_volume significantly > forecasted_volume, alert
  - question: Are clients connecting to critical services using deprecated protocols (SSLv3, TLS 1.0/1.1) or weak ciphers?
    context: Adversaries may perform a downgrade attack, forcing a client and server to negotiate a weaker encryption protocol or cipher suite that the adversary can break or decrypt. This question looks for the use of these outdated and insecure protocols, which should not be in use for connections to critical services.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network Egress Points
      - Internal Application Servers
      - Web Proxies
      - VPN Concentrators
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          search zeek_ssl_logs where destination is critical_service
          | if protocol_version in ["SSLv3", "TLSv1", "TLSv1.1"] or cipher in weak_cipher_list, alert high priority
  - question: Has there been a statistical increase in the percentage of sessions using weak protocols for a critical service?
    context: While a single connection with a weak protocol is suspicious, a sudden increase in the proportion of such connections to a specific service is a stronger indicator of a widespread downgrade attack. This question establishes a baseline of protocol usage and alerts on deviations from the norm.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network Egress Points
      - Internal Application Servers
      - Web Proxies
      - VPN Concentrators
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each critical_service:
            calculate moving_average of weak_protocol_percentage
            if current_percentage > 95th_percentile of historical_average, alert
  - question: Are there network sessions flagged by a predictive model as having a high probability of being an illegitimate downgrade attack?
    context: This question uses a machine learning model to assess the likelihood that a session was maliciously downgraded. By considering features like user-agent, destination, and time of day, the model can identify suspicious downgrades that might otherwise be missed, especially when legacy clients are present in the environment.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network Egress Points
      - Internal Application Servers
      - Web Proxies
      - VPN Concentrators
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each new connection:
            probability = downgrade_model(session_features)
            if probability is high, flag for review
  - question: Are critical external domains resolving to internal or non-legitimate IP addresses?
    context: A common AiTM technique is DNS poisoning, where an adversary causes a legitimate domain name (e.g., login.microsoftonline.com) to resolve to an IP address they control. This question checks for this by comparing DNS responses for critical domains against a list of their known, legitimate IP ranges.
    answer_sources:
      - Zeek dns.log
      - Windows DNS Client Events
      - Internal DNS Resolvers
      - Client Workstation Segments
      - Network Egress Points
      - Domain Controllers
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          search zeek_dns_logs for query in critical_domain_list
          | if resolved_ip is in RFC1918_range or not in legitimate_ip_range, alert
  - question: Has the entropy of resolved IP addresses for a high-value domain suddenly dropped?
    context: Normally, a high-value external service is hosted on multiple servers, resulting in a variety of resolved IPs (high entropy). In a DNS poisoning attack, many clients are redirected to a single attacker-controlled IP, causing a sharp drop in the entropy of resolved addresses. This question aims to detect this statistical anomaly.
    answer_sources:
      - Zeek dns.log
      - Windows DNS Client Events
      - Internal DNS Resolvers
      - Client Workstation Segments
      - Network Egress Points
      - Domain Controllers
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each high_value_domain in 1_hour_window:
            calculate shannon_entropy of resolved_ips
            if entropy < learned_threshold, alert
  - question: Has a cluster of clients started resolving a common domain to a new, shared, non-legitimate IP address?
    context: This question uses clustering algorithms to identify groups of clients exhibiting anomalous DNS behavior. A successful DNS poisoning attack will create a distinct cluster where numerous clients suddenly begin resolving a domain to the same new, malicious IP, a pattern that clustering can effectively detect.
    answer_sources:
      - Zeek dns.log
      - Windows DNS Client Events
      - Internal DNS Resolvers
      - Client Workstation Segments
      - Network Egress Points
      - Domain Controllers
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          run DBSCAN on (client_ip, queried_domain, resolved_ip)
          | identify and alert on new clusters where resolved_ip is non-legitimate
  - question: After an AiTM indicator was triggered, did the affected client send credentials via an HTTP POST to a known malicious domain?
    context: This question directly links a suspected AiTM event (like DNS poisoning) to its likely goal: credential theft. By correlating AiTM alerts with subsequent HTTP POST requests from the same client to phishing or typosquatted domains, analysts can find strong evidence of a successful attack.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          on AiTM_alert for client_ip:
            search zeek_http_logs for source_ip=client_ip and http_method="POST"
            | if destination_host in malicious_domain_feed, alert
  - question: Is a user submitting POST requests to a newly registered or low-reputation domain they have never visited before?
    context: AiTM phishing sites are often hosted on newly registered domains. This question baselines the domains each user typically submits POST requests to and alerts when they interact with a new, suspicious domain (e.g., registered within the last 30 days), which is a strong indicator of a phishing attempt.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          baseline user_post_destinations
          | search zeek_http_logs for http_method="POST"
          | enrich destination_domain with whois_data and reputation_score
          | if domain is new_to_user AND (registered_date < 30_days OR reputation is low), alert
  - question: Have any HTTP POST requests been classified as likely credential submissions to a suspicious domain?
    context: This question uses a machine learning classifier to analyze HTTP POST requests and identify those likely to contain credentials based on URI patterns and form fields. When such a submission is sent to a low-reputation or newly observed domain, it provides a high-confidence signal of credential theft, especially when correlated with other AiTM indicators.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each http_post_request:
            score = credential_submission_model(request_features)
            if score is high AND destination_reputation is low, alert
  - question: Is sensitive data (e.g., PII, financial data) visible in unencrypted traffic from a suspected AiTM node?
    context: Once an adversary has established an AiTM position, they may intercept unencrypted traffic to collect sensitive data. This question involves using IDS or DLP rules to inspect traffic flowing through a suspected malicious node for patterns matching sensitive information like Social Security or credit card numbers.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Core Network Switches
      - File Servers
      - Database Servers
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          apply IDS/DLP signatures to traffic from suspected_aitm_node
          | if signature match for sensitive_data_pattern, alert
  - question: Are sensitive or unusually large files being transferred from a suspected AiTM node?
    context: An adversary may use their AiTM position to exfiltrate collected data. This question focuses on identifying the transfer of sensitive file types (e.g., password databases, email archives) or atypically large compressed files from a compromised node, which could represent bulk data collection.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Core Network Switches
      - File Servers
      - Database Servers
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          monitor zeek_files_logs for transfers from suspected_aitm_node
          | if file_type in sensitive_file_list or file_size is anomalous, alert
  - question: Has there been an anomalous spike in outbound data volume from a suspected AiTM node?
    context: Bulk data collection and exfiltration often result in a significant, anomalous increase in outbound network traffic from the compromised node. This question uses time-series modeling to establish a baseline of normal traffic volume and detect sudden spikes that could indicate data theft.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Core Network Switches
      - File Servers
      - Database Servers
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          model time-series for outbound_bytes from suspected_aitm_node
          | if observed_bytes significantly exceeds forecast, alert
  - question: Is there evidence of malicious content, like JavaScript or iframes, being injected into HTTP responses?
    context: Adversaries can manipulate traffic to inject malicious content into legitimate websites, for example, to deploy browser exploits or capture keystrokes. This question uses signature-based detection to identify known malicious scripts or structures within HTTP response bodies.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          search zeek_http_logs for http_response_body
          | apply signatures for known malicious javascript or iframes
          | if match, alert
  - question: Are there hash mismatches for files downloaded from trusted software repositories?
    context: An adversary can perform an AiTM attack to replace legitimate software downloads with malicious versions. This question aims to detect this by comparing the hash of a downloaded file against the official hash provided by the vendor. A mismatch is a strong indicator of file tampering in transit.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each file_download from trusted_repository:
            lookup official_vendor_hash
            get file_hash from zeek_files_log
            if network_hash != vendor_hash, alert
  - question: Have there been anomalous modifications to the structure of HTTP responses for critical internal web applications?
    context: This question uses an unsupervised machine learning model (an autoencoder) to learn the normal structure of HTTP responses from critical applications. If an adversary injects content, it will alter this structure, resulting in a high reconstruction error from the model, thereby flagging the response as anomalous and potentially malicious.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each http_response from critical_app:
            reconstruction_error = autoencoder_model(response_features)
            if reconstruction_error > threshold, alert
  - question: Is an unauthorized internal host routing traffic between two other internal hosts?
    context: In an internal AiTM scenario, an adversary compromises a host and configures it to route traffic between other machines to intercept their communications. This question identifies such behavior by flagging any host that is not on an approved list of gateways or proxies but is observed acting as one.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Internal Network Segments
      - Datacenter Network Fabric
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          search network_flows where source_ip is internal, dest_ip is internal, and router_ip is internal
          | if router_ip not in authorized_gateway_list, alert high severity
  - question: Has a host begun communicating with an anomalously high number of internal peers compared to its baseline?
    context: A compromised host repurposed for internal AiTM will begin communicating with many more peers than it normally would. This question establishes a baseline for each host's communication patterns and uses outlier detection to identify when a host, such as a workstation, starts behaving like a central server or proxy.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Internal Network Segments
      - Datacenter Network Fabric
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          baseline unique_peer_count per host
          | for each host:
            if current_peer_count > 99th_percentile of baseline, alert
  - question: Has any host's 'betweenness centrality' score in the network communication graph increased suddenly and significantly?
    context: This question applies graph theory to network traffic. A host's 'betweenness centrality' measures how often it lies on the shortest path between other hosts. An AiTM node that successfully reroutes traffic will see its centrality score skyrocket, making it a clear outlier in the network graph and a strong candidate for investigation.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Internal Network Segments
      - Datacenter Network Fabric
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          build communication_graph from zeek_conn_logs
          | periodically calculate betweenness_centrality for each node
          | if node_centrality shows anomalous spike, alert
  - question: Are there specific certificate validation errors, such as 'self-signed' or 'hostname mismatch', for connections to critical services?
    context: When an adversary uses a fraudulent certificate for an AiTM attack, it often results in validation errors on the client side. This question specifically looks for high-risk error types when users are connecting to important services, as this is a common symptom of SSL/TLS interception.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Client Workstation Segments
      - Authentication Servers
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          search zeek_ssl_logs where server_name is critical_service
          | if validation_status in ["self_signed_certificate_in_chain", "host_name_mismatch"], alert
  - question: Has the rate of certificate validation errors for a specific network segment exceeded its historical norm?
    context: A localized AiTM attack, such as ARP spoofing on a specific subnet, would cause a sudden spike in certificate errors for clients in that segment. This question aims to detect such localized attacks by monitoring the error rate per segment and alerting on statistically significant increases.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Client Workstation Segments
      - Authentication Servers
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          monitor rate of cert_validation_errors per network_segment
          | if current_rate > 99th_percentile of 30-day_history, alert
  - question: Is the total volume of certificate validation errors across the network significantly higher than forecasted trends?
    context: A large-scale AiTM attack, such as widespread DNS poisoning, could cause a network-wide surge in certificate validation errors. This question uses time-series forecasting to model the expected number of errors and alerts when the observed count dramatically exceeds the forecast, indicating a major anomaly.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Client Workstation Segments
      - Authentication Servers
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          forecast total_cert_validation_errors network-wide
          | if observed_error_count significantly > forecast_confidence_interval, alert
  - question: Has a client endpoint started receiving connections from an unusually high number of unique internal hosts?
    context: An adversary might compromise a standard client workstation and turn it into a collection point for data gathered from other internal systems. This behavior is abnormal for a client endpoint. This question identifies such activity by flagging any client that receives connections from more than a set number of peers in a short time.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Datacenter Network Fabric
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each 10_minute_window:
            count unique_source_ips connecting to each client_endpoint
            if count > 20, alert
  - question: Is any host exhibiting a 'many-to-one' traffic pattern, receiving data from many peers and sending it to one?
    context: A host acting as a data aggregator or an intermediary exfiltration point will often receive data from many internal sources and then forward it to a single external or internal destination. This question identifies this statistical outlier behavior by calculating the ratio of inbound bytes from multiple peers to outbound bytes to a single peer.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Datacenter Network Fabric
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          for each host:
            calculate ratio = (bytes_in_from_many_peers / bytes_out_to_one_peer)
            if ratio is high and host is not a known log_collector, alert
  - question: Does any host exhibit an anomalously high 'degree centrality' compared to its peers in the network graph?
    context: This question uses graph analysis to find data collection points. In a network communication graph, a host acting as an aggregator will form a 'star' topology, connecting to many other nodes. This results in an unusually high 'degree centrality' (number of connections) compared to other hosts of its type (e.g., other workstations), making it a prime suspect.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Datacenter Network Fabric
      - Client Workstation Segments
    range: Last 90 days
    queries:
      - language: pseudocode
        query: |
          build communication_graph from network_flows
          | calculate degree_centrality for each node
          | if a workstation's centrality is anomalously high compared to other workstations, alert