name: T1557: Adversary-in-the-Middle
id: a8b3d1e4-5f78-4a9c-8a2d-9f6b7c0d1e2f
description: This playbook provides investigative steps to detect Adversary-in-the-Middle (AiTM) attacks, a technique used for both credential access and data collection. The investigation focuses on identifying evidence of network traffic manipulation, such as the use of malicious or anomalous SSL/TLS certificates, ARP and DNS spoofing, and protocol downgrade attacks. It also covers detecting the execution of common AiTM tools, suspicious credential submissions to phishing sites, and the interception and modification of sensitive data in transit. The playbook leverages network and endpoint data sources to uncover anomalies like unexpected network choke points, widespread certificate errors, and behavioral changes in host communication patterns that indicate an adversary is intercepting and controlling network traffic.
type: technique
related:
  - TA0006: Credential Access
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are SSL/TLS certificates with known malicious SHA1 hashes being observed in the network?
    context: This question aims to detect the use of certificates explicitly linked to malicious campaigns or AiTM phishing kits. A match provides a high-confidence indicator that an adversary is attempting to impersonate a legitimate service to intercept traffic.
    answer_sources:
      - Zeek x509.log
      - Zeek ssl.log
      - Network Egress Points
      - Servers hosting SSO/VPN/email
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek x509 logs WHERE certificate_sha1 IN (malicious_sha1_feed) | ALERT
  - question: Are new or statistically rare certificate issuers appearing for high-value services like SSO, VPN, or O365?
    context: Adversaries may use self-signed certificates or certificates from unusual CAs. By baselining normal issuer patterns for critical services, this question helps detect anomalies that could indicate an AiTM attack attempting to present a fraudulent certificate.
    answer_sources:
      - Zeek x509.log
      - Zeek ssl.log
      - Network Egress Points
      - Servers hosting SSO/VPN/email
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek ssl logs FOR service (server_name) | BASELINE issuer frequency | ALERT on new or rare issuer
  - question: Are any observed SSL/TLS certificates being classified as malicious by a machine learning model based on their intrinsic properties?
    context: This question leverages machine learning to proactively identify suspicious certificates that may not be on a known-bad list. It analyzes features like validity period, key length, and self-signed status to flag certificates that exhibit characteristics common to malicious issuance, indicating a potential AiTM attempt.
    answer_sources:
      - Zeek x509.log
      - Zeek ssl.log
      - Network Egress Points
      - Servers hosting SSO/VPN/email
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT Zeek x509 logs INTO classification_model | ALERT on certificate score > 0.9
  - question: Is there evidence of ARP or DNS spoofing attacks, or are known AiTM tools like Responder or Ettercap being executed on endpoints?
    context: This question looks for direct evidence of tools and techniques used to poison local network caches (ARP, DNS) to redirect traffic. An alert for these specific activities is a strong indicator of an active AiTM attack on the local network segment.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Windows Event ID 4688
      - Windows Event ID 4776
      - Core Network Switches
      - Client Workstation Segments
      - Domain Controllers
      - Wireless Access Points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek notices for 'ARP_Spoofing' OR 'DNS_Spoofing_Attack' OR SEARCH endpoint logs (EID 4688) for process names IN ('responder.py', 'ettercap', 'bettercap.exe') | ALERT
  - question: Has the MAC address of a default gateway changed, or is a single MAC address claiming an unusually high number of IP addresses?
    context: This question aims to detect classic ARP spoofing. A change in the gateway's MAC address indicates another device is impersonating it. A single MAC claiming multiple IPs can indicate an attacker's machine responding to ARP requests for many different hosts on the subnet.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Windows Event ID 4688
      - Windows Event ID 4776
      - Core Network Switches
      - Client Workstation Segments
      - Domain Controllers
      - Wireless Access Points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE gateway MAC per subnet | ALERT on change. COUNT unique IPs per MAC in 5-min window | ALERT if count > threshold
  - question: Is any single host generating an anomalous volume of LLMNR or NBT-NS traffic?
    context: Tools like Responder abuse legacy name resolution protocols (LLMNR, NBT-NS) to poison name requests on a local network. A sudden spike in this traffic from a single host that is not a designated server is a strong indicator of an AiTM poisoning attempt.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Windows Event ID 4688
      - Windows Event ID 4776
      - Core Network Switches
      - Client Workstation Segments
      - Domain Controllers
      - Wireless Access Points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL LLMNR/NBT-NS traffic volume per host | ALERT on significant deviation from forecast
  - question: Are connections to critical services using deprecated protocols (SSLv3, TLS 1.0/1.1) or weak cipher suites?
    context: This question seeks to identify downgrade attacks, where an adversary forces a client and server to negotiate a weaker encryption protocol or cipher that is easier to break. Observing these weak protocols in use against modern services is a high-fidelity indicator of an AiTM attack.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network Egress Points
      - Internal Application Servers
      - Web Proxies
      - VPN Concentrators
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek ssl logs for connections to critical services WHERE tls_version IN ('SSLv3', 'TLSv1', 'TLSv1.1') OR cipher IN (weak_cipher_list) | ALERT
  - question: Is there a statistical increase in the percentage of sessions using weak protocols for any critical services?
    context: This question moves beyond simple alerting to detect subtle, widespread downgrade attacks. By baselining the normal protocol usage for a service, a significant shift towards weaker protocols, even if they are not completely deprecated, can indicate an adversary's attempt to weaken security across many connections.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network Egress Points
      - Internal Application Servers
      - Web Proxies
      - VPN Concentrators
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE weak protocol percentage per service | CALCULATE moving average | ALERT if current_percentage > 95th_percentile
  - question: Are any network sessions predicted to be illegitimately downgraded based on a combination of session features?
    context: This question uses a predictive model to identify suspicious downgrades that might not be caught by static rules. It considers context like the client's user-agent and time of day to determine if a downgrade is expected (e.g., a legacy client) or anomalous (a modern client suddenly using a weak protocol), pointing to a potential AiTM attack.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network Egress Points
      - Internal Application Servers
      - Web Proxies
      - VPN Concentrators
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT session features (user-agent, SNI, time) into logistic_regression_model | ALERT on high probability of downgrade
  - question: Are critical external domains (e.g., login.microsoftonline.com) resolving to internal or non-corporate IP addresses?
    context: This is a direct check for DNS poisoning. If a trusted external service's domain name resolves to an internal or otherwise unauthorized IP address, it is a strong sign that an adversary is redirecting users to a malicious server under their control to perform an AiTM attack.
    answer_sources:
      - Zeek dns.log
      - Windows DNS Client Events
      - Internal DNS Resolvers
      - Client Workstation Segments
      - Network Egress Points
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek dns logs for queries to critical_domains | ALERT if resolved_ip is internal OR NOT IN legitimate_ip_range
  - question: Has there been a sudden drop in the variety (entropy) of resolved IP addresses for a high-value domain?
    context: Legitimate high-traffic services often resolve to many different IP addresses for load balancing. A DNS poisoning attack will often cause many clients to resolve the domain to a single malicious IP. This question detects this convergence by monitoring the entropy of resolved IPs, where a sudden drop indicates a potential widespread poisoning event.
    answer_sources:
      - Zeek dns.log
      - Windows DNS Client Events
      - Internal DNS Resolvers
      - Client Workstation Segments
      - Network Egress Points
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE shannon entropy of resolved IPs per domain over 1-hour window | ALERT if entropy drops below threshold
  - question: Has an anomalous cluster of clients formed that are all resolving a common domain to a new, shared IP address?
    context: This question uses unsupervised machine learning to find groups of victims in a DNS poisoning attack. The clustering algorithm identifies a group of clients behaving anomalously in the same way (resolving a specific domain to the same suspicious IP), which is a strong signal of a coordinated AiTM attack.
    answer_sources:
      - Zeek dns.log
      - Windows DNS Client Events
      - Internal DNS Resolvers
      - Client Workstation Segments
      - Network Egress Points
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: RUN DBSCAN on (client_ip, domain, resolved_ip) | ALERT on new anomalous clusters
  - question: Following a potential AiTM indicator, is the affected user submitting data via HTTP POST to a known malicious domain?
    context: This question links a potential traffic interception event (like DNS poisoning) with the likely goal credential theft. If a user whose traffic is being redirected is then observed sending data to a known phishing domain, it strongly suggests a successful AiTM attack is in progress.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: IF AiTM_alert for client_ip, THEN SEARCH for subsequent http.log POST from client_ip WHERE destination IN (phishing_feed) | ALERT
  - question: Are users submitting POST requests to newly registered domains or domains they have never interacted with before?
    context: Adversaries often use newly registered domains for phishing campaigns. This question establishes a baseline of normal user behavior (i.e., the sites they typically log into) and flags deviations, such as submitting credentials to a suspicious, newly created domain, which is a common tactic in AiTM phishing.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE POST destinations per user | ALERT if user posts to a domain registered < 30 days ago OR a new domain for that user
  - question: Are any HTTP POST requests classified as likely credential submissions being sent to low-reputation or newly observed domains?
    context: This question uses a model to intelligently identify credential submissions, even on unknown pages, by looking for common patterns (like '/login' in the URL or 'password' in form fields). It then correlates these submissions with domain reputation to find high-risk events, such as a likely password submission to a suspicious website, a key indicator of AiTM credential harvesting.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT http.log POST requests into classifier | IF score > threshold AND destination_reputation is low, THEN ALERT
  - question: Is sensitive data (PII, financial info) being observed in unencrypted traffic to or from a suspected AiTM node?
    context: This question looks for the exfiltration or collection of sensitive information in cleartext. If an adversary has successfully downgraded a connection or is intercepting unencrypted protocols, this detection can identify the specific data being stolen.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Core Network Switches
      - File Servers
      - Database Servers
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY DLP regex (SSN, CC#) to unencrypted traffic from suspected_aitm_node | ALERT on match
  - question: Are sensitive file types (e.g., .pst, .kdbx) or unusually large archives being transferred from a suspected AiTM node?
    context: Adversaries often collect and stage data in archives before exfiltration. This question monitors file transfers for tell-tale signs of data collection, such as the movement of password databases, email archives, or large, compressed files that are out of place for the network flow.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Core Network Switches
      - File Servers
      - Database Servers
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek files.log for transfers from suspected_aitm_node WHERE file_type IN (sensitive_types) OR file_size > threshold | ALERT
  - question: Is there an anomalous spike in outbound data volume from a suspected AiTM node, especially during non-business hours?
    context: Bulk data collection often results in a significant, unusual increase in network traffic. This question uses anomaly detection to identify when a node starts sending out much more data than it normally does, which could indicate the exfiltration phase following data collection via AiTM.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Core Network Switches
      - File Servers
      - Database Servers
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL outbound byte count for suspected_aitm_node | ALERT on anomalous spike
  - question: Are known malicious scripts or iframes being injected into HTTP responses?
    context: An adversary in the middle can modify legitimate web pages to inject malicious content, such as scripts to skim credentials or load malware. This question uses signature-based detection to find known malicious injections in real-time.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek http.log response bodies for malicious_js_signatures or iframe_patterns | ALERT on match
  - question: Are there hash mismatches for files being downloaded from trusted software repositories?
    context: This question aims to detect on-the-fly file modification, where an adversary intercepts a legitimate file download and replaces it with a malicious version. A hash mismatch is a definitive indicator that the file was altered in transit.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON file download from trusted_repo, GET vendor_hash | COMPARE with downloaded_file_hash from Zeek files.log | ALERT on mismatch
  - question: Do HTTP responses for critical internal applications show signs of structural modification when analyzed by an autoencoder?
    context: This question uses an anomaly detection model to spot subtle changes in web page structure that could indicate malicious injection. An autoencoder learns what a normal page looks like and flags deviations, allowing it to detect novel or unknown modifications made by an AiTM adversary.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Network Egress Points
      - Web Proxies
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT HTTP response structure into trained_autoencoder | ALERT on high reconstruction_error
  - question: Is an unauthorized internal host acting as a gateway or router for traffic between other internal hosts?
    context: Standard workstations should not be routing traffic between other devices. This question identifies when a compromised host is being used as an illegitimate pivot or choke point to intercept internal traffic, a clear sign of an AiTM position.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Internal Network Segments
      - Datacenter Network Fabric
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek conn.log for traffic between host_A and host_B routed via host_C | IF host_C is not in allowed_gateways_list, THEN ALERT
  - question: Is any host, particularly a workstation, suddenly communicating with an anomalously high number of internal peers?
    context: A host that is intercepting traffic via techniques like ARP spoofing will suddenly begin communicating with many devices on its subnet. This question detects this behavioral change, flagging a host that deviates from its normal role-based communication patterns and starts acting like a network hub.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Internal Network Segments
      - Datacenter Network Fabric
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE unique peers per host | ALERT if host's peer count exceeds percentile-based threshold
  - question: Has any host's 'betweenness centrality' score suddenly increased, placing it on the critical communication path between other nodes?
    context: In network graph theory, 'betweenness centrality' measures how often a node lies on the shortest path between other nodes. An AiTM node will naturally have a high centrality. This question applies graph analysis to find nodes that have anomalously become critical communication hubs, indicating they are intercepting traffic.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Internal Network Segments
      - Datacenter Network Fabric
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BUILD network graph from Zeek conn.log | CALCULATE betweenness_centrality for each host | ALERT on significant score increase
  - question: Are certificate validation errors like 'self-signed' or 'hostname mismatch' occurring when clients access critical services?
    context: When an adversary presents a fraudulent certificate for an AiTM attack, it often results in validation errors on the client side (unless the client's trust store is also compromised). This question detects these specific, high-risk errors when connecting to important services.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Client Workstation Segments
      - Authentication Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek ssl.log for connections to critical_services WHERE validation_status IN ('self_signed...', 'host_name_mismatch') | ALERT
  - question: Is there a statistical increase in the rate of certificate validation errors within a specific network segment?
    context: A localized AiTM attack (e.g., ARP spoofing on one subnet) would cause a spike in certificate errors for clients in that segment. This question aims to detect such localized anomalies by monitoring the error rate per segment and alerting on statistically significant increases.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Client Workstation Segments
      - Authentication Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR cert validation error rate per subnet | ALERT if rate > 99th percentile of historical data
  - question: Is the network-wide volume of certificate validation errors significantly exceeding forecasted levels?
    context: This question provides a broad, network-wide view to detect large-scale AiTM attacks (e.g., widespread DNS poisoning). By forecasting the expected number of normal validation errors, it can identify a statistically significant surge that points to a major security event.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Client Workstation Segments
      - Authentication Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FORECAST total cert validation errors using ARIMA | ALERT if observed_count > forecast + confidence_interval
  - question: Is any client endpoint receiving inbound connections from an unusually large number of other internal hosts?
    context: A client workstation typically initiates connections but receives very few. A compromised host being used as a data collection point or internal C2 server would violate this pattern. This question detects this by flagging clients that start acting like servers.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Datacenter Network Fabric
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: COUNT unique internal source IPs connecting to each client in 10-min window | ALERT if count > 20
  - question: Is any non-server host exhibiting a 'many-to-one' traffic pattern, receiving data from many peers and sending it to one?
    context: This question identifies a specific data aggregation and exfiltration pattern. The host collects data from many internal victims (many-to-one receive) and then funnels it to a single external or internal destination (one-to-many send). This pattern is highly anomalous for a typical workstation.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Datacenter Network Fabric
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE ratio of (bytes_in from many) / (bytes_out to one) for each host | ALERT on high ratio for non-server hosts
  - question: Does any host exhibit a 'star' topology or have an anomalously high degree centrality in the network communication graph?
    context: This question uses graph theory to formalize the detection of a central collection point. In a network graph, a collection point will appear as the center of a 'star' (connected to many otherwise unconnected nodes) and will have a very high 'degree centrality' (number of connections). This provides a robust, mathematical way to identify such nodes.
    answer_sources:
      - Zeek conn.log
      - Core Network Switches
      - Datacenter Network Fabric
      - Client Workstation Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: RUN community detection on network graph | IDENTIFY nodes with high 'degree centrality' or forming 'star' topologies | ALERT