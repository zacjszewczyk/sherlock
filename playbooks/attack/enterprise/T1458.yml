name: T1458: Replication Through Removable Media
id: 59a1e0b5-9b9c-4e8d-8d5a-6a2d7f8c9b0e
description: This playbook helps identify adversaries using removable media, such as USB drives, to compromise systems. It covers two primary scenarios: gaining initial access to a workstation by tricking a user into connecting a malicious mobile device, and using a compromised device to move laterally across the network. Investigations focus on detecting anomalous process behavior, suspicious network connections, and internal scanning activity that occurs shortly after a USB device is connected to a host.
type: technique
related:
  - TA0027: Initial Access
  - TA0033: Lateral Movement
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a process associated with mobile device management (e.g., adb.exe) been executed from a non-standard location or connected to a known malicious IP/domain shortly after a USB connection?
    context: Attackers may abuse legitimate mobile management tools for malicious purposes. A combination of a USB trigger, execution from an unusual path, and a network connection to a known malicious destination is a strong indicator of compromise via a removable device. This question helps detect this high-confidence pattern.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Endpoints with USB ports (corporate workstations, employee laptops, IT helpdesk workstations), public charging kiosks within corporate facilities, DNS servers, network gateways, VPN concentrators, and Mobile Device Management (MDM) servers.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). JOIN with Process creation events (Sysmon 1 / Win 4688) on the same host within 5 minutes. WHERE process is on mobile_management_watchlist AND (process is unsigned OR runs from non-standard path). JOIN with Network connection events (Sysmon 3) within same time window. WHERE destination IP/domain is on threat_intel_feed. ALERT high-severity.
  - question: Did a mobile management process exhibit unusually complex or a high number of command-line arguments following a USB connection, suggesting obfuscation?
    context: High command-line entropy or a significant deviation from normal argument counts can indicate an attacker trying to hide their commands or pass complex, non-standard instructions. This is anomalous for legitimate tools and can reveal attempts to execute malicious code.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Endpoints with USB ports (corporate workstations, employee laptops, IT helpdesk workstations), public charging kiosks within corporate facilities, DNS servers, network gateways, VPN concentrators, and Mobile Device Management (MDM) servers.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). JOIN with subsequent Process creation events (Sysmon 1) on the same host. WHERE process is on mobile_management_watchlist. CALCULATE command-line entropy and argument count. COMPARE with 30-day baseline for that process. ALERT medium-severity if entropy > 98th percentile OR argument count > 3 standard deviations from mean.
  - question: Did a mobile management process make an anomalous network connection (based on port, protocol, data volume, etc.) within 5 minutes of a USB device being connected?
    context: Machine learning models can detect subtle deviations from normal network traffic patterns that rule-based detections might miss. An anomalous connection occurring immediately after a USB event could signify data exfiltration, C2 communication, or the download of a second-stage payload.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Endpoints with USB ports (corporate workstations, employee laptops, IT helpdesk workstations), public charging kiosks within corporate facilities, DNS servers, network gateways, VPN concentrators, and Mobile Device Management (MDM) servers.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). JOIN with subsequent Network connection events (Sysmon 3, Zeek conn.log) from watchlist processes on same host within 5 minutes. APPLY pre-trained ML model (Isolation Forest/SVM) to connection features (port, protocol, bytes, ASN, geo). ALERT on connections classified as anomalies.
  - question: Did a host query a known malicious domain within 5 minutes of a USB device connection?
    context: This is a straightforward, high-fidelity indicator of compromise. A DNS query for a known-bad domain immediately after a potential infection vector (USB connection) is a strong signal that malware has been executed and is attempting to establish command and control.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Sysmon Event ID 22
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, guest network segments, internet gateway, recursive DNS resolvers, corporate DNS servers, and Endpoint Detection and Response (EDR) logs.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). JOIN with subsequent DNS query events (Sysmon 22, Zeek dns.log) on same host within 5 minutes. WHERE queried domain is on a threat_intel_feed. ALERT high-priority.
  - question: Did a host exhibit anomalous DNS activity (e.g., an unusually high number of unique domains, high entropy, or rare TLDs) shortly after a USB connection?
    context: This question aims to detect signs of Domain Generation Algorithms (DGA) or other automated C2 communication techniques. A sudden spike in these metrics after a USB connection suggests that malware dropped by the device is algorithmically generating domains to phone home, a common tactic to evade static blocklists.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Sysmon Event ID 22
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, guest network segments, internet gateway, recursive DNS resolvers, corporate DNS servers, and Endpoint Detection and Response (EDR) logs.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). FOR each host, analyze DNS queries (Sysmon 22, Zeek dns.log) in the next 5 minutes. CALCULATE unique domain count, label entropy, and rare TLD ratio. COMPARE with 30-day host baseline. ALERT medium-severity if metrics exceed statistical thresholds (e.g., 3 std dev, 99th percentile).
  - question: Were there any machine-learning-flagged outlier DNS queries from a host within 5 minutes of a USB connection?
    context: This uses machine learning to find DNS queries that do not fit normal patterns, even if they do not match specific rules or statistical thresholds. This can catch novel or sophisticated DGA variants. A cluster of such outliers after a USB connection is highly suspicious.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Sysmon Event ID 22
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, guest network segments, internet gateway, recursive DNS resolvers, corporate DNS servers, and Endpoint Detection and Response (EDR) logs.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). JOIN with subsequent DNS query events (Sysmon 22, Zeek dns.log) on same host within 5 minutes. APPLY pre-trained ML model (Isolation Forest/Autoencoder) to DNS query features. ALERT on queries classified as outliers, especially clusters of outliers.
  - question: Following a USB connection, was a malicious file (matching a known hash or spawning a suspicious PowerShell child process) dropped and executed?
    context: This is a direct detection for a common payload delivery mechanism. An attacker uses the USB connection to drop a file and then execute it. The presence of a known bad hash or suspicious PowerShell usage (e.g., encoded commands) provides high confidence of malicious activity related to lateral movement or payload execution.
    answer_sources:
      - Sysmon Event ID 11
      - Sysmon Event ID 1
      - Windows Event ID 4688
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, IT administrator workstations, software development environments, user profile directories (Downloads, Temp, AppData), and shared network drives.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). CORRELATE with File Create (Sysmon 11) and Process Create (Sysmon 1) events on same host within 10 minutes. ALERT CRITICAL if file hash matches malware feed. ALERT HIGH if child process is powershell.exe with arguments like '-enc', '-e', '-w hidden'.
  - question: After a USB connection, was a rare or never-before-seen file executed, or did an unusual parent-child process relationship occur?
    context: This question aims to detect novel malware or living-off-the-land techniques. A file seen on very few machines (low prevalence) is suspicious. Similarly, a process spawning a child process that it normally doesn't (e.g., 'ideviceinstaller.exe' spawning 'cmd.exe') is a strong anomaly indicative of lateral movement attempts.
    answer_sources:
      - Sysmon Event ID 11
      - Sysmon Event ID 1
      - Windows Event ID 4688
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, IT administrator workstations, software development environments, user profile directories (Downloads, Temp, AppData), and shared network drives.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). CORRELATE with File Create (Sysmon 11) and Process Create (Sysmon 1) events on same host within 10 minutes. CALCULATE file hash prevalence across enterprise. CALCULATE frequency of parent-child process pair. ALERT MEDIUM if hash prevalence < 5 hosts OR parent-child pair is in bottom 5% frequency.
  - question: Did a machine learning model classify any file execution that occurred within 10 minutes of a USB connection as highly likely to be malicious?
    context: This uses a predictive model to score file execution events based on a variety of features (path, signature, prevalence, parent process). It can catch sophisticated threats that evade simple rules, providing a probabilistic assessment of risk that can be used to prioritize investigations after a high-risk event like a USB connection.
    answer_sources:
      - Sysmon Event ID 11
      - Sysmon Event ID 1
      - Windows Event ID 4688
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, IT administrator workstations, software development environments, user profile directories (Downloads, Temp, AppData), and shared network drives.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). CORRELATE with Process Create (Sysmon 1) events on same host within 10 minutes. APPLY pre-trained ML model (Random Forest/GBM) to process/file features. ALERT HIGH on executions with malicious probability > 0.9.
  - question: Did a host initiate a network scan (as detected by Zeek) within 15 minutes of a USB device connection?
    context: Zeek's built-in scanning detection is a powerful capability. Correlating a scan notice directly with a recent USB connection provides strong, context-rich evidence that a payload dropped from the USB is attempting to discover other hosts on the network for lateral movement.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Sysmon Event ID 3
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, network segments containing high-value assets (Domain Controllers, Database Servers), internal network traffic choke points, East-West traffic monitoring points (e.g., network TAPs, virtual switch monitoring), and VLANs with sensitive servers.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH Zeek scan notices ('Scan::Address_Scan', 'Scan::Port_Scan'). FOR each scanning host, check for USB connection events (Win Event 2003) in the previous 15 minutes. ALERT HIGH if correlation is found.
  - question: Following a USB connection, did the host attempt to connect to an unusually large number of internal systems or exhibit a high rate of failed connections, suggesting network reconnaissance?
    context: This is a behavioral detection for network scanning. It looks for the statistical artifacts of scanning, such as many unique destinations and many connection failures, which can detect scanning that is too slow or subtle for pattern-based detectors. Correlating this behavior with a recent USB connection points to a likely compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Sysmon Event ID 3
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, network segments containing high-value assets (Domain Controllers, Database Servers), internal network traffic choke points, East-West traffic monitoring points (e.g., network TAPs, virtual switch monitoring), and VLANs with sensitive servers.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). FOR each host, monitor internal network connections (Zeek conn.log, Sysmon 3) for the next 15 minutes. CALCULATE unique internal IPs contacted on key ports AND ratio of failed-to-successful connections. ALERT MEDIUM if unique IP count > 20 OR failed connection ratio > 3 std dev from baseline.
  - question: Did a host's network behavior profile change from 'normal' to 'scanner-like' within 15 minutes of a USB connection?
    context: This approach uses unsupervised machine learning to dynamically group hosts by their behavior. A sudden, unexplained shift in a host's behavior cluster to one characterized by scanning activity, immediately following a USB event, is a high-confidence indicator of compromise and attempted lateral movement.
    answer_sources:
      - Zeek conn.log
      - Zeek notice.log
      - Sysmon Event ID 3
      - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
      - Corporate workstations, network segments containing high-value assets (Domain Controllers, Database Servers), internal network traffic choke points, East-West traffic monitoring points (e.g., network TAPs, virtual switch monitoring), and VLANs with sensitive servers.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: SEARCH USB connection events (Win Event 2003). FOR each host, check its assigned network behavior cluster (from K-Means/DBSCAN model). IF cluster changes from 'normal' to 'scanner' within 15 minutes of the USB event, ALERT HIGH.