playbook_name: "T1059.012: Hypervisor CLI"
playbook_id: "f8a1b2c3-d4e5-4f6a-7b8c-9d0e1f2a3b4c"
playbook_description: "This playbook helps investigate whether an adversary has executed commands via a hypervisor's command-line interface (CLI) for purposes of execution, defense evasion, or impact. It focuses on detecting the use of tools like esxcli, vim-cmd, and PowerCLI by matching against known IOCs, identifying anomalously rare or destructive commands, analyzing command sequences, detecting unauthorized usage, and monitoring for suspicious outbound network connections from hypervisor management interfaces."
playbook_type: "technique"
related_playbooks:
  - "TA0002: Execution"
playbook_contributors: "Zachary Szewczyk, Ask Sage"
created_date: "2025-10-01"
last_modified_date: "2025-10-01"
version: 1.0
tags: "none"
investigative_questions:
  - question: "Have any hypervisor CLI tools (esxcli, vim-cmd, PowerCLI) been executed where the process file hash or its child processes' hash matches a known malicious indicator?"
    context: "This question aims to detect the direct execution of a known malicious tool disguised as or associated with a legitimate hypervisor CLI. Adversaries often use custom or compromised binaries. Matching file hashes against up-to-date threat intelligence provides a high-fidelity signal of compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH process_creation_logs OR hypervisor_shell_logs
          WHERE process_name IN ('esxcli', 'vim-cmd', 'powershell.exe') AND command_line CONTAINS 'PowerCLI'
          LOOKUP file_hash in threat_intelligence_feed
          IF match FOUND, ALERT

  - question: "Have any hypervisor CLI commands been executed with arguments that are historically rare within the environment?"
    context: "This question helps uncover novel or unusual command-line activity that may not be caught by signature-based detections. Adversaries may use legitimate tools with unique parameter combinations for malicious purposes. Flagging commands that are in the bottom 5th percentile of historical frequency can surface these new attack patterns."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each hypervisor_cli_execution:
          CALCULATE historical_frequency of full_command_argument_string
          IF frequency < 5th_percentile, ALERT

  - question: "Has a machine learning model classified any hypervisor CLI command executions as malicious?"
    context: "This question leverages a supervised machine learning model trained to distinguish between benign and malicious command strings. By analyzing features like string length, character types, and keywords, the model can identify sophisticated malicious commands that mimic legitimate syntax, providing a proactive defense against zero-day exploits and advanced techniques. A high-confidence alert could trigger automated responses."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each new hypervisor_cli_execution:
          EXTRACT features (n-grams, length, keywords, etc.)
          INPUT features into trained_classification_model
          IF prediction is 'malicious' AND confidence > 0.9, ALERT and INITIATE host_isolation

  - question: "Have any high-risk hypervisor CLI commands (e.g., 'vm process kill', 'snapshot.removeall', 'firewall set --enabled false') been executed without an associated, approved change ticket?"
    context: "This question focuses on identifying inherently dangerous commands that could be used for destruction or defense evasion. By correlating these events with a change management system, analysts can quickly differentiate between legitimate, planned administrative work and unauthorized, potentially malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH command_logs for keywords IN ('vm process kill', 'snapshot.removeall', 'firewall set --enabled false', etc.)
          FOR each match:
          QUERY change_management_api for related_ticket
          IF no_ticket_found, ESCALATE_ALERT

  - question: "Has any user or host executed high-risk hypervisor commands at a rate significantly above their established baseline?"
    context: "This question aims to detect anomalous behavior from a user or host, even if the commands themselves are authorized. A sudden spike in high-risk commands by a single user or from a single host could indicate a compromised account or a malicious script being run, warranting investigation even if individual commands seem plausible."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each user/host:
          CALCULATE 30-day baseline (mean, stddev) for high-risk_command_frequency
          IF current_frequency > (mean + 3 * stddev), ALERT

  - question: "Have any hypervisor CLI command executions been flagged as anomalous outliers by a clustering algorithm?"
    context: "This question uses unsupervised machine learning to find unusual activity that doesn't fit into normal patterns of behavior. By clustering events based on user, source, command type, and time, the algorithm can identify 'normal' groups of activity. Any command that doesn't fit into a cluster is flagged as a 'noise' point or anomaly, representing a deviation from typical administrative workflows that requires review."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          CLUSTER command_execution_events using DBSCAN
          FEATURES: user, source_host, command_keywords, time_of_day
          IF event is marked as 'noise' (outlier), ALERT

  - question: "Has a sequence of hypervisor CLI commands matching a known attack chain (e.g., discovery followed by persistence or impact) been observed from a single source?"
    context: "This question looks for multi-step attack patterns rather than single suspicious commands. Adversaries often follow a predictable playbook, such as enumerating VMs and then killing them, or disabling security settings before establishing persistence. Detecting these specific sequences provides strong evidence of a targeted attack in progress."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH for stateful sequence in command_logs from same_source within 10_minutes:
          1. 'vim-cmd vmsvc/getallvms'
          2. 'esxcli vm process kill'
          IF sequence_complete, ALERT

  - question: "Has there been a sharp increase in command variety (high entropy) followed by a sharp decrease (low entropy) from a single user within a short time window?"
    context: "This question uses information theory to detect a common attack pattern: reconnaissance followed by action. High entropy (many different commands) suggests a user is exploring the system. This is followed by low entropy (repeating the same one or two commands), suggesting a scripted attack (e.g., killing all VMs). This pattern is a strong indicator of malicious intent."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          CALCULATE Shannon entropy of command_names in 5-minute sliding window per user
          IF sharp_increase_in_entropy THEN sharp_decrease_in_entropy, ALERT

  - question: "Did a sequence analysis model (like an RNN/LSTM) flag any executed hypervisor CLI commands as having a low probability of being the 'next command' in a normal sequence?"
    context: "This question leverages a sophisticated deep learning model that learns the typical sequences of commands used by administrators. By predicting the next likely command in a session, it can flag any command that deviates from this learned benign workflow. This is effective at catching unexpected or illogical actions that an attacker might take in the middle of an otherwise normal-looking session."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "ESXi shell.log"
      - "ESXi audit.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, and jump boxes with hypervisor management tools installed."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each command in user_session_stream:
          USE trained_RNN_model to predict_next_command
          CALCULATE probability of actual_executed_command
          IF probability is very_low, ALERT

  - question: "Have any hypervisor CLI tools been executed by a user account that is not a member of an authorized administrative group (e.g., 'VMware Administrators' in AD)?"
    context: "This is a fundamental access control check. Hypervisor administration is a highly privileged activity that should be restricted to a small number of authorized users. The execution of these tools by any other user is a serious security violation and a strong indicator of privilege escalation or a compromised account."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Windows Event ID 4624"
      - "Active Directory Logs"
      - "ESXi shell.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, domain controllers, and jump boxes."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          JOIN process_creation_events with ad_authentication_logs
          FOR each hypervisor_cli_process:
          CHECK if executing_user in 'VMware Administrators' AD_group
          IF user not_in_group, ALERT

  - question: "Has an authorized administrator executed a hypervisor CLI command from a source IP or at a time that is anomalous compared to their established profile?"
    context: "This question helps detect compromised administrator accounts. Even if the user is authorized, their behavior should be predictable. An admin who always works 9-5 from the corporate network suddenly running commands at 3 AM from a foreign IP is a major red flag. This method baselines 'normal' for each admin and alerts on deviations."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Windows Event ID 4624"
      - "Active Directory Logs"
      - "ESXi shell.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, domain controllers, and jump boxes."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each admin_user:
          BUILD profile of typical_source_ips, login_hours
          ON new hypervisor_cli_execution:
          IF source_ip OR time_of_day is anomalous for that user, ALERT

  - question: "Has an anomaly detection model (like an Isolation Forest) flagged any hypervisor CLI executions as having a high anomaly score based on user, source, time, and process context?"
    context: "This question uses a multi-dimensional anomaly detection model to find unusual combinations of factors. A single factor might not be suspicious (e.g., a new parent process), but the combination of a new parent process, an unusual time, and a slightly different command line length might be. The model learns the complex boundary of normal activity and flags any event that falls outside of it."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Windows Event ID 4624"
      - "Active Directory Logs"
      - "ESXi shell.log"
      - "Hypervisor management servers (e.g., vCenter), ESXi hosts, designated administrator workstations, domain controllers, and jump boxes."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each hypervisor_cli_execution:
          INPUT features (User, SourceIP, Time, ParentProcess, etc.) into Isolation_Forest_model
          IF anomaly_score is high, ALERT

  - question: "Has a hypervisor management interface made an outbound network connection to an external IP, domain, or JA3 hash that is on a threat intelligence feed?"
    context: "This question seeks to detect command and control (C2) or data exfiltration activity. Hypervisor management interfaces should generally only communicate with a limited set of internal systems. Any connection to a known malicious external entity is a critical indicator of compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network sensors (e.g., Zeek) monitoring traffic to/from hypervisor management interfaces, core network switches, and internet gateways."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH zeek_logs where source_ip is hypervisor_mgmt_ip AND destination_ip is external
          LOOKUP destination_ip, dns_query, or ja3_hash in threat_intelligence_feed
          IF match FOUND, ALERT

  - question: "Has a hypervisor made a 'first-seen' outbound connection to a new destination, or has its daily outbound data volume significantly exceeded its historical average?"
    context: "This question identifies two types of network anomalies. A 'first-seen' connection to a destination it has never communicated with before could indicate a new C2 channel. A sudden spike in outbound data volume can be a sign of data exfiltration. Both methods detect deviations from the established network baseline."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network sensors (e.g., Zeek) monitoring traffic to/from hypervisor management interfaces, core network switches, and internet gateways."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          BASELINE 30-day (dest_ip, dest_port, proto) tuples per hypervisor
          IF new_connection_tuple is not in baseline, ALERT
          BASELINE 30-day daily outbound_bytes per hypervisor
          IF today's_bytes > (mean + 3 * stddev), ALERT

  - question: "Has a community detection algorithm identified a network connection from a hypervisor to a node outside of its normal communication cluster?"
    context: "This question models the network as a social graph and identifies normal 'communities' of devices that talk to each other (e.g., vCenter, ESXi hosts, and storage controllers form a community). A connection from a hypervisor to a device outside of its normal community (e.g., to a workstation in the user VLAN) is anomalous and could represent lateral movement or C2."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network sensors (e.g., Zeek) monitoring traffic to/from hypervisor management interfaces, core network switches, and internet gateways."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          MODEL network traffic as a graph
          RUN Louvain Modularity to identify communication_communities
          IF connection forms between hypervisor_node and a node outside its community, ALERT