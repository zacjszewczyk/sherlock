name: T1087.004: Cloud Account
id: b3e5a4f8-7c1d-4e8f-8a9e-2b1c0d3e5f6a
description: |
  This playbook helps answer the question: Has the adversary attempted to enumerate cloud accounts? It provides investigative steps to detect this activity by analyzing various data sources. Detections focus on identifying network connections from suspicious origins (geographically rare or on threat intelligence feeds) to cloud IAM API endpoints, monitoring for process creation events related to cloud CLI tools (aws.exe, az.exe, gcloud.exe) using specific enumeration sub-commands, flagging anomalously high rates of API requests from a single source that indicate scripting or spraying, and correlating on-host process execution with network connections to identify unauthorized users performing discovery actions.
type: technique
related:
  - TA0007: Discovery
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a host on our network connected to a known cloud IAM API endpoint from an IP address that is present on a threat intelligence feed or associated with an anonymizing service?
    context: This question aims to identify high-confidence malicious activity by checking if network traffic to sensitive cloud management endpoints (like AWS IAM, Azure AD, or GCP IAM) originates from IPs already flagged as malicious or from services designed to obscure an attacker's origin. A match strongly suggests a compromised host or an external threat actor attempting to interact with the cloud environment.
    answer_sources: Zeek conn.log, Zeek dns.log, Threat intelligence feeds. Network Address Information (NAI) from Internet egress points, forward and reverse proxy servers, and enterprise DNS resolvers.
    range: last 90 days
    queries: SEARCH Zeek conn.log WHERE destination_ip resolves to cloud IAM API endpoint AND source_ip IN threat_intel_feed | RETURN source_ip, destination_ip, timestamp
  - question: Has a connection been made to a cloud IAM API from a geographic location that is statistically rare or inconsistent with our organization's normal business presence?
    context: This question helps detect potential unauthorized access by identifying connections from unusual countries. Adversaries may operate from locations where the organization has no employees or business operations. By baselining normal connection locations and alerting on rare outliers (e.g., countries in the bottom 1% of connection frequency), analysts can spot access attempts that deviate from established patterns.
    answer_sources: Zeek conn.log, Zeek dns.log, IP Geolocation database. Network Address Information (NAI) from Internet egress points, forward and reverse proxy servers, and enterprise DNS resolvers.
    range: last 90 days
    queries: SEARCH Zeek conn.log WHERE destination_ip resolves to cloud IAM API endpoint | GEO_LOOKUP source_ip | COMPARE source_country against historical_baseline | RETURN source_ip, source_country, timestamp WHERE source_country is rare
  - question: Can we identify potentially malicious connections to cloud IAM endpoints using a machine learning model trained on network traffic characteristics?
    context: This question leverages machine learning to move beyond simple rules and detect more subtle or novel threats. By training a model on features like connection duration, data volume, and source ASN, it can learn the characteristics of both benign and malicious traffic. This allows for the scoring of new connections in real-time to proactively identify suspicious activity that might otherwise be missed.
    answer_sources: Zeek conn.log, Zeek dns.log, Labeled historical data, CTI feeds. Network Address Information (NAI) from Internet egress points, forward and reverse proxy servers, and enterprise DNS resolvers.
    range: last 90 days
    queries: APPLY ML_model on real-time Zeek conn.log stream for connections to cloud IAM API endpoints | RETURN source_ip, destination_ip, score WHERE score > malicious_threshold
  - question: Has a user executed a known cloud CLI tool (like aws.exe, az.exe, gcloud.exe, or PowerShell) with specific sub-commands used for enumerating users, roles, or policies?
    context: This is a direct method to detect reconnaissance activity. Adversaries, after gaining initial access to an endpoint, often use native cloud CLI tools to discover the permissions and structure of the cloud environment. Searching for command-line artifacts of specific enumeration commands (e.g., 'aws iam list-users', 'Get-MsolRoleMember', 'az ad user list') provides high-fidelity evidence of this discovery technique.
    answer_sources: Windows Event ID 4688. Network Address Information (NAI) from Administrator workstations, developer endpoints, and CI/CD pipeline servers.
    range: last 90 days
    queries: SEARCH Windows Event ID 4688 WHERE (process_name IN ['aws.exe', 'az.exe', 'gcloud.exe', 'powershell.exe', 'pwsh.exe']) AND (command_line CONTAINS 'list-users' OR 'list-roles' OR 'Get-MsolRoleMember' OR 'az ad user list') | RETURN hostname, user, command_line
  - question: Has a user or host executed a cloud CLI command that is anomalously complex or is a first-time execution of a known enumeration command for that entity?
    context: This question helps find unusual command-line activity that might indicate malicious intent, such as obfuscated or long, scripted commands. By baselining normal command-line patterns for each user and host, we can detect deviations. High command-line entropy can suggest automated or complex scripts, while a user running an enumeration command for the first time is a significant behavioral anomaly worth investigating.
    answer_sources: Windows Event ID 4688. Network Address Information (NAI) from Administrator workstations, developer endpoints, and CI/CD pipeline servers.
    range: last 90 days
    queries: FOR each user/host, BASELINE cloud CLI command usage | SEARCH Windows Event ID 4688 | CALCULATE command_line_entropy | ALERT if entropy > 95th_percentile_for_entity OR if command is a first_time_enumeration_command_for_entity
  - question: Are there any cloud CLI command executions that are statistical outliers when compared to the clusters of normal, legitimate administrative activity?
    context: This question aims to uncover novel or unusual enumeration techniques not captured by specific signatures. By using a clustering algorithm like DBSCAN, we can group routine command-line activities into 'normal' clusters. Any command that doesn't fit into these clusters (i.e., is flagged as noise or an outlier) is by definition anomalous and could represent a new or modified attack tool or technique.
    answer_sources: Windows Event ID 4688. Network Address Information (NAI) from Administrator workstations, developer endpoints, and CI/CD pipeline servers.
    range: last 90 days
    queries: VECTORIZE command-line data from Windows Event ID 4688 | APPLY clustering algorithm (DBSCAN) | IDENTIFY and alert on commands classified as outliers/noise | RETURN hostname, user, command_line
  - question: Has a single source IP address made an unusually high number of distinct API calls to cloud IAM endpoints in a short period?
    context: This question is designed to detect automated reconnaissance or 'spraying' attacks. A legitimate user is unlikely to make dozens of different API calls in a few minutes. An attacker using a script to enumerate all possible users, roles, or policies would generate exactly this type of high-volume, high-variety request pattern. A hard threshold (e.g., >20 calls in 5 minutes) provides a simple but effective tripwire for this behavior.
    answer_sources: Zeek http.log, Zeek conn.log. Network Address Information (NAI) from Network Security Monitoring sensors at internet egress points and cloud-native flow logs (e.g., AWS VPC Flow Logs).
    range: last 90 days
    queries: SEARCH Zeek http.log, conn.log WHERE uri CONTAINS IAM paths | GROUP BY source_ip over 5_minute_window | COUNT distinct uri | ALERT if distinct_uri_count > 20
  - question: Is a source IP making a number or variety of IAM API calls that is statistically anomalous compared to its own historical baseline?
    context: This question refines the detection of enumeration by personalizing it for each source IP. Some service accounts or admin workstations may legitimately make more API calls than others. By creating a baseline for each entity and using statistical measures like standard deviation, we can detect significant changes in behavior (e.g., a normally quiet IP suddenly making hundreds of calls) which is a strong indicator of compromise or misuse.
    answer_sources: Zeek http.log, Zeek conn.log. Network Address Information (NAI) from Network Security Monitoring sensors at internet egress points and cloud-native flow logs (e.g., AWS VPC Flow Logs).
    range: last 90 days
    queries: FOR each source_ip, BASELINE hourly IAM API call count and variety | SEARCH real-time Zeek logs | ALERT if call_count > (mean + 3*std_dev) OR if unique_uri_count > 99th_percentile
  - question: Does the volume of IAM API calls from a source IP show a pattern that deviates significantly from what a time-series forecasting model predicts as normal?
    context: This approach seeks to identify anomalous spikes or changes in the rhythm of API requests. Time-series models like ARIMA or LSTMs can learn complex temporal patterns, including seasonality (e.g., lower activity on weekends). When the actual volume of requests deviates sharply from the model's predicted volume and its confidence interval, it suggests an event outside the norm, such as a scripted enumeration attack.
    answer_sources: Zeek http.log, Zeek conn.log. Network Address Information (NAI) from Network Security Monitoring sensors at internet egress points and cloud-native flow logs (e.g., AWS VPC Flow Logs).
    range: last 90 days
    queries: APPLY time-series model (ARIMA/LSTM) on 1-minute interval counts of IAM API calls per source_ip | ALERT if actual_volume deviates from predicted_volume_confidence_interval
  - question: Has a user who is not a designated cloud administrator executed a cloud CLI tool that resulted in a network connection to a cloud IAM API?
    context: This question provides powerful, context-rich detection by correlating host activity with network traffic and identity information. The execution of a cloud CLI tool by itself might be benign. However, when a non-administrative user performs both actions in quick succession, it is highly suspicious and warrants immediate investigation as it may indicate a compromised account or insider threat.
    answer_sources: Windows Event ID 4688, Zeek conn.log, Active Directory Security Logs. Network Address Information (NAI) from User endpoints, Virtual Desktop Infrastructure (VDI), CI/CD servers, and Domain Controllers for user attribute enrichment.
    range: last 90 days
    queries: JOIN (Windows Event ID 4688 where process is cloud CLI) with (Zeek conn.log where dest_ip is IAM API) on host_ip within 60s | ENRICH with user's AD groups | ALERT if user_group NOT IN 'Cloud Administrators'
  - question: Has a cloud CLI command been executed by a user from a department that does not typically use such tools, and is the command itself statistically rare?
    context: This question uses organizational context to identify anomalous behavior. While a DevOps engineer running 'az ad user list' might be normal, an accountant running the same command is highly irregular. By profiling which departments and users typically use cloud tools, we can flag executions that deviate from these peer group norms. The alert's severity can be increased if the command itself is also uncommon.
    answer_sources: Windows Event ID 4688, Zeek conn.log, Active Directory Security Logs. Network Address Information (NAI) from User endpoints, Virtual Desktop Infrastructure (VDI), CI/CD servers, and Domain Controllers for user attribute enrichment.
    range: last 90 days
    queries: PROFILE cloud CLI usage by user and department | SEARCH Windows Event ID 4688 | ENRICH with user's department | ALERT if department is historically low-activity for CLI usage | INCREASE severity if command is rare across organization
  - question: Based on a risk-scoring model, does a correlated cloud CLI execution and subsequent network connection represent a high-risk event that requires escalation?
    context: This question operationalizes threat detection by consolidating multiple weak signals into a single, actionable risk score. A model can weigh various factors—such as the user's role, the time of day, and the command's complexity—to produce a holistic assessment of risk. Events surpassing a certain risk threshold can then be automatically escalated, focusing analyst attention on the most critical threats.
    answer_sources: Windows Event ID 4688, Zeek conn.log, Active Directory Security Logs. Network Address Information (NAI) from User endpoints, Virtual Desktop Infrastructure (VDI), CI/CD servers, and Domain Controllers for user attribute enrichment.
    range: last 90 days
    queries: FOR correlated events (CLI exec + network conn), EXTRACT features (user role, host criticality, time, entropy, etc.) | APPLY Gradient Boosting model to calculate risk_score | ESCALATE if risk_score > threshold