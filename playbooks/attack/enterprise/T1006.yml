name: "T1006: Direct Volume Access"
id: "a6c5e2d1-0f8b-4a9c-9e1d-3b7f6a0c8d4e"
description: "This playbook is designed to help investigate whether an adversary is bypassing file access controls or monitoring by directly accessing logical volumes or raw disk data. It focuses on detecting the use of known direct volume access tools (e.g., NinjaCopy), the abuse of legitimate system utilities (e.g., vssadmin.exe, esentutl.exe), unauthorized processes requesting handles to volume objects, obfuscated PowerShell scripts calling raw disk I/O APIs, and correlated event sequences indicating volume access followed by data staging and exfiltration."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a known utility or script for direct volume access being executed?"
    context: "This question aims to detect the straightforward execution of well-known tools like NinjaCopy or rawdd. Identifying these tools by name, command-line arguments, or file hash provides a high-fidelity signal that an adversary is attempting to bypass standard file system controls."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
      - "Backup Infrastructure Servers"
    range: "Last 90 days"
    queries:
      - "SEARCH process_creation_logs OR powershell_script_logs WHERE (process_name IN (known_tools_list) OR command_line CONTAINS (known_tools_list) OR file_hash IN (known_hashes_list))"
  - question: "Is a rare process being executed with command-line arguments suggestive of raw disk or volume access?"
    context: "This question identifies potentially malicious or custom tools that are not on a known-bad list. By focusing on low-prevalence processes combined with suspicious keywords ('copy', 'raw', 'disk', 'volume', '\\\\.\\'), it helps uncover novel or renamed tools used for direct volume access."
    answer_sources:
      - "Windows Event ID 4688"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
      - "Backup Infrastructure Servers"
    range: "Last 90 days"
    queries:
      - "SEARCH process_creation_logs | CALCULATE prevalence(process_name) | WHERE prevalence < 5 AND command_line CONTAINS ('copy', 'raw', 'disk', 'volume', '\\\\.\\')"
  - question: "Does a machine learning model classify a process execution event as a likely direct volume access attempt?"
    context: "This question leverages a machine learning model to detect nuanced or previously unseen malicious behavior. By analyzing a combination of features like entropy, parent process, and user context, the model can identify anomalous process executions that may indicate a direct volume access attempt, even if the tool or command is not explicitly known."
    answer_sources:
      - "Windows Event ID 4688"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
      - "Backup Infrastructure Servers"
    range: "Last 90 days"
    queries:
      - "STREAM process_creation_logs TO ML_model | FILTER classification = 'malicious' AND confidence_score > 0.9"
  - question: "Is a legitimate system utility being used with specific command-line parameters known to facilitate direct volume access?"
    context: "Adversaries often abuse legitimate system tools (Living Off The Land Binaries) to evade detection. This question focuses on identifying specific, high-fidelity command-line patterns for utilities like vssadmin.exe, esentutl.exe, and wbadmin.exe that are strongly indicative of creating or accessing volume shadow copies or raw disk data for malicious purposes."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
      - "Backup Infrastructure Servers"
    range: "Last 90 days"
    queries:
      - "SEARCH process_creation_logs OR powershell_script_logs WHERE (process_name = 'vssadmin.exe' AND command_line MATCHES 'create shadow') OR (process_name = 'esentutl.exe' AND command_line MATCHES '/y /vss') OR (command_line MATCHES '\\\\.\\PhysicalDrive' OR '\\\\.\\HarddiskVolumeShadowCopy')"
  - question: "Is a legitimate system utility being run with unusually complex or obfuscated command-line arguments?"
    context: "This question aims to detect obfuscation or abnormal usage of legitimate tools. A significant deviation from the baseline command-line entropy for a given host suggests that an adversary may be trying to hide their actions, such as embedding encoded commands or complex paths."
    answer_sources:
      - "Windows Event ID 4688"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
      - "Backup Infrastructure Servers"
    range: "Last 90 days"
    queries:
      - "SEARCH process_creation_logs WHERE process_name IN ('vssadmin.exe', 'esentutl.exe', 'wbadmin.exe') | CALCULATE entropy(command_line) | COMPARE entropy to historical_baseline | ALERT if entropy > 95th_percentile"
  - question: "Is there a statistically improbable sequence of commands occurring, such as volume access followed by data compression and exfiltration tools?"
    context: "This question looks beyond single events to identify a logical attack chain. By modeling normal command sequences, it can detect when an attacker performs a series of actions—like creating a shadow copy, compressing it with 7-Zip, and then using PowerShell to send it out—that are highly unlikely to occur during benign administrative activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
      - "Backup Infrastructure Servers"
    range: "Last 90 days"
    queries:
      - "STREAM process_creation_logs | ANALYZE sequence(process_name) per host | ALERT on improbable_sequence (e.g., vssadmin -> 7z -> powershell)"
  - question: "Is an unauthorized process requesting a handle to a logical volume or physical drive?"
    context: "This question provides a direct method for detecting unauthorized access attempts to raw disk volumes. By enabling specific auditing and maintaining an allowlist of legitimate system and backup processes, any other process requesting a handle to a volume object (e.g., \\Device\\HarddiskVolume1) is highly suspicious and warrants immediate investigation."
    answer_sources:
      - "Windows Event ID 4656"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
    range: "Last 90 days"
    queries:
      - "SEARCH file_system_audit_logs (EventID 4656) WHERE object_name MATCHES ('\\Device\\HarddiskVolume', '\\Device\\Harddisk') AND process_name NOT IN (allowlist)"
  - question: "Is a legitimate, allowlisted process requesting unusually permissive or rare access rights to a volume object?"
    context: "Even legitimate processes can be compromised or abused. This question seeks to identify when an allowlisted process behaves abnormally by requesting access rights (e.g., WRITE_DAC, GENERIC_ALL) that are not part of its typical operational baseline. This could indicate process injection or another form of subversion."
    answer_sources:
      - "Windows Event ID 4656"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
    range: "Last 90 days"
    queries:
      - "SEARCH file_system_audit_logs (EventID 4656) WHERE process_name IN (allowlist) | CALCULATE frequency(access_mask) per process | ALERT if frequency < 1% OR access_mask IN (high_privilege_masks)"
  - question: "Does an unsupervised machine learning model identify an anomalous volume access event?"
    context: "This question uses anomaly detection to find novel or unknown threats without relying on pre-defined rules or signatures. By clustering normal volume access patterns based on process, object, and access rights, the model can flag any event that falls outside these clusters as an outlier, representing a potentially malicious deviation that requires analyst review."
    answer_sources:
      - "Windows Event ID 4656"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
    range: "Last 90 days"
    queries:
      - "STREAM file_system_audit_logs (EventID 4656) TO ML_model | FILTER classification = 'anomaly'"
  - question: "Has a direct volume access attempt been followed by data compression and a large network egress to a new destination?"
    context: "This question correlates alerts and events across different data sources to detect a full attack sequence. It specifically looks for the pattern of direct volume access, followed by data staging (compression), and finally data exfiltration (large outbound connection to a new IP), providing a high-confidence indicator of data theft."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Critical Servers (Domain Controllers, File Servers)"
      - "Administrator Workstations"
      - "Network Egress Points"
    range: "Last 90 days"
    queries:
      - "CORRELATE (alert_for_T1006) THEN (process_creation FOR compression_tool) THEN (network_connection with outbound_bytes > 100MB to new_IP) WITHIN 30m ON same_host"
  - question: "Following a potential direct volume access event, is there a statistically significant spike in outbound network traffic from the source host?"
    context: "This question enriches an initial volume access alert with network context to assess the likelihood of data exfiltration. A significant, anomalous spike in outbound data transfer shortly after a suspected T1006 event strongly suggests that the adversary has successfully acquired data and is now moving it off the network."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Critical Servers (Domain Controllers, File Servers)"
      - "Administrator Workstations"
      - "Network Egress Points"
    range: "Last 90 days"
    queries:
      - "ON alert_for_T1006, TRIGGER: SEARCH network_logs for source_host in next 60m | CALCULATE total_outbound_bytes | COMPARE to baseline | ESCALATE if outbound_bytes > 3_std_dev_from_mean"
  - question: "Does a probabilistic model detect a state transition from benign activity to volume access, staging, and exfiltration?"
    context: "This question uses a sophisticated probabilistic model (HMM) to track the state of a host over time. By observing a sequence of events like anomalous handle requests, LOLBAS execution, and large network flows, the model can infer the most likely sequence of hidden states. Detecting a transition through the full attack chain (VolumeAccess -> Staging -> Exfiltration) provides a very high-confidence alert based on the logical progression of an attack."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Critical Servers (Domain Controllers, File Servers)"
      - "Administrator Workstations"
      - "Network Egress Points"
    range: "Last 90 days"
    queries:
      - "STREAM logs to HMM | USE Viterbi_algorithm to find most_likely_state_sequence | ALERT if sequence = 'Benign' -> 'VolumeAccess' -> 'Staging' -> 'Exfiltration'"
  - question: "Is a PowerShell script using specific API calls or .NET methods associated with raw disk I/O?"
    context: "This question targets the use of PowerShell for direct volume access, a common technique for fileless attacks. By searching for specific function calls (CreateFileW, NtCreateFile) and .NET methods (System.IO.FileStream) used to interact with raw disk devices, it's possible to detect malicious scripts even if they are obfuscated."
    answer_sources:
      - "Windows Event ID 4103"
      - "Windows Event ID 4104"
      - "Windows Event ID 4688"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
    range: "Last 90 days"
    queries:
      - "SEARCH powershell_script_logs WHERE script_block_text CONTAINS ('CreateFileW', 'DeviceIoControl', 'NtCreateFile', '[System.IO.FileStream]::new(\\'\\\\.\\')')"
  - question: "Is a PowerShell script exhibiting high entropy and a high ratio of non-alphanumeric characters, suggesting obfuscation?"
    context: "Adversaries frequently obfuscate PowerShell scripts to hide their true intent. This question uses statistical metrics—entropy (randomness) and the prevalence of special characters—to identify scripts that are likely obfuscated. A script that is both highly random and full of non-alphanumeric characters is a strong candidate for being malicious."
    answer_sources:
      - "Windows Event ID 4104"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
    range: "Last 90 days"
    queries:
      - "SEARCH powershell_script_logs | CALCULATE entropy(script_block_text), non_alphanumeric_ratio(script_block_text) | ALERT if entropy > 98th_percentile AND non_alphanumeric_ratio > 98th_percentile"
  - question: "Does a natural language processing model classify a PowerShell script as malicious?"
    context: "This question applies advanced machine learning, specifically a transformer-based model like BERT, to understand the semantic content and structure of PowerShell scripts. Unlike simple keyword or entropy checks, this model can grasp the context and intent of the code, allowing it to identify sophisticated and novel malicious scripts with high accuracy."
    answer_sources:
      - "Windows Event ID 4104"
      - "Critical Servers (Domain Controllers, File Servers, Database Servers)"
      - "Administrator Workstations"
    range: "Last 90 days"
    queries:
      - "STREAM powershell_script_logs TO NLP_model | FILTER classification = 'malicious' AND confidence_score > 0.95"