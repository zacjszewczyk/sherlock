name: 'T1560.001: Archive via Utility'
id: 0a6c9a3e-1f8d-4a9b-8c7e-5d4f3b2a1c0d
description: >-
  This playbook helps answer if an adversary has collected and prepared data for exfiltration using archiving utilities. It provides investigative questions to detect the execution of known malicious archiving tools based on threat intelligence, the suspicious use of legitimate utilities with unusual command-line arguments or parent processes, the anomalous creation of archive files (.zip, .rar, .7z) in terms of location or size, the anomalous transfer of archives over the network, and correlated event sequences showing file discovery followed by compression on a single host.
type: technique
related:
  - 'TA0009: Collection'
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any archiving utilities been executed whose file hash or command-line arguments match known malicious indicators from threat intelligence?
    context: This question aims to detect the most straightforward and high-fidelity evidence of malicious archiving. By comparing process execution events against a curated list of known bad file hashes and command-line strings from Cyber Threat Intelligence (CTI), we can quickly identify the use of tools directly associated with threat actor campaigns. A match provides a strong signal of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - All enterprise endpoints and servers, particularly those hosting sensitive data or belonging to high-privilege users such as Domain Controllers, code repositories, and file servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process_creation_events
          WHERE (process_hash IN (cti_hash_list) OR command_line IN (cti_command_line_list))
          RETURN hostname, timestamp, process_name, process_hash, command_line
  - question: Have any rarely seen archiving utilities been executed across the enterprise?
    context: This question helps identify potentially malicious, non-standard archiving tools introduced by an adversary. It works by flagging executions of binaries that have a very low prevalence (e.g., seen on < 1% of hosts). This approach is effective for finding custom or less common adversary tools that are not yet present in standard CTI feeds.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - All enterprise endpoints and servers, particularly those hosting sensitive data or belonging to high-privilege users such as Domain Controllers, code repositories, and file servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE prevalence of each process_hash across all hosts.
          SEARCH process_creation_events
          WHERE process_name IN (archiving_tool_names) AND process_hash_prevalence < 0.01
          RETURN hostname, timestamp, process_name, process_hash, process_hash_prevalence
  - question: Can we use machine learning to classify the execution of an archiving utility as malicious based on its execution features?
    context: This question leverages a supervised machine learning model to predict maliciousness based on a combination of factors. By training on features like parent process name, command-line length, argument count, and process hash rarity, the model can identify complex patterns indicative of malicious behavior that are difficult to capture with simple rules or statistical thresholds.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - All enterprise endpoints and servers, particularly those hosting sensitive data or belonging to high-privilege users such as Domain Controllers, code repositories, and file servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each archiving_utility_execution:
            EXTRACT features (parent_process, cmd_length, hash_prevalence, binary_is_signed, etc.)
            INPUT features INTO trained_classification_model
            RETURN events where prediction is "malicious"
  - question: Have any legitimate archiving utilities been launched by an unusual parent process or with command-line arguments targeting sensitive directories?
    context: This question aims to detect the misuse of legitimate, "living-off-the-land" tools. Adversaries often use common utilities to blend in. This query looks for context that is out of place, such as an Office application or web server spawning an archiving process to compress sensitive user data (e.g., 'C:\Users'), which is highly indicative of data staging for exfiltration.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations, developer workstations, administrative jump boxes, and web servers where command-line tools are common but staging large archives, especially by automated processes, is not.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process_creation_events
          WHERE process_name IN (legit_archivers_list)
          AND (parent_process IN (unusual_parents_list) OR command_line CONTAINS (sensitive_paths_list) OR command_line CONTAINS (password_flags_list))
          RETURN hostname, timestamp, parent_process, process_name, command_line
  - question: Are there executions of legitimate archiving utilities that exhibit statistically rare parent-child process relationships or unusually complex command-line arguments?
    context: This question uses statistical analysis to find anomalies in how legitimate archiving tools are used. By baselining normal behavior, it can flag rare parent-child pairings (e.g., a web server process spawning tar.exe) or command lines with high entropy, which can indicate obfuscated scripts or randomized parameters used by an attacker to evade signature-based rules.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations, developer workstations, administrative jump boxes, and web servers where command-line tools are common but staging large archives, especially by automated processes, is not.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE baseline of normal parent-child pairs and command_line entropy for legit_archivers.
          SEARCH process_creation_events
          WHERE process_name IN (legit_archivers_list)
          AND (parent_child_pair_is_rare OR command_line_entropy > threshold)
          RETURN event_details
  - question: Can an anomaly detection model identify executions of legitimate archiving utilities that are statistical outliers compared to normal activity?
    context: This employs an unsupervised machine learning model to build a multi-dimensional profile of "normal" usage for archiving tools. It uses features like argument count, target file path depth, parent process rarity, and time of day. The model can then identify any execution that significantly deviates from this learned norm, flagging it as a potential threat without prior knowledge of the specific attack.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations, developer workstations, administrative jump boxes, and web servers where command-line tools are common but staging large archives, especially by automated processes, is not.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each legit_archiver_execution:
            EXTRACT features (arg_count, path_depth, parent_rarity, time_of_day)
            INPUT features INTO anomaly_detection_model
            RETURN events flagged as outliers
  - question: Have any archive files (.zip, .rar, etc.) been created in non-standard or suspicious locations like temporary directories or public user folders?
    context: Adversaries often stage data in temporary or world-writable directories like C:\Windows\Temp or C:\Users\Public to avoid immediate detection and potential permission issues. This question looks for the creation of archive files in these suspicious locations, especially when created by a process other than the user's interactive shell (explorer.exe) or a known backup program.
    answer_sources:
      - Sysmon Event ID 11
      - Windows Event ID 4688
      - Windows Event ID 4656
      - Windows Event ID 4663
      - File servers, document management systems (e.g., SharePoint servers), critical application servers, and user profile directories on workstations where large data sets reside or are commonly staged.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH file_creation_events
          WHERE file_extension IN ('.zip', '.rar', '.7z', '.cab', '.tar')
          AND file_path IN ('C:\Windows\Temp', '%APPDATA%', 'C:\Users\Public')
          AND creating_process NOT IN ('explorer.exe', 'backup.exe')
          RETURN hostname, timestamp, file_path, creating_process
  - question: Has any host exhibited a statistically unusual spike in the number or total size of archive files being created, or are archive filenames showing signs of randomization?
    context: This question aims to detect bulk data collection by looking for statistical deviations from normal behavior. A sudden increase in the volume of created archives on a host can indicate that an adversary is staging large amounts of data. Additionally, high Shannon entropy in filenames can suggest automated, randomized naming schemes used by malware to avoid simple IOC-based detection.
    answer_sources:
      - Sysmon Event ID 11
      - Windows Event ID 4688
      - Windows Event ID 4656
      - Windows Event ID 4663
      - File servers, document management systems (e.g., SharePoint servers), critical application servers, and user profile directories on workstations where large data sets reside or are commonly staged.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE hourly baseline of archive_count and archive_size per host.
          ALERT if count or size > 99th percentile of host's baseline.
          CALCULATE entropy of archive filenames in a 5-min window; ALERT if entropy > threshold.
  - question: Does a time-series forecasting model predict that the volume of archive data being created on a host is significantly anomalous?
    context: This uses an advanced statistical method, time-series forecasting, to model the expected volume of archive creation over time for each host, accounting for normal business cycles. An alert is triggered only when the actual volume of created archives significantly breaks from the model's predicted confidence interval. Correlating this with prior sensitive file access by the same process greatly increases alert fidelity.
    answer_sources:
      - Sysmon Event ID 11
      - Windows Event ID 4688
      - Windows Event ID 4656
      - Windows Event ID 4663
      - File servers, document management systems (e.g., SharePoint servers), critical application servers, and user profile directories on workstations where large data sets reside or are commonly staged.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          INPUT time_series of archive_data_volume per host INTO forecasting_model.
          ALERT if observed_volume > predicted_confidence_interval.
          ENRICH alert with preceding sensitive_file_access_events by the same process.
  - question: Have any archive files been transferred over the network to an unapproved external destination or over a non-standard port?
    context: This question focuses on detecting the exfiltration phase. It looks for network traffic where a file identified as an archive (by its MIME type) is sent to an external IP address that is not on an approved allowlist. It also checks for protocol-mismatch anomalies, such as archive data being sent over ports like DNS (53) or Kerberos (88), which is a common exfiltration technique.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points, VPN gateways, traffic to cloud storage provider IP ranges, and internal network segments separating critical servers from the general user network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          JOIN zeek_files_log and zeek_conn_log on UID.
          SEARCH where files.mime_type IN ('application/zip', 'application/x-rar-compressed')
          AND conn.dest_ip is external AND conn.dest_ip NOT IN (trusted_dest_allowlist)
          OR conn.dest_port IN (non_standard_ports_list)
          RETURN connection_details
  - question: Is any internal host transferring a statistically anomalous volume of archive data to external destinations, or sending data to new or rare Autonomous System Numbers (ASNs)?
    context: This question uses statistical baselining to detect unusual data exfiltration patterns. It identifies hosts that are suddenly sending out much more archived data than they normally do (e.g., Z-score > 3). It also detects connections to destination networks (ASNs) that the organization has never or rarely communicated with, which could indicate a new C2 channel or data drop zone.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points, VPN gateways, traffic to cloud storage provider IP ranges, and internal network segments separating critical servers from the general user network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE daily baseline of external_archive_bytes per host; ALERT if Z-score > 3.
          MAINTAIN list of known destination ASNs; ALERT on traffic to new or rare ASNs.
  - question: Can a machine learning model identify outbound archive transfers that are anomalous compared to a learned profile of normal activity?
    context: This leverages a one-class anomaly detection model to learn what "normal" outbound archive transfers look like, using a rich feature set including file size, destination port, time of day, destination ASN, and TLS details (JA3 hash, SNI). Any transfer that doesn't fit this complex, multi-dimensional profile is flagged as a potential exfiltration attempt, allowing for the detection of novel or sophisticated threats.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points, VPN gateways, traffic to cloud storage provider IP ranges, and internal network segments separating critical servers from the general user network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each outbound_archive_transfer:
            EXTRACT features (file_size, dest_port, time_of_day, dest_asn, ja3_hash, tls_sni)
            INPUT features INTO one_class_svm_model
            RETURN transfers flagged as anomalies
  - question: Has a correlated sequence of events occurred on a single host, involving file system discovery, followed by archiving, and the creation of an archive file in a short time window?
    context: This question seeks to identify the classic "smash and grab" data collection pattern. It uses a correlation rule to detect a logical chain of attacker activity: first, they run commands to find data (`dir /s`), then they compress it (`7z.exe`), and finally, the archive file is created. Seeing this sequence on one host within a short period (e.g., 30 minutes) is a strong indicator of active, hands-on-keyboard data collection.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 11
      - Domain Controllers, database servers, and workstations of executives, system administrators, or developers with access to sensitive intellectual property.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CORRELATE events on a single host within a 30-minute window:
          SEQUENCE(
            process_event where command_line contains 'dir /s' or 'Get-ChildItem -Recurse',
            process_event where process_name in ('7z.exe', 'tar.exe'),
            file_creation_event where file_extension is '.zip'
          )
  - question: Does the cumulative risk score of a user's session, based on a sequence of suspicious activities like discovery and compression, exceed a statistical threshold?
    context: This question uses a flexible risk-scoring model. Different suspicious actions (e.g., running discovery commands, archiving a sensitive directory, creating an archive in a temp folder) are assigned risk points. The total score for a user/host session is calculated over a rolling time window. If the score surpasses a high percentile (e.g., 98th) of all session scores, it indicates a session with a high concentration of suspicious behavior.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 11
      - Domain Controllers, database servers, and workstations of executives, system administrators, or developers with access to sensitive intellectual property.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each user_session:
            CALCULATE risk_score by summing points for events (discovery=+2, sensitive_archive=+5, temp_location=+3, parent_is_powershell=+4)
            ALERT if session_score > 98th_percentile of all session scores
  - question: Can a sequence analysis model (like an HMM or RNN) identify the `discovery -> compression -> staging` event chain as a statistically improbable and therefore anomalous sequence?
    context: This is an advanced approach where a machine learning model is trained on vast amounts of normal event sequences to learn the typical "flow" of activity. An attacker's `discovery -> compression -> stage` sequence, while logical to an analyst, is a very rare transition path compared to benign activity. The model flags this low-probability sequence as a high-risk anomaly without needing predefined rules.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 11
      - Domain Controllers, database servers, and workstations of executives, system administrators, or developers with access to sensitive intellectual property.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          INPUT host_event_sequences into trained_sequence_model (HMM/RNN).
          ALERT if model flags a sequence containing 'discovery->compress->stage' as a low-probability anomaly.