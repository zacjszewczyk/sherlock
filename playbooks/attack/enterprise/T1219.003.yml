name: T1219.003: Remote Access Hardware
id: 9e1b3f9b-1d7c-4a2e-8b6f-0c9d8e7f6a5b
description: This playbook helps determine if an adversary is establishing command and control using remote access hardware. It focuses on detecting indicators such as network connections to known C2 infrastructure, the connection of new physical devices matching hardware profiles (e.g., specific MAC OUIs or DHCP hostnames), suspicious event sequences like a new device connection followed by an immediate external network callout, interactive processes running without an active user logon, and persistent, low-volume network traffic patterns indicative of C2 heartbeats.
type: technique
related:
- TA0011: Command And Control
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are there any network connections or DNS queries matching a threat intelligence feed of known remote access hardware indicators?
  context: This question aims to find direct evidence of communication with C2 infrastructure associated with remote access hardware. By joining network connection and DNS logs with a threat intelligence feed of known IPs and domains for devices like PiKVM or TinyPilot, analysts can detect confirmed malicious activity.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Network egress points, internal DNS resolvers, and internet gateways.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      JOIN network_logs, dns_logs WITH threat_intel_feed
      ON network_logs.destination_ip = threat_intel_feed.ip
      OR dns_logs.query = threat_intel_feed.domain
      RETURN matches
- question: Have any domains been requested by only a single host within the enterprise?
  context: This question helps uncover potential C2 channels by identifying anomalous DNS activity. Legitimate services are typically accessed by many hosts, whereas a dedicated C2 domain may only be contacted by a single compromised machine. Ranking these single-host domains by their global rarity helps prioritize the most suspicious ones.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Network egress points, internal DNS resolvers, and internet gateways.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      GROUP dns_logs BY domain
      COUNT unique hosts per domain
      FILTER for domains with count = 1
      ENRICH with global domain prevalence data
      SORT by rarity
      RETURN rare_single_host_domains
- question: Are there any newly observed domains that a machine learning model classifies as malicious based on their lexical features?
  context: This question uses a machine learning model to proactively identify malicious domains that may not yet be on threat intelligence feeds. The model analyzes features like character randomness, length, and structure to distinguish algorithmically generated C2 domains from benign ones, flagging suspicious new domains for review.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Network egress points, internal DNS resolvers, and internet gateways.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each new domain in dns_logs
      EXTRACT lexical_features (entropy, length, etc.)
      APPLY classification_model(lexical_features)
      IF score > high_confidence_threshold
      RETURN suspicious_domain
- question: Has a new external device been detected on a server with a DHCP hostname matching known remote access hardware?
  context: This question looks for the physical introduction of unauthorized hardware. It correlates the detection of a new device (Windows Event ID 6416) on a critical server with DHCP requests containing hostnames (e.g., 'pikvm', 'tinypilot') that are defaults for remote access hardware, providing a strong signal of a physical breach.
  answer_sources:
  - Windows Event ID 6416
  - Zeek dhcp.log
  - Physical access points to servers (data centers), network closets, and workstations handling sensitive data.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FIND new_device_events (WinEvent 6416) on server-class machines
      CORRELATE with dhcp_logs by host
      WHERE dhcp_logs.hostname IN remote_access_hardware_watchlist
      RETURN matching events
- question: Have any new DHCP requests appeared with a MAC address OUI or client hostname that is historically rare in the environment?
  context: This question helps identify unauthorized devices by baselining normal DHCP activity. It maintains a frequency distribution of all observed MAC OUIs and hostnames. A new request containing an OUI or hostname that is statistically rare (e.g., in the bottom 1% of historical frequency) is flagged as a potential unknown and unauthorized device.
  answer_sources:
  - Windows Event ID 6416
  - Zeek dhcp.log
  - Physical access points to servers (data centers), network closets, and workstations handling sensitive data.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CALCULATE frequency distribution of OUIs and hostnames in dhcp_logs
      FOR each new DHCP request
      IF request.OUI_frequency < 1st_percentile OR request.hostname_frequency < 1st_percentile
      RETURN anomalous_dhcp_request
- question: Has a machine learning model classified any new device connection as a suspicious, non-standard asset based on its DHCP request?
  context: This question uses a classification model to distinguish between legitimate corporate devices and potentially malicious ones. The model is trained on features from DHCP requests (like hostname length, OUI, and requested options) to learn what a 'normal' corporate asset looks like, flagging any device that deviates from this profile for review.
  answer_sources:
  - Windows Event ID 6416
  - Zeek dhcp.log
  - Physical access points to servers (data centers), network closets, and workstations handling sensitive data.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each new device in dhcp_logs
      EXTRACT features (hostname_length, OUI, etc.)
      APPLY device_classification_model(features)
      IF classified as 'suspicious'
      RETURN suspicious_device
- question: Has a new device connection been immediately followed by a new external network connection from the same host, especially without an active interactive user logon?
  context: This question identifies a highly suspicious sequence of events indicative of automated malicious hardware. It correlates a new device connection with an immediate outbound network connection within a short time window. The suspicion is greatly increased if no interactive user (Logon Type 2 or 10) is logged in, suggesting the activity is not user-driven.
  answer_sources:
  - Windows Event ID 6416
  - Zeek conn.log
  - Windows Event ID 4624
  - Domain Controllers, database servers, and other Tier 0/Tier 1 assets.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CORRELATE new_device_events (WinEvent 6416) with outgoing_network_connections (Zeek conn.log)
      ON same host within a 3-minute window
      CHECK for absence of interactive_logon (WinEvent 4624, Type 2/10) on host
      RETURN correlated_suspicious_sequence
- question: Has the rate of 'new device connection followed by new external connection' events on any host significantly exceeded its historical baseline?
  context: This question uses statistical modeling to detect an abnormal frequency of a suspicious event sequence. By baselining the normal rate at which a host exhibits the 'new device -> external connection' pattern, a Poisson distribution model can identify a statistically significant spike in these events, suggesting a potential compromise or attack.
  answer_sources:
  - Windows Event ID 6416
  - Zeek conn.log
  - Windows Event ID 4624
  - Domain Controllers, database servers, and other Tier 0/Tier 1 assets.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each host
      CALCULATE baseline rate of (new_device -> external_connection) event pairs
      MODEL baseline with Poisson distribution
      MONITOR for observed counts that are statistical outliers
      RETURN hosts with anomalous event rates
- question: Has a sequence analysis model detected a low-probability event sequence involving a new hardware detection followed by an external network connection?
  context: This question leverages a sequence analysis model (like an HMM or LSTM) to learn the common, legitimate sequences of events on endpoints. It flags any observed sequence containing '[New Hardware Detected -> New External Connection]' that the model deems to have a very low probability of occurring, as this represents a novel and therefore suspicious chain of events.
  answer_sources:
  - Windows Event ID 6416
  - Zeek conn.log
  - Windows Event ID 4624
  - Domain Controllers, database servers, and other Tier 0/Tier 1 assets.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      INPUT event stream into sequence_analysis_model
      CALCULATE probability of observed event sequences
      IF probability of sequence containing [New Hardware -> External Connection] < low_prob_threshold
      RETURN anomalous_event_sequence
- question: Has an interactive process (like cmd.exe) been created by a non-service account user on a critical asset when no active interactive logon session for that user exists?
  context: This question aims to detect "ghost in the machine" activity, where an attacker operates on a system without a legitimate interactive session. It triggers a high-severity alert when a process associated with interactive use is created by a user account, but there is no corresponding logon event (Type 2, 3, or 10) for that user, after excluding known scheduled tasks.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4624
  - Windows Event ID 4634
  - Critical servers, administrative workstations, and systems with access to sensitive intellectual property.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each process_creation_event (WinEvent 4688) on critical assets
      IF user is not a service account AND process is interactive (cmd, powershell)
      CHECK for absence of active logon session (Type 2, 3, 10) for that user
      EXCLUDE known scheduled tasks
      RETURN suspicious_process_creation
- question: Has there been a sudden spike in the entropy of parent processes spawning interactive shells, or has a rare parent process spawned a shell without a logon session?
  context: This question statistically profiles parent-child process relationships to find anomalies. A sudden increase in the variety (entropy) of parent processes that launch shells, or a shell being spawned by a very unusual parent process (like a non-system service), especially without an active logon session, is a strong statistical indicator of compromise.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4624
  - Windows Event ID 4634
  - Critical servers, administrative workstations, and systems with access to sensitive intellectual property.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      PROFILE parent-child process relationships per host
      CALCULATE entropy of parent processes for interactive shells (cmd, powershell)
      ALERT on entropy spikes or rare parent processes spawning shells without a logon session
      RETURN anomalous_parent_child_relationship
- question: Has an anomaly detection model flagged any process creation event occurring outside of an active user logon session as a deviation from normal background activity?
  context: This question uses an anomaly detection model (e.g., Isolation Forest) to learn the patterns of legitimate background processes and scheduled tasks that run without an active user session. The model can then identify any new process activity that deviates from this learned baseline, flagging it as potentially malicious "ghost" activity.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4624
  - Windows Event ID 4634
  - Critical servers, administrative workstations, and systems with access to sensitive intellectual property.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      TRAIN anomaly_detection_model on features from background processes (user, parent, cmdline)
      APPLY model to new process events occurring without user logon
      IF event is flagged as an anomaly
      RETURN anomalous_process_event
- question: Has a server established a long-lived, low-data-volume TCP connection to an external IP on a non-standard port?
  context: This question searches for a classic C2 beaconing pattern a persistent connection that transfers very little data. The query specifically looks for TCP connections from a server that last for an extended period (e.g., >12 hours) but transfer a minimal amount of data (<50 KB) on an unusual port, after excluding known good services.
  answer_sources:
  - Zeek conn.log
  - Network egress points and firewalls monitoring traffic from critical server subnets and user VLANs.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SELECT * FROM zeek_conn_logs
      WHERE source is a server AND destination is external
      AND port is non-standard
      AND duration > 12 hours AND total_bytes < 50KB
      EXCLUDE approved services
      RETURN suspicious_long_connection
- question: Are there any new outgoing connections that are statistical outliers in terms of having a very long duration and very low data volume compared to the host's baseline?
  context: This question uses statistical baselining to identify low-and-slow C2 channels. For each host, it establishes a normal distribution of connection durations and data volumes. It then flags any new connection that is a statistical outlier (e.g., longer than the 98th percentile of durations and smaller than the 5th percentile of data volumes) as a potential C2 channel.
  answer_sources:
  - Zeek conn.log
  - Network egress points and firewalls monitoring traffic from critical server subnets and user VLANs.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each host, baseline distribution of connection_duration and total_bytes
      FOR each new connection
      IF connection.duration > 98th_percentile AND connection.total_bytes < 5th_percentile
      RETURN outlier_connection
- question: Does time series analysis of network connections from any host reveal a strong, regular signal indicative of automated C2 beaconing?
  context: This question applies time series analysis to detect the rhythmic, machine-like periodicity of C2 beaconing. By analyzing the timestamps of connections from a host to a specific destination, techniques like autocorrelation or Fourier transform can reveal a repeating pattern (e.g., a connection every 60 seconds), which is a hallmark of automated C2 implants.
  answer_sources:
  - Zeek conn.log
  - Network egress points and firewalls monitoring traffic from critical server subnets and user VLANs.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      GROUP connections by host, destination_ip
      CREATE time series from connection timestamps
      APPLY Fourier transform or autocorrelation
      IF strong periodic signal is detected
      RETURN beaconing_behavior_detected