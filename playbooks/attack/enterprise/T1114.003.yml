name: T1114.003: Email Forwarding Rule
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary is collecting sensitive information by creating email forwarding rules. It focuses on detecting evidence of auto-forwarding in email headers to untrusted external domains, identifying command-line execution of rule creation cmdlets (e.g., in PowerShell), monitoring for anomalous spikes in forwarded email volume, and detecting unauthorized processes modifying local email client rule files or registry keys.
type: technique
related:
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there any outbound emails being auto-forwarded to external domains that are either known-malicious or not on an approved business partner allow-list?
    context: This question aims to identify the most direct evidence of data exfiltration via email forwarding. By comparing forwarded-to domains against both threat intelligence and an internal allow-list, analysts can quickly flag high-risk forwarding rules that send data to untrusted or explicitly malicious destinations. A match indicates a potential compromise where an adversary has configured a rule to steal information.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Exchange Message Tracking Logs
      - Network Egress Points
      - Mail Gateway Servers
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH mail_logs WHERE forwarding_header_exists IS TRUE | EXTRACT destination_domain | CHECK destination_domain against threat_intel_list AND business_partner_allow_list | RETURN events WHERE destination_domain IS in threat_intel_list OR destination_domain IS NOT in business_partner_allow_list
  - question: Has a new, previously unseen external domain suddenly become the destination for email forwarding rules from multiple user accounts within a short time frame?
    context: This question helps detect coordinated or widespread attacks. An adversary might compromise multiple accounts and set up forwarding rules to the same external domain. A newly observed domain receiving forwards from several users simultaneously is a strong indicator of a targeted campaign, as legitimate forwarding is typically isolated and involves established partner domains.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Exchange Message Tracking Logs
      - Network Egress Points
      - Mail Gateway Servers
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH mail_logs WHERE forwarding_is_external IS TRUE | BASELINE destination_domains over 30_days | IDENTIFY new_destination_domains | FOR each new_destination_domain, COUNT distinct_users in last 24_hours | RETURN domains WHERE distinct_user_count > 2
  - question: Can machine learning classify an email forwarding event as malicious based on features of the destination domain and event context?
    context: This question leverages machine learning to automate the detection of suspicious forwarding by analyzing multiple weak signals simultaneously. Features like domain age, TLD, and reputation can collectively provide a strong indication of maliciousness that might be missed by simple rule-based checks. This helps identify novel or sophisticated attacks that use domains not yet on threat lists.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Exchange Message Tracking Logs
      - Network Egress Points
      - Mail Gateway Servers
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each forwarding_event | EXTRACT features (domain_age, domain_tld, domain_reputation, etc.) | APPLY classification_model | RETURN events WHERE model_prediction IS 'malicious' AND confidence_score > 0.90
  - question: Has a command-line interface, such as PowerShell, been used to create or modify an email inbox rule to forward messages to an external address not on an approved list?
    context: This question focuses on the method of rule creation. Adversaries often use command-line tools for automation and stealth. Detecting the execution of specific PowerShell cmdlets (`New-InboxRule`, `Set-InboxRule`) with forwarding parameters provides direct evidence of an attempt to programmatically create a data exfiltration channel, bypassing the typical user interface.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Exchange Servers (On-premise)
      - Domain Controllers
      - Endpoint Devices
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH command_logs (EID 4104, 4688) WHERE process IS 'powershell.exe' OR 'pwsh.exe' | FILTER command_line CONTAINS ('Set-InboxRule' OR 'New-InboxRule') AND ('-ForwardTo' OR '-ForwardingSmtpAddress') | EXTRACT target_address_domain | CHECK target_address_domain against partner_allow_list | RETURN events WHERE target_address_domain IS NOT in partner_allow_list
  - question: Is a non-administrative user executing mail-forwarding commands, or is a user executing these commands with unusually high complexity, suggesting obfuscation?
    context: This question aims to find outliers in command-line activity. Legitimate use of these cmdlets is typically restricted to a small group of administrators. Execution by a standard user is highly suspicious. Furthermore, adversaries may use obfuscation to hide their commands, which can be detected by measuring the command's string complexity (entropy). A high entropy score for a command from any user warrants investigation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Exchange Servers (On-premise)
      - Domain Controllers
      - Endpoint Devices
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH command_logs for mail_rule_cmdlets | FOR each event, CALCULATE command_line_entropy | BASELINE user_and_group_entropy | RETURN events WHERE (user IS NOT admin) OR (entropy > user_baseline + 2*stdev) OR (command_frequency > user_99th_percentile)
  - question: Can an anomaly detection model identify statistically unusual command executions that create or modify email forwarding rules?
    context: This question uses an unsupervised machine learning approach to find 'unknown unknowns.' By modeling normal behavior based on features like the executing user, parent process, and time of day, the model can flag any command execution that deviates significantly from the established norm. This is effective for detecting novel attack patterns that don't match pre-defined rules.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Exchange Servers (On-premise)
      - Domain Controllers
      - Endpoint Devices
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each mail_rule_command_event | EXTRACT features (user, role, parent_process, time_of_day) | APPLY anomaly_detection_model | RETURN events flagged as anomalous
  - question: Is there a direct temporal correlation between the creation of a new email forwarding rule in cloud audit logs and an immediate, sustained increase in forwarded email traffic from that user's account in network logs?
    context: This question links a configuration change directly to its effect on network traffic. The creation of a forwarding rule is a policy event, while the resulting email flow is the action. Correlating these two distinct data sources—an audit log and a network log—provides high-fidelity evidence that a newly created rule is actively exfiltrating data, bridging the gap between intent and impact.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Google Workspace Audit Logs
      - Zeek smtp.log
      - Zeek conn.log
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
      - Network Egress Points
      - Mail Gateway Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH audit_logs for 'New-InboxRule' event with external forwarding | EXTRACT user and timestamp | WITHIN minutes of event, SEARCH network_logs for forwarded_email_flow from same user to same external_address | RETURN correlated events
  - question: Has any user's daily volume of forwarded emails suddenly spiked to a level that is statistically significant compared to their own historical baseline?
    context: This question focuses on identifying anomalous behavior at the individual user level. A sudden, drastic increase in forwarded emails from an account that previously had little or no forwarding activity is a strong indicator of a new, potentially malicious rule. Using a user-specific baseline helps reduce false positives that might arise from comparing a user to a general organizational average.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Google Workspace Audit Logs
      - Zeek smtp.log
      - Zeek conn.log
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
      - Network Egress Points
      - Mail Gateway Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each user, CALCULATE daily_forwarded_email_volume | MAINTAIN 30-day moving_average and standard_deviation | RETURN alerts WHERE daily_volume > moving_average + 3*stdev
  - question: Is the current volume of forwarded emails for a user significantly higher than what a time series forecasting model predicted it would be?
    context: This question employs a more sophisticated statistical method to detect anomalies. Time series forecasting can account for trends and seasonality in a user's behavior. An alert is triggered only when the actual email volume is so far outside the predicted range that it cannot be explained by normal fluctuations, indicating a high probability of an anomalous event like a new malicious forwarding rule.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Google Workspace Audit Logs
      - Zeek smtp.log
      - Zeek conn.log
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
      - Network Egress Points
      - Mail Gateway Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each user, APPLY time_series_model to historical_forwarded_volume | PREDICT next_day_volume with confidence_interval | COMPARE actual_volume to prediction | RETURN alerts WHERE actual_volume > predicted_upper_bound
  - question: Has an unapproved process or application written to files or registry keys known to store Outlook email rules?
    context: This question focuses on the integrity of the endpoint where email clients are run. Email client rules are stored in specific files (e.g., .rwz) and registry locations. Normally, only the email client itself (e.g., outlook.exe) or administrative scripts should modify these. A modification by any other, unapproved process is a strong signal that malware or an unauthorized tool is attempting to create or alter rules covertly.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User Endpoint Devices
      - Virtual Desktop Infrastructure (VDI) Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH file_and_registry_logs (Sysmon EID 11, 13) | FILTER target_path is_known_outlook_rule_location | FILTER process_name IS NOT in allow_list ('outlook.exe', 'pwsh.exe') | RETURN matching events
  - question: Is a rare or previously unseen process interacting with email rule storage locations on the file system or in the registry?
    context: This question uses rarity and first-occurrence analysis to find suspicious activity. By baselining all processes that normally touch email rule locations, analysts can immediately spot a novel process performing this action. This is a powerful technique for detecting custom malware or living-off-the-land binaries (LOLBins) being used in an unusual context to manipulate email rules.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User Endpoint Devices
      - Virtual Desktop Infrastructure (VDI) Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: BASELINE all processes modifying email_rule_locations over 30 days | FOR each new modification event, CHECK process_name against baseline | RETURN events WHERE process_name is new or has very low frequency (<0.1% of endpoints)
  - question: Can a machine learning model classify file or registry modifications related to email rules as malicious based on process context?
    context: This question applies machine learning to endpoint data to distinguish between benign and malicious rule modifications. The model can learn the complex patterns of legitimate activity (e.g., Outlook modifying its own rule file) and flag deviations. Features like the parent process can be critical; for example, a rule modification by a process spawned from a Word document is highly suspicious.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User Endpoint Devices
      - Virtual Desktop Infrastructure (VDI) Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each email_rule_modification_event | EXTRACT features (process, parent_process, command_line) | APPLY classification_model | RETURN events WHERE model_prediction IS 'malicious' AND confidence_score is high