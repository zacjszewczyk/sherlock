name: T1114.003: Email Forwarding Rule
id: a1e8a4d6-4f7b-4b1e-8e6d-7c3f5a9b0c1d
description: Investigates whether an adversary is collecting sensitive information by creating email forwarding rules to exfiltrate data. This playbook helps detect this technique by analyzing email headers for forwarding to suspicious domains, monitoring for command-line execution of rule creation, identifying sudden increases in forwarded email volume, and detecting unusual processes modifying email client rule files or registry keys.
type: technique
related:
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are any outbound emails being auto-forwarded to external domains that are known-malicious or not on an approved partner allow-list?
    context: This question helps identify direct data exfiltration via email forwarding to suspicious destinations. Adversaries often set up rules to forward sensitive emails to external accounts they control. By checking the destination against threat intelligence and an allow-list of known business partners, analysts can quickly flag unauthorized or malicious forwarding activity.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Exchange Message Tracking Logs
      - Network Egress Points
      - Mail Gateway Servers
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: SEARCH mail_logs WHERE has_forwarding_header | EXTRACT destination_domain | LOOKUP threat_intel_domains, approved_partner_domains | WHERE is_malicious OR NOT is_approved_partner | RETURN user, destination_domain, timestamp
  - question: Has a new, rare external domain suddenly become the destination for email forwarding rules from multiple user accounts?
    context: This question aims to detect coordinated exfiltration campaigns. An adversary might compromise several accounts and set up forwarding rules to a single, newly-registered domain. By baselining normal forwarding destinations and looking for new domains being used by multiple users in a short timeframe, analysts can identify suspicious patterns.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Exchange Message Tracking Logs
      - Network Egress Points
      - Mail Gateway Servers
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: SEARCH mail_logs WHERE is_forwarded_externally | GROUP_BY destination_domain | COMPUTE first_seen_time, user_count_per_day | WHERE first_seen_time < 24h AND user_count > 2 | RETURN destination_domain, user_count
  - question: Can machine learning classify an email forwarding event as malicious based on its features?
    context: This question leverages a supervised machine learning model to automate the detection of malicious forwarding. By training a model on features like domain age, reputation, and geolocation, the system can identify subtle indicators of malicious activity that might be missed by simple rule-based detections, providing a more robust and scalable solution.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Exchange Message Tracking Logs
      - Network Egress Points
      - Mail Gateway Servers
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: FOR each forwarding_event | EXTRACT features (domain_tld, domain_age, asn, geo_ip) | PREDICT classification using trained_model | IF classification is 'malicious' AND confidence > 0.90 | ALERT
  - question: Are there command-line executions, such as PowerShell, creating or modifying email inbox rules to forward to external addresses?
    context: Adversaries may use command-line tools like PowerShell to programmatically create forwarding rules, which can be less noisy than using a GUI. This question focuses on detecting the specific commands and parameters (e.g., `Set-InboxRule`, `-ForwardingSmtpAddress`) used for this purpose, providing a high-fidelity indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Exchange Servers (On-premise)
      - Domain Controllers
      - Endpoint Devices
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: SEARCH process_logs OR powershell_logs | WHERE (command contains 'Set-InboxRule' OR 'New-InboxRule') AND (command contains '-ForwardTo' OR '-ForwardingSmtpAddress') AND destination_is_external_and_not_approved | ALERT
  - question: Is there anomalous or obfuscated command-line activity related to mail rule creation from unexpected user accounts?
    context: This question helps identify attempts to hide malicious activity. Adversaries may use non-standard user accounts or obfuscate their commands to evade detection. By baselining normal administrative behavior and looking for statistical outliers in command entropy or frequency, analysts can uncover sophisticated attempts to create malicious forwarding rules.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Exchange Servers (On-premise)
      - Domain Controllers
      - Endpoint Devices
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: SEARCH powershell_logs for mail_rule_cmdlets | FOR each event | CALCULATE command_entropy | COMPARE entropy to user_baseline | IF (user is not admin) OR (entropy_deviation > 2_std_dev) OR (frequency > 99th_percentile) | ALERT
  - question: Can an anomaly detection model identify statistically unusual command-line executions that create or modify forwarding rules?
    context: This question uses an unsupervised machine learning model to find "needles in a haystack." The model learns the normal patterns of command-line usage across the organization and can flag executions that are statistical outliers based on a combination of factors like the user, time, parent process, and command parameters, indicating a potential compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Exchange Servers (On-premise)
      - Domain Controllers
      - Endpoint Devices
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: FOR each command_event | EXTRACT features (user, parent_process, time_of_day, command_params) | SCORE with IsolationForest_model | IF score is anomalous AND command creates_forwarding_rule | ALERT
  - question: Is there a temporal correlation between a new forwarding rule being created in a cloud mail service and a sudden spike in forwarded emails from that user?
    context: This question links two distinct but related events to build a stronger case for malicious activity. An audit log event shows the "what" (a rule was created), and network/mail logs show the "impact" (a large volume of data was forwarded). Correlating these events in time provides high-confidence evidence of a newly active exfiltration rule.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Google Workspace Audit Logs
      - Zeek smtp.log
      - Zeek conn.log
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
      - Network Egress Points
      - Mail Gateway Servers
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: ON M365_audit_event for 'New-InboxRule' with external_forwarding | GET user, timestamp | SEARCH mail_logs for same_user near timestamp | IF immediate_and_sustained_increase_in_forwarded_emails | ALERT
  - question: Has any user's daily volume of forwarded emails significantly exceeded their historical baseline?
    context: This question focuses on changes in user behavior. A compromised account will often go from having no or low email forwarding activity to a sudden high volume. By establishing a baseline for each user's normal forwarding volume, analysts can easily spot significant deviations that indicate a new, and potentially malicious, forwarding rule has been activated.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Google Workspace Audit Logs
      - Zeek smtp.log
      - Zeek conn.log
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
      - Network Egress Points
      - Mail Gateway Servers
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: FOR each user | CALCULATE daily_forwarded_email_count | COMPARE to 30-day_moving_average_and_std_dev | IF daily_count > (average + 3 * std_dev) | ALERT
  - question: Does the current volume of forwarded emails for a user significantly exceed the volume predicted by a time series forecasting model?
    context: This question provides a more sophisticated approach to anomaly detection than simple baselining. A time series model can account for seasonality and trends (e.g., day-of-week patterns). An alert is triggered only when the actual email volume significantly surpasses what the model predicted was likely, reducing false positives and highlighting truly unexpected behavior.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Google Workspace Audit Logs
      - Zeek smtp.log
      - Zeek conn.log
      - Cloud Mail Service Tenant (e.g., Microsoft 365, Google Workspace)
      - Network Egress Points
      - Mail Gateway Servers
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: FOR each user | GET daily_forwarded_volume_history | PREDICT next_day_volume_and_confidence_interval with SARIMA_model | IF actual_volume > predicted_upper_bound | ALERT
  - question: Are unauthorized or non-allow-listed processes writing to or modifying files or registry keys associated with email client rules?
    context: This question focuses on how an adversary might create a forwarding rule on an endpoint. Instead of using standard tools like Outlook or PowerShell, they might use custom malware. By monitoring for modifications to specific rule files (e.g., .rwz) or registry keys by any process not on an allow-list, analysts can detect the use of unauthorized tools.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User Endpoint Devices
      - Virtual Desktop Infrastructure (VDI) Servers
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: SEARCH sysmon_logs WHERE (EventID=11 AND file_extension in ['.rwz', '.srs']) OR (EventID=13 AND registry_key contains 'Outlook\\Profiles') | IF process_name NOT IN allow_list | ALERT
  - question: Are rare or previously unseen processes interacting with email rule storage locations (files or registry)?
    context: This question helps identify novel or custom malware used to manipulate email rules. By profiling all processes that normally interact with rule storage locations, any new or exceptionally rare process performing such an action becomes highly suspicious. This method is effective at catching unknown threats that would be missed by signature-based detections.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User Endpoint Devices
      - Virtual Desktop Infrastructure (VDI) Servers
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: SEARCH sysmon_logs for rule_file_or_reg_modification | EXTRACT process_name | LOOKUP process_prevalence_baseline | IF process is_new OR is_rare (<0.1% of endpoints) | ALERT
  - question: Can a machine learning model classify file or registry modifications related to email rules as malicious based on process and user context?
    context: This question applies machine learning to endpoint data to determine the intent behind a rule modification. A model can learn the complex patterns of benign versus malicious activity by analyzing features like the process name, its parent, and command-line arguments. This allows for automated, high-confidence alerts on suspicious modifications.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User Endpoint Devices
      - Virtual Desktop Infrastructure (VDI) Servers
    range: last 90 days
    queries:
      - query_name: pseudocode
        query: FOR each rule_modification_event | EXTRACT features (process, parent_process, user, cmd_line) | PREDICT classification using trained_model | IF classification is 'malicious' with high_confidence | ALERT