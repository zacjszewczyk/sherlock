name: T1071.005: Publish-Subscribe Protocols
id: e0a3e3d6-7f9a-4b9e-9b0d-1c2d3e4f5a6b
description: This playbook helps determine if an adversary is using publish-subscribe protocols (e.g., MQTT, XMPP, AMQP) for command and control. It provides investigative steps to detect this activity by correlating network traffic with threat intelligence, analyzing protocol metadata for malicious signatures, monitoring for anomalous traffic patterns and volumes, identifying connections to unauthorized or suspicious brokers, analyzing topic names for statistical rarity or high entropy, and correlating pub/sub network events with subsequent high-risk process executions on endpoints.
type: technique
related:
  - TA0011: Command and Control
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are any internal hosts establishing publish-subscribe protocol connections to known malicious IP addresses or domains from a CTI feed?
    context: This question seeks to identify direct connections to known command and control (C2) infrastructure. A match against a high-confidence threat intelligence (CTI) feed on a pub/sub port (e.g., 1883 for MQTT, 5222 for XMPP) is a strong indicator of a compromise. This is a high-fidelity, signature-based check for active C2 communications.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Enterprise network egress points (e.g., firewalls, proxies)
      - Internal DNS resolvers
    range: last 90 days
    queries:
      - pseudocode: JOIN network_logs ON destination_ip WITH cti_feed ON ip; JOIN dns_logs ON resolved_ip WITH cti_feed ON ip; FILTER for pub/sub ports; ALERT on match.
  - question: Has there been a statistically significant increase in the number of unique source-destination pairs for pub/sub traffic that matches a CTI feed?
    context: This question aims to detect the wider deployment of a C2 campaign. While a single CTI match is significant, a sudden spike in the number of unique internal hosts connecting to known C2 infrastructure could indicate a widespread infection or a new phase of an attack. Baselining this activity helps distinguish isolated incidents from broader campaigns.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Enterprise network egress points (e.g., firewalls, proxies)
      - Internal DNS resolvers
    range: last 90 days
    queries:
      - pseudocode: COUNT unique source-destination pairs per hour for CTI-matched pub/sub traffic; COMPARE hourly count to 95th percentile of 90-day baseline; ALERT if count > baseline.
  - question: Can a machine learning model identify malicious publish-subscribe connections based on a combination of network features and threat intelligence?
    context: This question uses a predictive model to score the likelihood of a pub/sub connection being malicious, even without a direct CTI match. By training a logistic regression model on features like CTI matches (if any), destination ASN reputation, connection duration, and byte count, it's possible to uncover C2 channels that use previously unknown infrastructure by identifying combinations of suspicious characteristics.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Enterprise network egress points (e.g., firewalls, proxies)
      - Internal DNS resolvers
    range: last 90 days
    queries:
      - pseudocode: FOR each pub/sub connection, EXTRACT features (CTI_match, ASN_reputation, duration, bytes); SCORE with logistic regression model; ALERT if probability > 0.8.
  - question: Does any publish-subscribe metadata (e.g., MQTT topic, client ID) contain strings or patterns matching known malware signatures?
    context: This question looks for specific, hardcoded artifacts within the application layer of pub/sub traffic. Malware often uses predictable patterns for identifiers, topics, or usernames. Applying Yara rules or regular expressions to these fields can directly identify the presence of a specific malware family or tool based on prior threat intelligence and reverse engineering.
    answer_sources:
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Network sensors with application layer visibility (e.g., Zeek sensors)
      - Internal or cloud-hosted message brokers
    range: last 90 days
    queries:
      - pseudocode: APPLY Yara/regex rules to pub/sub metadata fields (topic, client_id, username); SEARCH for patterns like hex strings, GUIDs, base64; ALERT on match.
  - question: Are there any publish-subscribe sessions with unusually high entropy in their metadata fields, suggesting auto-generated C2 values?
    context: This question tries to identify algorithmically generated C2 values that lack known patterns. Adversaries may use randomized strings for topics or client IDs to evade signature-based detection. Calculating the Shannon entropy of these fields and comparing it to a baseline of normal traffic can reveal these randomized, high-complexity strings, which are anomalous and suspicious.
    answer_sources:
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Network sensors with application layer visibility (e.g., Zeek sensors)
      - Internal or cloud-hosted message brokers
    range: last 90 days
    queries:
      - pseudocode: FOR each session, CALCULATE Shannon entropy of metadata fields (topic, client_id); COMPARE entropy to 98th percentile of baseline; ALERT if entropy > baseline.
  - question: Can an anomaly detection model identify outlier publish-subscribe sessions based on the characteristics of their metadata?
    context: This question uses an unsupervised learning approach to find anomalous metadata without relying on specific signatures or entropy thresholds. By training a one-class SVM or isolation forest on features of legitimate metadata (like string length and character distribution), the model learns what 'normal' looks like. It can then flag any new session whose metadata deviates significantly from this learned norm, indicating a potential C2 channel.
    answer_sources:
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Network sensors with application layer visibility (e.g., Zeek sensors)
      - Internal or cloud-hosted message brokers
    range: last 90 days
    queries:
      - pseudocode: TRAIN one-class SVM/isolation forest on legitimate metadata features (length, char distribution); SCORE new pub/sub sessions; ALERT on outliers.
  - question: Are any hosts exhibiting extreme pub/sub connection behavior, such as excessively long-running connections or an abnormally high connection frequency?
    context: This question uses simple, static thresholds to catch egregious outliers that are almost certainly indicative of malicious or malfunctioning activity. For instance, a pub/sub connection lasting over 24 hours or a non-server host making thousands of connections per hour is highly abnormal and warrants immediate investigation as potential C2 keep-alive or beaconing activity.
    answer_sources:
      - Zeek conn.log
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Host network interfaces
      - Network segment gateways
      - Enterprise network egress points
    range: last 90 days
    queries:
      - pseudocode: ALERT if pub/sub connection duration > 24 hours; ALERT if non-server host pub/sub connection count > 1000 in one hour.
  - question: Has any host's daily pub/sub traffic profile (connection count, data volume, duration) deviated significantly from its own historical baseline?
    context: This question focuses on detecting changes in a host's own behavior over time. By establishing a 30-day rolling baseline for each host's pub/sub traffic metrics, we can identify when a host suddenly starts sending more data, connecting more frequently, or maintaining connections for longer. Such a deviation from its personal norm can indicate that the host has been compromised and is being used for C2.
    answer_sources:
      - Zeek conn.log
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Host network interfaces
      - Network segment gateways
      - Enterprise network egress points
    range: last 90 days
    queries:
      - pseudocode: For each host, CALCULATE daily pub/sub metrics (count, volume, duration); COMPARE daily metrics to 99th percentile of 30-day baseline; ALERT if metric > baseline.
  - question: Can machine learning models detect anomalies in a host's pub/sub traffic volume or its behavior relative to its peer group?
    context: This question applies more advanced modeling to detect subtle anomalies. A time series model (like Prophet) can forecast expected traffic volume and flag deviations that a simple percentile baseline might miss. Simultaneously, a clustering model can group similar hosts (e.g., all developer workstations). If a host's behavior causes it to drift away from its cluster, it signals a behavioral change that could be malicious.
    answer_sources:
      - Zeek conn.log
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Host network interfaces
      - Network segment gateways
      - Enterprise network egress points
    range: last 90 days
    queries:
      - pseudocode: FORECAST hourly pub/sub volume per host with ARIMA/Prophet; ALERT on significant deviation. CLUSTER hosts by traffic patterns; ALERT if a host becomes an outlier in its cluster.
  - question: Are any hosts initiating pub/sub connections to external destinations that are not on the organizational allow-list of approved brokers?
    context: This question implements a foundational security control by identifying communication to unauthorized services. By maintaining an allow-list of known-good pub/sub brokers, any connection to a destination not on that list is immediately suspicious. Enriching this alert with the process that initiated the connection provides critical context for an analyst to determine if it's unauthorized software or a malicious payload.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Internal DNS resolvers
      - Enterprise network egress points
      - Endpoint devices
    range: last 90 days
    queries:
      - pseudocode: FILTER pub/sub connections; CHECK if destination is in allow-list; IF NOT, ALERT and enrich with initiating process name from endpoint logs.
  - question: Among non-allow-listed pub/sub destinations, are any of them statistically rare (low prevalence) and newly registered?
    context: This question helps prioritize investigations among the many non-allow-listed destinations an organization might see. Legitimate services are typically used by many hosts (high prevalence). C2 infrastructure is often used by only a few compromised hosts (low prevalence). By flagging rare destinations and checking their domain registration date, we can surface highly suspicious C2 servers that are both newly created and not widely used.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Internal DNS resolvers
      - Enterprise network egress points
      - Endpoint devices
    range: last 90 days
    queries:
      - pseudocode: For non-allow-listed destinations, CALCULATE prevalence (unique hosts connecting); FLAG destinations in bottom 5th percentile; ENRICH with domain age; ALERT on rare, new domains.
  - question: Can clustering identify small, isolated groups of non-allow-listed pub/sub connections that may represent targeted C2 infrastructure?
    context: This question uses unsupervised learning to find 'conspiracies' in network traffic. Legitimate services often have connections from diverse locations with varied patterns. Targeted C2 infrastructure may manifest as a small, tight cluster of connections with similar features (e.g., same ASN, country, similar data patterns). A density-based algorithm like DBSCAN is effective at isolating these small clusters and single outliers, which are prime candidates for investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Internal DNS resolvers
      - Enterprise network egress points
      - Endpoint devices
    range: last 90 days
    queries:
      - pseudocode: CLUSTER non-allow-listed connections using DBSCAN on features (ASN, country, volume); INVESTIGATE small, isolated clusters and noise points.
  - question: Are any pub/sub topics being used that contain suspicious keywords related to command execution or file transfer?
    context: This question performs a simple but effective content scan on pub/sub topic names. Adversaries may use human-readable (though perhaps naive) topic names that betray their purpose, such as 'cmd/host123' or 'upload/file.zip'. Scanning for keywords like 'cmd', 'exec', 'shell', 'upload', etc., can provide high-confidence alerts for C2 activity.
    answer_sources:
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Network sensors with application layer visibility
      - Internal hosts generating pub/sub traffic
      - Message broker servers
    range: last 90 days
    queries:
      - pseudocode: SCAN 'topic' fields in pub/sub logs for keywords ('cmd', 'exec', 'upload', 'download'); ALERT on match.
  - question: Are hosts using new pub/sub topics for the first time, or are any topics being used that have unusually high entropy?
    context: This question uses two statistical methods to find anomalous topics. First, by tracking the set of topics each host normally uses, we can flag when a host uses a topic for the first time ('first-seen' analysis), which could indicate a new C2 task. Second, by calculating the entropy of all topics, we can identify algorithmically generated topic names that are designed to be random and evade signature-based detection.
    answer_sources:
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Network sensors with application layer visibility
      - Internal hosts generating pub/sub traffic
      - Message broker servers
    range: last 90 days
    queries:
      - pseudocode: MAINTAIN set of known topics per host; ALERT on first use of a new topic. CALCULATE entropy of all topics; ALERT if entropy > 99th percentile.
  - question: Can a topic modeling algorithm identify pub/sub topics that do not fit into any of the organization's established communication 'themes'?
    context: This question uses Natural Language Processing (NLP) to understand the semantic content of pub/sub topics. An algorithm like Latent Dirichlet Allocation (LDA) can analyze all topic names and group them into logical themes (e.g., 'sensor-data', 'system-health', 'user-chat'). A new topic related to C2 is unlikely to fit into any of these legitimate themes and would be flagged as an anomaly with a low probability score, providing a sophisticated way to detect novel threats.
    answer_sources:
      - Zeek mqtt.log
      - Zeek xmpp.log
      - Network sensors with application layer visibility
      - Internal hosts generating pub/sub traffic
      - Message broker servers
    range: last 90 days
    queries:
      - pseudocode: TRAIN LDA model on corpus of topic names to find themes; SCORE new topics against themes; ALERT on topics with low probability of belonging to any theme.
  - question: Is there a close temporal correlation between a pub/sub network connection and the execution of a suspicious process on the same host?
    context: This question directly links C2 communication with its resulting action on the endpoint. The core hypothesis is that a command is received via a pub/sub message, and then a process (like 'powershell.exe' or an executable in a temp directory) is launched to execute that command. A SIEM correlation rule that looks for this specific sequence of events within a short time window (e.g., 30 seconds) is a very powerful indicator of active, hands-on-keyboard C2 activity.
    answer_sources:
      - Zeek conn.log
      - Zeek mqtt.log
      - Windows Event ID 4688
      - Endpoint devices (workstations and servers)
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: CORRELATE pub/sub network event with process creation event on same host within 30 seconds; FILTER for suspicious processes (powershell.exe, cmd.exe) or paths (%TEMP%); ALERT on match.
  - question: Has there been a statistical increase in the rate of correlated pub/sub-to-process-execution events on any single host?
    context: This question baselines the frequency of the suspicious behavior identified in the symbolic rule. While a single occurrence is noteworthy, an increase in the rate of these correlated events on a specific host suggests an adversary is becoming more active on that machine. By tracking this rate over time, we can detect an escalation of activity that may precede lateral movement or data exfiltration.
    answer_sources:
      - Zeek conn.log
      - Zeek mqtt.log
      - Windows Event ID 4688
      - Endpoint devices (workstations and servers)
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: For each host, COUNT daily correlated pub/sub-to-process events; COMPARE daily rate to 99th percentile of 30-day baseline; ALERT if rate > baseline.
  - question: Can a machine learning model score the risk of a process execution event that is temporally linked to inbound pub/sub traffic?
    context: This question aims to build a predictive model to score the risk of these correlated event pairs, helping to prioritize analyst attention. By feeding a classifier features like the time difference, the reputation of the C2 server, the process name, its parent process, and any command-line arguments, the model can learn to distinguish benign correlations from malicious ones, reducing false positives and surfacing the most critical threats.
    answer_sources:
      - Zeek conn.log
      - Zeek mqtt.log
      - Windows Event ID 4688
      - Endpoint devices (workstations and servers)
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: For correlated event pairs, SCORE risk using Random Forest model with features (time_delta, IP_rep, process_name, parent_process, cmd_line); ALERT on high-risk score.