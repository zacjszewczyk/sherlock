name: "T1021.002: SMB-Windows Admin Shares"
id: "c1a2e3f4-b5d6-4c7e-8f9a-0b1c2d3e4f5a"
description: "This playbook helps investigate if an adversary is moving laterally through the network by exploiting Windows administrative shares (e.g., C$, ADMIN$). This technique is often observed through several key indicators: the transfer and subsequent execution of a known-malicious file on an administrative share; the creation of a new service or named pipe with a name matching known malicious tools (like PsExec or Cobalt Strike) immediately following an inbound SMB connection; anomalous access to default administrative shares, such as workstation-to-workstation traffic or access from a user account that has never performed this action before; and the complete behavioral sequence of a network logon, file write to an admin share, and remote execution of that file."
type: "technique"
related: 
    - "TA0008: Lateral Movement"
contributors:
    - "Zachary Szewczyk"
    - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
    - question: "Has a known-malicious file been transferred to a Windows administrative share and subsequently executed?"
      context: "This question aims to detect a common lateral movement pattern where an attacker copies a malicious tool to a hidden administrative share (like C$ or ADMIN$) and then runs it on the target system. Correlating a file write to an admin share with a known-bad file hash and a subsequent process creation provides a high-confidence indicator of compromise. The 5-minute window is critical for linking these events as part of a single, coordinated action."
      answer_sources:
        - "Zeek smb_files.log"
        - "Zeek files.log"
        - "Windows Event ID 4688"
        - "Windows Event ID 5145"
        - "Asset Inventory for NAI: Domain Controllers, File Servers, Database Servers, Developer Workstations, Executive Laptops"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Correlate WinEvent 5145 (ShareName ends with '$') with Zeek smb_files.log (write to same host), join with threat intel on file hash, and link to WinEvent 4688 (process creation of same file) within 5 minutes."
    - question: "Have any executables transferred to administrative shares shown unusually high entropy, suggesting packing or encryption?"
      context: "Attackers often pack or encrypt their malware to evade signature-based detection. This process typically increases the file's entropy (randomness). This question focuses on identifying executable files transferred over admin shares that have statistically anomalous entropy compared to a baseline of legitimate software. A high-entropy executable that is subsequently run is a strong signal of potentially malicious activity."
      answer_sources:
        - "Zeek smb_files.log"
        - "Zeek files.log"
        - "Windows Event ID 4688"
        - "Windows Event ID 5145"
        - "Asset Inventory for NAI: Domain Controllers, File Servers, Database Servers, Developer Workstations, Executive Laptops"
      range: "Last 90 days"
      queries:
        - "Pseudocode: For each file in smb_files.log transferred to admin share, calculate entropy. Compare entropy to 98th percentile of historical baseline. Alert if higher. Increase severity if WinEvent 4688 shows execution."
    - question: "Can we identify malicious file transfers to administrative shares using a machine learning model based on file and transfer characteristics?"
      context: "This question proposes a machine learning approach to move beyond simple rules and detect more nuanced malicious behavior. By training a model on various features like file entropy, PE header characteristics, user roles, and network context, we can assign a 'malice probability' to each file transfer. This allows for the detection of previously unseen malware and reduces reliance on static indicators, alerting on transfers that a model deems highly likely to be malicious."
      answer_sources:
        - "Zeek smb_files.log"
        - "Zeek files.log"
        - "Windows Event ID 4688"
        - "Windows Event ID 5145"
        - "Asset Inventory for NAI: Domain Controllers, File Servers, Database Servers, Developer Workstations, Executive Laptops"
      range: "Last 90 days"
      queries:
        - "Pseudocode: For each admin share file transfer, extract features (entropy, PE header, size, IP rep, etc.). Input features into trained classification model. Alert if malicious probability > 0.85."
    - question: "Has a remote network logon been immediately followed by the creation of a service or named pipe associated with known lateral movement tools?"
      context: "This question targets the signature behavior of tools like PsExec and Cobalt Strike, which authenticate to a remote host and then create a service or named pipe to execute commands. Correlating a network logon (Type 3) with the creation of a service or pipe whose name matches known malicious patterns (e.g., 'PSEXESVC') within a short timeframe is a high-fidelity indicator of an attacker moving laterally."
      answer_sources:
        - "Windows Event ID 7045"
        - "Sysmon Event ID 17"
        - "Sysmon Event ID 18"
        - "Windows Event ID 4624"
        - "Asset Inventory for NAI: Domain Controllers, File Servers, Critical Application Servers, Privileged User Workstations"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Correlate WinEvent 4624 (Logon Type 3) with WinEvent 7045 or Sysmon 17 on same host within 5 mins. Alert if ServiceName/PipeName matches regex list of malicious tools."
    - question: "Are there newly created services or named pipes with statistically unusual or rare names?"
      context: "Attackers often use randomly generated names for their services and named pipes to avoid static signature-based detection. This question uses a statistical approach (n-gram analysis) to identify names that do not conform to the established patterns of legitimate names in the environment. A name with a very low probability score is anomalous and warrants investigation, especially if created remotely by a non-standard account."
      answer_sources:
        - "Windows Event ID 7045"
        - "Sysmon Event ID 17"
        - "Sysmon Event ID 18"
        - "Windows Event ID 4624"
        - "Asset Inventory for NAI: Domain Controllers, File Servers, Critical Application Servers, Privileged User Workstations"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Build trigram frequency model on historical ServiceNames/PipeNames. Score each new name. Alert if score is below 5th percentile. Prioritize if user is non-standard admin."
    - question: "Can we detect anomalous service or named pipe creation events by identifying outliers in multi-dimensional feature space?"
      context: "This question leverages unsupervised machine learning to find outliers without pre-existing labels. By converting each service or named pipe creation event into a set of numerical features (name length, entropy, user rarity, etc.), we can use clustering algorithms like DBSCAN to group 'normal' events. Any event that does not fit into a cluster (i.e., an outlier or 'noise') is, by definition, statistically unique and should be investigated as potentially malicious."
      answer_sources:
        - "Windows Event ID 7045"
        - "Sysmon Event ID 17"
        - "Sysmon Event ID 18"
        - "Windows Event ID 4624"
        - "Asset Inventory for NAI: Domain Controllers, File Servers, Critical Application Servers, Privileged User Workstations"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Vectorize service/pipe creation events using features (name length, entropy, user rarity). Apply clustering algorithm (e.g., DBSCAN). Alert on events classified as outliers/noise."
    - question: "Has there been any administrative share access between two workstations, or by a non-privileged user account?"
      context: "Access to administrative shares is typically performed by administrators from specific management servers to other servers. Access between two end-user workstations (workstation-to-workstation) is highly unusual and a common indicator of lateral movement. Similarly, a standard user account accessing an admin share is a significant red flag. This question seeks to identify these explicit policy violations, which are often precursors to further attacks."
      answer_sources:
        - "Windows Event ID 4624"
        - "Windows Event ID 5145"
        - "Zeek conn.log"
        - "Asset Inventory for NAI: All Windows Servers, All Windows Workstations, Network East-West traffic monitoring points, VPN Concentrators"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Alert on WinEvent 5145 where ShareName ends in '$' AND source/dest are both 'workstations' in asset db, OR where user is not a privileged admin."
    - question: "Has any user, from a specific source, accessed an administrative share on a destination host for the first time, or has a single source accessed an unusually high number of hosts via admin shares?"
      context: "This question aims to detect two types of anomalous behavior. First, it identifies 'first-time' access patterns (a user/source/destination combination never seen before), which could indicate an attacker using a compromised account to explore the network. Second, it detects 'fan-out' activity, where a single compromised host is used to access many other hosts in a short period, which is a classic sign of an automated lateral movement script or tool."
      answer_sources:
        - "Windows Event ID 4624"
        - "Windows Event ID 5145"
        - "Zeek conn.log"
        - "Asset Inventory for NAI: All Windows Servers, All Windows Workstations, Network East-West traffic monitoring points, VPN Concentrators"
      range: "Last 90 days"
      queries:
        - "Pseudocode: For each admin share access (WinEvent 5145), check if (user, source, dest) triplet exists in 90-day baseline. Alert if new. Separately, count distinct destinations per source per hour. Alert if count > 99th percentile of baseline."
    - question: "Is there a statistically significant spike in the number of new, first-time administrative share connections across the network?"
      context: "This question models the network's administrative access patterns as a graph and looks for macro-level changes. A widespread lateral movement campaign will create many new connections (edges) in this graph as the attacker moves between systems. By using a time-series forecasting model, we can predict the 'normal' rate of new connections and alert when the actual number significantly exceeds this forecast, indicating a potential large-scale intrusion."
      answer_sources:
        - "Windows Event ID 4624"
        - "Windows Event ID 5145"
        - "Zeek conn.log"
        - "Asset Inventory for NAI: All Windows Servers, All Windows Workstations, Network East-West traffic monitoring points, VPN Concentrators"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Model daily count of new (user, source, dest) admin access triplets using time-series forecast (e.g., ARIMA). Alert if actual daily count exceeds the model's upper confidence interval."
    - question: "Has the full behavioral sequence of remote logon, admin share access, file write, and process execution been observed from a single source to a single destination?"
      context: "This question seeks to identify the entire attack chain for remote code execution via SMB admin shares. By correlating these four distinct events in a strict sequence and timeframe, we can create a very high-confidence alert. This stateful analysis moves beyond individual indicators to recognize the complete, multi-stage behavior, significantly reducing false positives and pinpointing active lateral movement."
      answer_sources:
        - "Windows Event ID 4624"
        - "Windows Event ID 5145"
        - "Zeek smb_files.log"
        - "Windows Event ID 4688"
        - "Asset Inventory for NAI: Internal network segments, East-West traffic monitoring points, Domain Controllers, Critical Servers"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Correlate sequence from same source/user to same dest within 2 mins: 1) WinEvent 4624 (Logon 3), 2) WinEvent 5145 (Share ends in '$'), 3) Zeek smb_files write, 4) WinEvent 4688 (exec of written file). Alert on full sequence match."
    - question: "Can we risk-score the sequence of an SMB file write followed by execution based on contextual factors?"
      context: "Not all remote file-write-and-execute sequences are malicious; some legitimate admin tools may use this pattern. This question introduces a risk-scoring system to prioritize the most suspicious sequences. By adding points for high-risk attributes—such as executable file types, writing to temporary directories, workstation-to-workstation traffic, and off-hours activity—we can focus analyst attention on events that accumulate a high risk score, tuning out more benign administrative behavior."
      answer_sources:
        - "Windows Event ID 4624"
        - "Windows Event ID 5145"
        - "Zeek smb_files.log"
        - "Windows Event ID 4688"
        - "Asset Inventory for NAI: Internal network segments, East-West traffic monitoring points, Domain Controllers, Critical Servers"
      range: "Last 90 days"
      queries:
        - "Pseudocode: For each [SMB Write -> Execute] sequence, calculate risk score. Add points for filetype, write location, WKS-to-WKS, off-hours. Alert if total score > 25."
    - question: "Can a sequence-aware machine learning model identify user sessions that exhibit patterns consistent with lateral movement?"
      context: "This question proposes an advanced analytical method using models like RNNs or HMMs, which are specifically designed to understand sequences. By training on labeled benign and malicious user sessions, the model learns the typical 'grammar' of user actions. It can then analyze new, unseen sessions in real-time and flag those whose sequence of events (logon, file access, process creation, etc.) is highly probable to be malicious, allowing for the detection of novel or complex attack patterns."
      answer_sources:
        - "Windows Event ID 4624"
        - "Windows Event ID 5145"
        - "Zeek smb_files.log"
        - "Windows Event ID 4688"
        - "Asset Inventory for NAI: Internal network segments, East-West traffic monitoring points, Domain Controllers, Critical Servers"
      range: "Last 90 days"
      queries:
        - "Pseudocode: Feed user session event sequences (logon, file access, etc.) into a trained sequence model (e.g., RNN). Alert if the model classifies the sequence probability as 'malicious' or 'lateral movement'."