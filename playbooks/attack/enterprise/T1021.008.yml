name: 'T1021.008: Direct Cloud VM Connections'
id: 'f8a9b7c6-d5e4-4f3a-2b1c-0d9e8f7a6b5c'
description: 'This playbook helps investigate if an adversary is moving laterally by using direct connections to cloud virtual machines. It focuses on identifying suspicious activities following a direct VM login, such as outbound connections to known C2 infrastructure, execution of post-exploitation tools, anomalous login properties (e.g., unusual geolocation or time), spikes in data exfiltration, and sequences of discovery commands followed by internal network connection attempts.'
type: 'technique'
related:
  - 'TA0008: Lateral Movement'
contributors:
  - 'Zachary Szewczyk'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Following a direct VM access event, did the VM connect to a known command-and-control (C2) server?'
    context: "This question seeks to identify a common adversary pattern where, after gaining access to a cloud virtual machine, they establish a connection to their C2 infrastructure for further command execution or data exfiltration. Correlating a direct access event (like AWS SSM 'StartSession' or Azure 'RunCommand') with an immediate outbound network connection to an IP or domain on a threat intelligence feed provides a high-fidelity indicator of compromise."
    answer_sources:
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Cloud management plane (e.g., AWS CloudTrail, Azure Activity Logs)'
      - 'Cloud VM instances (e.g., Windows Event Logs)'
      - 'Virtual network traffic sensors (e.g., VPC Flow Logs, Zeek sensors)'
      - 'Egress network gateways'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FIND direct_vm_access_event (e.g., AWS SSM 'StartSession', Azure 'RunCommand') FOR vm_instance. WITHIN 30 minutes, FIND network_flow_event (e.g., Zeek conn.log) WHERE source_ip IS vm_instance.ip AND destination_ip OR destination_domain (from Zeek dns.log) IS IN c2_threat_feed."
  - question: 'Following a direct VM access event, did the VM exhibit an unusually random pattern of outbound destination ports?'
    context: "This question aims to detect anomalous network behavior like port scanning or the use of random high-numbered ports for C2 communication, which can deviate from a VM's normal traffic profile. By establishing a baseline of destination port entropy and alerting on significant deviations after a direct access event, we can identify suspicious scanning or communication attempts that might indicate adversary activity."
    answer_sources:
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Cloud management plane (e.g., AWS CloudTrail, Azure Activity Logs)'
      - 'Cloud VM instances (e.g., Windows Event Logs)'
      - 'Virtual network traffic sensors (e.g., VPC Flow Logs, Zeek sensors)'
      - 'Egress network gateways'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: 'FOR EACH vm_instance: BASELINE destination_port_entropy over 30 days. FIND direct_vm_access_event FOR vm_instance. WITHIN 60 minutes, CALCULATE new_destination_port_entropy. ALERT IF new_entropy > (baseline_mean + 3 * baseline_std_dev).'
  - question: 'Following a direct VM access event, was there an anomalous spike in the volume of outbound data from the VM?'
    context: "This question focuses on detecting potential data exfiltration. Adversaries often transfer large amounts of stolen data after gaining access. By using a time-series forecasting model to predict normal outbound data volume, we can flag any observed volume that significantly exceeds the prediction after a direct access event, which could indicate a data theft in progress."
    answer_sources:
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Cloud management plane (e.g., AWS CloudTrail, Azure Activity Logs)'
      - 'Cloud VM instances (e.g., Windows Event Logs)'
      - 'Virtual network traffic sensors (e.g., VPC Flow Logs, Zeek sensors)'
      - 'Egress network gateways'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FOR EACH vm_instance: TRAIN time-series model on hourly outbound_bytes. FIND direct_vm_access_event FOR vm_instance. FOR each subsequent hour, OBSERVE actual_outbound_bytes. ALERT IF actual_outbound_bytes > model_predicted_upper_bound."
  - question: 'Following a direct VM access event, were any known malicious tools or suspicious commands executed on the VM?'
    context: "This question tries to identify the execution of post-exploitation tools or reconnaissance commands immediately after an adversary gains access. Correlating a direct login with the creation of a process matching a watchlist of malicious signatures (e.g., 'mimikatz.exe', 'powershell -enc') is a strong indicator that the access is being used for malicious purposes."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4624'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Cloud VM instance event logs (e.g., Windows Event Log, Linux auditd)'
      - 'Cloud management plane logs'
      - 'EDR agent logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FIND direct_vm_access_event FOR vm_instance. WITHIN 60 minutes, FIND process_creation_event (e.g., WinEvent 4688) ON vm_instance WHERE process_name OR command_line MATCHES malicious_watchlist."
  - question: 'Following a direct VM access event, were any commands executed with unusually high complexity or obfuscation?'
    context: "Adversaries often use obfuscation (e.g., Base64 encoding in PowerShell) to hide their commands. This question aims to detect such activity by analyzing the entropy of command-line arguments. A command with unusually high entropy for a common process like 'powershell.exe' after a direct login suggests an attempt to evade detection."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4624'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Cloud VM instance event logs (e.g., Windows Event Log, Linux auditd)'
      - 'Cloud management plane logs'
      - 'EDR agent logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FOR EACH process_name: BASELINE command_line_entropy. FIND direct_vm_access_event FOR vm_instance. FIND subsequent process_creation_event ON vm_instance. CALCULATE new_command_line_entropy. ALERT IF new_entropy > 95th_percentile_for_process_name."
  - question: 'Following a direct VM access event, did a machine learning model classify any executed commands as malicious?'
    context: "This question leverages a machine learning model trained to recognize malicious command-line patterns. By analyzing features like argument length, special characters, and n-gram frequency, the model can provide a probabilistic score of maliciousness. This approach can detect novel or sophisticated malicious commands that might not be on a static watchlist."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4624'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Cloud VM instance event logs (e.g., Windows Event Log, Linux auditd)'
      - 'Cloud management plane logs'
      - 'EDR agent logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "TRAIN ML model on command_line_features. FIND direct_vm_access_event FOR vm_instance. FOR each subsequent process_creation_event, FEED command_line to ML model. ALERT IF model_score > 0.9."
  - question: 'Did a direct interactive login to a cloud VM originate from an unexpected or unapproved geographic location?'
    context: "This question helps identify suspicious logins based on their geographic origin. An interactive login (like RDP) from a country where the organization has no presence or from which users do not typically connect is a strong indicator of a compromised account or an external threat actor."
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Zeek conn.log'
      - 'Cloud VM instance authentication logs (e.g., Windows Security Log)'
      - 'Cloud management plane logs'
      - 'Identity and Access Management (IAM) logs'
      - 'Geolocation databases'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FIND interactive_login_event (e.g., WinEvent 4624, Logon Type 2 or 10) TO cloud_vm. GET source_ip_country. ALERT IF source_ip_country IS NOT IN country_allow_list."
  - question: 'Did a successful login to a cloud VM exhibit multiple behavioral anomalies for that specific user?'
    context: "This question aims to detect 'impossible travel' scenarios or other deviations from a user's established behavior. By profiling a user's typical login patterns (source country, ISP, time of day) and scoring new logins against this profile, we can identify events that are highly uncharacteristic for that user, such as logging in from a new country at 3 AM, which might indicate account takeover."
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Zeek conn.log'
      - 'Cloud VM instance authentication logs (e.g., Windows Security Log)'
      - 'Cloud management plane logs'
      - 'Identity and Access Management (IAM) logs'
      - 'Geolocation databases'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FOR EACH user: PROFILE historical login behavior (country, ISP, hour). FOR each new login, CALCULATE risk_score based on deviations from profile. ALERT IF risk_score > 98th_percentile_for_user."
  - question: "Was a successful login to a cloud VM identified as an outlier compared to the organization's overall login patterns?"
    context: "This question uses unsupervised machine learning to find logins that don't fit any established pattern of normal activity across the organization. By clustering historical logins based on features like user, geolocation, and time, any new login that falls outside these clusters is considered an anomaly. This can help detect novel attack patterns that don't match a specific user's history but are unusual for the organization as a whole."
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Zeek conn.log'
      - 'Cloud VM instance authentication logs (e.g., Windows Security Log)'
      - 'Cloud management plane logs'
      - 'Identity and Access Management (IAM) logs'
      - 'Geolocation databases'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "CLUSTER historical login data using DBSCAN on features (user, geo, time). FOR each new login, CHECK if it belongs to an existing cluster. ALERT IF login is an outlier (does not belong to any cluster)."
  - question: 'Following a direct VM access event, did the VM attempt to resolve a domain associated with a dynamic DNS provider?'
    context: "Adversaries often use dynamic DNS (DDNS) providers to host their C2 infrastructure because it allows them to change IP addresses frequently. This question aims to detect this TTP. A DNS query to a non-allow-listed DDNS service shortly after a direct login is highly suspicious and may indicate an attempt to establish a C2 channel."
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Windows Event ID 5156'
      - 'Windows Event ID 4624'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Network sensors capturing VPC/VNet flow data (e.g., Zeek sensors)'
      - 'Egress network gateways'
      - 'Cloud VM network kernel logs (e.g., Windows Event ID 5156)'
      - 'DNS server logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FIND direct_vm_access_event FOR vm_instance. WITHIN 60 minutes, FIND dns_query_event (e.g., Zeek dns.log) FROM vm_instance WHERE queried_domain IS in known_ddns_provider_list AND NOT in organizational_allow_list."
  - question: "Following a direct VM access event, did the VM's outbound data transfer exceed its own historical high-water mark?"
    context: "This question provides a simple but effective method for detecting data exfiltration. By establishing a baseline of the normal peak hourly outbound traffic for each VM, any transfer that exceeds this threshold (e.g., the 99th percentile) after a direct login is a strong anomaly. This is a clear signal that an unusual amount of data is leaving the machine, warranting investigation."
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Windows Event ID 5156'
      - 'Windows Event ID 4624'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Network sensors capturing VPC/VNet flow data (e.g., Zeek sensors)'
      - 'Egress network gateways'
      - 'Cloud VM network kernel logs (e.g., Windows Event ID 5156)'
      - 'DNS server logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FOR EACH vm_instance: BASELINE 99th_percentile of hourly_outbound_bytes over 30 days. FIND direct_vm_access_event FOR vm_instance. IN subsequent hour, MEASURE total_outbound_bytes. ALERT IF total_outbound_bytes > baseline_99th_percentile."
  - question: "Following a direct VM access event, did the VM's overall network profile (e.g., bytes sent, connection count, unique ports) deviate from its normal behavior?"
    context: "This question uses a more sophisticated, holistic approach to anomaly detection. Instead of looking at a single metric, a multivariate model learns the complex relationships between various network indicators (like traffic volume, connection frequency, port usage). An alert from this model after a direct login indicates that the VM's network activity as a whole is abnormal, which can detect subtle or complex attack patterns that simpler rules might miss."
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Windows Event ID 5156'
      - 'Windows Event ID 4624'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Network sensors capturing VPC/VNet flow data (e.g., Zeek sensors)'
      - 'Egress network gateways'
      - 'Cloud VM network kernel logs (e.g., Windows Event ID 5156)'
      - 'DNS server logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FOR EACH vm_instance: TRAIN multivariate model on network metrics (bytes, connections, ports). FIND direct_vm_access_event FOR vm_instance. FEED subsequent network metrics to model. ALERT IF model flags behavior as anomalous."
  - question: 'Following a direct VM access, was there a sequence of discovery commands followed by an attempt to move laterally to another internal system?'
    context: "This question looks for the classic 'login -> recon -> lateral movement' attack chain. Detecting this specific sequence of events—a direct login, followed by local reconnaissance commands (like 'whoami', 'ipconfig'), and then an attempt to connect to another internal machine on an admin port (like RDP or SSH)—provides extremely strong evidence of an adversary actively moving through the network."
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4648'
      - 'Zeek conn.log'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Cloud VM instance logs (Security and System)'
      - 'Cloud management plane logs'
      - 'Network sensors monitoring east-west traffic between internal segments'
      - 'Domain Controller authentication logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "WITHIN a 60-minute window on a single vm_instance: FIND direct_vm_access_event, THEN FIND >=2 process_creation_events for discovery_commands, THEN FIND outbound_connection to internal_ip on admin_port (22, 3389, 5985). ALERT on sequence."
  - question: 'Following a direct VM access, did a user execute an unusually high number of discovery commands compared to their peers?'
    context: "This question aims to identify excessive reconnaissance activity by comparing a user's actions to a baseline for their role. While an administrator might run a few discovery commands, a long string of them could be suspicious. By flagging users who execute significantly more discovery commands than their peers shortly after logging in, we can pinpoint potential account misuse or adversary activity."
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4648'
      - 'Zeek conn.log'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Cloud VM instance logs (Security and System)'
      - 'Cloud management plane logs'
      - 'Network sensors monitoring east-west traffic between internal segments'
      - 'Domain Controller authentication logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "FOR EACH user_role: BASELINE count of discovery_commands in first 60 mins of session. FIND direct_vm_access_event for a user. COUNT discovery_commands in next 60 mins. ALERT IF count > 95th_percentile_for_user_role."
  - question: 'Following a direct VM access, did the sequence of user actions deviate from patterns of normal administrative sessions?'
    context: "This question uses advanced machine learning to understand the 'grammar' of a normal user session. A model is trained on typical sequences of events (e.g., login -> start service -> edit config). When a new session after a direct login shows an unusual sequence (e.g., login -> run whoami -> run net user -> connect to file share), the model will have a high reconstruction error, flagging it as anomalous. This can detect novel attack paths that don't rely on specific signatures."
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4648'
      - 'Zeek conn.log'
      - 'AWS CloudTrail'
      - 'Azure Activity Logs'
      - 'Cloud VM instance logs (Security and System)'
      - 'Cloud management plane logs'
      - 'Network sensors monitoring east-west traffic between internal segments'
      - 'Domain Controller authentication logs'
    range: 'last 90 days'
    queries:
      - search: 'Pseudocode'
        query: "TRAIN sequence model (e.g., LSTM autoencoder) on normal event sequences. FIND direct_vm_access_event. CAPTURE subsequent event sequence. FEED sequence to model. ALERT IF model reconstruction_error is high."