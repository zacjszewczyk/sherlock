name: "T1021.008: Direct Cloud VM Connections"
id: "5e9f8a7b-c6d5-4e3f-8a9b-0c1d2e3f4a5b"
description: "This playbook helps investigate if an adversary is moving laterally by using direct connections to cloud virtual machines. It focuses on identifying suspicious activities following a direct interactive login to a cloud VM, such as connections to known command-and-control servers, anomalous network traffic patterns (like high port entropy or unusual data volumes), execution of post-exploitation tools or discovery commands, obfuscated command-line arguments, and login events with anomalous properties like unusual geographic locations or times. The playbook provides questions and queries to detect these sequences of events, helping to distinguish malicious lateral movement from benign administrative activity."
type: technique
related:
- "TA0008: Lateral Movement"
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: "Has a direct cloud VM login been followed within 30 minutes by an outbound network connection to a known C2 server?"
  context: "This question aims to detect the common adversary pattern of gaining access to a machine and immediately establishing a connection back to their command-and-control infrastructure. Correlating a direct access event (like AWS SSM 'StartSession' or Azure 'RunCommand') with subsequent network traffic to a destination on a C2 threat intelligence list provides a high-fidelity indicator of compromise."
  answer_sources:
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Windows Event ID 4624"
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Cloud management plane logs"
  - "Cloud VM instance event logs"
  - "Virtual network traffic sensors"
  - "Egress network gateways"
  range: "last 90 days"
  queries:
  - "pseudocode": "SEARCH direct_vm_access_events | JOIN vm_id, time | SEARCH network_connections within 30m of access_time | WHERE destination_ip IN c2_threat_feed | ALERT"
- question: "Following a direct VM access event, did the VM exhibit an anomalously high variety of outbound destination ports?"
  context: "This question seeks to identify scanning or service discovery behavior. After compromising a host, an adversary might scan for open ports on other systems. This activity results in connections to a wide and unusual variety of destination ports, leading to a spike in port entropy. Comparing this entropy to a historical baseline for the specific VM helps differentiate malicious scanning from normal application behavior."
  answer_sources:
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Windows Event ID 4624"
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Cloud management plane logs"
  - "Cloud VM instance event logs"
  - "Virtual network traffic sensors"
  - "Egress network gateways"
  range: "last 90 days"
  queries:
  - "pseudocode": "FOR each VM, BASELINE destination port entropy over 30 days from network_logs | ON direct_vm_access_event, CALCULATE port entropy for next 60m | IF entropy > baseline_mean + 3 * baseline_std_dev, ALERT"
- question: "Did the volume of outbound data from a VM significantly increase beyond its predicted normal levels after a direct access event?"
  context: "This question is designed to detect data exfiltration. After gaining access, an adversary may stage and exfiltrate large volumes of data. A time-series model learns the normal 'rhythm' of a VM's data output. A significant deviation from the model's prediction, especially after a direct login, is a strong indicator that data is being stolen."
  answer_sources:
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Windows Event ID 4624"
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Cloud management plane logs"
  - "Cloud VM instance event logs"
  - "Virtual network traffic sensors"
  - "Egress network gateways"
  range: "last 90 days"
  queries:
  - "pseudocode": "FOR each VM, TRAIN time-series model on hourly outbound_bytes | ON direct_vm_access_event, PREDICT expected outbound_bytes | IF actual_bytes > predicted_upper_bound, ALERT"
- question: "Was a direct VM access event followed within 60 minutes by the execution of known malicious tools or discovery commands?"
  context: "This is a straightforward hunt for known bad activity. Adversaries often use a standard toolkit for post-exploitation, including credential dumpers like Mimikatz or reconnaissance commands like 'nltest'. Correlating a direct login with the immediate execution of these tools on the same machine is a strong signal of an active intrusion."
  answer_sources:
  - "Windows Event ID 4688"
  - "Windows Event ID 4624"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Cloud VM instance event logs (e.g., Windows Event Log, Linux auditd)"
  - "Cloud management plane logs"
  - "EDR agent logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "SEARCH direct_vm_access_events | JOIN vm_id, time | SEARCH process_creation_events within 60m of access_time | WHERE process_name OR command_line MATCHES malicious_tool_watchlist | ALERT"
- question: "Following a direct VM access, was a process executed with an unusually complex or obfuscated command line?"
  context: "Adversaries frequently use obfuscation to hide their commands from simple signature-based detection. High entropy in a command-line string, especially for common utilities like PowerShell or cmd.exe, often indicates encoded or randomly generated payloads. Comparing the entropy against a historical baseline for that specific process helps identify these obfuscated commands and reduce false positives from normally complex administrative scripts."
  answer_sources:
  - "Windows Event ID 4688"
  - "Windows Event ID 4624"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Cloud VM instance event logs (e.g., Windows Event Log, Linux auditd)"
  - "Cloud management plane logs"
  - "EDR agent logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "FOR each process_name, BASELINE command_line entropy | ON direct_vm_access_event, for each new process, CALCULATE command_line entropy | IF entropy > 95th_percentile_for_process, ALERT"
- question: "Did any command lines executed after a direct VM access receive a high maliciousness score from a machine learning classifier?"
  context: "This question leverages machine learning to move beyond simple signatures and heuristics. A model trained on a large dataset of benign and malicious command lines can learn subtle characteristics of malicious activity. By scoring all commands executed after a direct login, analysts can surface novel or highly obfuscated attacks that might otherwise be missed, providing a more robust and adaptive detection capability."
  answer_sources:
  - "Windows Event ID 4688"
  - "Windows Event ID 4624"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Cloud VM instance event logs (e.g., Windows Event Log, Linux auditd)"
  - "Cloud management plane logs"
  - "EDR agent logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "ON direct_vm_access_event, for each subsequent process_creation_event | SCORE command_line with ML_model | IF score > 0.9, ALERT"
- question: "Was there a successful interactive login to a cloud VM from a geographically unexpected country?"
  context: "This question provides a simple but effective geographic filter. Most organizations operate within a predictable set of countries. A login from a country where the organization has no business or employees is highly suspicious. This rule acts as a coarse, first-level check for unauthorized access attempts from unexpected parts of the world."
  answer_sources:
  - "Windows Event ID 4624"
  - "Windows Event ID 4625"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Zeek conn.log"
  - "Cloud VM instance authentication logs"
  - "Cloud management plane logs"
  - "Identity and Access Management (IAM) logs"
  - "Geolocation databases"
  range: "last 90 days"
  queries:
  - "pseudocode": "SEARCH successful_interactive_logins (Type 2 or 10) | GEO_LOOKUP source_ip | IF country NOT IN org_country_allow_list, ALERT"
- question: "Did a user's successful login to a cloud VM exhibit multiple deviations from their established behavior profile?"
  context: "This question operationalizes the concept of 'impossible travel' and behavioral analytics. Instead of relying on a single anomalous property, it aggregates risk by scoring multiple deviations from a user's normal login patterns (e.g., new location, different ISP, unusual time). A high cumulative score for a single login event strongly suggests that the credentials may be compromised, as it is unlikely for a legitimate user to change multiple aspects of their login behavior simultaneously."
  answer_sources:
  - "Windows Event ID 4624"
  - "Windows Event ID 4625"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Zeek conn.log"
  - "Cloud VM instance authentication logs"
  - "Cloud management plane logs"
  - "Identity and Access Management (IAM) logs"
  - "Geolocation databases"
  range: "last 90 days"
  queries:
  - "pseudocode": "FOR each user, PROFILE historical login country, ISP, hour | ON new_login, CALCULATE risk_score based on deviations from profile | IF risk_score > 98th_percentile_for_user, ALERT"
- question: "Was a successful login to a cloud VM identified as an outlier when compared to the organization's established login patterns?"
  context: "This question uses unsupervised machine learning to find 'unknown unknowns' in login data. Clustering algorithms like DBSCAN can automatically group similar logins into 'normal' clusters based on features like user, location, and time. Any login that doesn't fit into an existing cluster is flagged as an outlier. This is powerful for detecting novel attack vectors or compromised accounts that don't trigger specific, predefined rules but are clearly abnormal when viewed in the context of all historical activity."
  answer_sources:
  - "Windows Event ID 4624"
  - "Windows Event ID 4625"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Zeek conn.log"
  - "Cloud VM instance authentication logs"
  - "Cloud management plane logs"
  - "Identity and Access Management (IAM) logs"
  - "Geolocation databases"
  range: "last 90 days"
  queries:
  - "pseudocode": "CLUSTER historical login data (user, geo, time) using DBSCAN | ON new_login, CHECK if it belongs to a cluster | IF login is an outlier (noise point), ALERT"
- question: "Following a direct VM access, did the machine attempt to resolve a dynamic DNS domain?"
  context: "Adversaries often use dynamic DNS (DDNS) providers for their C2 infrastructure because it allows them to quickly change IP addresses while keeping the same domain name, making blocking difficult. A legitimate server in a corporate cloud environment has little reason to contact a DDNS provider. Therefore, a DNS query for a DDNS domain shortly after a direct login is a highly suspicious indicator of a C2 callback."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Windows Event ID 5156"
  - "Windows Event ID 4624"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Network sensors capturing VPC/VNet flow data"
  - "Egress network gateways"
  - "Cloud VM network kernel logs"
  - "DNS server logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "SEARCH direct_vm_access_events | JOIN vm_id, time | SEARCH dns_queries within 60m of access_time | WHERE domain IN dynamic_dns_provider_list AND domain NOT IN allow_list | ALERT"
- question: "Did the hourly outbound data transfer from a VM exceed its own historical 99th percentile baseline following a direct access event?"
  context: "This question aims to detect data exfiltration using a simple, robust statistical threshold. By establishing a baseline of normal peak traffic for each individual VM, this method accounts for the fact that different servers have different traffic patterns. A breach of the 99th percentile, meaning traffic is higher than it has been 99% of the time in the last month, especially right after a direct login, is a strong signal that an unusually large amount of data is leaving the machine."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Windows Event ID 5156"
  - "Windows Event ID 4624"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Network sensors capturing VPC/VNet flow data"
  - "Egress network gateways"
  - "Cloud VM network kernel logs"
  - "DNS server logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "FOR each VM, CALCULATE 99th percentile of hourly outbound_bytes over 30 days | ON direct_vm_access_event, CHECK outbound_bytes in next hour | IF outbound_bytes > 99th_percentile_baseline, ALERT"
- question: "Did the overall network behavior of a VM become anomalous across multiple metrics after a direct access event?"
  context: "This question uses a sophisticated approach to detect deviations in a VM's network 'personality.' A multivariate model learns the complex relationships between different network metrics (e.g., how byte counts normally correlate with connection counts). An adversary's activity, such as scanning followed by data exfiltration, will likely disrupt these learned relationships, even if no single metric is extreme. An anomaly score from this model after a direct login indicates a significant and suspicious shift in the VM's network behavior profile."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Windows Event ID 5156"
  - "Windows Event ID 4624"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Network sensors capturing VPC/VNet flow data"
  - "Egress network gateways"
  - "Cloud VM network kernel logs"
  - "DNS server logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "FOR each VM, TRAIN multivariate model on (bytes_sent, conn_count, unique_ports) per hour | ON direct_vm_access_event, feed subsequent metrics to model | IF model flags sequence as anomalous, ALERT"
- question: "Was there a sequence of direct access, followed by discovery commands, and then an attempt to connect to another internal machine on an admin port?"
  context: "This question looks for the classic 'land and expand' pattern of lateral movement. An adversary gains access, runs commands to understand the environment and find other targets ('whoami', 'ipconfig'), and then uses that information to try to move to another machine using protocols like RDP or SSH. Detecting this entire sequence of events within a short time frame on a single host is a very high-confidence indicator of an active lateral movement attempt."
  answer_sources:
  - "Windows Event ID 4624"
  - "Windows Event ID 4688"
  - "Windows Event ID 4648"
  - "Zeek conn.log"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Cloud VM instance logs (Security and System)"
  - "Cloud management plane logs"
  - "Network sensors monitoring east-west traffic"
  - "Domain Controller authentication logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "DEFINE sequence: direct_access -> 2+ discovery_commands -> outbound_admin_port_connection to internal_ip | SEARCH for sequence on single VM within 60 minutes | ALERT on match"
- question: "Did a user execute an unusually high number of discovery commands for their role shortly after a direct VM login?"
  context: "While system administrators run discovery commands, they typically do so in a limited, targeted way. An adversary, being unfamiliar with the network, will often run a large battery of such commands to orient themselves. By baselining the normal command count for different user roles (e.g., a developer rarely needs to run 'nltest'), this question can flag sessions with excessive reconnaissance activity that is abnormal for that specific user's job function."
  answer_sources:
  - "Windows Event ID 4624"
  - "Windows Event ID 4688"
  - "Windows Event ID 4648"
  - "Zeek conn.log"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Cloud VM instance logs (Security and System)"
  - "Cloud management plane logs"
  - "Network sensors monitoring east-west traffic"
  - "Domain Controller authentication logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "FOR each user_role, BASELINE count of discovery commands in first 60m of session | ON new_login, COUNT discovery commands in first 60m | IF count > 95th_percentile for user_role, ALERT"
- question: "Did the sequence of actions taken by a user after a direct login deviate from patterns seen in normal administrative sessions?"
  context: "This question uses advanced machine learning to understand the 'grammar' of a user session. A model like an LSTM autoencoder learns the typical order and type of events in a legitimate session (e.g., login, run specific script, connect to database). An adversary's session, which might involve different commands in a different order (e.g., login, run discovery, connect to external C2), will not match the learned patterns. A high reconstruction error from the model indicates the session sequence is 'ungrammatical' and therefore highly suspicious."
  answer_sources:
  - "Windows Event ID 4624"
  - "Windows Event ID 4688"
  - "Windows Event ID 4648"
  - "Zeek conn.log"
  - "AWS CloudTrail"
  - "Azure Activity Logs"
  - "Cloud VM instance logs (Security and System)"
  - "Cloud management plane logs"
  - "Network sensors monitoring east-west traffic"
  - "Domain Controller authentication logs"
  range: "last 90 days"
  queries:
  - "pseudocode": "TRAIN LSTM autoencoder on normal event sequences (login, process, net_conn) | ON new_session, feed event sequence to model | IF reconstruction_error is high, ALERT"