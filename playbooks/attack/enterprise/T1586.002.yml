name: T1586.002: Email Accounts
id: e1b7c3d0-a4f1-4e9a-8b6c-2f7d1e8a9b0c
description: This playbook helps investigate whether an adversary possesses compromised email accounts that could be used to target the organization. It focuses on detecting threats by matching inbound email data (sender, links, attachments) against threat intelligence; identifying phishing characteristics like dynamic DNS links and high-risk attachments; flagging unusual sending patterns like high-volume emails from new senders to specific groups; and correlating failed authentication attempts with successful logins for accounts known to be exposed in public data breaches.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are inbound emails, links, or attachments matching known indicators of compromise from threat intelligence feeds?
    context: This question aims to identify direct threats by cross-referencing components of incoming emails—such as the sender's address, embedded URLs, and attachment file hashes—with high-confidence threat intelligence feeds. A match indicates that a known malicious or compromised entity is attempting to communicate with the organization, which requires immediate attention and is a primary indicator of a targeted attack.
    answer_sources:
      - Zeek smtp.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Perimeter email gateway (SMTP relay)
      - Network security monitoring sensor tap points
      - DNS resolvers
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH smtp.log, dns.log, http.log, files.log | JOIN (sender_address, domain, file_hash) WITH threat_intelligence_feed | WHERE match_found | ALERT
  - question: Are low-reputation sender domains, which are new or have low sending volume, sending high-risk attachments?
    context: This question helps uncover suspicious activity from previously unknown or low-activity senders. A low reputation score, calculated based on the sender domain's age and traffic volume within the network, combined with the presence of risky attachment types (like executables or archives), can signal a spear-phishing attempt or the initial stages of a malware delivery campaign from a newly established malicious domain.
    answer_sources:
      - Zeek smtp.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Perimeter email gateway (SMTP relay)
      - Network security monitoring sensor tap points
      - DNS resolvers
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH smtp.log and files.log | CALCULATE sender_reputation (first_seen, volume, recipients) | FILTER reputation_score < 25th_percentile AND attachment_type IN (executable, archive) | ALERT
  - question: Can inbound emails be classified as malicious based on a machine learning model trained on features like sender TLD, subject content, URL-to-domain ratio, and attachment type?
    context: This question leverages a machine learning model to proactively identify malicious emails that may not be caught by signature-based detection. By analyzing a combination of features extracted from email metadata and content, the model can learn complex patterns associated with phishing and malware campaigns, providing a more sophisticated and adaptive layer of defense that can score and flag suspicious emails with high confidence.
    answer_sources:
      - Zeek smtp.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Perimeter email gateway (SMTP relay)
      - Network security monitoring sensor tap points
      - DNS resolvers
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: PIPELINE Zeek_logs -> FEATURE_EXTRACTION (TLD, subject_length, URL_ratio, MIME_type) | PREDICT with classification_model | WHERE prediction == 'malicious' AND confidence > 0.9 | ALERT
  - question: Do any inbound emails contain links to dynamic DNS providers or URL shorteners, or include high-risk attachment types like ISO, VHD, or LNK files?
    context: This question seeks to identify common phishing techniques by searching for structural red flags in emails. Adversaries often use dynamic DNS and URL shorteners to obscure malicious destinations, while disk image files (.iso, .vhd) and shortcut files (.lnk) are increasingly used to bypass email gateway scanners and deliver malware. Detecting these patterns provides an early warning of a potential phishing attack.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Zeek smtp.log
      - Perimeter email gateway
      - DNS resolvers
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH dns.log, http.log, files.log | FILTER (host MATCHES regex_ddns OR host MATCHES regex_shorteners) OR (mime_type IN high_risk_types OR filename ENDSWITH high_risk_extensions) | ALERT
  - question: Are there emails containing links to domains with unusually high entropy, suggesting they may be algorithmically generated?
    context: This question aims to detect domain generation algorithms (DGAs), a technique used by malware to create a large number of random-looking domain names for command and control. By calculating the Shannon entropy (a measure of randomness) of domain names in email links and comparing it to a baseline of normal domains, we can flag domains that are statistical outliers. A high entropy score is a strong indicator of a potentially malicious, auto-generated domain.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Zeek smtp.log
      - Perimeter email gateway
      - DNS resolvers
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH dns.log, http.log | CALCULATE entropy for each hostname | COMPARE entropy against baseline_distribution | WHERE entropy > 95th_percentile | ALERT
  - question: Is there an anomalous spike in the daily volume of a specific high-risk attachment type, such as ISO or ZIP files?
    context: This question is designed to detect mass-mailing campaigns that leverage a specific type of malicious attachment. By modeling the normal daily volume of high-risk attachment types and using a time series forecast to predict expected counts, we can identify significant deviations. A sudden, unexpected surge in the volume of a particular file type (e.g., ISO images) strongly suggests a coordinated attack is underway.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Zeek smtp.log
      - Perimeter email gateway
      - DNS resolvers
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: AGGREGATE daily count of high_risk_mime_types from files.log | FORECAST expected_count with SARIMA_model | IF observed_count > predicted_upper_bound | ALERT
  - question: Has a new sender domain, not seen in the last 60 days, sent a high volume of emails to multiple internal recipients in a short time frame?
    context: This question focuses on identifying a classic 'blast' attack from a new source. Adversaries often register new domains for their campaigns. A domain that has no history with the organization and suddenly sends emails to a significant number of employees within an hour is highly suspicious. This rule helps detect the initial wave of a phishing or malware distribution campaign.
    answer_sources:
      - Zeek conn.log
      - Zeek smtp.log
      - Network security monitoring sensor tap points
      - Perimeter email gateway logs
      - Directory services (for recipient group enrichment)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH smtp.log | IDENTIFY sender_domains not seen in last 60 days | IF new_domain sends to > 10 recipients in 1 hour | ALERT
  - question: Is an existing external sender domain exhibiting a sudden and significant spike in email volume and number of recipients?
    context: This question is designed to detect when a legitimate, but possibly compromised, sender account is used for a malicious campaign. By establishing a statistical baseline of normal sending behavior (volume and recipient count) for each external domain, we can detect anomalous spikes. An alert for activity exceeding several standard deviations from the norm can indicate that an external partner's email account has been hijacked for a large-scale phishing attack.
    answer_sources:
      - Zeek conn.log
      - Zeek smtp.log
      - Network security monitoring sensor tap points
      - Perimeter email gateway logs
      - Directory services (for recipient group enrichment)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each sender_domain, CALCULATE 30-day moving average and std_dev for hourly_volume and unique_recipients | IF current_hourly_volume > (average + 3*std_dev) AND current_recipient_count spikes | ALERT
  - question: Is a new external sender sending a targeted email to a specific, well-defined group of internal employees (e.g., the entire finance team)?
    context: This question aims to detect highly targeted spear-phishing attacks. By using graph analysis to identify 'communities' of employees who frequently communicate (like departments), we can spot suspicious emails from unknown senders that are precisely aimed at one of these groups. An external email targeting a high percentage of a single internal community is a strong indicator of a well-researched spear-phishing attempt.
    answer_sources:
      - Zeek conn.log
      - Zeek smtp.log
      - Network security monitoring sensor tap points
      - Perimeter email gateway logs
      - Directory services (for recipient group enrichment)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BUILD sender-recipient graph from smtp.log | IDENTIFY internal communities using Louvain algorithm | FOR new emails from new senders, CALCULATE recipient overlap with communities | IF overlap > 80% for a single community | ALERT
  - question: Has a successful user login occurred from an external IP address immediately after a series of failed login attempts from that same IP, especially if the user's credentials are known to be publicly exposed?
    context: This question helps to identify a successful brute-force or password-spraying attack. A pattern of multiple failed authentications followed by a success from the same source IP is a classic sign of an attacker guessing passwords. Enriching this finding by checking against a database of breached credentials adds critical context, significantly increasing the likelihood that the successful login was malicious.
    answer_sources:
      - Windows Event ID 4625
      - Windows Event ID 4624
      - Zeek conn.log
      - Internet-facing authentication servers (e.g., ADFS, Exchange OWA)
      - VPN concentrators
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for >10 failed logins (EventID 4625) for a user from an IP in 5 mins | FOLLOWED BY a successful login (EventID 4624) for same user/IP | JOIN with breached_credential_database | IF user is in breach_db | ALERT
  - question: Is any single external IP address responsible for an anomalously high ratio of failed-to-successful login attempts compared to the baseline?
    context: This question seeks to identify malicious IPs engaged in credential-based attacks without relying on a fixed threshold. By calculating a failed logon ratio for each source IP and comparing it to a statistical baseline of all external IPs, we can spot outliers. An IP with a failure ratio in the 99th percentile is behaving abnormally and is likely attempting a password-spraying or brute-force attack across multiple accounts.
    answer_sources:
      - Windows Event ID 4625
      - Windows Event ID 4624
      - Zeek conn.log
      - Internet-facing authentication servers (e.g., ADFS, Exchange OWA)
      - VPN concentrators
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each source_IP in 5-min windows, CALCULATE failure_ratio = failed_logins / total_logins | COMPARE failure_ratio to baseline_distribution | IF failure_ratio > 99th_percentile | ALERT
  - question: Has a user successfully logged in with characteristics (e.g., time, location, ASN) that are anomalous compared to their established historical behavior?
    context: This question aims to detect account compromise by modeling what constitutes 'normal' login behavior for each individual user. An unsupervised machine learning model can learn a user's typical login times, days, geographic locations (via ASN), and logon types. A new successful login that deviates significantly from this learned profile (i.e., receives a high anomaly score) is highly suspicious and could indicate that the user's credentials have been compromised, even if the login did not follow an obvious brute-force pattern.
    answer_sources:
      - Windows Event ID 4625
      - Windows Event ID 4624
      - Zeek conn.log
      - Internet-facing authentication servers (e.g., ADFS, Exchange OWA)
      - VPN concentrators
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new successful login (EventID 4624), EXTRACT features (time, day, ASN, etc.) | SCORE with user's Isolation Forest model | IF anomaly_score is high | ALERT