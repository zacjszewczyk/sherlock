name: T1087.003: Email Account
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps to determine if an adversary is actively discovering email accounts or global address lists. It focuses on detecting the execution of known enumeration tools, suspicious PowerShell activity (e.g., use of 'Get-GlobalAddressList'), unusual LDAP queries designed for bulk user enumeration, anomalous network traffic to directory and mail services, and network connections from unauthorized processes to these services.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a process been executed whose file hash or original name matches a known email account enumeration tool?
    context: This question aims to identify the most direct evidence of an adversary using known malicious tools, such as MailSniper or ADFind, for email discovery. Matching against threat intelligence feeds provides a high-fidelity signal that a malicious binary is present and has been executed on an endpoint.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers, Exchange Servers, Administrative Workstations, User Endpoints
    range: last 90 days
    queries:
      - pseudocode: SEARCH process_creation_logs WHERE (file_hash IN known_enumeration_tool_hashes OR file_name IN known_enumeration_tool_names)
  - question: Has a scripting engine (like PowerShell or CScript) launched a child process with a highly randomized or obfuscated file name?
    context: Adversaries often obfuscate the names of their scripts or temporary executables to evade simple signature-based detection. High character entropy in a filename, especially for a process spawned by a scripting interpreter, is a strong indicator of obfuscation and potential malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers, Exchange Servers, Administrative Workstations, User Endpoints
    range: last 90 days
    queries:
      - pseudocode: SEARCH process_creation_logs WHERE parent_process IN ('powershell.exe', 'cscript.exe') AND calculate_entropy(process_name) > 3.5
  - question: Has a newly executed process been classified by a machine learning model as a likely malicious enumeration tool?
    context: This question leverages a machine learning model to move beyond simple indicators and identify novel or unknown enumeration tools based on their behavioral characteristics. By analyzing features like the parent process, user context, and command-line properties, the model can flag suspicious processes that don't match any known signatures.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers, Exchange Servers, Administrative Workstations, User Endpoints
    range: last 90 days
    queries:
      - pseudocode: SEARCH process_creation_logs | score_with_ml_model(features) | WHERE score > 0.9
  - question: Have any PowerShell commands or script blocks been executed that contain tell-tale cmdlets or strings for querying email accounts or address lists?
    context: This question looks for the specific tools and commands an adversary would use within PowerShell to interact with Active Directory or Exchange to gather email addresses. Searching for literal strings like 'Get-GlobalAddressList', 'Get-Recipient', or LDAP filter patterns provides concrete evidence of reconnaissance activity.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers, Exchange Servers, Microsoft 365 Tenant, User Endpoints
    range: last 90 days
    queries:
      - pseudocode: SEARCH (powershell_script_logs OR command_line_logs) WHERE text MATCHES_REGEX ('Get-GlobalAddressList|Get-Recipient|Get-Mailbox|objectCategory=person')
  - question: Has a user executed a rare or novel PowerShell cmdlet related to email/directory discovery that deviates from their normal activity baseline?
    context: This question aims to detect anomalous behavior by focusing on what is unusual for a specific user. An administrator might occasionally use discovery cmdlets, but a typical user executing 'Get-GlobalAddressList' for the first time is highly suspicious. This approach helps reduce false positives from legitimate administrative activity.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers, Exchange Servers, Microsoft 365 Tenant, User Endpoints
    range: last 90 days
    queries:
      - pseudocode: SEARCH powershell_cmdlet_logs | COMPARE to_user_baseline | WHERE cmdlet_is_rare_for_user (rarity > 99th_percentile)
  - question: Has a user's PowerShell activity been classified by a topic model as being related to reconnaissance?
    context: This question uses an unsupervised machine learning approach to categorize entire scripts based on their content. Instead of looking for a single keyword, topic modeling can identify that a script's overall purpose is reconnaissance, even if it uses varied or obfuscated commands. This is useful for detecting sophisticated adversaries who avoid obvious cmdlet names.
    answer_sources:
      - Windows Event ID 4104
      - Domain Controllers, Exchange Servers, Microsoft 365 Tenant, User Endpoints
    range: last 90 days
    queries:
      - pseudocode: SEARCH powershell_script_logs | classify_with_lda_model | WHERE topic == 'reconnaissance' AND is_anomalous_for_user
  - question: Have any LDAP search queries been observed containing filters designed for bulk enumeration of users or email accounts?
    context: This question targets a common method for querying Active Directory at a low level. Adversaries use specific LDAP filters to dump lists of all users or all objects with email addresses. Detecting these specific filter strings in network traffic or domain controller logs is a strong indicator of bulk account discovery.
    answer_sources:
      - Zeek ldap.log
      - Windows Event ID 1644
      - Domain Controllers, Network segments monitoring traffic to Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: SEARCH (ldap_logs OR windows_event_1644) WHERE ldap_filter MATCHES_REGEX ('(objectCategory=person)|(objectClass=user)|(mail=*)')
  - question: Has any single LDAP query returned a number of objects that is anomalously large compared to the historical average for the source IP?
    context: This question focuses on the result of an LDAP query, rather than the query itself. A query that returns thousands of user objects is characteristic of a bulk data dump. By comparing the number of returned objects to a baseline, this method can detect enumeration activity even if the query filter itself is not obviously malicious.
    answer_sources:
      - Zeek ldap.log
      - Domain Controllers, Network segments monitoring traffic to Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: SEARCH ldap_logs | for_each source_ip | IF returned_objects > (3 * standard_deviation_of_baseline) THEN ALERT
  - question: Has there been a sudden, anomalous spike in the volume of LDAP search requests from any single host?
    context: This question uses time-series analysis to detect abnormal patterns in LDAP query volume. An adversary attempting to discover accounts may issue a rapid burst of many queries in a short time. A time-series model can distinguish this burst from normal, periodic fluctuations in LDAP traffic, flagging it as a potential reconnaissance attempt.
    answer_sources:
      - Zeek ldap.log
      - Domain Controllers, Network segments monitoring traffic to Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: SEARCH ldap_logs | aggregate_by_host_per_minute | ANALYZE with_sarima_model | WHERE volume DEVIATES_FROM forecast
  - question: Has a single source IP address made an excessive number of connections to directory or mail services within a short time window?
    context: This question uses a simple but effective threshold to detect brute-force connection attempts or scans against directory and mail services. While legitimate servers might make many connections, a high volume from a single client endpoint is often indicative of an automated tool scanning for information or vulnerabilities.
    answer_sources:
      - Zeek conn.log
      - Zeek dce_rpc.log
      - Zeek ldap.log
      - Network traffic segments in front of Domain Controllers and Exchange/Mail servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH network_connection_logs | group_by source_ip, 5_minute_window | WHERE destination_port IN (389, 636, 135, 443) AND connection_count > 500
  - question: Has a source IP's hourly connection count to directory or mail services exceeded its statistically normal range?
    context: This question refines the simple threshold approach by using statistical methods (Inter-Quartile Range) to define 'excessive' on a per-host basis. This makes the detection more robust and adaptable, as it can identify outliers relative to each host's own normal behavior, reducing false positives from chatty but legitimate clients.
    answer_sources:
      - Zeek conn.log
      - Network traffic segments in front of Domain Controllers and Exchange/Mail servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH network_connection_logs | for_each source_ip | CALCULATE hourly_connection_baseline | IF current_hour_count > (Q3 + 1.5 * IQR) THEN ALERT
  - question: Have any network connections been observed that do not fit into established 'normal' traffic patterns or clusters?
    context: This question employs a clustering algorithm (DBSCAN) to define normal behavior in a multi-dimensional way, considering features like data volume and connection duration, not just connection counts. Connections that don't belong to any dense, well-defined cluster are flagged as noise or outliers, representing potentially novel or stealthy reconnaissance techniques that other methods might miss.
    answer_sources:
      - Zeek conn.log
      - Network traffic segments in front of Domain Controllers and Exchange/Mail servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH network_connection_logs | extract_features (bytes, duration, service) | CLUSTER with_dbscan | WHERE point_is_noise
  - question: Has an unauthorized or non-allowlisted process initiated a network connection to a directory or mail service?
    context: This question seeks to identify malicious activity by focusing on the source process of network connections. While network traffic to a domain controller is normal, it's highly suspicious if it originates from a process other than an approved application like Outlook or Teams. Correlating process creation and network filtering logs allows for the detection of unauthorized tools communicating with sensitive services.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - User Endpoints, Application Servers, and network choke points monitoring traffic to directory/mail servers
    range: last 90 days
    queries:
      - pseudocode: JOIN process_creation_logs(4688), network_connection_logs(5156) | WHERE destination_port IN (135, 389, 443, 636) AND process_name NOT_IN allowlist
  - question: Has a network connection to a directory or mail service been initiated by an extremely rare process, especially one running from a temporary or user-writable directory?
    context: This question leverages the 'wisdom of the crowd' by identifying processes that are statistical rarities across the entire enterprise. A process that very few other hosts use to connect to Active Directory is inherently suspicious. The suspicion is heightened if that process is running from a non-standard location like a user's Temp folder, a common location for malware.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - User Endpoints, Application Servers, and network choke points monitoring traffic to directory/mail servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH process_network_connections | CALCULATE process_prevalence | WHERE prevalence < 1st_percentile AND process_path MATCHES ('C:\\Users\\*', 'C:\\Temp\\*')
  - question: Has a machine learning model classified a process-network connection event as an outlier compared to a baseline of legitimate activity?
    context: This question uses a one-class classification model, which is specifically designed for anomaly detection. By training the model exclusively on 'good' or 'normal' process-network connection events, it learns to build a tight boundary around that normal behavior. Any event that falls outside this boundary is flagged as an anomaly, providing a powerful way to detect novel attack techniques.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - User Endpoints, Application Servers, and network choke points monitoring traffic to directory/mail servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH process_network_connections | score_with_ocsvm_model | WHERE event_is_outlier