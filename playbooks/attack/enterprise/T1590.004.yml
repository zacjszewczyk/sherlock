name: T1590.004: Network Topology
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: >-
  This playbook helps determine if an adversary is performing external network reconnaissance to map an organization's network topology. It focuses on identifying malicious scanning activity by analyzing various indicators. These include high-volume connection attempts from IPs on threat intelligence feeds, network traffic containing signatures of reconnaissance tools (e.g., specific User-Agents or TCP flags), statistically anomalous scanning patterns such as horizontal (many hosts) or vertical (many ports) scans, low-and-slow connection attempts targeting sensitive ports from previously unseen sources, and sequential network sweeps across contiguous IP ranges.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are external source IPs known for malicious activity, such as scanning or being TOR exit nodes, attempting to connect to our network?
    context: This question aims to identify reconnaissance attempts from sources already flagged by threat intelligence. By correlating inbound connection attempts with lists of known malicious IPs (like scanners or TOR exit nodes), we can proactively detect threats. It's a high-fidelity indicator that an adversary is gathering information about our network. Maintaining an allowlist for known good scanners and partners is crucial to minimize false positives.
    answer_sources:
      - Zeek conn.log
      - Zeek intel.log
      - Perimeter firewalls
      - Internet gateways
      - Cloud provider network flow logs (e.g., AWS VPC Flow Logs)
      - Threat Intelligence Platform integration points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each connection in conn.log, CHECK if source_ip exists in threat_intelligence_feed. IF match found, ALERT. IGNORE if source_ip is in trusted_allowlist.
  - question: Is any single external IP sending an anomalously high volume of connection attempts compared to its own historical baseline?
    context: This question seeks to identify scanning activity by detecting statistical outliers in connection volume. Adversaries often use a single IP to perform broad scans, resulting in a spike in connection attempts. By comparing current activity against a 30-day baseline for each specific IP, we can spot deviations from normal behavior that indicate reconnaissance, even if the IP is not on a high-confidence threat list.
    answer_sources:
      - Zeek conn.log
      - Zeek intel.log
      - Perimeter firewalls
      - Internet gateways
      - Cloud provider network flow logs (e.g., AWS VPC Flow Logs)
      - Threat Intelligence Platform integration points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each source_ip, CALCULATE hourly_connection_mean and hourly_connection_std_dev over last 30 days. IF current_hour_connections > (hourly_mean + 3 * hourly_std_dev), ALERT.
  - question: Can we use machine learning to predict if an external IP is a scanner based on its network and behavioral characteristics?
    context: This question leverages machine learning to build a predictive model for identifying scanners. By training a model on features like IP reputation, ASN, origin, and connection patterns, we can create a sophisticated detection mechanism that goes beyond simple thresholds. This allows for a more nuanced 'scanner probability' score, enabling us to alert on activity that has a high likelihood of being reconnaissance, even if it employs evasive tactics.
    answer_sources:
      - Zeek conn.log
      - Zeek intel.log
      - Perimeter firewalls
      - Internet gateways
      - Cloud provider network flow logs (e.g., AWS VPC Flow Logs)
      - Threat Intelligence Platform integration points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each source_ip, EXTRACT features (reputation, ASN, country, frequency). INPUT features into trained classification model. IF model_output_probability > threshold, ALERT.
  - question: Is inbound network traffic exhibiting signatures of common reconnaissance tools, such as specific User-Agent strings or anomalous TCP flag combinations?
    context: This question focuses on finding direct evidence of scanning tools. Many reconnaissance tools (like Nmap, ZMap) leave fingerprints in the traffic they generate, such as unique User-Agent strings in HTTP requests or unusual TCP flag combinations (Xmas, NULL, FIN scans). Detecting these signatures is a strong indicator that an automated tool is being used to map the network.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek weird.log
      - External-facing web servers
      - Application load balancers
      - DMZ
      - Web Application Firewalls (WAFs)
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH http.log for user_agents matching known scanner patterns (e.g., 'Nmap', 'ZMap'). SEARCH conn.log for TCP flags matching 'Xmas', 'NULL', or 'FIN' scan combinations. ALERT on match.
  - question: Are User-Agent strings in inbound HTTP requests statistically unusual, suggesting they are either overly simple or randomized for evasion?
    context: This question uses information theory to detect anomalous User-Agent strings. Legitimate browsers have a typical complexity. User-Agents that are too simple (low entropy) or too random (high entropy) often indicate an automated tool. Low entropy can point to simple scripts, while high entropy can suggest an adversary is trying to evade signature-based detection by randomizing the User-Agent.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek weird.log
      - External-facing web servers
      - Application load balancers
      - DMZ
      - Web Application Firewalls (WAFs)
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each user_agent in http.log, CALCULATE Shannon entropy. ESTABLISH baseline entropy range. IF entropy is in bottom 5th or top 5th percentile, ALERT.
  - question: Is there a statistically significant spike in the frequency of scan-related TCP flag combinations (NULL, FIN, Xmas) over time?
    context: This question aims to detect coordinated scanning events by monitoring the frequency of specific TCP scan types over time. Instead of looking at individual connections, a time-series model (like ARIMA) can identify when the overall volume of these suspicious flag combinations deviates from the normal, forecasted baseline. This can reveal large-scale or coordinated reconnaissance campaigns.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek weird.log
      - External-facing web servers
      - Application load balancers
      - DMZ
      - Web Application Firewalls (WAFs)
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL frequency of NULL, FIN, Xmas scans per minute using ARIMA. FORECAST expected count. IF observed_count significantly deviates from forecast, ALERT.
  - question: Is a single external source connecting to an excessive number of unique destination hosts (horizontal scan) or unique destination ports (vertical scan) in a short time frame?
    context: This question identifies two classic scanning patterns. A horizontal scan (one source, many destinations) seeks to discover live hosts on a network. A vertical scan (one source, one destination, many ports) aims to find open services on a single host. Using simple, tuned thresholds for these activities in a short window is a straightforward and effective way to detect basic scanning.
    answer_sources:
      - Zeek conn.log
      - DMZ subnets
      - Public IP address ranges
      - Edge routers
      - Cloud security groups and network ACLs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: IN a 1-minute window, IF source_ip connects to >100 unique destination_ips, ALERT (Horizontal Scan). IF source_ip connects to >50 unique destination_ports on one host, ALERT (Vertical Scan).
  - question: Is any external source's scanning behavior (number of hosts or ports contacted) in the top percentile compared to all other external traffic?
    context: This question uses a dynamic, population-based approach to detect scanning. Instead of fixed thresholds, it compares the activity of each source IP against the behavior of all other sources. An IP whose connection diversity (number of hosts or ports) is in the 99th percentile is statistically anomalous and highly likely to be a scanner, allowing the detection threshold to adapt to overall traffic patterns.
    answer_sources:
      - Zeek conn.log
      - DMZ subnets
      - Public IP address ranges
      - Edge routers
      - Cloud security groups and network ACLs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each 5-minute window, CALCULATE 99th percentile for distinct_dest_ips and distinct_dest_ports across all sources. IF any source_ip exceeds either percentile, ALERT.
  - question: Can we use unsupervised machine learning to automatically group and identify source IPs that are behaving like scanners?
    context: This question applies unsupervised clustering (like DBSCAN) to automatically discover groups of IPs exhibiting similar, anomalous behavior. By clustering IPs based on features like the number of distinct hosts/ports contacted, the algorithm can identify scanning activity without needing pre-defined rules or thresholds. This is powerful for discovering novel or unusual scanning patterns.
    answer_sources:
      - Zeek conn.log
      - DMZ subnets
      - Public IP address ranges
      - Edge routers
      - Cloud security groups and network ACLs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY DBSCAN clustering on source_ips over a 10-minute window using features (distinct_dest_ips, distinct_dest_ports, sum_duration). LABEL and ALERT on anomalous clusters.
  - question: Are any external IPs attempting to connect to high-value, non-public ports on our network?
    context: This question provides high-fidelity alerting by focusing on adversary targets. Critical or sensitive ports (like RDP, SSH, WinRM) should not be exposed to the public internet. By creating a watchlist of these ports, any external connection attempt can be treated as a high-priority incident, as it strongly suggests targeted reconnaissance or an attempted intrusion.
    answer_sources:
      - Zeek conn.log
      - VPN concentrators
      - Remote access gateways
      - Servers hosting sensitive applications
      - Management interfaces of network appliances
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CREATE watchlist of critical_ports. FOR each connection from an external_ip, IF destination_port is in critical_ports_watchlist, GENERATE high-priority ALERT.
  - question: Is a source IP making infrequent but persistent connection attempts, characteristic of 'low and slow' scanning?
    context: This question is designed to detect evasive, 'low and slow' scanning techniques. Adversaries may spread out connection attempts over a long period to avoid triggering volume-based alerts. By calculating the inter-arrival time between connections, we can identify sources that are suspiciously persistent but infrequent, a key indicator of stealthy reconnaissance.
    answer_sources:
      - Zeek conn.log
      - VPN concentrators
      - Remote access gateways
      - Servers hosting sensitive applications
      - Management interfaces of network appliances
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each source_ip, CALCULATE average inter-arrival time between connections. IF avg_inter_arrival_time > 95th_percentile of all sources AND total_connections is low, ALERT.
  - question: Is there a subtle, long-term increase in the number of unique sources trying to connect to our critical ports?
    context: This question uses time-series analysis to detect subtle, long-term reconnaissance campaigns against high-value assets. A gradual increase in the number of unique IPs probing a critical port over days or weeks might be missed by other methods. A model like Seasonal-Hybrid ESD can detect these slow-moving trends, indicating sustained interest from one or more adversaries.
    answer_sources:
      - Zeek conn.log
      - VPN concentrators
      - Remote access gateways
      - Servers hosting sensitive applications
      - Management interfaces of network appliances
      - Domain Controllers
    range: last 90 days
    queries:
      - technology anomoly-detection-model
        query: FOR each high-value_port, APPLY time-series model (e.g., Seasonal-Hybrid ESD) to hourly_count of unique_source_ips. IF anomalous increase is detected, ALERT.
  - question: Is a single source IP connecting to destination IPs in a sequential order, indicating a network sweep?
    context: This question looks for a very specific and common reconnaissance pattern a network sweep. Adversaries often iterate through a contiguous IP range (e.g., 10.0.0.1, 10.0.0.2, 10.0.0.3) to find live hosts. A stateful rule that tracks destination IPs from a single source can easily detect this linear behavior and generate a high-confidence alert.
    answer_sources:
      - Zeek conn.log
      - Zeek icmp.log
      - Zeek weird.log
      - Organization's allocated CIDR blocks
      - Edge router logs
      - Network Address Translation (NAT) logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRACK destination_ips for each source_ip. IF source connects to >10 sequentially increasing destination_ips in a 1-minute window, ALERT.
  - question: Does a source IP have an abnormally high ratio of failed or rejected connections compared to successful ones?
    context: This question infers intent from connection outcomes. A legitimate client usually knows what it wants to connect to and has a high success rate. A scanner, however, is probing blindly and will generate a large number of failed or rejected connections. A source IP with a failure ratio over 90% is almost certainly not engaging in legitimate communication and is likely scanning for live hosts or open ports.
    answer_sources:
      - Zeek conn.log
      - Zeek icmp.log
      - Zeek weird.log
      - Organization's allocated CIDR blocks
      - Edge router logs
      - Network Address Translation (NAT) logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each source_ip over 10 minutes, CALCULATE ratio of (failed_connections / total_connections). IF ratio > 0.90, ALERT.
  - question: Can we model the sequence of IP addresses contacted by a source to predict if it's performing a sequential sweep?
    context: This question applies a Markov Chain model to detect non-random, sequential scanning. For normal traffic, the probability of a source connecting to IP `N` and then immediately to IP `N+1` is extremely low. A Markov model can quantify this transition probability. If the model shows a high probability of transitioning to an adjacent IP address, it provides strong mathematical evidence of a network sweep, allowing for highly accurate detection.
    answer_sources:
      - Zeek conn.log
      - Zeek icmp.log
      - Zeek weird.log
      - Organization's allocated CIDR blocks
      - Edge router logs
      - Network Address Translation (NAT) logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL transitions between destination_ips for a source as a Markov Chain. CALCULATE P(dest_ip_N+1 | dest_ip_N). IF this probability is high for adjacent IPs, ALERT.