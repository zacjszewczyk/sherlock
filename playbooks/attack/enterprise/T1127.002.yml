name: "T1127.002: ClickOnce"
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: "This playbook helps investigate whether an adversary is using ClickOnce applications for defense evasion. It focuses on detecting suspicious network downloads of ClickOnce files (.application, .appref-ms), anomalous process executions related to the ClickOnce framework (rundll32.exe with dfshim.dll, or dfsvc.exe spawning unusual children), temporal correlation between untrusted downloads and subsequent execution, and the use of ClickOnce for persistence by placing .appref-ms files in user Startup folders."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
investigative_questions:
  - question: "Are ClickOnce application downloads originating from or associated with known malicious indicators?"
    context: "This question aims to detect threats by correlating network and file activity related to ClickOnce files (.application, .appref-ms) with threat intelligence. A match on a URL, domain, IP address, or file hash against a blocklist indicates a high probability of malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek files.log"
      - "User Workstations"
      - "Internet Gateway/Proxy Servers"
      - "DNS Resolvers"
      - "SIEM/Threat Intelligence Platform"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH network_logs (http, dns) and file_logs
          WHERE file_extension is '.application' or '.appref-ms'
          JOIN logs on client_ip and timestamp
          LOOKUP requested_domain, server_ip, file_hash against threat_intelligence_feed
          IF match_found
            ALERT
  - question: "Are ClickOnce applications being downloaded from high-risk domains (e.g., newly registered, unpopular, or rarely seen)?"
    context: "This question focuses on proactively identifying suspicious domains hosting ClickOnce applications, even if they are not yet on a blocklist. By scoring domains based on age, popularity (Tranco rank), and internal request frequency, analysts can flag outliers that are more likely to be malicious."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek http.log"
      - "User Workstations"
      - "Internet Gateway/Proxy Servers"
      - "DNS Resolvers"
      - "SIEM/Threat Intelligence Platform"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH http_logs for downloads of '.application' or '.appref-ms'
          FOR each source_domain
            ENRICH with domain_age, tranco_rank, internal_first_seen, internal_request_count
            CALCULATE risk_score (higher for new, unpopular, rare domains)
            IF risk_score > 99th_percentile_threshold
              ALERT
  - question: "Can a machine learning model identify malicious ClickOnce download events based on their network characteristics?"
    context: "This question explores an advanced, predictive approach. By training a supervised classification model on features like URL length, URL entropy, TLD, domain age, and domain popularity, it can learn to distinguish between benign and malicious downloads in real-time, catching novel threats that other methods might miss."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "User Workstations"
      - "Internet Gateway/Proxy Servers"
      - "DNS Resolvers"
      - "SIEM/Threat Intelligence Platform"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each ClickOnce download event
            EXTRACT features (url_length, url_entropy, domain_age, etc.)
            APPLY pre-trained_classification_model
            IF model_prediction is 'malicious' and confidence > 0.9
              ALERT
  - question: "Is 'rundll32.exe' being used to execute a ClickOnce application via 'dfshim.dll' and 'ShOpenVerbApplication'?"
    context: "This question targets a very specific and high-fidelity indicator of ClickOnce execution. Observing this exact command-line pattern is a strong signal that a ClickOnce application has been launched, and it warrants immediate investigation as it is a known vector for malware delivery."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Terminal Servers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH process_creation_events (EventID 4688)
          WHERE process_name is 'rundll32.exe'
            AND command_line contains 'dfshim.dll'
            AND command_line contains 'ShOpenVerbApplication'
          ALERT on any match
  - question: "Is a ClickOnce application being launched by an unusual parent process?"
    context: "This question adds context to the execution event by examining the parent process. While some parent processes are normal for this activity, a ClickOnce launch originating from an unexpected source, such as an Office application (winword.exe) or a script host (powershell.exe), is highly suspicious and could indicate a phishing or exploitation chain."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Terminal Servers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          DEFINE baseline_parent_processes for 'rundll32.exe dfshim.dll' executions over 30 days
          SEARCH new process_creation_events for 'rundll32.exe dfshim.dll'
          EXTRACT parent_process_name
          IF parent_process_name_frequency < 5th_percentile of baseline
            ALERT
  - question: "Does the process execution chain leading to a ClickOnce launch deviate from established normal patterns?"
    context: "This question uses anomaly detection on the entire process tree leading to the ClickOnce execution. Malicious activity often creates atypical process chains (e.g., Outlook.exe -> Winword.exe -> powershell.exe -> rundll32.exe). By clustering normal chains and flagging outliers, this method can detect sophisticated, multi-stage attacks."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Terminal Servers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each 'rundll32.exe dfshim.dll' execution
            RECONSTRUCT process_lineage (parent, grandparent, etc.)
            APPLY clustering_model to the lineage
            IF lineage is flagged as anomaly or new small cluster
              ALERT
  - question: "Has the ClickOnce service process ('dfsvc.exe') spawned any child processes that are not on the organizational allowlist?"
    context: "The 'dfsvc.exe' process is part of the ClickOnce framework and typically spawns a predictable set of child processes. This question aims to detect when a malicious ClickOnce application causes 'dfsvc.exe' to launch an unexpected or unauthorized process, such as a scripting engine (powershell.exe) or other LOLBAS, which is a strong indicator of compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Servers with .NET applications"
      - "Virtual Desktop Infrastructure (VDI) environments"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          DEFINE allowlist of legitimate child processes for 'dfsvc.exe' from a 30-day baseline
          SEARCH process_creation_events
          WHERE parent_process_name is 'dfsvc.exe'
            AND child_process_name is NOT in allowlist
          ALERT
  - question: "Are legitimate child processes of 'dfsvc.exe' being executed with unusually long or complex command-line arguments?"
    context: "Even if a child process is on an allowlist, attackers can abuse it by passing malicious commands or scripts as arguments. This question seeks to detect such abuse by baselining the normal command-line length and entropy (randomness) for each child process and alerting on significant deviations, which could indicate obfuscated payloads."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Servers with .NET applications"
      - "Virtual Desktop Infrastructure (VDI) environments"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each allowlisted child of 'dfsvc.exe'
            CALCULATE baseline for command_line_length and command_line_entropy
          FOR each new execution
            COMPARE command_line_length and entropy to baseline
            IF length or entropy > 98th_percentile
              ALERT
  - question: "Can an unsupervised machine learning model detect anomalous child process executions spawned by 'dfsvc.exe'?"
    context: "This question proposes using a model like Isolation Forest to automatically identify unusual child process activity from 'dfsvc.exe'. By learning the characteristics of normal behavior (command line length, special characters, process name), the model can flag any new execution that doesn't fit the established pattern, providing a robust way to catch novel techniques."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Servers with .NET applications"
      - "Virtual Desktop Infrastructure (VDI) environments"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          TRAIN Isolation Forest model on baseline features of 'dfsvc.exe' child processes
          FOR each new 'dfsvc.exe' child process
            EXTRACT features (cmd_line_length, special_char_count, etc.)
            SCORE with model
            IF anomaly_score is high
              ALERT
  - question: "Has a ClickOnce application been downloaded from a non-allowlisted domain and executed on a host within a short time window?"
    context: "This question links network activity with endpoint activity to create a high-fidelity alert. Observing a user downloading a ClickOnce file from an untrusted source, immediately followed by the corresponding ClickOnce execution process (dfsvc.exe or rundll32.exe) on their machine, strongly suggests a user was tricked into running a malicious application."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet Gateway/Proxy Servers"
      - "User Workstations"
      - "DNS Resolvers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          DEFINE allowlist of ClickOnce domains
          SEARCH http_logs for downloads of '.application' or '.appref-ms' from non-allowlisted domains
          CORRELATE with process_creation_events for 'dfsvc.exe' or 'rundll32.exe dfshim.dll'
          WHERE client_ip is the same AND time_difference < 2 minutes
          ALERT
  - question: "Are ClickOnce applications being sourced from servers that serve only a very small number of clients within the organization?"
    context: "Legitimate software is typically distributed from central servers that serve many clients. This question identifies suspicious downloads by looking for source servers that have a very small 'fan-out' (i.e., they are part of the 'long tail' of distribution). A server providing a ClickOnce file to only one or two users is much more likely to be part of a targeted attack."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet Gateway/Proxy Servers"
      - "User Workstations"
      - "DNS Resolvers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each server_ip hosting ClickOnce files
            COUNT distinct client_ips downloading from it over 90 days
          FOR each new download
            IF source_server_ip's client_count < 5th_percentile
              ALERT
  - question: "Has there been a statistically significant spike in the overall volume of ClickOnce application downloads across the environment?"
    context: "A sudden, unexpected increase in the number of ClickOnce downloads could signal a widespread phishing campaign. This question uses time-series analysis to model the normal rhythm of download activity and automatically flags any anomalous surge that exceeds the predicted upper confidence bound, which could indicate a coordinated attack."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet Gateway/Proxy Servers"
      - "User Workstations"
      - "DNS Resolvers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          AGGREGATE hourly count of ClickOnce file downloads
          TRAIN time-series model (e.g., SARIMA) on historical data
          FORECAST expected download count and confidence interval
          IF actual_count > upper_confidence_bound
            ALERT
  - question: "Has a ClickOnce application reference file (.appref-ms) been written to a user's Startup folder?"
    context: "Placing a file in the Startup folder is a classic persistence technique. This question targets this behavior specifically for ClickOnce applications. The creation of an '.appref-ms' file in this location is a high-fidelity indicator that an adversary is attempting to make their malicious application run automatically every time the user logs in."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "User Startup Folders on Endpoints"
      - "File System Audit Logs"
      - "Domain Controllers (for GPO-based monitoring)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH file_system_audit_events (EventID 4663 for 'Write' access)
          WHERE object_name contains '\\Start Menu\\Programs\\Startup\\'
            AND object_name ends with '.appref-ms'
          ALERT
  - question: "Is there a rare or unique ClickOnce application (.appref-ms file) present in the Startup folders of a small number of endpoints?"
    context: "Legitimate software deployed for persistence is usually present on many machines. This question inventories all '.appref-ms' files in Startup folders across the enterprise and flags those with low prevalence. A file found on only a few machines (<1% of fleet) is highly suspicious and likely not part of a standard software package, pointing to a targeted attack."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "User Startup Folders on Endpoints"
      - "File System Audit Logs"
      - "Domain Controllers (for GPO-based monitoring)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          INVENTORY all '.appref-ms' files in Startup folders across all endpoints
          FOR each unique file_hash
            CALCULATE prevalence (percentage of endpoints with file)
            IF prevalence < 1% AND NOT known_targeted_deployment
              ALERT
  - question: "Does a ClickOnce application file in a Startup folder have anomalous characteristics compared to other legitimate startup items?"
    context: "This question uses anomaly detection to find suspicious startup items without relying on prevalence alone. By analyzing features like file name entropy, file size, and digital signature status, a machine learning model can cluster normal startup files together. Any '.appref-ms' file that the model flags as an outlier or 'noise' does not fit the typical profile and should be investigated."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "User Startup Folders on Endpoints"
      - "File System Audit Logs"
      - "Domain Controllers (for GPO-based monitoring)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR all files in Startup folders
            EXTRACT features (file_name_entropy, size, is_signed)
            APPLY clustering algorithm (e.g., DBSCAN)
            IF an '.appref-ms' file is classified as an outlier/noise
              ALERT