name: 'T1213: Data from Information Repositories'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: This playbook focuses on detecting adversaries collecting sensitive data from internal information repositories such as SharePoint, Confluence, network shares, and databases. It addresses the primary information requirement, "Has the adversary collected sensitive data from information repositories?". Detections are based on correlating internal data access events with suspicious subsequent activities. These activities include outbound network connections to malicious infrastructure, anomalous execution of database dump utilities, unusual patterns of file access (e.g., volume, cross-departmental access), staging data through compression, and abnormal volumes of network egress traffic. The playbook provides a multi-faceted approach, combining rule-based, statistical, and machine learning methods to identify this collection behavior.
type: technique
related:
  - 'TA0009: Collection'
contributors:
  - Zachary Szewczyk
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
  - question: Is a user session involving sensitive repository access followed by a network connection to known malicious infrastructure?
    context: This question helps to detect immediate data exfiltration attempts. An adversary might access sensitive files and then immediately send them to a command-and-control (C2) server or a dropzone. Correlating internal access with external connections to known-bad destinations within a short time frame is a high-fidelity indicator of compromise.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 5145
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek dns.log
      - SharePoint sites, Confluence spaces, and network file shares containing sensitive data
      - Network egress points and DNS resolvers
    range: last 90 days
    queries:
      - 'pseudocode: JOIN (repository_access_logs) WITH (network_connection_logs) ON (user, source_host) WHERE time_difference < 15 minutes AND destination_ip IN (threat_intelligence_feed)'
  - question: Following sensitive repository access, is a user connecting to a new or unusual destination country or Autonomous System Number (ASN)?
    context: This question aims to detect exfiltration to destinations that are anomalous for a specific user. Adversaries often use infrastructure in countries or hosted by providers that are not part of the organization's normal business operations. Baselining user behavior and alerting on connections to new or rare destinations after sensitive data access can uncover these exfiltration channels.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 5145
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek dns.log
      - SharePoint sites, Confluence spaces, and network file shares containing sensitive data
      - Network egress points and DNS resolvers
    range: last 90 days
    queries:
      - 'pseudocode: FOR each user_session involving repository_access: CHECK if subsequent destination_asn OR destination_country is NOT IN user_historical_destinations'
  - question: Can a machine learning model identify high-risk sessions involving repository access followed by network egress based on multiple features?
    context: This question moves beyond simple rules to a more sophisticated, risk-based approach. By combining multiple weak signals (e.g., time difference between access and egress, data volume transferred, destination IP reputation, destination ASN, domain age), a machine learning model can score the likelihood of malicious activity, reducing false positives and detecting more nuanced attacks.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 5145
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek dns.log
      - SharePoint sites, Confluence spaces, and network file shares containing sensitive data
      - Network egress points and DNS resolvers
      - WHOIS data
    range: last 90 days
    queries:
      - 'pseudocode: PREDICT risk_score USING ML_model ON session_features(time_diff, data_volume, ip_rep, asn, domain_age, repo_sensitivity)'
  - question: Has a database dump or data transfer utility been executed by an anomalous parent process or with output redirected to a suspicious staging directory?
    context: This helps detect when an adversary, having compromised a server (e.g., a web server), uses legitimate database tools to dump sensitive data. Normal execution of these tools is typically from an administrator's interactive shell (cmd.exe, powershell.exe), not from an automated process like a web server (w3wp.exe). Staging data in public or temporary directories is also a common TTP.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Production and development database servers
      - Web servers with database connectivity
      - Endpoints of DBAs, developers, and system administrators
    range: last 90 days
    queries:
      - 'pseudocode: SEARCH process_creation_logs WHERE process_name IN (db_dump_tools) AND (parent_process NOT IN (benign_parents) OR command_line CONTAINS (suspicious_paths))'
  - question: Is a user executing a database utility with a command-line structure that is significantly different from their historical usage?
    context: This question focuses on behavioral anomalies in how administrators and developers use database tools. An adversary might use the same tools but with different parameters, such as dumping a different database or using flags to bypass logging. Comparing the structure of commands against a user's baseline can reveal this deviation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Production and development database servers
      - Web servers with database connectivity
      - Endpoints of DBAs, developers, and system administrators
    range: last 90 days
    queries:
      - 'pseudocode: FOR each db_tool_execution: CALCULATE jaccard_similarity(current_command_tokens, historical_command_tokens_for_user); ALERT if similarity < 0.5'
  - question: Can a machine learning model classify the execution of a database utility as malicious based on its command-line features?
    context: This approach uses machine learning to score the maliciousness of a command line itself, rather than just comparing it to a baseline. Features like string complexity (entropy), length, and the presence of suspicious elements (IP addresses, redirection) can be powerful indicators, allowing for the detection of novel malicious commands.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Production and development database servers
      - Web servers with database connectivity
      - Endpoints of DBAs, developers, and system administrators
    range: last 90 days
    queries:
      - 'pseudocode: PREDICT is_malicious USING ML_model ON command_line_features(length, entropy, has_redirection, has_ip, parent_process, user)'
  - question: Is a user accessing information repositories or files that are designated for a different department or business unit?
    context: This is a direct check for access control violations. An adversary moving laterally or a malicious insider will often try to access data outside their normal job function. This question helps enforce "need-to-know" policies and detects clear violations of intended access patterns by comparing a user's group membership against the resource's access control list.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 5145
      - Zeek http.log
      - Application-specific audit logs (e.g., SharePoint, Confluence)
      - SharePoint Online tenant, Confluence server, network file shares categorized by departmental ownership
    range: last 90 days
    queries:
      - 'pseudocode: FOR each file_access_event: CHECK if user_group NOT IN allowed_groups_for_resource'
  - question: Has a user accessed an unusually high number of distinct files or pages from sensitive repositories compared to their own historical baseline?
    context: This question aims to detect bulk data collection. Before exfiltrating data, an adversary often needs to discover and access many different files. A sudden spike in the *variety* of files accessed by a single user, compared to their own normal behavior (e.g., exceeding the 98th percentile of their 30-day activity), is a strong indicator of reconnaissance or collection activity.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 5145
      - Zeek http.log
      - Application-specific audit logs (e.g., SharePoint, Confluence)
      - SharePoint Online tenant, Confluence server, network file shares categorized by data sensitivity
    range: last 90 days
    queries:
      - 'pseudocode: FOR each user: CALCULATE daily_distinct_file_count; ALERT if count > 98th_percentile(user_30_day_history)'
  - question: Is a user's pattern of repository access significantly different from that of their peers in the same role or department?
    context: This question identifies behavioral outliers. While a user's activity might not trigger individual thresholds, their overall pattern of access might be strange compared to others with the same job function. Peer group analysis is effective at spotting users whose behavior deviates from their group's norm, which could indicate a compromised account or an insider threat.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 5145
      - Zeek http.log
      - Application-specific audit logs (e.g., SharePoint, Confluence)
      - SharePoint Online tenant, Confluence server, network file shares categorized by departmental ownership
    range: last 90 days
    queries:
      - 'pseudocode: FOR each user: CALCULATE cosine_distance(current_access_vector, peer_group_centroid); ALERT if distance > threshold'
  - question: Has a user performed a mass file read from a sensitive share, immediately followed by the use of a data compression utility?
    context: This question targets a classic data staging TTP. Adversaries often copy a large number of files from a network share and then compress them into a single archive to facilitate easier and faster exfiltration. Correlating these two distinct activities (e.g., >1000 file reads followed by 7z.exe execution) in a short time window for the same user and host is a high-fidelity indicator of data collection and staging.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Network file shares containing intellectual property, PII, or financial records
      - User endpoints
    range: last 90 days
    queries:
      - 'pseudocode: DETECT >1000 file_reads FROM sensitive_share BY user, host in 30_min; IF detected, LOOK FOR compression_tool_process by same user, host in next 5_min'
  - question: Is a user-host pair exhibiting an anomalously high ratio of file read to file write operations, coupled with a high absolute read count?
    context: This question provides an alternative way to detect bulk data access. A normal user session involves a mix of reading and writing. A session focused purely on collection will be heavily skewed towards reading. A sudden, dramatic spike in the read-to-write ratio (e.g., >100:1) combined with an unusually high number of reads indicates that a user is likely copying data, not interacting with it normally.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4663
      - Network file shares containing intellectual property, PII, or financial records
      - User endpoints
    range: last 90 days
    queries:
      - 'pseudocode: IN 15-min_windows, CALCULATE read_write_ratio; ALERT if ratio > 100:1 AND read_count > 3_std_dev_above_mean'
  - question: Can a state-based machine learning model (HMM) detect a sequence of events corresponding to a likely data staging and compression workflow?
    context: This question proposes a sophisticated sequential analysis method. Data collection is a process with distinct stages (e.g., browsing, mass reading, compression). A Hidden Markov Model (HMM) can be trained to recognize the typical sequence of system events associated with this malicious workflow and alert when a user's session transitions from a 'Mass File Read' state to a 'Data Compression' state with high probability.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Network file shares containing intellectual property, PII, or financial records
      - User endpoints
    range: last 90 days
    queries:
      - 'pseudocode: INPUT user_event_sequence INTO HMM; ALERT if model transitions from ''Mass_Read_State'' to ''Compression_State'' with high probability'
  - question: After accessing a sensitive repository, is a host connecting to a known malicious domain type (e.g., dynamic DNS, anonymizer) and exfiltrating a large amount of data (>100MB)?
    context: This question combines three strong indicators: access to sensitive data, use of suspicious network infrastructure, and a large data transfer. The correlation of these events within a short time frame (e.g., 1 hour) provides a very high-confidence alert for data exfiltration. Adversaries often use dynamic DNS, anonymizing proxies, or abused cloud storage to hide their infrastructure.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5145
      - Application-specific audit logs
      - Network egress points (firewalls, proxies)
      - DNS resolvers
      - Information repositories
    range: last 90 days
    queries:
      - 'pseudocode: AFTER sensitive_repo_access BY host: MONITOR for 1_hour; ALERT if host connects to blocklisted_domain_type AND transferred_bytes > 100MB'
  - question: Is a host exhibiting an anomalous spike in outbound data volume (e.g., > 3 standard deviations above its hourly baseline) shortly after accessing a sensitive repository?
    context: This question focuses on detecting unusual data transfers by baselining a host's normal network behavior. A sudden, statistically significant increase in outbound traffic is a key indicator of exfiltration. By enriching this network anomaly alert with evidence of recent sensitive repository access from the same host, the event is contextualized and prioritized for investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5145
      - Application-specific audit logs
      - Network egress points (firewalls, proxies)
      - DNS resolvers
      - Information repositories
    range: last 90 days
    queries:
      - 'pseudocode: ALERT if hourly_outbound_volume > (mean + 3 * std_dev); IF alert, ENRICH by checking for sensitive_repo_access in preceding hour'
  - question: Can a time-series anomaly detection model identify abnormal spikes in a host's outbound traffic that are inconsistent with its learned daily and weekly patterns, especially when correlated with repository access?
    context: This question proposes a more advanced method for detecting network anomalies. Unlike a simple standard deviation threshold, time-series models (like Prophet or ESD) can account for normal cyclical patterns (e.g., nightly backups). This allows the model to identify traffic spikes that are truly anomalous, reducing false positives from legitimate, periodic high-traffic events. Correlating these anomalies with recent data access adds critical context.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5145
      - Application-specific audit logs
      - Network egress points (firewalls, proxies)
      - DNS resolvers
      - Information repositories
    range: last 90 days
    queries:
      - 'pseudocode: APPLY time-series_model to host_traffic_data; ALERT on identified anomalies; ENRICH with recent repo_access_data'