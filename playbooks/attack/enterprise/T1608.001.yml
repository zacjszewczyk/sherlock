name: T1608.001: Upload Malware
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an internal system is downloading or executing a malicious payload from external infrastructure. It focuses on identifying network connections to known malicious destinations, downloads of high-risk files from suspicious domains (like newly registered or non-sanctioned file-sharing sites), files transferred over TLS sessions with weak or dubious certificates (e.g., self-signed), and the execution of recently downloaded files that subsequently initiate outbound network connections.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has any internal host established a network connection with an IP, domain, or URL known to be malicious based on threat intelligence?
    context: This question aims to detect direct communication with known command-and-control (C2) or malware hosting infrastructure. Matching network traffic against a curated list of Indicators of Compromise (IOCs) is a high-fidelity method for identifying potential threats. A positive match requires immediate investigation to determine the nature of the communication and the state of the source host.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Data should be collected from Internet gateways, network egress points, and forward/reverse web proxies.
    range: last 90 days
    queries:
      - query: SEARCH network logs (Zeek conn, http) WHERE destination_ip OR destination_domain OR url IN (threat_intel_list) | RETURN source_host, destination, timestamp
  - question: Of the internal hosts connecting to known malicious domains, which connections are to domains rarely seen within the enterprise?
    context: This question refines IOC-based alerting by adding a layer of prevalence analysis. Widespread threats might infect many hosts, but a targeted attack often involves infrastructure that is unique to a small number of victims. By prioritizing connections to statistically rare malicious domains, analysts can focus on potentially more sophisticated or targeted threats.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Data should be collected from Internet gateways, network egress points, and forward/reverse web proxies.
    range: last 90 days
    queries:
      - query: SEARCH network logs WHERE destination_domain IN (threat_intel_list) | CALCULATE prevalence of destination_domain across all hosts over 90 days | FILTER for domains with low host count (e.g., < 3) | RETURN source_host, destination_domain, prevalence_count
  - question: Are there any network connections that a machine learning model flags as highly likely to be malicious, even if they don't match a known IOC?
    context: This question leverages predictive analytics to uncover novel or unknown threats that evade signature-based detection. By enriching network connection data with features like ASN, geography, and TLS certificate details, a classification model can identify suspicious patterns indicative of malicious activity. Alerts are triggered for connections exceeding a high-confidence probability threshold, enabling analysts to investigate emerging threats.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Data should be collected from Internet gateways, network egress points, and forward/reverse web proxies.
    range: last 90 days
    queries:
      - query: ENRICH network connection logs with features (ASN, geo, reputation, TLS data) | APPLY pre-trained classification model | FILTER for connections with predicted_malicious_probability > 0.90 | RETURN source_host, destination, probability_score, key_features
  - question: Has any internal host downloaded a high-risk file type (e.g., .exe, .dll) from a non-sanctioned file-sharing service or a newly registered domain?
    context: This question targets a common malware delivery vector: tricking users into downloading executables from untrusted sources. Attackers often use new domains (NRDs) or abuse public file-sharing sites to host their payloads. By monitoring for downloads of risky file types from these specific categories of domains, security teams can proactively identify potential malware introductions.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek files.log
      - WHOIS Data
      - Data should be collected from Internal DNS servers, network egress points, and web proxies.
    range: last 90 days
    queries:
      - query: SEARCH file download logs WHERE (file_mime_type IN (high_risk_list) AND destination_domain IN (non-sanctioned_list)) OR (file_mime_type IN (high_risk_list) AND domain_registration_age < 60 days) | RETURN source_host, filename, file_type, destination_domain, domain_age
  - question: Are there any downloads of high-risk files from URLs with unusually high-entropy (random-looking) paths?
    context: This question seeks to identify malware downloads from content delivery networks (CDNs) or other services that use algorithmically generated, random-looking URLs. High Shannon entropy in a URI path is often an indicator of automation rather than human-readable structure. Correlating this with the download of a high-risk file type can surface suspicious delivery mechanisms.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek files.log
      - WHOIS Data
      - Data should be collected from Internal DNS servers, network egress points, and web proxies.
    range: last 90 days
    queries:
      - query: FOR each file download event, CALCULATE shannon_entropy of the URI path | FILTER for events where file_mime_type IN (high_risk_list) AND uri_entropy > 98th_percentile_baseline | RETURN source_host, filename, uri, uri_entropy
  - question: Has an unusual spike in DNS queries for a specific domain coincided with the download of a high-risk file from that same domain?
    context: This question aims to detect 'first-touch' scenarios where an attacker's infrastructure is suddenly activated. A sudden, anomalous spike in DNS lookups for a domain, especially a low-traffic one, can indicate a coordinated campaign kickoff. Correlating this DNS anomaly with file download logs for high-risk files provides strong evidence of a potential malware staging and delivery event.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek files.log
      - WHOIS Data
      - Data should be collected from Internal DNS servers, network egress points, and web proxies.
    range: last 90 days
    queries:
      - query: APPLY time series anomaly detection to daily DNS query volume per domain | IF anomalous spike is detected for a domain, SEARCH file download logs for high-risk files from that domain within the same timeframe | RETURN source_host, filename, domain, dns_spike_details
  - question: Has a high-risk file been downloaded over a TLS session that used a self-signed or untrusted certificate?
    context: This question identifies malware downloads that are hiding behind improperly configured or deliberately malicious encryption. Legitimate sites typically use TLS certificates from trusted Certificate Authorities (CAs). The use of a self-signed certificate or one from an unknown CA to encrypt the download of an executable file is a significant red flag.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek ssl.log
      - Zeek conn.log
      - Data should be collected from network egress points, certificate transparency logs, and external threat intelligence platforms.
    range: last 90 days
    queries:
      - query: JOIN file download logs with TLS session logs on session ID | FILTER for downloads where file_mime_type IN (high_risk_list) AND (tls_validation_status = 'self-signed' OR tls_issuer NOT IN (trusted_ca_list)) | RETURN source_host, filename, destination_domain, tls_issuer, tls_subject
  - question: Are there any file downloads that accumulate a high composite risk score based on multiple suspicious factors?
    context: This question moves beyond single indicators to a more holistic risk assessment. A single suspicious attribute might be benign, but multiple weak signals occurring together (e.g., a self-signed cert, a low-reputation IP, and an unusual User-Agent) create a much stronger indication of malicious activity. By scoring and summing these factors, analysts can identify the riskiest download events.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek ssl.log
      - Zeek conn.log
      - Data should be collected from network egress points, certificate transparency logs, and external threat intelligence platforms.
    range: last 90 days
    queries:
      - query: FOR each file download, CALCULATE risk_score (e.g., +3 for self-signed, +2 for low-rep IP, +1 for unusual user-agent) | FILTER for downloads where total_risk_score > threshold | RETURN source_host, filename, destination, total_risk_score, contributing_factors
  - question: Can unsupervised machine learning identify any small, distinct clusters of file download activity that deviate from normal behavior?
    context: This question uses clustering algorithms like DBSCAN to find 'unknown unknowns'â€”novel attack patterns that don't match any predefined rules. By grouping downloads based on features like MIME type, TLS certificate details, and ASN, the vast majority of legitimate activity will form a large, central cluster. Small, dense, outlier clusters represent groups of downloads that share unusual characteristics, making them prime candidates for investigation.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek ssl.log
      - Zeek conn.log
      - Data should be collected from network egress points, certificate transparency logs, and external threat intelligence platforms.
    range: last 90 days
    queries:
      - query: APPLY clustering algorithm (e.g., DBSCAN) to file download events using features (MIME type, TLS issuer/subject, ASN, country) | IDENTIFY and isolate small, dense outlier clusters | RETURN events in outlier clusters for review
  - question: Has a file recently downloaded from the internet been executed on a host and immediately initiated an outbound network connection?
    context: This question directly links a potential malware delivery event (file download) with post-exploitation activity (process execution and C2 beaconing). Correlating network file download logs with endpoint process creation logs and subsequent network connection logs provides a strong, high-confidence signal of a successful malware execution chain.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek files.log
      - Zeek conn.log
      - Data should be collected from Endpoint devices (workstations, servers), domain controllers, and network egress points.
    range: last 90 days
    queries:
      - query: JOIN file downloads with process creation logs (by host, filename, within 10 mins) | JOIN result with subsequent network connection logs (by process ID) | FILTER for new processes that make external connections | RETURN host, filename, process_name, process_id, destination_ip
  - question: Is a process spawned from a downloaded file masquerading as a common Windows system process (e.g., 'svch0st.exe' instead of 'svchost.exe')?
    context: This question aims to detect a common defense evasion technique known as masquerading. Attackers often name their malicious executables with slight misspellings of legitimate system processes to blend in. By calculating the Levenshtein distance (a measure of string similarity), we can programmatically identify these typosquatting attempts.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek files.log
      - Zeek conn.log
      - Data should be collected from Endpoint devices (workstations, servers), domain controllers, and network egress points.
    range: last 90 days
    queries:
      - query: FOR processes created from downloaded files, CALCULATE Levenshtein distance between process_name and list of common system process names | FILTER for processes where distance > 0 AND distance < 3 | RETURN host, process_name, distance, closest_match
  - question: Does a process originating from a downloaded file exhibit periodic, 'heartbeat'-like network traffic indicative of command-and-control beaconing?
    context: This question seeks to identify the characteristic communication pattern of malware calling home to its C2 server. Unlike human-driven traffic, automated beaconing is often highly regular in its timing and data volume. By applying time series analysis to the network connections of a process spawned from a downloaded file, we can detect this periodicity and flag it as likely C2 activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek files.log
      - Zeek conn.log
      - Data should be collected from Endpoint devices (workstations, servers), domain controllers, and network egress points.
    range: last 90 days
    queries:
      - query: FOR a process from a downloaded file, ANALYZE the time series of its outbound network connections | USE autocorrelation or Fourier analysis to detect periodicity in connection timing/volume | IF strong regular signal is detected, ALERT | RETURN host, process_name, signal_details