name: 'T1608.001: Upload Malware'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: 'This playbook addresses the threat of an internal system downloading or executing a malicious payload staged on external infrastructure. It provides investigative steps to detect this activity by correlating network traffic with threat intelligence, analyzing file attributes (MIME type, extension) and source reputation (non-sanctioned file-sharing sites, newly registered domains), examining TLS certificate characteristics (self-signed, short-lived), and linking network file downloads to subsequent suspicious process execution and C2 beaconing on endpoints.'
type: 'technique'
related:
  - 'TA0042: Resource Development'
contributors:
  - 'Zachary Szewczyk'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Has any internal host established a network connection with a destination IP, domain, or URL known to be malicious?'
    context: 'This question aims to identify direct communication with known command-and-control (C2) or malware hosting infrastructure. Matching against a high-fidelity threat intelligence feed is a primary method for detecting active threats. An alert for such a connection provides a strong signal of a potential compromise.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'Internet gateways'
      - 'network egress points'
      - 'forward and reverse web proxies.'
    range: 'Last 90 days'
    queries:
      - 'SEARCH network_logs (conn, http) WHERE destination_ip OR destination_domain OR url IN malicious_ioc_list RETURN source_host, destination, timestamp'
  - question: 'If an internal host connected to a known malicious domain, is that domain rarely contacted by other hosts in the enterprise?'
    context: 'This question helps prioritize alerts by distinguishing between widespread, possibly less severe threats (or false positives) and highly targeted attacks. A malicious domain contacted by only one or a few hosts is more likely to be part of a specific, targeted campaign against the organization.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'Internet gateways'
      - 'network egress points'
      - 'forward and reverse web proxies.'
    range: 'Last 90 days'
    queries:
      - 'SEARCH network_logs WHERE destination_domain IN malicious_ioc_list | GROUP BY destination_domain | COUNT unique source_host | FILTER count < 3'
  - question: 'Have any outbound network connections been classified as highly likely to be malicious by a predictive model?'
    context: 'This question leverages machine learning to detect previously unknown or zero-day threats that are not yet in threat intelligence feeds. By analyzing a rich set of features (ASN, geo-location, reputation, TLS data), the model can identify subtle patterns indicative of malicious activity, providing a proactive detection capability.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek ssl.log'
      - 'Internet gateways'
      - 'network egress points'
      - 'forward and reverse web proxies.'
    range: 'Last 90 days'
    queries:
      - 'INPUT network_connections | ENRICH with geo, asn, reputation, tls_features | PREDICT maliciousness_score with ML_model | FILTER maliciousness_score > 0.90'
  - question: 'Was a high-risk file (e.g., .exe, .dll) downloaded from a non-sanctioned file-sharing site or a newly registered domain (NRD)?'
    context: 'Attackers often use file-sharing services or newly created domains to stage malware. This question focuses on identifying these high-risk download scenarios. Filtering by file type and source reputation (or age) helps to pinpoint potentially malicious payloads while reducing noise from legitimate downloads.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek dns.log'
      - 'Zeek files.log'
      - 'WHOIS Data'
      - 'Internal DNS servers'
      - 'network egress points'
      - 'web proxies.'
    range: 'Last 90 days'
    queries:
      - 'SEARCH file_downloads WHERE (mime_type IN high_risk_mimetypes) AND (source_domain IN non_sanctioned_fileshare_list OR source_domain_creation_date < 60_days_ago)'
  - question: 'Has a high-risk file been downloaded from a URL with an unusually random or complex path?'
    context: 'High entropy (randomness) in a URL path can indicate the use of algorithmically generated links, a technique often employed by content delivery networks (CDNs) and malware delivery systems to obscure file locations. This question helps detect suspicious delivery mechanisms that might evade simple domain-based blocking.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek files.log'
      - 'Internal DNS servers'
      - 'network egress points'
      - 'web proxies.'
    range: 'Last 90 days'
    queries:
      - 'SEARCH http_logs | CALCULATE shannon_entropy(uri_path) as entropy_score | JOIN with file_downloads on transaction_id | FILTER file_mime_type IN high_risk_mimetypes AND entropy_score > 98th_percentile'
  - question: 'Did an anomalous spike in DNS queries for a specific domain coincide with the download of a high-risk file from that same domain?'
    context: 'A sudden, unusual increase in DNS requests for a domain can signal the activation of a malicious campaign or a rendezvous point for compromised hosts. This question seeks to correlate such DNS anomalies with actual file transfers, providing strong evidence that the spike was related to malware staging and delivery.'
    answer_sources:
      - 'Zeek dns.log'
      - 'Zeek files.log'
      - 'Internal DNS servers'
      - 'network egress points'
      - 'web proxies.'
    range: 'Last 90 days'
    queries:
      - 'DETECT anomalous_spike in dns_query_volume for each domain | IF spike_detected, SEARCH file_downloads in same_timeframe WHERE domain == spike_domain AND file_type IN high_risk_types'
  - question: 'Has a high-risk file been downloaded over a TLS session that used a self-signed or untrusted certificate?'
    context: 'Legitimate sites typically use TLS certificates issued by trusted Certificate Authorities (CAs). Attackers often use self-signed certificates or certificates from unknown CAs for their infrastructure to save cost and avoid scrutiny. This question helps identify malware downloads that are hiding within encrypted traffic but betray their malicious nature through weak certificate practices.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek files.log'
      - 'Zeek ssl.log'
      - 'Zeek conn.log'
      - 'Network egress points'
      - 'certificate transparency logs'
      - 'external threat intelligence platforms.'
    range: 'Last 90 days'
    queries:
      - 'JOIN file_downloads with tls_sessions on transaction_id | FILTER file_type IN high_risk_types AND (tls_validation_status == "self-signed" OR tls_issuer NOT IN trusted_ca_list)'
  - question: 'Have any file downloads accumulated a high composite risk score based on multiple suspicious factors (e.g., self-signed cert, low-rep IP, short-lived cert)?'
    context: 'A single suspicious indicator may not be enough to confirm a threat. This question uses a risk-scoring model to aggregate multiple weak signals into a stronger, higher-confidence alert. By combining factors like certificate validity, IP reputation, and User-Agent anomalies, analysts can more effectively identify downloads that are holistically suspicious.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek files.log'
      - 'Zeek ssl.log'
      - 'Zeek conn.log'
      - 'Network egress points'
      - 'certificate transparency logs'
      - 'external threat intelligence platforms.'
    range: 'Last 90 days'
    queries:
      - 'FOR each file_download: CALCULATE score = (points for self_signed_cert) + (points for low_rep_ip) + (points for unusual_user_agent) + (points for short_cert_validity) | FILTER score > threshold'
  - question: 'Are there any small, distinct groups of file downloads that share similar suspicious characteristics (e.g., same cert issuer, destination ASN, file type)?'
    context: 'This question employs unsupervised machine learning to find novel or emerging attack patterns without relying on predefined rules or signatures. By clustering downloads based on their attributes, anomalous groups—small, dense clusters separate from the "normal" bulk of activity—can be identified for investigation as potential coordinated malicious campaigns.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek files.log'
      - 'Zeek ssl.log'
      - 'Zeek conn.log'
      - 'Network egress points'
      - 'certificate transparency logs'
      - 'external threat intelligence platforms.'
    range: 'Last 90 days'
    queries:
      - 'INPUT file_download_features (mime_type, tls_issuer, dest_asn, etc.) | APPLY DBSCAN clustering | IDENTIFY and investigate small, dense outlier clusters'
  - question: 'Did a file recently downloaded from an external source get executed and immediately make a new outbound network connection?'
    context: 'This question tracks the full lifecycle of a potential malware execution: download, execution, and command-and-control (C2) beaconing. Correlating network file download events with endpoint process creation and subsequent network activity provides a high-confidence indicator of compromise, showing that a downloaded payload is now active on the host.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 3'
      - 'Zeek files.log'
      - 'Zeek conn.log'
      - 'Endpoint devices (workstations, servers)'
      - 'domain controllers'
      - 'network egress points.'
    range: 'Last 90 days'
    queries:
      - 'JOIN file_downloads with process_creation on (host, filename) within 10min | JOIN with network_connections on process_id | FILTER connection is_external | ALERT'
  - question: 'Is a process created from a downloaded file masquerading as a common system process (e.g., "svch0st.exe" instead of "svchost.exe")?'
    context: 'Attackers often use typosquatting or minor variations of legitimate system process names to hide their malware from casual inspection. This question uses string similarity (Levenshtein distance) to detect such masquerading attempts, which is a strong indicator of malicious intent.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Zeek files.log'
      - 'Endpoint devices (workstations, servers)'
      - 'domain controllers.'
    range: 'Last 90 days'
    queries:
      - 'FOR each process from downloaded_file: CALCULATE levenshtein_distance(process_name, known_system_processes) as distance | FILTER distance > 0 AND distance < 3'
  - question: 'Does a process originating from a downloaded file exhibit periodic, "heartbeat"-like network traffic indicative of C2 beaconing?'
    context: 'Malware often communicates with its command-and-control server on a regular, automated schedule (a "beacon" or "heartbeat") to receive commands or exfiltrate data. This question aims to identify this rhythmic traffic pattern using time-series analysis. Detecting such periodicity is a classic and reliable way to uncover active C2 channels.'
    answer_sources:
      - 'Sysmon Event ID 3'
      - 'Zeek conn.log'
      - 'Endpoint devices (workstations, servers)'
      - 'network egress points.'
    range: 'Last 90 days'
    queries:
      - 'FOR each process from downloaded_file: ANALYZE timestamp_series of its outbound_connections | DETECT periodicity using fourier_analysis or autocorrelation | ALERT on strong_regular_signal'