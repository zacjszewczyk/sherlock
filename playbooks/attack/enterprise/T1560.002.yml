name: T1560.002: Archive via Library
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook addresses the adversary tactic of staging data for exfiltration by compressing or encrypting it using a third-party library. It provides investigative steps to detect this activity by monitoring for several key indicators: the execution of processes with hashes matching known malicious archivers; the use of scripting interpreters like Python or PowerShell to call compression libraries; the anomalous creation of archive files by non-interactive system services; a burst of file read activity from a single process immediately followed by the creation of an archive; and the creation of an archive file followed by a suspicious outbound network connection to an unknown or low-reputation destination.
type: technique
related:
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a process been executed whose file hash matches a known malicious or suspicious archiving tool from a threat intelligence feed?
    context: This question aims to identify the most straightforward evidence of malicious archiving activity: the use of a tool with a known bad reputation. By matching process hashes against a threat intelligence feed, analysts can quickly detect confirmed malicious tools used for data staging, bypassing the need for complex behavioral analysis. A match provides a high-confidence starting point for an investigation.
    answer_sources:
      - Windows Event ID 4688
      - Threat Intelligence Feed of Malicious Hashes
      - Focus on: Domain Controllers, File Servers, Critical Application Servers, Developer Workstations, Executive Laptops
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_events (EID: 4688) | JOIN file_hash with threat_intel_hashes | WHERE match_found
  - question: Is a rare or uncommon archiving-related process running in the environment?
    context: Adversaries often bring their own tools, which will appear as rare or unique in an enterprise environment compared to standard, widely deployed software. This question helps identify suspicious archiver tools that are not on a threat intelligence list by flagging them based on their rarity. A process related to archiving that is only present on a handful of systems is highly suspect and warrants investigation.
    answer_sources:
      - Windows Event ID 4688
      - Focus on: Domain Controllers, File Servers, Critical Application Servers, Developer Workstations, Executive Laptops
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_events (EID: 4688) | WHERE process_name CONTAINS ('zip', 'rar', 'archive', 'compress', '7z') | CALCULATE prevalence(file_hash) | WHERE prevalence < 0.5%
  - question: Does a process creation event for an archiver exhibit characteristics identified as malicious by a machine learning model?
    context: This question leverages machine learning to detect subtle patterns of maliciousness that are difficult to define with simple rules. By training a model on features like process name length, parent process, and argument count from known good and bad examples, it can predict the likelihood that a new, unseen archiving process is malicious. This is useful for detecting novel or obfuscated adversary tools.
    answer_sources:
      - Windows Event ID 4688
      - Focus on: Domain Controllers, File Servers, Critical Application Servers, Developer Workstations, Executive Laptops
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT process_creation_events to ML_model | PREDICT is_malicious | WHERE prediction == malicious
  - question: Is a scripting interpreter being used to call archiving or compression libraries, especially to access sensitive directories?
    context: Adversaries may use legitimate scripting tools like Python or PowerShell to perform 'living-off-the-land' attacks, calling built-in or third-party libraries to archive data. This avoids introducing a new, suspicious binary. This question looks for command-line evidence of these scripts being used for collection, focusing on known script interpreters and archiving module names.
    answer_sources:
      - Windows Event ID 4688
      - Focus on: User Workstations, Web Servers, Application Servers, CI/CD Build Servers, Code Repositories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_events (EID: 4688) | WHERE process_name IN ('python.exe', 'pwsh.exe') AND command_line CONTAINS ('zipfile', 'Compress-Archive', 'zlib') AND command_line targets sensitive_dirs
  - question: Are there any anomalous scripting commands related to archiving, such as those with unusually high complexity (entropy) or a frequency that deviates from a user's normal behavior?
    context: To evade simple keyword-based detections, adversaries might obfuscate their commands. High Shannon entropy in a command-line string can indicate such obfuscation. Additionally, a user who suddenly starts running many more archiving commands than usual may be compromised. This question uses statistical baselining to find these behavioral anomalies.
    answer_sources:
      - Windows Event ID 4688
      - Focus on: User Workstations, Web Servers, Application Servers, CI/CD Build Servers, Code Repositories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_events (EID: 4688) | WHERE command_line CONTAINS archiving_keywords | CALCULATE entropy(command_line) OR frequency(command, user) | WHERE entropy > baseline OR frequency > baseline
  - question: Are there unusual or outlier clusters of command-line activity related to archiving that differ from established normal behavior?
    context: This question uses unsupervised machine learning to discover novel or rare adversary techniques without relying on predefined signatures. By clustering command-line arguments, the system can define 'normal' groups of activity. Commands that do not fit into any large cluster or form their own small, isolated cluster are flagged as potential outliers worthy of investigation.
    answer_sources:
      - Windows Event ID 4688
      - Focus on: User Workstations, Web Servers, Application Servers, CI/CD Build Servers, Code Repositories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT command_line_tokens to clustering_model | IDENTIFY outlier_clusters | ALERT on outliers
  - question: Has a typically non-interactive or sensitive system process created an archive file?
    context: System services and background applications like web servers (w3wp.exe) or database servers (sqlservr.exe) generally do not create .zip or .rar files as part of their normal operation. This question aims to detect when such a process is compromised or exploited to stage data for exfiltration by looking for this highly anomalous file creation activity.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Focus on: Web Application Servers (DMZ), Database Servers, Internal File Shares, System Temporary Directories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH file_creation_events (EID: 4663) with archive_extensions | JOIN with process_creation (EID: 4688) on ProcessID | WHERE process_name IN (sensitive_process_list)
  - question: Has any process created an archive file for the first time or with a frequency that is statistically improbable based on its historical behavior?
    context: This question establishes a behavioral baseline for every process in the environment concerning the types of files it creates. An alert is triggered when a process, for example `svchost.exe`, creates a `.zip` file for the very first time. This anomaly detection method can uncover abuse of legitimate processes without needing a predefined list of sensitive processes.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Focus on: Web Application Servers (DMZ), Database Servers, Internal File Shares, System Temporary Directories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH file_creation_events (EID: 4663) | For each process_name, CALCULATE probability(file_extension) | WHERE file_extension is archive AND probability is near-zero
  - question: Does a file creation event involving an archive file deviate significantly from the normal baseline of activity as determined by a machine learning model?
    context: This question uses a more advanced form of anomaly detection to identify suspicious file creation events. A model is trained exclusively on 'normal' activity, learning the complex relationships between processes, file paths, and file types. Any event that the model cannot reconstruct well or classifies as an outlier, such as `svchost.exe` creating `data.zip` in `C:\Perflogs`, is flagged as highly suspicious.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Focus on: Web Application Servers (DMZ), Database Servers, Internal File Shares, System Temporary Directories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT file_creation_features to anomaly_model | IDENTIFY outliers | ALERT on outliers involving archive files
  - question: Has a single process rapidly read a large number of files and then immediately created an archive file?
    context: This question looks for the classic 'smash and grab' behavior of data collection. An adversary's script or tool will often read many different files from target directories and then consolidate them into a single archive. By correlating a burst of file read activity with a subsequent archive creation by the same process, we can detect this staging behavior in real-time.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Focus on: User Profile Directories (Documents, Desktop), Network-mapped Drives, SharePoint Sites, Source Code Repositories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: STATEFUL SEARCH for ProcessID | TRIGGER on >200 file_reads (EID: 4663) in 60s | FOLLOWED BY file_write (EID: 4663) with archive_extension by same ProcessID
  - question: Has a process accessed an unusually diverse set of directories before creating an archive file?
    context: Instead of just counting file reads, this question focuses on the breadth of a process's activity. A process that suddenly starts accessing many different directories it doesn't normally touch is suspicious. Correlating this 'directory traversal' anomaly with the creation of an archive file provides strong evidence that the process is collecting and staging data from disparate locations.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Focus on: User Profile Directories (Documents, Desktop), Network-mapped Drives, SharePoint Sites, Source Code Repositories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: For each ProcessID in 5min_window, COUNT unique_directories_accessed | WHERE count > baseline_for_process | CORRELATE with subsequent archive_creation by same ProcessID
  - question: Was there an unpredicted, anomalous spike in file system read activity on a host that correlates with the creation of an archive file?
    context: This question uses time-series analysis to understand the normal rhythm of file system activity on a host, accounting for regular patterns like daily backups or weekly scans. The model can then identify spikes in file reads that are truly anomalous and not part of normal operations. Linking such a spike to the creation of an archive file helps to filter out noise and pinpoint malicious data collection.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Focus on: User Profile Directories (Documents, Desktop), Network-mapped Drives, SharePoint Sites, Source Code Repositories
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT host_file_read_counts to time_series_model | DETECT anomaly_spike | CORRELATE spike_time with archive_creation_time on same host
  - question: Was an archive file created on a host shortly before an outbound network connection was made to a known malicious IP address?
    context: This question directly links the staging of data (archive creation) with the exfiltration of data (outbound connection). Correlating these two events in a short time window, especially when the destination is a known command-and-control server or malicious IP, provides a high-fidelity alert for the entire 'Collect' and 'Exfiltrate' chain of an attack.
    answer_sources:
      - Windows Event ID 4663
      - Zeek conn.log
      - Threat Intelligence Feed
      - Focus on: Network Egress Points (Firewalls, Proxies), DNS Servers, Endpoint Devices, Critical Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CORRELATE file_creation (EID: 4663, archive_ext) on HostA | with network_connection (Zeek) from HostA within 5min | WHERE destination_ip IN threat_intel_list
  - question: Following the creation of an archive file, did the host make an unusual outbound connection, such as to an unfamiliar network (ASN) or with an abnormally large data transfer?
    context: Even if the destination IP is not on a threat list, the characteristics of the connection can be suspicious. This question establishes a baseline of normal network behavior for each host. After an archive file is created, it looks for subsequent connections that deviate from this baseline, such as connecting to a new country or Autonomous System (ASN) for the first time, or sending a much larger amount of data than usual, which could be the exfiltration of the newly created archive.
    answer_sources:
      - Windows Event ID 4663
      - Zeek conn.log
      - Focus on: Network Egress Points (Firewalls, Proxies), DNS Servers, Endpoint Devices, Critical Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON archive_creation on HostA | MONITOR subsequent outbound_connections from HostA | ALERT if destination_ASN is rare for HostA OR bytes_sent > baseline
  - question: Using a graph model of network activity, does a host that recently created an archive file then connect to a suspicious or low-reputation network neighborhood?
    context: This question models the environment as a graph to uncover complex risk relationships. When a host creates an archive, its risk score in the graph is temporarily elevated. The system then analyzes its subsequent network connections to see if it communicates with external IPs that are part of a 'bad neighborhood'—a cluster of nodes with poor reputation scores or suspicious features. This helps identify exfiltration to previously unknown malicious infrastructure.
    answer_sources:
      - Windows Event ID 4663
      - Zeek conn.log
      - Threat Intelligence Feeds
      - Focus on: Network Egress Points (Firewalls, Proxies), DNS Servers, Endpoint Devices, Critical Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON archive_creation on HostA_node, increase risk_score | RUN pathfinder from HostA_node | ALERT if path leads to low_reputation_community_node