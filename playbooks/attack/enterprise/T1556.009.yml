name: T1556.009: Conditional Access Policies
id: 5a9b8c7d-6e3f-4a1b-9c8d-2e3f4a5b6c7d
description: This playbook is designed to detect adversarial manipulation of Conditional
  Access Policies for persistence, defense evasion, and credential access. It focuses
  on identifying successful authentication events that should have been blocked or
  challenged by security policies. This includes logins from malicious IPs, non-compliant
  devices, or via insecure legacy protocols. The playbook also helps uncover subtle
  policy modifications by monitoring for statistical anomalies, such as a decrease
  in MFA challenges, the emergence of new 'trusted' locations, impossible travel
  scenarios, and successful logins using known-compromised credentials.
type: technique
related:
- TA0003: Persistence
- TA0005: Defense Evasion
- TA0006: Credential Access
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are we observing successful authentications from IP addresses with a known
    high-risk reputation?
  context: This question aims to detect a direct failure of risk-based conditional
    access policies. If an authentication succeeds from an IP known to be malicious
    (e.g., a TOR node, known C2), it suggests a policy is misconfigured, disabled,
    or has been maliciously altered to allow the connection, providing the adversary
    with a persistent foothold.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Threat Intelligence Platforms
  range: last 90 days
  queries:
  - 'SEARCH successful_logins | JOIN source_ip with threat_intel_feed | WHERE risk_reputation
    = ''high'' | ALERT'
- question: Are there successful logins from IPs with a risk score that is anomalously
    high compared to the organizational baseline?
  context: This question moves beyond a simple blocklist to detect "gray" area threats.
    By establishing a dynamic threshold based on the organization's recent login
    risk profile (e.g., the 99th percentile), it can flag logins that are unusually
    risky even if the source IP isn't on a known-bad list. A success under these conditions
    points to a policy bypass.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Threat Intelligence Platforms
  range: last 90 days
  queries:
  - SEARCH successful_logins | ENRICH source_ip with risk_score | CALCULATE 99th_percentile_risk_score
    over 24h | WHERE login_risk_score > 99th_percentile_risk_score | ALERT
- question: Has a machine learning model identified a successful login as having
    a high probability of being malicious?
  context: This question leverages machine learning to find complex patterns that
    simple rules might miss. A model trained on features like IP geolocation, ASN,
    time of day, and user behavior can identify a login as highly suspicious. If such
    a high-probability login was authenticated successfully, it strongly indicates
    that the conditional access policy failed to evaluate the risk correctly.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Threat Intelligence Platforms
  range: last 90 days
  queries:
  - SEARCH successful_logins | APPLY classification_model | WHERE prediction_probability
    > 0.9 | ALERT
- question: Are successful external logins originating from Autonomous Systems (ASNs)
    not on the approved corporate allow-list?
  context: This question helps detect when an adversary adds a new, overly-permissive
    'trusted location' to a conditional access policy. By comparing the source ASN
    of every successful external login against a curated list of expected ASNs (corporate
    offices, VPNs, partners), any login from an unapproved ASN immediately flags a
    potential policy manipulation.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - AWS CloudTrail logs
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Network Gateway
  - Cloud IAM configuration portals
  range: last 90 days
  queries:
  - SEARCH successful_logins | LOOKUP source_asn | WHERE source_asn NOT IN approved_asn_list
    | ALERT
- question: Has a user's login activity suddenly consolidated to a new and organizationally-rare
    ASN?
  context: This question looks for behavioral shifts that suggest a compromised account
    is now being used from a new adversary-controlled location. A sharp decrease
    in the diversity (Shannon entropy) of a user's source ASNs, coupled with the
    new dominant ASN being rare across the organization, is a strong signal that
    a new 'trusted location' has been added for that user's benefit.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - AWS CloudTrail logs
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Network Gateway
  - Cloud IAM configuration portals
  range: last 90 days
  queries:
  - FOR each user | CALCULATE rolling_24h_entropy of source_asns | ALERT on sharp_decrease
    AND new_asn is rare_globally
- question: Is there a statistically significant and anomalous spike in successful
    logins from a new or rarely used ASN?
  context: This question uses time-series forecasting to detect the emergence of
    a new access pattern. For any given ASN, especially a new one, the expected number
    of logins is zero or very low. If a forecasting model (like ARIMA) predicts a
    near-zero count but the actual observed count is significantly higher, it flags
    an anomaly pointing to a newly added and exploited trusted location.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - AWS CloudTrail logs
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Network Gateway
  - Cloud IAM configuration portals
  range: last 90 days
  queries:
  - FOR each asn | FORECAST login_counts with ARIMA | WHERE actual_count > forecast_plus_confidence_interval
    | ALERT
- question: Are users in MFA-required groups successfully logging in without completing
    an MFA challenge?
  context: This is a direct check for MFA bypass. If a user is part of a group for
    which MFA is mandatory, any successful login that does not have a corresponding
    MFA success event in the logs within a short time window indicates a policy failure
    or misconfiguration, potentially allowing an attacker to persist with only a password.
  answer_sources:
  - Entra ID Sign-in logs
  - Okta System Log
  - Windows ADFS Event Logs
  - Windows Event ID 4624
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Active Directory Federation Services (ADFS) Servers
  - RADIUS Servers
  range: last 90 days
  queries:
  - SEARCH successful_logins for mfa_required_user | WHERE no_mfa_event within 5_minutes
    | ALERT
- question: Has the ratio of MFA-enforced logins for a critical user group dropped
    significantly below its historical baseline?
  context: This question aims to detect subtle, large-scale policy changes. An attacker
    might not disable MFA entirely but could add an exclusion (e.g., a new 'trusted'
    IP range) that weakens it. Monitoring the ratio of MFA-enforced logins to total
    logins for a group and alerting on a statistically significant drop (e.g., 3 standard
    deviations) can reveal such a weakening of security posture.
  answer_sources:
  - Entra ID Sign-in logs
  - Okta System Log
  - Windows ADFS Event Logs
  - Windows Event ID 4624
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Active Directory Federation Services (ADFS) Servers
  - RADIUS Servers
  range: last 90 days
  queries:
  - FOR each user_group | CALCULATE daily_mfa_ratio | BASELINE mfa_ratio over 7_days
    | WHERE current_ratio < (mean - 3 * stdev) | ALERT
- question: Has an anomaly detection model detected an unusual change in the MFA
    enforcement ratio for critical user groups?
  context: This question uses machine learning to automatically detect abnormal drops
    in MFA enforcement that might not be caught by simple standard deviation checks.
    A model like Isolation Forest can learn the normal daily and weekly fluctuations
    in the MFA ratio and will flag any sudden, unexpected drop as an anomaly, indicating
    a potential malicious policy modification.
  answer_sources:
  - Entra ID Sign-in logs
  - Okta System Log
  - Windows ADFS Event Logs
  - Windows Event ID 4624
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Active Directory Federation Services (ADFS) Servers
  - RADIUS Servers
  range: last 90 days
  queries:
  - FOR each user_group | APPLY anomaly_detection_model to mfa_ratio_timeseries |
    ALERT on anomalous_points
- question: Are successful logins occurring from devices with client fingerprints
    (JA3, User-Agent) that are not on the approved list for corporate assets?
  context: This question checks for violations of device compliance policies. If conditional
    access is configured to only allow managed devices, then a successful login from
    a device with an unknown or non-standard TLS fingerprint (JA3) or User-Agent
    string suggests that this policy has been bypassed or weakened, allowing an attacker's
    machine to connect.
  answer_sources:
  - Zeek http.log
  - Zeek ssl.log
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Cloud Application Frontends
  - VPN Portals
  - Endpoint Devices
  - Web Proxies
  range: last 90 days
  queries:
  - SEARCH successful_logins | JOIN with network_traffic | WHERE ja3_hash OR user_agent
    NOT IN approved_fingerprint_list | ALERT
- question: Are successful logins happening with exceptionally rare client fingerprints?
  context: This question uses statistical rarity to find suspicious devices. An attacker
    might use a custom tool or an unusual browser configuration, resulting in a unique
    client fingerprint. A successful login from a device whose fingerprint is seen
    in less than 0.1% of all authentications is highly anomalous and points to a non-compliant
    device that has bypassed policy.
  answer_sources:
  - Zeek http.log
  - Zeek ssl.log
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Cloud Application Frontends
  - VPN Portals
  - Endpoint Devices
  - Web Proxies
  range: last 90 days
  queries:
  - CALCULATE rarity of all ja3_hashes and user_agents | SEARCH successful_logins
    | WHERE fingerprint_rarity < 0.001 | ALERT
- question: Has a cluster of successful logins with unusual, shared characteristics
    (fingerprint, IP, time) been identified?
  context: This question uses unsupervised machine learning to find groups of related
    malicious activity. A clustering algorithm can group logins based on multiple
    features. A small, dense cluster of successful logins that all share an unusual
    User-Agent, come from a strange IP block, and occur at odd hours could represent
    an attacker's toolset being used against multiple accounts, indicating a successful,
    widespread bypass of device policies.
  answer_sources:
  - Zeek http.log
  - Zeek ssl.log
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Cloud Application Frontends
  - VPN Portals
  - Endpoint Devices
  - Web Proxies
  range: last 90 days
  queries:
  - CLUSTER successful_logins on (user_agent, ja3, ip, time) | IDENTIFY small, dense
    clusters with unusual features | ALERT
- question: Are successful authentications occurring from IP addresses or countries
    that are on an explicit deny list?
  context: This question checks for a direct and critical failure of a core defense
    policy. If a login succeeds from a source that is explicitly blocked by a deny
    list, it signifies that the policy is either disabled, misconfigured, or has been
    maliciously modified to allow the attacker access, representing a clear case
    of defense evasion.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - SEARCH successful_logins | WHERE source_ip IN deny_list OR source_country IN
    deny_list | ALERT
- question: Is the count of successful logins from a deny-listed location greater
    than zero?
  context: This question frames the deny list policy as a statistical baseline. The
    expected number of successful logins from a blocked IP range or country is zero.
    Any observed login count greater than zero is, by definition, a statistically
    significant deviation from the policy and constitutes a high-fidelity alert for
    a policy bypass.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - MONITOR successful_login_counts from deny_listed_locations | WHERE count > 0 |
    ALERT
- question: Did a successful login occur that a predictive model, trained on policy
    rules, identified as one that should have been blocked?
  context: This question uses a model as a "digital twin" of the intended policy.
    A simple classifier is trained to replicate the deny list logic. When a real-world
    successful login is fed to the model and the model predicts it should have been
    denied, this discrepancy highlights a "false negative" in the real policy's enforcement,
    indicating it was evaded.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - SEARCH successful_logins | APPLY policy_classifier_model | WHERE model_prediction
    = 'deny' | ALERT
- question: Are successful logins originating from non-sanctioned public cloud IP
    ranges?
  context: Attackers often use VMs in public clouds (AWS, Azure, GCP) to source their
    attacks, bypassing simple geo-fencing or IP reputation blocks. This question
    aims to detect this by checking if a successful login comes from a cloud provider's
    IP range that is not part of the organization's own sanctioned cloud infrastructure.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4624
  - AWS CloudTrail logs
  - GCP Audit Logs
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Public Cloud Tenant (AWS, Azure, GCP)
  range: last 90 days
  queries:
  - SEARCH successful_logins | ENRICH source_ip with cloud_provider_info | WHERE
    is_cloud_ip = true AND ip_range NOT IN sanctioned_list | ALERT
- question: Is a user exhibiting an anomalous amount of login activity from non-sanctioned
    cloud providers compared to their own baseline or their peers?
  context: This question establishes a behavioral baseline for individual users,
    where logins from non-sanctioned cloud IPs should be rare or non-existent. An
    alert is triggered if this activity for a single user suddenly exceeds a threshold
    (e.g., 5% of their logins) or is a statistical outlier, suggesting their account
    may be compromised and used from an attacker's cloud VM.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4624
  - AWS CloudTrail logs
  - GCP Audit Logs
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Public Cloud Tenant (AWS, Azure, GCP)
  range: last 90 days
  queries:
  - FOR each user | CALCULATE proportion_of_logins_from_unsanctioned_cloud_ips | WHERE
    proportion > threshold OR is_outlier | ALERT
- question: Has an anomaly detection model detected a sudden spike in the overall
    volume of logins from non-sanctioned cloud providers?
  context: This question monitors the aggregate threat landscape. The normal volume
    of successful logins from unauthorized cloud IPs should be near-zero. A time
    series model can learn this baseline and automatically detect a sudden spike
    in this activity across the organization, which could indicate a large-scale
    attack or a newly weakened policy being exploited.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4624
  - AWS CloudTrail logs
  - GCP Audit Logs
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Public Cloud Tenant (AWS, Azure, GCP)
  range: last 90 days
  queries:
  - APPLY anomaly_detection_model to timeseries of login_volume_from_unsanctioned_cloud_ips
    | ALERT on anomalous_spikes
- question: Has a single user account successfully logged in from two geographically
    distant locations within an impossible travel time?
  context: This is a classic question for detecting account sharing or compromise.
    By calculating the required travel speed between two consecutive successful login
    locations for the same user, any speed that is physically impossible (e.g., >1000
    km/h) indicates that location-based access controls have been bypassed and the
    account is being used from multiple places simultaneously.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - VPN Concentrators
  - Authentication Servers
  range: last 90 days
  queries:
  - FOR each successful_login | GET previous_login for same_user | CALCULATE distance
    and time_diff | COMPUTE speed | WHERE speed > 1000_kmh | ALERT
- question: Has an impossible travel event been detected based on a statistical outlier
    in travel speeds rather than a fixed threshold?
  context: This question refines the basic impossible travel detection. A fixed speed
    threshold can be too rigid. By calculating the distribution of all inter-login
    travel speeds across the organization, it's possible to identify events that
    are statistical outliers (e.g., in the 99.9th percentile) even if they fall below
    a hardcoded "impossible" speed, accounting for legitimate fast travel while still
    flagging suspicious activity.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - VPN Concentrators
  - Authentication Servers
  range: last 90 days
  queries:
  - CALCULATE distribution of all inter-login_speeds | FOR each new_login | CALCULATE
    speed | WHERE speed > 99.9th_percentile | ALERT
- question: Has a user's login sequence deviated from their normal, learned travel
    patterns in a way that suggests impossible travel?
  context: This question uses more advanced machine learning to understand an individual's
    normal movement patterns. A sequence model (like an LSTM autoencoder) can learn
    a user's typical login locations and transitions. A new login that is poorly
    reconstructed by the model (high reconstruction error) is considered anomalous
    and could represent an impossible travel scenario that simpler methods might
    miss.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Okta System Log
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - VPN Concentrators
  - Authentication Servers
  range: last 90 days
  queries:
  - FOR each user | TRAIN sequence_model on login_location_history | FOR each new_login
    | WHERE reconstruction_error > threshold | ALERT
- question: Has a successful login occurred from a country or ASN where the organization
    has no business operations?
  context: This is a simple but effective rule-based question. By maintaining a list
    of geographic locations or network providers from which no legitimate login should
    ever originate, any successful authentication from a source on this 'zero-login'
    list is an immediate and high-confidence indicator of a compromised account or
    a bypassed policy.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - SEARCH successful_logins | WHERE source_country OR source_asn IN zero_login_list
    | ALERT
- question: Is there a sudden, statistically significant surge in login volume from
    a country or ASN that historically has low or no activity?
  context: This question looks for sudden shifts in login geography. By baselining
    the normal login volume from every country and ASN, it's possible to detect a
    sudden spike (e.g., more than 4 standard deviations above the mean) from a previously
    quiet location. This could indicate an attacker has established a foothold and
    is now using it for access.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - FOR each country/asn | BASELINE hourly_login_counts over 30_days | WHERE current_hour_count
    > (mean + 4 * stdev) | ALERT
- question: Has a change point detection algorithm identified an abrupt and persistent
    shift in login volume from a specific country or ASN?
  context: This question uses specialized algorithms to find lasting changes, filtering
    out brief, random spikes. Change point detection is designed to identify the
    exact moment a time series' statistical properties change. An alert from such
    an algorithm indicates not just a momentary surge, but a new, sustained pattern
    of logins from a location, strongly suggesting a policy has been altered to allow
    it.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Entra ID Sign-in logs
  - Edge Firewalls
  - VPN Concentrators
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - FOR each country/asn | APPLY change_point_detection to login_volume_timeseries
    | ALERT on detected_change_point
- question: Has a successful authentication occurred for a user account that is on
    a list of known-compromised credentials?
  context: This is a critical check for risk-based policy failure. If an identity
    provider is aware that a user's credentials have been breached (e.g., via Entra
    ID Identity Protection), it should block the login or force a password reset.
    A successful login under these circumstances is a high-severity event, indicating
    a critical gap in conditional access policy enforcement.
  answer_sources:
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Okta System Log
  - Authentication Servers (e.g., Domain Controllers)
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Threat Intelligence Platforms
  range: last 90 days
  queries:
  - SEARCH successful_logins | WHERE username IN known_compromised_credential_list
    | ALERT
- question: For a user with known-compromised credentials, was their successful login
    also behaviorally anomalous?
  context: This question adds layers of risk to increase alert fidelity. A successful
    login from a compromised account is bad. A successful login from a compromised
    account that also comes from a new country or at an unusual time for that user
    is significantly worse. Correlating these two types of risk provides a much stronger
    signal that an account is actively being abused and policies have failed.
  answer_sources:
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Okta System Log
  - Authentication Servers (e.g., Domain Controllers)
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Threat Intelligence Platforms
  range: last 90 days
  queries:
  - SEARCH successful_logins | WHERE username IN known_compromised_credential_list
    AND login_behavior is outlier_for_user | ALERT
- question: Has a machine learning model, aware of the user's compromised status,
    flagged a successful login as highly probable to be malicious?
  context: This question leverages a machine learning model that explicitly uses `is_credential_compromised`
    as a feature. When the model assigns a high probability of malice to a successful
    login, it means that other features of the login (IP, time, etc.) in combination
    with the known breach, strongly point to an active compromise that the existing
    conditional access policies failed to stop.
  answer_sources:
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Okta System Log
  - Authentication Servers (e.g., Domain Controllers)
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  - Threat Intelligence Platforms
  range: last 90 days
  queries:
  - SEARCH successful_logins | APPLY classification_model with 'is_compromised' feature
    | WHERE prediction_probability > 0.9 | ALERT
- question: Are successful external logins occurring via legacy authentication protocols
    like POP, IMAP, or SMTP AUTH?
  context: Legacy authentication protocols are a major security risk because they
    cannot enforce MFA. Organizations should have policies to block them entirely.
    This question aims to detect any successful login using these protocols from
    an external source, as it indicates a policy is missing, disabled, or has been
    maliciously modified to allow an attacker a way to bypass MFA.
  answer_sources:
  - Entra ID Sign-in logs
  - Okta System Log
  - Zeek conn.log
  - Windows Event ID 4624
  - Mail Servers (Exchange, O365)
  - Legacy Application Servers
  - Edge Firewalls
  range: last 90 days
  queries:
  - SEARCH successful_logins | WHERE protocol IN ('POP', 'IMAP', 'SMTP_AUTH') AND
    source_ip is external AND source_ip NOT IN exception_list | ALERT
- question: Is there a sudden spike in legacy authentication usage for a specific
    user or for the organization as a whole?
  context: This question looks for changes in protocol usage patterns. A user who
    has never used legacy auth before suddenly doing so is suspicious. Likewise, a
    sudden spike in the organization-wide percentage of legacy authentications could
    indicate a widespread attack (e.g., password spraying against a legacy endpoint)
    or a recent policy change that re-enabled a vulnerable protocol.
  answer_sources:
  - Entra ID Sign-in logs
  - Okta System Log
  - Zeek conn.log
  - Windows Event ID 4624
  - Mail Servers (Exchange, O365)
  - Legacy Application Servers
  - Edge Firewalls
  range: last 90 days
  queries:
  - MONITOR legacy_auth_percentage per user and globally | ALERT on sudden_spike
    or deviation_from_baseline
- question: Has an anomaly detection model flagged a surge in the volume of successful
    legacy authentications?
  context: This question provides automated monitoring for legacy protocol abuse.
    A time series model can learn the normal (ideally, zero) baseline of legacy authentications.
    The model will automatically flag any significant increase, whether a sudden
    spike or a gradual rise, pointing to a potential attack or a weakening of security
    policies that an analyst should investigate.
  answer_sources:
  - Entra ID Sign-in logs
  - Okta System Log
  - Zeek conn.log
  - Windows Event ID 4624
  - Mail Servers (Exchange, O365)
  - Legacy Application Servers
  - Edge Firewalls
  range: last 90 days
  queries:
  - APPLY anomaly_detection_model to timeseries of legacy_auth_volume | ALERT on
    anomalous_points
- question: Has a single external IP address successfully logged into an unusually
    high number of distinct user accounts in a short time?
  context: This question is designed to detect successful password spraying or credential
    stuffing attacks. A single IP authenticating to many accounts (e.g., >10 accounts
    in 1 hour) is not normal user behavior. It strongly suggests an attacker is systematically
    trying a list of credentials and has found a way to bypass policies (like MFA)
    that should prevent this.
  answer_sources:
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Okta System Log
  - Authentication Servers (e.g., Domain Controllers)
  - Web Application Firewalls
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - FROM successful_logins in last 1_hour | GROUP BY source_ip | COUNT distinct users
    | WHERE user_count > 10 AND source_ip is external | ALERT
- question: Is any single IP address responsible for a statistically anomalous number
    of successful logins compared to other IPs?
  context: This question enhances the basic threshold rule by using a dynamic, statistical
    approach. Instead of a fixed number, it identifies attacking IPs by finding which
    ones are outliers (e.g., 4 standard deviations above the mean) in terms of the
    number of accounts they've successfully accessed. This adapts to the organization's
    normal activity levels and is better at finding attackers in noisy environments.
  answer_sources:
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Okta System Log
  - Authentication Servers (e.g., Domain Controllers)
  - Web Application Firewalls
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - CALCULATE stdev of unique_logins_per_ip in last 1_hour | FIND source_ips where
    unique_logins > (mean + 4 * stdev) | ALERT
- question: Has clustering analysis identified a dense group of successful logins
    originating from a single IP to many different user accounts?
  context: This question uses unsupervised machine learning to find attack patterns.
    A clustering algorithm like DBSCAN can group login events. A successful password
    spraying attack would appear as a dense cluster of events sharing the same source
    IP and User-Agent but having many different usernames. Identifying such a cluster
    is a strong indicator of a large-scale attack that has bypassed controls.
  answer_sources:
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Okta System Log
  - Authentication Servers (e.g., Domain Controllers)
  - Web Application Firewalls
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - CLUSTER successful_logins on (source_ip, user_agent) | IDENTIFY dense_clusters
    with high unique_user_count | ALERT
- question: Was a high number of failed login attempts for a user from a specific
    IP immediately followed by a successful login from that same IP?
  context: This question looks for the classic pattern of a brute-force or password
    guessing attack culminating in success. A stateful rule that correlates a burst
    of failures (e.g., >20 failures) with a subsequent success from the same user/IP
    pair within minutes is a strong indicator that the attacker has guessed the password
    and any lockout or risk-based policies have failed.
  answer_sources:
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Authentication Servers (e.g., Domain Controllers)
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - TRACK failed_logins per user/ip | IF failure_count > threshold AND success occurs
    from same user/ip within 15_mins | ALERT
- question: Following a brute-force attempt, did the successful login also exhibit
    anomalous characteristics for that user?
  context: This question adds more evidence to the brute-force success pattern. If,
    after a flurry of failed logins, the final successful login is also from a new
    country, a rare ASN, or at an unusual time for that specific user, the likelihood
    of a compromise is extremely high. It suggests the attacker not only guessed
    the password but also bypassed behavioral anomaly detection.
  answer_sources:
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Authentication Servers (e.g., Domain Controllers)
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - ON brute_force_detection | SCORE subsequent_success against user_behavioral_baseline
    | IF score is high_anomaly | ALERT
- question: Has a sequence model detected a low-probability transition from a 'failed
    login spree' state to an 'anomalous success' state for a user?
  context: This question uses a state-based model (HMM) to understand the sequence
    of events. The model learns the normal transitions between login states (e.g.,
    'Normal Login' -> 'Normal Login'). A transition from a state representing a brute-force
    attack ('Failed Login Spree') to a state representing an unusual success ('Anomalous
    Success') would be identified as a very rare and suspicious sequence, flagging
    a likely compromise and policy failure.
  answer_sources:
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Entra ID Sign-in logs
  - Authentication Servers (e.g., Domain Controllers)
  - Cloud Identity Provider Portals (e.g., Entra ID, Okta)
  range: last 90 days
  queries:
  - MODEL login_sequences with HMM | DETECT low_probability_transition from 'failed_spree'
    state to 'anomalous_success' state | ALERT