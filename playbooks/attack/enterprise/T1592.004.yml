name: "T1592.004: Client Configurations"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps determine if an adversary is actively gathering client configuration details for targeting. This involves detecting outbound network connections to known malicious infrastructure, identifying HTTP requests with fingerprinting signatures, spotting network scanning behavior, flagging anomalous traffic patterns like unusual Client-Hint headers or DNS query rates, and correlating local system reconnaissance command execution with subsequent outbound network activity."
type: "technique"
related:
  - "TA0043: Reconnaissance"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are internal hosts connecting to known malicious domains or IPs associated with reconnaissance campaigns?"
    context: "This question aims to detect initial reconnaissance activity by cross-referencing outbound network connections with a high-confidence threat intelligence feed. A match indicates a potential compromise or targeted reconnaissance, as the destination is already associated with malicious infrastructure used for phishing or client fingerprinting."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Corporate web proxy, DNS resolvers, and network egress points."
    range: "last 90 days"
    queries:
      - "Symbolic: SEARCH Zeek logs WHERE destination_ip OR destination_domain IN threat_intel_feed"
  - question: "Is any host connecting to multiple rare and newly registered domains, suggesting targeted reconnaissance?"
    context: "Adversaries often use newly registered domains (NRDs) for short-lived campaigns. This question identifies hosts connecting to domains that are both statistically rare within the organization and recently created. A cluster of such connections from a single host is a strong indicator of sophisticated, targeted reconnaissance attempts trying to evade reputation-based blocking."
    answer_sources:
      - "Zeek dns.log"
      - "Corporate web proxy, DNS resolvers, and network egress points."
    range: "last 90 days"
    queries:
      - "Statistical: CALCULATE domain rarity from DNS logs. IF domain is rare AND newly registered, SCORE risk. ALERT if host's cumulative risk score exceeds threshold in 5 mins."
  - question: "Are hosts attempting to resolve domains generated by a Domain Generation Algorithm (DGA), indicative of malware C2 communication?"
    context: "This question uses a machine learning model to detect connections to algorithmically generated domains. DGAs are commonly used by malware to dynamically find command and control (C2) servers. Detecting such queries helps identify infected hosts that are part of a botnet or under an adversary's control, even if the specific domains are not yet on a threat feed."
    answer_sources:
      - "Zeek dns.log"
      - "Corporate web proxy, DNS resolvers, and network egress points."
    range: "last 90 days"
    queries:
      - "Machine Learning: FOR each domain in DNS logs, CLASSIFY with DGA model. INVESTIGATE hosts querying high-confidence DGA domains."
  - question: "Are outbound HTTP requests containing URI patterns or script names associated with known client fingerprinting toolkits?"
    context: "This question looks for specific, known indicators of client fingerprinting scripts (like ScanBox) within HTTP traffic. Detecting these signatures, such as 'fingerprint.js' or unique URI parameters, provides direct evidence that an adversary is actively profiling the client's browser, plugins, and software configuration for vulnerability analysis."
    answer_sources:
      - "Zeek http.log"
      - "Corporate web proxy, network egress points, and any device capable of making outbound HTTP requests."
    range: "last 90 days"
    queries:
      - "Symbolic: SEARCH HTTP logs FOR URIs or request bodies matching known fingerprinting regex patterns. ALERT if multiple signatures are seen from same client/destination."
  - question: "Do any outbound HTTP requests have an unusually high URI query string entropy, potentially indicating exfiltration of fingerprinted data?"
    context: "Fingerprinting scripts often encode collected client data into a long, complex URI query string for exfiltration. This question identifies such activity by detecting statistical anomalies in URI entropy. A sudden spike above a user's or destination's baseline suggests an abnormal, programmatically generated request rather than typical user browsing."
    answer_sources:
      - "Zeek http.log"
      - "Corporate web proxy, network egress points, and any device capable of making outbound HTTP requests."
    range: "last 90 days"
    queries:
      - "Statistical: CALCULATE URI entropy for HTTP requests. ESTABLISH baseline per user/destination. ALERT if entropy exceeds 99th percentile of baseline."
  - question: "Can we use machine learning to identify suspicious HTTP requests that are likely related to client fingerprinting?"
    context: "This question leverages a machine learning classifier to distinguish malicious fingerprinting requests from benign traffic based on a combination of features like URI length, parameter count, and User-Agent anomalies. This approach can detect novel or obfuscated fingerprinting techniques that might evade simpler signature or statistical-based methods."
    answer_sources:
      - "Zeek http.log"
      - "Corporate web proxy, network egress points, and any device capable of making outbound HTTP requests."
    range: "last 90 days"
    queries:
      - "Machine Learning: EXTRACT features from HTTP logs. SCORE requests using a trained classifier model. FLAG suspicious requests for investigation."
  - question: "Are any known malicious scanners or TOR exit nodes attempting to connect to our internal network?"
    context: "This question aims to proactively identify and block reconnaissance scans from sources that are already known to be malicious. By checking all inbound connection attempts against a threat intelligence feed of scanners and TOR nodes, we can detect the earliest stages of network mapping before a more targeted attack occurs."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek weird.log"
      - "External-facing firewalls, DMZ network segments, and VPN concentrators."
    range: "last 90 days"
    queries:
      - "Symbolic: SEARCH inbound connection logs WHERE source_ip IN malicious_scanner_or_TOR_feed. ALERT on any match."
  - question: "Is any single external IP address scanning multiple internal hosts or ports in a short time frame?"
    context: "This question identifies active scanning behavior by looking for statistical outliers in inbound connection patterns. An external IP connecting to an abnormally high number of unique hosts or ports deviates significantly from normal traffic and is a classic indicator of an adversary performing network or service discovery against the organization's perimeter."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek weird.log"
      - "External-facing firewalls, DMZ network segments, and VPN concentrators."
    range: "last 90 days"
    queries:
      - "Statistical: AGGREGATE inbound connections by source IP over 1-min window. COUNT unique destination hosts and ports. ALERT if counts exceed 3 standard deviations above the mean."
  - question: "Can we use clustering algorithms to automatically identify and group network scanning activities from inbound traffic logs?"
    context: "This question applies an unsupervised machine learning algorithm (DBSCAN) to automatically find dense clusters of activity characteristic of scanning. This method can effectively separate one-to-many (host scan) or one-to-few-with-many-ports (port scan) patterns from sparse, legitimate traffic without relying on predefined thresholds, allowing for the detection of more subtle scanning techniques."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek weird.log"
      - "External-facing firewalls, DMZ network segments, and VPN concentrators."
    range: "last 90 days"
    queries:
      - "Machine Learning: APPLY DBSCAN clustering to inbound connection logs using source_ip, dest_port, protocol as features. LABEL dense clusters as 'scanning' and investigate."
  - question: "Are clients sending an unusual combination of HTTP Client-Hint headers to non-standard domains?"
    context: "Client-Hint headers can be legitimately used by services to optimize content, but they can also be abused by adversaries to gather detailed client configuration data. This question specifically looks for the combination of multiple `Sec-CH-UA-*` headers being sent to domains not on an allowlist, indicating a high probability of active browser fingerprinting."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Corporate DNS resolvers, web proxies, and endpoint devices."
    range: "last 90 days"
    queries:
      - "Symbolic: SEARCH HTTP logs for requests with 3+ Sec-CH-UA headers to a destination NOT IN allowlist. ALERT on match."
  - question: "Is any client suddenly querying a much higher number of unique domains than its historical baseline?"
    context: "This question aims to detect anomalous DNS behavior on a per-client basis. A sudden, sharp increase in the rate of unique domain lookups for a single host, compared to its own normal activity, can indicate automated behavior such as that caused by a fingerprinting script or other reconnaissance tool running on the endpoint."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Corporate DNS resolvers, web proxies, and endpoint devices."
    range: "last 90 days"
    queries:
      - "Statistical: ESTABLISH 30-day baseline of unique domains queried per minute for each client. ALERT if rate exceeds 98th percentile of its own baseline."
  - question: "Can a time-series anomaly detection model identify sudden changes in a client's DNS query patterns that suggest reconnaissance?"
    context: "This question uses a sophisticated anomaly detection model (LSTM autoencoder) to learn the 'normal' rhythm of a client's DNS activity. The model can then flag significant deviations from this learned pattern, such as the rapid-fire queries characteristic of automated fingerprinting, which would generate a high reconstruction error and trigger an alert."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Corporate DNS resolvers, web proxies, and endpoint devices."
    range: "last 90 days"
    queries:
      - "Machine Learning: MODEL DNS query rate time-series for each client with LSTM autoencoder. ALERT when model's reconstruction error spikes significantly."
  - question: "Are local system reconnaissance commands being executed on a host immediately before it connects to a new external IP address?"
    context: "This question correlates host-based activity with network activity to find strong evidence of compromise. The sequence of running local commands to gather system information (`systeminfo`, `wmic`, etc.) and then immediately making an outbound connection to a never-before-seen IP is a classic pattern of an adversary collecting data and exfiltrating it."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Zeek conn.log"
      - "Standard user endpoints, developer workstations, and servers with interactive user sessions."
    range: "last 90 days"
    queries:
      - "Symbolic: CORRELATE process creation events (systeminfo, wmic) with subsequent (within 60s) outbound network connections from the same host to a new IP address."
  - question: "Are users executing statistically rare command-line arguments related to system enumeration?"
    context: "This question uses TF-IDF to find 'needle in a haystack' command executions. While commands like `wmic` or `reg query` can be used for legitimate administration, certain combinations of arguments are highly unusual in a normal enterprise environment. Flagging these statistically rare command lines, especially when they relate to system enumeration, helps focus analyst attention on suspicious host activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Standard user endpoints, developer workstations, and servers with interactive user sessions."
    range: "last 90 days"
    queries:
      - "Statistical: ANALYZE command-line arguments using TF-IDF. SCORE rarity of arguments/combinations. FLAG commands with rare terms related to system enumeration."
  - question: "Can we detect anomalous sequences of host and network events that deviate from normal operational behavior?"
    context: "This question uses a Hidden Markov Model (HMM) to learn the 'grammar' of normal system activity (e.g., a typical process execution and network connection chain). When a sequence of events occurs that has a very low probability according to the trained model—such as PowerShell spawning `systeminfo` followed by a connection to a new IP—it is flagged as anomalous, indicating a likely intrusion."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Zeek conn.log"
      - "Standard user endpoints, developer workstations, and servers with interactive user sessions."
    range: "last 90 days"
    queries:
      - "Machine Learning: TRAIN HMM on benign sequences of host/network events. APPLY model to new sequences. FLAG sequences with low probability scores as anomalous."