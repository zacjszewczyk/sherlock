name: T1584: Compromise Infrastructure
id: f8a1b2c3-d4e5-4f6a-b7c8-d9e0f1a2b3c4
description: This playbook helps investigate if an adversary has compromised external infrastructure for C2, staging, or other operational purposes. This is identified by monitoring for connections to known malicious destinations, use of malicious TLS certificates, anomalous network protocols or fingerprints (like JA3/JA3S hashes or C2 user-agents), suspicious DNS activity (like DGA or NRD domains), C2-like beaconing behavior (periodic connections), unusual fan-out activity to many unique destinations, and suspicious file transfers to public sharing sites.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
investigative_questions:
  - question: Are internal hosts connecting to external IP addresses, domains, or URLs that are on a threat intelligence watchlist?
    context: This question aims to detect direct communication with known malicious infrastructure. By comparing outbound network traffic against an aggregated list of indicators from threat intelligence feeds, we can identify compromised hosts attempting to connect to C2 servers, malware drop sites, or other adversary-controlled systems. A match provides a high-confidence starting point for an investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Egress network gateways, proxy servers, internal DNS resolvers, and all endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH network_logs WHERE destination IN threat_intel_watchlist AND source IS internal
  - question: Is there an unusually high frequency of connections from an internal host to a known malicious destination?
    context: This question looks for anomalous communication patterns with known-bad destinations. Even a single connection is suspicious, but a sudden increase in frequency can indicate a more active or persistent compromise, such as repeated C2 callbacks or data exfiltration attempts. Using a Z-score helps statistically identify significant deviations from a host's baseline behavior.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Windows Event ID 5156
      - Egress network gateways, proxy servers, internal DNS resolvers, and all endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE frequency_baseline for source-destination pairs; ALERT if current_frequency_to_watchlist_dest > 3 * stdev from baseline
  - question: Can machine learning classify connections to threat-flagged destinations as definitively malicious based on their characteristics?
    context: This question uses a supervised machine learning model to add a layer of analytical rigor. It moves beyond simple watchlist matching by considering multiple features of a connection (port, protocol, data volume) and the indicator itself. This helps to reduce false positives and prioritize alerts by assigning a probability score, focusing analyst attention on the most likely malicious events.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Egress network gateways, proxy servers, internal DNS resolvers, and all endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: PREDICT is_malicious using ML_model on new_connection_features to watchlist_dest; ALERT if probability > 0.90
  - question: Are any internal hosts establishing TLS connections using certificates known to be malicious?
    context: This question focuses on identifying adversary infrastructure by its TLS certificate. Threat actors often reuse certificates across different servers. By matching attributes like the SHA-1 hash or serial number against a threat intelligence watchlist, we can detect connections to C2 infrastructure, even if the IP address or domain is new.
    answer_sources:
      - Zeek ssl.log
      - Network egress points with TLS inspection capabilities, web proxies, and endpoint EDR sensors capable of inspecting TLS traffic.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH tls_logs WHERE certificate_sha1 IN cert_watchlist OR certificate_serial IN cert_watchlist
  - question: Are any TLS connections using unusually rare certificate issuers or subjects within the enterprise?
    context: This question aims to find malicious certificates that are not yet on a watchlist by identifying statistical anomalies. Legitimate services typically use certificates from common, well-known issuers. A certificate with a very rare issuer or subject is suspicious and may indicate a self-signed certificate or one from a less-common provider used by an adversary.
    answer_sources:
      - Zeek ssl.log
      - Network egress points with TLS inspection capabilities, web proxies, and endpoint EDR sensors capable of inspecting TLS traffic.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE prevalence of cert_issuer and cert_subject; SCORE connections based on inverse_prevalence; ALERT if score > 99th_percentile
  - question: Can unsupervised machine learning identify clusters of anomalous TLS certificates that may represent unknown malicious infrastructure?
    context: This question uses unsupervised learning to discover novel threats. By clustering certificates based on their technical attributes (validity period, key length, etc.), we can find groups of certificates that behave differently from the norm. These anomalous clusters often represent adversary campaigns using similar TTPs to generate their certificates.
    answer_sources:
      - Zeek ssl.log
      - Network egress points with TLS inspection capabilities, web proxies, and endpoint EDR sensors capable of inspecting TLS traffic.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CLUSTER certificates using DBSCAN on features (validity_period, key_length, etc); INVESTIGATE outlier_clusters
  - question: Are there outbound connections exhibiting known malicious signatures, such as C2 JA3/JA3S hashes, specific C2 User-Agents, or TLS on non-standard ports?
    context: This question seeks to identify malicious activity through well-defined, signature-based rules. These rules detect common adversary TTPs, such as running TLS on an unusual port to evade simple firewalls, or using malware and C2 frameworks with hardcoded JA3/JA3S fingerprints or HTTP headers.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek http.log
      - Egress network gateways, internal network taps, and endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH network_logs WHERE (service IS 'ssl' AND port IS NOT 443) OR (ja3_hash IN c2_fingerprint_list) OR (user_agent IN c2_user_agent_list)
  - question: Are applications communicating over statistically uncommon destination ports?
    context: This question aims to detect services running on non-standard ports by looking for statistical rarity. While some legitimate applications use non-standard ports, adversaries often do so to hide their traffic. Identifying connections to ports that are rarely used across the entire enterprise can surface this type of hidden C2 channel.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek http.log
      - Egress network gateways, internal network taps, and endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE port_distribution for each service; ALERT if connection_port is not in top 99% of common ports for that service
  - question: Has there been a sudden, anomalous spike in the volume of traffic using non-standard ports?
    context: This question moves from detecting individual anomalous connections to detecting a broader campaign. A time-series model learns the normal rhythm of non-standard port usage. A sudden spike that breaks this pattern could indicate a widespread infection or the activation of a large-scale adversary campaign across multiple hosts.
    answer_sources:
      - Zeek conn.log
      - Egress network gateways, internal network taps, and endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FORECAST hourly_count of non-standard_port_connections; ALERT if observed_count > forecasted_upper_bound
  - question: Are internal hosts attempting to resolve and connect to known DGA (Domain Generation Algorithm) or newly registered domains (NRDs)?
    context: This question targets a common malware technique for locating C2 servers. Malware often uses DGAs to generate a large number of potential C2 domains, or uses NRDs to quickly stand up and tear down infrastructure. Alerting on a DNS query for such a domain, followed by a successful connection, is a strong indicator of compromise.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Internal DNS resolvers, DNS forwarders to external resolvers, and network egress points.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH dns_logs for query in (dga_list OR nrd_list); CORRELATE with connection_logs to resolved_ip; ALERT on match
  - question: Are hosts resolving domains that appear to be algorithmically generated based on high character randomness (entropy)?
    context: This question provides a way to detect potential DGA domains without relying on a pre-existing list. DGA domains are often a random-looking jumble of characters, which results in a high Shannon entropy score. By flagging domains with abnormally high entropy compared to a baseline of legitimate traffic, we can discover new or unknown DGAs.
    answer_sources:
      - Zeek dns.log
      - Internal DNS resolvers, DNS forwarders to external resolvers, and network egress points.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE shannon_entropy for all resolved domains; ALERT if entropy_score > 99.5th_percentile of baseline
  - question: Can a machine learning model classify newly observed domains as DGA-generated based on linguistic and structural features?
    context: This question applies a more sophisticated, feature-based machine learning approach to DGA detection. The model can learn the subtle patterns of DGA domains—beyond just entropy—such as domain length, number-to-letter ratio, and n-gram frequencies. This allows for more accurate classification and the detection of more complex DGAs that might evade simpler entropy checks.
    answer_sources:
      - Zeek dns.log
      - Internal DNS resolvers, DNS forwarders to external resolvers, and network egress points.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: PREDICT is_dga using ML_model on new_domain_features; ALERT if classification is 'DGA' with confidence > 0.95
  - question: Is any internal host making highly regular, periodic connections with small payloads to a single external destination, characteristic of C2 beaconing?
    context: This question seeks to identify C2 communications through their classic 'heartbeat' signature. A stateful rule can track the timing and size of connections between a specific host and destination. A consistent time interval (low jitter) combined with small, regular payload sizes is a hallmark of malware beaconing out for commands.
    answer_sources:
      - Zeek conn.log
      - Network egress points, core network switches monitoring server-to-internet traffic, and endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRACK source-destination pairs; ALERT if time_interval is consistent for >5 connections AND payload_size < 2KB
  - question: Are any communication flows between an internal host and an external destination exhibiting abnormally low jitter (low standard deviation in connection timing)?
    context: This question uses a statistical approach to find machine-like communication regularity. Human-generated traffic is typically bursty and irregular. By calculating the standard deviation of time between connections, we can quantify this 'jitter'. An extremely low standard deviation indicates a highly periodic, automated process, such as C2 beaconing.
    answer_sources:
      - Zeek conn.log
      - Network egress points, core network switches monitoring server-to-internet traffic, and endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE stdev of time_deltas between connections for each source-dest pair; ALERT if stdev < 2nd_percentile
  - question: Can a signal processing technique like Fast Fourier Transform (FFT) detect strong periodic signals in a host's connection timeline, indicating beaconing?
    context: This question applies a powerful signal processing technique to find hidden periodicities. FFT transforms a time series of connection events into the frequency domain. A strong peak in the frequency domain reveals a dominant, repeating cycle, even if it's obscured by other network noise. This can reliably detect beaconing at various intervals.
    answer_sources:
      - Zeek conn.log
      - Network egress points, core network switches monitoring server-to-internet traffic, and endpoint devices.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY FFT to connection_event_timeseries for each host; ALERT if strong peak is detected in frequency domain
  - question: Has any internal host connected to an abnormally large number of unique external destinations in a short time frame?
    context: This question aims to detect scanning or fan-out activity using a simple, high-volume threshold. An attacker might use a compromised host to scan for other vulnerable systems, or a botnet C2 might issue commands to many bots simultaneously. A hard threshold provides a basic but effective tripwire for this kind of widespread activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Endpoint devices, servers with direct outbound internet access (e.g., in a DMZ), and cloud virtual machines.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: COUNT unique destination_ips per source_host in 10-min window; ALERT if count > 200 AND dest_port NOT IN (80, 443)
  - question: Is any host connecting to a number of unique destinations that is statistically anomalous compared to its own historical baseline?
    context: This question refines the detection of fan-out activity by creating a personalized baseline for each host. Some hosts, like web proxies, are expected to connect to many destinations. By using a Z-score (standard deviations from the mean), we can detect when a host, regardless of its role, dramatically changes its behavior, which is a more reliable indicator of compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Endpoint devices, servers with direct outbound internet access (e.g., in a DMZ), and cloud virtual machines.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE baseline (mean, stdev) of unique_dest_count per hour for each host; ALERT if current_count > mean + 4*stdev
  - question: Can a change point detection algorithm identify an abrupt, statistically significant increase in a host's fan-out connection rate?
    context: This question uses an advanced statistical method to detect the exact moment a host's behavior changes. Unlike a rolling average, change point detection algorithms are designed to find sudden shifts in a time series' statistical properties. This can pinpoint the start of a scanning or command distribution event with high precision.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Endpoint devices, servers with direct outbound internet access (e.g., in a DMZ), and cloud virtual machines.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY change_point_detection to timeseries of unique_dest_count per minute for each host; ALERT on positive change point
  - question: Are files being transferred to or from public file-sharing sites from sensitive network zones, or are the files themselves of a suspicious type (e.g., executables, scripts)?
    context: This question focuses on data exfiltration or malware staging through common file-sharing services. It combines context (is the host a critical server?) with content inspection (is the file an executable or script?). An alert on either condition, especially a combination, is a strong indicator of unauthorized activity.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Critical assets (Domain Controllers, database servers, code repositories), endpoints of privileged users, and network egress points with file inspection capabilities.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH connection_logs WHERE destination in file_sharing_list AND (source in critical_subnet OR file_type in suspicious_type_list)
  - question: Are users transferring file types to file-sharing sites that are unusual for their peer group or department?
    context: This question seeks to identify anomalous behavior by comparing a user's activity to that of their peers. For example, it's normal for developers to use GitHub, but it might be highly unusual for someone in HR. By baselining activity by user group, we can detect outlier behavior that might indicate a compromised account being used for staging or exfiltration.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Network egress points with file inspection capabilities.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE baseline of file_types per user_group; ALERT if transferred_file_type is rare (<5th percentile) for that user's group
  - question: Can an anomaly detection model (One-Class SVM) identify file transfers to public sites that deviate from the normal, established profile of activity?
    context: This question uses unsupervised machine learning to build a complex model of 'normal' file transfer activity, incorporating features like source, time of day, file type, and size. Any transfer that falls outside this multi-dimensional 'normal' boundary is flagged as an anomaly, allowing for the detection of novel or sophisticated exfiltration techniques that might evade simpler rules.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek files.log
      - Network egress points with file inspection capabilities.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN one-class_SVM on normal_file_transfers; PREDICT and ALERT on new transfers identified as outliers