name: T1021: Remote Services
id: a8d1c9e8-dbf2-4f4d-8b2c-7e6a5f01b2a3
description: This playbook helps investigate potential lateral movement by an adversary using remote services like RDP, SSH, or WinRM. It focuses on detecting remote connections from compromised hosts, the execution of lateral movement tools shortly after a remote login, first-time or statistically rare connections between hosts, fan-out activity where one host connects to many others, and the use of non-standard ports for remote services.
type: technique
related:
  - TA0008: Lateral Movement
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are hosts from our watchlist of compromised or suspicious systems successfully making remote service connections (RDP, SSH, WinRM) to other internal systems?
    context: This question is critical for detecting known-bad actors attempting to expand their foothold. A successful connection from a watchlisted host is a strong indicator of active lateral movement and requires immediate investigation to contain the breach.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs on Domain Controllers
      - Network traffic logs from core switches and perimeter firewalls
      - Security event logs on Tier 0/1 servers and Privileged Access Workstations (PAWs).
    range: Last 90 days
    queries:
      - pseudocode: SEARCH (AuthenticationLogs OR NetworkLogs) WHERE (EventID=4624 AND LogonType=10) OR (dest_port IN {3389, 22, 5985, 5986}) AND source_ip IN (Watchlist) | RETURN source_ip, dest_ip, user, timestamp
  - question: Is there a statistically significant spike in the number of outbound remote service connections from a host on our suspicious watchlist?
    context: This question helps detect automated or scripted lateral movement activity. Adversaries often use scripts to rapidly probe or connect to multiple systems. A sudden, anomalous increase in connection attempts from a single compromised host, compared to its own baseline, can reveal this type of behavior which might otherwise be lost in overall network noise.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs on Domain Controllers
      - Network traffic logs from core switches and perimeter firewalls
      - Security event logs on Tier 0/1 servers and Privileged Access Workstations (PAWs).
    range: Last 90 days
    queries:
      - pseudocode: FOR host IN (Watchlist) | BASELINE hourly_connection_count over 30d | COMPARE current_hourly_count to baseline | ALERT if current_count > (mean + 3 * stdev)
  - question: Can we use a machine learning model to predict if a new remote connection from a watchlist host is malicious based on historical patterns?
    context: This leverages machine learning to proactively identify malicious lateral movement. By training a model on features of known-good and known-bad connections (like user privileges, time of day, subnets), we can score new connections in real-time. This provides a more nuanced detection capability than simple rule-based alerts, helping to prioritize the most suspicious activities.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs on Domain Controllers
      - Network traffic logs from core switches and perimeter firewalls
      - Security event logs on Tier 0/1 servers and Privileged Access Workstations (PAWs).
    range: Last 90 days
    queries:
      - pseudocode: INPUT new_connection_features (user_priv, time_of_day, protocol) | APPLY classification_model | ALERT if prediction_confidence is high
  - question: Is a known lateral movement tool (like psexec.exe, wmic.exe) or a suspicious command being executed on a host within five minutes of a remote login?
    context: This question aims to find direct evidence of an adversary's post-login actions. The tight time correlation between a remote login and the execution of a tool commonly used for lateral movement is a very high-fidelity indicator that the remote session is being used for malicious purposes.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Process and command-line logs on Domain Controllers, Member Servers, Application Servers, and Privileged Access Workstations.
    range: Last 90 days
    queries:
      - pseudocode: JOIN (EventID=4624 AND LogonType IN {3, 10}) with (EventID=4688) on hostname within 5m | FILTER process_name matches (psexec.exe, wmic.exe) OR command_line matches (powershell.exe -enc, net.exe use) | ALERT on match
  - question: Does a command line executed shortly after a remote login show a high degree of randomness or entropy, suggesting obfuscation?
    context: Adversaries often encode or obfuscate their commands (e.g., using PowerShell's -enc flag) to evade simple signature-based detection. High entropy is a mathematical indicator of randomness. By flagging commands with unusually high entropy scores post-login, we can detect these evasion techniques even if the specific command is unknown.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Process and command-line logs on Domain Controllers, Member Servers, Application Servers, and Privileged Access Workstations.
    range: Last 90 days
    queries:
      - pseudocode: JOIN (EventID=4624) with (EventID=4688) on hostname within 5m | CALCULATE Shannon_entropy(command_line) | ALERT if entropy > baseline_95th_percentile
  - question: Is the sequence of commands and processes being executed after a remote login anomalous compared to the user's typical behavior?
    context: This question addresses the behavioral aspect of an attack. A user, like a domain administrator, typically performs a predictable set of actions after logging in remotely. An LSTM or similar model can learn these normal sequences. If an attacker compromises the account and starts running unusual discovery commands (like whoami, ipconfig), the model will flag this sequence as a deviation, indicating a potential compromise.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Process and command-line logs on Domain Controllers, Member Servers, Application Servers, and Privileged Access Workstations.
    range: Last 90 days
    queries:
      - pseudocode: INPUT process_sequence_after_login | APPLY sequence_anomaly_model | ALERT if sequence is anomalous
  - question: Has a remote service connection just occurred between a user, source host, and destination host for the very first time in the last 90 days?
    context: Adversaries establishing a foothold or moving laterally will necessarily create connections that have never been seen before. While not always malicious, a 'first-time' connection is an important investigative lead. Tracking these events allows analysts to build a picture of network activity and spot unusual new communication paths that warrant further scrutiny.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs from Domain Controllers and member servers
      - VPN concentrator logs
      - Cloud IaaS access logs
      - network flow data from all internal network segments.
    range: Last 90 days
    queries:
      - pseudocode: FOR new_connection (user, src, dst, proto) | CHECK against historical_table_90d | IF not found | ALERT as 'first-time access'
  - question: Is a new remote login event statistically rare compared to all other connections observed in the network over the last 30 days?
    context: This question moves beyond simple 'first-time' analysis to identify connections that happen, but very infrequently. By modeling the network as a graph and weighting connections by frequency, we can assign a rarity score to every new login. A login that falls in the top percentile of rarity (e.g., top 2%) is highly unusual and could signify an adversary using a less-common pathway to avoid detection.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs from Domain Controllers and member servers
      - VPN concentrator logs
      - Cloud IaaS access logs
      - network flow data from all internal network segments.
    range: Last 90 days
    queries:
      - pseudocode: BUILD connection_graph over 30d | CALCULATE rarity_score for new_connection | ALERT if rarity_score > 98th_percentile
  - question: Does a recent remote login represent a significant deviation from a user's established pattern of remote access behavior?
    context: This question uses unsupervised machine learning to baseline a user's entire remote access profile (hosts they access, protocols, times). If a new login is so different from their past behavior that it doesn't fit into their normal 'cluster' of activity, the algorithm flags it as an outlier or 'noise'. This is a powerful way to detect account compromise, as an attacker's usage will likely not match the legitimate user's profile.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs from Domain Controllers and member servers
      - VPN concentrator logs
      - Cloud IaaS access logs
      - network flow data from all internal network segments.
    range: Last 90 days
    queries:
      - pseudocode: CLUSTER user_behavior_vectors | FOR new_login, update user_vector | RE-CLUSTER | ALERT if user is now 'noise' point
  - question: Did a host, after receiving a remote connection, initiate more than five outbound remote connections to unique hosts within the next hour?
    context: This identifies a classic adversary 'fan-out' or 'pivot' behavior. After compromising a single host, an attacker will often use it as a staging point to connect to many other systems in the same network segment. A simple threshold rule can effectively detect this initial burst of lateral movement from a newly established pivot point.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network traffic sensors capturing East-West traffic at VLAN or subnet boundaries
      - network flow logs
      - endpoint security logs across all server and workstation segments.
    range: Last 90 days
    queries:
      - pseudocode: ON remote_login_to(host) | MONITOR outbound_remote_connections from host for 60m | COUNT unique_destinations | ALERT if count > 5
  - question: Is a host initiating an abnormally high number of outbound remote connections compared to its own typical behavior?
    context: This refines the simple threshold approach by creating a personalized baseline for each host. A server that normally connects to 20 other hosts might not be anomalous, but a workstation that normally connects to zero and suddenly connects to 5 is highly suspicious. Comparing activity to the host's own 99th percentile helps to identify what is truly anomalous for that specific system, reducing false positives.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network traffic sensors capturing East-West traffic at VLAN or subnet boundaries
      - network flow logs
      - endpoint security logs across all server and workstation segments.
    range: Last 90 days
    queries:
      - pseudocode: FOR each host, BASELINE outbound_connection_count_per_hour over 30d | COMPARE current_hour_count to baseline | ALERT if count > 99th_percentile
  - question: Is the number of outbound lateral connections from a host significantly higher than what a time-series model would have predicted for this hour?
    context: This question applies advanced time-series analysis to detect fan-out behavior. An ARIMA model can learn trends and seasonality in a host's connection patterns (e.g., more activity during business hours). If the actual number of connections in a given hour dramatically exceeds the model's forecast, it suggests an unpredicted event, such as an adversary-driven lateral movement spree.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network traffic sensors capturing East-West traffic at VLAN or subnet boundaries
      - network flow logs
      - endpoint security logs across all server and workstation segments.
    range: Last 90 days
    queries:
      - pseudocode: FOR each host, FORECAST expected_connections for next hour using ARIMA model | COMPARE actual_connections to forecast | ALERT if actual > confidence_interval
  - question: Are we observing remote service traffic (like RDP or SSH) on ports other than the ones officially approved for use in our environment?
    context: This is a fundamental security hygiene check. Adversaries may use non-standard ports to bypass simple firewall rules or hide their activity. By defining and enforcing an explicit allow-list of (protocol, port) combinations, any deviation from this list becomes a high-confidence indicator of unauthorized or malicious activity.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek ssh.log
      - Zeek dce_rpc.log
      - Network Security Monitoring sensors at key network chokepoints, core switches, datacenter firewalls, and VPC flow logs in cloud environments.
    range: Last 90 days
    queries:
      - pseudocode: ANALYZE traffic using protocol decoders (RDP, SSH) | IF (protocol is RDP and dest_port is not 3389) OR (protocol is SSH and dest_port is not 22) | ALERT | ALSO, MONITOR conn.log for traffic on non-allowlisted ports
  - question: Is a remote service port being used that is statistically rare across the entire enterprise over the last 30 days?
    context: This question helps find needles in the haystack. While some non-standard ports might be used for legitimate but undocumented purposes, a port that is used very rarely (e.g., less than 10 times in a month across the whole organization) is highly suspicious and could point to a custom tool or a specific adversary technique being used in a targeted fashion.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek ssh.log
      - Zeek dce_rpc.log
      - Network Security Monitoring sensors at key network chokepoints, core switches, datacenter firewalls, and VPC flow logs in cloud environments.
    range: Last 90 days
    queries:
      - pseudocode: AGGREGATE destination_port counts over 30d | FILTER for remote_service_ports | ALERT if count < 10
  - question: Is there a network connection that is so anomalous in its characteristics (port, protocol, byte count, etc.) that an autoencoder model cannot accurately reconstruct it?
    context: This is a sophisticated anomaly detection technique. An autoencoder learns the essence of 'normal' network traffic. When it encounters a connection that doesn't fit this learned pattern—such as RDP traffic tunneled over an unusual port with abnormal byte counts—it will fail to reconstruct it accurately. This 'high reconstruction error' serves as a powerful alert for novel or highly evasive techniques that might bypass other detection methods.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek ssh.log
      - Zeek dce_rpc.log
      - Network Security Monitoring sensors at key network chokepoints, core switches, datacenter firewalls, and VPC flow logs in cloud environments.
    range: Last 90 days
    queries:
      - pseudocode: TRAIN autoencoder_model on normal_connection_vectors | FOR new_connection, calculate reconstruction_error | ALERT if error is high