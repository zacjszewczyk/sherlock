name: "T1597: Search Closed Sources"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps investigate whether an adversary has leveraged information from closed sources, such as breached credential dumps or technical data leaks, to conduct reconnaissance or prepare for initial access. It focuses on detecting credential-based attacks like password spraying and credential stuffing using known-breached accounts, identifying logins to long-dormant accounts, spotting connection attempts to non-public infrastructure, and flagging successful logins that exhibit multiple behavioral anomalies (e.g., unusual location, time, or device)."
type: "technique"
related:
  - "TA0043: Reconnaissance"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are there any successful or failed login attempts from external IP addresses using usernames known to be compromised in previous data breaches?"
    context: "This question aims to directly detect credential stuffing attacks. Adversaries often acquire lists of usernames and passwords from public or private data breaches and test them against an organization's authentication services. A match indicates a high probability that an adversary is attempting to leverage a known-compromised credential to gain unauthorized access."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services (e.g., VPN, OWA, M365)"
      - "Domain Controllers"
      - "Cloud IAM services"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH auth_logs (event_id=4624 OR 4625) WHERE source_ip.is_external=true AND username IN breached_credential_list"
  - question: "Has there been a statistically significant increase in failed login attempts for accounts known to be on breached credential lists?"
    context: "This question seeks to identify brute-force or credential stuffing activity that may not result in an immediate successful login but shows a clear anomalous pattern. By comparing the current rate of failed logins from external sources to a historical baseline, analysts can detect a surge in attack attempts against vulnerable accounts, even if the attacker is rotating through different passwords."
    answer_sources:
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services (e.g., VPN, OWA, M365)"
      - "Domain Controllers"
      - "Cloud IAM services"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "FOR user IN breached_credential_list | CALCULATE z_score(failed_logins_last_24h, baseline_30d) | ALERT if z_score > 3"
  - question: "Can a machine learning model identify malicious login attempts based on features like breach list status, source IP reputation, and time of day?"
    context: "This question proposes a more sophisticated, proactive detection method using machine learning. By training a model on various contextual features (if the account is on a breach list, IP reputation, time, ASN rarity), it can learn the subtle characteristics of malicious login attempts and score new events in real-time. This provides a more nuanced detection capability than simple rule-based alerts."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services (e.g., VPN, OWA, M365)"
      - "Domain Controllers"
      - "Cloud IAM services"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SCORE auth_events using ML_model(features=[is_breached, is_external, time_of_day, source_ASN_rarity, ip_reputation]) | ALERT if score > threshold"
  - question: "Is a single external IP address attempting to log in to a large number of different accounts in a short period?"
    context: "This question is designed to detect password spraying attacks. In this technique, an adversary uses a single password (or a small list of common passwords) against many different usernames. A rule that flags one source IP generating many failed logins for many unique users is a classic indicator of this reconnaissance method."
    answer_sources:
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services"
      - "Perimeter firewalls and network gateways"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH auth_logs (event_id=4625) | GROUP BY source_ip over 10m | COUNT unique usernames | ALERT if unique_username_count > 20"
  - question: "Is there an unusually high degree of randomness in the usernames being targeted for failed logins from a single external IP?"
    context: "This question uses information theory to detect password spraying. A high Shannon entropy value for the set of usernames targeted by a single IP suggests the attacker is cycling through a large and diverse list of users, which is not typical of legitimate, targeted login failures. This statistical approach can identify password spraying that might fly under the radar of simple threshold-based rules."
    answer_sources:
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services"
      - "Perimeter firewalls and network gateways"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "FOR ip IN external_ips | CALCULATE shannon_entropy(target_usernames) over 1h | ALERT if entropy > 99th_percentile_baseline"
  - question: "Can we use clustering algorithms to automatically group and identify password spraying activity from raw authentication logs?"
    context: "This question leverages unsupervised machine learning to find anomalous clusters of activity. A DBSCAN algorithm can group events based on their properties (like source IP, outcome, and username). A cluster representing a single IP, high unique username count, and high failure rate is a strong signature for a password spray, allowing for detection without pre-defined rules."
    answer_sources:
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services"
      - "Perimeter firewalls and network gateways"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "RUN DBSCAN on auth_logs (features=[source_ip, outcome, username_hash]) over 5m | IDENTIFY clusters with single_ip, high_unique_users, high_failures | ALERT"
  - question: "Has a user account that has been inactive for over 90 days suddenly had a successful login, especially from an external IP?"
    context: "This question targets the compromise of dormant accounts. Adversaries may use old, stolen credentials that are still valid for accounts that are no longer in active use. A successful login to such an account is highly suspicious, as there is no legitimate reason for it to be used. Correlating this with an external source IP further increases the likelihood of a compromise."
    answer_sources:
      - "Windows Event ID 4624"
      - "Active Directory User Object Attributes (e.g., lastLogonTimestamp)"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "Active Directory servers"
      - "Externally-facing authentication services"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "CREATE watchlist of users where lastLogon < 90d ago | SEARCH auth_logs (event_id=4624) where user in watchlist AND source_ip.is_external=true | ALERT"
  - question: "Did a recent successful login for a user occur after a period of inactivity that is statistically unusual for that specific user?"
    context: "This question moves beyond a static dormancy threshold (e.g., 90 days) to a user-specific behavioral baseline. Some users log in daily, while others log in weekly or monthly. By calculating a personal baseline for login frequency, we can flag a login that occurs after an unusually long gap for *that* user, which is a more tailored and potentially more accurate indicator of a compromise."
    answer_sources:
      - "Windows Event ID 4624"
      - "Active Directory User Object Attributes (e.g., lastLogonTimestamp)"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "Active Directory servers"
      - "Externally-facing authentication services"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "FOR user | CALCULATE mean and stddev of login_time_deltas | FOR new_login | IF time_since_last_login > mean + 3*stddev | ALERT"
  - question: "Can a time-series anomaly detection model identify a successful login that occurs during a period of predicted inactivity for a user?"
    context: "This question applies advanced time-series analysis to model each user's login rhythm (e.g., seasonality like weekdays vs. weekends). An algorithm like Seasonal-Hybrid ESD can learn this pattern and forecast when logins are expected. A successful login that occurs during a time the model predicts as 'off-hours' or 'inactive' is flagged as a significant anomaly, indicating a potential compromise."
    answer_sources:
      - "Windows Event ID 4624"
      - "Active Directory User Object Attributes (e.g., lastLogonTimestamp)"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "Active Directory servers"
      - "Externally-facing authentication services"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "FOR user | TRAIN time_series_model on login_history | FOR new_login | IF model flags login as anomaly | ALERT"
  - question: "Are external IP addresses attempting to connect to internal or non-public assets that should not be exposed to the internet?"
    context: "This question is focused on detecting network reconnaissance against internal infrastructure. By defining a clear list of assets (IPs, subnets, ports) that should never receive traffic from the public internet, any attempt to connect to them from an external source is an immediate and high-fidelity indicator of malicious scanning or targeted access attempts."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek notice.log"
      - "Network DMZ"
      - "Internal server subnets"
      - "Cloud environment subnets hosting non-public services"
      - "Perimeter firewalls"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "CREATE reference_set of non_public_assets | SEARCH network_logs where source_ip.is_external=true AND destination_ip IN non_public_assets | ALERT"
  - question: "Has a single external IP address made an unusual number of connection attempts to our non-public assets?"
    context: "This question aims to catch scanning activity that might be missed by single-connection alerts. While the baseline for connections to non-public assets should be zero, an attacker might probe multiple ports or hosts. By setting a low threshold (e.g., more than 5 attempts in an hour), we can detect an adversary systematically scanning our internal attack surface from a single source."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek notice.log"
      - "Network DMZ"
      - "Internal server subnets"
      - "Cloud environment subnets hosting non-public services"
      - "Perimeter firewalls"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH network_logs where source_ip.is_external=true AND destination_ip IN non_public_assets | GROUP BY source_ip over 1h | COUNT events | ALERT if event_count > 5"
  - question: "Can a machine learning model trained only on legitimate perimeter traffic identify anomalous connection attempts from external sources targeting non-public assets?"
    context: "This question proposes an anomaly detection approach for network traffic. A One-Class SVM is trained to understand what 'normal' traffic to the network perimeter looks like. Any new connection attempt from an external source that deviates significantly from this learned norm is flagged as an anomaly. This is particularly useful for identifying novel or slow scanning techniques against non-public infrastructure that might not trigger threshold-based rules."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek notice.log"
      - "Network DMZ"
      - "Internal server subnets"
      - "Cloud environment subnets hosting non-public services"
      - "Perimeter firewalls"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "TRAIN OneClassSVM_model on legitimate_perimeter_traffic_features | SCORE new_external_connections | ALERT if connection is anomaly, especially if targeting non-public_assets"
  - question: "Has a user successfully logged in from a country or Autonomous System Number (ASN) from which they have never logged in before?"
    context: "This question aims to detect credential compromise by identifying logins from geographically or network-topologically novel locations. Each user has a typical pattern of access points. A login from a new country or a new internet service provider's network (ASN) is a strong indicator of an 'impossible travel' scenario or account takeover, especially for users who do not travel frequently."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Externally-facing authentication services"
      - "VPN concentrators"
      - "Domain Controllers"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "FOR user | MAINTAIN safelist of source_countries and source_ASNs | FOR new_login | IF login.source_country NOT IN safelist OR login.source_ASN NOT IN safelist | ALERT"
  - question: "Has a successful login event accumulated a high risk score based on multiple deviations from the user's established behavior, such as a new country, new ASN, and unusual time?"
    context: "This question operationalizes a risk-scoring model to combine multiple weak signals into a stronger indicator of compromise. A single anomaly (like a login at an odd hour) might be benign, but when combined with a login from a new country and a new ASN, the event becomes much more suspicious. This scoring system allows for a more nuanced and context-rich alerting strategy than single-factor rules."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Externally-facing authentication services"
      - "VPN concentrators"
      - "Domain Controllers"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "FOR new_login | CALCULATE risk_score (new_country=1, new_ASN=1, unusual_time=1) | ALERT if total_score > 2"
  - question: "Can an unsupervised machine learning model, trained on a user's typical login characteristics, identify a successful login that is highly anomalous?"
    context: "This question leverages sophisticated unsupervised learning to create a holistic behavioral profile for each user or user group. An Isolation Forest model is particularly effective at identifying outliers in multi-dimensional data. By feeding it features like time of day, day of week, and source ASN, the model can learn a complex definition of 'normal' and flag logins that deviate from this norm in ways that simple rules or scoring systems might miss."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Externally-facing authentication services"
      - "VPN concentrators"
      - "Domain Controllers"
    range: "Last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "FOR user | TRAIN IsolationForest_model on login_features (hour, day, ASN_hash, etc.) | FOR new_login | IF model returns high anomaly_score | ALERT"