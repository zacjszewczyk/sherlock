name: T1541: Foreground Persistence
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps identify adversaries using foreground services on mobile devices to establish persistence or evade background process restrictions. Malicious applications may request the 'android.permission.FOREGROUND_SERVICE' permission to ensure they are not terminated by the operating system, allowing for persistent surveillance, command and control (C2) communication, or data exfiltration. The playbook focuses on detecting anomalous application behaviors such as unapproved apps requesting this permission, services running for outlier durations, and suspicious network patterns like long-duration, low-data connections, periodic C2 beaconing (identified by low entropy), and abnormal data upload volumes that could signify exfiltration.
type: technique
related:
- TA0028: Persistence
- TA0030: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are there any newly installed applications requesting the foreground service permission that are not on the approved allowlist?
  context: This question aims to identify potentially malicious applications at the point of installation. Adversaries may package malware as a seemingly legitimate app that requests foreground service permissions to ensure it can run persistently without being killed by the OS. Checking against an allowlist helps filter out legitimate apps and focuses on suspicious newcomers.
  answer_sources:
  - MDM Application Manifest Scan
  - Android Logcat
  - Mobile Device Management (MDM) servers
  - corporate application store and vetting pipeline
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      SEARCH MDM logs FOR new_app_installations
      PARSE manifest FOR 'android.permission.FOREGROUND_SERVICE'
      WHERE app_package_name NOT IN allowlist
      ALERT high_priority
- question: Are any applications running foreground services for durations that are statistical outliers compared to their peers?
  context: Legitimate applications use foreground services for specific, often time-bound tasks (e.g., music playback, navigation). A service running for an unusually long time compared to other apps in its category could indicate a malicious process designed for persistent C2 communication or surveillance, rather than a legitimate user-facing function.
  answer_sources:
  - Android Logcat
  - log aggregation platform ingesting Android Logcat data
  range: last 30 days
  queries:
  - search: pseudocode
    query: |
      SEARCH Android_Logcat FOR foreground_service_events
      GROUPBY app_category
      CALCULATE 99th_percentile(runtime_duration) over 30d
      ALERT medium_priority WHERE runtime_duration > 99th_percentile
- question: Have any new applications requesting foreground service permissions been classified as likely malicious by our machine learning model?
  context: This question leverages machine learning to proactively identify high-risk applications. By analyzing various features (permission count, app source, user ratings), the model can score the likelihood of an app being malicious, even if it's not on a known blocklist. A high score suggests a strong probability of malicious intent, warranting automated quarantine and immediate investigation.
  answer_sources:
  - MDM Application Manifest Scan
  - Android Logcat
  - Mobile Device Management (MDM) servers
  - corporate application store and vetting pipeline
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      ON new_app_install WITH 'FOREGROUND_SERVICE' permission
      SCORE app_features with ML_model
      IF malicious_probability > 0.9
      TRIGGER MDM_quarantine
      ALERT critical_incident
- question: Are any mobile devices making long-duration connections (over 4 hours) to known command and control (C2) servers?
  context: This question targets a classic C2 communication pattern, a persistent, long-lived connection to a server controlled by an adversary. By correlating network logs with threat intelligence, we can quickly identify connections to known malicious infrastructure. Enriching this with DNS data helps in understanding the full context of the malicious communication.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - MDM device inventory
  - Network sensors monitoring corporate Wi-Fi and VPN egress points
  - core DNS resolvers
  - MDM servers for IP-to-device mapping
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      SEARCH Zeek_conn_log
      JOIN with MDM_inventory ON device_ip
      WHERE duration > 14400s AND destination_ip IN threat_intel_feed
      ENRICH with DNS_query from Zeek_dns_log
      ALERT
- question: Are any mobile devices exhibiting network connections that are anomalously long in duration but low in data volume compared to their own baseline?
  context: This question seeks to uncover "low and slow" C2 channels that might not use known malicious IPs. By baselining each device's normal network behavior, we can spot outliers. A connection that is much longer than usual but transfers very little data is highly suspicious and characteristic of a C2 heartbeat or a channel awaiting commands, rather than legitimate data transfer.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - MDM device inventory
  - Network sensors monitoring corporate Wi-Fi and VPN egress points
  - core DNS resolvers
  - MDM servers for IP-to-device mapping
  range: last 30 days
  queries:
  - search: pseudocode
    query: |
      FOR each_device, BASELINE Zeek_conn_log over 30d
      CALCULATE p95(duration), p5(total_bytes)
      SEARCH new_connections
      ALERT medium_priority WHERE duration > p95 AND total_bytes < p5
- question: Has a time-series anomaly detection model detected a significant increase in the frequency of long-duration, low-data connections for any device?
  context: Instead of looking at single connections, this question analyzes the pattern of suspicious connections over time. A sudden, statistically significant increase in the rate of "low and slow" connections for a device can indicate that a malicious process has become active. Time-series analysis helps detect these subtle shifts in behavior that might be missed by simple threshold-based rules.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - MDM device inventory
  - Network sensors monitoring corporate Wi-Fi and VPN egress points
  - core DNS resolvers
  - MDM servers for IP-to-device mapping
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      FOR each_device, CREATE time_series of hourly_count(connections WHERE duration > 1hr AND total_bytes < 1KB)
      APPLY S-H-ESD anomaly_detection_model
      ALERT on anomaly
- question: Are mobile devices making HTTP requests with suspicious User-Agents to newly registered domains?
  context: This question aims to identify C2 communications disguised as HTTP traffic. Malware often uses generic or known-bad User-Agent strings. When this traffic is directed to a very new domain (a common tactic for adversaries to evade reputation-based blocking), it is highly indicative of malicious activity.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Zeek dns.log
  - Network sensors at traffic egress points
  - core DNS resolvers
  - network taps monitoring Wi-Fi access points for mobile devices
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      SEARCH Zeek_http_log for mobile_ips
      WHERE user_agent IN malware_signatures OR user_agent IS generic
      CORRELATE with Zeek_dns_log to get domain_age
      IF domain_age < 30d
      ALERT high_priority
- question: Are there any communication patterns from a mobile device to a single destination that are highly periodic and non-random, suggesting automated beaconing?
  context: Human-generated network traffic is typically random and bursty. Automated malware C2 beaconing, however, is often highly predictable, occurring at fixed intervals. By calculating the Shannon entropy of the time intervals between connections, we can mathematically measure this predictability. A very low entropy score strongly suggests machine-generated traffic, a hallmark of C2 beaconing.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Zeek dns.log
  - Network sensors at traffic egress points
  - core DNS resolvers
  - network taps monitoring Wi-Fi access points for mobile devices
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      SEARCH Zeek_conn_log
      GROUPBY source_ip, dest_ip in 1hr_windows
      IF connection_count > 10
      CALCULATE time_deltas_between_connections
      COMPUTE shannon_entropy(time_deltas)
      ALERT if entropy < 1.5
- question: Has our unsupervised machine learning model (DBSCAN) identified any network connections as anomalous outliers from normal behavior clusters?
  context: This question uses an unsupervised learning approach to find novel or unknown threats. By clustering all connection behaviors, the model learns what "normal" looks like. Any connection that does not fit into a normal cluster (a "noise point") is an anomaly. This can detect sophisticated C2 channels that might evade signature- or threshold-based methods.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Zeek dns.log
  - Network sensors at traffic egress points
  - core DNS resolvers
  - network taps monitoring Wi-Fi access points for mobile devices
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      HOURLY, featurize mobile_device_connections from Zeek_conn_log
      APPLY DBSCAN clustering_model
      ALERT on connections classified as 'noise' (outliers)
- question: Is an application running as a foreground service communicating with known malicious endpoints associated with data exfiltration?
  context: This question directly links application behavior with network traffic to find high-confidence indicators of data exfiltration. An application using a foreground service for persistence that is also observed sending data to a known malicious IP (e.g., an exfiltration server or anonymous file-sharing site) is a critical finding that requires immediate investigation.
  answer_sources:
  - MDM Application Runtime Logs
  - Zeek conn.log
  - MDM management servers for application runtime context
  - network sensors monitoring corporate Wi-Fi and VPN connections from mobile devices
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      REAL-TIME JOIN MDM_app_logs (for foreground_services) with Zeek_conn_log ON device_ip
      IF destination_ip IN exfiltration_threat_feed
      ALERT high_priority
- question: Has any application suddenly started uploading a significantly larger volume of data than its own historical baseline?
  context: This question seeks to detect data exfiltration by identifying anomalous changes in an application's data transfer behavior. A legitimate application typically has a predictable pattern of data usage. A sudden, large spike in outbound data, measured in standard deviations from its own norm, is a strong indicator that the application may have been compromised and is now exfiltrating data.
  answer_sources:
  - MDM Application Runtime Logs
  - Zeek conn.log
  - MDM management servers for application runtime context
  - network sensors monitoring corporate Wi-Fi and VPN connections from mobile devices
  range: last 30 days
  queries:
  - search: pseudocode
    query: |
      FOR each_app on each_device, BASELINE daily_outbound_bytes over 30d
      CALCULATE mean, std_dev
      SEARCH daily_logs
      ALERT medium_priority IF daily_outbound_bytes > (mean + 3 * std_dev)
- question: Has a machine learning regression model detected a sustained and anomalously high data upload volume from any device?
  context: This question uses a sophisticated predictive model to identify data exfiltration. Unlike a simple baseline, a regression model can account for complex factors like user role and device type to generate a more accurate prediction of expected data usage. When a device's actual data upload volume is consistently higher than the model's prediction (a large positive residual), it signals a high-confidence anomaly.
  answer_sources:
  - MDM Application Runtime Logs
  - Zeek conn.log
  - MDM management servers for application runtime context
  - network sensors monitoring corporate Wi-Fi and VPN connections from mobile devices
  range: last 90 days
  queries:
  - search: pseudocode
    query: |
      FOR each_device, PREDICT expected_daily_upload_volume with GB_Regressor_model
      CALCULATE residual = (actual_volume - predicted_volume)
      IF residual is large and sustained
      ALERT high_severity