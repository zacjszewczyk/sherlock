name: T1568.001: Fast Flux DNS
id: a7f8c1d6-4e9b-4c02-8d7a-1b9c3f5e6a0b
description: This playbook helps investigate whether an adversary is using fast flux DNS for command and control (C2) communications. It focuses on detecting the rapid change of DNS records associated with a single domain. Indicators include matching DNS queries against threat intelligence feeds of known fast flux domains, identifying high-entropy (DGA-like) domains that resolve to geographically diverse IPs, and flagging domains with an unusually high number of unique IP resolutions combined with a low Time-To-Live (TTL). The playbook also covers detecting double-flux, where the authoritative name servers themselves are rapidly changed, and correlating suspicious DNS activity with subsequent network connections on the endpoint to identify the responsible process.
type: technique
related:
  - TA0011: Command And Control
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are any internal hosts communicating with domains or IPs known to be associated with fast flux networks based on threat intelligence?
    context: This question aims to identify direct communication with known malicious infrastructure. By comparing network logs (DNS queries and connection logs) against a high-confidence list of fast flux indicators, analysts can quickly detect potential C2 activity. A match provides a strong, actionable signal for immediate investigation.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Network Egress/Internet Gateway
      - Corporate DNS Resolvers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: JOIN (dns_logs OR conn_logs) WITH fast_flux_threat_intel_feed ON (domain OR destination_ip). ALERT on match.
  - question: For hosts communicating with a known fast flux domain, is the query frequency unusually high, suggesting automated C2 beaconing?
    context: This question helps differentiate between incidental contact and persistent, automated C2 communication. Malware often beacons back to its C2 server at regular intervals. By calculating the percentile rank of query counts for a suspicious domain relative to a host's normal activity, analysts can prioritize alerts where the behavior is highly anomalous and indicative of a heartbeat or beaconing.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Network Egress/Internet Gateway
      - Corporate DNS Resolvers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: For each host with an IOC match, GET query_count for malicious_domain in last 24h. GET query_counts for all other domains by same host. CALCULATE percentile_rank. ALERT if rank > 95.
  - question: Can we predict the likelihood that a new domain matching a fast flux IOC is part of a specific threat campaign to aid in prioritization?
    context: This question moves beyond simple detection to advanced threat characterization. By training a machine learning model on features from both external threat intelligence (e.g., domain age) and internal network metadata (e.g., query frequency), analysts can score new IOC matches. This score helps prioritize incidents by estimating the probability that the activity is part of a known, high-risk campaign.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Network Egress/Internet Gateway
      - Corporate DNS Resolvers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: INPUT new_ioc_match. EXTRACT features (domain_age, query_freq, etc.). APPLY pre-trained_model. OUTPUT campaign_likelihood_score. ALERT if score > threshold.
  - question: Are any internal hosts querying for domains that match known Domain Generation Algorithm (DGA) patterns or feeds?
    context: DGAs are frequently used by malware to generate a large number of domain names to find their C2 servers, making static blocklists ineffective. This question focuses on proactively identifying DGA-based threats by matching queried domains against a watchlist of known DGA patterns (using regular expressions) and feeds of known DGA domains. A match is a strong indicator of malware infection.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - Endpoint devices
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each domain in dns_logs, IF domain MATCHES dga_watchlist (regex or feed), THEN ALERT.
  - question: Are there any high-entropy domains (suggesting DGA) that also resolve to a geographically or network-diverse set of IP addresses, characteristic of fast flux?
    context: This question combines two key indicators, the randomness of a domain name (a hallmark of DGA) and the rapid change of its resolved IPs (a hallmark of fast flux). By calculating the Shannon entropy of domain names and enriching the resolved IPs with GeoIP and ASN data, analysts can identify domains that are both algorithmically generated and using fast flux for resilience. The combination of these traits is a high-fidelity indicator of sophisticated C2 infrastructure.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - Endpoint devices
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each domain in dns_logs over 60min, CALCULATE shannon_entropy. ENRICH resolved_ips with GeoIP/ASN. IF entropy > 3.5 AND distinct_countries > 3, THEN ALERT.
  - question: Can we use machine learning to first classify domains as DGA-generated and then identify which of those use geographically dispersed IP clusters, indicating fast flux?
    context: This question leverages a more advanced, two-stage machine learning approach for high-precision detection. First, a DGA detection model (like an LSTM) classifies domains in real-time. For those flagged as DGA, a clustering algorithm (like HDBSCAN) is applied to their resolved IP addresses (enriched with location data). Clusters of IPs that are widely spread geographically are flagged as highly probable fast flux C2 networks, allowing analysts to focus on the most evasive threats.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - Endpoint devices
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: PIPE dns_logs to dga_model. IF domain IS dga, GET resolved_ips. ENRICH with geo_data. APPLY hdbscan_clustering. IF cluster has high_dispersion, THEN ALERT.
  - question: Are any domains resolving to an abnormally high number of unique IP addresses while also having a very low Time-To-Live (TTL) value?
    context: This question targets the core mechanism of single-IP fast flux. Adversaries rapidly rotate the A/AAAA records for a domain and set a very low TTL to prevent caching, forcing clients to frequently re-query. This rule operationalizes that detection by alerting when a domain resolves to many different IPs (e.g., >10) in a short window (30 minutes) and has a low average TTL (e.g., <300s), which are classic signs of fast flux.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - Network Egress/Internet Gateway
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each domain in 30min_window, COUNT unique_ips. CALC avg_ttl. IF unique_ips > 10 AND avg_ttl < 300, THEN ALERT.
  - question: Can we identify domains with an anomalously high 'flux ratio', indicating a high rate of IP change relative to their DNS caching time?
    context: This question introduces a 'flux ratio' metric to quantify the intensity of fast flux behavior. This ratio elegantly combines the number of changing IPs and the low TTL into a single, measurable value. By baselining this ratio across the entire network, analysts can use statistical methods (e.g., alerting on the 99th percentile) to automatically surface domains exhibiting extreme flux behavior that deviates significantly from the norm.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - Network Egress/Internet Gateway
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each domain in 60min_window, CALC flux_ratio = unique_ips / avg_ttl. COMPARE flux_ratio to historical_baseline. IF flux_ratio > 99th_percentile, THEN ALERT.
  - question: Using unsupervised machine learning, can we discover clusters of domains that exhibit fast flux characteristics without prior knowledge or fixed thresholds?
    context: This question applies unsupervised learning to discover novel or unknown fast flux networks. By using an algorithm like DBSCAN to cluster domains based on a set of flux-related features (unique IPs, TTL stats, subnet diversity), analysts can identify groups of domains that behave similarly and stand apart from normal DNS traffic. These outlier clusters are strong candidates for fast flux networks, even if they don't meet predefined rule-based thresholds.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - Network Egress/Internet Gateway
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR all domains, EXTRACT features (unique_ips, avg_ttl, stddev_ttl, etc.). APPLY DBSCAN clustering. ANALYZE and ALERT on outlier clusters.
  - question: Are the authoritative name servers for any domain changing frequently, in conjunction with low TTLs on the NS records, indicating double-flux DNS?
    context: This question targets 'double-flux', a more advanced technique where adversaries rapidly change not only the A records but also the name server (NS) records for a domain. A stateful rule is needed to track the set of NS records over time. An alert is triggered if this set changes frequently (e.g., >5 times in 24 hours) and the TTLs are low, indicating a deliberate effort to make the C2 infrastructure highly resilient and difficult to track.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - External-facing authoritative DNS servers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each domain_zone in 24h_window, TRACK set of NS_records. COUNT changes to set. CALC avg_ttl. IF changes > 5 AND avg_ttl < 1800, THEN ALERT.
  - question: Can we visually identify domains exhibiting double-flux behavior by plotting their name server change rate against their average name server TTL?
    context: This question proposes a data visualization approach for hunting double-flux activity. By calculating and plotting the rate of NS record changes versus the average TTL for all domains, a clear pattern emerges. Normal domains will have low change rates and high TTLs, while double-flux domains will cluster in a 'high-change-rate, low-TTL' quadrant. This allows analysts to visually hunt for and identify suspicious domains that warrant further investigation.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - External-facing authoritative DNS servers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each domain_zone, CALC ns_change_rate, avg_ns_ttl. PLOT all domains on scatter (x=ns_change_rate, y=avg_ns_ttl). INVESTIGATE domains in high-x, low-y quadrant.
  - question: Can we model our DNS traffic as a dynamic graph to detect communities of domains and name servers with high 'churn', indicating double-flux activity?
    context: This question applies advanced graph theory to detect double-flux. The entire DNS resolution process is modeled as a graph where domains, IPs, and name servers are nodes. By analyzing how this graph changes over time, algorithms can detect 'communities' (groups of related nodes) that are highly unstable. A community where the name server nodes for a specific domain are constantly being replaced is a very strong signal of a sophisticated double-flux C2 network.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Resolvers
      - External-facing authoritative DNS servers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: CREATE graph from DNS data (nodes=domains, IPs, NS). APPLY dynamic_graph_analysis. DETECT communities with high node churn. ALERT on communities with high NS churn for a domain.
  - question: Can we correlate a DNS query for a known fast flux domain with a subsequent network connection to a resolved IP and identify the responsible process on the endpoint?
    context: This question connects network-level indicators to host-level activity, providing crucial context for incident response. A correlation rule links a suspicious DNS query (from a fast flux IOC list) to an immediate outbound connection to one of the IPs from the DNS answer. Critically, the alert is then enriched with process information (e.g., from Windows Event ID 4688) to pinpoint the exact executable responsible for the malicious communication.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Endpoint devices
      - Network Egress/Internet Gateway
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: TRIGGER on dns_query to IOC_domain. WITHIN 60s, LOOK for conn_event to resolved_ip from same_host. IF found, GET parent_process_info. ALERT with all context.
  - question: For hosts exhibiting a sudden spike in DNS queries to a single domain, are they also successfully connecting to a high percentage of the resolved IPs?
    context: This question combines statistical anomaly detection with behavioral analysis to identify active C2. First, it detects a statistically significant spike in DNS queries from a host to a domain (Z-score > 3). Then, for those events, it calculates a 'connection success ratio' to see if the host is actually trying to connect to the rapidly changing IPs. A high ratio confirms the host isn't just resolving the domain but is actively using the results, which is a strong sign of C2.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Endpoint devices
      - Network Egress/Internet Gateway
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each host/domain, CALC Z-score of query_count in 5min_window. IF Z-score > 3, CALC success_ratio = (connected_ips / resolved_ips). IF ratio > 0.5, THEN ALERT.
  - question: Can a per-host machine learning model detect anomalous network behavior, and can we then determine if a spike in DNS queries to a single domain is the cause of the anomaly?
    context: This question describes a sophisticated, host-centric anomaly detection system. An ML model (like an LSTM autoencoder) learns the normal time-series network behavior for each host. When the model's reconstruction error spikes, it signals an anomaly. Feature importance techniques (like SHAP) are then used on the anomalous data to explain *why* the alert was triggered, confirming if the root cause was a burst of DNS queries characteristic of fast flux C2.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Endpoint devices
      - Network Egress/Internet Gateway
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: FOR each host, FEED time-series_features (dns_rate, etc.) to autoencoder_model. IF reconstruction_error > threshold, ALERT. APPLY SHAP to identify primary feature_driver.