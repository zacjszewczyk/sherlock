name: T1069.003: Cloud Groups
id: 5e6a87c1-2b0d-4f8a-986d-3195c4793b21
description: |
  This playbook helps answer whether an adversary has attempted to discover cloud groups and permissions. It focuses on identifying high-fidelity indicators like specific command strings or API calls; high volumes of enumeration calls from a single identity or IP; behavioral deviations from a user's historical baseline; enumeration from high-risk IP addresses; enumeration events followed by high-risk actions; and unusual network traffic patterns to cloud API endpoints from internal hosts.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
investigative_questions:
  - question: Are there any command-line arguments or API calls that are exact matches for known cloud group discovery techniques?
    context: |
      This question seeks to identify high-fidelity indicators of malicious discovery. By maintaining a watchlist of specific commands (e.g., 'Get-MsolRole', 'ListRolePolicies', 'az ad user get-member-groups') and alerting on their use by unauthorized users or systems, analysts can quickly detect overt reconnaissance attempts. This symbolic approach is effective against less sophisticated adversaries who use standard, unmodified toolsets.
    answer_sources:
      - Windows Event ID 4688
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Cloud provider IAM/Audit Log services
      - Domain Controllers
      - Administrator workstations
      - CI/CD pipeline runners
    range: last 90 days
    queries:
      - pseudocode: "SEARCH process creation logs and cloud audit logs FOR command-line arguments or API calls matching watchlist (e.g., 'Get-MsolRole', 'ListRolePolicies') WHERE user is NOT in administrative allowlist."
  - question: Has a user executed a cloud CLI command with an unusually high Shannon entropy score compared to their baseline?
    context: |
      This question aims to detect obfuscated or complex commands that deviate from normal administrative activity. Adversaries may use obfuscation to hide their intentions. By calculating the Shannon entropy of command-line arguments for processes like 'powershell.exe' or 'bash', we can establish a baseline for legitimate commands. A command with an entropy score in the 99th percentile for a user suggests it is abnormally complex, potentially indicating a non-interactive script or obfuscation technique.
    answer_sources:
      - Windows Event ID 4688
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Cloud provider IAM/Audit Log services
      - Domain Controllers
      - Administrator workstations
      - CI/CD pipeline runners
    range: last 90 days
    queries:
      - pseudocode: "CALCULATE Shannon entropy for command-line arguments of 'powershell.exe' or 'bash'. COMPARE to user's historical baseline. ALERT if current command entropy > 99th percentile of baseline."
  - question: Has a machine learning model classified a command-line argument as a probable malicious cloud discovery attempt?
    context: |
      This question leverages a supervised machine learning model to score the probability that a given command is malicious. By training a model on features like command length, keyword counts ('list', 'get'), and special character frequency, the system can identify novel or slightly modified discovery commands that might evade simple symbolic detection. This provides a more robust and adaptable method for detecting evolving adversary techniques.
    answer_sources:
      - Windows Event ID 4688
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Cloud provider IAM/Audit Log services
      - Domain Controllers
      - Administrator workstations
      - CI/CD pipeline runners
    range: last 90 days
    queries:
      - pseudocode: "SCORE new command-line arguments using a trained classification model. ALERT if the probability of being a malicious discovery attempt exceeds a predefined threshold."
  - question: Has a single user or IP address executed a high volume of enumeration API calls or used wildcard queries within a short time frame?
    context: |
      This question looks for signs of automated reconnaissance. A human operator typically works at a slower pace. A rule that alerts when a user executes more than 20 distinct enumeration calls (like 'ListGroups', 'ListRoles') in a minute, or uses broad wildcard queries (like 'Get-MsolUser -All | Get-MsolUserRole') from a non-whitelisted account, can effectively identify scripted enumeration attacks.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Zeek conn.log
      - Cloud provider API gateways
      - Internal network egress points
      - Administrator workstations and servers
    range: last 90 days
    queries:
      - pseudocode: "COUNT distinct enumeration API calls per user/IP in a 1-minute window. ALERT if count > 20. SEARCH for wildcard queries from non-whitelisted accounts."
  - question: Is a user or IP address generating enumeration API calls at a rate that is statistically anomalous compared to their baseline?
    context: |
      This question aims to identify unusual bursts of activity. By establishing a baseline rate of enumeration calls per minute for each user and IP over a 30-day period, we can detect significant deviations. An alert triggered when the current rate exceeds 3 standard deviations above the baseline points to activity that is anomalously fast for that specific entity, suggesting automated tools are in use.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Zeek conn.log
      - Cloud provider API gateways
      - Internal network egress points
      - Administrator workstations and servers
    range: last 90 days
    queries:
      - pseudocode: "CALCULATE rolling count of enumeration API calls per minute for each user/IP. COMPARE to 30-day baseline (mean, stddev). ALERT if current rate > (mean + 3 * stddev)."
  - question: Has a time-series anomaly detection model flagged a sudden spike or pattern change in enumeration events for a user or IP?
    context: |
      This question uses a time-series model (like ARIMA or LSTM) to learn the normal rhythm and cadence of enumeration activity for each user and source IP. The model can then forecast expected behavior and flag significant deviations, such as sudden spikes or changes in the pattern. This approach is powerful for detecting scripted attacks that may not be high in volume but have a machine-like, non-human cadence.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Zeek conn.log
      - Cloud provider API gateways
      - Internal network egress points
      - Administrator workstations and servers
    range: last 90 days
    queries:
      - pseudocode: "APPLY time-series anomaly detection model (e.g., ARIMA) to enumeration event counts per user/IP. ALERT if observed activity significantly deviates from the model's forecast."
  - question: Has a non-administrative user or an account outside of the 'Cloud Administrators' group executed a privileged enumeration command?
    context: |
      This question enforces a policy of least privilege by checking for policy violations. Certain powerful enumeration commands (e.g., 'Get-MsolRole', 'gcloud iam roles list') should only be used by authorized administrators. Alerting when a non-privileged account executes these commands provides a high-fidelity signal of either a policy violation or a compromised account attempting to discover privileged access paths.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Cloud provider IAM/Audit Log services
      - User and Entity Behavior Analytics (UEBA) platform data lake
      - SIEM log repository
    range: last 90 days
    queries:
      - pseudocode: "SEARCH for privileged enumeration commands (e.g., 'Get-MsolRole') WHERE user is NOT in 'Cloud Administrators' group or allowlist. ALERT on match."
  - question: Has a user's recent set of enumeration API calls shown low similarity to their historical baseline?
    context: |
      This question seeks to identify behavioral changes in a user's activity. By profiling the typical set of enumeration APIs a user calls over 30 days, we can create a historical baseline. We can then compare the set of calls made in a recent, short window (e.g., 1 hour) to this baseline using the Jaccard similarity index. A low score (e.g., below 0.2) indicates the user is performing actions that are very different from their normal behavior, which could be suspicious.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Cloud provider IAM/Audit Log services
      - User and Entity Behavior Analytics (UEBA) platform data lake
      - SIEM log repository
    range: last 90 days
    queries:
      - pseudocode: "PROFILE unique enumeration API calls per user over 30 days (baseline set). CALCULATE Jaccard similarity between recent 1-hour call set and baseline set. ALERT if similarity < 0.2."
  - question: Has an unsupervised clustering algorithm identified a user's enumeration behavior as an outlier or as having shifted to a high-risk cluster?
    context: |
      This question uses unsupervised machine learning to group users based on their enumeration behavior (e.g., API call frequency, diversity, time of day). This allows the system to identify users who are outliers and do not fit any normal pattern, or users who suddenly shift from a low-activity group to a high-activity, high-diversity group. Such a shift can indicate that an account has been compromised and is being used for reconnaissance.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Cloud provider IAM/Audit Log services
      - User and Entity Behavior Analytics (UEBA) platform data lake
      - SIEM log repository
    range: last 90 days
    queries:
      - pseudocode: "CLUSTER users based on enumeration behavior feature vectors (e.g., using DBSCAN). ALERT when a user is classified as an outlier or moves to a higher-risk cluster."
  - question: Did a cloud group enumeration event originate from a high-risk source IP address?
    context: |
      This question adds geographic and reputational context to an enumeration event. By enriching the source IP with geolocation data and checking it against threat intelligence feeds (e.g., known malicious IPs, TOR exit nodes), we can quickly identify high-risk activity. Alerting on enumeration from unapproved countries or Autonomous Systems (ASNs) provides a clear, rule-based method for flagging suspicious connections.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Zeek conn.log
      - Network gateway firewalls and proxies
      - VPN concentrators
      - Cloud provider audit logs
      - Endpoint process monitoring agents
    range: last 90 days
    queries:
      - pseudocode: "ENRICH source IP of enumeration events with geolocation and threat intelligence. ALERT if IP is on a blocklist or originates from a non-allowlisted country/ASN."
  - question: Did a cloud enumeration event originate from a geolocation or ASN that is statistically rare for that specific user?
    context: |
      This question aims to detect anomalous source locations for a user's activity, even if the location itself is not on a threat list. By maintaining a baseline of a user's typical source geolocations and ASNs, an event from a location that falls into the 1st percentile of frequency (i.e., is very rare for that user) can be flagged. This helps detect account takeovers where the adversary operates from a location unfamiliar to the legitimate user.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Zeek conn.log
      - Network gateway firewalls and proxies
      - VPN concentrators
      - Cloud provider audit logs
      - Endpoint process monitoring agents
    range: last 90 days
    queries:
      - pseudocode: "MAINTAIN frequency distribution of source geolocations/ASNs per user over a 90-day baseline. For new enumeration events, ALERT if the source location/ASN falls below the 1st percentile of frequency for that user."
  - question: Has a machine learning model classified an enumeration event as illegitimate based on its contextual features?
    context: |
      This question uses a classification model to make a holistic judgment about the legitimacy of an enumeration event. The model considers a wide range of features, such as source IP context (geolocation, ASN), time of day, user role, and the parent process on the endpoint. An event that the model scores as having a low probability of being legitimate can trigger an alert, allowing for the detection of complex, multi-faceted anomalies.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Windows Event ID 4688
      - Zeek conn.log
      - Network gateway firewalls and proxies
      - VPN concentrators
      - Cloud provider audit logs
      - Endpoint process monitoring agents
    range: last 90 days
    queries:
      - pseudocode: "SCORE enumeration events using a trained Random Forest model based on features like IP context, time, user role, and process. ALERT if the legitimacy probability score is low."
  - question: Was a cloud group enumeration event by a user followed by a high-risk action from the same user within a short time window?
    context: |
      This question seeks to identify the common attack chain of 'discover then act'. A SIEM correlation rule can detect this specific sequence, for example, a 'ListRoles' API call (discovery) followed by an 'AssumeRole' call (action) within 10 minutes by the same user. Alerting on this 'discovery-to-action' pattern is a strong indicator of malicious intent, as the adversary is immediately attempting to use the information they have gathered.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - SIEM correlation engine
      - Cloud provider audit log services
      - Data Loss Prevention (DLP) systems
    range: last 90 days
    queries:
      - pseudocode: "CREATE correlation rule: IF (EVENT_A is enumeration API) AND (EVENT_B is high-risk API like 'AssumeRole' or 'GetSecretValue') AND (UserA == UserB) AND (TimestampB - TimestampA < 10 minutes), THEN ALERT."
  - question: Did a user transition from an enumeration action to a high-risk action with a probability that is statistically unusual?
    context: |
      This question models user behavior as a sequence of states (API call types) to identify unlikely and therefore suspicious transitions. By calculating the normal transition probabilities between actions (e.g., the probability of a high-risk action following an enumeration action), we can flag sessions where this transition occurs with a significantly higher probability than the historical average. This points to a user session that is not following normal operational patterns.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - SIEM correlation engine
      - Cloud provider audit log services
      - Data Loss Prevention (DLP) systems
    range: last 90 days
    queries:
      - pseudocode: "MODEL user behavior as a Markov chain of API call types. CALCULATE transition probabilities. ALERT if P(High-Risk Action | Enumeration Action) for a user session significantly exceeds the historical average probability."
  - question: Has a graph-based anomaly detection algorithm identified a rare or high-risk path of user activity involving enumeration?
    context: |
      This question models the entire cloud environment as a graph of users, roles, and resources connected by API calls. Graph-based anomaly detection can then identify unusual or high-risk paths that represent a sequence of actions, such as a user listing roles, assuming a role, and then accessing a secret. This method is excellent for visualizing and detecting complex attack chains that might be missed by simple sequential correlation rules.
    answer_sources:
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - SIEM correlation engine
      - Cloud provider audit log services
      - Data Loss Prevention (DLP) systems
    range: last 90 days
    queries:
      - pseudocode: "MODEL cloud activity as a directed graph. APPLY graph-based anomaly detection to identify rare or high-risk paths, such as 'User -> ListRoles -> AssumeRole -> GetSecretValue'."
  - question: Has an internal host generated an excessive number of DNS queries for cloud API endpoints in a short period?
    context: |
      This question seeks to identify pre-cursors to large-scale enumeration from the network perspective. Before making API calls, a client must resolve the API endpoint's FQDN. A rule that alerts when a single host makes an unusually high number of unique DNS queries for cloud API domains (e.g., over 100 unique subdomains of '*.amazonaws.com' in 5 minutes) can detect the initial setup phase of an automated enumeration script.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Network TAPs at internet egress points
      - DNS resolvers
      - SIEM log repository
    range: last 90 days
    queries:
      - pseudocode: "MONITOR Zeek dns.log. COUNT unique DNS queries for cloud API FQDNs per host. ALERT if count exceeds threshold (e.g., 100 in 5 minutes)."
  - question: Is an internal host making connections to cloud API endpoints with an abnormally low average data transfer size?
    context: |
      This question identifies a network-level artifact of enumeration. Enumeration API calls often involve small requests and receive small responses (e.g., a list of names), in contrast to data uploads/downloads. By monitoring connection logs (like Zeek conn.log), we can flag hosts whose average connection size to cloud API endpoints drops significantly (e.g., more than 2 standard deviations) below their baseline, suggesting rapid-fire, low-payload enumeration checks.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Network TAPs at internet egress points
      - DNS resolvers
      - SIEM log repository
    range: last 90 days
    queries:
      - pseudocode: "MONITOR Zeek conn.log for connections to cloud API endpoints. CALCULATE average connection size per host. ALERT if average size drops more than 2 standard deviations below the host's 30-day mean."
  - question: Has a time-series anomaly model detected a machine-like cadence or anomalous burst of network connections from an internal host to cloud API endpoints?
    context: |
      This question applies time-series analysis to network connection volume to detect automated activity. A model can learn the normal daily and weekly patterns of connections to cloud APIs. It can then flag anomalies like a sudden burst of connections at an unusual time (e.g., 3 AM) or connections occurring with a perfectly regular, machine-like cadence that deviates from the learned pattern of human-driven activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - AWS CloudTrail
      - Azure Monitor Audit Logs
      - GCP Cloud Audit Logs
      - Network TAPs at internet egress points
      - DNS resolvers
      - SIEM log repository
    range: last 90 days
    queries:
      - pseudocode: "APPLY time-series anomaly detection to the volume of connections per second from internal hosts to cloud API IPs. ALERT on bursts or cadence changes that deviate from the learned seasonal pattern."