name: "T1484.002: Trust Modification"
id: "f9e1b3a2-4c5d-4e6f-8b7a-9d0c1e2f3a4b"
description: "This playbook is designed to detect adversarial modification of trust relationships for the purpose of privilege escalation or defense evasion. It focuses on identifying changes to Active Directory Federation Services (AD FS) and domain trusts, such as the addition of malicious signing certificates, alteration of claim issuance policies to grant elevated privileges, modification of domain trusts followed by suspicious authentication activity, and unauthorized changes to a domain's authentication method. The goal is to detect these activities which are strong indicators of an adversary attempting to gain higher-level permissions or bypass security controls within a federated environment."
type: "technique"
related:
  - "TA0004: Privilege Escalation"
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a new AD FS signing certificate been added that matches a known-malicious thumbprint?"
    context: "This question aims to identify the direct use of malicious infrastructure. Adversaries may add a new signing certificate to an AD FS server to forge security tokens. By comparing the thumbprint of newly added certificates against a list of known-bad indicators from threat intelligence, we can quickly detect a known attack pattern for privilege escalation."
    answer_sources:
      - "Windows Event ID 259"
      - "Windows Event ID 4104"
      - "Active Directory Federation Services (AD FS) servers"
      - "Threat Intelligence Feeds"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH for EventID 259. EXTRACT certificate_thumbprint. LOOKUP certificate_thumbprint in threat_intel_feed. ALERT on match."
  - question: "Has a new AD FS signing certificate been added with statistically anomalous properties, such as high entropy or being added by a non-administrative user?"
    context: "This question seeks to find outliers that may indicate a malicious certificate crafted to evade simple signature-based detection. Legitimate certificates often have predictable patterns in their subject and issuer fields. A certificate with unusually high entropy might be algorithmically generated. Furthermore, certificate additions by non-standard user accounts are highly suspicious and could indicate a compromised account being used to establish persistence or escalate privileges."
    answer_sources:
      - "Windows Event ID 259"
      - "Windows Event ID 4104"
      - "Active Directory Federation Services (AD FS) servers"
      - "Certificate Property Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH for EventID 259. CALCULATE entropy(certificate_subject), entropy(certificate_issuer). COMPARE to baseline. ALERT if > 95th percentile. CHECK if user is non-admin. ALERT if true."
  - question: "Can a machine learning model classify a newly added AD FS signing certificate as malicious based on its features?"
    context: "This question leverages machine learning to perform a more sophisticated, multi-faceted analysis of new certificates. By training a model on various features like validity period, key size, and issuer details, the system can learn the subtle characteristics of both benign and malicious certificates. This allows for the detection of novel threats that don't match known bad thumbprints or simple statistical anomalies."
    answer_sources:
      - "Windows Event ID 259"
      - "Windows Event ID 4104"
      - "Active Directory Federation Services (AD FS) servers"
      - "ML Certificate Classification Model"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON EventID 259, EXTRACT certificate_features. INPUT features into ML_model. IF model_score > threshold, ALERT."
  - question: "Has an AD FS claim issuance policy been modified to include high-privilege SIDs or rules that bypass MFA?"
    context: "This question looks for specific, high-confidence indicators of an adversary manipulating claim rules for privilege escalation. By adding a high-privilege SID like the Administrators SID to a token, or by inserting a claim that falsely indicates the user is on the corporate network to bypass MFA, an attacker can gain unauthorized access to sensitive applications. This is a direct method of privilege escalation within a federated environment."
    answer_sources:
      - "Windows Event ID 501"
      - "Windows Event ID 4104"
      - "Active Directory Federation Services (AD FS) servers"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH for EventID 501. REGEX search event_data for 'S-1-5-32-544' or 'multipleauthn' or 'insidecorpenetwork'. ALERT on match."
  - question: "Has a claim issuance policy been modified in a statistically unusual way, such as a significant increase in rule length or complexity, or by an unauthorized account?"
    context: "This question aims to detect suspicious policy changes that may not contain an obvious malicious string. A significant, unexpected increase in the complexity or length of a rule could indicate an adversary is embedding obfuscated logic. Tracking which accounts perform these changes and flagging modifications by accounts that have never done so before helps identify compromised accounts being used to alter security policies."
    answer_sources:
      - "Windows Event ID 501"
      - "Windows Event ID 4104"
      - "Active Directory Federation Services (AD FS) servers"
      - "Policy Change Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH for EventID 501. CALCULATE length/entropy of new rule. COMPARE to baseline. ALERT if > 3 stddev. CHECK if user is first-time modifier. ALERT if true."
  - question: "Can a machine learning model classify a claim issuance policy modification as unauthorized based on its context?"
    context: "This question uses a supervised learning model to differentiate between legitimate administrative changes and malicious modifications. By training on features like the user, time of day, and the content of the change, the model can learn the patterns of authorized activity. This allows it to flag changes that, while potentially performed by a privileged account, are inconsistent with normal operational behavior and may be unauthorized."
    answer_sources:
      - "Windows Event ID 501"
      - "Windows Event ID 4104"
      - "Active Directory Federation Services (AD FS) servers"
      - "Change Management Records"
      - "ML Policy Change Model"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON EventID 501, EXTRACT change_features (user, time, content). INPUT features into ML_model. IF model_classifies as 'unauthorized', ALERT."
  - question: "Has a domain trust modification been immediately followed by a network logon from the new trust to a high-value asset?"
    context: "This question seeks to identify the immediate abuse of a newly created or modified domain trust. An adversary might establish a trust to gain access to resources in another domain. A correlation rule that detects a trust modification followed by a successful network logon to a critical server (like a Domain Controller) from the source domain is a strong indicator of malicious activity."
    answer_sources:
      - "Windows Event ID 4703"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "Network traffic flow points between domain security boundaries"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "CORRELATE (EventID 4703) with (EventID 4624 AND LogonType 3 AND destination is high_value_asset) within 60 minutes. ENRICH with network logs. ALERT on correlation."
  - question: "Has a new or modified domain trust resulted in a statistically significant increase in cross-domain authentications?"
    context: "This question aims to detect the abuse of a domain trust by observing its usage patterns. Legitimate trust relationships typically have a predictable volume of authentication traffic. A sudden, anomalous spike in cross-domain authentications from a newly trusted domain, when compared to a historical baseline, suggests the trust is being exploited, possibly for lateral movement or data access."
    answer_sources:
      - "Windows Event ID 4703"
      - "Windows Event ID 4624"
      - "Domain Controllers"
      - "Network traffic flow points between domain security boundaries"
      - "Authentication Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON EventID 4703, MONITOR hourly count of (EventID 4624 AND LogonType 3) from source_domain for 24 hours. COMPARE count to historical baseline. ALERT if > 99th percentile."
  - question: "Is a time-series anomaly detection model flagging a spike in cross-domain authentications that is temporally linked to a trust modification event?"
    context: "This question uses a time-series model to forecast expected authentication volumes and detect deviations. By treating a trust modification event as an influencing factor (an exogenous variable), the model can more accurately determine if a subsequent spike in authentications is anomalous or expected. This advanced method helps to identify sophisticated attacks that might be missed by simpler statistical checks."
    answer_sources:
      - "Windows Event ID 4703"
      - "Windows Event ID 4624"
      - "Domain Controllers"
      - "Network traffic flow points between domain security boundaries"
      - "ML Time-Series Model"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "INPUT authentication volume and EventID 4703 occurrences into time-series_model. IF actual_volume > forecast_prediction_interval after EventID 4703, ALERT."
  - question: "Has a domain's authentication method been changed to 'Federated' by an account not on the authorized allow-list?"
    context: "This question targets unauthorized changes to a domain's authentication method, which is a critical security setting. An adversary might change a domain from 'Managed' to 'Federated' to redirect authentication to a server they control. By maintaining a strict allow-list of accounts authorized to make this change, any deviation can be immediately flagged as a high-priority security incident."
    answer_sources:
      - "Windows Event ID 307"
      - "Windows Event ID 510"
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Domain Controllers"
      - "AD FS Servers"
      - "Administrator Workstations"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH for PowerShell cmdlets 'Set-MsolDomainFederationSettings' or EventID 307/510. CHECK if user is NOT in authorized_admin_list. ALERT on unauthorized user."
  - question: "Has a domain federation setting been changed at a statistically anomalous time?"
    context: "This question focuses on the timing of administrative actions to spot outliers. Critical changes like modifying federation settings are typically performed during standard business hours or scheduled maintenance windows. A change that occurs late at night or on a weekend, when compared to a historical baseline of legitimate changes, is highly suspicious and warrants investigation, even if performed by a seemingly authorized account."
    answer_sources:
      - "Windows Event ID 307"
      - "Windows Event ID 510"
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Domain Controllers"
      - "AD FS Servers"
      - "Administrator Workstations"
      - "Activity Time Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH for federation change events. EXTRACT timestamp. COMPARE to baseline of normal change times. ALERT if timestamp is outside 5th-95th percentile."
  - question: "Has a UEBA model detected that a federation setting modification was part of an anomalous session for a privileged administrator?"
    context: "This question leverages User and Entity Behavior Analytics (UEBA) to provide deep contextual analysis of administrator actions. A UEBA model builds a profile of normal behavior for each user. It can detect if an administrator modifies federation settings from a new or unusual workstation, at an odd time, or in conjunction with other strange activities. This flags the action as a high-risk anomaly, even if the account has the necessary permissions, pointing to a potential account compromise."
    answer_sources:
      - "Windows Event ID 307"
      - "Windows Event ID 510"
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Domain Controllers"
      - "AD FS Servers"
      - "Administrator Workstations"
      - "UEBA Platform"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "INGEST federation change events into UEBA_model. IF user_session is flagged as anomalous, ALERT with high risk."
  - question: "Has a new trusted federation realm been added whose domain matches a known-malicious indicator?"
    context: "This question aims to detect the addition of a malicious federated trust by checking the new realm's domain against threat intelligence. Adversaries may establish a federated trust with a domain they control to gain access. A direct match of the domain against a feed of known-malicious domains is a high-confidence indicator of an attack."
    answer_sources:
      - "Windows Event ID 307"
      - "Windows Event ID 510"
      - "Windows Event ID 4104"
      - "Zeek dns.log"
      - "Zeek intel.log"
      - "AD FS Servers"
      - "Domain Controllers"
      - "DNS Servers"
      - "Network Gateways"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON EventID 307/510/4104, EXTRACT trusted_realm_uri. LOOKUP domain from URI in threat_intel_feed. ALERT on match."
  - question: "Has a new trusted federation realm been added whose domain is newly registered or has high character entropy?"
    context: "This question seeks to identify suspicious domains used for federation that aren't on threat intelligence feeds yet. Adversaries often use newly registered domains for their campaigns. A domain registered within the last 30 days is a significant red flag. Additionally, algorithmically generated domains often have high character entropy, so flagging domains with anomalous entropy scores can help uncover malicious infrastructure."
    answer_sources:
      - "Windows Event ID 307"
      - "Windows Event ID 510"
      - "Windows Event ID 4104"
      - "Passive DNS/WHOIS data"
      - "Domain Property Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON new trusted realm, QUERY WHOIS for domain_registration_date. ALERT if < 30 days old. CALCULATE entropy(domain_name). COMPARE to baseline. ALERT if > 95th percentile."
  - question: "Does a machine learning model classify a newly added trusted realm URI as likely malicious?"
    context: "This question uses machine learning, specifically a Domain Generation Algorithm (DGA) detector, to proactively identify malicious domains. These models are trained on the lexical features of millions of domains and can classify a domain as benign or malicious without prior knowledge. This is effective against adversaries who use DGAs to create a large number of command-and-control domains."
    answer_sources:
      - "Windows Event ID 307"
      - "Windows Event ID 510"
      - "Windows Event ID 4104"
      - "ML DGA Detection Model"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON new trusted realm, EXTRACT domain. INPUT domain into DGA_model. IF model_score > threshold, ALERT."
  - question: "Has a PowerShell cmdlet for updating federation settings been executed with a non-approved issuer URI or signing certificate?"
    context: "This question looks for direct evidence of an adversary hijacking the federation trust by injecting their own settings. By monitoring PowerShell logs for cmdlets like 'Update-MSOLFederatedDomain' and inspecting the parameters, we can detect if an attacker is attempting to set the issuer URI to a domain they control or inject a rogue token-signing certificate. This is a critical defense evasion and privilege escalation technique."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "AD FS Servers"
      - "Domain Controllers"
      - "Administrator Workstations"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "SEARCH EventID 4104 for 'Update-MSOLFederatedDomain'. REGEX parse parameters. IF IssuerUri is NOT in allow-list OR SigningCertificate is NOT from internal PKI, ALERT."
  - question: "Has a PowerShell cmdlet for updating federation settings been executed with a statistically rare parameter or combination of parameters?"
    context: "This question aims to find unusual executions of administrative commands that might indicate misuse. While an adversary might use legitimate cmdlets, they may use them with parameters or in combinations that are rare in normal administrative activity. By baselining common usage and alerting on statistical outliers, it's possible to flag suspicious command executions that warrant further review."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "AD FS Servers"
      - "Domain Controllers"
      - "Administrator Workstations"
      - "Cmdlet Usage Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ANALYZE historical usage of federation cmdlets. ON new execution, check if parameter or parameter_combination is rare (<1% of invocations). ALERT if true."
  - question: "Can an anomaly detection model identify an unusual execution of a federation settings cmdlet based on its full context?"
    context: "This question uses an unsupervised machine learning model to detect anomalous command executions. The model considers a wide range of features, including the command, its parameters, the user who ran it, and the source host. This allows it to identify novel or unusual invocations that deviate from established patterns, which could represent an adversary using legitimate tools for malicious purposes."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "AD FS Servers"
      - "Domain Controllers"
      - "Administrator Workstations"
      - "ML Anomaly Detection Model"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "INPUT command_execution_features (command, params, user, host) into Isolation_Forest_model. IF model identifies as anomaly, ALERT."
  - question: "Has a domain trust been modified by a privileged account from a geographically unapproved location?"
    context: "This question uses geofencing as a simple but effective control for privileged access. If a trust modification event is preceded by a logon from an IP address that maps to a country where the business does not operate or from which administrators do not work, it is a strong indicator of a compromised account. This helps detect adversaries operating from foreign locations."
    answer_sources:
      - "Windows Event ID 4703"
      - "Windows Event ID 307"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "AD FS Servers"
      - "VPN Concentrators"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "CORRELATE trust modification event with preceding logon (EventID 4624). GET source_ip from logon. GEO-IP lookup. IF country is NOT in allow-list, ALERT."
  - question: "Has a domain trust been modified by a privileged account at an unusual time or from a new location based on their individual baseline?"
    context: "This question moves beyond simple geofencing to personalized behavioral baselining. By analyzing each privileged user's historical login times and locations, we can detect deviations from their personal norm. A trust modification performed by a user logging in at 3 AM when they always work 9-to-5, or from a new country, is highly suspicious and can be flagged even if the location is generally approved for the company."
    answer_sources:
      - "Windows Event ID 4703"
      - "Windows Event ID 307"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "AD FS Servers"
      - "User Login Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON trust modification, get user. CHECK preceding logon time and location against user's baseline. IF time > 2 stddev from mean OR location is new in 90 days, increase risk_score. ALERT if score > threshold."
  - question: "Has a UEBA platform flagged a user's session as anomalous during which a domain trust modification occurred?"
    context: "This question leverages a comprehensive UEBA solution to detect sophisticated account compromises. A UEBA model analyzes a user's entire session, including login, resource access, and commands run. If it flags a session as anomalous, any high-impact action like a trust modification that occurs within that session should be treated as a critical alert, as it suggests an attacker is in control of the account."
    answer_sources:
      - "Windows Event ID 4703"
      - "Windows Event ID 307"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "AD FS Servers"
      - "UEBA Platform"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "INGEST user session data into UEBA_model. IF session containing a trust modification event is flagged as anomalous, ALERT."
  - question: "Following a trust modification, did an AD FS server connect to an external IP whose SNI is not on a pre-approved list?"
    context: "This question seeks to identify post-modification network activity that indicates communication with a malicious external identity provider (IdP). After modifying a trust, an adversary's IdP may need to communicate with the internal AD FS server. By maintaining an allow-list of legitimate partner IdP Server Name Indications (SNIs) and alerting on connections to any SNI not on the list, we can detect this suspicious outbound communication."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Windows Event ID 307"
      - "Windows Event ID 501"
      - "AD FS Servers"
      - "Network Perimeter Firewalls"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "CORRELATE trust modification event with subsequent SSL connection from AD FS server within 5 mins. EXTRACT SNI from SSL log. IF SNI not in approved_list, ALERT."
  - question: "Following a trust modification, was there a statistically significant spike in data volume transferred from an AD FS server to external IdP endpoints?"
    context: "This question aims to detect anomalous data transfers that may occur after a trust is compromised. An adversary might use the new trust to exfiltrate data via the federation channel. By baselining the normal volume of data transferred between AD FS servers and external identity providers, a sudden spike that is temporally correlated with a trust modification can indicate malicious activity."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 307"
      - "Windows Event ID 501"
      - "AD FS Servers"
      - "Network Perimeter Firewalls"
      - "Data Transfer Baselines"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "ON trust modification, MONITOR data transfer volume from AD FS server for 30 mins. COMPARE to hourly baseline. ALERT if volume > 3 stddev above baseline."
  - question: "Did a time-series model forecast an anomalous spike in new connections from an AD FS server immediately following a trust modification?"
    context: "This question uses advanced time-series forecasting to detect subtle anomalies in network connection patterns. An adversary might test a newly configured malicious trust by initiating a series of connections. A forecasting model can predict the normal rate of new connections, and if the actual count significantly exceeds the model's prediction right after a trust modification event, it can be flagged as a correlated anomaly requiring investigation."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 307"
      - "Windows Event ID 501"
      - "AD FS Servers"
      - "Network Perimeter Firewalls"
      - "ML Time-Series Model"
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: "INPUT connection count and trust modification events into time-series_model. IF actual_count exceeds prediction_interval after a modification event, ALERT."