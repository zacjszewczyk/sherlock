name: T1484.002: Trust Modification
id: c1b9a1e0-68d1-4b2f-8a9a-5e8e7f6d4c3b
description: This playbook focuses on detecting the modification of trust relationships
  for privilege escalation or defense evasion. It addresses adversarial actions such
  as adding malicious AD FS signing certificates, altering claim issuance policies
  to grant elevated privileges or bypass MFA, and creating new domain trusts to facilitate
  cross-domain attacks. The playbook also covers the malicious change of a domain's
  authentication method to 'Federated', the addition of malicious trusted realm URIs,
  the use of PowerShell to inject foreign certificates, and modifications performed
  from anomalous locations or at unusual times. These activities are often followed
  by suspicious network traffic, such as a spike in cross-domain authentications
  or unusual connections from AD FS servers to external identity providers.
type: technique
related:
- TA0004: Privilege Escalation
- TA0005: Defense Evasion
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a new AD FS signing certificate been added whose thumbprint matches
    a known-malicious indicator?
  context: This question uses a symbolic approach to detect known threats. Adversaries
    may add a signing certificate they control to an AD FS server to forge security
    tokens. By monitoring for new certificate additions (Windows Event ID 259) and
    comparing the certificate's thumbprint against a threat intelligence feed of
    malicious indicators, analysts can quickly identify the use of known attacker
    tools or infrastructure.
  answer_sources: Windows Event ID 259, Windows Event ID 4104, Active Directory Federation
    Services (AD FS) servers, Threat intelligence feeds
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      SEARCH for (Windows Event ID 259)
      EXTRACT certificate_thumbprint
      LOOKUP certificate_thumbprint against known_malicious_thumbprints
      IF match_found:
        ALERT (High Priority)
- question: Has a new AD FS signing certificate been added with anomalous properties
    or by an unusual user?
  context: This question uses statistical analysis to find outliers. Adversaries
    may generate new certificates whose properties (like subject or issuer name complexity)
    differ from legitimate ones. This query establishes a baseline for the Shannon
    entropy of certificate subject/issuer fields and flags new certificates that
    deviate significantly. It also baselines which users add certificates and alerts
    if a non-administrative account performs this sensitive action.
  answer_sources: Windows Event ID 259, Windows Event ID 4104, Active Directory Federation
    Services (AD FS) servers
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      FOR each new certificate (Event ID 259):
        CALCULATE entropy(subject_field), entropy(issuer_field)
        COMPARE to historical baseline (95th percentile)
        IF entropy > baseline_threshold:
          ALERT (Statistical Anomaly)

      TRACK user accounts adding certificates
      IF non-admin_user adds certificate:
        ALERT (Policy Violation)
- question: Does a newly added AD FS signing certificate have features that a machine
    learning model classifies as malicious?
  context: This question leverages a machine learning model for advanced detection.
    A classification model, trained on features like certificate validity period,
    key size, and issuer details, can score the likelihood of a new certificate being
    malicious. This approach can identify novel threats that may not match known indicators
    or simple statistical outliers, providing a more robust and adaptive detection
    capability.
  answer_sources: Windows Event ID 259, Windows Event ID 4104, Active Directory Federation
    Services (AD FS) servers
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      ON new certificate detection (Event ID 259):
        EXTRACT features (validity_period, key_size, issuer, subject_entropy, etc.)
        INPUT features into classification_model
        GET malicious_likelihood_score
        IF score > predefined_threshold:
          ALERT (ML Detection)
- question: Has an AD FS claim issuance policy been modified to include rules that
    grant high-privilege access or bypass MFA?
  context: This question looks for specific, high-risk rule modifications. Adversaries
    can alter claim rules (detected via Windows Event ID 501) to escalate privileges,
    for example, by adding the Administrator SID to a user's token or inserting a
    claim that bypasses multi-factor authentication. This query uses regular expressions
    to search for these specific malicious patterns within the rule change data.
  answer_sources: Windows Event ID 501, Windows Event ID 4104, Active Directory Federation
    Services (AD FS) servers
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      SEARCH for (Windows Event ID 501)
      EXTRACT policy_change_details
      REGEX_MATCH for ('S-1-5-32-544', 'multipleauthn', 'insidecorpenetwork') in policy_change_details
      IF match_found:
        ALERT (High-Privilege Rule Change)
- question: Has a claim issuance policy modification resulted in a statistically
    significant change in rule complexity, or was it performed by a first-time user?
  context: This question identifies anomalous changes based on statistical properties.
    Malicious rule additions may significantly increase the length or complexity
    (entropy) of the policy. This query baselines normal rule characteristics and
    flags modifications that cause a large deviation. It also tracks which accounts
    modify policies and alerts if a new, previously unseen account performs this
    action, indicating potential credential abuse.
  answer_sources: Windows Event ID 501, Windows Event ID 4104, Active Directory Federation
    Services (AD FS) servers
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      ON policy modification (Event ID 501):
        CALCULATE length(new_rule), entropy(new_rule)
        COMPARE to historical baseline (e.g., >3 standard deviations)
        IF deviation is significant:
          ALERT (Anomalous Rule Complexity)

      BASELINE accounts that modify policies
      IF new_account performs modification:
        ALERT (First-Time Policy Modifier)
- question: Has a machine learning model classified a recent claim issuance policy
    modification as 'unauthorized'?
  context: This question uses a supervised machine learning model to distinguish
    between legitimate and malicious changes. By training a model on historical changes
    labeled as 'authorized' or 'unauthorized' (e.g., from change management data),
    the system can learn the patterns of normal administrative behavior. It can then
    classify new modifications in real-time, considering features like the user,
    time of day, and the change content, to flag suspicious activity.
  answer_sources: Windows Event ID 501, Windows Event ID 4104, Active Directory Federation
    Services (AD FS) servers, Change management records
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      ON policy modification (Event ID 501):
        EXTRACT features (user, time_of_day, change_content)
        INPUT features into supervised_model
        GET classification_result
        IF classification_result == 'unauthorized':
          ALERT (Unauthorized Change Detected)
- question: Was a domain trust modification followed by a successful network logon
    from the new trust to a high-value asset?
  context: This question creates a correlation to detect immediate abuse of a new
    domain trust. An adversary might establish a new trust and immediately use it
    to access sensitive systems. This query looks for a trust modification event
    (Windows Event ID 4703) followed closely by a network logon (Windows Event ID
    4624, Logon Type 3) from an account in the new domain to a critical asset like
    a Domain Controller.
  answer_sources: Windows Event ID 4703, Windows Event ID 4624, Zeek conn.log, Domain
    Controllers, Network traffic flow points between domain security boundaries
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      TRIGGER on (Windows Event ID 4703)
      WITHIN 60 minutes, SEARCH for (Windows Event ID 4624, Logon Type 3)
      WHERE source_domain == new_trusted_domain from Event 4703
      AND destination_asset in high_value_asset_list
      ENRICH with Zeek conn.log to confirm traffic flow
      IF correlated_events_found:
        ALERT (Potential Trust Abuse)
- question: Did cross-domain authentication activity from a newly trusted domain
    increase to a statistically anomalous level?
  context: This question uses statistical analysis to identify abnormal authentication
    volume after a trust is established. After a new trust is created (Event ID 4703),
    a sudden, massive spike in authentications (Event ID 4624, Type 3) from that
    domain, far exceeding the normal volume seen from other legitimate trusts, can
    indicate an adversary is enumerating or attacking resources across the new trust
    boundary.
  answer_sources: Windows Event ID 4703, Windows Event ID 4624, Zeek conn.log, Domain
    Controllers, Network traffic flow points between domain security boundaries
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      TRIGGER on (Windows Event ID 4703)
      BASELINE hourly volume of (Event ID 4624, Type 3) from new_trusted_domain for 24 hours
      COMPARE volume to historical baseline from other trusts (99th percentile)
      IF volume > baseline_threshold:
        ALERT (Anomalous Cross-Domain Authentication Volume)
- question: Did a time-series anomaly detection model flag a spike in cross-domain
    authentications that was temporally linked to a trust modification?
  context: This question applies a machine learning model to find subtle anomalies
    in authentication patterns. A time-series model (like ARIMA) can forecast the
    expected volume of cross-domain authentications. By feeding trust modification
    events (Event ID 4703) into the model as an external factor, it can more accurately
    detect unexpected spikes in logons that are directly correlated with the trust
    change, indicating potential abuse.
  answer_sources: Windows Event ID 4703, Windows Event ID 4624, Zeek conn.log, Domain
    Controllers, Network traffic flow points between domain security boundaries
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      MODEL authentication volume (Event ID 4624, Type 3) with time-series_model
      INPUT (Event ID 4703) as an exogenous variable
      IF actual_volume significantly exceeds forecasted_volume post-event:
        ALERT (ML-Detected Authentication Anomaly)
- question: Was a domain's authentication method changed to 'Federated' by an account
    not on an authorized allow-list?
  context: This question enforces a strict policy on who can alter federation settings.
    An adversary with privileged credentials might change a domain from managed to
    federated to redirect authentication through an infrastructure they control. This
    query checks for the execution of federation-changing cmdlets or related event
    IDs (307, 510) and alerts if the action is performed by any user not on an explicit
    list of authorized administrators.
  answer_sources: Windows Event ID 307, Windows Event ID 510, Windows Event ID 4688,
    Windows Event ID 4104, Domain Controllers, AD FS Servers, Administrator Workstations
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      SEARCH for (cmdlet 'Set-MsolDomainFederationSettings' OR Event ID 307/510)
      EXTRACT user_account
      IF user_account NOT IN authorized_admin_list:
        ALERT (Unauthorized Federation Change)
- question: Was a domain's authentication method changed to 'Federated' outside of
    normal business hours?
  context: This question uses time-based statistical analysis to spot unusual activity.
    Legitimate, high-impact changes like modifying domain federation are typically
    done during scheduled change windows or normal business hours. This query establishes
    a baseline of when these changes normally occur and alerts on any modification
    that happens at a statistically anomalous time (e.g., late at night or on a weekend),
    which is a common indicator of malicious activity.
  answer_sources: Windows Event ID 307, Windows Event ID 510, Windows Event ID 4688,
    Windows Event ID 4104, Domain Controllers, AD FS Servers, Administrator Workstations
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      ANALYZE timestamps of all historical federation changes
      ESTABLISH baseline of normal activity times (e.g., 5th-95th percentile)
      ON new federation change:
      IF timestamp is outside baseline range:
        ALERT (Anomalous Time for Federation Change)
- question: Did a User and Entity Behavior Analytics (UEBA) model flag a federation
    settings change as a high-risk anomaly?
  context: This question leverages a sophisticated UEBA model to detect behavioral
    deviations. Even if a privileged account is used, the context of the action matters.
    A UEBA system profiles the normal behavior of each administrator (e.g., typical
    workstations, hours, types of actions). It would flag an event as anomalous if,
    for example, an admin who never touches federation settings suddenly modifies
    them from a server they've never logged into before.
  answer_sources: Windows Event ID 307, Windows Event ID 510, Windows Event ID 4688,
    Windows Event ID 4104, Domain Controllers, AD FS Servers, Administrator Workstations
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      INPUT all privileged user actions into UEBA model
      MODEL behavioral profile for each user (hosts, hours, commands)
      ON federation setting change:
      IF UEBA model flags the user's session or specific action as anomalous:
        ALERT (UEBA High-Risk Anomaly)
- question: Has a new trusted federation realm been added whose domain matches a known-malicious
    indicator?
  context: This question aims to detect the addition of a malicious federation trust
    using threat intelligence. Adversaries may add a new trusted issuer URI pointing
    to a domain they control for defense evasion. This query extracts the domain
    from any newly added trusted realm (from PowerShell or AD FS logs) and compares
    it against threat intelligence feeds of malicious domains, providing a high-fidelity
    alert on a match.
  answer_sources: Windows Event ID 307, Windows Event ID 510, Windows Event ID 4104,
    Zeek dns.log, Zeek intel.log, AD FS Servers, Domain Controllers, DNS Servers,
    Network Gateways
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      SEARCH for (Event ID 4104, 307, 510) indicating new trusted realm
      EXTRACT domain_from_URI
      LOOKUP domain_from_URI in threat_intel_feed
      IF match_found:
        ALERT (Malicious Federation Domain Added)
- question: Has a new trusted federation realm been added whose domain is newly registered
    or has high character entropy?
  context: This question uses statistical properties of the domain name to find suspicious
    federation trusts. Adversaries often use newly registered domains for their attacks.
    This query checks the registration date (via passive DNS or WHOIS) for any new
    issuer URI and flags very new domains. It also calculates the character entropy
    of the domain name to detect algorithmically generated or nonsensical names that
    deviate from legitimate corporate or partner domains.
  answer_sources: Windows Event ID 307, Windows Event ID 510, Windows Event ID 4104,
    Zeek dns.log, Zeek intel.log, AD FS Servers, Domain Controllers, DNS Servers,
    Network Gateways
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      ON new trusted realm addition:
        EXTRACT domain_from_URI
        QUERY passive DNS for domain_registration_date
        IF registration_date < 30 days ago:
          ALERT (Newly Registered Federation Domain)

        CALCULATE entropy(domain_from_URI)
        IF entropy > baseline_threshold (95th percentile):
          ALERT (High Entropy Federation Domain)
- question: Has a machine learning model classified a newly added trusted realm URI
    as likely malicious?
  context: This question uses a machine learning model, such as one designed to detect
    Domain Generation Algorithms (DGAs), to automatically assess new issuer URIs.
    These models analyze the lexical features of a domain name (length, character
    patterns, etc.) to determine if it was computer-generated, a common tactic for
    attackers. This provides an automated way to flag potentially malicious domains
    without relying on prior threat intelligence.
  answer_sources: Windows Event ID 307, Windows Event ID 510, Windows Event ID 4104,
    Zeek dns.log, Zeek intel.log, AD FS Servers, Domain Controllers, DNS Servers,
    Network Gateways
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      ON new trusted realm addition:
        EXTRACT domain_from_URI
        INPUT domain_from_URI into DGA_detection_model
        GET malicious_probability_score
        IF score > predefined_threshold:
          ALERT (ML Detected Malicious Federation Domain)
- question: Have federation settings been modified to use a foreign token-signing
    certificate or an unapproved issuer URI?
  context: This question looks for specific cmdlet parameters that indicate an attacker
    is hijacking the federation trust. By monitoring PowerShell logs (Event ID 4104)
    for cmdlets like 'Update-MSOLFederatedDomain', this query can flag invocations
    where an attacker specifies an issuer URI not on an allow-list or injects a token-signing
    certificate that was not issued by the organization's trusted internal PKI.
  answer_sources: Windows Event ID 4688, Windows Event ID 4104, AD FS Servers, Domain
    Controllers, Administrator Workstations
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      SEARCH PowerShell logs (Event ID 4104) for 'Update-MSOLFederatedDomain' or 'Set-MsolDomainFederationSettings'
      EXTRACT parameters '-IssuerUri', '-SigningCertificate'
      IF '-IssuerUri' is not in approved_domain_list:
        ALERT (Unapproved Issuer URI)
      IF '-SigningCertificate' is not from internal_PKI:
        ALERT (Foreign Signing Certificate)
- question: Have federation-related PowerShell cmdlets been executed with a statistically
    rare combination of parameters?
  context: This question aims to find unusual command invocations by analyzing parameter
    usage. Legitimate administrative tasks often use common, predictable sets of
    parameters. An attacker might use a rare parameter or a novel combination of
    parameters. This query creates a frequency distribution of parameter sets for
    federation cmdlets and flags any execution that uses a combination seen in less
    than 1% of historical invocations.
  answer_sources: Windows Event ID 4688, Windows Event ID 4104, AD FS Servers, Domain
    Controllers, Administrator Workstations
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      LOG all parameters used with federation cmdlets
      CREATE frequency distribution of parameter combinations
      ON new cmdlet execution:
      IF parameter_combination_frequency < 1%:
        ALERT (Statistically Rare Cmdlet Usage)
- question: Has an anomaly detection model identified the execution of a federation-related
    cmdlet as a novel or unusual event?
  context: This question uses an unsupervised machine learning model (like an Isolation
    Forest) to identify anomalous command-line activity. The model is trained on
    a broad feature set of command executions, including the user, source host, and
    all parameters. It can identify novel invocations that deviate from established
    administrative patterns, even if the user has the correct permissions, pointing
    to a potential credential compromise or insider threat.
  answer_sources: Windows Event ID 4688, Windows Event ID 4104, AD FS Servers, Domain
    Controllers, Administrator Workstations
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      TRAIN anomaly_detection_model on features (command, parameters, user, host)
      ON new federation cmdlet execution:
        INPUT execution_features into model
        IF model classifies as anomaly:
          ALERT (Anomalous Command-Line Invocation)
- question: Was a domain trust modified by a privileged account that logged in from
    a geographically unapproved location?
  context: This question uses geolocation to detect potentially compromised privileged
    accounts. This query establishes a 'geofence' of approved countries for administrative
    access. If a trust modification event (like Event ID 4703 or 307) is preceded
    by a logon event (Event ID 4624) from an IP address that geolocates outside of
    this approved list, it generates a high-priority alert for a likely account takeover.
  answer_sources: Windows Event ID 4703, Windows Event ID 307, Windows Event ID 4624,
    Zeek conn.log, Domain Controllers, AD FS Servers, VPN Concentrators, Cloud Access
    Security Broker (CASB)
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      TRIGGER on trust modification (Event ID 4703, 307) by 'user_X'
      SEARCH for preceding logon (Event ID 4624) by 'user_X'
      EXTRACT source_IP from logon event
      GEO-LOCATE source_IP
      IF country NOT IN approved_country_list:
        ALERT (Trust Modification from Unapproved Location)
- question: Was a domain trust modified by a privileged account logging in at an
    anomalous time or from an anomalous location?
  context: This question uses statistical baselining of user behavior to score the
    risk of a trust modification. For each privileged user, it builds a profile of
    normal login times and source IP subnets/countries. When a trust modification
    occurs, it examines the preceding login. If the login is a statistical outlier
    (e.g., unusual time, first-time access from a country), it adds to a risk score,
    and an alert is generated if the score exceeds a threshold.
  answer_sources: Windows Event ID 4703, Windows Event ID 307, Windows Event ID 4624,
    Zeek conn.log, Domain Controllers, AD FS Servers, VPN Concentrators, Cloud Access
    Security Broker (CASB)
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      FOR each privileged user:
        BASELINE normal_login_times and normal_login_countries
      ON trust modification by 'user_X':
        GET preceding login for 'user_X'
        CALCULATE risk_score based on deviation from time/country baselines
        IF risk_score > threshold:
          ALERT (High-Risk Trust Modification)
- question: Did a UEBA model flag a user's session as anomalous when a trust modification
    occurred?
  context: This question uses a comprehensive UEBA model to detect when a legitimate
    action occurs within a suspicious context. The UEBA platform models the holistic
    session behavior of a user—login time, source IP, commands run, resources accessed.
    If a trust modification is performed during a session that the model has already
    flagged as anomalous for any reason, the action is considered highly suspicious
    and warrants immediate investigation.
  answer_sources: Windows Event ID 4703, Windows Event ID 307, Windows Event ID 4624,
    Zeek conn.log, Domain Controllers, AD FS Servers, VPN Concentrators, Cloud Access
    Security Broker (CASB)
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      INPUT session data (login, commands, resource access) into UEBA model
      ON trust modification:
      CHECK if the current user session is flagged as anomalous by UEBA
      IF session is anomalous:
        ALERT (Trust Modification in Anomalous Session)
- question: Following a trust modification, did an AD FS server connect to an external
    endpoint with an unapproved SNI?
  context: This question seeks to identify post-modification C2 or data exfiltration
    activity. After modifying a trust, an adversary might have the AD FS server connect
    to an external endpoint. This query monitors for trust modification events (e.g.,
    Event ID 307) and then checks subsequent outgoing SSL/TLS connections from the
    AD FS server. If a connection is made to a destination whose Server Name Indication
    (SNI) is not on a pre-approved list of known partners, it is flagged as suspicious.
  answer_sources: Zeek conn.log, Zeek ssl.log, Windows Event ID 307, Windows Event
    ID 501, AD FS Servers, Network Perimeter Firewalls, DNS Servers
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      TRIGGER on trust modification (Event ID 307, 501) on 'ADFS_server'
      WITHIN 5 minutes, SEARCH Zeek ssl.log for connections FROM 'ADFS_server'
      EXTRACT SNI from SSL connection
      IF SNI NOT IN approved_SNI_list:
        ALERT (ADFS Connection to Unapproved Endpoint)
- question: Following a trust modification, was there a statistically significant
    spike in data volume transferred from an AD FS server to external identity providers?
  context: This question uses network flow data to detect anomalous data transfer
    potentially related to a trust compromise. This query establishes a baseline for
    the normal hourly volume of data transferred from AD FS servers to known external
    identity provider endpoints. If a trust modification event is followed by a spike
    in data transfer that is more than three standard deviations above the baseline,
    it could indicate an adversary exploiting the new trust.
  answer_sources: Zeek conn.log, Zeek ssl.log, Windows Event ID 307, Windows Event
    ID 501, AD FS Servers, Network Perimeter Firewalls, DNS Servers
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      BASELINE hourly data volume (Zeek conn.log bytes) from AD FS servers to external IdPs
      TRIGGER on trust modification (Event ID 307, 501)
      WITHIN 30 minutes, MONITOR data volume from AD FS server
      IF volume > (baseline_mean + 3 * baseline_stdev):
        ALERT (Anomalous Data Transfer from ADFS Server)
- question: Did a time-series model forecast an anomaly in the connection count from
    an AD FS server immediately following a trust modification?
  context: This question uses machine learning to detect subtle changes in network
    behavior correlated with a trust modification. A time-series forecasting model
    can predict the normal number of connections per minute from an AD FS server to
    external IdPs. If the actual number of connections significantly exceeds the model's
    forecasted range shortly after a trust modification event is logged, it flags
    a correlated anomaly that may indicate an adversary testing or exploiting the
    new trust.
  answer_sources: Zeek conn.log, Zeek ssl.log, Windows Event ID 307, Windows Event
    ID 501, AD FS Servers, Network Perimeter Firewalls, DNS Servers
  range: Last 90 days
  queries:
  - search_technology: pseudocode
    query: |
      MODEL connection_count_per_minute from AD FS with time-series_model
      TRIGGER on trust modification event
      WITHIN a short window post-event:
      IF actual_connection_count > model_prediction_interval:
        ALERT (Correlated Network Anomaly After Trust Mod)