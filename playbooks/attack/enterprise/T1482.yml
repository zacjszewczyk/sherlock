name: T1482: Domain Trust Discovery
id: a2b1c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps to determine if an adversary is attempting to discover domain trust relationships. Adversaries may use known recon tools (like BloodHound), native utilities (like nltest.exe, powershell.exe), or direct LDAP queries to enumerate domain trusts. This activity can be identified by looking for specific process hashes, command-line arguments, anomalous parent-child process relationships (e.g., WINWORD.EXE spawning nltest.exe), unauthorized LDAP queries for 'trustedDomain' objects, and logical sequences of discovery commands executed in a short time frame from a single host.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there any process creation events where the executable hash matches a known indicator of compromise for a domain reconnaissance tool?
    context: This question aims to detect the use of known malicious tools like BloodHound/SharpHound by comparing file hashes of newly created processes against a threat intelligence feed. A match provides a high-fidelity signal that an adversary is using a specific, recognized tool for domain reconnaissance.
    answer_sources:
      - Windows Event ID 4688 from Domain Controllers, Member Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Search process creation events (EID 4688) for file hashes present in malicious tool hash list. Alert on match.
  - question: Are there any process creation events for executables that are extremely rare within the enterprise?
    context: This question focuses on identifying outlier behavior. Adversaries often introduce tools that are not standard across the environment. By calculating the prevalence of every executable hash, we can flag those that appear on a very small number of endpoints, which could indicate an unauthorized or malicious tool deployment.
    answer_sources:
      - Windows Event ID 4688 from Domain Controllers, Member Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Calculate prevalence of all file hashes from process creation events over 30 days. Alert on hashes with prevalence below 1st percentile.
  - question: Can we use machine learning to classify process executions as benign or suspicious based on their attributes?
    context: This question proposes a more advanced, model-based detection approach. By training a classifier on features like process name, parent process, command-line attributes, and hash prevalence, the model can learn to identify subtle signs of malicious activity. A 'suspicious' classification, especially for a rare process, is a strong indicator of a threat.
    answer_sources:
      - Windows Event ID 4688 from Domain Controllers, Member Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Input process event features (name, parent, CLI, hash prevalence) into a trained classification model. Alert on 'suspicious' classification.
  - question: Are native utilities like nltest.exe or powershell.exe being executed with command-line arguments specific to domain trust enumeration?
    context: This question targets the 'living-off-the-land' technique where adversaries use legitimate system tools for malicious purposes. By creating specific rules to look for command-line arguments like '/domain_trusts' or 'Get-ADTrust', we can detect when these native utilities are being used for reconnaissance.
    answer_sources:
      - Windows Event ID 4688 from Domain Controllers, Member Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Search command-line logs (from EID 4688) for regex patterns like 'nltest.exe /domain_trusts' or 'Get-ADTrust'. Alert on match.
  - question: Are users or hosts executing domain trust discovery commands anomalously compared to their established baseline?
    context: This question aims to find unusual behavior by baselining normal activity. Administrative users might run discovery commands occasionally, but a non-admin user or a server running one for the first time is highly suspicious. This method detects deviations from normal patterns, which can indicate compromised accounts or hosts.
    answer_sources:
      - Windows Event ID 4688 from Domain Controllers, Member Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Baseline command-line execution frequency per user/host. Alert if discovery command frequency exceeds 2 standard deviations from baseline.
  - question: Are there rare or unique command-line patterns related to domain trust discovery being used?
    context: This question seeks to find novel or obfuscated attack techniques. Adversaries may try to disguise their commands. By using unsupervised clustering on command-line strings, we can group similar commands and identify outliers or small clusters that represent unusual syntax, potentially uncovering new methods of domain trust enumeration.
    answer_sources:
      - Windows Event ID 4688 from Domain Controllers, Member Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Cluster command-line strings using an algorithm like DBSCAN. Investigate rare clusters containing discovery-related keywords.
  - question: Is a domain trust discovery command being executed by a suspicious parent process like an office application or web server?
    context: This question focuses on process lineage to find illogical or suspicious behavior. A tool like 'nltest.exe' should not be spawned by Microsoft Word ('WINWORD.EXE') or a web server process ('w3wp.exe'). Such an event strongly suggests that the parent process has been compromised and is being used to launch reconnaissance activities.
    answer_sources:
      - Windows Event ID 4688 from Web Servers, Application Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Search process creation events (EID 4688) where child process is a discovery tool and parent process is in a suspicious list (e.g., WINWORD.EXE, OUTLOOK.EXE).
  - question: Are there any statistically rare parent-child process relationships involving domain discovery tools?
    context: This question uses probability to identify anomalies in process creation chains. By analyzing all parent-child process relationships across the enterprise, we can identify pairs that occur very infrequently. A low-probability pairing, such as 'WINWORD.EXE' spawning 'nltest.exe', is a strong statistical indicator of malicious activity.
    answer_sources:
      - Windows Event ID 4688 from Web Servers, Application Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Calculate frequency distribution of all parent-child process pairs. Alert on pairs involving discovery tools that have a very low probability (e.g., < 0.1%).
  - question: Can graph-based anomaly detection identify unusual process execution chains that terminate in a discovery command?
    context: This question proposes modeling process activity as a graph to uncover complex attack paths. Instead of just looking at parent-child pairs, this method analyzes entire chains of process creation. Anomaly detection algorithms can then identify rare or never-before-seen paths, which are highly indicative of an adversary moving through a system.
    answer_sources:
      - Windows Event ID 4688 from Web Servers, Application Servers, User Workstations
    range: last 90 days
    queries:
      - pseudocode: Build process lineage graphs from event logs. Use a graph anomaly detection algorithm to find rare execution chains ending in a discovery command.
  - question: Are there any LDAP queries for 'trustedDomain' objects originating from hosts that are not authorized administrative systems or Domain Controllers?
    context: This question examines network traffic for direct signs of domain trust reconnaissance. LDAP is a common protocol for this activity. By creating a rule that checks for queries targeting 'trustedDomain' objects from unauthorized source IPs, we can catch reconnaissance attempts at the network level.
    answer_sources:
      - Zeek ldap.log, Zeek conn.log from Network taps monitoring traffic to and from Domain Controllers, Core network switch SPAN ports
    range: last 90 days
    queries:
      - pseudocode: Monitor Zeek ldap.log for events where search_filter contains '(objectClass=trustedDomain)' and id.orig_h is not in the approved DC/admin list.
  - question: Is a non-DC host exhibiting an unusual spike in the diversity of its LDAP queries?
    context: This question uses information theory to detect reconnaissance behavior. A reconnaissance tool often issues a wide variety of LDAP queries to explore the domain structure. By calculating the entropy of the query filters for each source host, a sudden spike for a non-administrative host can indicate that it's performing broad reconnaissance.
    answer_sources:
      - Zeek ldap.log, Zeek conn.log from Network taps monitoring traffic to and from Domain Controllers, Core network switch SPAN ports
    range: last 90 days
    queries:
      - pseudocode: Calculate Shannon entropy of LDAP search_filter per source IP over 1-hour windows. Alert if entropy for a non-DC host exceeds 95th percentile of its baseline.
  - question: Can time-series analysis detect uncharacteristic bursts of LDAP query volume from a single host?
    context: This question applies machine learning to network traffic volume to spot anomalies. Reconnaissance scripts often generate a sudden burst of activity. A time-series model can learn the normal 'rhythm' of LDAP traffic for each host and flag sudden, high-volume deviations that don't fit the learned pattern.
    answer_sources:
      - Zeek ldap.log, Zeek conn.log from Network taps monitoring traffic to and from Domain Controllers, Core network switch SPAN ports
    range: last 90 days
    queries:
      - pseudocode: Use a trained time-series anomaly detection model on LDAP query volume per host. Alert on detected anomalies.
  - question: Has a single host executed a known sequence of discovery commands within a short time frame?
    context: This question looks for a 'playbook' of attacker actions by correlating discrete events. An adversary often follows a logical progression of commands (e.g., find out who I am, find the domain trusts, find other computers). By defining and searching for these sequences, we can detect a 'living-off-the-land' reconnaissance campaign in progress.
    answer_sources:
      - Windows Event ID 4688, Zeek conn.log from Enterprise-wide endpoint log collection points, Network sensor data aggregators
    range: last 90 days
    queries:
      - pseudocode: Use a stateful rule to detect a sequence like (whoami) -> (nltest /domain_trusts) -> (net view) from a single host within 60 minutes.
  - question: Has any host accumulated a high risk score based on the execution of multiple discovery-related commands over time?
    context: This question uses a risk scoring model to quantify suspicious behavior. Instead of a single alert, this method accumulates evidence. Each suspicious command adds points to a host's score, with older events decaying in value. When a host's score crosses a high threshold, it signifies a sustained pattern of suspicious activity that warrants immediate investigation.
    answer_sources:
      - Windows Event ID 4688, Zeek conn.log from Enterprise-wide endpoint log collection points, Network sensor data aggregators
    range: last 90 days
    queries:
      - pseudocode: Assign points to discovery commands with a time-decay function. Alert when a host's cumulative score exceeds a statistical threshold (e.g., 99th percentile).
  - question: Can a Hidden Markov Model identify sequences of system activity that match known adversary behavior patterns?
    context: This question proposes a sophisticated probabilistic model to understand the adversary's state. An HMM can be trained to recognize the typical transitions between stages of an attack (e.g., from 'Local Discovery' to 'Domain Discovery'). When live events suggest a sequence of transitions that is highly improbable for benign activity but probable for an attack, it can generate a high-confidence alert.
    answer_sources:
      - Windows Event ID 4688, Zeek conn.log from Enterprise-wide endpoint log collection points, Network sensor data aggregators
    range: last 90 days
    queries:
      - pseudocode: Feed live event data into a trained HMM. Alert on sequences of state transitions that have a low probability under the benign model.