name: T1546.009: AppCert DLLs
id: 2c8c4f1e-8e4a-4d2b-9e8c-5a6b7c8d9e0f
description: This playbook focuses on detecting adversaries leveraging AppCert DLLs for persistence and privilege escalation. It provides investigative questions to identify malicious modifications to the HKLM\System\CurrentControlSet\Control\Session Manager\AppCertDLLs registry key, correlating these changes with subsequent suspicious activities such as the creation of DLLs in unusual locations, anomalous process behavior, unexpected network connections, and privilege escalation events like adding users to administrative groups.
type: technique
related:
- TA0003: Persistence
- TA0004: Privilege Escalation
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has the AppCertDLLs registry key been modified to point to a DLL with a known malicious name or hash?
  context: Adversaries often use known malicious tools or reuse code. This question aims to detect persistence attempts by checking if a newly registered AppCert DLL matches any indicators in threat intelligence feeds. A match provides a high-confidence signal of malicious activity.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 13
  - Threat Intelligence Feeds
  - NAI: Domain Controllers, Tier 0 Servers, Executive Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH registry events for modifications to 'HKLM\System\CurrentControlSet\Control\Session Manager\AppCertDLLs'. FOREACH event, EXTRACT new DLL path. HASH the DLL file. LOOKUP DLL name and hash in threat intelligence. ALERT on match.
- question: Has the AppCertDLLs registry key been modified to point to a DLL with a high-entropy or seemingly randomized file path?
  context: Randomized or obfuscated file paths are a common tactic used by adversaries to evade signature-based detection and make analysis more difficult. This question seeks to identify such paths by measuring their string entropy against a baseline of normal paths in the environment. An unusually high entropy score is a strong indicator of suspicious activity.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 13
  - NAI: Domain Controllers, Tier 0 Servers, Executive Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH registry events for modifications to 'HKLM\System\CurrentControlSet\Control\Session Manager\AppCertDLLs'. FOREACH event, EXTRACT new DLL path. CALCULATE string entropy of the path. COMPARE entropy to historical baseline. ALERT if entropy > 95th percentile.
- question: Does a modification to the AppCertDLLs registry key exhibit characteristics identified as malicious by a trained machine learning model?
  context: This question leverages a machine learning model to perform advanced anomaly detection. By analyzing features like the parent process of the writing process, path characteristics, and historical frequency, the model can identify subtle or complex patterns of malicious behavior that might be missed by simple rules. A high-probability prediction from the model indicates a likely malicious event.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 13
  - NAI: Domain Controllers, Tier 0 Servers, Executive Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH registry events for modifications to 'HKLM\System\CurrentControlSet\Control\Session Manager\AppCertDLLs'. FOREACH event, EXTRACT features (parent process, path length, special chars, etc.). INPUT features into trained classification model. ALERT if model output > high probability threshold.
- question: Was a DLL recently created in a world-writable directory (e.g., C:\Users\Public, %TEMP%) just before the AppCertDLLs registry key was modified to point to it?
  context: Adversaries often drop their malicious payloads into world-writable directories to ensure they have the necessary permissions. This question looks for a tight temporal correlation between a DLL being created in such a location and its subsequent registration as an AppCert DLL. This sequence of events is highly suspicious and strongly suggests a persistence attempt.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 11
  - NAI: Standard User Workstations, Multi-user Servers (e.g., Citrix, RDS)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for DLL file creation events in world-writable directories. CORRELATE by hostname with registry modification events to 'AppCertDLLs' that occur within 5 minutes, where the registry value matches the created DLL path. ALERT on correlation.
- question: Was the AppCertDLLs key modified to point to a new DLL in a public directory by a process that rarely performs this action?
  context: Legitimate software installers might perform this sequence of actions, but it's typically done by a predictable set of processes. This question aims to identify anomalous behavior by baselining which processes normally write DLLs to public/temp folders and then modify the AppCertDLLs key. If a process that has rarely or never performed this action before does so, it is a strong indicator of malicious activity.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 11
  - NAI: Standard User Workstations, Multi-user Servers (e.g., Citrix, RDS)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for correlated DLL creation in public dirs and AppCertDLLs registry mods. EXTRACT the parent process name. COMPARE process name against a historical baseline of processes performing this action sequence. ALERT if process frequency is < 5th percentile.
- question: Did the sequence of a DLL being written to a world-writable directory followed by an AppCertDLLs modification represent a statistically improbable event chain on the affected host?
  context: This question uses a sequence analysis model to understand normal chains of events on an endpoint. The model learns which actions typically follow others. A transition from a DLL write in a public folder to an AppCertDLLs registry modification is likely to be a very low-probability event in a normal environment. The model can flag this sequence as a significant anomaly, even if the individual events are not inherently suspicious.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 11
  - NAI: Standard User Workstations, Multi-user Servers (e.g., Citrix, RDS)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: INPUT endpoint event streams (file writes, registry mods) into a trained sequence analysis model. DEFINE states for 'DLL write to world-writable dir' and 'AppCertDLLs mod'. ALERT if the model flags a low-probability transition between these states.
- question: Following an AppCertDLLs modification, did a critical system process spawn a suspicious child process like a command-line interpreter?
  context: A malicious AppCert DLL will be loaded into every process that calls CreateProcess. This can lead to code execution within the context of legitimate, high-privilege system processes. This question looks for the immediate aftermath of this injection, specifically focusing on critical processes like lsass.exe or wininit.exe spawning any children, or other common processes spawning interpreters (cmd.exe, powershell.exe), which is highly indicative of compromise.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Zeek notice.log
  - NAI: All Endpoints and Servers, Internet Gateway, DNS Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. WITHIN 1 hour on the same host, SEARCH for process creation events where ParentProcess is a critical system process (lsass.exe, etc.) and ChildProcess is a command interpreter (cmd.exe, powershell.exe). ALERT on match.
- question: Following an AppCertDLLs modification, did the affected host initiate outbound network connections using a rare or non-standard TLS client fingerprint (JA3/JA3S)?
  context: Malware often uses custom cryptographic libraries or non-standard methods to establish C2 communications. This can result in a unique TLS client fingerprint (JA3/JA3S hash). This question checks for rare or anomalous TLS fingerprints from a host shortly after a suspected AppCert DLL persistence event, which could indicate the malware 'calling home'.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Zeek notice.log
  - NAI: All Endpoints and Servers, Internet Gateway, DNS Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. WITHIN 1 hour on the same host, SEARCH for outbound TLS connections. CALCULATE JA3/JA3S hash for each connection. COMPARE hash pair against a baseline of common pairs in the environment. ALERT if the pair's frequency is < 5th percentile.
- question: Did a host exhibit anomalous outbound network behavior (e.g., unusual data volume, connection counts, port usage) shortly after an AppCertDLLs modification?
  context: Once a malicious AppCert DLL is loaded, it may initiate C2 communication or data exfiltration, causing a change in the host's normal network traffic patterns. This question uses a time-series model to detect significant deviations from the host's established network baseline (e.g., bytes sent, connection frequency) immediately following a registry modification, which could signal the activation of the malicious DLL.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Zeek notice.log
  - NAI: All Endpoints and Servers, Internet Gateway, DNS Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. FOR the affected host, INPUT subsequent network metrics (bytes out, connection count) into a time-series anomaly detection model. ALERT if the model detects a significant deviation from the forecasted baseline.
- question: Was a user account added to a high-privilege group (e.g., Administrators, Domain Admins) shortly after the AppCertDLLs registry key was modified on the same host?
  context: A common goal after gaining persistence is to escalate privileges. This question looks for a direct correlation between an AppCert DLL modification and a subsequent privilege escalation event, such as a user being added to a powerful administrative group. The tight time window between these two events strongly suggests the AppCert DLL was used to gain the necessary access to perform the group modification.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4720
  - Windows Event ID 4732
  - Windows Event ID 4728
  - NAI: Domain Controllers, Identity and Access Management Systems, Critical Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. CORRELATE by hostname with user-to-group addition events (for privileged groups) occurring within 10 minutes. ALERT on correlation.
- question: Following an AppCertDLLs modification, was a privileged group membership changed by a user or process that rarely or never performs this action?
  context: Privileged group modifications are sensitive and typically performed by a small, predictable set of administrative accounts or system processes. This question aims to detect abuse by identifying when such a change is made by an anomalous actor (user or process) shortly after an AppCertDLLs modification. This indicates the malicious DLL may have provided the capability for an unexpected account to perform privilege escalation.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4720
  - Windows Event ID 4732
  - Windows Event ID 4728
  - NAI: Domain Controllers, Identity and Access Management Systems, Critical Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for correlated AppCertDLLs mods and privileged group changes. EXTRACT the user/process that performed the group change. COMPARE actor against a baseline of typical actors for this action. ALERT if actor frequency is < 1st percentile.
- question: Based on a machine learning model, does the sequence of an AppCertDLLs modification followed by a privileged group change have a high probability of being malicious?
  context: This question applies a machine learning model to assess the likelihood that a correlated AppCertDLLs modification and privilege escalation event is malicious. The model considers multiple features, such as the process involved, user context, and time delta, to provide a more nuanced risk score than a simple rule. A high confidence score from the model provides a strong signal of a sophisticated attack.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4720
  - Windows Event ID 4732
  - Windows Event ID 4728
  - NAI: Domain Controllers, Identity and Access Management Systems, Critical Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for correlated AppCertDLLs mods and privileged group changes. EXTRACT features (process name, user context, time delta, etc.). INPUT features into a trained classification model. ALERT if model confidence > 0.9.
- question: Did a high-integrity system process (e.g., services.exe, lsass.exe) spawn a command-line interpreter shortly after an AppCertDLLs modification?
  context: Malicious AppCert DLLs, once loaded into a SYSTEM-level process, can be used to spawn other processes with the same elevated privileges. The spawning of a command shell (cmd.exe or powershell.exe) from a process that should never do so (like lsass.exe) is a classic sign of code injection and privilege escalation. This question looks for this specific, high-fidelity indicator of compromise.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - NAI: Domain Controllers, All Windows Servers, Privileged Access Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. WITHIN 5 minutes on the same host, SEARCH for process creation events where ParentProcess is a high-integrity system process and ChildProcess is cmd.exe or powershell.exe. ALERT on match.
- question: Following an AppCertDLLs modification, was a statistically rare parent-child process relationship observed?
  context: Endpoints have predictable process lineage patterns (e.g., explorer.exe spawning cmd.exe). Adversaries leveraging code injection via AppCert DLLs will create new, unexpected parent-child relationships. This question uses a probabilistic model to identify these anomalous process chains. A process creation event with a very low conditional probability of occurring is a strong indicator of malicious code execution.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - NAI: Domain Controllers, All Windows Servers, Privileged Access Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. WITHIN 5 minutes on the same host, SEARCH for process creation events. FOR each event, CALCULATE the conditional probability P(Child|Parent) based on a historical baseline. ALERT if probability < 0.01.
- question: Did a process creation event following an AppCertDLLs modification create an anomalous link between previously unrelated process trees in the process graph?
  context: This question models process activity as a graph, where processes are nodes and parent-child relationships are edges. Malicious code injection can create bizarre connections, such as a system service process suddenly spawning a child of a user's browser process. This graph-based approach can detect such structurally anomalous relationships that indicate a compromise has bridged two distinct execution contexts.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - NAI: Domain Controllers, All Windows Servers, Privileged Access Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. ANALYZE subsequent process creation events on the host. CONSTRUCT a process lineage graph. APPLY graph anomaly detection to identify new edges that connect previously disconnected subgraphs. ALERT on such connections.
- question: Was the AppCertDLLs registry key modified by a process that was spawned from a common user application like a web browser or Microsoft Office document?
  context: Modifying the AppCertDLLs key requires administrative privileges and should not be performed by a standard user application. This question looks for a process lineage where the process modifying the registry key originates from a common user application (e.g., Word, Outlook, Chrome). This is a strong indicator of a successful exploit chain, where a user opened a malicious document or visited a malicious site, leading to code execution that escalated privileges to modify the system for persistence.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - NAI: All User Endpoints, Virtual Desktop Infrastructure (VDI)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. GET the ProcessName and its ParentProcess. CHECK if the ParentProcess is on a watchlist of common user applications (winword.exe, chrome.exe, etc.). ALERT on match.
- question: Was the AppCertDLLs registry key modified by a process running at a Medium or Low integrity level?
  context: The AppCertDLLs registry key is protected and should only be modifiable by processes running with High or SYSTEM integrity. A modification originating from a Medium or Low integrity process is a major security violation and a definitive sign of a successful privilege escalation exploit. This question checks for this specific condition, which provides high-confidence evidence of a compromise.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - NAI: All User Endpoints, Virtual Desktop Infrastructure (VDI)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. EXTRACT the integrity level of the writing process. ALERT if integrity level is 'Medium' or 'Low'.
- question: Does the process lineage of a process modifying the AppCertDLLs key match a pattern classified as suspicious by a decision tree model?
  context: This question uses a decision tree model to formalize the logic of identifying suspicious process lineages. By training the model on known good and bad examples, it can learn the complex rules that differentiate legitimate system maintenance from a malicious exploit chain (e.g., a process tree originating from a browser with changing integrity levels). This provides a robust and automated way to detect sophisticated attacks.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - NAI: All User Endpoints, Virtual Desktop Infrastructure (VDI)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH for AppCertDLLs modification events. EXTRACT process lineage features (process, parent, grandparent, integrity levels). INPUT features into a trained decision tree classifier. ALERT if classified as suspicious.