name: 'T1568.003: DNS Calculation'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: "This playbook helps investigate whether an adversary has established command and control by calculating C2 endpoints from DNS query responses. Adversaries may use this technique to dynamically determine a C2 port or IP address, making detection more difficult. Indicators include internal hosts connecting to ports that are mathematical derivatives of resolved IP octets, connections to non-standard ports shortly after querying suspicious domains (e.g., high entropy, newly registered), DNS queries for domains with characteristics of algorithmic generation (DGA), an unusual increase in NXDOMAIN responses, and highly regular network beaconing activity following a suspicious DNS query."
type: 'technique'
related:
  - 'TA0011: Command and Control'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: '1.0'
tags: 'none'
questions:
  - question: "Is a host making a network connection to a port that was algorithmically calculated from a recent DNS query response?"
    context: "This question aims to proactively detect C2 activity where the communication port is not fixed but is instead calculated from the octets of a resolved IP address. By scripting checks that simulate known calculation algorithms (e.g., sum of octets, XOR operations) and correlating them with network connection logs within a short time window, analysts can identify this evasive technique."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS Resolvers"
      - "Egress Network Gateways"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each successful DNS A-record, simulate known C2 port calculation algorithms on the resolved IP. SEARCH network connection logs within 60 seconds for an outbound connection from the same source host to the same resolved IP, but on the calculated port. ALERT on any match."
  - question: "Are there hosts consistently connecting to high-numbered ports where the port number has a fixed mathematical relationship with the resolved IP address?"
    context: "This question provides a reactive method to discover DNS calculation. It works backward from observed connections on non-standard ports (>1024). By correlating these connections to recent DNS queries and calculating the difference between the port and various arithmetic combinations of the IP's octets, analysts can identify hosts where this difference is consistently a small, fixed value, suggesting a static calculation algorithm is in use."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS Resolvers"
      - "Egress Network Gateways"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR every connection to a port > 1024, find the most recent DNS query for that destination IP from the same source. CALCULATE the delta between the port and combinations of the IP's octets. USE a moving average to FLAG hosts where this delta is consistently near zero across multiple connections."
  - question: "Can we use machine learning to detect outlier network connections that are likely the result of DNS calculation for C2?"
    context: "This question proposes an advanced, model-based approach to detection. By creating a feature set for DNS/network events (domain entropy, IP reputation, port number, vector of calculated values) and feeding it to an unsupervised learning model like Isolation Forest, analysts can identify anomalous connections that deviate from normal behavior. This is effective for detecting novel or complex algorithms that evade simple rule-based logic."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS Resolvers"
      - "Egress Network Gateways"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: CREATE a feature set from correlated DNS and network events, including domain entropy, IP reputation, destination port, and a vector of calculated values from the IP. TRAIN an unsupervised learning model on this data. ISOLATE and ALERT on outliers where ports show strong correlation with the calculated vector."
  - question: "Is a host connecting to a non-standard, high-numbered port immediately after resolving a known malicious or suspicious domain?"
    context: "This question focuses on correlating suspicious DNS activity with subsequent network behavior. Adversaries often pair DNS calculation with domains from threat intelligence feeds. This query creates a rule to specifically look for the sequence of a DNS query for a known C2 domain followed within 60 seconds by a connection to a non-standard port (>1024), which is a strong indicator of compromise."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Egress Firewalls/Proxies"
      - "Internal DNS Resolvers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: CREATE a rule that joins DNS logs with network connection logs. ALERT when a connection to a port > 1024 (and not on an approved list) occurs within 60 seconds of a DNS query for a domain that is present on a C2 threat intelligence feed."
  - question: "Is a host connecting to an unusually high port number for our organization after querying a low-reputation or high-entropy domain?"
    context: "This question aims to identify anomalous port usage by establishing a baseline of normal behavior. By calculating the 99th percentile of destination ports used across the organization, analysts can create a dynamic threshold for 'unusual' ports. An alert is triggered when a host connects to a port exceeding this percentile shortly after querying a domain that is algorithmically generated (high entropy) or has a poor reputation, indicating a likely C2 channel."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Egress Firewalls/Proxies"
      - "Internal DNS Resolvers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: ESTABLISH a baseline of destination port usage and calculate the 99th percentile. ALERT when a host makes a connection to a port exceeding this percentile within 60 seconds of querying a domain with high entropy or a low reputation score."
  - question: "Can we detect anomalous spikes in connections to high-numbered ports that are preceded by suspicious DNS activity?"
    context: "This question uses time-series analysis to detect changes in behavior over time. A model can learn the normal rate of connections to high ports (>1024) for each host. By enriching this model with data about preceding DNS queries (like domain age or entropy), it can flag statistically significant deviations from the forecast, especially when those deviations follow suspicious DNS lookups."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Egress Firewalls/Proxies"
      - "Internal DNS Resolvers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: DEPLOY a time-series anomaly detection model to monitor the rate of connections to ports > 1024 per host. ENRICH the model with features from preceding DNS queries. ALERT on temporal anomalies that deviate from the forecasted normal behavior."
  - question: "Are hosts querying for domains that are not on our enterprise allowlist but are present on known DGA threat intelligence feeds?"
    context: "This question addresses the use of Domain Generation Algorithms (DGAs) which are often a precursor to DNS calculation. This is a high-fidelity check that compares all DNS queries against a corporate allowlist of known-good domains. Any domain not on the list is then checked against threat intelligence feeds for known DGA patterns, with any match triggering a high-priority alert."
    answer_sources:
      - "Zeek dns.log"
      - "Microsoft-Windows-DNS-Client/Operational Event ID 3008"
      - "Internal DNS Resolvers"
      - "Domain Controllers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each FQDN in DNS logs, CHECK if it is on the enterprise allowlist. IF NOT, query threat intelligence feeds for known DGA families. ALERT on any match."
  - question: "Are hosts querying for domains that have an unusually high Shannon entropy score compared to normal traffic?"
    context: "This question uses a statistical property, Shannon entropy, to identify algorithmically generated domains. A baseline for entropy is established from the last 30 days of known-good, allowlisted domains. Any new domain not on the allowlist that has an entropy score exceeding the 98th percentile of this baseline is flagged, as its randomness is a strong indicator of DGA activity."
    answer_sources:
      - "Zeek dns.log"
      - "Microsoft-Windows-DNS-Client/Operational Event ID 3008"
      - "Internal DNS Resolvers"
      - "Domain Controllers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR all domains not on the enterprise allowlist, CALCULATE the Shannon entropy of the second-level domain. ESTABLISH a baseline entropy from known-good domains. ALERT on domains with entropy scores exceeding the 98th percentile of the baseline."
  - question: "Can a machine learning model classify queried domains as legitimate or DGA-generated based on their linguistic features?"
    context: "This question leverages a more sophisticated, supervised machine learning approach to DGA detection. A pre-trained classification model (e.g., Random Forest) can analyze various features of a domain—such as length, entropy, n-gram frequency, and vowel-to-consonant ratio—to make a probabilistic determination of whether it was generated by a machine or a human. Domains classified as DGA with high confidence are flagged for investigation."
    answer_sources:
      - "Zeek dns.log"
      - "Microsoft-Windows-DNS-Client/Operational Event ID 3008"
      - "Internal DNS Resolvers"
      - "Domain Controllers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: APPLY a pre-trained classification model to domains from DNS logs. The model should use features like domain length, entropy, and n-gram frequency. FLAG domains classified as DGA with a confidence score > 0.9."
  - question: "Is any host generating an abnormally high rate and ratio of DNS queries that result in a Non-Existent Domain (NXDOMAIN) response?"
    context: "This question helps detect DGA-based C2, where malware cycles through a list of potential domains until it finds one that resolves. This behavior results in a large number of failed DNS lookups. This query establishes a simple threshold-based rule to alert if a single host's NXDOMAIN count and its ratio of NXDOMAIN to total queries exceed a set limit (e.g., >50 queries and >80% ratio) within a short 5-minute window."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS Resolvers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: COUNT DNS queries by source IP and response code over a 5-minute window. ALERT if the NXDOMAIN count for a host exceeds 50 and the ratio of NXDOMAIN to total queries for that host exceeds 0.8."
  - question: "Is any host exhibiting a statistically significant increase in its NXDOMAIN query ratio compared to its own historical baseline?"
    context: "This question provides a more robust, baseline-driven approach to detecting abnormal NXDOMAIN activity. Instead of a fixed threshold, it calculates the z-score of a host's current NXDOMAIN ratio against its own 30-day rolling average. A z-score greater than 3 indicates a significant statistical deviation from normal behavior, providing a more reliable alert and reducing false positives from hosts that may normally have a higher NXDOMAIN rate."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS Resolvers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each host, calculate the z-score of its current 1-hour NXDOMAIN ratio against its 30-day rolling average. ALERT if the z-score exceeds 3 and the raw NXDOMAIN count is above a nominal threshold."
  - question: "Can we identify hosts whose DNS behavior profile has shifted to one characterized by a high rate of NXDOMAIN responses?"
    context: "This question uses unsupervised clustering to identify behavioral shifts. Hosts are grouped based on their daily DNS response code profiles (e.g., vector of counts for NOERROR, NXDOMAIN, etc.). An alert is triggered when a host moves from a large, stable cluster representing 'normal' behavior to a smaller, more volatile cluster defined by a high proportion of NXDOMAIN responses, indicating a potential compromise."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS Resolvers"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: USE time-series clustering to group hosts by their daily DNS response code profiles. IDENTIFY and ALERT on any host that transitions from a 'normal' cluster to a cluster characterized by a high NXDOMAIN ratio."
  - question: "Is a host making highly regular, periodic connections to a destination that was resolved from a suspicious DNS query?"
    context: "This question aims to identify C2 beaconing activity that often follows a successful DNS resolution. After a suspicious DNS event is flagged, this query looks for subsequent connections from the source host that have a machine-like regularity. It specifically checks for consistent time intervals (low jitter) between connections over an extended period (e.g., one hour), which is characteristic of automated C2 callbacks."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Egress Network Gateways"
      - "Core Network Switches"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR destination IPs associated with flagged suspicious DNS activity, IDENTIFY repeating connections from a single source. ALERT if the time between consecutive connections is consistent (e.g., every 300s +/- 5s) over at least one hour."
  - question: "Are there any source-destination communication pairs exhibiting extremely low deviation in both timing and packet size?"
    context: "This question uses statistical analysis to find machine-like C2 beaconing. It calculates the standard deviation of the time deltas between connections and the standard deviation of the packet sizes for every source-destination pair. Pairs that fall into the lowest percentile for both metrics are flagged. This combination of highly regular timing and consistent data volume is a strong signal of automated, non-human communication."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Egress Network Gateways"
      - "Core Network Switches"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each source-destination IP pair, calculate the standard deviation of the time deltas between connections and the standard deviation of packet sizes. FLAG pairs that fall into the lowest 1st percentile for both metrics."
  - question: "Can a sequence analysis model detect anomalous patterns of DNS queries followed by beaconing-like network connections?"
    context: "This question proposes using a deep learning model, such as an LSTM autoencoder, to understand normal sequences of network events for a host. The model is trained on vast amounts of normal traffic data. It can then be used to identify and alert on anomalous sequences, such as a DNS query followed by a series of small, regularly timed connections to the resolved IP, which the model would flag as a deviation from learned normal behavior."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Egress Network Gateways"
      - "Core Network Switches"
      - "Endpoint Devices"
    range: "Last 90 days"
    queries:
      - "Pseudocode: TRAIN an LSTM autoencoder on sequences of normal network events per host. USE the model to identify anomalous sequences, such as a DNS query followed by repeated, small, and regularly timed connections to the resolved IP. ALERT on these anomalies."