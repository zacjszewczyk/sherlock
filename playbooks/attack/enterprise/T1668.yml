name: "T1668: Exclusive Control"
id: "f4b8e1a0-8c9d-4e1f-a2b3-c4d5e6f7a8b9"
description: "This playbook helps investigate if an adversary is attempting to maintain exclusive control over a compromised system. This can be achieved by eliminating competing malware or hardening the system against other attackers. Indicators include the execution of malware removal tools, command-line arguments that disable security services or modify firewall rules, unauthorized modification of registry keys related to security products, processes with unusual parent-child relationships performing sensitive actions, rapid sequences of administrative account manipulation, and unauthorized patching or service disabling immediately following network exploitation activity."
type: "technique"
related:
  - "TA0003: Persistence"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a newly created process a known malware removal utility or a tool used to disable other security tools?"
    context: "Adversaries may deploy tools to remove competing malware or security software to ensure their own persistence and control. This question checks if the hash of a newly executed process matches a known tool used for achieving exclusive control, which would be a high-confidence indicator of malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek files.log"
      - "All endpoints and servers, particularly Domain Controllers and critical application servers."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (Event ID 4688). FOR each event, LOOKUP process_hash against threat_intel_feed_of_exclusive_control_tools. ALERT on match."
  - question: "Is a newly executed process extremely rare in the environment?"
    context: "Malware or specialized attacker tools are often not widely distributed across an organization's network. Identifying processes that have run on a very small percentage of endpoints can help uncover these unique, potentially malicious executables. This method helps find unknown tools not present in threat intelligence feeds."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek files.log"
      - "All endpoints and servers, particularly Domain Controllers and critical application servers."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (Event ID 4688) in the last 90 days. FOR each process_hash, CALCULATE unique host count over last 30 days. ALERT if (unique_host_count / total_hosts) < 0.001 AND process_hash is NOT in approved_software_list."
  - question: "Does a machine learning model classify a new process, masquerading as a utility or anti-malware tool, as malicious?"
    context: "Attackers often disguise their malicious executables with filenames or metadata that mimic legitimate system utilities or security tools. This question uses a machine learning model to analyze file characteristics (like hash, PE header, signature) to determine its true nature, bypassing simple name-based detection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek files.log"
      - "All endpoints and servers, particularly Domain Controllers and critical application servers."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (Event ID 4688). FOR each event, EXTRACT file metadata. INPUT metadata into ML_file_classifier. ALERT if classification is 'malicious' AND (filename CONTAINS 'util' OR 'clean' OR 'antimalware')."
  - question: "Are command-line arguments being used to disable security controls like firewalls or security services?"
    context: "Adversaries frequently use built-in command-line tools like `netsh.exe`, `sc.exe`, or PowerShell cmdlets to programmatically disable security measures. This question searches for specific command patterns known to turn off firewalls, disable security services, or alter security product configurations, which is a direct attempt to weaken system defenses."
    answer_sources:
      - "Windows Event ID 4688"
      - "All endpoints and servers, especially those hosting security management consoles or acting as domain controllers."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (Event ID 4688) where command_line MATCHES regex for ('netsh advfirewall set...off', 'sc.exe config...start= disabled', 'Set-MpPreference -DisableRealtimeMonitoring $true'). ALERT on match."
  - question: "Is a command-line string for a common system process unusually complex or obfuscated?"
    context: "To evade simple keyword-based detection, attackers often obfuscate their malicious commands, making them appear as random or complex strings. By calculating the Shannon entropy (a measure of randomness) of command lines for processes like `powershell.exe` or `cmd.exe` and comparing it to a normal baseline, we can identify potentially obfuscated malicious commands."
    answer_sources:
      - "Windows Event ID 4688"
      - "All endpoints and servers, especially those hosting security management consoles or acting as domain controllers."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (Event ID 4688) for common system processes (powershell.exe, cmd.exe). CALCULATE shannon_entropy of command_line. ALERT if entropy > 95th_percentile_baseline."
  - question: "Does a machine learning model classify a process's command-line arguments as malicious?"
    context: "This question leverages a machine learning model trained to differentiate between benign and malicious command-line activity. By analyzing features like command length, character distribution, and suspicious keywords, the model can identify malicious commands that might not match a specific, known pattern, providing a more robust detection method."
    answer_sources:
      - "Windows Event ID 4688"
      - "All endpoints and servers, especially those hosting security management consoles or acting as domain controllers."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (Event ID 4688). EXTRACT command_line and its features. INPUT features into ML_command_classifier. ALERT if classification is 'malicious'."
  - question: "Has an unauthorized process modified a critical registry key related to a security product?"
    context: "Many security products rely on specific registry keys for their configuration and operation. Adversaries may modify these keys to disable or cripple the security tool. This question monitors a watchlist of these critical keys and alerts when a modification is made by a process not on an approved list of system management tools."
    answer_sources:
      - "Windows Event ID 4657"
      - "Windows Event ID 4688"
      - "System registries on all endpoints and servers, with a focus on administrator workstations and critical servers."
    range: "last 90 days"
    queries:
      - "SEARCH registry modification events (Event ID 4657) for keys in critical_security_key_watchlist. IF process_name is NOT in approved_tool_allowlist, ALERT."
  - question: "Has a security-related registry key been modified by a process that has not been observed modifying it before?"
    context: "Over time, a baseline of normal activity can be established, showing which processes typically modify specific registry keys. This question identifies anomalous behavior by alerting when a process modifies a security-related registry key for the first time, suggesting a deviation from normal operations that could be malicious."
    answer_sources:
      - "Windows Event ID 4657"
      - "Windows Event ID 4688"
      - "System registries on all endpoints and servers, with a focus on administrator workstations and critical servers."
    range: "last 90 days"
    queries:
      - "BUILD baseline of (process_name, registry_key_path) pairs from past 30 days. SEARCH for new registry modification events (Event ID 4657). ALERT if the (process_name, registry_key_path) pair is not in the baseline."
  - question: "Is there an anomalous spike in modification events for security-related registry keys?"
    context: "A sudden, widespread effort to disable security controls can manifest as a sharp increase in registry modification events across the environment. This question uses a time-series model to detect such spikes that are inconsistent with normal activity like scheduled maintenance or software deployments, potentially indicating a coordinated attack."
    answer_sources:
      - "Windows Event ID 4657"
      - "Windows Event ID 4688"
      - "System registries on all endpoints and servers, with a focus on administrator workstations and critical servers."
    range: "last 90 days"
    queries:
      - "AGGREGATE hourly count of security-related registry modifications (Event ID 4657). APPLY time-series anomaly detection model. ALERT on statistically significant spikes."
  - question: "Did a non-interactive process spawn a shell that was followed by a security degradation event?"
    context: "Applications like Microsoft Word or web server services should not typically spawn command shells (`cmd.exe`, `powershell.exe`) to perform administrative actions. This question looks for a suspicious chain of events: a non-interactive parent spawning a shell, followed shortly by an event like a firewall rule change or a service being stopped, which strongly indicates post-exploitation activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4947"
      - "Windows Event ID 7036"
      - "Internet-facing web servers, remote access gateways, and general user endpoints."
    range: "last 90 days"
    queries:
      - "SEARCH for process creation (Event ID 4688) where parent_process is non-interactive (e.g., winword.exe, wmiprvse.exe) and child_process is a shell. CORRELATE with a security degradation event (Event ID 4947, 7036) on the same host within 5 minutes. ALERT on match."
  - question: "Has a rare or statistically unlikely parent-child process relationship occurred, especially involving a sensitive child process?"
    context: "Adversaries often create process chains that are not seen during normal system operation. By modeling all parent-child process relationships observed in the environment, we can calculate the probability of any given pairing. This question flags extremely rare pairings, such as a web server spawning `netsh.exe`, which are highly indicative of malicious behavior."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4947"
      - "Windows Event ID 7036"
      - "Internet-facing web servers, remote access gateways, and general user endpoints."
    range: "last 90 days"
    queries:
      - "CALCULATE probability of all (parent_process, child_process) pairs from historical data (Event ID 4688). SEARCH for new process creation events. ALERT if P(Child|Parent) < 0.01 AND child_process is a sensitive utility (netsh.exe, sc.exe)."
  - question: "Does a process execution graph show an anomalous structure, such as a web server process spawning a shell to modify a system service?"
    context: "System activity can be visualized as a graph of process executions. Normal operations create predictable graph structures. This question applies graph-based anomaly detection to find subgraphs that deviate from these normal patterns. This can uncover complex, multi-step attack chains that might be missed by analyzing individual events."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4947"
      - "Windows Event ID 7036"
      - "Internet-facing web servers, remote access gateways, and general user endpoints."
    range: "last 90 days"
    queries:
      - "CONSTRUCT process execution graph from Event ID 4688 data. APPLY graph-based anomaly detection algorithm. ALERT on subgraphs that deviate from learned normal structures."
  - question: "Was a newly created privileged account immediately used to disable or delete other accounts?"
    context: "A classic attacker technique is to create a new administrative account and then use it to lock out or remove legitimate administrators to maintain control. This question looks for a specific, rapid sequence of events: account creation, promotion to a privileged group, and then disabling or deleting another account, all within a short time window."
    answer_sources:
      - "Windows Event ID 4720"
      - "Windows Event ID 4726"
      - "Windows Event ID 4732"
      - "Windows Event ID 4725"
      - "Domain Controllers, Active Directory databases, and local account databases on critical servers."
    range: "last 90 days"
    queries:
      - "SEARCH for sequence: 1) Account created (Event ID 4720), 2) Account added to privileged group (Event ID 4732), 3) Account disables/deletes another account (Event ID 4725/4726). ALERT if sequence occurs within a 15-minute window."
  - question: "Was a user account promoted to a privileged group an unusually short time after its creation?"
    context: "Legitimate user accounts are rarely granted high privileges immediately after being created. Automated attack scripts, however, will often perform this action in seconds or minutes. This question identifies such behavior by calculating the 'time-to-privilege' and alerting when this duration is anomalously short, indicating likely malicious automation."
    answer_sources:
      - "Windows Event ID 4720"
      - "Windows Event ID 4726"
      - "Windows Event ID 4732"
      - "Windows Event ID 4725"
      - "Domain Controllers, Active Directory databases, and local account databases on critical servers."
    range: "last 90 days"
    queries:
      - "FOR each privileged group addition (Event ID 4732), FIND the account creation time (Event ID 4720). CALCULATE time_delta. ALERT if time_delta is in the bottom 1st percentile of the baseline."
  - question: "Was a high-risk new user account immediately used for privileged activity?"
    context: "Not all user creations are equal. Some, based on their naming convention, time of creation, or source, are inherently riskier. This question uses a model to score the risk of a new account creation and correlates high-risk creations with subsequent privileged actions, providing a high-confidence alert for suspicious activity."
    answer_sources:
      - "Windows Event ID 4720"
      - "Windows Event ID 4726"
      - "Windows Event ID 4732"
      - "Windows Event ID 4725"
      - "Domain Controllers, Active Directory databases, and local account databases on critical servers."
    range: "last 90 days"
    queries:
      - "FOR each new user creation (Event ID 4720), SCORE risk using ML model. IF risk_score is high AND the new account performs a privileged action (e.g., Event ID 4725) shortly after, ALERT."
  - question: "Did a service stop or patch-like process execution occur on a host shortly after it was targeted by a network exploitation attempt?"
    context: "After successfully exploiting a vulnerability, an adversary might 'patch' the system to prevent other attackers from using the same entry point. This question correlates external network indicators of exploitation (from Zeek logs) with internal host events like a service stopping or a patching process running, which could indicate an attacker securing their foothold."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek notice.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 7036"
      - "Internet-facing servers (e.g., web, VPN, RDP), network perimeter security devices, and patch management systems."
    range: "last 90 days"
    queries:
      - "SEARCH for network exploitation alerts (Zeek notice.log) or connections from malicious IPs (Zeek conn.log). CORRELATE with a service stop (Event ID 7036) or patch-like process (Event ID 4688) on the same destination host within 1 hour. ALERT on match."
  - question: "Did patching or service management activity occur at an unusual time or was it initiated by an unusual process?"
    context: "Legitimate patching and service management typically follow a predictable schedule and are performed by specific system processes. This question establishes a baseline of this normal activity and alerts on outliers, such as a service being modified at 3 AM on a weekend by `powershell.exe` instead of a standard installer, which could indicate an adversary's actions."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek notice.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 7036"
      - "Internet-facing servers (e.g., web, VPN, RDP), network perimeter security devices, and patch management systems."
    range: "last 90 days"
    queries:
      - "BUILD baseline of normal patching activity (process, time, day). SEARCH for service modifications (Event ID 7036) or patch installations (Event ID 4688). ALERT if the event is a statistical outlier from the baseline."
  - question: "Is there a novel, high correlation between external network threat indicators and internal host service changes?"
    context: "This question uses advanced time-series analysis to find hidden relationships between external network events (like threat alerts) and internal system changes (like service modifications). The model learns normal correlations and can flag new, strong correlations that emerge, potentially revealing an attacker's TTPs as they interact with a compromised system."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek notice.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 7036"
      - "Internet-facing servers (e.g., web, VPN, RDP), network perimeter security devices, and patch management systems."
    range: "last 90 days"
    queries:
      - "MODEL time-series cross-correlation between external network alerts (Zeek notice.log) and internal service changes (Event ID 7036). ALERT on novel, high-correlation events that deviate from the learned model."