name: T1590.002: DNS
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary is performing DNS reconnaissance against the network. This can manifest as DNS queries for organizational domains originating from known malicious IP addresses, unauthorized zone transfer attempts (AXFR/IXFR queries), a high volume of queries resulting in non-existent domain (NXDOMAIN) errors, the use of deprecated 'ANY' queries, systematic subdomain enumeration characterized by high query rates or entropy, or an unusual number of queries for sensitive record types like MX, TXT, or SRV from unexpected external sources.
type: technique
related:
- TA0043: Reconnaissance
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are external IP addresses identified as malicious or reconnaissance-focused by threat intelligence querying our organizational domains?
  context: This question seeks to identify straightforward reconnaissance activity by correlating incoming DNS queries with known threat intelligence. An alert from a symbolic rule matching a source IP to a malicious feed and a query to an internal domain is a strong indicator of targeted reconnaissance.
  answer_sources:
  - Zeek dns.log
  - Threat Intelligence Platform Data
  - External-facing DNS servers
  - Network perimeter firewalls
  - Cloud provider DNS logs
  - Threat Intelligence Platform
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      JOIN dns_logs ON (source_ip) WITH threat_intelligence_feed ON (ip_address)
      WHERE threat_intelligence.category IN ('reconnaissance', 'malicious')
      AND dns_logs.query ENDS WITH 'organizational_domain'
- question: Do any external IPs from threat intelligence feeds show a statistically significant focus on querying our organizational domains compared to other external IPs?
  context: This question uses a statistical approach to find adversaries who may be trying to blend in. Instead of a single query, it looks for IPs from threat feeds that dedicate an unusually high percentage of their total DNS query activity to our domains, which suggests more than just casual interest.
  answer_sources:
  - Zeek dns.log
  - Threat Intelligence Platform Data
  - External-facing DNS servers
  - Network perimeter firewalls
  - Cloud provider DNS logs
  - Threat Intelligence Platform
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      FOR each 1-hour window:
        CALCULATE baseline_percentile = 95th percentile of (queries_to_org_domain / total_queries) for all external IPs.
        FOR each source_ip in threat_intelligence_feed:
          CALCULATE ip_focus_percentage = (queries_to_org_domain / total_queries) for source_ip.
          IF ip_focus_percentage > baseline_percentile AND total_queries > 20:
            ALERT
- question: Can a machine learning model classify any incoming DNS queries from external sources as having a high probability of being reconnaissance activity?
  context: This question leverages a supervised machine learning model to detect complex reconnaissance patterns that symbolic or simple statistical rules might miss. The model analyzes multiple features of a DNS query simultaneously (e.g., query structure, source IP reputation, ASN) to score its likelihood of being malicious, providing a more nuanced detection capability.
  answer_sources:
  - Zeek dns.log
  - Threat Intelligence Platform Data
  - External-facing DNS servers
  - Network perimeter firewalls
  - Cloud provider DNS logs
  - Threat Intelligence Platform
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      FOR each new DNS query from an external source:
        EXTRACT features (query_length, entropy, query_type, ip_reputation, asn, geo).
        APPLY trained classification model to features.
        IF model_probability_score > 0.9:
          ALERT
- question: Have any unauthorized zone transfer attempts (AXFR/IXFR) been made against our DNS servers from IPs not on the approved allow-list?
  context: This question looks for a classic and high-fidelity indicator of DNS reconnaissance. A zone transfer provides an attacker with a complete map of a network's hosts. Any attempt from an unauthorized IP is a serious security event and should be investigated immediately.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 5504
  - Authoritative DNS servers
  - Secondary DNS servers
  - Domain Controllers with DNS role
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      // Zeek
      SELECT * FROM dns_logs
      WHERE query_type IN ('AXFR', 'IXFR')
      AND source_ip NOT IN (zone_transfer_allow_list)

      // Windows
      SELECT * FROM windows_event_logs
      WHERE event_id = 5504
      AND source_ip NOT IN (zone_transfer_allow_list)
- question: Is any single external IP generating a statistically anomalous number of DNS queries that are being refused by our servers?
  context: This question aims to detect potential reconnaissance, such as failed zone transfer attempts or other probing, by looking for statistical anomalies. A spike in 'REFUSED' responses from a single IP address can indicate an automated tool systematically probing for vulnerabilities or misconfigurations, even if the specific queries (like AXFR) aren't seen.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 5504
  - Authoritative DNS servers
  - Secondary DNS servers
  - Domain Controllers with DNS role
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      CALCULATE baseline_mean, baseline_std_dev of hourly 'REFUSED' responses from all external IPs.
      FOR each 1-hour window:
        FOR each external source_ip:
          CALCULATE hourly_refused_count for source_ip.
          IF hourly_refused_count > (baseline_mean + 3 * baseline_std_dev):
            ALERT
- question: Does an unsupervised machine learning model identify any external DNS sessions as anomalous, particularly those involving zone transfer query types?
  context: This question uses an unsupervised ML model to find unusual sessions without pre-existing labels. By analyzing features like the mix of query types, volume, and response codes, the model can flag sessions that deviate from normal behavior. An anomalous session that also contains AXFR/IXFR queries is a very strong signal of a targeted reconnaissance attempt.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 5504
  - Authoritative DNS servers
  - Secondary DNS servers
  - Domain Controllers with DNS role
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      FOR each external IP session:
        EXTRACT features (query_type_distribution, query_volume, refused_ratio).
        APPLY Isolation Forest model to feature set.
        IF model flags session as anomaly AND session contains 'AXFR' or 'IXFR' queries:
          ALERT
- question: Are any external IPs using the deprecated 'ANY' query type against our organizational domains?
  context: This question targets the use of 'ANY' queries, which request all available DNS records for a given name. While it has legitimate uses, it is often used in the initial stages of reconnaissance to gather as much information as possible with a single query. Because it is deprecated and inefficient, its use from an unknown external source is suspicious.
  answer_sources:
  - Zeek dns.log
  - External-facing DNS servers
  - Internal DNS resolvers
  - Cloud DNS service logs (e.g., AWS Route 53, Azure DNS)
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      SELECT * FROM dns_logs
      WHERE query_type = 'ANY'
      AND source_ip_is_external
      AND query ENDS WITH 'organizational_domain'
- question: Is any external IP generating a statistically high ratio of non-existent domain (NXDOMAIN) errors while making a significant number of queries?
  context: This question helps to identify subdomain brute-forcing or enumeration attempts. Attackers often use a dictionary of common names to guess subdomains. This results in a large number of queries for names that do not exist, leading to a high ratio of NXDOMAIN responses. This behavior is highly abnormal for legitimate users.
  answer_sources:
  - Zeek dns.log
  - External-facing DNS servers
  - Internal DNS resolvers
  - Cloud DNS service logs (e.g., AWS Route 53, Azure DNS)
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      FOR each 5-minute window:
        CALCULATE baseline_percentile = 98th percentile of (NXDOMAIN_count / total_queries) for all external IPs.
        FOR each external source_ip:
          CALCULATE ip_nxdomain_ratio = (NXDOMAIN_count / total_queries) for source_ip.
          IF total_queries > 50 AND ip_nxdomain_ratio > baseline_percentile:
            ALERT
- question: Can a clustering algorithm (like DBSCAN) identify any external IPs exhibiting anomalous DNS query patterns, such as high NXDOMAIN rates or unusual query type distributions?
  context: This question uses unsupervised machine learning to group source IPs by their query behavior. Normal traffic will form dense clusters, while attackers or scanners with unique patterns (like high NXDOMAIN rates or odd query mixes) will be isolated as 'noise' or form small, distinct clusters. This allows for the discovery of novel or unusual reconnaissance techniques.
  answer_sources:
  - Zeek dns.log
  - External-facing DNS servers
  - Internal DNS resolvers
  - Cloud DNS service logs (e.g., AWS Route 53, Azure DNS)
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      FOR each 15-minute window:
        AGGREGATE features (NXDOMAIN_rate, query_count, query_type_dist) per source_ip.
        APPLY DBSCAN clustering to the set of feature vectors.
        INVESTIGATE IPs classified as 'noise' or belonging to small clusters.
- question: Has any single external IP address generated an extremely high volume of DNS queries for our subdomains in a short time frame?
  context: This question uses a simple, high-threshold rule to detect brute-force subdomain enumeration. While legitimate services can sometimes be chatty, a very high number of queries (e.g., >500 in 5 minutes) from a single IP is a strong indication of an automated scanning tool attempting to discover our infrastructure.
  answer_sources:
  - Zeek dns.log
  - External-facing DNS servers
  - Network perimeter firewalls
  - Cloud DNS provider logs
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      GROUP DNS queries by source_ip and 5-minute window
      WHERE query ENDS WITH 'organizational_domain'
      HAVING COUNT(query) > 500
      ALERT
- question: Are any external IPs querying for subdomains with a statistically high level of randomness (entropy), suggesting automated enumeration?
  context: This question seeks to identify subdomain enumeration that uses algorithmically generated names rather than a simple wordlist. These generated names often appear random, leading to a high Shannon entropy score. Comparing the entropy of queried subdomains from an IP against a baseline of normal traffic can effectively detect this advanced enumeration technique.
  answer_sources:
  - Zeek dns.log
  - External-facing DNS servers
  - Network perimeter firewalls
  - Cloud DNS provider logs
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      CALCULATE baseline_entropy_percentile = 99th percentile of subdomain label entropy for all external IPs.
      FOR each 10-minute window:
        FOR each external source_ip:
          COLLECT unique subdomain labels queried for org domain.
          CALCULATE shannon_entropy of the collected labels.
          IF shannon_entropy > baseline_entropy_percentile:
            ALERT
- question: Does a time-series anomaly detection model detect any sudden, abnormal spikes in DNS query volume from a single external IP?
  context: This question uses a sophisticated time-series model to learn the 'normal' rhythm of DNS query traffic from various sources. The model can then spot sudden, sharp deviations from this learned pattern, such as the beginning of a brute-force attack. This is particularly useful for detecting attacks that start abruptly, as the model's reconstruction error will spike, triggering an alert.
  answer_sources:
  - Zeek dns.log
  - External-facing DNS servers
  - Network perimeter firewalls
  - Cloud DNS provider logs
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      FOR each source_ip:
        MAINTAIN a time-series of query volume per minute.
        APPLY trained LSTM autoencoder model to the time-series.
        CALCULATE reconstruction error.
        IF reconstruction_error is significantly higher than baseline:
          ALERT
- question: Are any external IPs, not identified as known partners, making an excessive number of queries for sensitive record types like SRV or TXT?
  context: This question looks for targeted information gathering. Attackers query for SRV records to find services like VoIP or LDAP, and TXT records for information like SPF data that could aid in email spoofing. A high number of such queries from an unknown IP, which is not a legitimate partner or service, is highly suspicious.
  answer_sources:
  - Zeek dns.log
  - Authoritative DNS servers
  - Mail gateway DNS records
  - Cloud service provider DNS records
  - VoIP infrastructure DNS records
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      GROUP queries by source_ip and 1-hour window
      WHERE source_ip NOT IN (partner_allow_list)
      HAVING (COUNT(DISTINCT query WHERE query_type = 'SRV') > 5)
      OR (COUNT(query WHERE query_type = 'TXT') > 10)
      ALERT
- question: Is any external IP making a statistically anomalous number of queries for sensitive record types (MX, TXT, SPF, SRV) compared to its peers?
  context: This question uses a statistical baseline to identify IPs that show an unusual interest in sensitive infrastructure records. By comparing an IP's query rate for these record types against the 95th percentile of all external traffic, it can flag potential reconnaissance activity that might not be voluminous enough to trigger a simple threshold rule but is abnormal in its focus.
  answer_sources:
  - Zeek dns.log
  - Authoritative DNS servers
  - Mail gateway DNS records
  - Cloud service provider DNS records
  - VoIP infrastructure DNS records
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      CALCULATE baseline_percentile = 95th percentile of 1-hour sensitive_query_count for all external IPs.
      FOR each external source_ip:
        CALCULATE moving 1-hour count of sensitive queries (MX, TXT, SPF, SRV).
        IF sensitive_query_count > baseline_percentile AND sensitive_query_count > 10:
          ALERT
- question: Using a Hidden Markov Model, can any DNS query sequences from an external IP be classified as belonging to a 'Reconnaissance' state?
  context: This question applies a stateful machine learning model (HMM) to analyze the sequence of DNS queries within a session. The model learns the typical progression of query types for different user behaviors (e.g., browsing, checking mail). It can then identify when a sequence of queries from an IP is most likely explained by a 'Reconnaissance' state, indicating a shift from normal activity to targeted information gathering.
  answer_sources:
  - Zeek dns.log
  - Authoritative DNS servers
  - Mail gateway DNS records
  - Cloud service provider DNS records
  - VoIP infrastructure DNS records
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |
      FOR each external IP session (sequence of DNS queries):
        APPLY trained HMM to the query sequence.
        DECODE the most likely sequence of hidden states.
        IF 'Reconnaissance' state is present in the decoded sequence:
          ALERT