name: T1578.005: Modify Cloud Compute Configurations
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: |
  This playbook helps investigate whether an adversary has modified cloud compute configurations to evade defenses or enable resource hijacking. It focuses on detecting suspicious use of cloud command-line interfaces (CLIs) from anomalous parent processes, command syntax matching known offensive tools (like Pacu or PowerZure), and API calls originating from users or IP addresses with no history of such administrative actions. The playbook also looks for configuration changes that enable unapproved cloud regions followed by resource deployment, or service quota increases immediately followed by a burst of resource provisioning and network traffic, which are strong indicators of resource hijacking for activities like cryptomining.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are cloud CLI tools being executed by suspicious parent processes or communicating with known malicious destinations?
    context: |
      This question aims to detect a common initial access or defense evasion technique where an adversary, having compromised a non-shell process like a Microsoft Office application, spawns a cloud CLI tool to manipulate the cloud environment. Correlating this with network traffic to known malicious IPs or domains provides strong evidence of command-and-control or data exfiltration activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - Administrator workstations
      - DevOps jump boxes
      - CI/CD pipeline servers
      - Network egress points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH process creation logs
          WHERE process_name IN ('az.exe', 'aws.exe', 'gcloud.exe')
            AND parent_process_name NOT IN ('explorer.exe', 'cmd.exe', 'powershell.exe')
          JOIN with malware hash database on process_hash
          JOIN process host IP and timestamp with network/DNS logs
          WHERE destination_ip OR destination_domain IN CTI_feed
  - question: Are there statistically anomalous cloud CLI executions, such as unusually complex commands or a sudden increase in activity?
    context: |
      This question helps identify attackers attempting to hide their commands through obfuscation (leading to high entropy) or those engaging in automated, high-frequency actions that deviate from normal user behavior. By baselining normal activity, we can spot outliers that may represent malicious use of legitimate tools.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - Administrator workstations
      - DevOps jump boxes
      - CI/CD pipeline servers
      - Network egress points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          // Query 1: Command Entropy
          FOR each cloud CLI execution:
            CALCULATE Shannon entropy of command-line arguments.
            ALERT if entropy > 95th_percentile_for_user_role.

          // Query 2: Execution Frequency
          CALCULATE 30-day moving average of CLI executions per host.
          ALERT if current daily count > (average + 3 * standard_deviation).
  - question: Can we use a machine learning model to predict whether a given cloud CLI execution is malicious based on its combined process and network characteristics?
    context: |
      This question leverages a machine learning model to holistically assess a cloud CLI event. By training on a wide range of features (process lineage, command attributes, user context, network reputation), the model can identify complex, non-obvious patterns of malicious activity that might be missed by simpler symbolic or statistical rules.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - Administrator workstations
      - DevOps jump boxes
      - CI/CD pipeline servers
      - Network egress points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SCORE new process and network events using trained Random Forest model.
          FEATURES: process_name, parent_process_name, cmd_line_length, cmd_line_entropy, user, dest_ip_reputation, connection_byte_count.
          ALERT if prediction is 'malicious' with high confidence.
  - question: Are there command-line arguments being used that match signatures of known offensive cloud security tools like Pacu or PowerZure?
    context: |
      This question looks for direct, high-fidelity indicators of compromise by searching for the unique fingerprints left by specific hacking tools. A match provides strong evidence that an attacker is actively using a known offensive toolset against the cloud environment.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Administrator workstations
      - Developer endpoints
      - Servers with cloud SDKs/CLIs installed
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH process creation logs
          WHERE command_line_arguments MATCHES regex_list_for_offensive_tools
            (e.g., 'pacu --import-keys', 'Invoke-PowerZure -Module \'All\'', 'cloudsplaining scan-bucket')
          ALERT on any match.
  - question: Are users executing extremely rare sequences of cloud modification commands within a short time frame?
    context: |
      This question aims to detect anomalous workflows. While a single command might be legitimate, a sequence of rare commands, especially those involving resource modification, could represent an attacker exploring and altering the environment in a way that no legitimate administrator does. It focuses on the abnormality of the sequence of actions, not just a single action.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Administrator workstations
      - Developer endpoints
      - Servers with cloud SDKs/CLIs installed
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each user session (e.g., commands within a 30-minute window):
            CALCULATE n-gram (n=2, 3) frequency of command sequences across organization.
            ALERT if a sequence involves modification verbs ('set', 'modify', 'update')
              AND the sequence frequency is in the bottom 1st percentile.
  - question: Can a sequence-based machine learning model detect deviations from the normal 'grammar' of administrative command workflows?
    context: |
      This question applies deep learning to understand the typical flow and structure of administrative sessions. An LSTM autoencoder learns what normal command sequences look like. When an attacker uses a tool or performs manual actions that don't follow this learned grammar, the model flags it as an anomaly, even if the individual commands themselves are not inherently suspicious.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Administrator workstations
      - Developer endpoints
      - Servers with cloud SDKs/CLIs installed
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FEED new user command sequences into a trained LSTM autoencoder.
          CALCULATE reconstruction error for each sequence.
          ALERT if reconstruction error is above a dynamically learned threshold, indicating an anomalous sequence.
  - question: Is a sensitive cloud configuration API call being made by a user or service principal that is not on the authorized allow-list?
    context: |
      This is a high-fidelity detection method based on a principle of least privilege. By defining a strict list of who is allowed to perform critical changes, any deviation from this list is a significant security event. It's a direct way to enforce and monitor access control policies.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - Zeek conn.log
      - Cloud provider logging services (e.g., AWS CloudTrail S3 bucket, Azure Log Analytics Workspace)
      - Identity and Access Management (IAM) systems
      - VPN/remote access logs
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH cloud audit logs
          FOR events like 'ModifyInstanceAttribute', 'Microsoft.Authorization/policyAssignments/write', 'compute.projects.setCommonInstanceMetadata'
          ALERT if executing_identity.user NOT IN authorized_allow_list.
  - question: Are there 'first-seen' statistical anomalies associated with sensitive API calls, such as a user performing an action for the first time or from a new location?
    context: |
      This question focuses on identifying unusual behavior from otherwise legitimate or privileged accounts. An attacker using a compromised account will likely perform actions that the legitimate user has never done before. Detecting these 'firsts'—first time using an API, first time from a new country, or an unusual burst of activity—can be an early indicator of account takeover.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - Zeek conn.log
      - Cloud provider logging services (e.g., AWS CloudTrail S3 bucket, Azure Log Analytics Workspace)
      - Identity and Access Management (IAM) systems
      - VPN/remote access logs
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each sensitive API call:
            CHECK historical logs for (user, api_call) pair. ALERT if first time seen.
            CHECK historical logs for (user, source_ASN) pair. ALERT if source ASN is new for user in 90 days.
            CHECK hourly call count for user. ALERT if count > 99th percentile for that user.
  - question: Can an unsupervised machine learning model identify anomalous cloud API calls that do not fit into any known cluster of benign behavior?
    context: |
      This question uses clustering to automatically define 'normal' for different user roles without needing pre-labeled data. The model groups similar API calls based on multiple features. Any activity that doesn't fit well into an existing cluster is flagged as an outlier, potentially representing a novel attack or a compromised account acting erratically.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - Zeek conn.log
      - Cloud provider logging services (e.g., AWS CloudTrail S3 bucket, Azure Log Analytics Workspace)
      - Identity and Access Management (IAM) systems
      - VPN/remote access logs
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SCORE cloud audit log events using a trained Isolation Forest or DBSCAN model.
          FEATURES: one-hot encoded API call name, user agent, source IP details (ASN, geo), time of day, API parameters.
          ALERT on any event flagged as an anomaly/outlier.
  - question: Are any cloud resources being enabled, modified, or deployed in a geographic region that is not on the company's approved list?
    context: |
      This is a straightforward governance and security check. Attackers often use unmonitored or non-standard regions to deploy resources for activities like cryptomining, hoping to evade detection. Alerting on any activity in an unauthorized region is a simple but effective way to detect this.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - Cloud provider logging services
      - Corporate cloud governance documentation
      - Corporate Asset Management Database
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH cloud audit logs for any API call
          WHERE event.region NOT IN approved_region_list
          AND event_name relates to resource creation/modification (e.g., 'RunInstances', 'CreateSubnet')
          ALERT on any match.
  - question: Are cloud resources being deployed in regions that have zero or very low historical usage by the organization?
    context: |
      This question provides a dynamic way to detect the use of unusual regions without relying solely on a static, manually-maintained list. By profiling historical usage, it can automatically flag deployments in regions that are either brand new to the organization or have been dormant for a long time, both of which are suspicious.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - Cloud provider logging services
      - Corporate cloud governance documentation
      - Corporate Asset Management Database
    range: Last 365 days
    queries:
      - technology: Pseudocode
        query: |
          PROFILE historical region usage from last 365 days of audit logs.
          ALERT on any new resource deployment in a region with zero historical usage.
          ALERT on any new resource deployment in a region with no usage in the past 180 days.
  - question: Can a machine learning model, trained on the characteristics of normal resource deployments, identify a deployment in an anomalous region as an outlier?
    context: |
      This question uses a one-class classification model to learn the multi-dimensional boundary of what constitutes a 'normal' deployment, considering factors like region, instance type, and user. A deployment in a new or unusual region will be far from this learned boundary and thus flagged as an anomaly, providing a more robust detection than a simple list-based check.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - Cloud provider logging services
      - Corporate cloud governance documentation
      - Corporate Asset Management Database
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SCORE new resource deployment events using a trained One-Class SVM or Isolation Forest model.
          FEATURES: cloud_region (categorical), instance_type, user_identity, time_of_day.
          ALERT if an event is flagged as an outlier, especially if the region was not in the training data.
  - question: Is a service quota increase followed within a short period by a high volume of resource creation and significant network egress, indicative of resource hijacking?
    context: |
      This question looks for a specific, logical chain of events that strongly indicates cryptojacking or other resource abuse. An attacker needs to increase service limits before they can deploy a large number of machines. By correlating the quota increase with mass provisioning and subsequent data transfer, we can connect the preparation, execution, and objective of the attack.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - VPC Flow Logs
      - Zeek conn.log
      - Cloud provider logging services
      - Network flow log sources
      - Network egress points
      - Cloud billing/cost management dashboards
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CREATE correlated rule that triggers on the following sequence:
          1. A cloud audit log event for a service quota increase (e.g., 'RequestServiceQuotaIncrease').
          2. Within 1 hour, >20 resource creation calls (e.g., 'RunInstances') from the same identity.
          3. Within the next hour, network flow logs show an aggregated egress of >1GB from the newly created resources to a single destination IP.
          ALERT if all three conditions are met.
  - question: Following a service quota increase, does the rate of resource creation API calls statistically deviate from the established baseline for that account?
    context: |
      This question uses statistical baselining to detect an abnormal surge in resource provisioning that follows a quota increase. Instead of a fixed threshold (like '>20 instances'), this method adapts to the normal behavior of each account. A large deviation from the norm, especially outside business hours, is a strong signal of abuse.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - VPC Flow Logs
      - Zeek conn.log
      - Cloud provider logging services
      - Network flow log sources
      - Network egress points
      - Cloud billing/cost management dashboards
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MONITOR for cloud audit log events related to quota increases.
          FOLLOWING such an event, if the rate of resource creation calls in the subsequent 24 hours > (30-day baseline + 3 * standard_deviation):
            GENERATE alert.
            ENRICH with time-of-day context, flagging activity outside standard business hours with higher severity.
  - question: Can a time-series model detect a structural changepoint in resource provisioning and network traffic patterns that occurs immediately after a configuration change like a quota increase?
    context: |
      This question applies advanced time-series analysis to model the expected behavior of an account. A 'changepoint' is a point in time where the statistical properties of the time series change. Detecting such a changepoint right after a quota increase suggests the system has shifted to a new, potentially malicious, state of high-volume resource deployment, which is a hallmark of resource hijacking.
    answer_sources:
      - AWS CloudTrail
      - Azure Activity Logs
      - GCP Audit Logs
      - VPC Flow Logs
      - Zeek conn.log
      - Cloud provider logging services
      - Network flow log sources
      - Network egress points
      - Cloud billing/cost management dashboards
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FORECAST the expected volume of resource provisioning API calls using a time-series model (e.g., Prophet).
          FEED real-time data from cloud audit logs into the model.
          ALERT when the model detects a significant changepoint (a structural break from the forecast)
            that occurs immediately after a configuration change event like a quota increase.