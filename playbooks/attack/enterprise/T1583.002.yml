name: T1583.002: DNS Server
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary is developing DNS infrastructure for their operations. It focuses on detecting suspicious DNS activity, such as queries to domains or IPs on threat intelligence feeds, queries to typosquatted or homoglyph domains, early resolutions of newly registered domains with low TTL values, and multiple newly registered domains resolving to the same IP address.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any internal hosts made DNS queries for domains or received answers for IPs that are present on high-confidence threat intelligence feeds?
    context: This question aims to identify direct communication with known malicious infrastructure. Matching DNS queries or resolved IPs against a curated list of high-confidence malicious indicators is a direct way to detect potential command and control (C2) communication, malware delivery, or other malicious activities. A match is a strong signal of compromise and warrants immediate investigation.
    answer_sources:
      - Zeek dns.log
      - Windows Event ID 260
      - Network Egress Points
      - Enterprise DNS Resolvers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH dns_logs WHERE query IN threat_intel_domains OR resolved_ip IN threat_intel_ips
  - question: Are DNS queries matching threat intelligence feeds being made by a small, targeted set of internal hosts rather than being widespread?
    context: This question helps differentiate between a widespread, low-level threat (like adware) and a targeted attack. If only a few hosts are contacting a known malicious domain, it suggests a more focused, potentially more severe compromise. This statistical approach helps prioritize alerts by identifying activity that deviates from the norm of broad, non-targeted threats.
    answer_sources:
      - Zeek dns.log
      - Windows Event ID 260
      - Network Egress Points
      - Enterprise DNS Resolvers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH dns_logs WHERE query IN threat_intel_domains | GROUP BY query | COUNT unique source_ip | FILTER count < 5th_percentile_client_count
  - question: Can we use machine learning to automatically classify the risk level of DNS queries that match threat intelligence feeds?
    context: This question addresses the challenge of alert fatigue from threat intelligence feeds, especially those with lower confidence scores. By training a model on features like the feed's reputation, the threat's confidence score, and internal query patterns (frequency, client count), we can automatically prioritize alerts, flagging some as high-confidence true positives and others as requiring further vetting. This improves analyst efficiency.
    answer_sources:
      - Zeek dns.log
      - Windows Event ID 260
      - Network Egress Points
      - Enterprise DNS Resolvers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: INPUT threat_intel_matches | PREDICT risk_level WITH classification_model(threat_feed_reputation, confidence_score, query_frequency, client_count) | FILTER risk_level == 'High-Confidence True Positive'
  - question: Are internal hosts querying domains that are typosquatted or homoglyph variations of our corporate, partner, or high-value brand domains?
    context: Adversaries often register domains that visually or typographically resemble legitimate ones to trick users in phishing campaigns or to masquerade C2 traffic. This question seeks to detect such activity by comparing all outbound DNS queries against a pre-generated list of look-alike domains. A match is a strong indicator of a potential phishing attempt or an existing compromise.
    answer_sources:
      - Zeek dns.log
      - Network Egress Points
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH dns_logs WHERE query IN pregenerated_typosquat_list
  - question: Are there any queried domains that are both highly similar to our critical domains and have a high degree of randomness (entropy)?
    context: This question uses a statistical approach to find typosquatted domains without relying solely on a pre-generated list. It combines two properties: string similarity (low Levenshtein distance) to a known good domain, and high character randomness (Shannon entropy). This combination is effective because adversaries might add random-looking subdomains or characters to a typosquatted domain (e.g., 'wvxyz-company.com'), increasing its entropy while maintaining similarity. This dual-factor analysis helps to surface sophisticated typosquatting attempts.
    answer_sources:
      - Zeek dns.log
      - Network Egress Points
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH dns_logs | CALCULATE levenshtein_distance(query, monitored_domains) and shannon_entropy(query) | FILTER levenshtein_distance <= 2 AND shannon_entropy > 90th_percentile_entropy
  - question: Can we use machine learning to detect clusters of syntactically similar domains that may be associated with a domain generation algorithm (DGA)?
    context: This question aims to identify malware using DGAs for C2 communication. DGAs create large numbers of pseudo-random domains, which often share syntactic structures. By vectorizing domain names and using clustering algorithms, we can group these algorithmically-generated domains together. Anomaly detection can then identify these clusters as abnormal compared to legitimate domain traffic, even without prior knowledge of the specific DGA family.
    answer_sources:
      - Zeek dns.log
      - Network Egress Points
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: INPUT all_queried_domains | VECTORIZE domains with n-grams | CLUSTER vectors with DBSCAN | IDENTIFY anomalous_clusters with IsolationForest
  - question: Are a small number of internal hosts among the first in the organization to query newly registered domains with a low Time-To-Live (TTL)?
    context: Adversaries frequently use newly registered domains (NRDs) for their campaigns, as they have no prior reputation. A low TTL value is often used to quickly change the underlying C2 IP address, evading blocklists. When only a few hosts in an organization are the first to contact such a domain, it strongly suggests a targeted attack rather than incidental browsing. This combination of factors (new domain, low TTL, few clients) is a high-fidelity indicator of malicious activity.
    answer_sources:
      - Zeek dns.log
      - Network Egress Points
      - Enterprise DNS Resolvers
      - Endpoint Devices of High-Value Targets
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH dns_logs | ENRICH with whois_creation_date | FILTER creation_date < 30_days_ago AND ttl < 300 | GROUP BY domain | COUNT unique source_ip | FILTER count < 5
  - question: Are we observing DNS queries for newly seen domains that have an anomalously high-risk score based on their age and TTL value?
    context: This question provides a statistical method for risk-scoring domains based on two key indicators of maliciousness: youth (low age) and agility (low TTL). By creating a combined risk score, we can quantify the suspicion level of a domain. Alerting on domains whose scores are statistical outliers (e.g., >3 standard deviations from the mean) allows for the dynamic detection of suspicious infrastructure without relying on fixed thresholds, adapting to changes in attacker TTPs.
    answer_sources:
      - Zeek dns.log
      - Network Egress Points
      - Enterprise DNS Resolvers
      - Endpoint Devices of High-Value Targets
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH first_seen_domains | CALCULATE risk_score = (1/age) + (1/ttl) | FILTER risk_score > (mean_risk_score + 3 * stddev_risk_score)
  - question: Is there a sudden, anomalous spike in the number of newly registered domains being queried by the organization?
    context: This question aims to detect the start of a widespread campaign. A sudden surge in queries to various unrelated NRDs across the organization can indicate that a large-scale phishing or malware campaign has just been launched. By using time-series forecasting, we can model the normal 'background noise' of NRD queries and automatically alert when a statistically significant anomaly occurs, pointing to a coordinated event.
    answer_sources:
      - Zeek dns.log
      - Network Egress Points
      - Enterprise DNS Resolvers
      - Endpoint Devices of High-Value Targets
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: MODEL nrd_queries_per_hour as time_series with Prophet | FORECAST expected_nrd_count | ALERT if actual_nrd_count > forecast_upper_bound
  - question: Are we observing multiple (more than three) newly registered domains resolving to the same IP address?
    context: Adversaries often host multiple malicious domains on the same server to support different phases of a campaign or multiple campaigns. Identifying a single IP address that is the resolution for several different NRDs is a strong indicator that the IP is part of a malicious infrastructure. This technique, often called 'domain co-occurrence' or 'shared IP', is a reliable way to uncover adversary-controlled assets.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Network Egress Points
      - Passive DNS databases
      - Cloud Provider Network Infrastructure
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH dns_logs | ENRICH with whois_creation_date | FILTER creation_date < 60_days_ago | GROUP BY resolved_ip | COUNT unique domain | FILTER count > 3
  - question: Are we seeing IPs where the vast majority of domains they host are NRDs, and are the same groups of internal clients communicating with them?
    context: This question adds two statistical layers to the co-occurrence detection. First, it identifies IPs that are *disproportionately* associated with NRDs, filtering out large shared hosting providers. Second, by checking if the *same* set of internal hosts are querying these different domains, it establishes a strong link, suggesting a coordinated C2 mechanism where a group of compromised machines cycles through different C2 domains that all point to the same infrastructure.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Network Egress Points
      - Passive DNS databases
      - Cloud Provider Network Infrastructure
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH dns_logs | CALCULATE nrd_ratio per resolved_ip | FILTER nrd_ratio > 99th_percentile | FOR each IP, CALCULATE jaccard_similarity(client_set_domain1, client_set_domain2) | FILTER similarity > 0.7
  - question: Can graph analysis and community detection identify tightly-knit clusters of internal hosts communicating with a small set of external IPs associated with NRDs?
    context: This question applies graph theory to discover C2 infrastructure. By modeling the relationships between internal hosts and the IPs they communicate with, we can find 'communities' or clusters. A cluster that consists of a distinct group of internal hosts all communicating with a small, shared set of external IPs (especially IPs known to host NRDs) is a powerful visualization and confirmation of a C2 network. This method can uncover the scope of a breach and the structure of the adversary's infrastructure.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Network Egress Points
      - Passive DNS databases
      - Cloud Provider Network Infrastructure
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: CREATE graph from (internal_host, resolved_ip) connections | RUN community_detection_algorithm | IDENTIFY communities with few IPs, distinct hosts, and NRD-associated IPs