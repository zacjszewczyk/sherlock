name: T1098.002: Additional Email Delegate Permissions
id: f5d8e7c6-b5a4-4987-8654-3c2b1a09f8e7
description: |
  This playbook provides investigative steps to determine if an adversary is leveraging additional email delegate permissions for persistence or privilege escalation (T1098.002). It focuses on identifying suspicious permission changes, such as those involving watchlisted accounts, newly created accounts, or grants of 'FullAccess' rights. The playbook also guides analysis of post-delegation behavior, including mailbox logins from unusual locations or devices, anomalous outbound email patterns, and subsequent lateral movement activities. It helps detect unauthorized permission modifications by non-administrative users or legitimate administrators acting outside of their normal behavioral baselines.
type: technique
related:
  - TA0003: Persistence
  - TA0004: Privilege Escalation
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a mailbox permission modification been performed where the actor or target account is on a watchlist of compromised or high-risk accounts?
    context: |
      This question seeks to identify high-fidelity indicators of malicious activity. An adversary who has compromised an account may use it to grant themselves access to other mailboxes. Likewise, they may target high-value accounts. Correlating permission changes with a predefined list of compromised or high-risk accounts allows for immediate detection of this technique with a low false-positive rate.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH logs WHERE event_type='MailboxPermissionChange' AND (actor.user IN (watchlist) OR target.user IN (watchlist))
  - question: Is any user account executing mailbox permission changes at a rate that is anomalously high compared to their own or their peer group's historical baseline?
    context: |
      Adversaries often automate tasks, leading to a higher frequency of actions than a normal user would perform. This question aims to detect such automated or scripted behavior by establishing a baseline of normal permission change activity for each user and their peers. A significant deviation from this baseline, such as an account suddenly modifying many mailboxes, can indicate that the account is compromised and being used for malicious persistence.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE frequency of 'MailboxPermissionChange' events per user over 90 days. ALERT if current activity > 95th percentile of user's baseline OR peer group's baseline.
  - question: Can a machine learning model identify mailbox permission changes that have a high probability of being malicious based on contextual features?
    context: |
      This question proposes a more sophisticated detection method that moves beyond simple rules. By training a classification model on features like the actor's role, target's role, time of day, and IP reputation, the system can learn the subtle patterns that differentiate legitimate administrative tasks from malicious actions. This allows for the assignment of a risk score to each event, enabling analysts to prioritize the most suspicious permission changes.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          SCORE 'MailboxPermissionChange' events using ML model with features (actor.role, target.role, time_of_day, source.ip.reputation, on_watchlist_flag). ALERT if score > high_risk_threshold.
  - question: Has a mailbox permission change granted 'FullAccess' rights, or assigned permissions to a very new account or a service account?
    context: |
      This question targets specific, high-risk permission changes. Granting 'FullAccess' is powerful and provides complete control over a mailbox. Adversaries may also create new accounts or use service accounts to set up persistence, as these are less likely to be noticed. Alerting on these specific conditions helps to quickly identify potentially malicious grants that provide an attacker with significant access or a stealthy foothold.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH logs WHERE event_type='MailboxPermissionChange' AND (permission_right='FullAccess' OR target.user.creation_date < 30_days_ago OR target.user.type='ServiceAccount')
  - question: Is an administrator granting mailbox permissions in a way that is unusually repetitive or lacks variety compared to their normal behavior?
    context: |
      This question uses information theory to detect scripted activity. A human administrator typically grants a variety of permissions as needed. An automated script, however, might repeatedly grant the exact same permission (e.g., 'FullAccess') over and over. By measuring the Shannon entropy of an admin's permission-granting activity, a sharp drop in complexity can signal a shift from human behavior to automated, potentially malicious, behavior.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE Shannon entropy of permission types granted per admin over 30 days. ALERT if entropy drops > 2 standard deviations below admin's baseline.
  - question: Is there a cluster of mailbox permission changes that deviates from the organization's normal daily or weekly patterns?
    context: |
      This question aims to detect large-scale malicious activity by analyzing the overall stream of permission changes. A time-series model can learn the normal rhythm of an organization's administrative activities (e.g., more changes during business hours). A sudden burst of activity, like multiple 'FullAccess' grants at an unusual time, would deviate significantly from the forecasted pattern, indicating a potential coordinated attack rather than routine work.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL stream of permission change events with time-series model (e.g., ARIMA). ALERT if a cluster of events causes a significant deviation from the forecast.
  - question: Following a new mailbox delegation, did the new delegate log in from an IP address or use a User-Agent string never before seen for the original mailbox owner?
    context: |
      This question links a permission change to subsequent access, looking for a classic sign of account takeover. Legitimate users tend to have a consistent set of devices and network locations. If, shortly after a new delegate is added, that delegate accesses the mailbox from a completely new location or with a new device/browser, it's highly suspicious. It suggests the 'delegate' is actually an attacker using their own infrastructure.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4624
      - Zeek conn.log
      - Microsoft 365 Unified Audit Log
      - Azure AD Sign-in Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - VPN Concentrators
      - Network Firewalls/Gateways
      - Endpoint devices
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          CORRELATE 'MailboxPermissionChange' with 'MailboxLogin' within 60 mins. ALERT if login.source_ip OR login.user_agent is NOT IN original_owner.historical_baseline (last 90 days).
  - question: After a new delegation, was the delegate's first access to the mailbox from a location or device that is statistically rare for the original user?
    context: |
      This question refines the previous one by applying a statistical rarity score instead of a simple binary check. It builds a profile of the original user's normal access patterns. When a new delegate accesses the account, their access is scored based on how unusual its location and device are compared to the original owner's profile. Access from a rare location and with a rare device would receive a high score, flagging it for review as a potential compromise.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4624
      - Zeek conn.log
      - Microsoft 365 Unified Audit Log
      - Azure AD Sign-in Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - VPN Concentrators
      - Network Firewalls/Gateways
      - Endpoint devices
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          PROFILE user access patterns (location, ASN, user-agent). After delegation, SCORE delegate's first access based on rarity against owner's profile. ALERT if score > 95th percentile.
  - question: Did a new delegate's access to a mailbox fall outside the established 'normal' access behavior clusters for that mailbox?
    context: |
      This question uses unsupervised machine learning to define 'normal' for a mailbox's access patterns. By clustering historical access events based on features like IP, time, and user agent, the model can create a detailed picture of legitimate use. Any new access event, such as one from a new delegate, that doesn't fit into any of these 'normal' clusters is, by definition, an anomaly and should be investigated as a potential threat.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4624
      - Zeek conn.log
      - Microsoft 365 Unified Audit Log
      - Azure AD Sign-in Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - VPN Concentrators
      - Network Firewalls/Gateways
      - Endpoint devices
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          CLUSTER historical mailbox access events (K-Means) into 'normal' groups. ALERT if a new delegate's access event does not fall into any existing cluster.
  - question: After a mailbox was delegated, was there a high-volume internal email blast to recipients unfamiliar to the original mailbox owner?
    context: |
      This question looks for signs of an adversary using a compromised mailbox for internal phishing or data gathering. A common tactic is to use the trusted account to email a large number of internal colleagues. This rule specifically looks for a high volume of emails sent within a short period to recipients who have no prior email history with the legitimate mailbox owner, which is a strong indicator of malicious use.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Email Gateway
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Network Egress Points
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          MONITOR outbound email after delegation. ALERT if count(emails) > 100 in 1 hour AND recipients NOT IN original_owner.recipient_history (last 90 days).
  - question: Following a delegation event, did the outbound email volume or recipient domain profile of the mailbox become anomalous compared to its baseline?
    context: |
      This question aims to detect misuse of a delegated mailbox by looking for statistical changes in its sending behavior. It establishes a baseline for normal email volume and the set of domains the user typically corresponds with. An attacker using the mailbox for exfiltration or spam might cause a spike in volume or start sending emails to a completely new set of domains. A significant deviation in either metric would flag the activity as suspicious.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Email Gateway
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Network Egress Points
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE outbound email volume and recipient domains. After delegation, ALERT if volume > 3 STDEV above mean OR Jaccard_similarity(new_domains, baseline_domains) < 0.2.
  - question: After a delegation event, did the actual email activity from the mailbox significantly deviate from its forecasted, time-series-based prediction?
    context: |
      This question uses a predictive model to identify changes in mailbox behavior. A forecasting model can learn the complex patterns of a user's email activity, including time-of-day and day-of-week seasonality. After a delegate is added, if the actual email traffic deviates significantly and persistently from what the model predicted, it implies a fundamental change in how the mailbox is being used, which could be due to malicious activity.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Email Gateway
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Network Egress Points
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          FORECAST email volume/flow with time-series model (e.g., Prophet). After delegation, ALERT if actual activity shows significant sustained residual error compared to forecast.
  - question: Has a suspicious or watchlisted account granted permissions to a mailbox belonging to a member of a high-value group like 'Domain Admins' or 'C-Suite'?
    context: |
      This question focuses on a clear privilege escalation scenario. Gaining access to the mailbox of a highly privileged user is a primary goal for an attacker. This rule creates a high-severity alert when two high-risk conditions co-occur: the actor is a known suspicious account, and the target is a high-value individual. This combination is a powerful indicator of a targeted privilege escalation attempt.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH logs WHERE event_type='MailboxPermissionChange' AND target.user.group IN ('HighValueTargets') AND actor.user IN ('SuspiciousAccounts')
  - question: Can a risk score be calculated for permission changes to identify events where a suspicious actor grants powerful permissions to a privileged account?
    context: |
      This question proposes a quantitative risk scoring model to prioritize alerts. Instead of a binary alert, each event is scored based on a weighted combination of risk factors: whether the target is privileged, whether the actor is on a watchlist, and the rarity/power of the permission granted. This allows analysts to focus on the highest-scoring events, which represent the most probable privilege escalation attempts, rather than treating all alerts equally.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE RiskScore for each permission change based on weighted factors (target_is_privileged, actor_on_watchlist, permission_rarity). ALERT if RiskScore > 99th percentile.
  - question: Is there evidence of a low-privileged or suspicious user creating a permission link to a high-value, privileged user in the organization's identity graph?
    context: |
      This question conceptualizes the organization's identities and permissions as a graph. In this model, privileged users are central nodes. A privilege escalation attempt can be seen as an attacker creating an anomalous edge in this graph, linking their low-privilege node to a high-centrality node. Graph-based anomaly detection can automatically flag such improbable connections, which are difficult to spot with traditional log analysis.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL identities and permissions as a graph. Use graph anomaly detection to find improbable new 'has-permission-on' edges from low-privilege/suspicious nodes to high-centrality/privileged nodes.
  - question: Has an actor granted themselves permissions on another user's mailbox, especially a privileged user's mailbox?
    context: |
      This question targets a specific and highly suspicious action: a user modifying permissions to grant access *to themselves* on someone else's mailbox. While there can be legitimate scenarios, it's often an indicator of an attacker using a compromised account to pivot and gain access to another user's data. The suspicion level increases dramatically if the target mailbox belongs to a privileged user.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH logs WHERE event_type='MailboxPermissionChange' AND actor.identity == delegate.identity AND actor.identity != target.owner.identity. ALERT if target.owner.is_privileged.
  - question: Has a user who normally never grants permissions to themselves on other mailboxes suddenly started doing so?
    context: |
      This question applies behavioral analysis to the act of self-granting permissions. It establishes a baseline for each user's tendency to perform this action. For most users, this baseline will be zero. A sudden deviation, where a user grants themselves access to another mailbox for the first time, is a significant behavioral anomaly that warrants investigation, as it may signal that their account has been compromised for this purpose.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE ratio of self-grants vs other-grants per user. ALERT if ratio deviates > 3 standard deviations from user's or peer group's baseline.
  - question: Can a machine learning model distinguish between legitimate and illegitimate instances of a user granting themself mailbox permissions?
    context: |
      This question proposes using a supervised learning model to add context to the act of self-granting permissions. While the act itself is suspicious, some legitimate cases may exist. A classifier trained on features like source IP, time of day, and the roles of the actor and target can learn to differentiate between legitimate administrative actions and illegitimate ones, reducing false positives and focusing analyst attention.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          CLASSIFY self-grant events using an ML model with features (source.ip, time_of_day, actor.role, target.role). ALERT if event is classified as 'illegitimate' with high confidence.
  - question: Has a mailbox permission change been executed by a non-administrative user, or by an authorized admin from an unapproved IP address or country?
    context: |
      This question enforces access control policies on administrative actions. First, it checks if the user performing the action belongs to an authorized group. Any permission change by a non-admin is an immediate red flag. Second, for legitimate admins, it checks if the action originates from an approved location (e.g., a corporate subnet or VPN). An admin action from an unexpected IP or country could indicate their account has been compromised.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - Zeek conn.log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - SIEM/Log Management Platform
      - VPN Concentrators
      - Management Workstation Subnets
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          ALERT if 'MailboxPermissionChange' is executed by user NOT IN (AuthorizedAdmins). FOR AuthorizedAdmins, ALERT if source.ip NOT IN (ApprovedSubnets) OR source.country NOT IN (ApprovedCountries).
  - question: Did an authorized administrator perform a mailbox permission change at a time of day or from a source IP that is rare for their personal activity baseline?
    context: |
      This question applies user-level behavioral baselining to legitimate administrators. Every admin has a typical pattern of work hours and locations. An action performed far outside this pattern (e.g., at 3 AM for a 9-to-5 admin, or from a new ISP) is an anomaly. This can help detect when a legitimate admin's account has been compromised and is being used by an attacker in a different time zone or location.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - Zeek conn.log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - SIEM/Log Management Platform
      - VPN Concentrators
      - Management Workstation Subnets
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE activity hours and source IPs for each admin. ALERT if 'MailboxPermissionChange' occurs during a time window in the lowest 10th percentile of activity OR from a statistically rare source IP.
  - question: Can an anomaly detection algorithm, like Isolation Forest, identify malicious administrative actions by isolating them from the bulk of legitimate actions?
    context: |
      This question leverages an unsupervised learning technique suited for 'find the different' problems. An Isolation Forest model is trained on a large dataset of legitimate administrative actions. Since malicious actions are rare and different, they will have different feature values (e.g., different source IP, time, target) and will be 'isolated' more easily by the algorithm. This provides a way to flag novel or unusual attack patterns without pre-defined rules.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - Zeek conn.log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - SIEM/Log Management Platform
      - VPN Concentrators
      - Management Workstation Subnets
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN Isolation Forest on legitimate permission change events. SCORE new events. ALERT if event is flagged as an anomaly (isolated with few partitions).
  - question: Was a new delegation on a high-value mailbox followed by access from the delegate, and then by authentication failures or connections to other critical systems from the same source IP?
    context: |
      This question looks for a multi-stage attack chain: persistence, access, and lateral movement. It correlates a sequence of events: (1) a risky permission change, (2) access using that new permission, and (3) subsequent attempts to move laterally from the same source. Detecting this entire chain provides very strong evidence of a hands-on-keyboard attacker who has gained a foothold and is now trying to expand their access.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Critical Application Servers
      - Network Core
      - Network Egress Points
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          DETECT stateful sequence: (1) 'PermissionChange' on high-value mailbox. (2) 'MailboxAccess' by new delegate within 24h. (3) Spike in 'AuthFailures' or 'RDP/RPC' to Tier 0 server from same source IP within 1h. ALERT on completed sequence.
  - question: After a delegate accessed a high-value mailbox, did the network traffic volume from their source IP significantly exceed their historical baseline?
    context: |
      This question aims to detect data staging or exfiltration following a mailbox compromise. After gaining access, an attacker may attempt to download large amounts of data. By monitoring the network traffic volume from the delegate's source IP and comparing it to their own historical baseline, a sudden, massive increase in outbound data transfer can be identified, indicating that the access was likely for data theft.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Critical Application Servers
      - Network Core
      - Network Egress Points
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          After delegate access to high-value mailbox, MONITOR network traffic (bytes_out) from source IP. ALERT if volume in any 1-hour window > 99th percentile of that IP's hourly baseline.
  - question: Did a sequence of user actions, starting with granting delegate permission, deviate from normal behavior patterns as defined by a sequence analysis model?
    context: |
      This question applies advanced modeling to detect malicious sequences of actions. A Hidden Markov Model can be trained to understand the probability of transitioning from one state to another in a normal user session (e.g., login -> read email -> logout). An attacker's sequence (e.g., grant permission -> login as delegate -> attempt RDP to DC) would be highly improbable under this model, allowing it to be flagged as a suspicious chain of events indicative of lateral movement.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Critical Application Servers
      - Network Core
      - Network Egress Points
    range: the last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL normal user action sequences (HMM). SCORE new sequences starting with 'grant permission'. ALERT if sequence probability is anomalously low.