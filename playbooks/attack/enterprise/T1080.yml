name: "T1080: Taint Shared Content"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps investigate whether an adversary has moved laterally by placing malicious content in a shared location. It focuses on detecting malicious files on network shares by analyzing file hashes and names, identifying suspicious scripts or shortcuts, monitoring for unusual volumes of file modifications, and correlating file write events with subsequent executions from a shared path. The goal is to uncover attempts to compromise systems by tainting content accessible to multiple users or systems."
type: "technique"
related:
  - "TA0008: Lateral Movement"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Have any new files on network shares been identified as malicious by matching their hash against a threat intelligence database?"
    context: "This question aims to detect known malware dropped onto network shares. By calculating the SHA256 hash of every new file and comparing it to a database of known malicious file hashes, we can quickly identify threats with a high degree of confidence. A match indicates an adversary has placed a known malicious tool or payload in a shared location, likely for lateral movement or persistence."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek files.log"
      - "Enterprise file shares (e.g., SMB, NFS), document management systems (e.g., SharePoint), and departmental or public-access network drives."
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH file creation events ON network shares | CALCULATE sha256_hash | JOIN with threat_intel_hashes ON sha256_hash | WHERE match_found"
  - question: "Are there any new files on network shares with statistically unusual filenames, such as high entropy or rare character sequences?"
    context: "Adversaries often use randomly generated filenames for their malware to avoid static, signature-based detection. This question focuses on identifying these files by analyzing their names. By establishing a baseline of normal filenames and then flagging new files with high Shannon entropy or unusual n-gram frequencies, we can uncover potential malware that might otherwise go unnoticed. This is a statistical approach to finding unknown or polymorphic malware."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek files.log"
      - "Enterprise file shares (e.g., SMB, NFS), document management systems (e.g., SharePoint), and departmental or public-access network drives."
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH new files ON network shares | FOR_EACH file, CALCULATE shannon_entropy(filename), ngram_frequency(filename) | COMPARE against baseline | WHERE entropy > 95th_percentile OR ngram_is_rare"
  - question: "Can a machine learning model classify any new files on network shares as malicious based on their metadata?"
    context: "This question leverages a machine learning classifier to assess the likelihood of a file being malicious based on its metadata, such as file extension, size, source user, and the process that created it. This approach can identify suspicious files even without a known hash or a clearly anomalous filename. An alert is triggered when the model's calculated probability of maliciousness ($$ p(malicious) > 0.85 $$) exceeds a defined threshold, indicating a high-confidence finding that warrants investigation."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek files.log"
      - "Enterprise file shares (e.g., SMB, NFS), document management systems (e.g., SharePoint), and departmental or public-access network drives."
    range: "last 90 days"
    queries:
      - "pseudocode: STREAM file creation metadata TO ml_model | WHERE model_output_probability > 0.85"
  - question: "Do any new script or shortcut files on network shares contain suspicious commands, obfuscated code, or unexpected target paths?"
    context: "Adversaries frequently use scripts (.ps1, .vbs, .bat) and shortcut files (.lnk) for execution. This question seeks to identify malicious instances of these files by inspecting their content. We look for signs like .lnk files pointing to scripting engines (powershell.exe) or scripts containing common obfuscation techniques (e.g., 'Invoke-Expression', 'FromBase64String') or suspicious API calls using pattern matching like YARA rules. This helps detect malicious payloads staged for lateral movement."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "User home directories on network shares, software deployment and update repositories, and staging directories used by developers or system administrators."
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH new script/shortcut files ON network shares | SCAN file content with YARA rules for obfuscation patterns and suspicious targets | WHERE match_found"
  - question: "Are there new script files on network shares with unusually high character-level entropy compared to benign scripts of the same type?"
    context: "Packed or encrypted scripts often exhibit higher entropy (randomness) than normal, human-written code. This question uses a statistical method to detect them. By calculating the Shannon entropy for new scripts and comparing it to a baseline for legitimate scripts of the same type (e.g., PowerShell), we can identify outliers. A script with significantly higher entropy is a strong indicator that it has been obfuscated to hide its malicious functionality."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "User home directories on network shares, software deployment and update repositories, and staging directories used by developers or system administrators."
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH new script files ON network shares | FOR_EACH script, CALCULATE shannon_entropy(content) | COMPARE against baseline_for_filetype | WHERE entropy > 3_std_dev_above_mean"
  - question: "Can a Natural Language Processing (NLP) model classify the content of new scripts on network shares as malicious?"
    context: "This question applies advanced machine learning, specifically NLP models, to understand the intent of a script's code. By training a model on a vast dataset of both malicious and benign scripts, it can learn to identify malicious patterns in code structure, function calls, and embedded strings that simple pattern matching might miss. An alert is generated when the model classifies a new script as malicious with high confidence (e.g., > 90%), providing a powerful way to detect novel script-based threats."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "User home directories on network shares, software deployment and update repositories, and staging directories used by developers or system administrators."
    range: "last 90 days"
    queries:
      - "pseudocode: STREAM new script content TO nlp_classifier_model | WHERE model_classification == 'malicious' AND confidence > 0.90"
  - question: "Has a user process, other than a standard deployment tool, written or modified sensitive file types (e.g., .exe, .dll) on a network share?"
    context: "This question focuses on detecting unauthorized software or code modification on network shares. By creating a watchlist of sensitive file extensions (like executables and scripts) and known safe processes (like software deployment tools), we can alert on any other process that modifies these file types. This helps pinpoint suspicious activity, such as a user's web browser dropping an executable on a share, which is highly anomalous and could indicate a compromised host being used to stage malware."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 5140"
      - "Zeek smb_files.log"
      - "Sysmon Event ID 11"
      - "Critical file servers hosting intellectual property, financial records, or PII. Also includes application servers with shared configuration files and backup storage locations."
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH file write/modify events ON network shares | WHERE file_extension IN sensitive_list AND process_name NOT IN allowed_list | ALERT"
  - question: "Has any user exhibited anomalous file write activity on network shares, such as an unusually high volume of writes or writing atypical file types?"
    context: "Every user has a typical pattern of behavior. This question aims to detect deviations from that pattern. By creating a baseline for each user's file write activity on shares—including the number of files written per hour and the types of files they usually work with—we can use statistical methods like the Interquartile Range (IQR) to spot anomalies. A sudden spike in file writes or a user suddenly writing file types they've never touched before can indicate a compromised account or insider threat."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 5140"
      - "Zeek smb_files.log"
      - "Sysmon Event ID 11"
      - "Critical file servers hosting intellectual property, financial records, or PII. Also includes application servers with shared configuration files and backup storage locations."
    range: "last 90 days"
    queries:
      - "pseudocode: FOR_EACH user, SEARCH file write events ON network shares | CALCULATE hourly_count, extension_distribution | COMPARE against user_baseline | WHERE current_activity is IQR_outlier"
  - question: "Does a time-series anomaly detection model show a significant, unexpected spike in the overall file write volume on any network share?"
    context: "This question looks for mass file modification events, like those caused by ransomware or a worm propagating, by analyzing the overall activity on a share rather than individual user behavior. A time-series model (like ARIMA or an LSTM autoencoder) is trained on historical file write data to learn the normal rhythm of a share. The model then forecasts expected activity and alerts when the actual number of file writes significantly exceeds the prediction, pointing to a large-scale, anomalous event."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 5140"
      - "Zeek smb_files.log"
      - "Sysmon Event ID 11"
      - "Critical file servers hosting intellectual property, financial records, or PII. Also includes application servers with shared configuration files and backup storage locations."
    range: "last 90 days"
    queries:
      - "pseudocode: AGGREGATE file write events per share in 5-min windows | FEED to time_series_anomaly_model | WHERE observed_volume > forecasted_volume + threshold"
  - question: "Has a file been executed from a network share by a different user or host shortly after it was written?"
    context: "This is a classic pattern for lateral movement: 'drop and execute.' An attacker compromises one machine, uses it to write a malicious payload to a network share, and then triggers its execution from another machine. This question specifically looks for this behavior by correlating file write events with process execution events on the same network path. An alert is generated if the execution happens within a short time window (e.g., $$ \\Delta t < 5 $$ minutes) of the write, and especially if the user or host that wrote the file is different from the one that executed it."
    answer_sources:
      - "Sysmon Event ID 1"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek conn.log"
      - "All endpoints with mounted network shares, especially those belonging to users with broad access (e.g., domain admins, help desk staff) and servers that execute tasks from shared locations."
    range: "last 90 days"
    queries:
      - "pseudocode: CORRELATE file_creation_events with process_execution_events ON UNC_path | WHERE (exec_time - write_time < 5_minutes) AND (write_user != exec_user OR write_host != exec_host)"
  - question: "Has a statistically rare or never-before-seen process been executed from a network share?"
    context: "While some processes are commonly run from network shares (e.g., installers), malware often has a unique or random name. This question aims to find novel threats by identifying executions that are statistically rare across the enterprise. By building a frequency table of all processes executed from shares, we can flag any process that is uncommon (e.g., run by less than 1% of users or seen less than 5 times). This helps detect new malware that isn't yet in any threat intelligence database."
    answer_sources:
      - "Sysmon Event ID 1"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek conn.log"
      - "All endpoints with mounted network shares, especially those belonging to users with broad access (e.g., domain admins, help desk staff) and servers that execute tasks from shared locations."
    range: "last 90 days"
    queries:
      - "pseudocode: BUILD frequency table of process names executed from network shares | FOR_EACH new execution, CHECK frequency | WHERE frequency < threshold (e.g., < 5 times in 90 days)"
  - question: "Has a User and Entity Behavior Analytics (UEBA) model flagged a user's execution of a process from a network share as anomalous for that specific user?"
    context: "This question uses a sophisticated UEBA model to detect when a user's activity deviates from their own established normal behavior. The model learns each user's typical patterns, including what programs they run, from where, and in what context. It would then flag an event like an accountant, who normally only uses Excel, suddenly running a PowerShell script from a network share as a significant anomaly specific to that user's profile, even if running PowerShell from a share is normal for a system administrator."
    answer_sources:
      - "Sysmon Event ID 1"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 11"
      - "Windows Event ID 4663"
      - "Zeek conn.log"
      - "All endpoints with mounted network shares, especially those belonging to users with broad access (e.g., domain admins, help desk staff) and servers that execute tasks from shared locations."
    range: "last 90 days"
    queries:
      - "pseudocode: STREAM process execution events to UEBA_model | FOR_EACH event, model calculates anomaly_score for user_profile | WHERE anomaly_score > threshold"