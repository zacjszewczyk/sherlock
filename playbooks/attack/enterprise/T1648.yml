name: T1648: Serverless Execution
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: |
  This playbook helps determine if an adversary has abused serverless computing for arbitrary code execution. It focuses on identifying malicious activity originating from serverless environments (e.g., AWS Lambda, Azure Functions) or from hybrid service accounts used to bridge cloud and on-premise resources. Key indicators include anomalous outbound network connections from serverless IP ranges to known malicious destinations or involving unusual data volumes; suspicious process creation by hybrid service accounts using reconnaissance tools or LOLBAS; first-time or widespread internal network access by service accounts; anomalous parent-child process relationships; large data exfiltration following a service account logon; the creation of serverless functions with high-risk permissions; and the modification of Power Automate flows to exfiltrate data or establish persistence.
type: technique
related:
  - TA0002: Execution
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any outbound connections from our serverless compute environments been made to known malicious IP addresses or domains?
    context: This question seeks to identify direct command and control (C2) or data exfiltration channels established from a compromised serverless function. By correlating network logs with threat intelligence and known cloud provider IP ranges, an analyst can detect when a function communicates with an adversary-controlled server, which is a strong indicator of compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Threat Intelligence Feed
      - Cloud Provider IP Range Feeds
      - Network egress points, Internet gateways, DNS resolvers, Cloud provider serverless compute environments (e.g., AWS Lambda, Azure Functions, Google Cloud Functions).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek conn.log WHERE source_ip IN serverless_ip_list AND destination_ip IN malicious_ip_feed
  - question: Has any serverless function initiated an outbound connection with an anomalously large data transfer volume?
    context: Adversaries may use compromised serverless functions to exfiltrate large volumes of data. This question aims to detect such activity by baselining normal outbound data transfer volumes (`orig_bytes`) and alerting on significant deviations (e.g., >95th percentile). This helps identify potential data theft that might otherwise be missed if the destination is not on a threat intelligence list.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Threat Intelligence Feed
      - Cloud Provider IP Range Feeds
      - Network egress points, Internet gateways, DNS resolvers, Cloud provider serverless compute environments (e.g., AWS Lambda, Azure Functions, Google Cloud Functions).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE 95th_percentile of orig_bytes for serverless_ips over last 30 days. SEARCH Zeek conn.log WHERE source_ip IN serverless_ip_list AND orig_bytes > 95th_percentile.
  - question: Can machine learning models identify suspicious C2-like traffic originating from our serverless functions based on connection metadata?
    context: This question leverages a machine learning model (e.g., Random Forest) to proactively identify malicious command and control (C2) traffic that may not be caught by signature-based methods. By analyzing features like connection duration, byte counts, protocol, and domain name entropy, the model can flag outbound connections from serverless IPs that exhibit the characteristics of C2 channels, even to unknown destinations.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Threat Intelligence Feed
      - Cloud Provider IP Range Feeds
      - Network egress points, Internet gateways, DNS resolvers, Cloud provider serverless compute environments (e.g., AWS Lambda, Azure Functions, Google Cloud Functions).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY ML model on Zeek conn.log and dns.log features for connections WHERE source_ip IN serverless_ip_list. ALERT where model_prediction == 'malicious' AND confidence_score > 0.9.
  - question: Has a hybrid cloud service account executed any processes containing command-line arguments associated with malicious tools or reconnaissance activity?
    context: This question aims to detect when a compromised hybrid service account is used to execute malicious commands on an on-premise host. By monitoring process creation events (Windows Event ID 4688) for these specific accounts and scanning command-line arguments for known malicious tools (`mimikatz`), reconnaissance commands (`whoami`), or suspicious LOLBAS usage, analysts can identify active adversary behavior.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Service Account Inventory
      - Domain Controllers, Hybrid application servers, On-premise data stores, Endpoints of cloud administrators.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Windows Event 4688 WHERE user IN hybrid_service_accounts AND command_line MATCHES regex('mimikatz|procdump|whoami|nltest /dclist|certutil.exe -urlcache')
  - question: Has any hybrid service account executed a process that is statistically rare for that specific account's normal behavior?
    context: This question focuses on detecting anomalous behavior by identifying when a hybrid service account runs a process it has rarely or never run before. By creating a historical baseline of process executions for each account, analysts can flag executions with a high rarity score (e.g., >98th percentile) as potential indicators of compromise, suggesting the account is being used for activities outside its normal operational scope.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Service Account Inventory
      - Domain Controllers, Hybrid application servers, On-premise data stores, Endpoints of cloud administrators.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE historical process frequency per hybrid_service_account. SEARCH Windows Event 4688 WHERE user IN hybrid_service_accounts AND CALCULATE_RARITY(process_name) > 98th_percentile.
  - question: Have any commands executed by hybrid service accounts used a sequence of arguments that is statistically improbable or deviates from normal administrative scripting?
    context: Adversaries often use legitimate tools like `powershell.exe` with unusual combinations of arguments. This question uses n-gram analysis to model the normal sequences of command-line arguments for processes executed by hybrid service accounts. By alerting on argument sequences with a very low probability, analysts can detect novel or suspicious command invocations that deviate from established patterns, indicating potential misuse.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Service Account Inventory
      - Domain Controllers, Hybrid application servers, On-premise data stores, Endpoints of cloud administrators.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL n-gram probability of command-line arguments for processes run by hybrid_service_accounts. SEARCH Windows Event 4688 WHERE user IN hybrid_service_accounts AND NGRAM_PROBABILITY(command_line) < threshold.
  - question: Has a hybrid service account attempted to authenticate or connect to an internal host that is not on its pre-approved allow-list?
    context: This question enforces a zero-trust model for service accounts by checking if they are accessing unauthorized systems. By maintaining an explicit allow-list of hosts each hybrid account is permitted to access, any connection or authentication attempt to a host not on that list represents a policy violation and a strong indicator of lateral movement or unauthorized reconnaissance.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Service Account Inventory
      - Internal network segments, Authentication servers (e.g., Domain Controllers, RADIUS), High-value data repositories (e.g., file servers, database servers), Crown jewel application servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH (Event 4624 OR Zeek conn.log) WHERE user IN hybrid_service_accounts AND destination_host NOT IN user_specific_allow_list.
  - question: Has a hybrid service account connected to a significantly higher number of unique internal hosts in a 24-hour period than its established baseline?
    context: An adversary who has compromised a service account may use it to scan the network or move laterally to multiple hosts. This question aims to detect such behavior by baselining the daily number of unique hosts accessed by each account. An alert is triggered if this count exceeds a statistical threshold (e.g., mean + 3 standard deviations), indicating a potential burst of scanning or lateral movement activity.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Service Account Inventory
      - Internal network segments, Authentication servers (e.g., Domain Controllers, RADIUS), High-value data repositories (e.g., file servers, database servers), Crown jewel application servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE daily_unique_host_count_mean_and_stddev per hybrid_service_account over last 90 days. SEARCH access logs WHERE user IN hybrid_service_accounts AND unique_host_count_in_24h > (mean + 3*stddev).
  - question: Has a hybrid service account initiated a network connection that does not fit into any established cluster of normal behavior?
    context: This question uses unsupervised machine learning (e.g., DBSCAN) to identify anomalous network connections that deviate from an account's typical activity. By clustering connections based on features like destination port, protocol, and data volume, the model learns what constitutes 'normal' behavior (e.g., 'database queries'). Connections that are flagged as outliers or 'noise' do not fit these patterns and could represent adversary activity.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Service Account Inventory
      - Internal network segments, Authentication servers (e.g., Domain Controllers, RADIUS), High-value data repositories (e.g., file servers, database servers), Crown jewel application servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY DBSCAN clustering model to connection logs for hybrid_service_accounts. ALERT on new connections classified as noise/outliers.
  - question: Has a hybrid service account created a process that results in a known high-risk parent-child relationship (e.g., a web server spawning a command shell)?
    context: Certain parent-child process relationships are highly indicative of malicious activity, such as a web server process (`w3wp.exe`) spawning a command shell (`cmd.exe`). This question uses a deny-list of these known-bad relationships to immediately detect when a hybrid service account is used to perform such an action, which is a strong signal of web shell execution or privilege escalation.
    answer_sources:
      - Windows Event ID 4688
      - Service Account Inventory
      - Application servers running hybrid workloads, Web servers, Database servers, Critical infrastructure hosts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Windows Event 4688 WHERE user IN hybrid_service_accounts AND (parent_process, child_process) IN high_risk_pair_denylist.
  - question: Has a new or statistically rare parent-child process relationship been observed on a server, initiated by a hybrid service account?
    context: This question aims to detect novel execution chains that deviate from a server's established operational baseline. By profiling all parent-child process relationships over time, the system can alert when a hybrid account initiates a process pair that has never been seen before or is extremely rare. This can uncover attacker techniques that use legitimate software in unusual ways to evade detection.
    answer_sources:
      - Windows Event ID 4688
      - Service Account Inventory
      - Application servers running hybrid workloads, Web servers, Database servers, Critical infrastructure hosts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE parent-child process pairs per server over 30 days. SEARCH Windows Event 4688 WHERE (parent_process, child_process) is a new pair OR its frequency < 0.1%.
  - question: Does the process execution chain initiated by a hybrid service account form an anomalous graph structure compared to normal activity?
    context: This question models process activity as a graph to detect complex and abnormal execution flows that simple parent-child rules might miss. By training a graph-based anomaly detection model, analysts can identify unusual structures—such as unexpectedly long chains of processes, a process spawning an abnormal number of children, or circular dependencies—that indicate a sophisticated attack or deviation from benign execution flow.
    answer_sources:
      - Windows Event ID 4688
      - Service Account Inventory
      - Application servers running hybrid workloads, Web servers, Database servers, Critical infrastructure hosts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CONVERT process events from hybrid_service_accounts to graphs. APPLY graph anomaly detection model. ALERT on subgraphs with anomalous structures.
  - question: Has an internal host initiated a connection to a known file-sharing or unauthorized cloud storage site shortly after a hybrid service account logged into it?
    context: This question seeks to identify data staging and exfiltration. An adversary might use a compromised hybrid account to access an internal host and then use that host to upload data to an external service. By correlating account logons with subsequent network traffic within a short time window (e.g., 15 minutes), analysts can detect when a host connects to suspicious destinations like Pastebin or Mega.nz, indicating potential data theft.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network Egress Points, Data staging servers, File shares, Hosts accessed by hybrid service accounts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN Windows Event 4624 (user IN hybrid_service_accounts) with Zeek conn.log (source_ip=event.ip) WHERE conn.timestamp is within 15 minutes of event.timestamp AND conn.destination IN (pastebin, mega.nz, anonfiles, etc).
  - question: Following a hybrid service account logon, did an internal host exfiltrate an anomalously large volume of data in a single session?
    context: This question focuses on detecting bulk data exfiltration. By establishing a baseline for normal outbound data volume for each host, an alert can be triggered when a session's data transfer size exceeds a high-percentile threshold (e.g., 99th percentile). When this anomalous transfer occurs shortly after a hybrid service account logon, it strongly suggests the account was used to access and exfiltrate data.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network Egress Points, Data staging servers, File shares, Hosts accessed by hybrid service accounts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE orig_bytes 99th percentile per host. JOIN Windows Event 4624 with Zeek conn.log within 15 minutes. ALERT where conn.orig_bytes > percentile_threshold.
  - question: Did a critical server's outbound network traffic volume significantly and unexpectedly spike immediately following a hybrid service account logon?
    context: This question uses a time-series forecasting model (e.g., ARIMA) to predict a server's normal outbound traffic patterns, using service account logons as a potential influencing factor. An alert is generated when the actual traffic volume significantly deviates from the model's prediction after a logon event. This can detect sophisticated exfiltration methods that might not be a single large session but a sustained, anomalous increase in traffic.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network Egress Points, Data staging servers, File shares, Hosts accessed by hybrid service accounts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL time-series of outbound traffic for critical servers, with hybrid account logons as a regressor. ALERT when observed traffic significantly exceeds predicted volume post-logon.
  - question: Has a serverless function been created or updated with high-risk IAM permissions, such as wildcards (`*:*`) or the ability to pass roles (`iam:PassRole`)?
    context: This question aims to detect the creation of overly permissive or malicious serverless functions. Adversaries may create or modify functions with excessive permissions to escalate privileges or access other resources. Monitoring cloud audit logs for specific high-risk permissions in function creation or update events provides an early warning of potential persistence or privilege escalation mechanisms.
    answer_sources:
      - Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Logs, Google Cloud Audit Logs)
      - Cloud IAM services, Serverless function configuration portals (e.g., AWS Lambda Console), Cloud event/messaging services (e.g., AWS EventBridge, Azure Event Grid), Cloud code repositories.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH cloud_audit_logs for events (CreateFunction, UpdateFunctionConfiguration) WHERE request_parameters contain ('iam:PassRole', '*:*', 'iam:CreatePolicyVersion').
  - question: Has a newly created or modified serverless function been assigned a combination of permissions and triggers that results in a statistically high risk score?
    context: This question provides a quantitative method for assessing the risk of a serverless function's configuration. By assigning a rarity score to each permission and trigger, and then summing these to create a total risk score for the function, analysts can identify outliers. A function whose risk score is in the 99th percentile for the environment is highly anomalous and warrants investigation, even if no single permission is explicitly forbidden.
    answer_sources:
      - Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Logs, Google Cloud Audit Logs)
      - Cloud IAM services, Serverless function configuration portals (e.g., AWS Lambda Console), Cloud event/messaging services (e.g., AWS EventBridge, Azure Event Grid), Cloud code repositories.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE rarity score for all IAM permissions and triggers. For new/modified functions, CALCULATE total risk score. ALERT where risk_score > 99th_percentile.
  - question: Can a machine learning model identify serverless function configurations that are likely malicious based on their attributes?
    context: This question leverages a classification model to automatically flag suspicious function configurations. By training the model on features like the creator's identity, source IP, and the number and type of permissions, it can learn to distinguish between normal administrative changes and potentially malicious ones. This helps prioritize analyst attention on the functions most likely to be compromised or created for malicious purposes.
    answer_sources:
      - Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Logs, Google Cloud Audit Logs)
      - Cloud IAM services, Serverless function configuration portals (e.g., AWS Lambda Console), Cloud event/messaging services (e.g., AWS EventBridge, Azure Event Grid), Cloud code repositories.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY ML model to new/modified function configurations. ALERT where model_prediction == 'malicious' AND confidence_score > 0.9.
  - question: Has a Power Automate flow been created or updated to automatically forward emails or share files with external, non-corporate destinations?
    context: Adversaries can abuse Power Automate (or similar low-code platforms) to create simple yet effective data exfiltration or persistence rules. This question looks for the creation or modification of flows that use sensitive actions (like sending emails or creating sharing links) in combination with external destinations or anonymous access settings, which could indicate an attempt to siphon data out of the M365 environment.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Microsoft 365 environment, User mailboxes (Exchange Online), Document libraries (SharePoint Online, OneDrive), Power Platform admin center.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH M365 audit logs WHERE operation IN ('FlowCreated', 'FlowUpdated') AND flow_definition contains (('Send_an_email_V2' OR 'Create_sharing_link') AND external_destination).
  - question: Has a user created an anomalously high number of Power Automate flows, or used a statistically rare combination of triggers and actions?
    context: This question aims to detect abuse of Power Automate by looking for behavioral anomalies. A sudden spike in flow creation by a single user could indicate a compromised account setting up malicious rules. Similarly, the use of a rare combination of triggers and actions (e.g., 'new email' trigger with an 'HTTP POST' action) can highlight a novel or suspicious automation that deviates from normal business processes.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Microsoft 365 environment, User mailboxes (Exchange Online), Document libraries (SharePoint Online, OneDrive), Power Platform admin center.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE user flow creation rate. ALERT where user_flow_creation_rate > 3 * std_dev. BASELINE trigger/action pair frequency. ALERT on statistically rare pairs.
  - question: Does a newly created Power Automate flow fall outside the established clusters of normal business process automation?
    context: This question uses unsupervised clustering to identify anomalous Power Automate flows that do not conform to existing patterns. By converting flow definitions into numerical vectors and grouping them, the system can identify clusters representing common business tasks. A flow that is identified as an outlier or 'noise' does not fit any of these patterns and is a strong candidate for manual review as it may be malicious.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Microsoft 365 environment, User mailboxes (Exchange Online), Document libraries (SharePoint Online, OneDrive), Power Platform admin center.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: VECTORIZE Power Automate flow definitions. APPLY clustering algorithm. ALERT when a new flow is identified as an outlier.