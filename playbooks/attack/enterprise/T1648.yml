name: T1648: Serverless Execution
id: f2c4e6a8-8d9b-4e7a-9f0c-1b2d3e4f5a6b
description: This playbook focuses on detecting adversaries abusing serverless computing for arbitrary code execution. It addresses threats such as outbound network connections from serverless functions to malicious destinations or involving anomalous data volumes; suspicious process creation on hybrid systems by service accounts using malicious tools or exhibiting rare behaviors; anomalous network access patterns by these accounts, including connections to unauthorized hosts or atypical connection properties; unusual parent-child process relationships indicating unexpected execution flows; data exfiltration attempts following service account logons; the creation of serverless functions or Power Automate flows with high-risk permissions or configurations indicative of persistence and data theft.
type: technique
related:
  - TA0002: Execution
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags:
  - none
investigative_questions:
  - question: Has a serverless function initiated a network connection to a known malicious IP address or domain?
    context: This question seeks to identify direct communication from serverless compute environments to known command-and-control (C2) infrastructure or other malicious endpoints. By correlating outbound traffic from cloud provider serverless IP ranges against a threat intelligence feed of malicious indicators, analysts can uncover high-confidence signs of a compromised function.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Threat Intelligence Feed
      - Cloud Provider IP Range Feeds
      - Network egress points
      - Internet gateways
      - DNS resolvers
      - Cloud provider serverless compute environments (e.g., AWS Lambda, Azure Functions, Google Cloud Functions)
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH conn.log
          WHERE source_ip IN serverless_ip_list
          AND destination_ip IN malicious_ip_list
  - question: Has a serverless function initiated an outbound network connection with an anomalously large data transfer volume?
    context: This question helps detect potential data exfiltration. Adversaries may use compromised serverless functions to collect and transfer large volumes of sensitive data out of the network. By establishing a historical baseline of normal outbound traffic volume (e.g., over 30 days) and alerting on significant deviations (e.g., exceeding the 95th percentile), analysts can identify suspicious data transfers that warrant investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Threat Intelligence Feed
      - Cloud Provider IP Range Feeds
      - Network egress points
      - Internet gateways
      - DNS resolvers
      - Cloud provider serverless compute environments (e.g., AWS Lambda, Azure Functions, Google Cloud Functions)
    range: last 30 days
    queries:
      - pseudocode: |
          SEARCH conn.log
          WHERE source_ip IN serverless_ip_list
          CALCULATE 95th_percentile(outbound_bytes) over last 30 days
          ALERT IF current_outbound_bytes > 95th_percentile
  - question: Does outbound network traffic from a serverless function exhibit characteristics of malicious command-and-control (C2) communication based on a machine learning model?
    context: This question moves beyond simple signature-based detection to identify behavioral patterns of malicious C2 traffic. A machine learning model can be trained to recognize subtle characteristics (e.g., connection duration, data size, protocol, domain name entropy) that distinguish malicious traffic from benign traffic. Applying this model to outbound connections from serverless functions can help detect novel or evasive C2 channels.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Threat Intelligence Feed
      - Cloud Provider IP Range Feeds
      - Network egress points
      - Internet gateways
      - DNS resolvers
      - Cloud provider serverless compute environments (e.g., AWS Lambda, Azure Functions, Google Cloud Functions)
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY ML model (Random Forest) to conn.log and dns.log features
          FOR connections where source_ip IN serverless_ip_list
          ALERT IF classification is 'malicious' AND confidence > 0.9
  - question: Has a hybrid cloud service account executed a process containing known malicious tools, reconnaissance commands, or suspicious LOLBAS usage?
    context: Adversaries may compromise service accounts used for hybrid cloud operations to execute malicious code on-premises. This question looks for explicit signs of this activity by scanning the command lines of processes created by these accounts for keywords, tools (e.g., mimikatz), and patterns associated with reconnaissance (e.g., whoami) or the abuse of legitimate system utilities (Living Off the Land Binaries, or LOLBAS).
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Service Account Inventory
      - Domain Controllers
      - Hybrid application servers
      - On-premise data stores
      - Endpoints of cloud administrators
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH Event ID 4688
          WHERE user IN hybrid_service_accounts
          AND command_line MATCHES (mimikatz, procdump, whoami, nltest, 'certutil.exe -urlcache', etc.)
  - question: Has a hybrid cloud service account executed a process that is statistically rare for that specific account's normal behavior?
    context: This question aims to detect anomalous behavior even when no explicitly malicious tools are used. By baselining the typical processes run by each service account, an execution that is unusual for that account's established role can be flagged. This is useful for identifying a compromised account being used for unintended purposes that deviate from its normal operational profile.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Service Account Inventory
      - Domain Controllers
      - Hybrid application servers
      - On-premise data stores
      - Endpoints of cloud administrators
    range: last 90 days
    queries:
      - pseudocode: |
          FOR EACH user IN hybrid_service_accounts
          CALCULATE historical frequency of process_name
          ALERT IF new process execution has a rarity_score > 98th percentile
  - question: Has a hybrid cloud service account executed a common process (like powershell.exe) with an unusual or improbable sequence of command-line arguments?
    context: This provides a more granular analysis of process execution, as adversaries often use legitimate tools with malicious arguments. By modeling the normal command-line argument patterns for common processes on a per-account basis using n-gram analysis, analysts can detect deviations that suggest malicious scripting or interactive use rather than standard administrative tasks.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Service Account Inventory
      - Domain Controllers
      - Hybrid application servers
      - On-premise data stores
      - Endpoints of cloud administrators
    range: last 90 days
    queries:
      - pseudocode: |
          MODEL n-gram sequence of command-line arguments for processes like powershell.exe
          FOR EACH user IN hybrid_service_accounts
          ALERT IF probability of new argument sequence is below threshold
  - question: Has a hybrid service account attempted to access an internal host that is not on its pre-approved allow-list?
    context: This provides a high-fidelity detection method for potential lateral movement. By defining and enforcing an explicit allow-list of hosts a service account is permitted to access, any authentication or connection attempt to an unauthorized system becomes a strong indicator of compromise, misconfiguration, or an insider threat.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Service Account Inventory
      - Internal network segments
      - Authentication servers (e.g., Domain Controllers, RADIUS)
      - High-value data repositories (e.g., file servers, database servers)
      - Crown jewel application servers
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH Event ID 4624 OR conn.log
          WHERE user IN hybrid_service_accounts
          AND destination_host NOT IN user_specific_allow_list
  - question: Has a hybrid service account accessed a significantly higher number of unique internal hosts in a 24-hour period than its established baseline?
    context: This question helps detect network scanning and reconnaissance. An adversary using a compromised service account may try to discover other systems on the network. A sudden spike in the number of unique hosts accessed by an account, measured against its historical average (e.g., > 3 standard deviations), is a strong statistical indicator of this behavior.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Service Account Inventory
      - Internal network segments
      - Authentication servers (e.g., Domain Controllers, RADIUS)
      - High-value data repositories (e.g., file servers, database servers)
      - Crown jewel application servers
    range: last 90 days
    queries:
      - pseudocode: |
          FOR EACH user IN hybrid_service_accounts
          CALCULATE mean and stddev of unique_hosts_accessed_per_day over last 90 days
          ALERT IF unique_hosts_in_last_24h > (mean + 3 * stddev)
  - question: Has a hybrid service account initiated a network connection that does not fit into any established cluster of normal behavior?
    context: This question uses unsupervised machine learning (e.g., DBSCAN) to identify anomalous connections without pre-defined rules. By clustering normal connection patterns based on features like destination port, protocol, and data volume, any new connection that is flagged as an outlier (i.e., does not belong to any known cluster) can be investigated as a potential indicator of novel attack techniques or lateral movement.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Service Account Inventory
      - Internal network segments
      - Authentication servers (e.g., Domain Controllers, RADIUS)
      - High-value data repositories (e.g., file servers, database servers)
      - Crown jewel application servers
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY DBSCAN clustering to conn.log features for hybrid service accounts
          ALERT IF a new connection is flagged as a noise point (outlier)
  - question: Has a hybrid service account created a process that results in a known high-risk parent-child relationship (e.g., a web server spawning a command shell)?
    context: Certain parent-child process relationships, such as a web server process (w3wp.exe) spawning a command shell (cmd.exe), are almost always indicative of malicious activity. This question uses a simple but effective deny-list to catch these unambiguous signs of code execution, which could be part of a web shell or other exploit.
    answer_sources:
      - Windows Event ID 4688
      - Service Account Inventory
      - Application servers running hybrid workloads
      - Web servers
      - Database servers
      - Critical infrastructure hosts
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH Event ID 4688
          WHERE user IN hybrid_service_accounts
          AND (parent_process, child_process) IN deny_list_pairs
  - question: Has a process been created on a hybrid workload server that results in a parent-child relationship never seen before on that server, or one that is historically very rare?
    context: This question aims to detect novel execution flows by baselining legitimate parent-child process relationships on a server-by-server basis. Any new or extremely rare pairing can be flagged as anomalous. This is effective for detecting attackers using living-off-the-land techniques in unexpected ways that deviate from normal administrative or application behavior.
    answer_sources:
      - Windows Event ID 4688
      - Service Account Inventory
      - Application servers running hybrid workloads
      - Web servers
      - Database servers
      - Critical infrastructure hosts
    range: last 30 days
    queries:
      - pseudocode: |
          BASELINE parent-child pairs per server over last 30 days
          ALERT IF new pair is observed for the first time OR its historical frequency is < 0.1%
  - question: Does the process execution chain initiated by a hybrid service account form an anomalous graph structure compared to normal execution flows?
    context: This question models process activity as a complex graph to find sophisticated anomalies beyond simple parent-child pairs. By analyzing the entire execution chain (e.g., its length, branching, or specific nodes), a graph-based model can detect attacks that involve multiple, individually legitimate steps that, when combined, create a suspicious execution path.
    answer_sources:
      - Windows Event ID 4688
      - Service Account Inventory
      - Application servers running hybrid workloads
      - Web servers
      - Database servers
      - Critical infrastructure hosts
    range: last 90 days
    queries:
      - pseudocode: |
          MODEL process executions as a graph
          TRAIN graph anomaly detection model on normal structure
          ALERT IF new subgraph from a hybrid service account is structurally anomalous
  - question: Following a logon by a hybrid service account, did the host initiate an outbound connection to a known unauthorized file-sharing or paste site?
    context: This question targets a common data exfiltration pattern where an attacker logs in with a compromised account, stages data, and then uploads it to an external service. By correlating the logon event (Windows Event ID 4624) with subsequent outbound network traffic (Zeek conn.log) within a short time window (e.g., 15 minutes), analysts can find strong, contextual evidence of exfiltration.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network Egress Points
      - Data staging servers
      - File shares
      - Hosts accessed by hybrid service accounts
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH for logon (Event ID 4624) by hybrid service account
          WITHIN 15 minutes, SEARCH for outbound connection (conn.log) from same host
          ALERT IF destination is on a list of file-sharing/paste sites
  - question: Following a logon by a hybrid service account, did the host exfiltrate an anomalously large amount of data in a single network session?
    context: This question looks for large-scale data theft. By establishing a baseline for normal outbound data volume from each host, a connection that sends significantly more data than usual (e.g., >99th percentile) shortly after a hybrid account logon is highly suspicious. This correlation helps tie the anomalous network activity directly to the account that may have initiated it.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network Egress Points
      - Data staging servers
      - File shares
      - Hosts accessed by hybrid service accounts
    range: last 30 days
    queries:
      - pseudocode: |
          SEARCH for logon (Event ID 4624) by hybrid service account
          WITHIN 15 minutes, SEARCH for outbound connection (conn.log) from same host
          ALERT IF outbound_bytes > 99th_percentile_baseline_for_host
  - question: Did a critical server's outbound network traffic deviate significantly from its predicted volume immediately following a logon by a hybrid service account?
    context: This uses predictive modeling for sophisticated anomaly detection. A time-series model (e.g., ARIMA) learns the normal rhythm of a server's network traffic. By including logon events as a factor, the model can predict expected traffic. A large, unpredicted spike in outbound traffic after a logon is a strong signal of anomalous activity like data exfiltration.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network Egress Points
      - Data staging servers
      - File shares
      - Hosts accessed by hybrid service accounts
    range: last 90 days
    queries:
      - pseudocode: |
          MODEL outbound traffic volume per minute with ARIMA/Prophet, using logons as a regressor
          ALERT IF actual_traffic significantly exceeds predicted_traffic after a hybrid account logon
  - question: Has a serverless function been created or modified with high-risk IAM permissions, such as wildcards or the ability to pass roles?
    context: This is a fundamental security check to prevent privilege escalation in the cloud. Permissions like `iam:PassRole` or wildcards (`*:*`) can be abused by an attacker to grant a serverless function excessive privileges, turning it into a powerful pivot point. Alerting on the creation of such configurations is a critical preventative and detective control.
    answer_sources:
      - Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Logs, Google Cloud Audit Logs)
      - Cloud IAM services
      - Serverless function configuration portals (e.g., AWS Lambda Console)
      - Cloud event/messaging services (e.g., AWS EventBridge, Azure Event Grid)
      - Cloud code repositories
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH cloud audit logs (CreateFunction, UpdateFunctionConfiguration)
          WHERE request_parameters contain ('iam:PassRole', '*:*', etc.)
  - question: Has a serverless function been configured with a combination of permissions and triggers that results in a statistically high risk score compared to the rest of the environment?
    context: This question moves from looking at single risky permissions to evaluating the overall risk of a function's configuration. By assigning rarity scores to permissions and triggers, we can identify functions that, while not having one single "deny-listed" permission, have an unusual and potentially dangerous combination of privileges, indicating a possible backdoor or high-risk misconfiguration.
    answer_sources:
      - Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Logs, Google Cloud Audit Logs)
      - Cloud IAM services
      - Serverless function configuration portals (e.g., AWS Lambda Console)
      - Cloud event/messaging services (e.g., AWS EventBridge, Azure Event Grid)
      - Cloud code repositories
    range: last 90 days
    queries:
      - pseudocode: |
          CALCULATE rarity score for all IAM permissions and triggers
          FOR each function, SUM scores to get a total risk score
          ALERT IF function_risk_score > 99th percentile of all functions
  - question: Does a newly created or modified serverless function's configuration appear malicious based on a machine learning classification model?
    context: This question uses a supervised machine learning model to automatically flag suspicious function configurations. By training on known benign and malicious examples, the model can learn complex patterns involving the creator's identity, source IP, and the specific combination of permissions and triggers, providing an automated first-pass analysis for security teams.
    answer_sources:
      - Cloud provider audit logs (e.g., AWS CloudTrail, Azure Activity Logs, Google Cloud Audit Logs)
      - Cloud IAM services
      - Serverless function configuration portals (e.g., AWS Lambda Console)
      - Cloud event/messaging services (e.g., AWS EventBridge, Azure Event Grid)
      - Cloud code repositories
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY ML model (Logistic Regression) to function configuration features
          ALERT IF classification is 'malicious' AND confidence is high
  - question: Has a Power Automate flow been created or updated to automatically forward emails, create public sharing links, or send data to an external web service?
    context: This question targets the abuse of low-code/no-code platforms like Power Automate for malicious purposes. Adversaries can create seemingly benign automation flows that act as persistence or data exfiltration mechanisms. This rule looks for specific, high-risk actions within a flow's definition that are commonly used for these purposes.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Microsoft 365 environment
      - User mailboxes (Exchange Online)
      - Document libraries (SharePoint Online, OneDrive)
      - Power Platform admin center
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH M365 audit logs for Operation: (FlowCreated, FlowUpdated)
          INSPECT flow definition for actions like 'Send_an_email', 'Create_sharing_link'
          WITH external destinations or anonymous settings
  - question: Has a user created an anomalous number of Power Automate flows, or used a statistically rare combination of triggers and actions?
    context: This question provides behavioral anomaly detection for Power Automate usage. A sudden burst of flow creation by a user, or the use of an unusual trigger-action pair (e.g., 'new email arrives' trigger combined with an 'HTTP POST' action), can indicate that an account has been compromised and is being used to set up malicious automation.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Microsoft 365 environment
      - User mailboxes (Exchange Online)
      - Document libraries (SharePoint Online, OneDrive)
      - Power Platform admin center
    range: last 90 days
    queries:
      - pseudocode: |
          BASELINE flow creation count per user AND trigger/action pair frequency
          ALERT IF user's flow creation > 3 stddev above baseline
          OR IF trigger/action pair is statistically rare
  - question: Does a new Power Automate flow's definition fall outside of established clusters of normal business process automation?
    context: This question uses unsupervised machine learning to identify novel or unusual flows without pre-defined rules. By clustering existing flows based on their components (actions, connectors, triggers), we can identify "normal" business processes. A new flow that does not fit into any existing cluster is an outlier and warrants investigation as it may be a custom-built malicious tool.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Microsoft 365 environment
      - User mailboxes (Exchange Online)
      - Document libraries (SharePoint Online, OneDrive)
      - Power Platform admin center
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY clustering (K-Means) to vectorized flow definitions
          ALERT IF new flow is classified as an outlier or belongs to a suspicious cluster