name: T1534: Internal Spearphishing
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps determine if an adversary is leveraging a compromised internal account for lateral movement via internal spearphishing. It focuses on identifying key indicators such as outbound network connections to malicious destinations from mail clients, the spawning of script interpreters by office applications, suspicious email characteristics like header mismatches or high-risk attachments, correlated sequences of suspicious host events (e.g., DNS query to process spawn to network access), and anomalous email sending volumes from internal accounts.
type: technique
related:
  - TA0008: Lateral Movement
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are internal hosts making network connections to IPs or domains on threat intelligence blocklists?
    context: This is a foundational check to identify communications with known-malicious infrastructure. A connection from an internal host, particularly from a mail or collaboration client, to a destination on a threat intelligence feed is a high-confidence indicator of a successful spearphish where a user has clicked a malicious link.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Network Egress Points
      - Internal DNS Resolvers
      - User Endpoints
      - Web Proxies
    range: last 90 days
    queries:
      - pseudocode: JOIN (network_logs, dns_logs) WITH threat_intel_feed ON (dest_ip, domain) WHERE source_ip IS_INTERNAL; ALERT on match;
  - question: Are internal hosts communicating with newly registered and rarely seen domains?
    context: Adversaries frequently use newly registered domains (NRDs) for phishing campaigns to bypass reputation-based blocking. A domain that is both recently created and has very little or no traffic history within the enterprise is highly suspicious, as it suggests a lack of legitimate purpose and is a common tactic for establishing attack infrastructure.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Network Egress Points
      - Internal DNS Resolvers
      - User Endpoints
      - Web Proxies
    range: last 90 days
    queries:
      - pseudocode: CALCULATE FQDN_frequency over 90_days; ENRICH with WHOIS_registration_date; FLAG hosts connecting to domains WHERE frequency < 5th_percentile AND age < 30_days;
  - question: Can a machine learning model identify malicious outbound connections from email or chat clients based on network characteristics?
    context: This question moves beyond simple blocklists to behavior-based detection. A model can analyze a combination of network features (port, protocol, data volume, domain entropy, JA3 hash) to identify subtle patterns indicative of malicious traffic, allowing for the detection of connections to unknown malicious servers.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Network Egress Points
      - Internal DNS Resolvers
      - User Endpoints
      - Web Proxies
    range: last 90 days
    queries:
      - pseudocode: FOR each connection from [OUTLOOK.EXE, MSTEAMS.EXE]: SCORE with ML_model(dest_port, protocol, volume, domain_entropy, ja3_hash); ALERT if score > threshold;
  - question: Are office or collaboration applications spawning shell or script interpreter processes?
    context: Legitimate user activity almost never involves an email client, word processor, or chat application directly launching a command shell (cmd.exe) or script interpreter (powershell.exe, wscript.exe). This action is a classic indicator of macro execution from a malicious document or a user clicking a link that runs a malicious script.
    answer_sources:
      - Windows Event ID 4688
      - User Endpoints
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH process_logs WHERE parent_process IN [office_apps] AND child_process IN [script_interpreters]; ALERT on match;
  - question: Is a script interpreter launched by an office application using an unusually complex or obfuscated command line?
    context: Adversaries often use obfuscation techniques, such as Base64 encoding, to hide malicious commands passed to interpreters like PowerShell. This obfuscation increases the randomness, or entropy, of the command-line string. Detecting a high-entropy command line from a process spawned by an office application can reveal attempts to execute hidden malicious code.
    answer_sources:
      - Windows Event ID 4688
      - User Endpoints
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers
    range: last 90 days
    queries:
      - pseudocode: FOR each process_creation_event: CALCULATE command_line_entropy; IF parent is office_app AND child is script_interpreter: ALERT if entropy > baseline + 3*std_dev;
  - question: Can a machine learning model distinguish between benign and suspicious process creation events originating from office applications?
    context: A machine learning model can analyze multiple features of a process creation event (parent/child names, command-line length and entropy, user context) to learn the complex patterns that differentiate normal system behavior from malicious activity. This provides a more robust detection capability than simple rules and helps identify novel attack techniques.
    answer_sources:
      - Windows Event ID 4688
      - User Endpoints
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers
    range: last 90 days
    queries:
      - pseudocode: FOR each process_event from office_app: CLASSIFY with ML_model(parent, child, cmd_length, cmd_entropy); ALERT if classification is 'suspicious';
  - question: Are internal emails being sent with mismatched 'From' and 'Reply-To' headers or containing links from URL shorteners?
    context: A mismatch between the 'From' and 'Reply-To' headers is a technique used to spoof a sender's identity while ensuring any replies are directed to an attacker-controlled mailbox. Additionally, URL shorteners are often used to obscure the final destination of a malicious link. Both are suspicious in an internal email context.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Internal Mail Transfer Agents
      - Network Segments with Email Servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH smtp_logs WHERE source_is_internal AND dest_is_internal: ALERT if from_header_domain != reply-to_header_domain OR body contains known_url_shortener;
  - question: Are internal emails being sent with statistically rare or high-risk file attachment types?
    context: While common business attachments (.docx, .pdf) are frequent, certain file types like ISO images (.iso), LNK files (.lnk), or VHD files (.vhd) are rarely exchanged in legitimate internal email. Their presence is highly anomalous and a strong indicator of a malicious payload being delivered.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Internal Mail Transfer Agents
      - Network Segments with Email Servers
    range: last 90 days
    queries:
      - pseudocode: CALCULATE MIME_type_frequency over 30_days; FOR each new email: ALERT if attachment_MIME_type is in bottom 1st percentile (e.g., .iso, .lnk, .html);
  - question: Can a machine learning model score the risk of an internal email based on its metadata and sender-recipient relationship?
    context: This approach combines multiple weak indicators of maliciousness (e.g., header anomalies, URL counts, subject length) with contextual information (e.g., rarity of the sender-recipient pair) into a single risk score. This allows for the detection of suspicious emails that may not trigger any single high-fidelity rule but are risky when viewed holistically.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Internal Mail Transfer Agents
      - Network Segments with Email Servers
    range: last 90 days
    queries:
      - pseudocode: FOR each internal email: SCORE with ML_model(header_features, graph_features); ALERT if score > threshold;
  - question: Are hosts exhibiting a correlated sequence of events: a suspicious DNS query, followed by suspicious process creation, followed by network share access?
    context: While a single one of these events could be benign, their occurrence in a tight sequence on a single host is highly indicative of a successful attack chain: 1) A user clicks a link (DNS query), 2) a payload is executed (process creation), and 3) the payload attempts to access resources or move laterally (network share access).
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Windows Event ID 5145
      - User Endpoints
      - File Servers
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: CORRELATE logs by host_ip; ALERT if (event_1: suspicious_dns_query) -> (event_2: suspicious_process_creation) -> (event_3: network_share_access) occurs within 5 minutes;
  - question: Following a potential phishing click, is the user's account accessing network shares that are unusual for that user?
    context: After compromising an account, an attacker will often perform reconnaissance by accessing network shares. This activity frequently deviates from the legitimate user's normal behavior. By baselining normal user access patterns, we can flag access to a rare or never-before-seen share as potential post-compromise activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Windows Event ID 5145
      - User Endpoints
      - File Servers
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: BUILD user_share_access_baseline over 90_days; IF potential_phish_click_detected: ALERT on any subsequent access to a share not in user's baseline;
  - question: Can a sequence mining model detect anomalous chains of user activity indicative of a spearphishing attack chain?
    context: This advanced behavioral approach involves training a model to understand the normal temporal sequences of events on a host (e.g., open email, open doc). The model can then identify a sequence like [open email -> DNS query to NRD -> spawn PowerShell -> access network share] as a low-probability, and therefore highly suspicious, chain of events.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Windows Event ID 5145
      - User Endpoints
      - File Servers
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: TRAIN sequence_model (HMM/LSTM) on normal user event sequences; FOR new event sequences: ALERT if model assigns low probability to the observed sequence;
  - question: Is a single internal account sending a mass email with an identical subject line to a large number of internal recipients?
    context: This is a simple but effective rule for detecting a compromised account being used to propagate a phishing campaign internally. It is highly unusual for a legitimate user to send an identical email to over 100 colleagues within a single hour; this behavior is characteristic of an automated script.
    answer_sources:
      - Zeek smtp.log
      - Internal Mail Transfer Agents
      - Network Segments with Email Servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH smtp_logs; GROUP BY source_ip, subject, hour; ALERT if count(unique_recipients) > 100 AND source_is_internal;
  - question: Is an internal user account suddenly sending a statistically anomalous volume of email or emailing an anomalously high number of unique recipients?
    context: This method creates a behavioral baseline for each individual user's email sending habits. An alert is triggered when a user's activity (both emails sent and unique recipients) dramatically exceeds their own historical average, which is a strong indicator that their account has been compromised and is being used for malicious purposes.
    answer_sources:
      - Zeek smtp.log
      - Internal Mail Transfer Agents
      - Network Segments with Email Servers
    range: last 90 days
    queries:
      - pseudocode: FOR each sender: CALCULATE 30-day_baseline (mean, std_dev) for emails/hour and recipients/hour; ALERT if current_hour_activity > mean + 3*std_dev for both metrics;
  - question: Can clustering algorithms identify automated internal phishing campaigns by finding groups of highly similar emails from a single sender?
    context: Adversaries may slightly alter subject lines or content to evade simple identical-match rules. By converting subject lines into numerical vectors (e.g., TF-IDF) and using a clustering algorithm like DBSCAN, we can group thematically similar emails. Identifying a large, dense cluster of emails from one sender that is unusual for their history can unmask a sophisticated, automated campaign.
    answer_sources:
      - Zeek smtp.log
      - Internal Mail Transfer Agents
      - Network Segments with Email Servers
    range: last 90 days
    queries:
      - pseudocode: HOURLY: VECTORIZE subject_lines (TF-IDF); CLUSTER vectors by sender using DBSCAN; ALERT if large, dense cluster is anomalous for that sender's history;