name: T1534: Internal Spearphishing
id: 3c57a73a-44d2-4318-86d7-1b059530263f
description: This playbook helps identify if an adversary is leveraging a compromised internal account for lateral movement via internal spearphishing. Detections focus on identifying suspicious network connections from mail clients, unusual process creation from office applications, anomalous characteristics in internal emails (such as header mismatches or high-risk attachments), correlated sequences of events (DNS query -> process spawn -> network access), and statistically significant anomalies in email sending volume from internal accounts.
type: technique
related:
- TA0008: Lateral Movement
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is an internal host communicating with known malicious infrastructure via an email or collaboration client?
  context: This question aims to detect direct command and control (C2) or data exfiltration channels established by malware delivered through an internal spearphishing email. An email or chat client making connections to destinations on threat intelligence blocklists is a high-fidelity indicator of compromise.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Threat Intelligence Feeds
  - NAI: Network Egress Points, Internal DNS Resolvers, User Endpoints, Web Proxies
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH network_logs OR dns_logs WHERE source_ip IN internal_network AND (destination_ip IN threat_intel_feed OR destination_domain IN threat_intel_feed) AND source_process IN (email_clients, collab_tools)
- question: Are internal hosts connecting to newly registered or rarely seen domains via email or collaboration clients?
  context: Adversaries often use newly registered domains (NRDs) for phishing campaigns. Legitimate internal traffic rarely goes to these domains. This question helps identify potential phishing links or C2 domains by flagging connections to domains that are both statistically rare for the enterprise and recently created.
  answer_sources:
  - Zeek dns.log
  - WHOIS data
  - NAI: Network Egress Points, Internal DNS Resolvers, User Endpoints, Web Proxies
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH dns_logs | CALCULATE frequency(domain) OVER 90d | JOIN with whois_data | WHERE frequency < 5th_percentile AND registration_age < 30d AND source_ip IN internal_network
- question: Does network traffic originating from an email or collaboration client exhibit characteristics of malicious activity according to a machine learning model?
  context: This question uses a machine learning model to move beyond simple blocklists and heuristics. By analyzing a combination of network features (port, protocol, data volume, etc.), the model can identify subtle patterns indicative of malicious connections that might otherwise be missed, providing a more robust and adaptive detection method.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Zeek files.log
  - Windows Event ID 4688
  - NAI: Network Egress Points, Internal DNS Resolvers, User Endpoints, Web Proxies
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: INPUT network_logs WHERE source_process IN (email_clients, collab_tools) | APPLY ML_model(features) | RETURN events WHERE malicious_probability > threshold
- question: Has an office productivity or collaboration application spawned a command-line interpreter or scripting engine?
  context: This is a classic indicator of compromise. Legitimate user activity rarely involves an application like Outlook or Word directly launching PowerShell or Command Prompt. This behavior is often associated with the execution of a malicious macro or payload delivered via a phishing email.
  answer_sources:
  - Windows Event ID 4688
  - NAI: User Endpoints, Virtual Desktop Infrastructure (VDI), Application Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH process_creation_logs WHERE parent_process IN (office_apps, collab_tools) AND child_process IN (script_interpreters, shells)
- question: Was a script interpreter or shell spawned by an office application with an unusually complex or obfuscated command line?
  context: Adversaries often use obfuscation to hide their commands within command-line arguments. High entropy (a measure of randomness or complexity) in the command line can indicate the presence of encoded scripts (e.g., Base64), which is a common technique to evade signature-based detections.
  answer_sources:
  - Windows Event ID 4688
  - NAI: User Endpoints, Virtual Desktop Infrastructure (VDI), Application Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH process_creation_logs WHERE parent_process IN (office_apps) AND child_process IN (script_interpreters) | CALCULATE entropy(command_line) | RETURN events WHERE entropy > baseline_std_dev * 3 OR entropy > 4.5
- question: Does a machine learning model classify a process creation event originating from an office application as suspicious?
  context: This question leverages a machine learning model to provide a more nuanced assessment of process creation events. The model can learn the complex relationships between features like parent/child process names, command-line properties, and user context to identify suspicious activity that may not be caught by simple rules, reducing false positives.
  answer_sources:
  - Windows Event ID 4688
  - NAI: User Endpoints, Virtual Desktop Infrastructure (VDI), Application Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: INPUT process_creation_logs WHERE parent_process IN (office_apps) | APPLY ML_model(features) | RETURN events WHERE classification == 'suspicious'
- question: Are there internal emails being sent with a mismatched 'From' and 'Reply-To' header, or containing links from URL shortening services?
  context: A mismatch between the 'From' and 'Reply-To' headers can be a technique used by adversaries to trick a recipient into replying to an external, attacker-controlled address. Similarly, URL shorteners are often used to obfuscate the final destination of a malicious link. This question helps identify these common phishing lures.
  answer_sources:
  - Zeek smtp.log
  - NAI: Internal Mail Transfer Agents, Network Segments with Email Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH smtp_logs WHERE source_ip IN internal_network AND dest_ip IN internal_network | WHERE from_header_domain != reply_to_header_domain OR body_links IN (url_shortener_list)
- question: Are internal emails being sent with statistically rare or high-risk file attachment types?
  context: Adversaries often use uncommon or dangerous file types (like .iso, .lnk, .vhd) to bypass security controls that focus on more common attachment types. By baselining normal attachment activity, this question helps to surface anomalous emails carrying these potentially malicious payloads.
  answer_sources:
  - Zeek smtp.log
  - Zeek files.log
  - NAI: Internal Mail Transfer Agents, Network Segments with Email Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH smtp_logs AND file_logs | CALCULATE frequency(mime_type) OVER 30d | WHERE current_mime_type_frequency < 1st_percentile AND mime_type IN (high_risk_extensions)
- question: Has an internal email been assigned a high risk score by a machine learning model based on its metadata and sender/recipient relationship?
  context: This question uses a model to aggregate multiple weak signals (header mismatches, URL counts, rare sender-recipient pairs, etc.) into a single, actionable risk score. This allows for the detection of sophisticated phishing attempts that might not trigger any single rule but appear highly suspicious when viewed holistically.
  answer_sources:
  - Zeek smtp.log
  - NAI: Internal Mail Transfer Agents, Network Segments with Email Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: INPUT smtp_logs | APPLY ML_model(features) | RETURN emails WHERE risk_score > threshold
- question: Has a host exhibited a suspicious sequence of events within a short time frame, such as a DNS query to a new domain, followed by a suspicious process spawn, and then a network share access attempt?
  context: Individual events in this sequence might not be alarming, but their occurrence in a specific, rapid succession is highly indicative of a successful phishing attack. This question correlates disparate log sources to reconstruct the attack chain, from initial click to lateral movement.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 4688
  - Windows Event ID 5145
  - NAI: User Endpoints, File Servers, Network Egress Points, DNS Resolvers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: CORRELATE dns_logs, process_logs, file_share_logs ON host | TRIGGER IF dns_query(new_domain) -> process_spawn(office_app, shell) -> file_share_access() WITHIN 5_minutes
- question: Following a potential phishing click, did the user's account attempt to access a network share that is unusual for them?
  context: After compromising an account, adversaries often explore the network, accessing shares they have no legitimate reason to. By baselining normal user behavior, this question can detect this reconnaissance or lateral movement activity, especially when it occurs shortly after other indicators of phishing.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 5145
  - NAI: User Endpoints, File Servers, Network Egress Points, DNS Resolvers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH file_share_logs(user) | BASELINE user_share_access OVER 90d | DETECT deviation FROM baseline WHERE logon_event FOLLOWS connection(low_reputation_domain)
- question: Has a sequence mining model detected a low-probability sequence of user activity matching a known phishing pattern?
  context: This question leverages advanced analytics to learn the 'normal grammar' of user and host activity. It can detect novel or complex attack chains that don't match predefined correlation rules by identifying sequences of events (like email client -> DNS -> process -> network) that are statistically unlikely based on historical data.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 4688
  - Windows Event ID 5145
  - NAI: User Endpoints, File Servers, Network Egress Points, DNS Resolvers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: INPUT aggregated_host_logs | APPLY sequence_model | RETURN events WHERE sequence_probability < threshold AND sequence_matches_phishing_pattern
- question: Has a single internal account sent a mass email with an identical subject line to a large number of internal recipients?
  context: This is a brute-force method for detecting an internal phishing campaign. A compromised account being used to spam other internal users will often exhibit this behavior. The static thresholds provide a simple but effective tripwire for large-scale lateral movement attempts.
  answer_sources:
  - Zeek smtp.log
  - NAI: Internal Mail Transfer Agents, Network Segments with Email Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH smtp_logs | GROUPBY source_ip, subject | COUNT distinct(recipient) AS recipient_count | WHERE recipient_count > 100 WITHIN 1_hour
- question: Has an internal user account suddenly sent a volume of emails or targeted a number of unique recipients that is a statistical anomaly compared to their own baseline?
  context: Unlike a static threshold, this question uses a dynamic baseline tailored to each user. This helps to accurately identify anomalous behavior for any user, whether they normally send ten emails a day or a thousand, reducing false positives from naturally 'chatty' accounts or services.
  answer_sources:
  - Zeek smtp.log
  - NAI: Internal Mail Transfer Agents, Network Segments with Email Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH smtp_logs | BASELINE emails_per_hour, recipients_per_hour FOR each sender OVER 30d | DETECT deviation WHERE current_hour_count > baseline_mean + (3 * baseline_std_dev)
- question: Does clustering analysis reveal a large, dense group of highly similar emails originating from a single sender, which is uncharacteristic for that sender?
  context: This question moves beyond simple volume counts to analyze the content similarity of the emails themselves. A compromised account used for an internal phishing campaign will likely send many messages with very similar, templated subject lines. A clustering algorithm can detect this campaign activity by identifying these dense groups of messages, even if the volume isn't high enough to trigger a standard volumetric alert.
  answer_sources:
  - Zeek smtp.log
  - NAI: Internal Mail Transfer Agents, Network Segments with Email Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: INPUT smtp_logs | VECTORIZE subject_lines | APPLY DBSCAN_clustering GROUPBY sender | RETURN clusters WHERE cluster_size is anomalous FOR sender