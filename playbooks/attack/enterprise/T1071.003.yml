name: T1071.003: Mail Protocols
id: b2a5f6e8-8d4c-4a1f-9b2e-7c6d5a3b4c1d
description: This playbook helps determine if an adversary is using mail protocols (SMTP,
  POP3, IMAP) for command and control (C2) communications. It provides investigative
  steps to detect this activity by looking for several key indicators: connections
  to known malicious C2 infrastructure identified via threat intelligence; email
  content (headers, subject, body) that matches known C2 patterns; periodic, low-jitter
  'beaconing' connections characteristic of automated malware; anomalous data transfer
  volumes that could indicate data exfiltration; mail traffic originating from unapproved
  processes on an endpoint; and high-entropy data in email fields suggesting the
  presence of encoded or encrypted C2 data.
type: technique
related:
- TA0011: Command and Control
contributors:
- Zachary Szewczyk
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
- question: Are mail protocol connections being made to known malicious command and
    control infrastructure?
  context: This question aims to identify direct connections to adversary infrastructure
    by cross-referencing network connection logs with a threat intelligence feed
    of known malicious IPs and domains. A match is a high-fidelity indicator of a
    compromise. The query should focus on mail-related ports (25, 110, 143, 465,
    587, 993, 995) and inspect both destination IPs and domains extracted from mail
    logs.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek smtp.log
  - Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      SEARCH Zeek logs (conn.log, smtp.log)
      WHERE port IN (25, 110, 143, 465, 587, 993, 995)
      JOIN destination_ip, helo_domain WITH CTI_feed
      ON destination_ip = CTI_feed.ip OR helo_domain = CTI_feed.domain
      RETURN alert
- question: Are there any mail server domains being contacted with unusually low frequency,
    suggesting they might be newly established or used by a small set of victims?
  context: Adversaries often use unique or new domains for C2 that are not yet present
    in threat intelligence feeds. This question seeks to uncover these domains by
    identifying statistical rarities. By calculating the frequency of all mail server
eTLD+1s
    (effective top-level domain plus one) across the organization, domains that appear
    very infrequently (e.g., in the bottom 5th percentile) can be flagged for further
    scrutiny as they deviate from common, high-traffic mail providers.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek smtp.log
  - Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      CALCULATE frequency of each eTLD+1 from smtp.log and dns.log over 30 days
      IDENTIFY domains in the lowest 5th percentile of frequency
      RETURN list of rare domains for review
- question: Can a machine learning model identify malicious mail server domains based
    on their characteristics?
  context: This question proposes a proactive, machine-learning-based approach to
    detecting malicious domains that may evade other detection methods. By training
    a classifier (like a Random Forest) on features such as domain age from WHOIS
    data, lexical properties (e.g., entropy, character ratios), and DNS query patterns,
    it's possible to score new domains and automatically flag those that exhibit
    malicious characteristics with a high degree of confidence.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek smtp.log
  - Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      FOR each new mail domain observed in Zeek logs
      EXTRACT features (WHOIS age, lexical analysis, DNS patterns)
      APPLY pre-trained Random Forest model
      IF score > 0.9 THEN generate alert
- question: Do any emails contain headers, subjects, or other fields that match signatures
    of known C2 tools?
  context: Malware often uses specific, recognizable patterns in email fields for
    C2 communication. This question focuses on using regular expressions to hunt
    for these signatures. By applying a ruleset against email metadata fields like
    subject, user-agent, and custom headers, an analyst can detect indicators of
    known malware families, such as long non-dictionary words, Base64-encoded strings,
    or GUIDs, which are not typical of human-generated emails.
  answer_sources:
  - Zeek smtp.log
  - Zeek pop3.log
  - Zeek imap.log
  - Internal Mail Relays
  range: last 90 days
  queries:
  - pseudocode: |
      APPLY regex ruleset (e.g., for Base64, GUIDs)
      TO smtp.log fields (subject, from, user_agent, x_originating_ip)
      IF rule matches THEN generate alert
- question: Are there any outbound emails with an unusually high ratio of non-alphanumeric
    characters in the subject line, suggesting structured data instead of human-written
    text?
  context: C2 channels may encode data within the subject line of an email, which
    results in a different character distribution compared to normal, human-written
    subjects. This question involves establishing a baseline for the ratio of non-alphanumeric
    to total characters in subject lines and then flagging any emails that are statistical
    outliers (e.g., exceeding the 99th percentile). This can effectively uncover
    covert channels that abuse the subject field.
  answer_sources:
  - Zeek smtp.log
  - Zeek pop3.log
  - Zeek imap.log
  - Internal Mail Relays
  range: last 90 days
  queries:
  - pseudocode: |
      FOR each outbound email
      CALCULATE ratio = (non-alphanumeric chars / total chars) in subject
      COMPARE ratio to 30-day baseline distribution
      IF ratio > 99th percentile THEN generate alert
- question: Can topic modeling on email subject lines reveal clusters of machine-generated
    or non-sensical subjects indicative of a C2 channel?
  context: This question uses an unsupervised machine learning approach, Latent Dirichlet
    Allocation (LDA), to discover thematic topics within the corpus of all email
    subject lines. While most topics will correspond to legitimate business communication,
    a C2 channel using subject lines for data transfer may appear as a distinct topic
    that is semantically meaningless or composed of random-looking character collections.
    Reviewing these anomalous topics can reveal covert C2 activity.
  answer_sources:
  - Zeek smtp.log
  - Zeek pop3.log
  - Zeek imap.log
  - Internal Mail Relays
  range: last 90 days
  queries:
  - pseudocode: |
      APPLY LDA model to all email subjects over a 7-day window
      MANUALLY review generated topics
      FLAG topics that appear random or meaningless for investigation
- question: Are there any hosts making mail protocol connections to a single destination
    at highly regular, machine-like intervals?
  context: This question aims to detect C2 'beaconing,' a common behavior where malware
    periodically contacts its control server. Unlike human activity, automated beaconing
    often occurs at fixed intervals with very little variation ('jitter'). This query
    involves analyzing connection logs to find a series of connections from a single
    source to a single destination where the time between each connection is constant,
    within a small tolerance.
  answer_sources:
  - Zeek conn.log
  - Endpoint Devices and Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      FOR each source-destination pair on mail ports
      CALCULATE time delta between consecutive connections
      IF 10+ consecutive deltas are constant (+/- 5s) THEN flag as beaconing
- question: Can we detect C2 beaconing by identifying mail connection groups with
    an extremely low standard deviation in their inter-arrival times?
  context: This is a statistical method for identifying the low-jitter, periodic
    nature of C2 beaconing. By grouping connections by source and destination over
    a 24-hour period and calculating the standard deviation of the time between those
    connections, a very low standard deviation indicates highly regular, automated
    traffic rather than sporadic, human-driven activity. This is a strong signal
    for potential C2 communications.
  answer_sources:
  - Zeek conn.log
  - Endpoint Devices and Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      GROUP connections by source_ip, dest_ip over 24 hours
      CALCULATE stdev of inter-arrival times for each group
      IF stdev < 5 seconds AND connection_count > 10 THEN generate alert
- question: Can time-series analysis on a host's mail connection activity reveal hidden
    periodic patterns indicative of C2?
  context: This question proposes using advanced time-series analysis to find periodic
    signals that might be missed by simple interval checks. By creating a time series
    of a host's connection counts and applying a decomposition model (like STL),
    the activity can be broken down into its trend, seasonal (periodic), and residual
    components. A strong periodic component that doesn't align with known business
    cycles can expose a hidden C2 beacon.
  answer_sources:
  - Zeek conn.log
  - Endpoint Devices and Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      FOR each host, create time series of mail connection counts (1-min bins)
      APPLY STL decomposition model to the time series
      ALERT if a strong, unexplained periodic component is detected
- question: Is there any single mail protocol connection indicating bulk data exfiltration
    through an unusually large data transfer?
  context: This question seeks to find data exfiltration over a mail channel by setting
    a simple, high-watermark threshold for data volume. A single email connection
    transferring an anomalously large amount of data (e.g., >50MB) is highly suspicious,
    as it far exceeds typical email sizes and could represent a large file or database
    being exfiltrated by an adversary. This threshold should be tuned to the specific
    environment to reduce false positives.
  answer_sources:
  - Zeek conn.log
  - Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      SEARCH Zeek conn.log for mail port connections
      IF originator_bytes > 50MB THEN generate alert
- question: Does any host exhibit mail connection data volumes that are anomalous
    compared to its own historical baseline?
  context: Rather than a single global threshold, this question focuses on dynamic,
    host-specific baselining to detect anomalies. By profiling the typical outbound
    data volume (`orig_bytes`) and the client-to-server byte ratio for each host
    over a 30-day period, the system can flag any new connection that significantly
    deviates from that host's established normal behavior (e.g., exceeds the 98th
    percentile). This helps detect exfiltration that might be small overall but is
    large for a specific user.
  answer_sources:
  - Zeek conn.log
  - Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      FOR each host, establish 30-day baseline of orig_bytes and orig/resp ratio
      FOR each new mail connection from that host
      IF orig_bytes > 98th percentile of baseline THEN generate alert
- question: Can an anomaly detection model identify suspicious mail sessions based
    on a combination of network traffic features?
  context: This question leverages an unsupervised machine learning model, Isolation
    Forest, to find outliers in mail protocol traffic. By feeding the model multiple
    features from connection logs (e.g., duration, bytes sent, bytes received, packet
    counts), it can learn the characteristics of normal traffic and identify sessions
    that are statistically anomalous across multiple dimensions. This is powerful
    for detecting novel or complex C2 techniques that don't fit simple rules.
  answer_sources:
  - Zeek conn.log
  - Internet Gateway/Egress Points
  range: last 90 days
  queries:
  - pseudocode: |
      INPUT features (duration, orig_bytes, resp_bytes, orig_pkts) from conn.log
      APPLY pre-trained Isolation Forest model to all mail connections
      ALERT on connections flagged as highly anomalous by the model
- question: Is mail protocol network traffic originating from a process that is not
    an approved email client?
  context: This question aims to detect when a non-standard process, such as a command-line
    shell or a script interpreter, initiates a mail connection. By correlating network
    data with endpoint process creation events, an analyst can check the process
    name against an allowlist of legitimate mail clients (e.g., outlook.exe, thunderbird.exe).
    A connection from a process like `powershell.exe` is a strong indicator of malicious
    activity.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Sysmon Event ID 1
  - Sysmon Event ID 3
  - Endpoint Devices
  range: last 90 days
  queries:
  - pseudocode: |
      CORRELATE network connections on mail ports (from Zeek)
      WITH process creation events (from Sysmon/Event Logs)
      IF process_name is NOT IN (outlook.exe, thunderbird.exe, ...) THEN generate alert
- question: Has a process initiated a mail connection that is rare or has never been
    seen for a particular host?
  context: This question focuses on detecting anomalous process behavior on a per-host
    basis. Even if a process is legitimate, its use to make mail connections might
    be abnormal for a specific machine. By creating a baseline of which processes
    initiate mail connections on each host, the system can alert when a process does
    so for the first time or with a frequency that is a significant statistical outlier
    (e.g., in the bottom 1st percentile of historical frequency).
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Sysmon Event ID 1
  - Sysmon Event ID 3
  - Endpoint Devices
  range: last 90 days
  queries:
  - pseudocode: |
      FOR each host, create baseline of processes making mail connections
      WHEN a process makes a new mail connection
      IF process is new to baseline OR its frequency is in bottom 1% THEN generate alert
- question: Can a machine learning model classify a process as suspicious based on
    how it was created and executed, prior to it making a mail connection?
  context: This is a proactive detection that uses machine learning to score the
    legitimacy of a process itself. By training a model (like Gradient Boosting)
    on features from process creation events (e.g., parent process, command-line
    arguments, integrity level), it's possible to identify suspicious processes.
    When one of these high-risk processes is later observed making a mail connection,
    it can be flagged with high confidence as part of a malicious C2 channel.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Sysmon Event ID 1
  - Sysmon Event ID 3
  - Endpoint Devices
  range: last 90 days
  queries:
  - pseudocode: |
      APPLY pre-trained Gradient Boosting model to all process creation events
      IF process is classified as suspicious AND later makes a mail connection
      THEN generate high-confidence alert
- question: Are there email subjects that appear to be Base64-encoded strings, indicating
    a covert data channel?
  context: This question uses a specific, rule-based approach to find a common C2
    encoding technique. Base64 is often used to ensure data can be transmitted safely
    within text-based protocols like email. A regular expression can be crafted to
    look for subject lines that have characteristics of Base64-encoded data: a long
    string with no spaces, composed exclusively of alphanumeric characters and specific
    symbols (+, /, =). A match is highly indicative of non-human communication.
  answer_sources:
  - Zeek smtp.log
  - Internal Mail Relays
  range: last 90 days
  queries:
  - pseudocode: |
      APPLY regex to smtp.log subject field
      LOOK FOR strings > 50 chars, no spaces, only [A-Za-z0-9+/=]
      IF match THEN generate alert
- question: Are there any emails where the subject or HELO string has an abnormally
    high entropy score compared to a historical baseline?
  context: Shannon entropy measures the randomness or unpredictability of data.
    Normal text (like a subject line) has relatively low entropy, while encrypted
    or compressed data has high entropy. This question involves calculating the entropy
    of email subject and HELO fields, establishing a normal baseline (mean and standard
    deviation) over 30 days, and then flagging any email where these fields have
    an entropy score that is a significant statistical outlier (e.g., 3+ standard
    deviations above the mean).
  answer_sources:
  - Zeek smtp.log
  - Internal Mail Relays
  range: last 90 days
  queries:
  - pseudocode: |
      CALCULATE 30-day rolling average and stdev of entropy for 'subject' and 'helo' fields
      FOR each new email
      IF entropy(subject) > (avg + 3*stdev) THEN generate alert
- question: Can a machine learning classifier distinguish between normal text and
    encoded data within email subject lines?
  context: This question proposes using a supervised learning model, like Logistic
    Regression, to explicitly classify subject lines as either normal or encoded.
    By training the model on a labeled dataset, it can learn the distinguishing characteristics
    (e.g., length, entropy, n-gram frequency) of encoded text. This trained model
    can then be applied to all new emails to proactively identify and alert on subjects
    that are likely being used to transmit C2 data.
  answer_sources:
  - Zeek smtp.log
  - Internal Mail Relays
  range: last 90 days
  queries:
  - pseudocode: |
      FOR each email subject
      EXTRACT features (length, entropy, n-gram frequency)
      APPLY pre-trained Logistic Regression model
      IF model predicts 'encoded' with high probability THEN generate alert