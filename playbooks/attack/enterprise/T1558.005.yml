name: "T1558.005: Ccache Files"
id: "8c6d1a5b-9f8e-4b2a-8c7d-3e4f5a6b7c8d"
description: "This playbook helps identify if an adversary is stealing or misusing Kerberos ccache files to facilitate credential access. Investigations should focus on anomalous logon sessions (Logon Type 9) initiated by rare or known malicious tools, suspicious command-line arguments containing ticket manipulation keywords or high-entropy strings, unusual network transfer or local access of ccache files (`krb5cc_*`), abnormal sequences of commands involving Kerberos and file transfer utilities, and anomalous Kerberos service ticket requests that deviate from established user or network baselines."
type: "technique"
related: 
  - "TA0006: Credential Access"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Is a new logon session (Logon Type 9) being initiated by a known credential theft tool?"
    context: "This question attempts to identify a high-fidelity indicator of credential abuse. Adversary tools like Mimikatz, Rubeus, and Kekeo are often used to inject stolen Kerberos tickets (from ccache files or other means) into memory to create a new logon session as the victim user. This query looks for the direct link between the execution of a known malicious tool (from a watchlist) and the immediate creation of a Logon Type 9 event, which strongly suggests a pass-the-ticket attack is in progress."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Privileged access workstations, member servers, domain controllers, Tier 0 assets"
    range: "last 90 days"
    queries:
      - "search: Find process creation (4688) for tool in watchlist. Correlate process ID with logon event (4624) where logon type is 9."
  - question: "Is a statistically rare process initiating a new logon session (Logon Type 9)?"
    context: "While Logon Type 9 events are common for legitimate tools like `runas.exe`, they are not typically initiated by a wide variety of processes. This question aims to uncover credential abuse by identifying outliers. By establishing a baseline of normal processes that create these logon sessions, analysts can flag any process that falls into a rare percentile (e.g., a script, a custom binary, or an office application) as highly suspicious, as it may indicate an adversary is using a non-standard method to leverage stolen credentials."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Privileged access workstations, member servers, domain controllers, Tier 0 assets"
    range: "last 90 days"
    queries:
      - "search: From logon events (4624) with type 9, find parent process. Compare process frequency against historical baseline. Alert on rare processes."
  - question: "Does a new logon session (Logon Type 9) and its parent process exhibit characteristics of malicious activity based on a trained machine learning model?"
    context: "This question leverages a supervised machine learning model to detect more subtle or novel variations of credential abuse. The model is trained on features from both the process creation event (e.g., command-line entropy, parent process) and the subsequent logon event (e.g., user context, source workstation). By learning the complex patterns of both benign and known-malicious activity, the model can score new events in real-time and alert on those that are classified as suspicious with high confidence, even if they don't match a specific signature or watchlist."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Privileged access workstations, member servers, domain controllers, Tier 0 assets"
    range: "last 90 days"
    queries:
      - "search: Extract features from correlated process creation (4688) and logon (4624) events. Score with ML model. Alert on high suspicion score."
  - question: "Is a process being executed with command-line arguments indicative of Kerberos ticket manipulation or pass-the-ticket attacks?"
    context: "This question focuses on finding direct evidence of credential theft tools being used via their command-line artifacts. Tools like Rubeus and Mimikatz use specific keywords and argument structures (e.g., `ptt /ticket:`, `tgs::ask`, `convert /ccache`) to perform actions on Kerberos tickets. This query uses regular expressions to search for these patterns, as well as for long, base64-encoded strings that are characteristic of embedded tickets, providing a strong signal of malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Linux/macOS systems with command-line logging, Windows systems used for ticket conversion, domain controllers"
    range: "last 90 days"
    queries:
      - "search: Search process creation logs (4688) for command lines matching regex patterns for ticket manipulation (e.g., 'ptt /ticket:', base64 strings)."
  - question: "Is a process being executed with unusually long or high-entropy command-line arguments, suggesting an embedded Kerberos ticket?"
    context: "This question provides a way to detect ticket manipulation when specific tool signatures are unknown or obfuscated. Kerberos tickets, when passed as arguments, are often base64-encoded, resulting in long strings with high Shannon entropy (a measure of randomness). By establishing a baseline for normal command-line entropy across the environment, this query can flag any command whose arguments are a statistical outlier, which is a strong indicator that a ticket or other encoded blob is being passed."
    answer_sources:
      - "Windows Event ID 4688"
      - "Linux/macOS systems with command-line logging, Windows systems used for ticket conversion, domain controllers"
    range: "last 90 days"
    queries:
      - "search: Calculate entropy for command-line arguments in process creation logs (4688). Compare against historical baseline. Alert on high-entropy outliers."
  - question: "Does a command-line execution exhibit anomalous characteristics when compared to a learned baseline of normal activity?"
    context: "This question uses an unsupervised anomaly detection model to identify novel or evasive command-line attacks. Instead of relying on specific signatures, the model learns the normal patterns of command-line usage based on features like length, argument count, character distribution, and entropy. It can then flag any new command that deviates significantly from these learned baselines, making it effective against custom tools or obfuscated versions of known tools."
    answer_sources:
      - "Windows Event ID 4688"
      - "Linux/macOS systems with command-line logging, Windows systems used for ticket conversion, domain controllers"
    range: "last 90 days"
    queries:
      - "search: Extract features from command lines (length, entropy, etc.). Score with unsupervised anomaly detection model. Alert on high anomaly score."
  - question: "Is a file matching Kerberos ccache naming conventions being transferred over the network, particularly to an external destination?"
    context: "This question aims to detect the exfiltration of credential material. Kerberos ccache files (e.g., `krb5cc_` or `krb5.ccache`) contain sensitive ticket-granting tickets and should almost never be transferred over the network, especially to an external IP address. This query monitors network file transfer logs (e.g., from Zeek) for these specific filenames and generates a high-severity alert if such a transfer is observed, as it is a strong sign of credential theft."
    answer_sources:
      - "Zeek files.log"
      - "Zeek conn.log"
      - "Zeek ftp.log"
      - "Zeek smb_files.log"
      - "File servers hosting Linux user home directories, network egress points, Linux developer workstations"
    range: "last 90 days"
    queries:
      - "search: Monitor network file transfer logs (Zeek) for filenames matching 'krb5cc_*' or 'krb5.ccache'. Alert if destination is external or not on allowlist."
  - question: "Is a statistically rare process accessing Kerberos ccache files, or is a normal process accessing an unusually high number of them?"
    context: "This question detects credential harvesting on a host by baselining file access patterns. Legitimate access to ccache files is typically limited to a small set of system processes (e.g., `sshd`). This query identifies anomalous behavior by flagging access from any process that is statistically rare (like `powershell.exe` or a script) or by alerting when a legitimate process accesses a volume of ccache files that is significantly above its normal behavior, which could indicate a sweeping or harvesting action."
    answer_sources:
      - "Windows Event ID 4663"
      - "File servers hosting Linux user home directories, network egress points, Linux developer workstations"
    range: "last 90 days"
    queries:
      - "search: From file access logs (4663) for ccache files, baseline accessing processes. Alert on rare processes or unusually high access counts per process."
  - question: "Does the relationship between a user, a process, a ccache file, and a network destination represent an improbable or anomalous path?"
    context: "This question uses graph-based analysis to uncover complex attack chains that might appear benign in isolated events. It models relationships between entities (users, processes, files, IPs) to identify highly improbable sequences of actions. For example, a web service account running a process that accesses a domain administrator's ccache file and then makes a connection to an external IP represents an anomalous path that would be flagged, indicating a potential multi-stage credential theft and exfiltration attack."
    answer_sources:
      - "Windows Event ID 4663"
      - "Zeek files.log"
      - "Zeek conn.log"
      - "File servers hosting Linux user home directories, network egress points, Linux developer workstations"
    range: "last 90 days"
    queries:
      - "search: Model user, process, file, and network events in a graph. Use graph algorithms to find and alert on anomalous paths involving ccache files."
  - question: "Has a user or system executed a sequence of commands indicative of locating, packaging, and exfiltrating Kerberos tickets?"
    context: "This question looks for a logical chain of adversary actions related to credential theft. The query defines a stateful rule that triggers if a specific sequence of events occurs in a short time window on a single host: (1) listing tickets with `klist`, (2) accessing the ccache file, (3) compressing or encoding the file, and (4) making an outbound network connection. Detecting this full sequence provides strong, contextual evidence of an active attempt to steal and exfiltrate Kerberos credentials."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Zeek conn.log"
      - "User workstations, bastion hosts, servers with interactive logins"
    range: "last 90 days"
    queries:
      - "search: Detect sequence: klist execution (4688), then ccache file access (4663), then compress/encode command (4688), then outbound network connection (Zeek)."
  - question: "Has a user executed a statistically improbable sequence of commands involving Kerberos utilities?"
    context: "This question focuses on detecting behavioral anomalies in command-line activity. Using N-gram analysis, it models the typical sequences of commands for each user. An alert is generated when a user executes a command sequence that has a very low probability based on their historical behavior. A sequence like `klist` followed by `powershell -enc` would be highly unusual for most users and would be flagged as a deviation indicative of credential harvesting and preparation for exfiltration."
    answer_sources:
      - "Windows Event ID 4688"
      - "User workstations, bastion hosts, servers with interactive logins"
    range: "last 90 days"
    queries:
      - "search: Model user command sequences using N-grams from process logs (4688). Alert on sequences with very low probability based on historical data."
  - question: "Does a sequence of user or system events (process, file, network) have a high reconstruction error when processed by a sequence-based anomaly detection model?"
    context: "This question uses a sophisticated deep learning model (like an LSTM autoencoder) to learn the normal 'rhythm' of activity for a user or host, including process executions, file accesses, and network connections. The model can then identify anomalous sequences that deviate from this learned norm. An event sequence with a high reconstruction error—meaning the model finds it highly unpredictable—such as `klist` being run by an unusual parent process followed by an outbound connection, would be flagged as a significant anomaly."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Zeek conn.log"
      - "User workstations, bastion hosts, servers with interactive logins"
    range: "last 90 days"
    queries:
      - "search: Feed sequences of user/host events into a trained LSTM autoencoder. Alert on sequences with high reconstruction error."
  - question: "Is a Kerberos Ticket-Granting Ticket (TGT) for the krbtgt service being requested from a machine that is not a Domain Controller?"
    context: "This question is designed to detect a Golden Ticket attack, a powerful persistence mechanism often enabled by credentials stolen via ccache files or other means. A service ticket request for the `krbtgt` principal should only originate from a Domain Controller. Any request for this service from a non-DC client address is a very high-fidelity indicator that an adversary has forged a TGT to gain unrestricted access to the domain."
    answer_sources:
      - "Windows Event ID 4769"
      - "Zeek kerberos.log"
      - "Domain controllers, critical application servers, network choke points"
    range: "last 90 days"
    queries:
      - "search: Monitor Kerberos ticket requests (4769). Alert if Service Name is 'krbtgt' and Client Address is not a Domain Controller."
  - question: "Is a user authenticating from an unusual location, to an unusual service, or at an unusual time, based on their historical profile?"
    context: "This question aims to detect the malicious use of a stolen Kerberos ticket (pass-the-ticket) by identifying behavioral anomalies. It works by building a historical profile for each user, mapping their typical source IP subnets, accessed services (SPNs), and logon times. Any new authentication that deviates significantly from this established baseline—such as logging in from a new country or accessing a critical server for the first time—is flagged as suspicious, as it may indicate an attacker is impersonating that user."
    answer_sources:
      - "Zeek kerberos.log"
      - "Windows Event ID 4769"
      - "Windows Event ID 4624"
      - "Domain controllers, critical application servers, network choke points"
    range: "last 90 days"
    queries:
      - "search: Profile user authentication behavior (source IP, service, time) from logs (4769). Score new authentications against the profile. Alert on high deviation."
  - question: "Does a Kerberos authentication event fall outside of normal activity clusters for the enterprise?"
    context: "This question uses unsupervised clustering to find anomalous logons without pre-built profiles. The algorithm groups all authentication events based on features like user, source IP, and destination service, identifying dense clusters that represent normal 'peer group' activity. Any event that does not fit into a cluster is classified as a noise point or outlier. These outliers are strong candidates for investigation, as they represent activity that is abnormal compared to all other observed behaviors, such as the first instance of a pass-the-ticket attack."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4769"
      - "Domain controllers, critical application servers, network choke points"
    range: "last 90 days"
    queries:
      - "search: Cluster authentication events (4624/4769) based on user, source, destination, and time. Alert on events that do not belong to any cluster (noise points)."