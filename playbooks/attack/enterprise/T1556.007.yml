name: T1556.007: Hybrid Identity
id: 5a73e911-c7d6-4e8b-8a1c-0f9b6d4c2a3b
description: This playbook focuses on detecting adversaries manipulating hybrid identity
  environments, such as Active Directory Federation Services (AD FS) or Azure AD
  Connect with Pass-through Authentication (PTA), to achieve persistence, evade defenses,
  and access credentials. It provides investigative questions to identify malicious
  DLLs loaded into identity service processes, unauthorized modifications to critical
  configuration files, MFA bypass techniques, credential dumping attempts, and anomalous
  network connections originating from identity infrastructure servers.
type: technique
related:
- TA0003: Persistence
- TA0005: Defense Evasion
- TA0006: Credential Access
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a known-malicious DLL been loaded by the AD FS or PTA service process?
  context: Adversaries may load a malicious DLL, such as an authentication backdoor
    like MagicWeb, into the AD FS (Microsoft.IdentityServer.Servicehost.exe) or PTA
    (AzureADConnectAuthenticationAgentService.exe) service processes. This allows
    them to manipulate the authentication process. This question checks the file hash
    of all loaded DLLs against a threat intelligence feed of known malware to identify
    such backdoors.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 7
  - AD FS Servers, Azure AD Connect Servers (PTA), SIEM Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Sysmon (EventID=7) WHERE Image IN ('Microsoft.IdentityServer.Servicehost.exe',
      'AzureADConnectAuthenticationAgentService.exe') | LOOKUP ImageLoaded.Hash against
      ThreatIntelFeed | ALERT on match
- question: Has an unusually rare or previously unseen DLL been loaded by AD FS or
    PTA services?
  context: Legitimate DLLs loaded by AD FS and PTA services are typically consistent.
    An adversary introducing a new malicious DLL will appear as a rare or novel event.
    This question establishes a baseline of normally loaded DLLs and alerts on outliers,
    which could indicate a newly introduced backdoor.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 7
  - AD FS Servers, Azure AD Connect Servers (PTA), SIEM Platform
  range: last 30 days
  queries:
  - technology: pseudocode
    query: SEARCH Sysmon (EventID=7) WHERE Image IN ('...Servicehost.exe', '...AgentService.exe')
      over last 30 days | BASELINE count(ImageLoaded) | ALERT if current ImageLoaded
      count is in bottom 1st percentile
- question: Does a DLL loaded by AD FS or PTA services have characteristics of malware
    based on a machine learning model?
  context: Malicious DLLs often have distinct features compared to benign ones, such
    as high entropy, invalid signatures, or unusual import tables. This question
    uses a machine learning model to score each newly loaded DLL based on these features,
    providing a probabilistic method to detect sophisticated or unknown backdoors.
  answer_sources:
  - Sysmon Event ID 7
  - AD FS Servers, Azure AD Connect Servers (PTA), SIEM Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Sysmon (EventID=7) WHERE Image IN ('...Servicehost.exe', '...AgentService.exe')
      | EXTRACT features (entropy, signature, imphash) | SCORE with ML_Model | ALERT
      on high malicious_probability_score
- question: Have the AD FS or PTA services loaded a DLL that is unsigned, has an
    invalid signature, or is located in a non-standard directory?
  context: Adversaries often place malicious DLLs in unusual locations (e.g., C:\ProgramData\,
    C:\Users\Public\) to evade detection. These DLLs are also frequently unsigned
    or have invalid digital signatures. This question looks for these classic indicators
    of malicious code being loaded by critical identity processes.
  answer_sources:
  - Sysmon Event ID 7
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Sysmon (EventID=7) WHERE Image IN ('...Servicehost.exe', '...AgentService.exe')
      AND (Signed=false OR SignatureStatus!=Valid OR ImageLoaded.Path NOT IN (StandardPathWhitelist))
      | ALERT
- question: Was a DLL loaded by AD FS or PTA from a directory path with unusually
    high entropy?
  context: To obfuscate their tools, attackers may use long, randomized directory
    names. This results in a file path with high mathematical entropy. This question
    analyzes the entropy of the directory path for each loaded DLL to identify potential
    obfuscation attempts.
  answer_sources:
  - Sysmon Event ID 7
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Sysmon (EventID=7) WHERE Image IN ('...Servicehost.exe', '...AgentService.exe')
      | CALCULATE entropy(ImageLoaded.Directory) | ALERT if entropy > 98th percentile
      of baseline
- question: Has a DLL loaded by AD FS or PTA been identified as an outlier by a clustering
    model?
  context: Normal DLL loading activity for a given service creates predictable patterns
    based on file path, signer, and parent process. This question uses an unsupervised
    clustering model to define these normal patterns and flag any loaded DLL that
    does not fit into a cluster, indicating it is an anomalous outlier worthy of investigation.
  answer_sources:
  - Sysmon Event ID 7
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Sysmon (EventID=7) WHERE Image IN ('...Servicehost.exe', '...AgentService.exe')
      | CLUSTER on features (path, signer) | ALERT on noise_points/outliers
- question: Has an unauthorized user or process modified a critical AD FS/PTA configuration
    file or registry key?
  context: To establish persistence, an adversary might modify configuration files
    (e.g., Microsoft.IdentityServer.Servicehost.exe.config) or registry keys to alter
    how the service operates or to load malicious components. This question monitors
    for any write or modification access to these critical assets by accounts other
    than whitelisted administrators or the SYSTEM account, especially outside of maintenance
    windows.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Sysmon Event ID 11
  - Sysmon Event ID 13
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH File/Registry Auditing (EventID IN (4663, 4657, 11, 13)) WHERE
      TargetObject IN (CriticalConfigList) AND User NOT IN (AdminWhitelist) | ALERT
- question: Has there been an anomalous spike in modification events for AD FS/PTA
    configuration files or registry keys?
  context: While some modifications are normal, a sudden burst of changes, especially
    outside of business hours or change windows, can indicate malicious activity.
    This question establishes a baseline for the normal rate of modifications and
    alerts when the current rate significantly exceeds the historical average.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Sysmon Event ID 11
  - Sysmon Event ID 13
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH File/Registry Auditing over 1 hour | COUNT events WHERE TargetObject
      IN (CriticalConfigList) | ALERT if count > (baseline_mean + 3*baseline_std_dev)
- question: Does the volume of AD FS/PTA configuration changes significantly deviate
    from the forecasted volume?
  context: The volume of configuration changes can be modeled and predicted over
    time. A sophisticated adversary might perform slow, subtle changes. This question
    uses a time-series model to predict the expected number of change events and alerts
    when the actual number deviates significantly from the forecast, potentially catching
    low-and-slow attacks.
  answer_sources:
  - Sysmon Event ID 11
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Sysmon (EventID=11) WHERE TargetFilename IN (CriticalConfigList) |
      FORECAST event_volume with ARIMA model | ALERT if observed_volume is outside
      confidence_interval
- question: Has a new service or scheduled task been created on an AD FS/PTA server
    that executes from a suspicious location or with encoded arguments?
  context: A common persistence method is to create a new service or scheduled task.
    This question looks for indicators of malicious tasks, such as those running from
    temporary/user-writable directories or using encoded PowerShell commands to hide
    their true purpose.
  answer_sources:
  - Windows Event ID 4698
  - Windows Event ID 7045
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Service/Task Creation (EventID IN (7045, 4698)) WHERE (ImagePath
      IN (SuspiciousPaths) OR CommandLine CONTAINS ('-enc', '-encodedcommand')) |
      ALERT
- question: Has a new service or scheduled task been created on an AD FS/PTA server
    with a high-entropy (randomized) name?
  context: To avoid detection based on common malware names, adversaries may use
    randomly generated names for their malicious services or tasks. This results
    in a name with high character entropy. This question calculates the entropy of
    new service/task names to identify this obfuscation technique.
  answer_sources:
  - Windows Event ID 4698
  - Windows Event ID 7045
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Service/Task Creation (EventID IN (7045, 4698)) | CALCULATE entropy(ServiceName)
      | ALERT if entropy > 99th percentile of baseline
- question: Does a newly created service or scheduled task on an AD FS/PTA server
    appear malicious based on a classification model?
  context: Legitimate services and tasks have predictable characteristics (e.g., run
    from System32, run as SYSTEM). This question uses a machine learning model to
    score new services/tasks based on features like executable path, argument complexity,
    and user context to distinguish them from potentially malicious persistence mechanisms.
  answer_sources:
  - Windows Event ID 4698
  - Windows Event ID 7045
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Service/Task Creation (EventID IN (7045, 4698)) | EXTRACT features
      (path, args, user) | SCORE with ML_Model | ALERT on high malicious_score
- question: Have any commands associated with defense evasion been executed on an
    AD FS or PTA server?
  context: Before or during an attack, adversaries often try to disable security
    controls. This question searches for the execution of commands used to clear
    event logs (wevtutil.exe cl), disable security tools (Set-MpPreference), or manipulate
    firewall rules (netsh advfirewall) on critical identity servers.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Process Creation (EventID IN (4688, 1)) | FILTER CommandLine MATCHES
      ('wevtutil cl', 'netsh advfirewall', 'Set-MpPreference -Disable') | ALERT
- question: Has an administrator on an AD FS/PTA server executed an unusually rare
    command for their account?
  context: Each administrator typically has a routine set of commands they use. An
    attacker who has compromised an admin account may execute commands that are unusual
    for that specific user's normal behavior. This question baselines each admin's
    command-line activity and alerts on rare command executions that deviate from
    their profile.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Process Creation by User | BASELINE command frequency per user |
      ALERT if command frequency for user is in bottom 5th percentile
- question: Has an improbable sequence of commands been executed on an AD FS/PTA server?
  context: Normal administrative tasks often follow a predictable sequence of commands.
    An attacker's actions may appear as a statistically unlikely or illogical sequence.
    This question uses a sequence analysis model to learn normal command flows and
    alerts when an observed sequence has a very low probability of occurring.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Process Creation events | MODEL command sequences with HMM | ALERT
      on low-probability sequences
- question: Has a user who requires MFA successfully authenticated via AD FS without
    a corresponding MFA success event?
  context: A primary goal of attacking AD FS is to bypass Multi-Factor Authentication
    (MFA). This question directly checks for this condition by correlating successful
    token issuance events (AD FS Event ID 501) with MFA success events (AD FS Event
    ID 1200) for the same user. A successful login without a recent MFA event for
    an MFA-enabled user is a critical indicator of a bypass.
  answer_sources:
  - AD FS Event ID 1200
  - AD FS Event ID 501
  - AD FS Servers, Security Information and Event Management (SIEM) Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: ON AD FS EventID 501 for MFA_User | SEARCH for AD FS EventID 1200 for same
      user in last 5 mins | IF not found, ALERT
- question: Has the ratio of successful logins to successful MFA events for a user
    dropped significantly below their baseline?
  context: For any user required to use MFA, the number of successful logins should
    be very close to the number of successful MFA completions. This question establishes
    a baseline of this ratio for each user and alerts if the ratio suddenly drops,
    indicating that logins are succeeding without the expected MFA challenges.
  answer_sources:
  - AD FS Event ID 1200
  - AD FS Event ID 501
  - AD FS Servers, Security Information and Event Management (SIEM) Platform
  range: last 30 days
  queries:
  - technology: pseudocode
    query: CALCULATE ratio(EventID 501 / EventID 1200) per user over last 30 days
      for baseline | ALERT if current ratio drops >50% below baseline
- question: Has an AD FS authentication flow for an MFA-enabled user violated the
    expected sequence of events?
  context: A legitimate MFA login follows a strict sequence of events (e.g., credential
    submission, MFA challenge, MFA success, token issuance). An MFA bypass would
    break this sequence. This question models the valid authentication flow and alerts
    on any sequence of events that deviates from the learned legitimate state transitions.
  answer_sources:
  - AD FS Event ID 1200
  - AD FS Event ID 501
  - AD FS Servers, Security Information and Event Management (SIEM) Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: MODEL AD FS event sequences as state machine | ALERT on any sequence that
      violates state transition rules (e.g., CredentialPOST -> Token-Issued for MFA
      user)
- question: Has a successful authentication occurred from a prohibited country or
    an anonymizing proxy?
  context: Attackers often route their traffic through geographically disparate locations
    or use proxies to hide their origin. This is a fundamental check to identify
    successful logins originating from IP addresses known to be malicious, associated
    with anonymizing services, or located in countries from which no legitimate user
    should be connecting.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - AD FS Event ID 501
  - AD FS Servers, Network Gateway, SIEM Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Successful Logins | ENRICH SourceIP with GeoIP and ThreatIntel |
      ALERT if SourceIP.Country IN (ProhibitedList) or SourceIP.isProxy=true
- question: Has there been a statistical spike in successful authentications from
    a single country?
  context: A password spray attack or a successful credential compromise can lead
    to a sudden, anomalous increase in successful logins from a specific country
    or region. This question baselines the normal volume of authentications per country
    and alerts when a significant statistical deviation occurs, indicating a potential
    large-scale attack.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - AD FS Event ID 501
  - AD FS Servers, Network Gateway, SIEM Platform
  range: last 30 days
  queries:
  - technology: pseudocode
    query: COUNT successful logins by SourceIP.Country per hour | ALERT if count >
      (baseline_mean + 4*baseline_std_dev) for that country
- question: Do key authentication metrics show a collective deviation from their
    normal, correlated patterns?
  context: Metrics like successful logins, failed logins, and MFA events are often
    correlated. For example, a rise in successful logins should be accompanied by
    a rise in MFA successes. This question uses a multivariate model to detect when
    the relationship between these metrics breaks down, which could indicate an attack
    like an MFA bypass where successful logins spike without a corresponding rise
    in MFA events.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - AD FS Event ID 501
  - AD FS Servers, Network Gateway, SIEM Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: MODEL timeseries(success_logins, failed_logins, mfa_success) with multivariate
      model | ALERT on anomalous time windows
- question: Has an AD FS or PTA server connected to a known malicious domain or IP
    address?
  context: If an identity server is compromised, the attacker may use it for command
    and control (C2) or data exfiltration. This question checks all outbound network
    connections from AD FS/PTA servers against a threat intelligence feed of known
    malicious infrastructure to detect C2 activity.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - AD FS Servers, Azure AD Connect Servers (PTA), Network Egress Points, DNS Resolvers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH DNS/Network logs WHERE SourceIP IN (ADFS_PTA_Servers) | LOOKUP Destination
      against ThreatIntelFeed | ALERT on match
- question: Has an AD FS or PTA server connected to a newly registered domain?
  context: Adversaries frequently use newly registered domains (NRDs) for their C2
    infrastructure, as these domains are less likely to be on reputation lists. This
    question identifies any connection from a critical identity server to a domain
    registered within the last week, which is a strong indicator of malicious activity.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - AD FS Servers, Azure AD Connect Servers (PTA), Network Egress Points, DNS Resolvers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH DNS logs WHERE SourceIP IN (ADFS_PTA_Servers) | ENRICH Query with
      WHOIS data | ALERT if Domain.RegistrationDate < 7 days ago
- question: Has an AD FS or PTA server attempted to resolve a domain name that appears
    to be generated by an algorithm (DGA)?
  context: Advanced malware often uses Domain Generation Algorithms (DGAs) to create
    a large, unpredictable set of C2 domains. This question applies a machine learning
    model to analyze the linguistic properties of DNS queries from identity servers
    to detect and block connections to DGA-based C2 infrastructure.
  answer_sources:
  - Zeek dns.log
  - AD FS Servers, Azure AD Connect Servers (PTA), Network Egress Points, DNS Resolvers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM DNS logs WHERE SourceIP IN (ADFS_PTA_Servers) | SCORE Query with DGA_Model
      | ALERT on high DGA_probability_score
- question: Have the AD FS or PTA service processes spawned any child processes, especially
    those related to credential dumping?
  context: The core AD FS (Microsoft.IdentityServer.Servicehost.exe) and PTA (AzureADConnectAuthenticationAgentService.exe)
    processes should not be spawning child processes during normal operation. Any
    child process is highly suspicious, and a child process associated with credential
    dumping (e.g., procdump, mimikatz) is a critical indicator of an active attack.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Process Creation WHERE ParentImage IN ('...Servicehost.exe', '...AgentService.exe')
      | ALERT on any result
- question: Have the AD FS or PTA services spawned any child processes at all?
  context: This is a more direct version of the previous question. In a properly
    hardened environment, the baseline of child processes for these services is zero.
    This question formalizes that assumption, where any child process spawned from
    these parents is a severe anomaly and requires immediate investigation.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Process Creation WHERE ParentImage IN ('...Servicehost.exe', '...AgentService.exe')
      | ALERT on any result
- question: If a child process is spawned by AD FS/PTA, do its command-line arguments
    appear anomalous or undefined by normal system activity?
  context: In the unlikely event a legitimate child process is spawned, its command-line
    arguments should fall into predictable patterns. This question uses topic modeling
    to define what 'normal' command-line activity looks like across the environment.
    If a child process from an identity service uses arguments that don't fit any
    known topic, it is flagged as highly suspicious.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Process Creation WHERE ParentImage IN ('...Servicehost.exe', '...AgentService.exe')
      | ANALYZE CommandLine with topic model | ALERT if topic is rare/undefined
- question: Has an unauthorized process attempted to read the memory of the AD FS
    or PTA service processes?
  context: Adversaries dump credentials by reading the memory of processes that handle
    them, like AD FS and PTA services. This question monitors for process memory access
    events (Sysmon Event ID 10) and alerts when any process not on a strict whitelist
    (e.g., legitimate monitoring tools) attempts to read the memory of these critical
    identity services.
  answer_sources:
  - Sysmon Event ID 10
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Sysmon (EventID=10) WHERE TargetImage IN ('...Servicehost.exe',
      '...AgentService.exe') AND GrantedAccess includes 'PROCESS_VM_READ' AND SourceImage
      NOT IN (Whitelist) | ALERT
- question: Has a rare or previously unseen process accessed the memory of the AD
    FS/PTA services?
  context: Even if some tools are whitelisted to access memory, their usage should
    be predictable. This question establishes a baseline of which processes access
    the memory of identity services and how often. It then alerts on any access from
    a new process or one that accesses memory with extreme rarity, indicating a potential
    misuse of a legitimate tool.
  answer_sources:
  - Sysmon Event ID 10
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 30 days
  queries:
  - technology: pseudocode
    query: SEARCH Sysmon (EventID=10) WHERE TargetImage IN ('...Servicehost.exe',
      '...AgentService.exe') | BASELINE count by SourceImage | ALERT if SourceImage
      is new or count is in bottom 1st percentile
- question: Has a memory access event targeting AD FS/PTA services been flagged as
    an outlier by a machine learning model?
  context: This question uses an anomaly detection model (like an Isolation Forest)
    trained exclusively on legitimate memory access events. The model learns the
    complex patterns of normal behavior. Any new access event that the model flags
    as a significant outlier is likely an attempt by an adversary to dump credentials.
  answer_sources:
  - Sysmon Event ID 10
  - AD FS Servers, Azure AD Connect Servers (PTA)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FROM Sysmon (EventID=10) WHERE TargetImage IN ('...Servicehost.exe', '...AgentService.exe')
      | SCORE event with IsolationForest model | ALERT on outlier events
- question: Was a large outbound data transfer from an AD FS/PTA server observed
    shortly after a burst of successful user authentications?
  context: This is a classic smash-and-grab scenario where an attacker compromises
    credentials, authenticates as multiple users to access data, and then exfiltrates
    it. This question looks for a temporal correlation between a high volume of successful
    logins and a subsequent large outbound data transfer from the same identity server.
  answer_sources:
  - Zeek conn.log
  - AD FS Event ID 501
  - Windows Event ID 4624
  - AD FS Servers, Azure AD Connect Servers (PTA), Network Egress Points, SIEM Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: TRIGGER on >20 successful logins in 5 mins from ServerX | SEARCH for outbound
      connection >5MB from ServerX in next 5 mins | IF found, ALERT
- question: Is there a new, strong statistical correlation between the number of unique
    user authentications and the volume of outbound data from an AD FS/PTA server?
  context: Normally, the number of users logging in shouldn't be directly correlated
    with the amount of data leaving an identity server. This question calculates the
    Pearson correlation between these two metrics over time. A sudden spike in positive
    correlation suggests that as more users authenticate, data is being exfiltrated,
    a strong sign of credential harvesting.
  answer_sources:
  - Zeek conn.log
  - AD FS Event ID 501
  - Windows Event ID 4624
  - AD FS Servers, Azure AD Connect Servers (PTA), Network Egress Points, SIEM Platform
  range: last 30 days
  queries:
  - technology: pseudocode
    query: CALCULATE correlation(unique_users, outbound_bytes) in 5-min windows |
      ALERT if correlation > 0.8 and historically low
- question: Does the volume of successful authentications now statistically predict
    the volume of outbound data, where it did not before?
  context: This question uses a more advanced statistical test (Granger causality)
    to determine if a new causal relationship has emerged between authentications
    and data egress. If the model finds that login events are now a statistically
    significant predictor of outbound data transfers, it implies a new, suspicious
    link between these activities that warrants investigation.
  answer_sources:
  - Zeek conn.log
  - AD FS Event ID 501
  - Windows Event ID 4624
  - AD FS Servers, Azure AD Connect Servers (PTA), Network Egress Points, SIEM Platform
  range: last 90 days
  queries:
  - technology: pseudocode
    query: TEST if timeseries(successful_logins) Granger-causes timeseries(outbound_bytes)
      | ALERT if p-value < 0.05 and this relationship is new