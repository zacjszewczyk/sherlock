name: T1016.001: Internet Connection Discovery
id: 2d8d85e8-5867-4638-a73c-36427357c98f
description: This playbook helps identify if an adversary is performing host or network discovery activities to check for Internet connectivity. It focuses on detecting outbound connections to known malicious destinations, unusual usage of network utilities (like ping, curl, Test-NetConnection), connections from hosts that shouldn't have internet access, a high diversity of protocols used by a single host in a short time, and patterns of DNS queries to many unique domains (high entropy). These activities are often performed by processes not associated with normal user activity or from critical assets with restricted network policies.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags:
  - none
questions:
  - question: Is a host making outbound connections or DNS queries to destinations known to be malicious based on threat intelligence feeds?
    context: This question is crucial for identifying direct communication with known adversary infrastructure. An alert triggered by this rule indicates a high-confidence signal that a host may be compromised or is attempting to contact a command-and-control (C2) server, a malware distribution point, or other malicious endpoints. Early detection of such connections is vital for rapid incident response.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network Egress Points (e.g., Firewalls, Web Proxies)
      - DNS Resolvers
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH (Zeek_conn_log OR Zeek_dns_log) WHERE destination_ip IN threat_intel_feed OR destination_domain IN threat_intel_feed
  - question: For a connection to a known malicious destination, how rare is this destination across the enterprise, and should the alert be escalated?
    context: This question helps prioritize alerts by adding a layer of context based on historical data. A connection to a malicious destination that has never been seen before in the environment is significantly more suspicious than one that might be part of a widespread, low-severity campaign. By identifying rare and potentially unique connections, analysts can focus on the most critical threats first.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network Egress Points (e.g., Firewalls, Web Proxies)
      - DNS Resolvers
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each threat_intel_match: COUNT occurrences of destination_ip/domain in last 30 days. IF count < 99th percentile of all external destinations, THEN escalate_priority.
  - question: Can machine learning be used to score the likelihood that a connection is malicious, and should an automated response be triggered?
    context: This question explores the use of advanced analytics to automate the detection and response process. By feeding rich connection metadata into a machine learning model, it's possible to identify malicious activity that might not match a specific signature but exhibits suspicious characteristics. A high-confidence score from the model can justify automated actions like host isolation, significantly reducing the time-to-containment for a threat.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network Egress Points (e.g., Firewalls, Web Proxies)
      - DNS Resolvers
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT connection_metadata (src_ip, dst_ip, port, protocol, ja3, process_info) INTO ML_Model. IF ML_Model.score > 0.9, THEN trigger_automated_response(host).
  - question: Are common network discovery utilities (ping, tracert, curl, nslookup) or PowerShell cmdlets (Test-NetConnection) being executed by unusual parent processes?
    context: Adversaries often use legitimate system utilities, a technique known as Living Off the Land (LotL), to perform discovery without introducing new tools. While users and administrators use these tools, they are typically launched from interactive shells like cmd.exe or explorer.exe. When these utilities are spawned by non-interactive or unexpected processes (e.g., a web server process, a scheduled task), it is a strong indicator of malicious automation or a remote shell.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint devices (Workstations, Laptops)
      - Servers (especially those with restricted internet access like Domain Controllers)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH (WinEventID:4688 AND ProcessName IN ('ping.exe', 'tracert.exe', 'curl.exe', 'nslookup.exe')) OR (WinEventID:4104 AND ScriptBlock CONTAINS 'Test-NetConnection') WHERE ParentProcessName NOT IN ('explorer.exe', 'cmd.exe', 'powershell.exe')
  - question: Is a host exhibiting an anomalously high frequency of network utility executions compared to its own baseline?
    context: This question focuses on detecting behavioral anomalies on a per-host basis. A sudden spike in the use of network discovery tools on a single machine, or their use by an account for the first time, can signal that an adversary is actively mapping the network or testing for connectivity from a newly compromised host. This approach is effective for catching activity that might otherwise be lost in the noise of a large enterprise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint devices (Workstations, Laptops)
      - Servers (especially those with restricted internet access like Domain Controllers)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host: CALCULATE baseline of network_utility_executions over 30 days. ALERT if count in 1-hour window > 95th percentile of baseline.
  - question: Can a time-series model detect statistically significant spikes in network utility usage that indicate an automated discovery script?
    context: This question applies a more sophisticated statistical method to find anomalies. Simple thresholding can be noisy, but a time-series model can account for normal cyclical patterns (e.g., daily or weekly scripts). A sharp deviation from the model's forecast, especially when correlated with other suspicious events like a new service being created, provides a high-confidence signal that the activity is not part of a normal administrative routine and is likely malicious.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Endpoint devices (Workstations, Laptops)
      - Servers (especially those with restricted internet access like Domain Controllers)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT host_utility_execution_frequency INTO time_series_model. ALERT if actual_frequency significantly deviates from model_forecast.
  - question: Is a single host using multiple different network protocols to connect to external destinations in a short time frame, excluding normal web browsing?
    context: This question aims to identify automated discovery scripts that probe for open ports or test different egress paths. A legitimate application, like a web browser, might use a couple of protocols (e.g., TCP/80, TCP/443, UDP/53), but a rapid sequence involving protocols like ICMP, raw TCP, and DNS from a non-browser process is highly suspicious and indicative of a tool scanning for connectivity options.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Network Egress Points
      - Endpoint devices
      - DNS Resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek_conn_log GROUP BY src_ip, 2min_window. ALERT if distinct_protocol_count >= 3 AND process_info NOT IN ('browser.exe', 'updater.exe')
  - question: Is a host exhibiting an anomalously high diversity of network protocols in its outbound connections compared to its historical behavior?
    context: Similar to baselining utility usage, this question applies behavioral analysis to network traffic. Most hosts have a relatively stable pattern of protocol usage. A sudden increase in the variety of protocols used by a single host can indicate that a new, potentially malicious tool is running and performing network reconnaissance. This method can catch novel or obfuscated tools that don't rely on common utility names.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Network Egress Points
      - Endpoint devices
      - DNS Resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host: CALCULATE protocol_diversity_score over 5-min windows. ALERT if score > 99th percentile of host's historical scores.
  - question: Can unsupervised machine learning identify dense clusters of network activity from a single host that show high protocol diversity?
    context: This question proposes using clustering algorithms to find "bursts" of suspicious activity without pre-defined rules. An algorithm like DBSCAN can automatically group together connection events that are close in time and share a source host. If a resulting cluster contains a wide variety of protocols, it represents a statistically significant anomaly—a burst of diverse reconnaissance—that warrants investigation.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Network Egress Points
      - Endpoint devices
      - DNS Resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT connection_events (host, protocol, port, time) INTO DBSCAN_model. ALERT on clusters with high protocol diversity from a single host.
  - question: Is a host from a restricted network segment or a process running as a service account making an unauthorized outbound connection?
    context: This is a high-fidelity detection based on policy violation. Critical assets like Domain Controllers or servers in a PCI-DSS environment should have strictly controlled and monitored internet access. Any connection from these assets or from a service account (which should not be used for interactive tasks) to a destination not on a pre-approved allow list is a serious security event and a strong indicator of compromise or misconfiguration.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Critical Server Subnets (e.g., Domain Controllers, Database Servers)
      - Network Egress Points
      - Authentication Logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek_conn_log WHERE (src_ip IN restricted_asset_list OR user_account IN service_account_list) AND destination_ip NOT IN allow_list.
  - question: Is an unusual or rare process on a critical server initiating an outbound network connection?
    context: This question adds behavioral profiling to policy enforcement. For a given server role (e.g., database server), there is a small, predictable set of processes that should be making network connections. If a process like powershell.exe or a randomly named executable suddenly makes an outbound connection from a database server, it deviates sharply from the established baseline and is a strong signal of malicious activity, such as a reverse shell or data exfiltration tool.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Critical Server Subnets (e.g., Domain Controllers, Database Servers)
      - Network Egress Points
      - Authentication Logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each critical_server: PROFILE normal_outbound_processes. ALERT if outbound_connection initiated by process NOT in normal profile.
  - question: Can a one-class machine learning model be used to detect any anomalous network connection from a critical server?
    context: This question proposes creating a tight "envelope" of normal behavior for critical assets using machine learning. A one-class SVM is trained only on data representing normal activity (e.g., connections to patch servers, domain controllers). Any new connection that falls outside this learned boundary is, by definition, an anomaly. This is a powerful technique for detecting novel attack methods on high-value assets where any deviation from the norm is unacceptable.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Critical Server Subnets (e.g., Domain Controllers, Database Servers)
      - Network Egress Points
      - Authentication Logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN one-class_SVM_model on normal_network_behavior of critical_servers. PREDICT on new_connections. ALERT if prediction is 'anomaly'.
  - question: Is a host performing DNS queries for a large number of unique and previously unseen domains with very little follow-on traffic?
    context: This question targets a specific adversary technique known as "domain fluxing" or the use of Domain Generation Algorithms (DGAs) for C2 communication. Malware may generate hundreds or thousands of domain names, testing them until it finds one that is active. This results in a pattern of many unique DNS lookups, often for domains never seen before, with minimal or no data transferred, which is highly uncharacteristic of normal user browsing.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek_dns_log GROUP BY host, 24hr_window. ALERT if unique_domain_count > 50 AND domains are new/uncategorized AND traffic_volume is low.
  - question: Which hosts exhibit the highest 'randomness' (Shannon entropy) in the domain names they are querying?
    context: This question provides a mathematical way to quantify the suspiciousness of DNS query patterns. Legitimate web browsing has a relatively low entropy because users visit a limited set of common domains. DGA-generated domains, however, are often random-looking strings, leading to a high entropy score for the set of domains queried by a compromised host. Identifying hosts with the highest entropy is an effective hunting technique for finding C2 communications.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host: CALCULATE daily Shannon_entropy of queried_domains. ALERT on top 1% of hosts by entropy_score (after filtering CDNs).
  - question: Is a host suddenly contacting a significantly larger number of unique destination IP addresses than predicted by its historical behavior?
    context: This question looks for a sudden "fan-out" of network connections, which can be another indicator of automated discovery or C2 activity. A time-series model learns a host's normal pattern of destination diversity. A sudden, sharp increase in the number of unique IPs a host connects to, far exceeding the model's forecast, indicates a fundamental change in the host's behavior that warrants a hunt-focused investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host: FORECAST daily_unique_dest_ip_count using time_series_model. ALERT if actual_count significantly exceeds forecast.