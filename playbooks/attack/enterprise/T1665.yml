name: T1665: Hide Infrastructure
id: f9a5b3c2-d1e0-4f6a-8b7c-9e3d4f2a1b0c
description: This playbook helps to answer the question, "Is the adversary using hidden infrastructure for Command and Control?". It provides investigative methods to detect adversary C2 infrastructure hiding techniques, including matching network events against threat intelligence for known C2 redirectors, malicious proxies, or abused infrastructure; identifying suspicious SSL/TLS sessions using self-signed or free certificates to non-whitelisted cloud ASNs with rare JA3/JA3S fingerprints; detecting suspicious DNS characteristics like dynamic DNS, high entropy subdomains, or large non-standard record responses; identifying domain fronting via SNI/Host header mismatches or suspicious redirection patterns; finding periodic C2 beaconing traffic with constant intervals and low data volumes; and detecting fast-flux DNS where a domain resolves to a rapidly changing set of diverse IPs with low TTLs.
type: technique
related:
- TA0011: Command And Control
contributors:
- Zachary Szewczyk
- Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
- question: Are any outbound network connections, DNS queries, or TLS handshakes matching known C2 infrastructure indicators from threat intelligence feeds?
  context: This question aims to identify direct, known-bad activity by cross-referencing all outbound network traffic (IPs, domains, certificate hashes) with threat intelligence feeds. A match provides a high-confidence signal that an internal host is communicating with adversary-controlled infrastructure, such as C2 redirectors or malicious proxies.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Windows Event ID 3
  - Network egress points (e.g., perimeter firewalls, web proxies)
  - enterprise DNS resolvers
  - network sensor tap points.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH network_logs, dns_logs, ssl_logs WHERE destination_ip OR destination_domain OR certificate_hash IN threat_intel_feed_of_c2_indicators
- question: Are there any non-corporate Autonomous Systems (ASNs) receiving an anomalously high number of connections from internal hosts, particularly to IPs associated with proxy or VPN services?
  context: This question seeks to uncover potential C2 channels hiding behind legitimate services. Adversaries often use multiple hosts within a single hosting or VPN provider's network. By identifying ASNs that receive connections from an unusually large number of distinct internal clients and are predominantly composed of proxy/VPN IPs, we can find potential C2 aggregators that would be missed by simple IOC matching.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Windows Event ID 3
  - Network egress points (e.g., perimeter firewalls, web proxies)
  - enterprise DNS resolvers
  - network sensor tap points.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH network_logs | GROUP BY destination_asn | CALCULATE distinct_source_hosts, proportion_of_proxy_ips | FILTER distinct_source_hosts > 95th_percentile AND proportion_of_proxy_ips > 0.5
- question: Can we classify network connections as 'suspicious C2' using a machine learning model based on features like threat intelligence matches, connection properties, and IP/SSL reputation?
  context: This question leverages machine learning to build a predictive model that can identify suspicious C2 communications based on a combination of factors. Unlike simple rules, a classifier can learn complex patterns from features like connection duration, data volume, destination port, SSL certificate attributes, and IP reputation to score connections, allowing analysts to focus on the highest-probability C2 traffic.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek ssl.log
  - Windows Event ID 3
  - Network egress points (e.g., perimeter firewalls, web proxies)
  - enterprise DNS resolvers
  - network sensor tap points.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: APPLY classification_model ON network_connection_data | FILTER prediction == 'suspicious C2' AND confidence_score > threshold
- question: Are there any SSL/TLS sessions using free or self-signed certificates to non-whitelisted cloud ASNs that also use a JA3/JA3S hash matching a known malicious signature?
  context: This question combines multiple suspicious indicators to create a high-fidelity alert. Adversaries often use free or self-signed certificates for C2 infrastructure hosted in public clouds to minimize cost and effort. By correlating this with a JA3/JA3S hash (a fingerprint of the client's TLS negotiation) that matches a known malware family, we can pinpoint specific C2 communications with high confidence.
  answer_sources:
  - Zeek ssl.log
  - Zeek conn.log
  - Network security monitoring sensors with SSL/TLS visibility (e.g., Zeek)
  - network egress points with access to connection metadata.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH ssl_logs WHERE (is_self_signed OR issuer_is_free) AND destination_asn IN non_whitelisted_cloud AND ja3_hash IN known_c2_fingerprints
- question: Among SSL/TLS sessions using free/self-signed certificates to non-whitelisted cloud ASNs, are any using a JA3/JA3S client fingerprint that is statistically rare within the enterprise?
  context: This question helps to identify custom or non-standard client applications used for C2, which often have unique TLS implementations. By focusing on sessions that already meet suspicious criteria (free/self-signed certs to cloud IPs) and then identifying those with rare JA3/JA3S fingerprints, we can uncover novel or uncommon malware that wouldn't be caught by known signature-based detections.
  answer_sources:
  - Zeek ssl.log
  - Zeek conn.log
  - Network security monitoring sensors with SSL/TLS visibility (e.g., Zeek)
  - network egress points with access to connection metadata.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH ssl_logs WHERE (is_self_signed OR issuer_is_free) AND destination_asn IN non_whitelisted_cloud | CALCULATE frequency of ja3_hash | FILTER ja3_hash_frequency < 5th_percentile
- question: Can an anomaly detection model identify highly abnormal SSL/TLS sessions that may indicate C2 activity, based on features like certificate properties, destination ASN, and JA3/JA3S rarity?
  context: This question uses an unsupervised machine learning approach to find outliers without relying on predefined rules or signatures. By feeding an anomaly detection model features like certificate validity, destination details, and the statistical rarity of the client fingerprint, the model can score every session for its 'abnormality'. This allows analysts to investigate the most unusual sessions that deviate from the established baseline of normal traffic.
  answer_sources:
  - Zeek ssl.log
  - Zeek conn.log
  - Network security monitoring sensors with SSL/TLS visibility (e.g., Zeek)
  - network egress points with access to connection metadata.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: APPLY anomaly_detection_model ON ssl_session_data | SORT by anomaly_score descending | INVESTIGATE top results
- question: Are any internal hosts making DNS queries to known dynamic DNS providers?
  context: This question aims to detect the use of dynamic DNS (DDNS) services, which are frequently abused by adversaries to host C2 infrastructure due to their ease of use and ability to quickly change IP addresses. Matching queries against a list of known DDNS providers is a simple but effective way to identify potential C2 communications that should be correlated with endpoint process activity.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 4688
  - Windows DNS Client Analytic Logs
  - Enterprise DNS resolvers
  - endpoint devices (for process context)
  - DNS forwarders to external resolvers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH dns_logs WHERE domain IN known_ddns_provider_list | CORRELATE source_host with process_creation_logs
- question: Are there any DNS queries with unusually high subdomain entropy or abnormally large TXT record responses?
  context: This question targets two common DNS-based C2 techniques. High subdomain entropy often indicates the use of a Domain Generation Algorithm (DGA) to create pseudo-random C2 domains. Abnormally large TXT record responses can be a sign of DNS tunneling, where C2 data is exfiltrated or received within DNS query responses. Both are strong statistical indicators of malicious activity.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 4688
  - Windows DNS Client Analytic Logs
  - Enterprise DNS resolvers
  - endpoint devices (for process context)
  - DNS forwarders to external resolvers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH dns_logs | CALCULATE subdomain_entropy, txt_response_size | FILTER subdomain_entropy > 98th_percentile OR (query_type == 'TXT' AND txt_response_size > 3_std_dev_from_mean)
- question: Are any hosts generating a volume of DNS queries that significantly exceeds their forecasted baseline, potentially indicating DNS tunneling?
  context: This question uses time series analysis to detect anomalies in the rate of DNS activity from a specific host. A sudden, unexplained spike in DNS query volume can be a symptom of DNS tunneling, where malware generates a high frequency of queries to exfiltrate data. Correlating these volume spikes with other indicators like high entropy or large responses strengthens the case for C2 activity.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 4688
  - Windows DNS Client Analytic Logs
  - Enterprise DNS resolvers
  - endpoint devices (for process context)
  - DNS forwarders to external resolvers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FOR EACH source_host, FORECAST dns_query_volume | ALERT if actual_volume >> forecasted_volume
- question: Are there any decrypted web sessions where the HTTP Host header does not match the TLS Server Name Indication (SNI), indicating potential domain fronting?
  context: This question provides a definitive way to detect domain fronting, a technique where adversaries hide their true destination by making it appear as if traffic is going to a high-reputation domain (e.g., a CDN). In a decrypted environment, a mismatch between the outer-layer SNI and the inner-layer HTTP Host header is a clear signal of this evasion technique.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek http.log
  - Zeek ssl.log
  - Decrypting web proxies
  - network TAPs placed between users and the internet
  - network security monitoring sensors.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: JOIN http_logs, ssl_logs ON session_id | FILTER http_host != ssl_sni
- question: Are any hosts exhibiting an anomalous pattern of connecting to a high-reputation CDN and then immediately connecting to a suspicious, low-reputation destination?
  context: This question attempts to detect C2 redirectors without requiring traffic decryption. Adversaries may use a legitimate, high-reputation service as a first-hop redirector to their actual C2 server. By analyzing connection sequences, we can identify hosts that have a statistically unusual probability of 'transitioning' from a known-good CDN to a suspicious destination (e.g., long-lived, low-volume connection to a non-corporate IP), which is a strong indicator of this technique.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek http.log
  - Zeek ssl.log
  - Decrypting web proxies
  - network TAPs placed between users and the internet
  - network security monitoring sensors.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FOR EACH host, ANALYZE connection_sequences | CALCULATE probability of (connection to CDN -> connection to suspicious_ip) | FILTER probability > 3_std_dev_from_mean
- question: Can a sequence analysis model (e.g., LSTM) detect anomalous network session patterns, such as a connection to a trusted CDN followed by a connection to a rare, non-categorized IP?
  context: This question applies a more advanced machine learning technique to learn what 'normal' user browsing sequences look like. A sequence model like an LSTM can understand the temporal relationship between connections. It can then flag entire sequences as anomalous, such as the specific pattern of a user connecting to a trusted domain and then immediately pivoting to a rare, previously unseen IP address, which is highly indicative of a C2 redirector.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek http.log
  - Zeek ssl.log
  - Decrypting web proxies
  - network TAPs placed between users and the internet
  - network security monitoring sensors.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: APPLY sequence_model ON session_metadata_sequences | FILTER sequence_is_anomalous
- question: Are any internal hosts connecting to external IPs explicitly categorized as TOR exit nodes, malicious proxies, or known C2 providers?
  context: This question focuses on identifying connections to infrastructure known to be used for anonymization or malicious purposes. While some use of TOR or proxies may be legitimate, any connection to an IP explicitly flagged by threat intelligence as a malicious proxy or C2 server is a high-confidence indicator of compromise and requires immediate investigation.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4688
  - Windows Event ID 3
  - Network egress points (e.g., firewalls)
  - network sensor tap points
  - endpoint devices for process and command-line context.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH network_logs WHERE destination_ip_reputation IN ['TOR Exit Node', 'Malicious Proxy', 'C2']
- question: Are there any communication patterns between an internal host and an external destination characterized by highly regular time intervals and low data volumes, indicative of C2 beaconing?
  context: This question aims to detect the 'heartbeat' of malware. C2 beaconing is automated and therefore often occurs at very regular intervals (e.g., every 5 minutes), resulting in a low standard deviation of inter-arrival times. These check-in connections also typically involve small amounts of data. Identifying traffic flows with both of these statistical properties is a classic and effective method for finding C2 channels.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4688
  - Windows Event ID 3
  - Network egress points (e.g., firewalls)
  - network sensor tap points
  - endpoint devices for process and command-line context.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FOR EACH source_dest_pair, CALCULATE stdev(inter_arrival_time), mean(bytes_sent) | FILTER stdev(inter_arrival_time) < 1.0 AND mean(bytes_sent) < 1024
- question: Can a clustering algorithm group network connections and identify distinct clusters that exhibit C2-like characteristics (e.g., low data volume, long duration, regular intervals)?
  context: This question uses unsupervised learning to find groups of suspicious activity without prior labeling. By clustering connections based on features like data volume, duration, and timing regularity, a DBSCAN algorithm can automatically separate normal web browsing from other types of traffic. Analysts can then investigate these smaller, distinct clusters that exhibit the typical properties of C2 beaconing or interactive sessions.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4688
  - Windows Event ID 3
  - Network egress points (e.g., firewalls)
  - network sensor tap points
  - endpoint devices for process and command-line context.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: APPLY DBSCAN_model ON connection_metadata | INVESTIGATE anomalous_clusters | CORRELATE hosts in cluster with process_logs
- question: Are any internal hosts attempting to resolve domains known to be part of fast-flux C2 networks?
  context: This question seeks to identify C2 activity by matching against known indicators. Fast-flux is a DNS technique used to hide C2 servers behind a constantly changing array of compromised hosts. Threat intelligence providers actively track and publish lists of domains using this technique. Matching DNS queries against these lists provides a high-confidence alert for C2 communication attempts.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Enterprise DNS resolvers
  - DNS forwarders
  - network security monitoring sensors capturing DNS traffic.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH dns_logs WHERE query_domain IN known_fast_flux_domain_feed
- question: Are any domains exhibiting statistical properties of fast-flux DNS, such as a high number of unique IPs and ASNs combined with a low average TTL?
  context: This question aims to proactively identify potential fast-flux networks without relying on a known-bad list. By creating a 'flux score' that mathematically combines the key characteristics of this technique—many unique IPs, diverse network locations (ASNs), and low TTL values to force frequent re-queries—we can statistically identify and flag domains that are behaving like fast-flux networks, even if they have not yet been added to an intelligence feed.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Enterprise DNS resolvers
  - DNS forwarders
  - network security monitoring sensors capturing DNS traffic.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: FOR EACH domain, CALCULATE flux_score = (unique_ips * unique_asns) / (avg_ttl + 1) | FILTER flux_score > 99th_percentile
- question: Can a machine learning classifier distinguish between benign domains, legitimate CDNs, and malicious fast-flux domains based on DNS response characteristics?
  context: This question addresses the challenge that legitimate Content Delivery Networks (CDNs) can share some characteristics with fast-flux networks. A supervised machine learning model, like a Random Forest, can be trained to learn the subtle differences. By using features like the number of IPs/ASNs, TTL values, and domain name entropy, the model can make a more nuanced classification, reducing false positives from CDNs and more accurately identifying malicious fast-flux domains.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Enterprise DNS resolvers
  - DNS forwarders
  - network security monitoring sensors capturing DNS traffic.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: APPLY classification_model ON domain_dns_features | FILTER prediction == 'fast-flux'