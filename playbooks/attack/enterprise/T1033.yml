name: T1033: System Owner-User Discovery
id: 5792d477-98a9-4b2a-9e19-58352668383a
description: This playbook helps investigate if an adversary is actively trying to discover system owners or users on the network. This can be identified by observing the execution of known user discovery tools, the use of built-in commands like 'whoami' from unusual parent processes, a rapid series of discovery commands followed by suspicious network egress, unauthorized connections to network device management interfaces, or large-scale Active Directory user/group object queries from a single host.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a process being executed that is associated with a known user discovery tool or malware based on its file hash?
    context: This question aims to identify malicious activity by comparing the file hashes of newly executed processes against threat intelligence feeds. A match indicates the presence of a known malicious utility like Seatbelt or BloodHound, which are commonly used by adversaries for reconnaissance, and requires immediate investigation.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Endpoint Devices (Workstations, Servers)
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FOR each new process event, GET file_hash. IF file_hash IN known_discovery_tool_hashes, THEN ALERT.
  - question: Is an unsigned executable with low prevalence across the enterprise being executed?
    context: This question helps uncover potentially malicious or unauthorized software that isn't widespread. By focusing on executables that are not digitally signed by a trusted publisher and are found on a very small percentage of endpoints (e.g., less than 1%), analysts can identify custom malware or reconnaissance tools that adversaries try to hide by avoiding common detection signatures.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Endpoint Devices (Workstations, Servers)
      - Centralized Log Repository (SIEM)
    range: last 30 days
    queries:
      - query_type: pseudocode
        query: FOR each process event, GET file_hash and is_signed. IF is_signed is FALSE AND prevalence(file_hash) < 1%, THEN FLAG for investigation.
  - question: Has a machine learning model classified a newly observed executable as a malicious discovery tool?
    context: This question leverages a machine learning model to proactively identify malicious executables based on their intrinsic features, such as file entropy or specific strings ('whoami', 'net user'). This approach can detect novel or obfuscated threats that might evade signature-based methods, allowing for the triage of high-confidence classifications for immediate response.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Endpoint Devices (Workstations, Servers)
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FOR each new executable, EXTRACT features. PREDICT classification using ML_model. IF classification is 'malicious' with high_confidence, THEN TRIAGE for incident response.
  - question: Is a user discovery command being spawned by an unusual parent process like an Office application or web browser?
    context: Adversaries often use legitimate processes to mask their activities. This question checks for user discovery commands (e.g., 'whoami.exe') being initiated by non-standard parent processes like 'winword.exe' or 'chrome.exe'. Such behavior is highly indicative of a compromised process being used to perform reconnaissance.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Endpoint Devices (Workstations, Servers)
      - Domain Controllers
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: SEARCH for process_name IN ('whoami.exe', 'query.exe user') WHERE parent_process_name IN ('winword.exe', 'excel.exe', 'chrome.exe', 'services.exe').
  - question: Has a user on a specific host executed an anomalous number of discovery commands compared to their baseline?
    context: This question aims to detect unusual user behavior by establishing a normal baseline of discovery command usage for each user-host pair. An alert is triggered when a user's activity significantly deviates from this baseline, such as executing an abnormally high number of these commands in a short period, which could signal automated scripting or manual enumeration by an attacker.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Endpoint Devices (Workstations, Servers)
      - Domain Controllers
      - Centralized Log Repository (SIEM)
    range: last 30 days
    queries:
      - query_type: pseudocode
        query: FOR each user_host_pair, CALCULATE baseline of discovery_command_frequency. IF current_count in 1_hour > 99th_percentile(baseline), THEN ALERT.
  - question: Does a user's command sequence, involving a discovery command, deviate from normal learned patterns?
    context: This question uses a sequence analysis model to understand the typical order of commands for different user roles. It flags command sequences that have a low probability of occurring, such as a user discovery command being executed immediately after opening a document or downloading a file. This can indicate that a user's session has been hijacked or that a malicious script is running.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Endpoint Devices (Workstations, Servers)
      - Domain Controllers
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FOR each user_session, ANALYZE command_sequence. IF probability(sequence) < threshold, THEN FLAG as anomalous.
  - question: Has a host executed multiple unique discovery commands in a short window, immediately followed by a network connection to a suspicious external address?
    context: This question looks for a classic attack pattern: gather information and then exfiltrate it. It correlates endpoint activity (multiple discovery commands) with network activity (an outbound connection to a low-reputation IP or non-standard port). A positive match strongly suggests an adversary is collecting user data and sending it to a command-and-control server.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Zeek conn.log
      - Endpoint Devices (Workstations, Servers)
      - Network Egress Points
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: IF count(unique_discovery_commands) on host > 3 in 5_minutes AND followed_by outbound_connection to low_reputation_IP in 1_minute, THEN ALERT.
  - question: Is a host exhibiting both an anomalously high number of discovery commands and unusually diverse outbound port activity?
    context: This question combines two statistical anomalies to increase detection confidence. It flags hosts that not only execute an unusually high number of discovery commands (high Z-score) but also connect to an unusually wide range of destination ports (high entropy). This combination can indicate reconnaissance followed by network scanning or C2 communication over various ports.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Zeek conn.log
      - Endpoint Devices (Workstations, Servers)
      - Network Egress Points
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FOR each host, CALCULATE Z_score(discovery_command_count) and entropy(destination_ports). IF Z_score > 3 AND entropy is anomalous, THEN ALERT.
  - question: Does a time-series anomaly detection model show a significant spike in discovery commands across the enterprise, and do hosts contributing to that spike also show suspicious outbound network activity?
    context: This question provides an enterprise-wide view to detect coordinated or widespread discovery activity. A time-series model identifies significant spikes in the overall volume of discovery commands. Analysts can then drill down into these specific time windows to identify the contributing hosts and enrich this data with their network connections to find the source of the potentially malicious campaign.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Zeek conn.log
      - Endpoint Devices (Workstations, Servers)
      - Network Egress Points
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: APPLY time_series_model to enterprise_discovery_command_count. IF anomaly_spike detected, IDENTIFY contributing_hosts and CHECK for suspicious_outbound_connections.
  - question: Has a connection been made to a network device's management interface (SSH/Telnet) from an IP address not on the authorized allow-list?
    context: This question enforces a strict access control policy for critical network infrastructure. By maintaining an explicit list of authorized administrative sources, any connection attempt from an unlisted source is immediately flagged as a high-severity security violation, indicating a potential brute-force attack or an attempt by an intruder to move laterally.
    answer_sources:
      - Zeek conn.log
      - Zeek ssh.log
      - Network Device Syslog
      - Network Infrastructure (Switches, Routers, Firewalls)
      - Management Network Segment
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FOR each connection to network_device on port 22 or 23, IF source_ip NOT IN admin_allow_list, THEN CRITICAL_ALERT.
  - question: Has an authenticated SSH session to a network device exhibited an unusually short duration and low data transfer volume?
    context: This question aims to identify automated, scripted interactions with network devices, which are characteristic of adversary actions. Legitimate administrative sessions typically have a longer duration and more data transfer. Sessions that are extremely short and involve minimal data are likely a script logging in, running a single command (like user discovery), and logging out, which warrants investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek ssh.log
      - Network Device Syslog
      - Network Infrastructure (Switches, Routers, Firewalls)
      - Management Network Segment
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FOR each authenticated_ssh_session, IF duration < 5th_percentile AND bytes_transferred < 5th_percentile, THEN FLAG for investigation.
  - question: Has a clustering algorithm identified an SSH session to a network device as an outlier compared to normal administrative activity?
    context: This question uses unsupervised machine learning to define 'normal' for SSH sessions based on multiple features (source IP, duration, etc.). Any session that does not fit into the established clusters of normal activity is flagged as an outlier. This can detect novel or subtle attack patterns that might not be caught by simple statistical thresholds.
    answer_sources:
      - Zeek conn.log
      - Zeek ssh.log
      - Network Device Syslog
      - Network Infrastructure (Switches, Routers, Firewalls)
      - Management Network Segment
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: CLUSTER ssh_sessions based on features. IF new_session is outlier OR in sparse_cluster, THEN FLAG as anomalous.
  - question: Has a host or user account generated a high volume of Active Directory object queries in a short time?
    context: This question sets a hard threshold to detect potential Active Directory reconnaissance. Activities like running 'net user /domain' from a non-DC or a single account generating over 100 object access events (Event ID 4662) on a Domain Controller within a minute are highly indicative of tools like BloodHound or AdFind being used to map out the domain structure.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Security Event ID 4662
      - Zeek conn.log
      - Zeek ldap.log
      - Zeek dce_rpc.log
      - Domain Controllers
      - Member Servers
      - Centralized Log Repository (SIEM)
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: ALERT IF (host is not DC AND process is 'net.exe' with '/domain' argument) OR (user generates > 100 EventID 4662 for user/group objects in 1 minute).
  - question: Has a source IP queried a number of unique AD objects that is statistically anomalous compared to the network average?
    context: This question uses a statistical approach to detect LDAP-based reconnaissance. By tracking the number of unique AD objects queried by each IP address and comparing it to a moving average for the entire network, it can identify outliers. A source IP querying a number of objects that is several standard deviations above the norm is a strong indicator of enumeration activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Security Event ID 4662
      - Zeek conn.log
      - Zeek ldap.log
      - Zeek dce_rpc.log
      - Domain Controllers
      - Member Servers
      - Centralized Log Repository (SIEM)
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FOR each source_ip, COUNT unique_ldap_queries in 10_min_window. CALCULATE moving_average and std_dev for all IPs. IF source_ip_count > (moving_average + 4 * std_dev), THEN ALERT.
  - question: Is a user's Active Directory query behavior significantly different from that of their peers?
    context: This question uses peer group analysis to detect anomalous AD query behavior that might indicate a compromised account or an insider threat. Users are grouped by their roles, and a baseline of normal query behavior is established for each group. An alert is triggered if a user's activity (e.g., volume of queries, types of objects queried) deviates significantly from their peer group's norm.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Security Event ID 4662
      - Zeek conn.log
      - Zeek ldap.log
      - Zeek dce_rpc.log
      - Domain Controllers
      - Member Servers
      - Centralized Log Repository (SIEM)
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: CLUSTER users into peer_groups. MODEL normal LDAP_query_behavior for each group. IF user_behavior deviates from peer_group_baseline, THEN FLAG for investigation.