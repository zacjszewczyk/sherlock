name: T1033: System Owner-User Discovery
id: e5d5a6e7-1b2c-4d5e-8f9a-0b1c2d3e4f5a
description: |
  This playbook helps determine if an adversary is conducting active user discovery on the network. It focuses on identifying the execution of known discovery utilities via file hashes, the use of built-in commands from anomalous parent processes, rapid sequences of discovery commands followed by network exfiltration, unauthorized connections to network device management interfaces, and large-scale enumeration of Active Directory user or group objects.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are known user discovery tools or malware being executed, identified by their file hashes?
    context: |
      This question aims to detect the use of specific, pre-identified malicious or suspicious tools like Seatbelt or BloodHound. By matching file hashes from newly executed processes against a threat intelligence feed, we can quickly identify known threats with high confidence, enabling a rapid response.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Endpoint Devices (Workstations, Servers)
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "SEARCH process_creation_events | COMPARE file_hash against threat_intelligence_feed_of_discovery_tool_hashes | ALERT on_match"
  - question: Are rare, unsigned executables being run across the enterprise, suggesting potential custom or uncommon discovery tools?
    context: |
      This question focuses on identifying potentially malicious executables that are not widely distributed or digitally signed. A low prevalence rate (e.g., seen on less than 1% of endpoints) for an unsigned application can indicate a custom tool or a newly introduced piece of malware used for discovery, warranting further investigation.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Endpoint Devices (Workstations, Servers)
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "SEARCH process_creation_events over last_30_days | CALCULATE prevalence_of each_file_hash | FILTER for unsigned_executables | ALERT if prevalence < 1%"
  - question: Can we proactively classify newly observed executables as malicious discovery tools using machine learning models?
    context: |
      This question leverages machine learning to analyze intrinsic file characteristics (like entropy, imported functions, and embedded strings) to predict if an executable is malicious. This approach can detect novel or obfuscated discovery tools that might evade hash or signature-based detection methods.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Endpoint Devices (Workstations, Servers)
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "FOR each new_executable | EXTRACT file_features (entropy, imports, strings) | APPLY pre-trained_classifier_model | ALERT if classified_as_malicious with_high_confidence"
  - question: Are built-in user discovery commands (e.g., whoami, query user) being spawned by unusual parent processes like Office applications or web browsers?
    context: |
      Legitimate user discovery commands are typically run from command shells or administrative scripts. When they are launched by processes like Microsoft Word or Google Chrome, it is a strong indicator of compromise, often resulting from a malicious macro or a browser exploit. This question helps detect such anomalous process relationships.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Endpoint Devices (Workstations, Servers)
      - Domain Controllers
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "SEARCH process_creation_events for discovery_commands (whoami.exe, query.exe) | CHECK parent_process_name | ALERT if parent_is (winword.exe, excel.exe, chrome.exe, services.exe)"
  - question: Is a user executing an unusually high number of discovery commands on a specific host compared to their normal behavior?
    context: |
      This question establishes a behavioral baseline for each user on each host to detect abnormal spikes in activity. An adversary who has compromised an account may run numerous discovery commands in a short period to orient themselves. Alerting on deviations from the norm (e.g., exceeding the 99th percentile) helps identify this reconnaissance behavior.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Endpoint Devices (Workstations, Servers)
      - Domain Controllers
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "FOR each user_host_pair, BASELINE discovery_command_frequency over 30_days | MONITOR hourly_command_count | ALERT if hourly_count > 99th_percentile_of_baseline"
  - question: Are discovery commands appearing in abnormal sequences of command-line activity for a given user role?
    context: |
      This question uses machine learning to understand the typical workflow and command sequences for different user roles. A discovery command executed immediately after a non-administrative task, like opening a document, breaks the normal pattern and has a low probability in a trained sequence model. This helps detect adversaries misusing compromised accounts.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Endpoint Devices (Workstations, Servers)
      - Domain Controllers
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "TRAIN sequence_analysis_model on normal_command_histories per_user_role | FOR new_command_sequences | CALCULATE transitional_probability | ALERT if sequence_has_low_probability (e.g., document_open -> whoami)"
  - question: Is a host executing multiple different discovery commands in a short time frame, followed immediately by a suspicious outbound network connection?
    context: |
      This question correlates endpoint and network activity to detect a common attack pattern: gather information, then exfiltrate it or connect to a command-and-control server. The combination of rapid discovery and a subsequent connection to a low-reputation IP or a non-standard port is a high-fidelity indicator of malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Zeek conn.log
      - Endpoint Devices (Workstations, Servers)
      - Network Egress Points
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "CORRELATE events where (host executes >=3 unique_discovery_commands within 5_minutes) AND (host initiates outbound_connection within 1_minute_after) TO (low_reputation_IP OR non_standard_port) | ALERT on_correlation"
  - question: Is a host showing a statistically significant increase in discovery command executions combined with anomalous outbound network port activity?
    context: |
      This question uses statistical measures to find anomalies. A high Z-score for command counts indicates a significant deviation from the host's normal behavior. Simultaneously, high entropy in destination ports suggests scanning or the use of random ports for C2, which is also abnormal. Combining these two statistical anomalies provides a stronger signal.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Zeek conn.log
      - Endpoint Devices (Workstations, Servers)
      - Network Egress Points
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "FOR each host, CALCULATE daily_Z-score of discovery_command_count vs 90-day_history | CALCULATE entropy of outbound_destination_ports | ALERT if Z-score > 3 AND port_entropy is_anomalously_high"
  - question: Are enterprise-wide spikes in discovery command activity correlated with hosts making suspicious outbound connections?
    context: |
      This question applies time-series anomaly detection at a macro level to find coordinated or widespread discovery activity. By identifying significant spikes in the total number of discovery commands across the entire network, we can pinpoint moments of interest. Enriching these moments with network data helps identify the specific hosts responsible for the spike and their subsequent suspicious network behavior.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows PowerShell Event ID 4104
      - Zeek conn.log
      - Endpoint Devices (Workstations, Servers)
      - Network Egress Points
      - Centralized Log Repository (SIEM)
    range: last 90 days
    queries:
      - pseudocode: "APPLY time-series_anomaly_detection on enterprise_wide_discovery_command_count_per_minute | ON anomaly_spike, IDENTIFY contributing_hosts | CHECK if contributing_hosts made_suspicious_outbound_connections | ALERT on_match"
  - question: Are connections to network device management interfaces (SSH, Telnet) originating from unauthorized IP addresses?
    context: |
      Access to critical network infrastructure should be strictly controlled. This question enforces a zero-trust policy by checking every management connection against a pre-defined allow-list of administrative workstations. Any connection from an IP not on this list is a critical security violation and requires immediate investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek ssh.log
      - Network Device Syslog
      - Network Infrastructure (Switches, Routers, Firewalls)
      - Management Network Segment
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - pseudocode: "MONITOR connections to network_devices on ports 22, 23 | CHECK source_IP against allow-list_of_admin_hosts | ALERT if source_IP is not_on_list"
  - question: Are there SSH sessions to network devices that are unusually short and involve minimal data transfer, suggesting automated scripts?
    context: |
      Human administrators typically have longer, more interactive sessions. Automated scripts, however, often log in, run a single command, and log out very quickly. This question profiles normal session characteristics (duration, data transferred) and flags sessions that are statistical outliers (e.g., bottom 5th percentile), which are indicative of scripted, and potentially malicious, access.
    answer_sources:
      - Zeek conn.log
      - Zeek ssh.log
      - Network Device Syslog
      - Network Infrastructure (Switches, Routers, Firewalls)
      - Management Network Segment
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - pseudocode: "PROFILE SSH session_duration and bytes_transferred to network_devices | FLAG sessions in bottom_5th_percentile for both_metrics (e.g., duration < 5s AND bytes < 500)"
  - question: Can we identify anomalous SSH sessions to network devices that don't fit into normal clusters of administrative activity?
    context: |
      This question uses unsupervised machine learning to group similar SSH sessions into clusters representing normal administrative patterns. A session that does not fit well into any existing cluster (an outlier) is anomalous. This can detect a compromised admin account being used from a new location, or an attacker using different techniques than legitimate administrators.
    answer_sources:
      - Zeek conn.log
      - Zeek ssh.log
      - Network Device Syslog
      - Network Infrastructure (Switches, Routers, Firewalls)
      - Management Network Segment
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - pseudocode: "CLUSTER SSH_sessions based on features (source_IP, duration, bytes) | IDENTIFY sessions that are outliers or form_small_sparse_clusters | ALERT on_anomalous_sessions"
  - question: Is a non-Domain Controller host performing broad Active Directory user or group enumeration?
    context: |
      Large-scale enumeration of AD objects (users, groups) from a standard workstation is highly suspicious and is a key indicator of reconnaissance tools like BloodHound or AdFind. This question sets a simple threshold (e.g., >100 object access events in a minute) or looks for specific commands ('net user /domain') to detect this blatant enumeration activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Security Event ID 4662
      - Zeek conn.log
      - Zeek ldap.log
      - Zeek dce_rpc.log
      - Domain Controllers
      - Member Servers
      - Centralized Log Repository (SIEM)
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - pseudocode: "MONITOR for 'net user /domain' commands from non-DC hosts OR >100 user/group object_access_events (4662) from single_user in 1_minute | ALERT on_condition"
  - question: Is any single host querying a statistically anomalous number of unique Active Directory objects via LDAP compared to the network baseline?
    context: |
      This question uses network traffic analysis (LDAP logs) to detect AD reconnaissance. By establishing a moving average of unique objects queried per host, we can spot a host that suddenly starts querying far more objects than is typical (e.g., >4 standard deviations above the average), indicating potential enumeration activity.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Security Event ID 4662
      - Zeek conn.log
      - Zeek ldap.log
      - Zeek dce_rpc.log
      - Domain Controllers
      - Member Servers
      - Centralized Log Repository (SIEM)
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - pseudocode: "TRACK unique_AD_objects_queried per_source_IP in 10-min_windows | CALCULATE moving_average and standard_deviation for this_metric | ALERT if source_IP_count > 4_std_devs above_average"
  - question: Is a user's Active Directory query behavior significantly different from that of their peers with similar job roles?
    context: |
      Users with similar roles (e.g., accountants, developers) tend to have similar AD interaction patterns. This question uses peer group analysis to model this normal behavior. When an individual user's query patterns (e.g., volume, types of objects queried) deviate significantly from their peer group, it can indicate that their account is compromised and being used for reconnaissance.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Security Event ID 4662
      - Zeek conn.log
      - Zeek ldap.log
      - Zeek dce_rpc.log
      - Domain Controllers
      - Member Servers
      - Centralized Log Repository (SIEM)
      - Network Security Monitoring (NSM) Sensor Grid
    range: last 90 days
    queries:
      - pseudocode: "CLUSTER users into peer_groups based on AD_role | MODEL normal_LDAP_query_behavior for each_peer_group | USE anomaly_detection_model (Isolation Forest) to find users deviating from their_peer_group_baseline"