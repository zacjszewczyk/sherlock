name: T1566.002: Spearphishing Link
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate if an adversary has gained initial access via a spearphishing link. It provides investigative questions to detect multiple indicators of this technique, including outbound network connections to known malicious domains from threat intelligence, potential credential theft via HTTP POST requests containing sensitive field names, downloads of high-risk file types from untrusted domains, suspicious child processes being spawned by web browsers, time-based correlations between inbound emails with URLs and outbound clicks to those URLs, and DNS queries for lexically suspicious domains (e.g., homoglyphs, high entropy).
type: technique
related:
  - TA0001: Initial Access
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are internal hosts connecting to network indicators known to be malicious based on threat intelligence?
    context: This question seeks to identify direct connections to known-bad infrastructure, such as phishing sites or malware C2 servers. By correlating outbound network logs with high-confidence threat intelligence feeds, we can detect initial compromises or ongoing malicious communication with a high degree of certainty. A direct match is a strong indicator of compromise and warrants immediate investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek ssl.log
      - Network egress points (e.g., firewalls, proxies)
      - DNS resolvers
      - Cloud Access Security Brokers (CASB)
    range: last 90 days
    queries:
      - pseudocode: SEARCH outbound_network_logs (conn, dns, http, ssl) WHERE destination_ip OR destination_domain IN threat_intelligence_feed. RETURN source_ip, destination_ip, destination_domain, timestamp.
  - question: Are connections to known malicious indicators targeted or widespread?
    context: This question helps differentiate between a widespread campaign and a targeted attack. If a malicious domain or IP is contacted by only a very small number of internal hosts, it suggests a targeted spearphishing attempt rather than a broad, opportunistic attack. Identifying this rarity increases the risk score and prioritizes the incident for a more focused investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek ssl.log
      - Network egress points (e.g., firewalls, proxies)
      - DNS resolvers
      - Cloud Access Security Brokers (CASB)
    range: last 30 days
    queries:
      - pseudocode: FOR each malicious_indicator from threat_intel_match COUNT distinct source_hosts connecting to malicious_indicator in last 30 days. IF count < 5th_percentile_of_all_external_connections RAISE risk_score.
  - question: Can we confirm the maliciousness of a URL that matched threat intelligence using an independent machine learning model?
    context: This question adds a layer of validation to threat intelligence hits. While threat intelligence is valuable, it can have false positives or lag. By using a machine learning model trained on lexical, host-based, and historical features, we can independently score a URL's likelihood of being malicious. An event that is both a threat intelligence match and has a high maliciousness score from the model represents a very high-confidence threat.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek ssl.log
      - Network egress points (e.g., firewalls, proxies)
      - DNS resolvers
      - Cloud Access Security Brokers (CASB)
    range: last 90 days
    queries:
      - pseudocode: FOR each threat_intel_match_url CALCULATE malicious_probability_score using ML_model(url_features). IF score > 0.9 ESCALATE event.
  - question: Are users submitting data to external sites using forms that appear to be for credential harvesting?
    context: This question aims to identify HTTP POST requests that contain common credential field names (e.g., 'username', 'password') in their body or URI. This is a classic sign of a phishing page designed to steal user credentials. Alerting on such requests to non-whitelisted external domains can proactively detect credential theft in progress.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxy servers
      - network taps at internet gateways
      - user workstations and servers
    range: last 90 days
    queries:
      - pseudocode: SEARCH http_logs for POST requests to external_domains. APPLY regex for ('user', 'pass', 'ssn', etc.) to URI and POST_body. ALERT on match to non-whitelisted domain.
  - question: Do potential credential harvesting POST requests exhibit statistical anomalies like high URI randomness or a low number of unique clients?
    context: This question adds statistical rigor to the detection of credential harvesting. High URI entropy can indicate session identifiers or encoded data common in malicious frameworks. A low number of unique hosts POSTing to a destination suggests it is not a popular, legitimate service. Combining these two indicators significantly increases the confidence of a finding.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxy servers
      - network taps at internet gateways
      - user workstations and servers
    range: last 30 days
    queries:
      - pseudocode: FOR each credential_harvesting_alert CALCULATE shannon_entropy of URI. CALCULATE distinct_source_hosts to destination_domain in last 30 days. IF entropy > 95th_percentile AND host_count < 3 RAISE risk.
  - question: Is a user exhibiting an anomalous volume of HTTP POST requests to external domains compared to their own baseline?
    context: This question seeks to identify deviations from a user's normal behavior. By modeling each user's typical volume of HTTP POSTs, we can detect a sudden, unexplained spike. Such an anomaly could indicate a compromised account, a browser extension gone rogue, or automated script activity performing data exfiltration.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxy servers
      - network taps at internet gateways
      - user workstations and servers
    range: last 90 days
    queries:
      - pseudocode: FOR each user COMPARE current_POST_volume to forecasted_volume from SARIMA_model. IF observed_volume > upper_confidence_interval FLAG as anomaly.
  - question: Are users downloading high-risk file types from newly registered or non-whitelisted external domains?
    context: This question focuses on detecting the delivery of potentially malicious payloads. Adversaries frequently use new domains for their campaigns and deliver malware via scripts, executables, or weaponized documents. By maintaining a watchlist of high-risk file types and correlating them with downloads from new domains, we can catch initial payload delivery.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network egress points
      - host endpoints
      - DNS resolvers
      - email gateway sandboxes
    range: last 90 days
    queries:
      - pseudocode: SEARCH file_download_logs WHERE (mime_type IN high_risk_list OR extension IN high_risk_list) AND source_domain_age < 90 days. ALERT on match.
  - question: Are observed file downloads statistically rare within the environment?
    context: This question helps to surface suspicious downloads by identifying outliers. Most organizational downloads are repetitive (e.g., PDFs from known partners). A file download with a very rare combination of MIME type, source ASN, and file extension deviates from normal activity and is therefore suspicious and worthy of review.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network egress points
      - host endpoints
      - DNS resolvers
      - email gateway sandboxes
    range: last 90 days
    queries:
      - pseudocode: FOR each file_download CALCULATE rarity_score based on historical frequency of (MIME_type, source_ASN, extension) tuple. IF rarity_score > 99th_percentile FLAG for review.
  - question: Does a machine learning model classify a downloaded file as malicious based on its metadata?
    context: This question leverages a machine learning classifier to score the maliciousness of a downloaded file without executing it (static analysis). By analyzing features like domain reputation, file extension, filename entropy, and digital signature status, the model can provide a probabilistic assessment of risk, enabling automated alerting on high-score files.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network egress points
      - host endpoints
      - DNS resolvers
      - email gateway sandboxes
    range: last 90 days
    queries:
      - pseudocode: FOR each file_download CALCULATE maliciousness_score using Random_Forest_model(file_features). IF score > 0.85 GENERATE alert.
  - question: Are web browsers spawning suspicious child processes like command shells or scripting engines?
    context: This question detects a common post-exploitation pattern. After a user clicks a malicious link, the browser may be exploited to launch a command shell (cmd.exe), PowerShell, or a script interpreter (wscript.exe) to execute further commands. This is highly abnormal behavior for a browser and is a strong indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Zeek http.log
      - Zeek conn.log
      - User workstations
      - VDI instances
      - application servers
      - network web proxies
    range: last 90 days
    queries:
      - pseudocode: SEARCH process_creation_logs (EID 4688) WHERE parent_process IN (chrome.exe, msedge.exe, firefox.exe) AND child_process IN (cmd.exe, powershell.exe, wscript.exe, etc.). ALERT on match.
  - question: Is an observed browser-child process relationship rare, or does the child process have an unusually complex command line?
    context: This question refines the previous detection by adding statistical context. A parent-child relationship that is rare across the enterprise (e.g., 'firefox.exe' spawning 'cmd.exe') is more suspicious than a common one. Additionally, high command-line entropy can indicate obfuscation or complex, non-interactive commands, both of which are hallmarks of malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Zeek http.log
      - Zeek conn.log
      - User workstations
      - VDI instances
      - application servers
      - network web proxies
    range: last 90 days
    queries:
      - pseudocode: FOR each browser_child_process_event CALCULATE prevalence of parent-child_pair. CALCULATE shannon_entropy of child_command_line. IF prevalence < 1% OR entropy > 98th_percentile RAISE risk.
  - question: Does a sequence of processes originating from a web browser deviate from normal, modeled behavior?
    context: This question uses anomaly detection to identify malicious execution flows. Benign activity follows predictable patterns (e.g., browser -> helper process). An attack might create a process chain (e.g., browser -> powershell -> rundll32) that is statistically unlikely. Modeling process chains and flagging low-probability sequences can uncover novel or sophisticated attacks.
    answer_sources:
      - Windows Event ID 4688
      - Zeek http.log
      - Zeek conn.log
      - User workstations
      - VDI instances
      - application servers
      - network web proxies
    range: last 90 days
    queries:
      - pseudocode: FOR each process_chain originating from browser CALCULATE probability_score using LSTM_model. IF score is low (anomalous) FLAG for investigation.
  - question: Did a user recently click a link in an email that led to a domain with a poor reputation?
    context: This question directly links an inbound email to subsequent risky web traffic. By correlating email logs (which contain URLs) with DNS and HTTP logs (which show clicked links), we can pinpoint the exact email and link that led to a connection with a malicious site, providing crucial context for the incident response. The correlation is done on the user and a short time window (e.g., 15 minutes).
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Zeek http.log
      - Email Gateway Logs
      - Email gateway
      - DNS resolvers
      - network egress points
      - user workstations
    range: last 90 days
    queries:
      - pseudocode: JOIN email_logs with web_logs ON user within 15_minutes. IF destination_domain in email_url AND destination_domain has poor_reputation GENERATE alert.
  - question: Was a malicious URL clicked by only a single user, indicating a highly targeted attack?
    context: This question helps identify highly targeted phishing (i.e., spearphishing) by looking for URLs with an extremely low click-through rate (CTR). If a malicious link is sent to many users but only one or two click, it suggests those users were specifically chosen or that the lure was tailored to them. These events warrant a high-priority investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Zeek http.log
      - Email Gateway Logs
      - Email gateway
      - DNS resolvers
      - network egress points
      - user workstations
    range: last 90 days
    queries:
      - pseudocode: FOR each URL in email_campaign CALCULATE click_through_rate (CTR). IF CTR < 1st_percentile (e.g., 1-2 clicks) ESCALATE for investigation.
  - question: Did a user's click on an email link represent a break from their normal behavioral patterns?
    context: This question profiles a user's typical link-clicking habits (e.g., time of day, day of week, time between email receipt and click). A click that falls outside of their normal clusters of activity is anomalous and could indicate a moment of distraction, urgency, or a particularly convincing phish that broke their normal pattern of scrutiny.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Zeek http.log
      - Email Gateway Logs
      - Email gateway
      - DNS resolvers
      - network egress points
      - user workstations
    range: last 90 days
    queries:
      - pseudocode: FOR each user_email_click_event COMPARE event_features to user's DBSCAN_clusters. IF event is noise_point (outlier) FLAG as anomalous.
  - question: Are internal hosts attempting to resolve domains that appear to be homoglyphs or typosquats of legitimate, high-value domains?
    context: This question seeks to detect domains specifically crafted to impersonate well-known brands or internal company assets. Homoglyph algorithms check for visual character similarity (e.g., 'g' vs 'q'), while typosquatting algorithms check for minor spelling errors. Alerting on DNS queries for such domains can catch phishing attempts before the user even connects.
    answer_sources:
      - Zeek dns.log
      - Internal and external DNS resolvers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: FOR each new_domain in dns_logs APPLY homoglyph_check and typosquat_check against high_value_domain_list. ALERT on match.
  - question: Are internal hosts querying for newly observed domains that are statistically random and queried by very few hosts?
    context: This question helps identify domains that are likely machine-generated (as with a Domain Generation Algorithm, or DGA) or part of a very targeted attack. High character entropy suggests randomness, while a low number of querying hosts indicates the domain is not a popular, legitimate service. The combination of these two factors is highly suspicious.
    answer_sources:
      - Zeek dns.log
      - Internal and external DNS resolvers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: FOR each new_domain in dns_logs CALCULATE shannon_entropy and 2-gram_frequency. CALCULATE unique_querying_hosts. IF entropy > 95th_percentile AND host_count < 3 RAISE for review.
  - question: Does a machine learning model classify a newly queried domain as malicious based on its lexical features?
    context: This question provides a scalable way to automatically score the risk of every new domain seen in DNS traffic. The model uses lexical features like domain length, entropy, n-gram frequency, and TLD popularity to generate a probability score, automatically flagging potentially malicious domains for analyst review without relying on threat intelligence alone.
    answer_sources:
      - Zeek dns.log
      - Internal and external DNS resolvers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: FOR each new_domain in dns_logs CALCULATE malicious_probability_score using ML_model(lexical_features). IF score > 0.9 GENERATE alert.