name: "T1200: Hardware Additions"
id: "8f9a2b1c-3d4e-4f5a-6b7c-8d9e0f1a2b3c"
description: |
  This playbook helps investigate if an adversary has gained initial access via unauthorized hardware additions (TA0001 - Initial Access). This involves detecting events such as the installation of malicious drivers or services following a hardware connection, where the binary's hash or certificate is malicious. It also covers identifying network traffic to suspicious destinations or with rare characteristics (like JA3/JA3S hashes) within minutes of a hardware connection. The playbook looks for DHCP requests from hardware with MAC addresses or hostnames matching known offensive tools (e.g., Hak5, Flipper). It also addresses keystroke injection attacks by correlating Human Interface Device (HID) connections with the immediate execution of obfuscated or encoded commands. Furthermore, it includes checks for new MAC addresses on the network that are not registered in an asset management system. Finally, it helps identify anomalous process behavior, such as unusual parent-child relationships or uncharacteristic network connections, occurring shortly after a new hardware device is detected.
type: "technique"
related:
  - "TA0001: Initial Access"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is there evidence of a malicious driver or service being installed immediately after a new hardware connection?"
    context: "This question aims to detect adversaries using malicious hardware that installs a persistent backdoor or payload. By correlating hardware connection events (Windows Event ID 6416) with the subsequent creation of new drivers or services (Windows Event ID 7045), we can examine the associated executable files. If the file's hash is known to be malicious via threat intelligence, or if it's signed by an untrusted or revoked certificate, it's a strong indicator of compromise."
    answer_sources:
      - "Windows Event ID 7045"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 6"
      - "All corporate endpoint devices (laptops, desktops, servers), particularly those in sensitive areas like data centers or executive suites."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH for (Windows Event ID 6416 OR Windows Event ID 7045) and related file creation events. EXTRACT file hash and certificate details. CHECK file hash against threat intelligence feeds. CHECK certificate against a deny list. ALERT on match."
  - question: "Are newly installed drivers exhibiting unusually high entropy, suggesting they are packed or encrypted?"
    context: "Malicious payloads are often packed or encrypted to evade static analysis. This results in high entropy (randomness) in the file. This question involves calculating the entropy of all new driver files associated with hardware installations (Sysmon Event ID 6) and comparing it to a baseline of known-good drivers. A significant deviation from the norm (e.g., 3 standard deviations above the mean) can indicate a suspicious file that requires further investigation."
    answer_sources:
      - "Windows Event ID 7045"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 6"
      - "All corporate endpoint devices (laptops, desktops, servers), particularly those in sensitive areas like data centers or executive suites."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ON new driver file creation (Sysmon Event ID 6), CALCULATE file entropy. COMPARE entropy value to a pre-calculated baseline of legitimate driver entropy. ALERT if the value exceeds the baseline threshold (e.g., mean + 3 * standard deviation)."
  - question: "Does a machine learning model classify newly installed drivers as suspicious based on their file features?"
    context: "This question leverages machine learning to automate the detection of malicious drivers. A model, such as a random forest classifier, can be trained on various features extracted from driver files (e.g., file size, entropy, imported functions, digital signature status, signer reputation). When a new driver is installed, these features are extracted and fed to the model. A 'suspicious' classification from the model triggers an alert for an analyst to review."
    answer_sources:
      - "Windows Event ID 7045"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 6"
      - "All corporate endpoint devices (laptops, desktops, servers), particularly those in sensitive areas like data centers or executive suites."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ON new driver installation, EXTRACT features (file size, entropy, imports, signature). INPUT features into trained random forest model. ALERT if classification is 'suspicious' with high confidence."
  - question: "Is a host initiating network connections to known malicious destinations shortly after a new hardware device is connected?"
    context: "Malicious hardware may immediately 'call home' to an adversary's command and control (C2) server. This question involves correlating a new device installation event (Windows Event ID 6416) on a host with its subsequent network activity within a short time frame (e.g., 5 minutes). If the host connects to a destination IP, domain, or TLS server name that is present on a threat intelligence feed, it is a strong signal of malicious activity."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Windows Event ID 6416"
      - "Network egress points, DNS resolvers, and endpoint devices."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH for new device installation (Windows Event ID 6416). Within a 5-minute window, monitor network logs (Zeek) from that host. CHECK destination IP, DNS query, and TLS server name against threat intelligence feeds. ALERT on match."
  - question: "Following a device installation, is the host making network connections that are rare or anomalous for the enterprise?"
    context: "Adversaries often use infrastructure that has not been seen before in the target environment. Instead of relying solely on known-bad indicators, this question focuses on rarity. After a device installation, we analyze the subsequent network connections from that host. By calculating the enterprise-wide prevalence of the destination IP, requested domain, and JA3 hash, we can identify connections that are highly unusual. A combination of rare indicators can generate a risk score, triggering an alert for review."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Windows Event ID 6416"
      - "Network egress points, DNS resolvers, and endpoint devices."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ON new device installation, within 5 minutes, CALCULATE enterprise-wide prevalence of destination IP, domain, and JA3 hash from the host's network traffic. GENERATE a risk score based on rarity. ALERT if the score exceeds a defined threshold."
  - question: "Is there an anomalous spike in outbound network traffic volume from a host immediately after a new hardware device is connected?"
    context: "A malicious hardware device might initiate data exfiltration or download a larger second-stage payload, causing a sudden increase in network traffic. This question applies time-series anomaly detection models (like ARIMA) to a host's outbound traffic volume. An alert is triggered if an anomalous spike is detected immediately following a hardware installation event, prompting further inspection of the traffic."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Windows Event ID 6416"
      - "Network egress points, DNS resolvers, and endpoint devices."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY a time-series anomaly detection model to a host's outbound network traffic volume. ON new hardware installation (Windows Event ID 6416), check for a detected anomalous spike. ALERT on anomaly."
  - question: "Is a new device requesting a DHCP lease using a MAC address or hostname associated with known offensive security hardware?"
    context: "Specialized offensive hardware often has default hostnames or uses MAC addresses from specific vendor blocks (OUIs). This question involves monitoring DHCP logs (e.g., Zeek dhcp.log) for new requests. If the MAC address's OUI or the client hostname matches a curated list of known penetration testing or hacking hardware (like Hak5, Pwnie Express, Flipper), an alert should be generated for immediate investigation."
    answer_sources:
      - "Zeek dhcp.log"
      - "Zeek conn.log"
      - "Core network switches, DHCP servers, and wireless network segments."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "MONITOR DHCP logs for new requests. EXTRACT MAC address and hostname. COMPARE the OUI (from MAC) and hostname against a list of known offensive hardware identifiers. ALERT on match."
  - question: "Is a new DHCP request exhibiting an anomalous MAC address vendor (OUI) or hostname structure compared to the baseline?"
    context: "This question seeks to identify unknown or custom offensive hardware by looking for statistical anomalies in DHCP requests. By profiling the typical distribution of OUIs and hostname structures (length, character sets, patterns) across the network, we can score each new DHCP request for rarity. A request with a never-before-seen OUI and an unusual hostname syntax would receive a high anomaly score, indicating a potentially unauthorized device."
    answer_sources:
      - "Zeek dhcp.log"
      - "Zeek conn.log"
      - "Core network switches, DHCP servers, and wireless network segments."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "PROFILE legitimate DHCP requests to create a baseline of OUI distribution and hostname syntax. ON new DHCP request, calculate an anomaly score based on its OUI and hostname structure against the baseline. ALERT on high score."
  - question: "Does a machine learning model (isolation forest) identify a new DHCP request as an outlier based on its features?"
    context: "This question uses an unsupervised machine learning model, like an isolation forest, to detect anomalous DHCP requests. The model is trained on features from legitimate DHCP requests (OUI, hostname length, character distribution). It can then identify new requests that do not conform to the learned profile of 'normal' activity, flagging them as outliers for investigation. This is effective at finding novel or unusual devices without relying on predefined signatures."
    answer_sources:
      - "Zeek dhcp.log"
      - "Zeek conn.log"
      - "Core network switches, DHCP servers, and wireless network segments."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "TRAIN an isolation forest model on features of legitimate DHCP requests. USE the model to score new DHCP requests. ALERT if a request is identified as an outlier."
  - question: "Following a new HID connection, is a process created with command-line arguments indicative of a keystroke injection attack?"
    context: "Adversaries can use malicious Human Interface Devices (HIDs), like a Rubber Ducky, to inject keystrokes that execute commands. This question correlates a new HID connection with subsequent process creation events (e.g., powershell.exe, cmd.exe) within seconds. The command line is inspected for high-risk indicators of keystroke injection payloads, such as `-enc`, `IEX`, `DownloadString`, or other obfuscation techniques."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 1"
      - "All corporate endpoint devices, especially workstations in common areas or those used by privileged users."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH for new HID connection. Within 10 seconds, look for process creation (powershell.exe, cmd.exe). ANALYZE command line for suspicious substrings like '-enc', 'IEX', 'DownloadString'. ALERT on match."
  - question: "Does a command line executed shortly after a new HID connection have unusually high entropy, suggesting obfuscation?"
    context: "Keystroke injection payloads often use encoding (like Base64) to bypass simple keyword-based detections, which results in a high-entropy command-line string. This question involves calculating the entropy of any command line executed within 10 seconds of a new HID connection. If the entropy value is in the 99th percentile of typical command-line entropy, it strongly suggests obfuscation and should be flagged for review."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 1"
      - "All corporate endpoint devices, especially workstations in common areas or those used by privileged users."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ON new HID connection, within 10 seconds, CALCULATE entropy of any spawned process command line. COMPARE to a baseline of normal command-line entropy. ALERT if entropy is in the 99th percentile."
  - question: "Does an NLP model classify a command line executed immediately after a HID connection as malicious?"
    context: "This question applies advanced natural language processing (NLP) to command-line analysis. A sophisticated transformer-based model, pre-trained on a vast dataset of benign and malicious commands, can classify new command lines with high accuracy. Any command executed immediately after a HID connection is fed to the model. An alert is generated if the model classifies the command as malicious with high confidence, providing a powerful detection method for novel or complex injection attacks."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 1"
      - "All corporate endpoint devices, especially workstations in common areas or those used by privileged users."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ON new HID connection, within 10 seconds, pass any spawned command line to a pre-trained NLP classification model. ALERT if the model returns 'malicious' with >90% confidence."
  - question: "Is a new MAC address observed on the network that is not registered in the asset management system?"
    context: "This is a fundamental security hygiene check to detect unauthorized devices. The question involves periodically extracting all unique MAC addresses seen in network logs (DHCP, general traffic) and comparing them against an authoritative list of approved MAC addresses from a CMDB or NAC system. Any MAC address found on the network but not in the approved list should trigger an alert for an unauthorized device."
    answer_sources:
      - "Zeek dhcp.log"
      - "Zeek conn.log"
      - "Asset Management System Data (CSV/DB)"
      - "Network infrastructure (DHCP servers, core switches), Asset Management Database, Network Access Control (NAC) systems."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SCHEDULED JOB (e.g., every 15 mins): EXTRACT unique MACs from network logs. JOIN against approved MACs from asset database. ALERT on any MAC present in logs but not in the database."
  - question: "Is there an anomalous increase in the number of new, unregistered MAC addresses appearing on the network?"
    context: "While a single unregistered device is a concern, a sudden flood of them could indicate a more significant event, such as an adversary connecting multiple devices or a physical breach. This question involves tracking the count of new, unregistered MAC addresses over time (e.g., hourly). By establishing a baseline using a moving average, an alert can be triggered if the hourly count suddenly exceeds a statistical threshold (e.g., 3 standard deviations above the mean)."
    answer_sources:
      - "Zeek dhcp.log"
      - "Zeek conn.log"
      - "Asset Management System Data (CSV/DB)"
      - "Network infrastructure (DHCP servers, core switches), Asset Management Database, Network Access Control (NAC) systems."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "TRACK the hourly count of new, unregistered MAC addresses. ESTABLISH a baseline with a 7-day moving average. ALERT if the hourly count exceeds 3 standard deviations above the average."
  - question: "Does the number of new, unregistered devices significantly exceed the forecasted amount for a given period?"
    context: "Organizations have natural rhythms for adding new devices, such as onboarding new employees. This question uses a time-series forecasting model (like Prophet or LSTM) to predict the expected number of new, unregistered devices, accounting for these seasonal trends. An alert is generated only when the actual number of new devices significantly surpasses the model's predicted upper confidence bound, indicating a truly anomalous event rather than expected business activity."
    answer_sources:
      - "Zeek dhcp.log"
      - "Zeek conn.log"
      - "Asset Management System Data (CSV/DB)"
      - "Network infrastructure (DHCP servers, core switches), Asset Management Database, Network Access Control (NAC) systems."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "USE a forecasting model (e.g., Prophet) to predict the daily number of new unregistered devices. ALERT if the actual count significantly exceeds the model's forecasted upper confidence interval."
  - question: "Following a new hardware connection, is a process created with an unusual or suspicious parent-child relationship?"
    context: "Malicious hardware drivers or payloads may launch processes in a way that deviates from normal system behavior. This question involves creating a correlation that looks for a new device connection (Windows Event ID 6416) followed quickly by a process creation (Sysmon Event ID 1) with an anomalous parent-child relationship (e.g., services.exe spawning cmd.exe, which is highly irregular). This is a strong indicator that the new hardware triggered a malicious action."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "All corporate endpoint devices, Security Information and Event Management (SIEM) system."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ON new device connection (Event ID 6416), within 60 seconds, CHECK for process creation (Sysmon ID 1) with a parent-child relationship that is on a list of known-bad or rare pairs. ALERT on match."
  - question: "After a new hardware event, is a legitimate system process exhibiting uncharacteristic behavior, such as an unusual parent or a new type of network connection?"
    context: "Adversaries often abuse legitimate system processes to hide their activity. This question focuses on profiling the normal behavior of every process on an endpoint (e.g., its typical parent, its network destinations). After a new hardware event, any subsequent process activity is scored for anomalies. A high score, generated if a process like svchost.exe is launched by an unusual parent or makes a network connection to a rare IP, indicates potential compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "All corporate endpoint devices, Security Information and Event Management (SIEM) system."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "MAINTAIN profiles of normal process behavior (parent process, network connections). ON new hardware event, score subsequent process activity (Sysmon ID 1, 3) for deviations from its profile. ALERT on high anomaly score."
  - question: "Does a graph-based analysis of system activity following a new hardware event reveal an anomalous sequence of events?"
    context: "Modern attacks are often a chain of seemingly disparate events. This question uses a graph-based model where nodes represent entities like processes, files, and network connections. By training the model on graphs of normal system activity, it can learn benign patterns. When a new hardware event occurs, the subgraph of subsequent activity is analyzed. The model can identify anomalous sequences (e.g., new device -> process creation -> registry run key modification) that deviate from normal behavior."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Windows Event ID 6416"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "All corporate endpoint devices, Security Information and Event Management (SIEM) system."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "AFTER a new hardware event, CONSTRUCT a graph of subsequent process, file, and network activity. ANALYZE the graph for sequences that deviate from a trained model of benign patterns. ALERT on anomalous sequences."