name: "T1003.005: Cached Domain Credentials"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps investigate if an adversary has accessed cached domain credentials. It provides questions to detect credential dumping through various means, including the execution of known malicious tools identified by their hash, suspicious command-line arguments, unauthorized access to critical Windows registry hives (SECURITY, SYSTEM, SAM) or the LSASS process memory, and unauthorized access to Linux credential cache files (SSSD or Quest). The playbook also includes methods to correlate these dumping indicators with subsequent anomalous network activity to identify lateral movement."
type: "technique"
related:
  - "TA0006: Credential Access"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a process executed with a hash matching a known credential dumping utility?"
    context: "This question aims to identify the use of known malicious tools like Mimikatz or secretsdump.py by comparing the cryptographic hash of executed processes against a threat intelligence feed. A match is a high-confidence indicator of a credential dumping attempt."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon for Linux Event ID 1"
      - "All Windows and Linux Endpoints, Privileged Access Workstations, Critical Application Servers, and Domain Controllers."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Search process execution logs. Filter where process hash matches a threat intelligence feed of known credential dumping tool hashes. Generate a high-severity alert on match."
  - question: "Has a statistically rare process executed, potentially indicating an unknown credential dumping tool?"
    context: "This question looks for anomalous process executions by calculating the enterprise-wide prevalence of a process hash. A process seen on very few hosts (e.g., <5) or not associated with a known software deployment could be a novel or obfuscated malicious tool. The risk is higher if it runs from a temporary or user-writable directory."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon for Linux Event ID 1"
      - "All Windows and Linux Endpoints, Privileged Access Workstations, Critical Application Servers, and Domain Controllers."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "For each process execution, calculate enterprise-wide hash prevalence. Flag as risky if hash is seen on < 5 hosts or < 0.01% of fleet and not part of a known software deployment. Increase risk if path is temporary/user-writable."
  - question: "Can machine learning classify a process as a credential dumping tool based on its metadata?"
    context: "This question uses a supervised machine learning model to classify processes as benign or malicious. By analyzing features like hash prevalence, file path characteristics, parent process details, and code signing status, the model can identify suspicious processes that may not be caught by signature-based or simple statistical methods."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon for Linux Event ID 1"
      - "All Windows and Linux Endpoints, Privileged Access Workstations, Critical Application Servers, and Domain Controllers."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Extract features from process execution events (e.g., hash prevalence, path entropy, parent process name, is signed). Apply trained classification model (e.g., XGBoost) to classify process as benign or malicious."
  - question: "Has a process been executed with command-line arguments indicative of credential dumping?"
    context: "This question searches for specific text patterns and commands (e.g., 'sekurlsa::logonpasswords', 'reg.exe save HKLM\\SECURITY') within process command-line arguments. These are strong signatures for known credential dumping techniques and tools."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Auditd logs"
      - "All Windows Endpoints, Authentication Servers, Linux systems integrated with Active Directory"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Search process execution logs for command-line arguments. Apply a regex filter for known credential dumping patterns like 'sekurlsa::', 'lsadump::cache', 'reg.exe save HKLM\\SECURITY', and 'tdbdump'. Alert on any match."
  - question: "Has a user or host executed a command with statistically rare argument patterns?"
    context: "This question aims to detect novel or obfuscated malicious commands by baselining normal command-line patterns for each user and host. A command whose structure is highly unusual (e.g., in the 99.5th percentile of rarity) for that context is flagged as anomalous and warrants investigation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Auditd logs"
      - "All Windows Endpoints, Authentication Servers, Linux systems integrated with Active Directory"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "For each user/host, establish a 30-day baseline of command-line argument n-grams. Flag any new command whose pattern rarity is in the 99.5th percentile for that user or host."
  - question: "Can command-line arguments be clustered using NLP to identify malicious activity?"
    context: "This question applies Natural Language Processing (NLP) to group similar command-line arguments. By converting commands into numerical representations (embeddings) and clustering them, we can identify commands that fall into known malicious clusters or are outliers from all established benign clusters, indicating potentially new attack techniques."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Auditd logs"
      - "All Windows Endpoints, Authentication Servers, Linux systems integrated with Active Directory"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Generate NLP embeddings for all command-line arguments. Use a clustering algorithm (e.g., K-Means) to group similar commands. Investigate commands in malicious clusters or those identified as outliers."
  - question: "Has an unauthorized process attempted to read critical registry hives like SECURITY, SYSTEM, or SAM?"
    context: "This question focuses on protecting registry hives that store credential material. By deploying monitoring (SACLs) and creating an allowlist of legitimate system processes (like lsass.exe), we can alert on any unauthorized process attempting to read these sensitive locations, which is a common step in credential dumping."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 13"
      - "Domain Controllers, Windows Servers with cached credentials enabled, User Workstations"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Monitor for read handle requests (Event ID 4656/4663) to HKLM\\SECURITY, HKLM\\SYSTEM, and HKLM\\SAM. Alert if the process image path is not on a pre-defined allowlist of legitimate system processes."
  - question: "Has a process from a statistically unusual file path accessed critical registry hives?"
    context: "This question identifies suspicious registry access by analyzing the file path of the accessing process. Malicious tools are often dropped in temporary or randomized locations, resulting in high-entropy file paths. A process accessing sensitive hives from such a path is highly suspect compared to legitimate system processes in predictable locations like C:\\Windows\\System32."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 13"
      - "Domain Controllers, Windows Servers with cached credentials enabled, User Workstations"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "For each process accessing critical hives, calculate the Shannon entropy of its file path. Flag events where the path entropy is statistically high compared to a baseline, indicating a potentially randomized or suspicious location."
  - question: "Can anomalous registry hive access be identified by clustering access events?"
    context: "This question uses unsupervised machine learning to find unusual patterns in registry hive access. By clustering events based on features like the process name, user context, and time of day, we can identify outlier events that do not fit into any established 'benign' cluster, representing a potential threat."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 13"
      - "Domain Controllers, Windows Servers with cached credentials enabled, User Workstations"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Cluster registry hive access events using features like process name, user context, time of day, and parent process. Investigate outlier clusters or individual outlier events that do not belong to known benign clusters."
  - question: "Has an unauthorized process attempted to read the memory of the LSASS process?"
    context: "This question detects a classic credential dumping technique: memory scraping of the Local Security Authority Subsystem Service (lsass.exe). We monitor for processes requesting specific memory access rights (like PROCESS_VM_READ) to lsass.exe and alert if the source process is not on a pre-defined allowlist of legitimate security and system tools."
    answer_sources:
      - "Sysmon Event ID 10"
      - "All Windows Endpoints and Servers, especially Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Monitor Sysmon Event ID 10 where TargetImage is 'lsass.exe'. Alert if GrantedAccess includes '0x1010' (PROCESS_VM_READ) and SourceImage is not on an allowlist of approved tools (e.g., MsMpEng.exe)."
  - question: "Has a new or rare process/user combination been observed accessing the LSASS process?"
    context: "This question establishes a behavioral baseline of which processes and logon sessions normally interact with lsass.exe. Any 'first-seen' combination of a source process and logon ID accessing LSASS is flagged as anomalous. The suspicion level increases if the process itself is rare across the entire organization."
    answer_sources:
      - "Sysmon Event ID 10"
      - "All Windows Endpoints and Servers, especially Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Establish a 30-day baseline of (SourceImage, LogonId) pairs that access lsass.exe. Alert on any new pair observed for the first time. Score severity based on the enterprise-wide rarity of the SourceImage."
  - question: "Can a machine learning model detect anomalous access to the LSASS process?"
    context: "This question uses a one-class SVM model, which is trained exclusively on legitimate LSASS access events. The model learns the boundary of 'normal' behavior. Any new access event that falls outside this learned boundary is classified as an anomaly, indicating a potential credential dumping attempt that might use novel methods."
    answer_sources:
      - "Sysmon Event ID 10"
      - "All Windows Endpoints and Servers, especially Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Train a one-class SVM model on feature vectors from legitimate LSASS access events. Use the model to identify any new access events that are classified as anomalous or novel."
  - question: "Has a credential dumping indicator been followed by anomalous network authentication activity from the same host?"
    context: "This question correlates multiple stages of an attack to increase detection confidence. It looks for a confirmed credential dumping indicator (like LSASS access) followed within a short time window (e.g., 60 minutes) by suspicious lateral movement, such as the same host suddenly authenticating to an unusual number of other internal systems."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 10"
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Zeek dce_rpc.log"
      - "Enterprise-wide network traffic gateways, Authentication logs on all servers, Process execution logs on all endpoints"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Create a stateful rule. Trigger: LSASS access or suspicious command alert on a host. Condition: Within 60 minutes, the same host originates network logons (Logon Type 3) to >5 distinct internal hosts for the first time in 7 days. Action: Escalate to incident."
  - question: "Following a credential dumping alert, did the host exhibit a statistically significant increase in network connections?"
    context: "This question statistically validates suspected lateral movement after a credential dumping event. It compares the host's network behavior in the hour after the alert to its historical baseline. If the number of distinct destination IPs or ports exceeds a high percentile (e.g., 99th), it strongly suggests the stolen credentials are being used for network reconnaissance or movement."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 10"
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Zeek dce_rpc.log"
      - "Enterprise-wide network traffic gateways, Authentication logs on all servers, Process execution logs on all endpoints"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Following a credential dumping alert on a host, analyze its subsequent network connections. If the host exceeds its historical 99th percentile of distinct destination IPs/ports per hour, flag for anomalous lateral movement."
  - question: "Can a sequence of security events be modeled to identify a likely transition from credential dumping to lateral movement?"
    context: "This question uses a Hidden Markov Model (HMM) to understand the sequence of attacker behaviors. The model is trained on event sequences to learn the probability of transitioning between states like 'Benign', 'Credential Dumping', and 'Lateral Movement'. An observed sequence of events that shows a high probability of this specific malicious transition path generates a high-confidence alert."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 10"
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Zeek dce_rpc.log"
      - "Enterprise-wide network traffic gateways, Authentication logs on all servers, Process execution logs on all endpoints"
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Use a Hidden Markov Model with states 'Benign', 'Credential Dumping', 'Lateral Movement'. Train on sequences of security events. An observed sequence with a high probability of 'Credential Dumping' -> 'Lateral Movement' transition generates an alert."
  - question: "Has a non-standard user or process accessed Linux credential cache files?"
    context: "This question looks for direct access to sensitive credential files on Linux systems integrated with Active Directory, such as SSSD or Quest/VAS caches. It uses signature-based rules to monitor for read access to these files by any user other than 'root' or the service account, or for the use of specific tools like 'tdbdump' against these files."
    answer_sources:
      - "Auditd logs"
      - "Sysmon for Linux Event ID 1"
      - "bash_history"
      - "Linux servers and workstations integrated with Active Directory via SSSD or Quest/VAS."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Monitor read access to '/var/lib/sss/db/cache_*.ldb' or '/var/opt/quest/vas/authcache/vas_auth.vdb'. Alert if accessing user is not 'root' or 'sssd'. Also, search command lines for 'tdbdump' on these paths."
  - question: "Has a rare process or command been used to access Linux credential cache files?"
    context: "This question identifies anomalous access to Linux credential caches by baselining the processes that normally interact with them. Any access from a process not on the baseline is suspicious. Furthermore, analyzing the command-line arguments for rarity can help detect novel or obfuscated tools being used for this purpose."
    answer_sources:
      - "Auditd logs"
      - "Sysmon for Linux Event ID 1"
      - "bash_history"
      - "Linux servers and workstations integrated with Active Directory via SSSD or Quest/VAS."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Baseline all processes that access credential cache file paths. Alert on any access from a process not in the baseline. Also, flag any command-line arguments seen for the first time accessing these files."
  - question: "Can a machine learning model classify access to Linux credential cache files as benign or malicious?"
    context: "This question uses a supervised classification model to distinguish between legitimate administrative access and malicious access to sensitive Linux credential files. By training on features like the user, their privileges, the process name, and time of day, the model can learn to identify suspicious access patterns that deviate from normal administrative behavior."
    answer_sources:
      - "Auditd logs"
      - "Sysmon for Linux Event ID 1"
      - "bash_history"
      - "Linux servers and workstations integrated with Active Directory via SSSD or Quest/VAS."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "Train a classification model (e.g., Logistic Regression) on file access events. Use features like user name, privileges, process name, and parent process. Classify new events as benign or malicious."