name: T1521.001: Symmetric Cryptography
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook investigates the use of symmetric cryptography for command and control (C2) communications originating from managed mobile devices. The primary goal is to detect adversaries who are encrypting their C2 traffic to evade network defenses. The playbook focuses on two key indicators. The first is C2 beaconing, which is identified by a combination of periodic network connections, high-entropy data payloads suggesting encryption, and the use of non-standard, high-numbered destination ports. The second is C2 tunneling, where malicious traffic is sent over standard ports (e.g., 443, 53) but does not conform to the expected application-layer protocol, such as observing TCP traffic on port 443 without a corresponding TLS handshake.
type: technique
related:
  - TA0037: Command And Control
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a managed mobile device connecting to a known command and control (C2) server?
    context: This question aims to identify the most direct evidence of a compromise by cross-referencing mobile device network logs with a threat intelligence feed of known malicious C2 servers. A positive match is a high-confidence indicator of malicious activity and should be treated as a critical alert, as it suggests an active C2 channel is established.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek software.log
      - Zeek http.log
      - Mobile Device Management (MDM) network flow logs
      - Mobile EDR network connection logs
      - Managed mobile devices
      - Corporate Wi-Fi network sensors
      - VPN concentrators
      - Internet Gateway / Egress Firewall
      - Cloud Access Security Broker (CASB)
      - Mobile Device Management (MDM) Server
      - Threat Intelligence Feed
    range: last 90 days
    queries:
      - technology: SIEM Pseudocode
        query: |
          JOIN mobile_device_network_logs WITH threat_intelligence_feed ON (destination_ip OR destination_domain)
          WHERE match_is_found
          GENERATE critical_alert
  - question: Is a mobile device exhibiting network traffic patterns indicative of C2 beaconing, such as periodic connections, high-entropy data, and non-standard ports?
    context: This question seeks to identify covert C2 channels that do not rely on known malicious infrastructure. Adversaries often use custom C2 protocols that beacon out at regular intervals (low inter-arrival time deviation) and encrypt their traffic (high entropy). By analyzing these behavioral characteristics and assigning a risk score, analysts can uncover previously unknown C2 activity that would be missed by signature-based detection alone.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek software.log
      - Zeek http.log
      - Mobile Device Management (MDM) network flow logs
      - Mobile EDR network connection logs
      - Managed mobile devices
      - Corporate Wi-Fi network sensors
      - VPN concentrators
      - Internet Gateway / Egress Firewall
      - Cloud Access Security Broker (CASB)
      - Mobile Device Management (MDM) Server
    range: last 90 days
    queries:
      - technology: SIEM Pseudocode
        query: |
          FOR each source_ip in a 1-hour sliding window:
            GROUP outbound_connections by destination_ip, destination_port
            CALCULATE inter_arrival_stddev
            CALCULATE payload_entropy
            CALCULATE risk_score:
              +3 if inter_arrival_stddev < 5 seconds
              +3 if payload_entropy > 7.5
              +2 if destination_port > 1024 and not in allow_list
            IF risk_score > 4, ALERT
  - question: Can machine learning models identify anomalous high-entropy traffic from mobile devices that is likely C2 communication?
    context: This question proposes a sophisticated, two-stage machine learning approach for detecting advanced C2 threats. A time-series model first identifies unusual spikes in encrypted traffic volume, reducing the amount of data that needs further inspection. A second, more resource-intensive classification model then analyzes the anomalous traffic using a rich feature set to distinguish between malicious C2 and benign activity with high accuracy. This helps automate detection and reduce analyst workload.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek software.log
      - Zeek http.log
      - Zeek ssl.log
      - Mobile Device Management (MDM) network flow logs
      - Mobile EDR network connection logs
      - Managed mobile devices
      - Corporate Wi-Fi network sensors
      - VPN concentrators
      - Internet Gateway / Egress Firewall
      - Cloud Access Security Broker (CASB)
      - Mobile Device Management (MDM) Server
    range: last 90 days
    queries:
      - technology: Machine Learning Pseudocode
        query: |
          // Stage 1: Time-series Anomaly Detection
          FOR each device:
            AGGREGATE high_entropy_traffic_volume in 5-min intervals
            APPLY ARIMA/LSTM model
            IF anomaly detected, TRIGGER Stage 2
          // Stage 2: Classification
            EXTRACT features (inter-arrival stats, entropy, duration, bytes, port, ASN, JA3/JA3S)
            APPLY Random Forest classifier
            IF classification is C2 with high confidence, GENERATE incident
  - question: Is a mobile device using a standard service port (e.g., 443 for HTTPS, 53 for DNS) for traffic that does not conform to the expected protocol?
    context: This question addresses C2 tunneling, a common evasion technique where adversaries wrap their malicious traffic in a legitimate protocol or simply use a common port to bypass firewall rules. By checking for discrepancies, such as traffic on port 443 without a corresponding TLS handshake or on port 53 without a DNS query, analysts can uncover hidden C2 channels masquerading as normal web or DNS traffic. Enriching these findings with threat intelligence provides further context for prioritization.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points
      - Internal DNS resolvers
      - Cloud Access Security Broker (CASB) logs
      - Core network switches
      - Threat Intelligence Feed
    range: last 90 days
    queries:
      - technology: SIEM Pseudocode
        query: |
          // For HTTPS tunneling
          LEFT JOIN conn_logs (port=443) WITH ssl_logs ON connection_uid
          WHERE ssl_log is NULL, ALERT
          // For DNS tunneling
          LEFT JOIN conn_logs (port=53) WITH dns_logs ON connection_uid
          WHERE dns_log is NULL, ALERT
          ENRICH alert with threat_intel on destination_ip/ASN
  - question: Is a mobile device exhibiting a statistically significant increase in protocol-mismatched connections compared to its own baseline or its peers?
    context: This question focuses on detecting C2 tunneling through behavioral baselining rather than fixed rules. It establishes what is 'normal' for each device and for the entire device population by calculating a 'Protocol Mismatch Ratio'. An alert is triggered when a device deviates significantly (using Median Absolute Deviation) from its own historical behavior or from the population's norm. This statistical approach is effective at finding outliers and can adapt to changes in the environment.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points
      - Internal DNS resolvers
      - Cloud Access Security Broker (CASB) logs
      - Core network switches
    range: last 90 days
    queries:
      - technology: Analytics Platform Pseudocode
        query: |
          FOR each device:
            CALCULATE daily_mismatch_ratio = mismatched_connections / total_connections on key ports (443, 53)
            CALCULATE 30-day rolling median of the ratio
            CALCULATE Median Absolute Deviation (MAD) of the ratio
            IF daily_ratio > (median + 3 * MAD), ALERT
            // Also compare to population
            CALCULATE 99th percentile of ratio for all devices
            IF daily_ratio > 99th_percentile, ALERT
  - question: Can an unsupervised anomaly detection model identify network connections that are likely C2 tunneling based on their low-level connection properties?
    context: This question explores the use of an unsupervised machine learning model, like Isolation Forest, to detect C2 tunneling without relying on pre-labeled data. The model learns the characteristics of 'normal,' protocol-adherent traffic from features in connection logs (e.g., duration, bytes, service field). It then assigns an anomaly score to new connections. Connections that receive a high score are flagged as potential C2 because they differ significantly from the learned baseline of normal behavior, indicating non-standard protocol usage.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points
      - Internal DNS resolvers
      - Cloud Access Security Broker (CASB) logs
      - Core network switches
    range: last 90 days
    queries:
      - technology: Machine Learning Pseudocode
        query: |
          // Training
          TRAIN Isolation Forest model on known-good connection data
          // Inference
          FOR each new connection:
            EXTRACT features (duration, bytes, proto, service, conn_state, history, port)
            CALCULATE anomaly_score with model
            IF score is high, FLAG for review