name: "T1649: Steal or Forge Authentication Certificates"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook addresses the threat of adversaries stealing or forging authentication certificates to gain unauthorized access. It focuses on detecting several key indicators of compromise, such as the execution of known certificate theft tools, the use of command-line arguments for certificate manipulation, anomalous certificate enrollment requests on a Certificate Authority, unauthorized access to cryptographic keys, suspicious certificate-based logons with anomalous traits, and the creation of certificate files in unusual locations followed by network exfiltration."
type: "technique"
related:
  - "TA0006: Credential Access"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Have any processes been executed that match known certificate theft tools, or have any network connections been made using known malicious TLS certificates?"
    context: "This question aims to detect the direct use of known malicious tools or infrastructure. By matching process file hashes against a threat intelligence watchlist of certificate manipulation tools (like Certipy, Mimikatz, Rubeus) or matching TLS certificate thumbprints against a list of known malicious ones, we can quickly identify confirmed malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek x509.log"
      - "Domain Controllers, Certificate Authority Servers, All Endpoints, Network Egress Points"
    range: "last 90 days"
    queries:
      - "SIEM Query: JOIN process_creation_events ON process_hash WITH certificate_tool_hash_watchlist. JOIN network_connection_events ON certificate_thumbprint WITH malicious_certificate_watchlist."
  - question: "Is there an anomalous execution frequency of legitimate certificate management tools on any host?"
    context: "Adversaries may abuse legitimate system utilities (living-off-the-land) like 'certutil.exe' to perform malicious actions. This question seeks to identify such abuse by baselining the normal execution frequency of these tools per host and flagging significant deviations (e.g., exceeding the 99th percentile), which could indicate reconnaissance or theft activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers, Certificate Authority Servers, All Endpoints, Network Egress Points"
    range: "last 90 days"
    queries:
      - "SIEM Query: COUNT process_executions WHERE process_name IN (certutil.exe, certlm.msc) GROUP BY host, time_window. ALERT IF count > 99th_percentile_baseline."
  - question: "Can we identify suspicious or malicious process executions related to certificate management using a machine learning model?"
    context: "This question leverages a supervised machine learning model to proactively identify potentially malicious process executions that may not be caught by simple signature-based rules. By training on features like process name, parent process, command-line entropy, and user context, the model can assign a risk score to new events and flag high-risk activities for analyst review, enabling detection of novel threats."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers, Certificate Authority Servers, All Endpoints, Network Egress Points"
    range: "last 90 days"
    queries:
      - "ML Model Query: PREDICT risk_score FROM process_execution_features (process_name, parent_process, cmd_entropy, user). ALERT IF risk_score > threshold."
  - question: "Are there any command-line arguments indicating the use of known certificate enumeration, request, or theft tools?"
    context: "This question looks for specific, high-fidelity indicators of compromise within command-line logs. By using regular expressions to search for patterns associated with known offensive security tools (like Certipy, Mimikatz, Rubeus), we can detect their usage even if the executable name is changed. A match provides strong evidence of malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows PowerShell Event ID 4104"
      - "Domain Controllers, Certificate Authority Servers, All Endpoints with PowerShell/CMD access"
    range: "last 90 days"
    queries:
      - "SIEM Query: SEARCH process_creation_events OR powershell_events WHERE command_line MATCHES REGEX ('find -vulnerable', 'auth -pfx', 'crypto::certificates', 'asktgs /pfx')."
  - question: "Are there any command-line executions with unusually high entropy, suggesting obfuscation?"
    context: "Adversaries often use obfuscation or encoding to hide their commands from simple keyword-based detections. This question aims to uncover such activity by calculating the entropy (randomness) of command-line arguments for common shells. A command with an entropy score significantly higher than the established baseline for a given user/host suggests obfuscation and warrants investigation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows PowerShell Event ID 4104"
      - "Domain Controllers, Certificate Authority Servers, All Endpoints with PowerShell/CMD access"
    range: "last 90 days"
    queries:
      - "SIEM Query: CALCULATE entropy(command_line) for powershell.exe, cmd.exe, certutil.exe. ALERT IF entropy > (baseline_entropy + 3 * std_dev) for user_host_pair."
  - question: "Can a Natural Language Processing (NLP) model identify novel or obfuscated malicious command lines related to certificate abuse?"
    context: "This question proposes using an advanced NLP model to understand the semantic structure and intent of command lines, going beyond simple regex or entropy analysis. By training on a large dataset of benign and malicious commands, the model can classify new, previously unseen command-line variations as suspicious or malicious, providing a powerful defense against evolving attack techniques."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows PowerShell Event ID 4104"
      - "Domain Controllers, Certificate Authority Servers, All Endpoints with PowerShell/CMD access"
    range: "last 90 days"
    queries:
      - "ML Model Query: CLASSIFY command_line from events 4688, 4104 using transformer_model. ALERT IF classification is 'suspicious' or 'malicious'."
  - question: "Have there been any certificate requests that violate security policy, such as by specifying a Subject Alternative Name (SAN) or using a restricted template?"
    context: "This question targets a specific Active Directory Certificate Services (AD CS) misconfiguration known as ESC1, where an attacker can impersonate privileged accounts by specifying a Subject Alternative Name (SAN) in a certificate request. The query checks for any such requests or requests for highly sensitive templates (like 'Sub-CA') from unauthorized sources, which are critical indicators of an attack."
    answer_sources:
      - "Windows Event ID 4886"
      - "Windows Event ID 4898"
      - "Windows Event ID 4887"
      - "Active Directory Certificate Authority (CA) Servers"
    range: "last 90 days"
    queries:
      - "SIEM Query: SEARCH certificate_request_events (4886) WHERE (template_allows_san AND san_is_specified) OR (template IN ('Sub-CA') AND requestor NOT IN (ca_servers))."
  - question: "Have there been any statistically rare certificate requests or an anomalous spike in failed requests from a specific user?"
    context: "This question aims to find unusual behavior by baselining normal certificate request patterns. It flags requests that are rare for a given user/machine and template combination, which could indicate an attacker exploring the environment. Additionally, a sudden spike in failed requests from a single user can be a sign of automated probing for misconfigurations or vulnerabilities on the Certificate Authority."
    answer_sources:
      - "Windows Event ID 4886"
      - "Windows Event ID 4898"
      - "Windows Event ID 4887"
      - "Active Directory Certificate Authority (CA) Servers"
    range: "last 90 days"
    queries:
      - "SIEM Query: CALCULATE rarity_score for (requestor, template) pair. ALERT if score is high. SEPARATELY, COUNT failed_requests (4887) by user. ALERT if count > (baseline + 3 * std_dev)."
  - question: "Is there an anomalous volume of successful or failed certificate requests for sensitive templates over time?"
    context: "This question uses a time-series model to detect automated abuse of the Certificate Authority. By monitoring the volume of successful and failed requests for specific, sensitive templates (e.g., Domain Controller Authentication), the model can identify sudden, anomalous spikes that deviate from normal patterns. Such a spike is a strong indicator of an adversary attempting to mint certificates for privilege escalation."
    answer_sources:
      - "Windows Event ID 4886"
      - "Windows Event ID 4898"
      - "Windows Event ID 4887"
      - "Active Directory Certificate Authority (CA) Servers"
    range: "last 90 days"
    queries:
      - "ML Model Query: MONITOR time-series of successful (4898) and failed (4887) requests per template. ALERT if anomalous spike is detected for sensitive templates."
  - question: "Has a cryptographic key been exported by an unauthorized process?"
    context: "This question focuses on detecting the direct theft of private keys. It monitors for key export events and correlates them with process creation information to identify the responsible application. An alert is generated if the process performing the export is not on an explicit allow-list of legitimate applications, indicating a high probability of credential theft."
    answer_sources:
      - "Windows Event ID 5058"
      - "Windows Event ID 5059"
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "All Endpoints and Servers, especially Domain Controllers and Certificate Authority Servers"
    range: "last 90 days"
    queries:
      - "SIEM Query: JOIN key_export_events (5058) WITH process_creation_events (4688) on ProcessID. ALERT IF process_name NOT IN (key_export_allow_list)."
  - question: "Has a user performed a key export for the first time, or has there been an unusual amount of access to protected key storage directories?"
    context: "This question seeks to identify anomalous behavior related to key access. It flags two suspicious scenarios: a user exporting a key for the very first time, which is a rare and potentially malicious event; and a process rapidly accessing numerous files in protected key storage directories. The latter can indicate an attempt to enumerate or steal multiple keys at once."
    answer_sources:
      - "Windows Event ID 5058"
      - "Windows Event ID 5059"
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "All Endpoints and Servers, especially Domain Controllers and Certificate Authority Servers"
    range: "last 90 days"
    queries:
      - "SIEM Query: ALERT IF user performs first-time key_export (5058). SEPARATELY, COUNT file_access_events (4663) to crypto_dirs by process. ALERT if count > 98th_percentile."
  - question: "Can an unsupervised machine learning model detect anomalous access to cryptographic keys or protected key storage?"
    context: "This question uses an unsupervised model (like Isolation Forest) to learn what constitutes normal key access behavior. By analyzing features like the user, process, target key/file, and time of day, the model can identify rare and unusual combinations of these features. This allows for the detection of novel attack patterns, such as a non-system process accessing machine keys outside of business hours."
    answer_sources:
      - "Windows Event ID 5058"
      - "Windows Event ID 5059"
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "All Endpoints and Servers, especially Domain Controllers and Certificate Authority Servers"
    range: "last 90 days"
    queries:
      - "ML Model Query: DETECT_ANOMALY from key_access_features (user, process, path, time_of_day). ALERT on anomalous events."
  - question: "Has a privileged account, which is not expected to use certificate-based logon, successfully authenticated using this method?"
    context: "This question targets a high-risk scenario where a compromised certificate for a privileged or service account is used for an interactive logon. Since these types of accounts rarely, if ever, log on interactively with a certificate, such an event is highly suspicious and could indicate that an attacker has stolen the account's certificate and is using it to move laterally or escalate privileges."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek x509.log"
      - "Domain Controllers, Authentication Servers (RADIUS/NPS), VPN Concentrators, Network Gateways"
    range: "last 90 days"
    queries:
      - "SIEM Query: SEARCH logon_events (4624) WHERE logon_type IN ('Network', 'RemoteInteractive') AND auth_package IN ('Kerberos', 'Schannel_Cert') AND user IN (privileged_user_watchlist)."
  - question: "Has a user authenticated with a certificate from a geographically impossible location or a previously unseen network?"
    context: "This question aims to detect credential theft by analyzing the geographic and network origin of certificate-based logons. By profiling a user's typical logon locations and source networks (ASNs), we can flag authentications that are physically impossible ('impossible travel') or originate from a network never before used by that user. This is a strong indicator that the user's certificate has been stolen and is being used from an attacker-controlled system."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek x509.log"
      - "Domain Controllers, Authentication Servers (RADIUS/NPS), VPN Concentrators, Network Gateways"
    range: "last 90 days"
    queries:
      - "SIEM Query: ON new_logon, CALCULATE travel_speed from previous_logon_location. ALERT IF speed > impossible_threshold. ALSO, ALERT IF source_ASN is new for user."
  - question: "Has a user's certificate authentication behavior significantly deviated from that of their organizational peers?"
    context: "This question uses peer group analysis to identify anomalous behavior that might be normal for an individual but is strange compared to their colleagues. The model groups users by role (e.g., HR, Engineering) and learns the normal authentication patterns for each group. An alert is raised if a user's activity, such as an HR employee using a certificate to authenticate to a developer server, deviates significantly from their peer group's norm, suggesting a compromised account or certificate."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek x509.log"
      - "Domain Controllers, Authentication Servers (RADIUS/NPS), VPN Concentrators, Network Gateways"
    range: "last 90 days"
    queries:
      - "ML Model Query: CLUSTER users into peer_groups. ON new_authentication, CALCULATE distance from user_behavior to peer_group_centroid. ALERT IF distance > threshold."
  - question: "Has a certificate file (.pfx, .pem, etc.) been created in a sensitive or unusual directory by an unauthorized process?"
    context: "This question focuses on detecting the staging of stolen certificates for exfiltration. By enabling file system auditing on common staging areas (like temp folders) and other sensitive locations, we can monitor for the creation of certificate files. An alert is triggered if the process writing the file is not an approved application (like a web browser or certificate client), suggesting an attacker is preparing to steal the certificate."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "User Workstations, File Servers, Web Servers, Network Egress Points"
    range: "last 90 days"
    queries:
      - "SIEM Query: SEARCH file_write_events (4663) WHERE file_extension IN (.pfx, .p12, .pem) AND target_dir IN (staging_dirs). ALERT IF process_name NOT IN (allow_list)."
  - question: "Is there an anomalously high volume of certificate files being transferred outbound over the network?"
    context: "This question aims to detect the exfiltration of certificate files by monitoring network traffic. By analyzing file transfer logs (like Zeek's files.log) and baselining the normal volume of certificate-related MIME types being sent outbound, we can detect significant spikes. An alert on a volume exceeding a dynamic threshold (e.g., 95th percentile) indicates a potential mass exfiltration of stolen certificates."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "User Workstations, File Servers, Web Servers, Network Egress Points"
    range: "last 90 days"
    queries:
      - "SIEM Query: COUNT outbound_transfers where mime_type IN (pkcs12, x509-cert) GROUP BY hour. ALERT IF count > 95th_percentile_baseline."
  - question: "Has a process been observed writing a certificate file and immediately initiating an outbound network transfer of that file?"
    context: "This question seeks to identify the full 'steal and exfiltrate' attack chain with high confidence by linking discrete events into a single narrative. A sequence analysis model looks for a specific pattern within a short time window: the same process first writing a certificate file to disk, then making an outbound network connection, and then a certificate file being detected on that connection. This sequence is a very strong indicator of active certificate theft and exfiltration."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "User Workstations, File Servers, Web Servers, Network Egress Points"
    range: "last 90 days"
    queries:
      - "SIEM Query: DETECT sequence for a single process: (1) file_write with .pfx extension (4663), THEN (2) outbound_network_connection (conn.log), THEN (3) file_transfer with cert_mime_type (files.log) within 2 minutes."