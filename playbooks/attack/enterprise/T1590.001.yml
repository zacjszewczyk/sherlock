name: "T1590.001: Domain Properties"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps to identify if an adversary is actively gathering information about an organization's domain properties for targeting. This includes detecting external IPs from threat intelligence feeds performing DNS queries or connecting to services, observing unusual HTTP/S requests indicative of reconnaissance tools, monitoring for anomalous execution of network utilities on internal hosts, identifying high volumes of DNS queries resulting in NXDOMAIN responses, and detecting network or service sweeps from a single external source."
type: "technique"
related:
  - "TA0043: Reconnaissance"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a known malicious IP address querying our DNS or connecting to our services?"
    context: "Threat intelligence feeds provide lists of IP addresses known for malicious activities such as scanning or command and control. Matching a source IP from our network logs (DNS and connection logs) against these feeds is a high-confidence method for detecting targeted reconnaissance early in the attack lifecycle."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "External-facing DNS Resolvers"
      - "Network Perimeter Firewalls"
      - "Web Application Firewalls"
    range: "last 90 days"
    queries:
      - "pseudocode: JOIN dns_logs and conn_logs ON source_ip; COMPARE source_ip against threat_intel_feed; ALERT on match;"
  - question: "Is an IP from an unusual or rare Autonomous System Number (ASN) sending an anomalous number of DNS queries to our domain?"
    context: "Adversaries often leverage infrastructure from less common hosting providers or geographic regions. By establishing a baseline of normal query volume per source ASN, we can identify significant deviations. A sudden spike in queries from a new or infrequent ASN can indicate a reconnaissance attempt that might evade simple IP-based threat lists."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "External-facing DNS Resolvers"
      - "Network Perimeter Firewalls"
      - "Web Application Firewalls"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each source_ip, get ASN; CALCULATE historical query_count_per_ASN; ESTABLISH baseline (95th percentile); ALERT if new/rare ASN source_ip exceeds baseline in 1-hour window;"
  - question: "Can we use a machine learning model to classify source IPs as malicious based on their DNS and connection behavior?"
    context: "This question explores a predictive approach beyond static rules. A supervised classification model, such as a Random Forest, can learn complex patterns from historical data. By engineering features like source ASN, country, time of day, and connection/query frequency, the model can classify new, unseen source IPs and alert on those predicted to be malicious, thus catching novel threats."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "External-facing DNS Resolvers"
      - "Network Perimeter Firewalls"
      - "Web Application Firewalls"
    range: "last 90 days"
    queries:
      - "pseudocode: TRAIN Random Forest model on labeled (benign/malicious) IP data with features (ASN, country, conn_count, dns_count); APPLY model to new IPs in real-time; ALERT on malicious classification;"
  - question: "Are we seeing HTTP/S requests with User-Agents or URIs that match signatures of known domain reconnaissance tools?"
    context: "Automated reconnaissance tools like 'ffuf', 'gobuster', and 'sublist3r' often leave distinct fingerprints in the User-Agent string or the requested URI. This question aims to detect the active use of these tools by applying a list of regular expressions for known tool signatures against web traffic logs."
    answer_sources:
      - "Zeek http.log"
      - "Public-facing Web Servers"
      - "Cloud API Gateways"
      - "Reverse Proxies"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH http_logs for user_agent OR uri matching regex_list_of_recon_tools; ALERT on match;"
  - question: "Is any external source IP requesting web resources with an unusually high level of randomness, suggesting automated enumeration?"
    context: "When an adversary uses a tool to brute-force directory names or subdomains, the sequence of requested URIs appears more random than normal user browsing. Calculating the Shannon entropy of URIs requested by a single source IP can quantify this randomness. A spike in entropy above the established baseline is a strong indicator of automated enumeration."
    answer_sources:
      - "Zeek http.log"
      - "Public-facing Web Servers"
      - "Cloud API Gateways"
      - "Reverse Proxies"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each source_ip, CALCULATE Shannon entropy of requested URIs in 5-min window; ESTABLISH baseline entropy; ALERT if entropy exceeds 99th percentile of baseline;"
  - question: "Can a machine learning model distinguish malicious reconnaissance tool User-Agents from legitimate browsers and benign bots?"
    context: "This question proposes using a deep learning model, like a character-level Convolutional Neural Network (CNN), to analyze the structure of User-Agent strings. This approach can be more resilient than static signature matching, as it can identify new or modified tools that share structural similarities with known malicious User-Agents but do not match existing patterns."
    answer_sources:
      - "Zeek http.log"
      - "Public-facing Web Servers"
      - "Cloud API Gateways"
      - "Reverse Proxies"
    range: "last 90 days"
    queries:
      - "pseudocode: TRAIN character-level CNN on user_agent strings to classify (legitimate, benign_bot, malicious); APPLY model to new http_logs; ALERT on malicious classification;"
  - question: "Is a network utility like nslookup or whois being executed by an unusual process or user account on an internal host?"
    context: "Legitimate use of network utilities like 'nslookup.exe' is typically interactive, launched from a command prompt by an administrator. When these tools are spawned by a non-standard parent process (e.g., a web service) or run under a service account, it is highly suspicious and could indicate an adversary performing internal reconnaissance after gaining an initial foothold."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers"
      - "Endpoint Workstations"
      - "Member Servers"
      - "Privileged Access Workstations"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH process_creation_events (EID 4688) for process_name IN (nslookup.exe, whois.exe, Resolve-DnsName); ALERT if parent_process NOT IN (explorer.exe, cmd.exe, powershell.exe) OR if user is a service_account;"
  - question: "Is any user or host executing an abnormally high number of network utility commands?"
    context: "While a single execution of 'nslookup' is normal, a sudden burst of these commands from one user or host is not. By baselining the normal frequency of these commands per user and per host, we can detect anomalous spikes that suggest an adversary is systematically enumerating internal or external resources."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers"
      - "Endpoint Workstations"
      - "Member Servers"
      - "Privileged Access Workstations"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each host/user, ESTABLISH baseline frequency of network utility executions; ALERT if daily count > (mean + 3 * std_dev) OR if command-line arguments show unusual domain variety;"
  - question: "Can we use unsupervised clustering to find anomalous process executions related to network reconnaissance?"
    context: "This question uses an unsupervised machine learning approach (e.g., DBSCAN) to group all process execution events into clusters of 'normal' behavior. Processes that do not fit into these clusters are flagged as outliers. This is effective for finding novel or stealthy techniques that don't match predefined rules, by identifying activity that is simply 'different' from the norm."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers"
      - "Endpoint Workstations"
      - "Member Servers"
      - "Privileged Access Workstations"
    range: "last 90 days"
    queries:
      - "pseudocode: CLUSTER process_execution_events using DBSCAN on features (process_name, cmd_line_entropy, parent_process, session_type); INVESTIGATE outlier clusters;"
  - question: "Is an external IP address generating a high volume of DNS queries for non-existent subdomains?"
    context: "A common technique for subdomain enumeration is to brute-force a list of potential names, which results in many DNS queries that receive an NXDOMAIN (non-existent domain) response. A simple rule that counts the number of NXDOMAIN responses from a single source IP in a short time frame can effectively detect this activity."
    answer_sources:
      - "Zeek dns.log"
      - "External-facing DNS Resolvers"
      - "Internal Recursive DNS Servers that log queries"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each external_source_ip, COUNT DNS queries with NXDOMAIN response in 1 minute; ALERT if count > 50;"
  - question: "Is an external IP showing both a high ratio of NXDOMAIN responses and high randomness in the subdomains being queried?"
    context: "This question improves upon simple NXDOMAIN counting by adding a second condition: high entropy in the queried subdomain names. The combination of a high failure rate (NXDOMAIN ratio) and high randomness (entropy) is a stronger indicator of automated brute-force enumeration, helping to filter out benign misconfigurations."
    answer_sources:
      - "Zeek dns.log"
      - "External-facing DNS Resolvers"
      - "Internal Recursive DNS Servers that log queries"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each external_source_ip in 5-min window, CALCULATE (NXDOMAIN_ratio, subdomain_entropy); ALERT if NXDOMAIN_ratio > 98th_percentile_baseline AND subdomain_entropy is high;"
  - question: "Can a time-series model detect anomalies in the volume and rate of NXDOMAIN responses from external sources?"
    context: "This question proposes using a sophisticated time-series model (e.g., ARIMA or LSTM) to forecast the 'normal' rate of DNS queries and NXDOMAIN responses, learning daily and weekly patterns. When a sudden, unexpected spike occurs that deviates significantly from the forecast (a high residual error), it signals an anomaly that could be a reconnaissance scan."
    answer_sources:
      - "Zeek dns.log"
      - "External-facing DNS Resolvers"
      - "Internal Recursive DNS Servers that log queries"
    range: "last 90 days"
    queries:
      - "pseudocode: TRAIN time-series model (e.g., LSTM) on DNS query volume and NXDOMAIN rate; MONITOR forecast error (residual) in real-time; ALERT on significant spikes in error for a specific source IP;"
  - question: "Is Zeek's built-in portscan detector identifying scans from external IPs?"
    context: "This question leverages an existing capability within Zeek, which has a built-in script that detects port scanning behavior and logs it to 'portscan.log'. While potentially noisy, it provides a simple, immediate alert for basic scanning activity originating from the internet and requires minimal configuration."
    answer_sources:
      - "Zeek conn.log"
      - "Network Perimeter Firewalls"
      - "Demilitarized Zone (DMZ) segments"
      - "Public-facing Application Servers"
    range: "last 90 days"
    queries:
      - "pseudocode: MONITOR Zeek portscan.log; ALERT on any entry where scanner is an external IP;"
  - question: "Is any external IP connecting to an unusually high number of distinct internal hosts or ports?"
    context: "Adversaries perform network sweeps to identify live hosts (horizontal scanning) and service scans to find open ports on a host (vertical scanning). This question aims to detect this by counting the unique destination IPs and ports contacted by a single source IP in a short window and alerting when this count exceeds a dynamic, rolling baseline."
    answer_sources:
      - "Zeek conn.log"
      - "Network Perimeter Firewalls"
      - "Demilitarized Zone (DMZ) segments"
      - "Public-facing Application Servers"
    range: "last 90 days"
    queries:
      - "pseudocode: FROM conn_logs, GROUP BY source_ip in 5-min window; COUNT distinct dest_hosts and distinct dest_ports; ALERT if count > 99.5th percentile of 7-day baseline;"
  - question: "Can we use unsupervised clustering to identify external IP addresses that are exhibiting scanning behavior?"
    context: "This question uses a clustering model like K-Means to group network traffic based on connection patterns. Features such as the count of distinct hosts/ports contacted, the ratio of SYN packets, and average connection duration can effectively separate normal traffic from scanning activity. The model can identify and alert on clusters whose characteristics match scanning behavior without predefined rules."
    answer_sources:
      - "Zeek conn.log"
      - "Network Perimeter Firewalls"
      - "Demilitarized Zone (DMZ) segments"
      - "Public-facing Application Servers"
    range: "last 90 days"
    queries:
      - "pseudocode: CLUSTER aggregated conn_data per source_ip using K-Means on features (distinct_dest_IPs, distinct_dest_ports, SYN_ratio, avg_duration); IDENTIFY and ALERT on clusters representing scanning behavior;"