name: 'T1590.001: Domain Properties'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: "This playbook helps investigate whether an adversary is actively gathering information about the organization's domain properties for targeting purposes. This includes detecting reconnaissance activity such as external IPs from threat intelligence feeds querying corporate domains, HTTP/S requests with User-Agents or URIs matching known scanning tools, unusual internal execution of network utilities like nslookup or whois, high volumes of DNS queries resulting in non-existent domain (NXDOMAIN) errors from a single source, and network or service scanning from an external IP."
type: 'technique'
related:
  - 'TA0043: Reconnaissance'
contributors:
  - 'Zachary Szewczyk'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: "Has a source IP known to be malicious been observed querying our DNS or connecting to our public-facing services?"
    context: "This question aims to identify high-confidence reconnaissance activity by checking if any network traffic (DNS queries or general connections) originates from IP addresses listed on reputable threat intelligence feeds. A match indicates that a known malicious actor is directly interacting with our infrastructure, which is a strong signal of targeted reconnaissance or the initial stages of an attack."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "External-facing DNS Resolvers"
      - "Network Perimeter Firewalls"
      - "Web Application Firewalls"
      - "Threat Intelligence Feed"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "JOIN dns_logs AND connection_logs ON source_ip | LOOKUP source_ip in threat_intelligence_feed | WHERE threat_match == TRUE"
  - question: "Is a source IP from an unusual or new Autonomous System Number (ASN) sending an anomalous number of DNS queries to our domain?"
    context: "This question seeks to detect potential reconnaissance from sources that are not yet on a threat list. By baselining normal query volume per ASN, we can spot outliers. A sudden spike in queries from a rare or previously unseen ASN could indicate an adversary using newly provisioned infrastructure to gather information about our network."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "External-facing DNS Resolvers"
      - "Network Perimeter Firewalls"
      - "Web Application Firewalls"
      - "ASN Database"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each source_ip, GET source_asn | GROUPBY source_asn, CALCULATE historical_query_count_baseline | For current 1-hour window, COUNT queries by source_ip | ALERT if query_count > baseline AND source_asn is rare"
  - question: "Can we classify a new, unseen source IP as malicious based on its network behavior patterns?"
    context: "This question leverages machine learning to proactively identify malicious reconnaissance activity. By training a model on features like ASN, geography, and connection/query frequency, we can develop a more nuanced and adaptive detection capability than static rules or threat lists alone, allowing us to flag suspicious IPs that exhibit characteristics of past attacks."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "External-facing DNS Resolvers"
      - "Network Perimeter Firewalls"
      - "Web Application Firewalls"
      - "ASN Database"
      - "GeoIP Database"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each new source_ip, EXTRACT features (asn, country, time_of_day, conn_count, dns_query_count) | INPUT features into trained_classification_model | ALERT if model_prediction == 'malicious'"
  - question: "Are any inbound HTTP/S requests using User-Agents or URIs associated with known reconnaissance tools?"
    context: "This question focuses on identifying automated reconnaissance tools by looking for their specific signatures in web traffic. Tools used for subdomain enumeration, directory brute-forcing, or vulnerability scanning often leave distinct fingerprints in the User-Agent string or the requested URI. Detecting these signatures provides direct evidence of scanning activity."
    answer_sources:
      - "Zeek http.log"
      - "Public-facing Web Servers"
      - "Cloud API Gateways"
      - "Reverse Proxies"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SEARCH http_logs WHERE user_agent MATCHES regex_list_of_recon_tools OR uri MATCHES regex_list_of_recon_tools"
  - question: "Is any single source IP requesting an unusually diverse and random set of URI paths?"
    context: "This question aims to detect automated web content discovery, such as directory or file brute-forcing. Attackers' tools often generate a wide variety of non-sequential and random-looking URI requests. Calculating the Shannon entropy of these URIs can quantify this randomness; a significant spike in entropy compared to normal user behavior is a strong indicator of enumeration."
    answer_sources:
      - "Zeek http.log"
      - "Public-facing Web Servers"
      - "Cloud API Gateways"
      - "Reverse Proxies"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each source_ip, CALCULATE shannon_entropy of requested_uris in 5-min_window | COMPARE to historical_baseline_entropy | ALERT if current_entropy > 99th_percentile_of_baseline"
  - question: "Can a machine learning model classify an HTTP User-Agent string as belonging to a malicious reconnaissance tool, even if it's new or modified?"
    context: "This question seeks to identify malicious User-Agents that may have been altered to evade simple signature-based detection. A character-level CNN can learn the subtle structural patterns of different User-Agent families (legitimate, benign bots, malicious tools). This allows for the detection of novel or spoofed User-Agents that still share underlying characteristics with known malicious tools."
    answer_sources:
      - "Zeek http.log"
      - "Public-facing Web Servers"
      - "Cloud API Gateways"
      - "Reverse Proxies"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each http_request, EXTRACT user_agent_string | INPUT user_agent into trained_cnn_model | ALERT if model_prediction == 'malicious'"
  - question: "Has a network reconnaissance tool (like nslookup or whois) been executed by an unusual process or user account?"
    context: "This question aims to find internal reconnaissance activity by focusing on how network utilities are executed. While administrators and users run these tools legitimately (typically from an interactive shell), execution by a service account or an unexpected parent process (like a web server or office application) is highly suspicious and could indicate a compromised host being used for discovery."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers"
      - "Endpoint Workstations"
      - "Member Servers"
      - "Privileged Access Workstations"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SEARCH process_creation_events WHERE (process_name IN ['nslookup.exe', 'whois.exe'] OR (process_name == 'powershell.exe' AND command_line CONTAINS 'Resolve-DnsName')) AND (parent_process NOT IN ['explorer.exe', 'cmd.exe', 'powershell.exe'] OR user_is_service_account)"
  - question: "Is a user or host executing network reconnaissance tools with an anomalous frequency or targeting an unusual number of domains?"
    context: "This question seeks to identify abuse of legitimate network utilities by detecting abnormal usage patterns. A system administrator might run `nslookup` a few times a day. An attacker, however, might script it to run hundreds of times to resolve a list of potential targets. By baselining normal frequency and command-line patterns, we can flag significant deviations that suggest automated or large-scale internal reconnaissance."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers"
      - "Endpoint Workstations"
      - "Member Servers"
      - "Privileged Access Workstations"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each user/host, CALCULATE 30-day_baseline (mean, std_dev) of network_utility_executions | ALERT if daily_count > (mean + 3 * std_dev) OR command_line_domain_count is anomalous"
  - question: "Can we identify anomalous clusters of network utility process executions that differ from normal administrative activity?"
    context: "This question uses machine learning to find 'unknown unknowns' in process execution data. By clustering executions based on multiple features (process name, command line details, parent, user context), we can group normal, legitimate activity together. Any small, distinct clusters or individual outliers that don't fit the main groups represent anomalous behavior that warrants investigation, potentially revealing novel attack patterns."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers"
      - "Endpoint Workstations"
      - "Member Servers"
      - "Privileged Access Workstations"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "EXTRACT features from process_creation_events (process_name, cmd_length, cmd_entropy, parent_process, session_type) | APPLY clustering_algorithm (DBSCAN) | INVESTIGATE outlier clusters and noise points"
  - question: "Is any single external IP generating a high number of failed DNS lookups (NXDOMAIN) for our domain?"
    context: "This question aims to detect subdomain brute-force attacks. Attackers often use a dictionary of common subdomain names to query a target domain, resulting in a large number of queries for names that do not exist (NXDOMAIN). A simple threshold for NXDOMAIN responses from a single source within a short time is a direct and effective way to detect this activity."
    answer_sources:
      - "Zeek dns.log"
      - "External-facing DNS Resolvers"
      - "Internal Recursive DNS Servers that log queries"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each source_ip, COUNT dns_queries WHERE response_code == 'NXDOMAIN' in 1-min_window | ALERT if count > 50"
  - question: "Is an external IP exhibiting both a high ratio of failed DNS lookups and high randomness in the subdomains it is querying?"
    context: "This question refines the detection of subdomain brute-forcing by combining two indicators. A high NXDOMAIN ratio points to guessing, while high entropy in the queried names confirms the automated, non-sequential nature of the guessing. Requiring both conditions to be met reduces false positives that might arise from misconfigured clients, while more accurately identifying sophisticated enumeration tools."
    answer_sources:
      - "Zeek dns.log"
      - "External-facing DNS Resolvers"
      - "Internal Recursive DNS Servers that log queries"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each source_ip in 5-min_window, CALCULATE nxdomain_ratio and subdomain_entropy | ALERT if nxdomain_ratio > 98th_percentile_baseline AND subdomain_entropy is high"
  - question: "Is the volume or rate of failed DNS lookups from a specific source IP significantly deviating from its forecasted normal behavior?"
    context: "This question applies time-series analysis to detect anomalies in DNS query patterns. By creating a forecast model for normal query volume and NXDOMAIN rates, we can detect when the actual observed behavior significantly deviates from the prediction. This method is powerful for detecting 'low and slow' reconnaissance that might not cross static thresholds but represents a clear change from an actor's established baseline."
    answer_sources:
      - "Zeek dns.log"
      - "External-facing DNS Resolvers"
      - "Internal Recursive DNS Servers that log queries"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each source_ip, FORECAST expected_dns_volume and nxdomain_rate using time-series_model | CALCULATE residual (actual - forecast) | ALERT if residual shows a significant sustained spike"
  - question: "Has our network monitoring tool's built-in portscan detector flagged any external IP addresses?"
    context: "This question provides a quick, first-pass check for obvious scanning activity. Network security monitors like Zeek have pre-built detectors for common scanning patterns. While they can be noisy, they offer an immediate, low-effort signal that a port scan from an external source may be underway, prompting further investigation."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek portscan.log"
      - "Network Perimeter Firewalls"
      - "Demilitarized Zone (DMZ) segments"
      - "Public-facing Application Servers"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SEARCH portscan_logs WHERE originator_ip is external"
  - question: "Is an external IP connecting to an abnormally high number of distinct internal hosts (horizontal scan) or distinct ports on a single host (vertical scan)?"
    context: "This question aims to statistically detect network sweeps and port scans. A horizontal scan involves one IP trying to connect to many different hosts, while a vertical scan involves one IP trying to connect to many different ports on a single host. By creating a baseline for normal connection patterns and alerting on significant deviations (e.g., >99.5th percentile), we can reliably detect this behavior."
    answer_sources:
      - "Zeek conn.log"
      - "Network Perimeter Firewalls"
      - "Demilitarized Zone (DMZ) segments"
      - "Public-facing Application Servers"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each source_ip in 5-min_window, COUNT distinct destination_hosts and distinct destination_ports | COMPARE counts to 7-day_rolling_baseline | ALERT if host_count > 99.5th_percentile OR port_count > 99.5th_percentile"
  - question: "Can we identify clusters of network traffic that exhibit the characteristics of scanning behavior?"
    context: "This question uses machine learning to group connection patterns and identify clusters that represent scanning. Scanning behavior typically has distinct features: high fan-out to many hosts/ports, a high ratio of initial connection packets (SYNs) with no follow-up, and very short connection durations. By clustering on these features, we can isolate groups of traffic that are characteristic of automated scanning, even if they don't cross a simple threshold."
    answer_sources:
      - "Zeek conn.log"
      - "Network Perimeter Firewalls"
      - "Demilitarized Zone (DMZ) segments"
      - "Public-facing Application Servers"
    range: "Last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "For each source_ip, AGGREGATE features (distinct_dest_ips, distinct_dest_ports, syn_ratio, avg_duration) over 5-min_window | APPLY clustering_algorithm | IDENTIFY and ALERT on clusters representing scan behavior"