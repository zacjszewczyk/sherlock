name: T1589.001: Credentials
id: d9a2b5e3-8f0c-4a1e-9b6f-7e8d0c1a2b3c
description: This playbook helps investigate whether an adversary is attempting to gather credentials from the organization. This can manifest in several ways, including credential phishing, where adversaries use emails or websites with known IOCs to harvest credentials. Phishing campaigns can also be identified by their volume, such as a large number of similar emails being sent to many recipients in a short time. Additionally, this playbook addresses brute-force techniques like password spraying, where a single source IP generates many authentication failures across multiple accounts, and username enumeration, where an attacker probes a login endpoint to discover valid usernames by generating a high rate of 'user name does not exist' errors.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are we observing any indicators of compromise (IOCs) related to known credential phishing campaigns in our network and email traffic?
    context: This question aims to detect credential phishing attempts by matching network and email metadata (like URLs, domains, IPs) against high-confidence threat intelligence feeds. A match is a strong indicator of a targeted attack and requires immediate attention to prevent credential loss.
    answer_sources:
      - Zeek smtp.log
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Email Gateway
      - Web Proxy
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - search: zeek_logs | lookup threat_intel_feed on (url, domain, ip, file_hash) | where match_found | alert
  - question: Are there any suspicious URLs in our traffic that, while not on a known IOC list, exhibit characteristics of phishing links, such as high entropy or being hosted on a newly registered domain?
    context: Attackers often use newly created domains and obfuscated URL paths to evade signature-based detection. This question helps identify these suspicious URLs by analyzing their structural properties. High character entropy in a URL path can indicate randomization to avoid filters, and very new domains are a classic red flag for malicious activity. By risk-scoring these attributes, we can uncover emerging phishing threats.
    answer_sources:
      - Zeek smtp.log
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Email Gateway
      - Web Proxy
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - search: zeek_http_smtp_logs | parse url | calculate path_entropy | lookup domain_age | if path_entropy > threshold and domain_age < 30_days then alert
  - question: Can a machine learning model identify previously unseen phishing URLs in our environment based on their lexical features?
    context: This question proposes a more advanced, proactive detection method using machine learning. By training a classifier on the characteristics of known good and bad URLs (like length, special characters, keywords), we can build a model that predicts whether a new, uncategorized URL is likely to be malicious. This helps catch zero-day phishing attacks that haven't yet been added to threat intelligence feeds.
    answer_sources:
      - Zeek smtp.log
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Email Gateway
      - Web Proxy
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - search: zeek_http_smtp_logs | extract_url_features | predict with logistic_regression_model | if prediction == 'phishing' and probability > 0.9 then alert
  - question: Has a large number of our users received a similar email from a single external source in a short period of time?
    context: This question is designed to detect the initial blast of a phishing campaign. A single external sender sending highly similar emails (measured by subject line similarity) to many internal recipients within an hour is a strong indicator of a coordinated attack, rather than normal business communication.
    answer_sources:
      - Zeek smtp.log
      - Zeek http.log
      - Zeek dns.log
      - Email Gateway
      - Internal Mail Servers
      - DNS Resolvers
    range: last 90 days
    queries:
      - search: zeek_smtp | group_by sender_ip, time_window=1h | where unique_recipients > 20 and subject_similarity > 0.8 | alert
  - question: Is a specific URL being distributed via email to an unusually high number of recipients, compared to its historical baseline?
    context: This question focuses on the distribution velocity of a URL within emails. Malicious links in a phishing campaign are often sent to many people quickly. By baselining the normal 'URL-to-recipient' rate, we can spot anomalies where a link suddenly goes "viral" internally, which is a strong signal of a phishing campaign in progress.
    answer_sources:
      - Zeek smtp.log
      - Zeek http.log
      - Zeek dns.log
      - Email Gateway
      - Internal Mail Servers
      - DNS Resolvers
    range: last 90 days
    queries:
      - search: zeek_smtp | for_each url | count unique_recipients in 5min_window | compare_to_baseline | if count > 99th_percentile then alert
  - question: Can we use unsupervised machine learning to automatically group related emails and detect the emergence of a new, large-scale phishing campaign?
    context: This question leverages unsupervised learning (like DBSCAN) to find hidden patterns in email traffic without pre-existing labels. The model groups emails based on sender, subject, and URL features. The sudden appearance of a new, large cluster of similar emails can indicate a coordinated campaign. Applying anomaly detection to the volume of messages within these clusters helps pinpoint the exact moment an attack begins.
    answer_sources:
      - Zeek smtp.log
      - Zeek http.log
      - Zeek dns.log
      - Email Gateway
      - Internal Mail Servers
      - DNS Resolvers
    range: last 90 days
    queries:
      - stream: zeek_smtp_metadata | apply DBSCAN clustering | monitor cluster_size and formation_rate | apply anomaly_detection to cluster_volume | alert on spikes
  - question: Is a single external IP address attempting to log in to multiple user accounts and failing, indicating a potential password spraying attack?
    context: Password spraying is a brute-force technique where an attacker tries a few common passwords against many different user accounts. This question seeks to identify this behavior by looking for a single source IP generating a high number of authentication failures across many distinct accounts within a short time frame. This is a classic signature of a password spraying attack against external-facing services.
    answer_sources:
      - Windows Event ID 4625
      - Zeek conn.log
      - Public-facing Authentication Servers (e.g., ADFS, VPN, OWA)
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - search: event_id=4625 and zeek_conn | group_by source_ip, time_window=1h | where unique_failed_users > 10 | alert
  - question: Are any source IPs exhibiting an anomalously low ratio of successful to failed logins, suggesting they are guessing credentials rather than performing legitimate authentications?
    context: Legitimate users occasionally fail to log in, but a source IP performing a password spray will have an extremely high failure rate and a very low (or zero) success rate. This question establishes a baseline for the normal success-to-failure ratio and alerts when an IP deviates significantly, indicating its activity is likely malicious and not just a user forgetting their password.
    answer_sources:
      - Windows Event ID 4625
      - Zeek conn.log
      - Public-facing Authentication Servers (e.g., ADFS, VPN, OWA)
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - search: event_id in (4624, 4625) | group_by source_ip, time_window=1h | calculate success_fail_ratio | compare_to_baseline | if ratio < 1st_percentile and total_failures > 20 then alert
  - question: Is the volume of failed authentications from a particular network (ASN) significantly higher than our predictive model expects, even accounting for normal daily and weekly patterns?
    context: This question uses time series forecasting to predict the expected volume of login failures from different parts of the internet (grouped by ASN). This approach can detect large-scale, distributed attacks where multiple IPs from the same network are involved. When the actual number of failures dramatically exceeds the model's prediction, it signals a coordinated event that requires investigation.
    answer_sources:
      - Windows Event ID 4625
      - Zeek conn.log
      - Public-facing Authentication Servers (e.g., ADFS, VPN, OWA)
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - search: event_id=4625 | group_by ASN | forecast failure_count with Prophet_model | if actual_failures > predicted_upper_bound then alert
  - question: Is a single external IP address generating a high volume of login failures specifically because the usernames do not exist?
    context: Before launching a password spray, attackers may first try to identify valid usernames. This is called username enumeration. This question looks for the specific failure code indicating an invalid username ('0xc0000064'). A high volume of these errors from a single source IP is a strong signal that an attacker is probing the system to build a list of valid accounts for a future attack.
    answer_sources:
      - Zeek http.log
      - Windows Event ID 4625
      - Zeek conn.log
      - Public-facing Web Servers
      - Application Servers
      - Authentication APIs
    range: last 90 days
    queries:
      - search: event_id=4625 and sub_status='0xc0000064' | group_by source_ip, time_window=10m | where event_count > 50 | alert
  - question: Is any source IP generating a disproportionately high number of 'invalid username' errors compared to 'bad password' errors?
    context: A legitimate user might mistype their password (generating a 'bad password' error), but they are unlikely to repeatedly mistype their username. An attacker performing username enumeration, however, will generate almost exclusively 'invalid username' errors. This question flags source IPs where the ratio of these error types is abnormally high, separating enumeration activity from normal login failures.
    answer_sources:
      - Zeek http.log
      - Windows Event ID 4625
      - Zeek conn.log
      - Public-facing Web Servers
      - Application Servers
      - Authentication APIs
    range: last 90 days
    queries:
      - search: event_id=4625 | group_by source_ip | calculate ratio of 'invalid_user_errors' to 'bad_password_errors' | compare_to_baseline | if ratio > 98th_percentile then alert
  - question: Can a machine learning model be trained to automatically classify authentication activity as benign, password spraying, or username enumeration based on session features?
    context: This question proposes a sophisticated, all-in-one detection method. By training a model on features that characterize different types of authentication behavior (e.g., number of unique users, ratio of failure types, request timing), it can learn to distinguish between normal activity and specific attack patterns like password spraying or username enumeration. This provides a powerful, automated way to identify and categorize threats against authentication services.
    answer_sources:
      - Zeek http.log
      - Windows Event ID 4625
      - Zeek conn.log
      - Public-facing Web Servers
      - Application Servers
      - Authentication APIs
    range: last 90 days
    queries:
      - stream: auth_logs | featurize_session (unique_users, failure_ratios, timing) | predict with GradientBoosting_model | if prediction in ('spraying', 'enumeration') then alert