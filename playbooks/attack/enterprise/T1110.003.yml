name: "T1110.003: Password Spraying"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps answer the question: Is the adversary attempting to gain account credentials using password spraying? It provides investigative methods to detect password spraying attempts by analyzing various indicators. These include observing authentication failures from IPs listed on threat intelligence feeds, detecting anomalous User-Agent strings, identifying a high number of Kerberos pre-authentication failures from a single source across many accounts, noting a high ratio of unique failed accounts to total attempts from one IP, correlating a successful login with a preceding series of failures from the same source, and detecting a statistically significant increase in the overall volume of authentication failures compared to historical baselines."
type: "technique"
related:
  - "TA0006: Credential Access"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are authentication failures or web requests originating from IP addresses on threat intelligence feeds or using user-agents associated with password spraying tools?"
    context: "This question helps detect initial spraying attempts by correlating authentication failure logs (Windows Event IDs 4625, 4771) and connection logs (Zeek conn.log) with high-confidence threat intelligence. It also checks for known malicious User-Agent strings in web traffic (Zeek http.log) to identify the use of specific attack tools. A positive match is a strong indicator of a targeted attack."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Threat Intelligence Feed"
      - "Internet gateway"
      - "Externally-facing web applications"
      - "Domain Controllers"
      - "VPN concentrators"
      - "Cloud Authentication Services (e.g., Azure AD, Okta)"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "FOR each auth failure or web request, GET source IP and user agent. CHECK source IP against CTI feed. CHECK user agent against known spraying tool list. IF match, ALERT."
  - question: "For an IP matched on a CTI feed, is it targeting an unusually diverse set of user accounts, suggesting a spraying pattern?"
    context: "This question aims to confirm a password spraying attempt after an initial CTI match. By calculating the Shannon entropy of usernames targeted by a suspicious IP within a short timeframe (15 minutes), we can quantify the randomness or diversity of the targets. A high entropy score, exceeding a statistical baseline (95th percentile), indicates the IP is not targeting one or two accounts but spraying across many, which is a hallmark of this attack."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Threat Intelligence Feed"
      - "Internet gateway"
      - "Externally-facing web applications"
      - "Domain Controllers"
      - "VPN concentrators"
      - "Cloud Authentication Services (e.g., Azure AD, Okta)"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "ON CTI IP match, GET all usernames targeted by IP in last 15 mins. CALCULATE Shannon entropy of unique usernames. IF entropy > baseline_95th_percentile, ALERT."
  - question: "Can we classify external authentication attempts as malicious in real-time based on their characteristics?"
    context: "This question explores a proactive, probabilistic approach to detection. By using a machine learning model (e.g., Logistic Regression) to score each external authentication attempt based on features like IP reputation, ASN, geolocation, time of day, and User-Agent prevalence, the system can identify and alert on attempts classified as 'malicious' with high probability, potentially stopping an attack in progress."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Threat Intelligence Feed"
      - "Internet gateway"
      - "Externally-facing web applications"
      - "Domain Controllers"
      - "VPN concentrators"
      - "Cloud Authentication Services (e.g., Azure AD, Okta)"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "FOR each external auth attempt, CREATE feature vector (IP reputation, ASN, geo, time, User-Agent). SCORE with ML model. IF score > threshold, ALERT."
  - question: "Has a single source IP address generated a high number of Kerberos pre-authentication failures (0x18) across many different accounts in a short time?"
    context: "This question provides a simple but effective rule to detect a clear password spraying pattern against Kerberos. It looks for a single source IP address that generates Windows Event ID 4771 with Failure Code '0x18' (indicating pre-authentication failed) for more than 10 distinct user accounts within a 5-minute window. This hard-coded threshold is designed to catch obvious spraying activity with high confidence."
    answer_sources:
      - "Windows Event ID 4771"
      - "Domain Controllers"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "COUNT distinct users with Event 4771/Code 0x18 from a single IP in 5 mins. IF count > 10, ALERT."
  - question: "Is any single source IP responsible for an anomalously high number of distinct accounts failing Kerberos pre-authentication compared to a baseline?"
    context: "This question uses a statistical approach instead of a fixed threshold. It filters for Kerberos pre-authentication failures (Event ID 4771, Code '0x18'), groups them by source IP, and counts the distinct target accounts over a 10-minute sliding window. By comparing this count to a baseline distribution of normal activity, it can alert when a source IP's activity exceeds the 99th percentile, indicating an anomalously broad and suspicious targeting pattern."
    answer_sources:
      - "Windows Event ID 4771"
      - "Domain Controllers"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "FOR each source IP, COUNT distinct users with Event 4771/Code 0x18 over 10 mins. IF count > 99th_percentile_baseline, ALERT."
  - question: "Can we identify clusters of Kerberos pre-authentication failures that indicate a coordinated password spraying attack?"
    context: "This question applies unsupervised machine learning (e.g., DBSCAN) to detect attacks. By streaming Kerberos failure events (Event ID 4771, Code '0x18') into a clustering model, we can group events based on features like source IP and target account. A dense cluster identified by the model, characterized by a single source IP and a high number of unique target accounts, represents a password spraying attack with high confidence."
    answer_sources:
      - "Windows Event ID 4771"
      - "Domain Controllers"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "STREAM Event 4771/Code 0x18 to DBSCAN model. FEATURES: source IP, timestamp, target account hash. IF dense cluster with single IP and many accounts is found, ALERT."
  - question: "Is a single source IP causing authentication failures for a large number of unique user accounts within a 15-minute window?"
    context: "This question poses a straightforward threshold-based rule for detecting less stealthy NTLM or Kerberos spraying attacks. It triggers an alert if a single source IP is responsible for failed authentications (Windows Event ID 4625) for more than 20 unique user accounts within a 15-minute period. This simple threshold is effective at catching noisy or unsophisticated spray attacks."
    answer_sources:
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Domain Controllers"
      - "Member Servers"
      - "VPN concentrators"
      - "Any server accepting network logons"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "COUNT distinct users with Event 4625 from a single IP in 15 mins. IF count > 20, ALERT."
  - question: "Is a source IP exhibiting both a high count of distinct failed accounts and a high ratio of distinct accounts to total attempts?"
    context: "This question refines detection by looking for two conditions highly characteristic of password spraying: breadth (many distinct accounts) and depth (few attempts per account). By calculating the distinct account count and the ratio of distinct accounts to total attempts for each source IP, we can alert when an IP exceeds a statistical baseline (98th percentile) for the count and has a high ratio (e.g., > 0.8). This helps reduce false positives from legitimate users making multiple failed login attempts."
    answer_sources:
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Domain Controllers"
      - "Member Servers"
      - "VPN concentrators"
      - "Any server accepting network logons"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "FOR each IP in 30 mins, CALC distinct_failed_users and ratio = distinct_failed_users / total_failures. IF distinct_failed_users > 98th_percentile AND ratio > 0.8, ALERT."
  - question: "Does the pattern of authentication failures from a source IP appear anomalous when compared to normal network traffic?"
    context: "This question leverages an anomaly detection model (e.g., Isolation Forest) to find subtle attack patterns. A feature vector is created for each source IP over a 15-minute window, including counts of different failure events, unique account counts, and the standard deviation of time between attempts. The model, trained on normal traffic, assigns an anomaly score. Scores exceeding a threshold indicate a high likelihood of password spraying."
    answer_sources:
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Domain Controllers"
      - "Member Servers"
      - "VPN concentrators"
      - "Any server accepting network logons"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "FOR each IP in 15 mins, CREATE feature vector (failure counts, unique account counts, time deviation). SCORE with Isolation Forest model. IF score > threshold, ALERT."
  - question: "Has a successful login occurred from an IP address that was recently responsible for numerous failed logins against other accounts?"
    context: "This is a critical question for identifying a successful password spray. It uses a stateful rule that directly links a pattern of failures to a subsequent success. A high-severity alert is triggered when a source IP generates more than 10 failed logins (Event ID 4625/4771) across distinct accounts and then has a successful login (Event ID 4624) within 30 minutes. This provides a high-confidence alert and identifies the compromised account."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "Member Servers"
      - "VPN concentrators"
      - "Endpoints"
      - "Externally-facing web applications"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "IF a source IP has >10 distinct failed logins (4625/4771) AND a successful login (4624) within 30 mins, ALERT on success."
  - question: "Has a successful authentication originated from an IP that is on a watchlist for recent suspicious failed login activity?"
    context: "This question describes a stateful, statistical approach to confirming a compromise. A state table or watchlist is maintained for source IPs that have recently exceeded a statistical threshold for failed authentications (e.g., 95th percentile of distinct failed accounts). When a successful authentication (Event ID 4624) occurs, the source IP is checked against this watchlist. A match escalates the event as a high-confidence successful password spray."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "Member Servers"
      - "VPN concentrators"
      - "Endpoints"
      - "Externally-facing web applications"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "MAINTAIN watchlist of IPs with high failure rates. ON successful login (4624), CHECK if source IP is on watchlist. IF yes, ALERT."
  - question: "Does the sequence of authentication events (failures and successes) from a source IP appear anomalous?"
    context: "This question uses sequence-aware algorithms (e.g., HMM, LSTM) to analyze the narrative of an authentication session. The model is trained on benign sequences of events. An attack sequence, characterized by a high volume of failures across many accounts followed by a sudden success, will be recognized by the model as a low-probability, anomalous sequence, thus triggering an alert."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Zeek conn.log"
      - "Domain Controllers"
      - "Member Servers"
      - "VPN concentrators"
      - "Endpoints"
      - "Externally-facing web applications"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "MODEL auth event sequences per IP with LSTM/HMM. IF model flags a sequence of (many failures -> 1 success) as anomalous, ALERT."
  - question: "Has the overall volume of authentication failures across the entire network exceeded a critical, pre-defined threshold?"
    context: "This question proposes a 'tripwire' rule for detecting large-scale, noisy attacks. It sets a high, fixed threshold for the total count of authentication failures (Windows Event IDs 4625 and 4771) across all domain controllers within a given timeframe (e.g., 5000 events in 1 hour). While not subtle, it serves as an effective last-resort detector for a massive password spraying campaign that might otherwise be missed."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Internet gateway"
      - "Domain Controllers"
      - "VPN concentrators"
      - "Network backbone sensors"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "SUM all 4625 and 4771 events across network over 1 hour. IF sum > 5000, ALERT."
  - question: "Is the current hourly count of authentication failures statistically unusual when compared to a historical, seasonal baseline?"
    context: "This question moves beyond a fixed threshold to a more intelligent statistical one. It aggregates authentication failure counts into hourly bins and creates a baseline model that accounts for normal business cycles (seasonality). An alert is triggered if the current hour's count exceeds the forecasted value by a significant margin (e.g., more than 3 standard deviations of the model's error), indicating a statistically significant anomaly."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Internet gateway"
      - "Domain Controllers"
      - "VPN concentrators"
      - "Network backbone sensors"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "MODEL hourly auth failure counts with seasonality. FORECAST expected count for current hour. IF actual_count > (forecast + 3*stdev), ALERT."
  - question: "Does the observed volume of authentication failures or failed connection attempts fall outside the predicted range of a time-series forecasting model?"
    context: "This question describes the most sophisticated approach to volume-based detection. It uses advanced time-series forecasting models (e.g., Prophet, SARIMA) trained on at least 90 days of historical data to predict the expected volume of failures for the next interval. If the observed volume falls outside the model's prediction interval (e.g., 99% confidence), it triggers an alert, indicating a statistically significant and unexpected event."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 4625"
      - "Windows Event ID 4771"
      - "Internet gateway"
      - "Domain Controllers"
      - "VPN concentrators"
      - "Network backbone sensors"
    range: "last 90 days"
    queries:
      - search_technology: "pseudocode"
        query: "TRAIN SARIMA/Prophet model on 90-day history of auth failure counts. FORECAST next interval with 99% confidence interval. IF observed_count is outside interval, ALERT."