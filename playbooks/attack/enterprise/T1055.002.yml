name: "T1055.002: Portable Executable Injection"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps investigate whether an adversary has used Portable Executable (PE) injection to escalate privileges or evade defenses. PE injection involves introducing code into the address space of a separate live process. This is a common technique used to bypass security controls, escalate privileges by running code in a higher-privilege context, and masquerade malicious activity under a legitimate process. Indicators include the creation of remote threads in atypical source-target process pairs, execution of files matching known IOCs for injection tools, processes with command-line arguments specifying target PIDs, anomalous parent-child process relationships, and core system processes exhibiting unusual network or process creation behavior. Evasion indicators may include trusted processes making suspicious network connections (e.g., to newly registered domains or known C2 servers), spawning unusual child processes (e.g., command shells), or exhibiting C2-like network beaconing."
type: "technique"
related:
  - "TA0004: Privilege Escalation"
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Has a remote thread been created in a critical system process by an untrusted source?"
    context: "A common method of PE injection involves a process creating a remote thread in a high-privilege target process, such as 'lsass.exe' or 'services.exe'. Identifying instances where the source process is not a standard system utility (e.g., not located in 'C:\\Windows\\System32\\') provides a high-fidelity signal for this malicious activity."
    answer_sources:
      - "Sysmon Event ID 8"
      - "Windows Event ID 4688"
      - "All Windows Endpoints and Servers, especially Privileged Access Workstations (PAWs) and Domain Controllers."
    range: "last 90 days"
    queries:
      - "SEARCH Sysmon (EventID=8) WHERE (SourceImage NOT IN ('C:\\Windows\\System32\\*') AND TargetImage IN ('lsass.exe', 'services.exe', 'wininit.exe', 'csrss.exe')) | CREATE_ALERT HighSeverity"
  - question: "Have any statistically rare remote thread creation events occurred?"
    context: "Attackers may use novel source-to-target process combinations for remote thread creation to evade simple signature-based rules. By establishing a baseline of all 'CreateRemoteThread' events across the enterprise, analysts can identify statistically rare pairs that warrant manual review, potentially uncovering new or targeted attack patterns."
    answer_sources:
      - "Sysmon Event ID 8"
      - "Windows Event ID 4688"
      - "All Windows Endpoints and Servers, especially Privileged Access Workstations (PAWs) and Domain Controllers."
    range: "last 90 days"
    queries:
      - "SEARCH Sysmon (EventID=8) | STATS count by SourceImage, TargetImage | WHERE count < 5 OR is_outlier | REVIEW_MANUALLY"
  - question: "Can a machine learning model identify high-risk remote thread creation events indicative of PE injection?"
    context: "To move beyond simple rules, a classification model can analyze multiple features of a remote thread creation event (e.g., source/target paths, user context, reputation of the start function address) to generate a holistic risk score. This approach helps prioritize the most suspicious events that are likely to be malicious PE injection."
    answer_sources:
      - "Sysmon Event ID 8"
      - "Windows Event ID 4688"
      - "All Windows Endpoints and Servers, especially Privileged Access Workstations (PAWs) and Domain Controllers."
    range: "last 90 days"
    queries:
      - "INPUT Sysmon (EventID=8) | APPLY_ML_MODEL (features=[SourceImage, TargetImage, User, StartFunction]) | CREATE_ALERT where score > threshold"
  - question: "Has a process been created from an executable matching a known malicious hash associated with injection tools?"
    context: "Adversaries often reuse known malware droppers, loaders, or frameworks like Cobalt Strike that perform PE injection. Correlating file hashes from process creation events with a threat intelligence feed of known IOCs is a direct method to detect the use of these malicious tools in the environment."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Domain Controllers, Privileged Access Workstations (PAWs), Critical Application Servers, general user endpoints."
    range: "last 90 days"
    queries:
      - "SEARCH ProcessLogs (EventID=1 OR EventID=4688) | LOOKUP ThreatIntel on FileHash | WHERE ThreatIntel.tag IN ('injector', 'loader', 'Cobalt Strike') | CREATE_ALERT"
  - question: "Has a rare process been executed from a user-writable directory?"
    context: "Attackers often place custom or packed executables in non-standard, user-writable locations like 'C:\\Temp\\' or '%APPDATA%'. Identifying processes whose file hash is rare across the enterprise and that execute from these directories can help uncover suspicious binaries that may be used for PE injection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Domain Controllers, Privileged Access Workstations (PAWs), Critical Application Servers, general user endpoints."
    range: "last 90 days"
    queries:
      - "SEARCH ProcessLogs | STATS prevalence(FileHash) | WHERE prevalence < 0.1% AND FilePath IN ('C:\\Users\\Public\\*', 'C:\\Temp\\*', '%APPDATA%\\*') | CREATE_ALERT MediumPriority"
  - question: "Can a machine learning model identify malicious process creations that subsequently access high-privilege processes?"
    context: "This approach combines two key investigative steps. First, a machine learning model flags a newly created process as potentially malicious based on its features. Second, this suspicion is confirmed and its priority elevated if that same process is then observed accessing a sensitive process like 'lsass.exe' (via Sysmon Event ID 10), a common target for credential theft post-injection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Domain Controllers, Privileged Access Workstations (PAWs), Critical Application Servers, general user endpoints."
    range: "last 90 days"
    queries:
      - "INPUT ProcessLogs | APPLY_ML_MODEL (features=[FilePath, ParentProcess, User, CommandLine]) | IF score > threshold AND process accesses('lsass.exe') | ELEVATE_PRIORITY"
  - question: "Are there any processes being executed with command-line arguments that indicate an attempt to inject into another process?"
    context: "Injection tools are often invoked with specific command-line arguments, such as a flag to specify the target Process ID (PID). Scanning process creation logs for these patterns (e.g., '--pid 1234') or for the misuse of legitimate utilities like 'rundll32.exe' can directly reveal the execution of an injection tool."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All Windows Endpoints and Servers."
    range: "last 90 days"
    queries:
      - "SEARCH ProcessLogs | REGEX CommandLine on ('--pid [0-9]+', '/pid:[0-9]+', 'rundll32.exe ...') | CREATE_ALERT"
  - question: "Have any statistically rare or anomalous parent-child process relationships been observed?"
    context: "Malicious injection can lead to unnatural process behaviors, such as a non-interactive service ('services.exe') spawning an interactive command shell ('cmd.exe'). By baselining normal parent-child process relationships, analysts can flag statistically rare pairs that deviate from expected system behavior and indicate compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All Windows Endpoints and Servers."
    range: "last 90 days"
    queries:
      - "SEARCH ProcessLogs | STATS frequency(ParentProcess, ChildProcess) | WHERE frequency < 1st_percentile AND ChildProcess IN ('cmd.exe', 'powershell.exe') | CREATE_ALERT"
  - question: "Has an unusual sequence of child processes been spawned by a common parent process?"
    context: "After injecting code, an adversary often executes a sequence of discovery commands (e.g., 'whoami.exe', 'net.exe'). A sequence analysis model can learn the normal chains of child processes for a given parent and flag significant deviations, such as 'explorer.exe' spawning a PowerShell script that then runs 'net.exe', as a potential post-injection attack chain."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All Windows Endpoints and Servers."
    range: "last 90 days"
    queries:
      - "INPUT ProcessLogs | APPLY_SEQUENCE_MODEL on child_process_sequence | IF sequence_is_anomalous | CREATE_ALERT"
  - question: "Has a core system process, which should not have network access or spawn children, initiated a network connection or created a child process?"
    context: "Core Windows processes like 'lsass.exe', 'wininit.exe', and 'csrss.exe' have extremely predictable, constrained behaviors. Any deviation, such as initiating an outbound network connection or spawning a child process, is a high-confidence indicator that the process has been compromised via injection."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "Network Egress Points (Firewalls/Gateways), Critical System Servers (e.g., Domain Controllers)."
    range: "last 90 days"
    queries:
      - "SEARCH (NetworkLogs OR ProcessLogs) WHERE ProcessName IN ('lsass.exe', 'csrss.exe', 'wininit.exe') AND (is_outbound_connection OR has_child_process) | CREATE_ALERT Critical"
  - question: "Has a critical process like 'svchost.exe' exhibited anomalous network behavior, such as connecting to a low-reputation destination or transferring an unusual amount of data?"
    context: "While some system processes like 'svchost.exe' are expected to make network connections, this activity is generally predictable. By baselining this behavior, analysts can use percentile-based thresholds to detect outliers, such as a connection to a risky IP or an unusually large data transfer, which may indicate C2 or exfiltration from an injected thread."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "Network Egress Points (Firewalls/Gateways), Critical System Servers (e.g., Domain Controllers)."
    range: "last 90 days"
    queries:
      - "SEARCH NetworkLogs WHERE ProcessName='svchost.exe' | IF destination_reputation < 5th_percentile OR data_volume > 99th_percentile | CREATE_ALERT"
  - question: "Can a multi-feature anomaly detection model identify suspicious network activity from critical system processes?"
    context: "Rather than relying on single-feature thresholds, an anomaly detection model like an Isolation Forest can analyze a combination of network features (process name, destination port, protocol, bytes sent) simultaneously. This allows it to identify subtle, complex deviations from normal behavior that are indicative of malicious activity within a critical process."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "Network Egress Points (Firewalls/Gateways), Critical System Servers (e.g., Domain Controllers)."
    range: "last 90 days"
    queries:
      - "INPUT (ProcessLogs, NetworkLogs) | APPLY_ANOMALY_MODEL (features=[process, port, protocol, bytes]) | IF is_anomaly | CREATE_ALERT"
  - question: "Has a trusted process, not typically used for browsing, connected to a known malicious domain or IP address?"
    context: "To evade detection, adversaries inject into legitimate processes like 'notepad.exe' or 'svchost.exe' to blend their C2 traffic with normal system activity. Alerting when these non-browsing processes connect to destinations on a threat intelligence list helps to unmask this masquerading behavior."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Sysmon Event ID 3"
      - "Network Egress Points, DNS Resolvers, Web Proxies, Host-based network sensors."
    range: "last 90 days"
    queries:
      - "SEARCH NetworkLogs WHERE ProcessName IN ('svchost.exe', 'notepad.exe') | LOOKUP ThreatIntel on DestinationIP | WHERE ThreatIntel.is_malicious | CREATE_ALERT HighPriority"
  - question: "Has a trusted process connected to a newly registered or algorithmically generated domain?"
    context: "Adversaries frequently use newly registered domains (NRDs) or employ domain generation algorithms (DGAs) for their C2 infrastructure. A trusted process connecting to a domain that was registered within the last 30 days or has a high-entropy name is highly suspicious and deviates from normal behavior, where processes connect to established, well-known domains."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Sysmon Event ID 3"
      - "Network Egress Points, DNS Resolvers, Web Proxies, Host-based network sensors."
    range: "last 90 days"
    queries:
      - "SEARCH NetworkLogs | IF (domain_age < 30_days OR domain_entropy > 3.5) AND ProcessName IS trusted | CREATE_ALERT"
  - question: "Has a trusted process shown a sudden spike in data transfer volume to a low-reputation domain?"
    context: "A sudden, anomalous increase in the volume of data sent from a trusted process to a low-reputation domain can be a sign of data exfiltration. A time-series anomaly detection model can monitor for these spikes, which deviate from the forecasted baseline of normal activity, indicating potential data theft from an injected process."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Sysmon Event ID 3"
      - "Network Egress Points, DNS Resolvers, Web Proxies, Host-based network sensors."
    range: "last 90 days"
    queries:
      - "INPUT DataVolume from trusted_process to low_rep_domain | APPLY_TIMESERIES_MODEL | IF spike_is_anomaly | CREATE_ALERT"
  - question: "Has a document-handling or office application spawned a command shell or a living-off-the-land binary?"
    context: "It is highly anomalous for processes like 'WINWORD.EXE' or 'outlook.exe' to spawn child processes such as 'cmd.exe', 'powershell.exe', or known LOLBins. This behavior is a classic indicator of malicious code execution, often stemming from a malicious macro or an exploited vulnerability, leading to further actions on the host."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "User Workstations, Application Servers, Virtual Desktop Infrastructure (VDI)."
    range: "last 90 days"
    queries:
      - "SEARCH ProcessLogs WHERE ParentProcess IN ('WINWORD.EXE', 'explorer.exe', 'outlook.exe') AND ChildProcess IN ('cmd.exe', 'powershell.exe', 'net.exe', 'whoami.exe') | CREATE_ALERT"
  - question: "Has a trusted process spawned a child with a highly obfuscated or complex command line?"
    context: "Attackers use command-line obfuscation to hide their payloads from signature-based defenses. Calculating the Shannon entropy of command-line arguments can quantify this complexity. A command with an entropy score significantly higher than the baseline for that parent-child pair suggests obfuscation and malicious intent."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "User Workstations, Application Servers, Virtual Desktop Infrastructure (VDI)."
    range: "last 90 days"
    queries:
      - "SEARCH ProcessLogs | CALCULATE entropy(CommandLine) | IF entropy > 95th_percentile for parent-child pair | CREATE_ALERT"
  - question: "Has a command-line interpreter been executed with an unusual syntax or combination of arguments?"
    context: "Advanced attackers may use legitimate tools like PowerShell with unusual argument combinations or syntax to evade detection. A machine learning model trained on the structure of normal command lines can identify these 'grammatically' strange but valid commands, flagging them as potential abuse that would be missed by simple pattern matching."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "User Workstations, Application Servers, Virtual Desktop Infrastructure (VDI)."
    range: "last 90 days"
    queries:
      - "INPUT CommandLine | APPLY_NLP_MODEL | IF command_structure_is_anomalous | CREATE_ALERT"
  - question: "Is a trusted process making a TLS connection using a self-signed or mismatched certificate?"
    context: "Adversaries often use self-signed SSL/TLS certificates for their C2 infrastructure as a low-cost way to encrypt traffic. A trusted process making a TLS connection where the certificate is self-signed, or where the certificate's common name does not match the server name, is a strong signal of a connection to a malicious endpoint."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Sysmon Event ID 3"
      - "Network Egress Points, Correlated Host Logs."
    range: "last 90 days"
    queries:
      - "SEARCH SSL_Logs | WHERE (is_self_signed OR subject_cn != sni) AND ProcessName IS trusted | CREATE_ALERT"
  - question: "Is a process exhibiting periodic, low-jitter network beaconing, especially using a rare JA3/JA3S hash?"
    context: "Malicious implants often beacon back to their C2 server at regular intervals, resulting in a low standard deviation (jitter) in the time between connections. Combining this temporal analysis with the rarity of the connection's JA3/JA3S fingerprint (which profiles the TLS client) creates a high-fidelity signature for automated C2 communication."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Sysmon Event ID 3"
      - "Network Egress Points, Correlated Host Logs."
    range: "last 90 days"
    queries:
      - "SEARCH NetworkLogs | CALCULATE time_delta_stddev per (host, process, dest) | IF stddev < 2s AND prevalence(JA3_hash) < 1% | CREATE_ALERT"
  - question: "Does a process have a cluster of network activity that is anomalous compared to its normal behavior?"
    context: "By applying a clustering algorithm like DBSCAN to network connection metadata, we can group all of a process's connections into clusters of similar behavior. Normal activity forms a large, dense cluster, while malicious C2 or exfiltration will likely appear as a distinct, small outlier cluster that can be automatically flagged for investigation."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Sysmon Event ID 3"
      - "Network Egress Points, Correlated Host Logs."
    range: "last 90 days"
    queries:
      - "INPUT NetworkLogs per process | APPLY DBSCAN(features=[duration, bytes, port, JA3]) | IF cluster is outlier | INVESTIGATE_CLUSTER"
  - question: "Has the 'dropper -> injection -> beacon' sequence of events been observed on a single host?"
    context: "This question hunts for the full attack lifecycle on a single host within a short time window. Detecting the correlated sequence of (1) an initial access process, (2) a short-lived dropper that downloads a file, and (3) a persistent, legitimate process beginning to beacon to a new domain provides a high-confidence alert of a successful compromise via injection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "User Workstations, Email Gateway Servers, Web Proxy Servers."
    range: "last 90 days"
    queries:
      - "CORRELATE events on host | FIND SEQUENCE: (outlook.exe -> child_A), (child_A downloads file AND terminates < 60s), (explorer.exe starts beaconing to new domain within 2 mins) | CREATE_ALERT"
  - question: "Has a host experienced a sudden spike in the creation of short-lived processes, followed by anomalous activity?"
    context: "A sudden burst in the rate of short-lived processes (e.g., those lasting less than 60 seconds) can indicate the execution of a malicious script or a series of setup commands. Using change point detection to identify such a burst and then analyzing the subsequent network and process activity on that host can reveal the compromise that follows."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "User Workstations, Email Gateway Servers, Web Proxy Servers."
    range: "last 90 days"
    queries:
      - "INPUT count(short_lived_processes) per host over time | APPLY ChangePointDetection | IF change_point_detected | ANALYZE subsequent activity for anomalies"
  - question: "Can a stateful model (HMM) classify a host's threat state as 'Injected' based on a sequence of observed events?"
    context: "A Hidden Markov Model (HMM) is well-suited for this problem because it can infer a hidden state (e.g., 'Benign', 'Injected') from a sequence of observable events (process creations, network connections). By training the model on known attack scenarios, it can learn to classify the real-time threat state of a host, providing a probabilistic assessment of compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "User Workstations, Email Gateway Servers, Web Proxy Servers."
    range: "last 90 days"
    queries:
      - "INPUT event_stream per host | APPLY HMM_Classifier | IF current_state='Injected' | CREATE_ALERT"