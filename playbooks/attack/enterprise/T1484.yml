name: T1484: Domain or Tenant Policy Modification
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: "This playbook addresses the adversary technique of modifying domain or tenant policies to escalate privileges and evade defenses. Adversaries may alter Group Policy Objects (GPOs) to execute malicious scripts, grant themselves sensitive user rights (like SeDebugPrivilege), or change federation settings in hybrid cloud environments to gain unauthorized access. This playbook also covers defense evasion tactics, such as using GPOs to add exclusions for security tools, disable audit logging, or deploy scripts that tamper with security controls like AMSI. The investigative questions focus on detecting these modifications through symbolic rules, statistical anomalies, and machine learning models, covering changes to GPO scripts, user rights assignments, critical policies, audit configurations, and federation trusts."
type: technique
related:
  - TA0004: Privilege Escalation
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there GPO modifications that introduce scripts or tasks containing known malicious indicators?
    context: This question seeks to identify if an adversary has embedded malicious content directly into a Group Policy Object. By parsing GPO modification events (like Windows Event IDs 5136 and 5137) and extracting observables such as file paths, domains, IPs, and commands from scripts or scheduled tasks, we can compare them against threat intelligence. A match indicates a likely attempt to use GPOs for malicious code execution.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5137, Windows Event ID 4688, Zeek conn.log, Zeek http.log from Domain Controllers, All Domain-joined Endpoints and Servers, Network Egress Points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH GPO modification events (EID 5136, 5137). EXTRACT file paths, domains, IPs, commands from script/task content. JOIN extracted values with threat intelligence feed. ALERT on match.
  - question: Have any GPO script modifications exhibited unusually high entropy, suggesting obfuscation?
    context: Adversaries often obfuscate or pack their malicious scripts to evade signature-based detection. This question aims to detect such activity by measuring the Shannon entropy of scripts introduced via GPO modifications. A script with an entropy score significantly higher than the established baseline for legitimate scripts in the environment is a strong indicator of obfuscation and warrants investigation.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5137, Windows Event ID 4688, Zeek conn.log, Zeek http.log from Domain Controllers, All Domain-joined Endpoints and Servers, Network Egress Points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each modified GPO script CALCULATE Shannon entropy. IF entropy > 95th_percentile_of_baseline ALERT.
  - question: Can a machine learning model classify any recent GPO modifications as likely malicious?
    context: This question leverages a machine learning model to identify malicious GPO modifications based on a combination of features that might not be suspicious in isolation. By training a classifier on features like script length, keyword frequency (e.g., 'Invoke-Expression'), entropy, and the context of the change (modifying account, time of day), the model can provide a probabilistic score of maliciousness, helping to uncover more subtle attacks.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5137, Windows Event ID 4688, Zeek conn.log, Zeek http.log from Domain Controllers, All Domain-joined Endpoints and Servers, Network Egress Points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each GPO modification EXTRACT features (script length, keywords, entropy, account, time). INPUT features into trained ML model. IF model_output_probability > 0.85 ALERT.
  - question: Have any GPO modifications granted sensitive user rights to unauthorized accounts?
    context: This question checks for a classic privilege escalation technique where an adversary modifies a GPO to grant powerful user rights (e.g., SeBackupPrivilege, SeDebugPrivilege) to a user or group they control. By monitoring GPO modification events (Windows Event ID 5136) for changes to the 'gPCUserRightsAssignment' attribute and comparing the assigned principal against an allow-list of administrators, we can detect unauthorized privilege grants.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, Organizational Units (OUs) containing high-value systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH GPO modification events (EID 5136) where attribute is 'gPCUserRightsAssignment'. EXTRACT principal and right. IF principal is NOT in admin_allow_list AND right IS in sensitive_rights_watchlist ALERT.
  - question: Has there been a statistically anomalous increase in the number of principals assigned a sensitive user right?
    context: Instead of targeting a single user, an adversary might grant a sensitive privilege to a large group of users to increase their footprint. This question aims to detect such widespread changes by baselining the number of principals assigned to each sensitive right. A sudden increase that is statistically significant (e.g., more than two standard deviations above the moving average) indicates an anomaly that requires investigation.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, Organizational Units (OUs) containing high-value systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each sensitive user right BASELINE count of assigned principals. IF current_count > (moving_average + 2 * std_dev) ALERT.
  - question: Does a graph-based model of Active Directory show anomalous new links between users and high-privilege GPOs?
    context: This question uses a graph model to represent the complex relationships within Active Directory. Users, groups, and GPOs are nodes, while memberships and links are edges. A machine learning model trained on this graph can identify structural anomalies, such as a new edge representing a non-standard user being granted high privileges via a GPO. This approach is effective at finding unusual relationships that might be missed by rule-based checks.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, Organizational Units (OUs) containing high-value systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: UPDATE Active Directory graph model with latest changes. RUN anomaly detection algorithm. IF new edge (user-GPO link) is flagged as low-probability anomaly ALERT.
  - question: Have any critical GPOs been modified by an unauthorized user account?
    context: Critical GPOs, like the Default Domain Policy, have a wide-ranging impact, and changes to them should be tightly controlled. This question focuses on enforcing this control by maintaining an allow-list of authorized administrators for a watchlist of critical GPOs. Any modification, creation, or link change event (Windows Event IDs 5136, 5137, 5139) on a watched GPO by an account not on the list should trigger an immediate alert.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5137, Windows Event ID 5139, Windows Event ID 5141 from Domain Controllers, Administrative Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH GPO events (EID 5136, 5137, 5139, 5141) on critical_GPO_watchlist. IF 'Subject User Name' is NOT in authorized_admin_list ALERT.
  - question: Have any authorized administrators modified GPOs at unusual times?
    context: Even legitimate administrators can have their accounts compromised. This question aims to detect such a scenario by baselining the normal working hours for each administrator's GPO modification activity. A modification that occurs at an unusual time (e.g., late at night or on a weekend), falling outside their typical activity pattern, could indicate that their account is being used by an adversary.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5137, Windows Event ID 5139, Windows Event ID 5141 from Domain Controllers, Administrative Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each GPO modification by authorized admin BASELINE activity by hour/day. IF modification_timestamp is outside 5th-95th percentile of baseline ALERT.
  - question: Has a one-class SVM model identified any GPO modifications as outliers from normal administrative behavior?
    context: This question employs a one-class SVM, a machine learning algorithm ideal for anomaly detection when you have a lot of 'normal' data and few or no examples of 'abnormal' data. The model is trained on legitimate GPO modification events, learning the complex patterns of normal behavior based on features like the account, target GPO, and time. Any new modification that the model classifies as an outlier is flagged as a suspicious deviation.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5137, Windows Event ID 5139, Windows Event ID 5141 from Domain Controllers, Administrative Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each GPO modification EXTRACT features (account, GPO DN, OU link, time). INPUT features into trained One-Class SVM model. IF model classifies as outlier ALERT.
  - question: Have any unauthorized changes been made to domain federation settings in Azure AD or on-premise ADFS?
    context: Modifying a domain's federation settings is a powerful technique for an adversary to gain persistent access to cloud resources. This question looks for this specific, high-impact activity by creating high-severity alerts for rare events like 'Set federation settings on domain' in Azure AD audit logs or the creation of a new Claims Provider Trust on-premise (Windows Event ID 510). Any such occurrence is a critical incident requiring immediate investigation.
    answer_sources:
      - Windows Event ID 307, Windows Event ID 510, Azure AD Audit Logs from Active Directory Federation Services (ADFS) Servers, Identity Provider (IdP) infrastructure, Azure AD Tenant
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for Azure AD Audit log 'Set federation settings on domain' OR on-premise Event ID 510. ALERT on any occurrence.
  - question: Has there been any change to the domain's authentication method or trusted identity providers?
    context: Changes to domain authentication methods are extremely rare and should only occur during planned architectural changes. This question establishes a zero-tolerance baseline for these events. Any change from 'Managed' to 'Federated' authentication, or any addition of a new trusted identity provider URI that doesn't correspond to a planned change, is considered a critical anomaly and a potential sign of compromise.
    answer_sources:
      - Windows Event ID 307, Windows Event ID 510, Azure AD Audit Logs from Active Directory Federation Services (ADFS) Servers, Identity Provider (IdP) infrastructure, Azure AD Tenant
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE count of domain auth changes per month is 0. ALERT if count > 0. BASELINE set of trusted IdP URIs. ALERT if new URI is added without change request.
  - question: Does a state-change model show an unapproved transition in the domain's authentication state?
    context: This question models the domain's authentication configuration as a finite state machine, where states are 'Managed' or 'Federated' and the set of trusted providers. A machine learning model tracks transitions between these states. Any state transition that is not correlated with an approved change request ID from a change management system within a short time window is flagged as a high-confidence anomaly, strongly suggesting an unauthorized and malicious modification.
    answer_sources:
      - Windows Event ID 307, Windows Event ID 510, Azure AD Audit Logs from Active Directory Federation Services (ADFS) Servers, Identity Provider (IdP) infrastructure, Azure AD Tenant
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL domain auth as state machine. ON state transition CHECK for corresponding approved change request ID within 1 hour. IF no matching CR ALERT.
  - question: Have any GPO modifications added security tool exclusions for known malicious paths or processes?
    context: A common defense evasion tactic is to use GPOs to centrally deploy exclusions for security tools like Windows Defender, effectively blinding them to malicious activity. This question aims to detect this by parsing GPO modification events (Windows Event ID 5136) that alter registry keys for exclusions and matching the new exclusion against a list of known malicious file paths, process names, or extensions.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, All Domain-joined Endpoints and Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH GPO modification events (EID 5136) for security tool exclusion registry keys. EXTRACT exclusion value. JOIN value with threat intelligence feed. ALERT on match.
  - question: Has there been a statistically unusual number of GPO-based exclusion modifications?
    context: In a well-managed environment, changes to security tool exclusions should be infrequent. This question establishes a statistical baseline for the frequency of these modifications, which should be very low. Any significant spike in activity, such as a count exceeding the mean by several standard deviations, or even any modification at all in a 24-hour period, is anomalous and suggests a potential attempt to weaken security controls.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, All Domain-joined Endpoints and Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE frequency of GPO exclusion modifications. IF current_count > (mean + 3 * std_dev) in a 24h window ALERT.
  - question: Can a machine learning model classify any newly added exclusion paths as suspicious?
    context: Adversaries often place malware in user-writable, non-standard directories (e.g., %TEMP%, C:\Users\Public\) and then add exclusions for these paths. This question uses a text classification model to distinguish between benign exclusion paths (e.g., for a legitimate enterprise application in 'Program Files') and suspicious ones. The model analyzes features like path depth and the use of common temporary or public directories to flag suspicious exclusions for review.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, All Domain-joined Endpoints and Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new exclusion path INPUT path into text classification model. IF model classifies as 'suspicious' with high confidence ALERT.
  - question: Do any modified GPO scripts contain syntax known to disable security tools?
    context: This question looks for direct attempts to disable security defenses via scripts deployed through GPOs. By scanning the content of these scripts (from SYSVOL or PowerShell logs) with YARA rules, we can detect specific defense evasion techniques. These rules can identify patterns for bypassing AMSI, stopping ETW providers, or using commands to disable security products like Windows Defender, providing a high-fidelity signal of malicious intent.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141, Windows Event ID 4104 from Domain Controllers, All Domain-joined Endpoints and Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SCAN script content from modified GPOs and PowerShell logs (EID 4104) with YARA rules for defense evasion. ALERT on rule match.
  - question: Are any new GPO scripts highly dissimilar from the baseline of known-good administrative scripts?
    context: Adversarial scripts often have a different structure and use different commands than legitimate administrative scripts. This question quantifies this difference using the Jaccard similarity index. By comparing the tokenized content of a new GPO script to a baseline set of approved scripts, a low similarity score can highlight a script that is functionally and structurally different, indicating it may be malicious and requires further analysis.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141, Windows Event ID 4104 from Domain Controllers, All Domain-joined Endpoints and Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new GPO script TOKENIZE content. CALCULATE Jaccard similarity against baseline of good scripts. IF similarity_score < 10th_percentile ALERT.
  - question: Does an NLP-based model classify any GPO scripts as intended for defense evasion?
    context: This question uses a sophisticated Natural Language Processing (NLP) model trained specifically to understand the intent of PowerShell and other scripts. By analyzing the sequence of commands, arguments, and obfuscation patterns, the model can classify a script's purpose (e.g., 'reconnaissance', 'defense evasion', 'benign administration'). A classification of 'defense evasion' with high probability provides strong evidence of malicious activity.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141, Windows Event ID 4104 from Domain Controllers, All Domain-joined Endpoints and Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT GPO script content into trained NLP model. IF model classifies script as 'defense evasion' with high probability ALERT.
  - question: Have any GPO modifications disabled critical audit policy subcategories?
    context: To cover their tracks, adversaries may modify GPOs to disable security logging. This question detects this by defining a 'Golden Configuration' for essential audit policy settings (e.g., ensuring Process Creation auditing is enabled). By monitoring GPO modification events, any deviation from this known-good baseline, such as disabling a critical audit subcategory, will trigger an alert, indicating a potential attempt to tamper with logs.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, Organizational Units (OUs) with sensitive systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: DEFINE 'Golden Configuration' for audit policies. ON GPO modification event (EID 5136) COMPARE new policy with Golden Config. IF deviation (e.g., critical audit subcategory disabled) ALERT.
  - question: Has a GPO audit policy change been followed by a statistically significant drop in security event volume?
    context: This question seeks to find evidence that a GPO modification successfully disabled logging. It correlates a GPO audit policy change event with the subsequent volume of relevant security logs (e.g., Windows Event ID 4688 for process creation) from the systems affected by the GPO. A statistically significant drop in log volume, falling several standard deviations below the moving average, strongly suggests that the policy change was an effective and likely malicious act of log tampering.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, Organizational Units (OUs) with sensitive systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR log volume for critical events by OU. ON GPO audit policy change event IF subsequent log volume from target OU drops > 3 std_dev below moving average ALERT.
  - question: Has a time-series model detected an unexplainable drop in log volume that correlates with a GPO modification?
    context: This question uses a multivariate time-series model to learn the normal daily and weekly patterns of event logging for different host groups and event types. The model can distinguish between expected fluctuations (e.g., fewer logs on a weekend) and true anomalies. An unexplainable drop in log volume that occurs shortly after a GPO modification event is flagged as a correlated anomaly, providing high-confidence detection of successful log tampering.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers, Organizational Units (OUs) with sensitive systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN time-series model on log volumes by event ID and OU. ON GPO modification event (EID 5136) IF model flags a subsequent, unexplainable drop in log volume as an anomaly ALERT.
  - question: Has a 'flash' GPO modification occurred, where a policy was changed and quickly reverted?
    context: Adversaries may perform a 'flash' modification to a GPO—changing it to perform a malicious action and then quickly changing it back to its original state to avoid detection. This question is designed to catch this specific behavior. It works by caching GPO version numbers and alerting if a GPO is modified and then reverted to a previous version number within a short time window (e.g., 30 minutes).
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON GPO modification event (EID 5136) CACHE GPO GUID and version. IF another mod for same GUID occurs within 30 mins AND version reverts to cached value ALERT 'Flash GPO Modification'.
  - question: Has a GPO modification-reversion sequence occurred with an unusually short time delta?
    context: This question provides a statistical method for detecting 'flash' GPO modifications. It analyzes the time between consecutive modifications for the same GPO across the entire environment to establish a baseline distribution. A modification-reversion cycle that occurs much faster than normal administrative changes (e.g., in the bottom 5th percentile of time deltas) is flagged as a statistical anomaly, indicative of automated or hurried adversarial activity.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR all GPOs ANALYZE time delta between consecutive modifications to build a baseline. IF a mod-revert sequence has a time delta < 5th percentile of baseline ALERT.
  - question: Has a sequence analysis model detected an anomalous pattern of GPO-related actions?
    context: This question uses a sequence analysis model, like an LSTM autoencoder, to learn the normal sequences of administrative actions involving GPOs (e.g., 'modify -> link -> wait'). An anomalous sequence, such as 'modify -> wait 5 minutes -> revert', which doesn't fit learned patterns of legitimate administrative workflows, would be flagged by the model. This helps detect not just individual suspicious actions, but suspicious chains of events.
    answer_sources:
      - Windows Event ID 5136, Windows Event ID 5141 from Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN LSTM model on normal sequences of GPO-related admin actions. FEED new action sequences into the model. IF model flags a sequence (e.g., 'modify->revert') as an anomaly ALERT.