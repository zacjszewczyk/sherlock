name: T1003.003: NTDS
id: 5a9b8c7d-6e3f-4a1b-9c8d-7e6f5a4b3c2d
description: |
  This playbook helps investigate attempts by an adversary to access or exfiltrate a copy of the Active Directory NTDS database (ntds.dit) for credential theft. Evidence may include large network transfers from Domain Controllers, the execution of dumping utilities (like ntdsutil or vssadmin), direct unauthorized access to the ntds.dit file, suspicious creation of Volume Shadow Copies, or DCSync replication requests from non-domain controllers. The goal is to identify the various stages of NTDS theft, from creating a copy to its exfiltration.
type: technique
related:
  - TA0006: Credential Access
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a large file transfer (>500MB) been observed from a Domain Controller to an external IP, potentially containing the NTDS.dit database?
    context: |
      This question aims to detect the exfiltration of the Active Directory database (NTDS.dit). Adversaries may copy this file and transfer it off the network to perform offline credential cracking. A large, single-file transfer from a Domain Controller is highly anomalous. This specific query looks for connections over 500MB and tries to correlate them with file transfer logs that indicate the file being transferred is the NTDS database, even if it has been renamed using a GUID pattern.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek ssl.log
      - Network Egress Points
      - Internet Gateway
      - Domain Controller network interfaces
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH Zeek conn.log
          WHERE source_ip IS IN domain_controllers AND destination_ip IS external AND bytes_out > 500MB
          JOIN on transaction_id WITH Zeek files.log
          WHERE filename MATCHES ('ntds.dit', '*.dit', guid_pattern)
  - question: Has any outbound connection from a Domain Controller exceeded the established baseline for data transfer volume, especially to a new or unusual destination?
    context: |
      This question uses behavioral analytics to detect anomalous data transfers from Domain Controllers. Instead of a fixed threshold, it establishes a dynamic baseline of normal outbound traffic volume. An alert is triggered for any connection that is a statistical outlier (e.g., in the 99th percentile), which could indicate exfiltration of a large file like NTDS.dit. The check for a new destination ASN or country adds confidence that the activity is suspicious and not just a large but legitimate backup or update.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek ssl.log
      - Network Egress Points
      - Internet Gateway
      - Domain Controller network interfaces
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          CALCULATE 30-day baseline of bytes_out for each domain_controller.
          SEARCH Zeek conn.log in last 90 days
          WHERE source_ip IS IN domain_controllers
          AND bytes_out > 99th_percentile(baseline)
          ENRICH with ASN and country data.
          FLAG if destination_asn OR destination_country is new.
  - question: Has a machine learning model identified any outbound connection from a Domain Controller as having a high probability of being malicious egress?
    context: |
      This question leverages a machine learning model to provide a more sophisticated detection than simple rule-based alerts. By analyzing a combination of features (connection size, destination port, protocol, duration, IP reputation, JA3 hash, etc.), a classification model can learn the complex patterns of both normal and malicious traffic. An alert from this model indicates that a connection has many characteristics associated with known exfiltration techniques, providing a high-fidelity signal that warrants investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek ssl.log
      - Network Egress Points
      - Internet Gateway
      - Domain Controller network interfaces
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH for alerts from 'DC_Malicious_Egress_ML_Model'.
          FOR each alert, retrieve connection details:
            source_ip, destination_ip, destination_port, bytes_out, protocol, duration, ja3_hash
          ANALYZE features that contributed to high probability score.
  - question: Has a known NTDS dumping utility or suspicious script been executed on a Domain Controller?
    context: |
      This question looks for the direct execution of tools and commands commonly used to dump the NTDS database. By monitoring for specific process names (ntdsutil.exe, vssadmin.exe) and command-line arguments ('ifm', 'create shadow', 'secretsdump.py', etc.) on Domain Controllers, analysts can catch explicit attempts to create a copy of the credential database. Monitoring PowerShell script blocks (Event ID 4104) is crucial as adversaries often use fileless, script-based versions of these tools.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH Event ID (4688, 1, 4104) from domain_controllers
          WHERE (ProcessName IN ('ntdsutil.exe', 'vssadmin.exe', 'powershell.exe'))
          AND (CommandLine CONTAINS ('ifm', 'create shadow', 'secretsdump.py', 'Invoke-NinjaCopy', 'Invoke-DCSync', 'Copy-VSS'))
  - question: Has the command-line entropy on a Domain Controller anomalously spiked for common processes like powershell.exe?
    context: |
      This question seeks to identify obfuscated commands, a common adversary tactic. Adversaries often use heavy obfuscation within PowerShell or command prompt to hide malicious activity. Calculating the Shannon entropy of command-line arguments for generic processes can reveal this. A command with an entropy score significantly higher than the baseline is likely obfuscated and warrants investigation, especially if it contains suspicious keywords related to NTDS.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          CALCULATE baseline Shannon entropy for command lines on DCs.
          SEARCH Event ID (4688, 1) from domain_controllers
          WHERE ProcessName IN ('powershell.exe', 'cmd.exe')
          AND shannon_entropy(CommandLine) > 95th_percentile(baseline)
          AND CommandLine CONTAINS ('NTDS', 'SystemRoot', 'dit')
  - question: Has an anomalous parent-child process relationship, such as a web server process spawning ntdsutil.exe, been observed on a Domain Controller?
    context: |
      This question looks for unusual process creation chains, which can indicate that a compromised service or application is being used to launch an attack. Legitimate processes on a Domain Controller have predictable parent-child relationships. An anomaly, such as a web server process (w3wp.exe) or an interactive logon spawning a credential dumping tool, deviates from this normal behavior and is a strong indicator of compromise. A sequence analysis model like an LSTM can be trained to detect these anomalous chains.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH for alerts from 'DC_Process_Chain_Anomaly_Model'.
          FOR each alert, retrieve parent_process, child_process, and command_line.
          INVESTIGATE the parent process to determine the initial point of compromise.
  - question: Has an unauthorized process accessed the ntds.dit file on a Domain Controller?
    context: |
      This question focuses on detecting direct, unauthorized access to the NTDS.dit file itself. After enabling object access auditing (SACL) on the file, any read attempt will generate an event. By creating an allowlist of legitimate processes (like lsass.exe, System, and approved backup agents), analysts can be alerted to any other process attempting to read the file, which is a strong indicator of compromise. Monitoring for file creation events with a '.dit' extension outside the normal directory can also catch attempts to save a copy elsewhere.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Domain Controller file systems, specifically the %SystemRoot%\NTDS\ directory
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH Event ID 4663 from domain_controllers
          WHERE ObjectName ENDS WITH '\NTDS\ntds.dit'
          AND ProcessName NOT IN (allowlist: 'lsass.exe', 'System', 'dfm.exe', etc.)
          UNION
          SEARCH Sysmon Event ID 11
          WHERE TargetFilename ENDS WITH '.dit'
          AND TargetFilename NOT IN ('%SystemRoot%\NTDS\ntds.dit')
  - question: Has a new or unusual user account and process combination been observed accessing the ntds.dit file?
    context: |
      This question uses behavioral analysis to detect anomalous access to the NTDS.dit file. By establishing a baseline of which users and processes normally access the file, any new combination can be flagged as suspicious. This can catch, for example, a legitimate backup agent being run under a compromised user account. Further risk-scoring by time of day can help differentiate between scheduled, legitimate activity (e.g., a backup running in its designated window) and unscheduled, potentially malicious access.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Domain Controller file systems, specifically the %SystemRoot%\NTDS\ directory
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          CREATE 30-day baseline of unique (ProcessName, SubjectUserName) tuples accessing ntds.dit.
          SEARCH Event ID 4663 in last 90 days
          WHERE (ProcessName, SubjectUserName) tuple IS NOT in baseline.
          INCREASE risk score if access time is outside normal backup windows.
  - question: Has a machine learning model flagged any access events to the ntds.dit file as anomalous outliers?
    context: |
      This question applies unsupervised machine learning to detect suspicious access to the NTDS.dit file. An isolation forest model can profile normal access patterns using features like the process name, user account, logon ID, and type of access requested (AccessMask). The model can then identify any access events that are statistical outliers, indicating a deviation from established legitimate activity without relying on predefined rules or signatures.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Domain Controller file systems, specifically the %SystemRoot%\NTDS\ directory
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH for alerts from 'NTDS_File_Access_Anomaly_Model'.
          FOR each alert, retrieve event details:
            ProcessName, SubjectUserName, LogonID, AccessMask.
          ANALYZE features that contributed to the anomaly score.
  - question: Has a Volume Shadow Copy been created on a Domain Controller by a user account not authorized for backup operations?
    context: |
      This question targets a common precursor to NTDS theft: creating a Volume Shadow Copy to access the locked ntds.dit file. Adversaries use `vssadmin create shadow` or PowerShell equivalents to do this. By alerting when these commands are run by an interactive user or a service account not on an explicit allowlist for backup operations, analysts can detect suspicious activity before the file is even accessed.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7036
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH Event ID (4688, 4104) from domain_controllers
          WHERE (CommandLine CONTAINS 'vssadmin create shadow' OR ScriptBlockText CONTAINS 'New-VSSShadowCopy')
          AND SubjectUserName NOT IN (allowlist of backup/admin accounts)
  - question: Has a Volume Shadow Copy been created on a Domain Controller at a time that deviates from the established backup schedule?
    context: |
      This question aims to detect anomalous VSS creation events by analyzing their timing. Legitimate VSS creation is typically part of a scheduled backup process, which has a predictable daily or weekly pattern. By modeling this time series, it's possible to identify any VSS creation events that are statistical outliers and do not align with the known backup schedule. Such an event is highly suspicious and could indicate an adversary's attempt to create a shadow copy to steal ntds.dit.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7036
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          MODEL time series of VSS start events (EID 7036) and vssadmin commands (EID 4688).
          SEARCH for new VSS creation events.
          ALERT if the event time is a statistical outlier based on the historical time series model.
  - question: Has a machine learning model classified a Volume Shadow Copy creation event as malicious based on its context?
    context: |
      This question uses a decision tree or similar classifier to determine if a VSS creation event is malicious. The model considers multiple features in context, such as the initiating process, the user account and their group memberships, and the time of day. Crucially, it also looks for follow-on activity within a short time window, such as access to ntds.dit or a large network egress. An alert from this model provides a high-confidence signal that the VSS creation was part of an attack chain.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7036
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH for alerts from 'VSS_Malicious_Creation_Classifier'.
          FOR each alert, retrieve features:
            ProcessName, SubjectUserName, UserGroups, TimeOfDay.
          CHECK for correlated ntds.dit access or network egress alerts within 10 minutes.
  - question: Has a DCSync replication request been observed originating from a host that is not a Domain Controller?
    context: |
      This question aims to detect DCSync attacks, where an adversary with sufficient privileges impersonates a Domain Controller to request password data. This is done via a 'DsGetNcChanges' RPC call. By monitoring network traffic for this specific operation and alerting whenever the source IP is not an authorized Domain Controller, or by monitoring Windows security logs for replication requests from unauthorized accounts, analysts can detect this powerful credential access technique.
    answer_sources:
      - Zeek dce_rpc.log
      - Windows Event ID 4662
      - Network segments connecting to Domain Controllers
      - Authentication Servers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH Zeek dce_rpc.log
          WHERE operation = 'DsGetNcChanges'
          AND source_ip NOT IN (allowlist of DC IPs)
          UNION
          SEARCH Event ID 4662
          WHERE Properties CONTAINS '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2'
          AND SubjectAccountSID NOT IN (allowlist of DC SIDs)
  - question: Has there been an anomalous spike in the number of distinct hosts attempting to perform DCSync operations?
    context: |
      This question provides a behavioral approach to detecting widespread DCSync activity. Instead of looking at a single unauthorized request, this method baselines the normal number of hosts performing replication. A sudden spike in the count of distinct source hosts making 'DsGetNcChanges' requests, exceeding a statistical threshold (e.g., three standard deviations), could indicate a broad attack where an adversary is using multiple compromised systems to perform DCSync.
    answer_sources:
      - Zeek dce_rpc.log
      - Windows Event ID 4662
      - Network segments connecting to Domain Controllers
      - Authentication Servers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          CALCULATE rolling 7-day average of distinct source hosts making 'DsGetNcChanges' requests per hour.
          SEARCH for current hourly count of distinct source hosts.
          ALERT if current_count > (average + 3 * standard_deviation).
  - question: Has a graph-based anomaly detection model identified an unusual DC replication pattern, such as a non-DC host connecting to a DC?
    context: |
      This question applies graph theory to model Active Directory replication. In a normal environment, the graph of replication consists of edges (DCSync requests) exclusively between nodes classified as Domain Controllers. A graph-based anomaly detection algorithm can model this structure and immediately flag any structural anomaly, such as the sudden appearance of an edge from a non-DC node to a DC node. This is a very strong and specific indicator of a DCSync attack.
    answer_sources:
      - Zeek dce_rpc.log
      - Windows Event ID 4662
      - Network segments connecting to Domain Controllers
      - Authentication Servers
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH for alerts from 'DC_Replication_Graph_Anomaly_Model'.
          FOR each alert, visualize the anomalous edge:
            source_node (non-DC), destination_node (DC), edge_property ('DsGetNcChanges').
          INVESTIGATE the source_node for compromise.
  - question: Has a suspected NTDS dumping event on a Domain Controller been immediately followed by a large network transfer from that same DC?
    context: |
      This question correlates host-based indicators of compromise with network-based indicators to detect the full 'dump and exfiltrate' attack chain. An alert for a suspicious host event (e.g., 'vssadmin' execution or unauthorized ntds.dit access) can be noisy on its own. By correlating it with a subsequent, statistically large network transfer from the same machine within a short time window (e.g., 5 minutes), the confidence of a true positive exfiltration event increases dramatically.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Sysmon Event ID 3
      - Domain Controllers
      - Network Egress Points
      - Internet Gateway
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH for host_alert (vssadmin, ntds.dit access, etc.) on domain_controllers
          JOIN with network_connection_events (Zeek conn.log, Sysmon EID 3) from same host
          WHERE network_event.timestamp is within 5 minutes of host_alert.timestamp
          AND network_event.bytes_out > 99th_percentile_baseline
  - question: Following a host-based trigger event, has the moving average of outbound data volume from a DC shown a statistically significant deviation?
    context: |
      This question provides a more sustained view of exfiltration compared to a single large transfer. An Exponentially Weighted Moving Average (EWMA) is sensitive to recent changes in data volume. After a host-based trigger (like 'ntdsutil' execution), monitoring this moving average can detect a sustained, anomalous transfer that might not be a single huge file but a series of smaller chunks. An alert is generated if the observed volume causes a statistically significant deviation, indicating an ongoing exfiltration attempt.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Sysmon Event ID 3
      - Domain Controllers
      - Network Egress Points
      - Internet Gateway
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each DC, maintain an EWMA of outbound data volume.
          UPON a host-based trigger event on a DC:
            MONITOR EWMA for the next 15 minutes.
            ALERT if observed volume causes a significant deviation in the EWMA.
  - question: Has a sequence of events on a Domain Controller been classified by a Hidden Markov Model as a likely exfiltration state?
    context: |
      This question uses a sophisticated state-based model to understand the sequence of adversary actions. A Hidden Markov Model (HMM) can be trained on sequences of events from a DC, learning the probability of transitioning between hidden states like 'Benign' and 'Exfiltrating'. When a sequence of observed events (e.g., 'vssadmin_create', then 'rare_process_access_ntds', then 'large_network_tx') makes the 'Exfiltrating' state the most likely hidden state, an alert is fired. This provides a holistic view of the attack chain.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Sysmon Event ID 3
      - Domain Controllers
      - Network Egress Points
      - Internet Gateway
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          SEARCH for alerts from 'DC_Exfiltration_HMM_Model'.
          FOR each alert, retrieve the sequence of observed events that led to the 'Exfiltrating' state.
          ANALYZE the event sequence to understand the full attack path.