name: T1598.002: Spearphishing Attachment
id: a1f9e9e0-6b3a-4f8c-9c1d-8e7a6b5c4d3e
description: This playbook helps determine if an adversary is conducting reconnaissance via spearphishing attachments. This involves analyzing inbound emails for known malicious signatures in attachments or sender details, detecting when document reader applications spawn suspicious child processes (e.g., command-line interpreters), identifying targeted, low-volume email bursts from new or suspicious domains, and monitoring for outbound network connections from document-spawned processes to potential command-and-control servers.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is an inbound email attachment or its associated sender details (IP, domain) present on a threat intelligence blacklist?
    context: Malicious attachments are a primary initial access vector. Checking file hashes, sender IP addresses, and source domains against known Indicators of Compromise (IOCs) from threat intelligence feeds is a high-fidelity method for early detection of spearphishing attempts. This is often corroborated by checking for email authentication failures (SPF, DKIM, DMARC), which can indicate a spoofed or malicious sender.
    answer_sources:
      - Zeek files.log
      - Zeek smtp.log
      - Threat Intelligence Platform Data
      - Email Gateway
      - Mail Servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - pseudocode: FOR each email in SMTP logs, EXTRACT file hash, sender IP, sender domain, reply-to domain. QUERY hash, IP, and domains against threat intel feeds. CHECK SPF/DKIM/DMARC results for 'fail'. ALERT on match.
  - question: Has a rare and newly registered domain sent an email with an attachment?
    context: Adversaries frequently register new domains for specific campaigns to bypass reputation-based security controls. By establishing a baseline of normal sender domain frequency, we can identify domains that are rarely seen. Cross-referencing these rare domains with their registration date (via WHOIS) can uncover domains created just before a campaign. An email from a domain that is both rare and new is a strong heuristic for a targeted spearphishing attempt.
    answer_sources:
      - Zeek smtp.log
      - WHOIS lookup services
      - Email Gateway
      - Mail Servers
    range: last 90 days
    queries:
      - pseudocode: BASELINE sender domain frequency over 30 days. IDENTIFY domains in bottom 5th percentile. FOR these rare domains, PERFORM WHOIS lookup. IF domain is < 30 days old and email has an attachment, ALERT for review.
  - question: Does an email exhibit a combination of features that a machine learning model classifies as likely malicious?
    context: This question moves beyond simple rules to a more holistic, probabilistic approach. By training a model on various features (sender reputation, domain age, attachment type, subject line entropy, etc.), we can identify sophisticated attacks that might evade individual IOC or heuristic checks. A high probability score from a model indicates a strong likelihood of a malicious spearphishing attempt, enabling automated blocking or quarantine.
    answer_sources:
      - Zeek files.log
      - Zeek smtp.log
      - Email Gateway
      - Mail Servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - pseudocode: FOR each email, CREATE feature vector (sender reputation, domain age, TLD rarity, auth results, attachment type/size, subject entropy, IOC match). INPUT vector into trained classification model. IF output probability > threshold (e.g., 0.90), FLAG for block/quarantine.
  - question: Did a common document-handling application (e.g., Outlook, Word, Acrobat) spawn a suspicious child process like a command-line interpreter or reconnaissance tool?
    context: Legitimate document applications rarely spawn command-line tools or system utilities. This behavior is a hallmark of malicious macros or exploits embedded in attachments, which are used to execute code for reconnaissance (e.g., `whoami`, `systeminfo`) or further compromise. Detecting this specific parent-child process relationship is a critical indicator of post-exploitation activity originating from a spearphishing attachment.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User Workstations
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers (e.g., Citrix)
    range: last 90 days
    queries:
      - pseudocode: SEARCH process creation logs. FILTER for ParentProcessName IN {OUTLOOK.EXE, WINWORD.EXE, ...} AND NewProcessName IN {powershell.exe, cmd.exe, whoami.exe, ...}. ALERT on match.
  - question: Has an anomalously rare parent-child process execution, originating from a document handler, occurred with unusually high command-line entropy?
    context: This question targets attackers attempting to evade simple signature-based detection by using legitimate but unusual process chains. By baselining normal process activity, we can spot infrequent parent-child pairs. High command-line entropy further suggests obfuscated commands, a common adversary technique. The combination of a rare process chain and obfuscated commands points to a sophisticated, evasive execution.
    answer_sources:
      - Windows Event ID 4688
      - User Workstations
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers (e.g., Citrix)
    range: last 90 days
    queries:
      - pseudocode: BASELINE frequency of all parent-child process pairs over 90 days. BASELINE command-line entropy for each child process. ALERT if a document handler spawns a child, the pair is in the bottom 1% frequency, AND command-line entropy is > 3 standard deviations above the mean.
  - question: Can unsupervised machine learning identify outlier process creation events originating from a document handler?
    context: This approach assumes we may not know what "bad" looks like. By clustering all process creation events based on features like parent/child names and command-line characteristics, we can define "normal" clusters of activity. Events that do not fit into any cluster (i.e., noise or outliers) and originate from a document handler are, by definition, highly anomalous and warrant immediate investigation as potential zero-day or unknown attack patterns.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User Workstations
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers (e.g., Citrix)
    range: last 90 days
    queries:
      - pseudocode: FOR each process creation event, CREATE feature vector (parent hash, child hash, cmd-line length, cmd-line entropy, special char count). APPLY DBSCAN algorithm. INVESTIGATE outlier points where the parent is a document handler.
  - question: Has a previously unseen domain sent a small, targeted batch of emails with attachments of the same file type to a specific group of users?
    context: Spearphishing campaigns are often targeted, not mass-emailed. This behavior—a new sender domain, a small group of recipients (e.g., 2-20 users), and consistent attachment types across all emails—is a classic pattern for a targeted attack. Monitoring for this specific combination helps differentiate a focused campaign from normal bulk email traffic.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Directory Services Data
      - Email Gateway
      - Directory Services
      - Human Resources Information System (HRIS)
    range: last 90 days
    queries:
      - pseudocode: MONITOR SMTP logs for sender domains not seen in 60 days. IF new domain sends to >2 and <20 recipients within 1 hour AND all emails have attachments of the same type, ALERT.
  - question: Has a new domain sent a low-entropy (non-random) email burst with attachments to recipients who share a common organizational attribute (e.g., same department)?
    context: Adversaries often target users based on their role (e.g., sending fake invoices to the finance team). A low-entropy recipient list indicates deliberate selection, not random chance. Correlating this with shared user attributes from a directory service provides strong evidence that the campaign is not random but is a targeted, well-researched spearphishing attack.
    answer_sources:
      - Zeek smtp.log
      - Directory Services Data
      - Email Gateway
      - Directory Services
      - Human Resources Information System (HRIS)
    range: last 90 days
    queries:
      - pseudocode: IDENTIFY email bursts from new domains. CALCULATE Shannon entropy of recipient list. QUERY directory service for recipient attributes. IF entropy is low AND recipients share an attribute (e.g., department), ELEVATE suspicion score.
  - question: Can email metadata clustering identify small, dense groups of emails indicative of a targeted campaign?
    context: This machine learning approach helps find suspicious clusters in email traffic. By grouping emails based on sender, attachment type, and recipient department, targeted campaigns will form small, dense clusters distinct from the large, diffuse clusters of normal business email. A tight cluster of a few emails from a new domain, all with PDF attachments, sent only to the 'Finance' department would be automatically flagged as a potential campaign.
    answer_sources:
      - Zeek smtp.log
      - Directory Services Data
      - Email Gateway
      - Directory Services
      - Human Resources Information System (HRIS)
    range: last 90 days
    queries:
      - pseudocode: FOR emails in a 1-hour window, CREATE feature vector (sender domain, attachment type, recipient department). APPLY clustering algorithm (DBSCAN). FLAG small, dense clusters for review.
  - question: Did a process spawned by a document handler make a network connection to a known malicious IP or domain?
    context: This is a high-confidence indicator of compromise. It signifies that a malicious attachment was opened, code executed, and it is now "calling home" to a command-and-control (C2) server. Correlating the process lineage on the host (document > child process) with the network connection to a blacklisted destination provides end-to-end evidence of a successful intrusion.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - User Workstations
      - Network Egress Points
      - Internal DNS Resolvers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - pseudocode: CORRELATE process creation logs with network connection logs using ProcessGuid. ALERT if a process spawned by a document handler connects to an IP/domain on a C2 blocklist.
  - question: Did a process spawned by a document handler connect to a statistically rare domain using a rare TLS client fingerprint (JA3)?
    context: Attackers often use new or obscure domains for C2 that are not yet on blacklists. A connection from a document-spawned process is already suspicious; if it also goes to a rarely visited domain ("long-tail" analysis) using a client TLS configuration (JA3) that is also rare for that host, the combination of multiple statistical anomalies is a very strong signal of malicious C2 activity.
    answer_sources:
      - Sysmon Event ID 1
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - User Workstations
      - Network Egress Points
      - Internal DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: BASELINE FQDN and JA3 hash frequency over 90 days. IDENTIFY connections from document-spawned processes where the destination FQDN and the client JA3 hash are both in the bottom 1% of frequency. ALERT on this combined anomaly.
  - question: Does a network connection from a document-spawned process deviate from the learned model of 'normal' network behavior?
    context: This question applies anomaly detection to network traffic from potentially compromised processes. A one-class SVM model is trained only on "normal" connection behavior. When a new connection from a document-spawned process is evaluated, if it doesn't fit the normal model (e.g., it uses an odd port, has an unusual data ratio, or the domain has a high DGA prediction score), the model flags it as an outlier. This can detect novel C2 channels that other methods might miss.
    answer_sources:
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - User Workstations
      - Network Egress Points
      - Internal DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: TRAIN one-class SVM on normal connection feature vectors. FOR new connections from document-spawned processes, CREATE feature vector (ProcessName, Port, Protocol, Duration, Bytes, DGA score, JA3 rarity). IF model classifies as outlier, ALERT.