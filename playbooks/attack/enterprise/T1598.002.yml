name: T1598.002: Spearphishing Attachment
id: 5a8a68b4-522d-4f06-b563-7313c4c9e426
description: This playbook helps determine if an adversary is conducting reconnaissance via spearphishing attachments. It focuses on identifying malicious indicators in inbound emails, such as known-bad file hashes or sender details from threat intelligence. It also looks for post-delivery activity, such as a document reader spawning suspicious child processes (e.g., command shells, recon tools), a process from a document handler making unusual outbound network connections to suspicious destinations, or patterns indicating a targeted, low-volume campaign from a new or suspicious domain.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are inbound emails containing attachments whose file hash, sender IP, sender domain, or reply-to address match known threat intelligence indicators?
    context: This question aims to detect direct evidence of spearphishing by matching email artifacts against known-bad indicators. A match provides a high-confidence signal of a malicious delivery attempt. Checking for email authentication failures (SPF/DKIM/DMARC) adds context, as attackers often use spoofed or illegitimate domains that fail these checks.
    answer_sources:
      - Zeek files.log
      - Zeek smtp.log
      - Threat Intelligence Platform Data
      - Email Gateway
      - Mail Servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each file in files.log with source 'SMTP':
            hash = SHA256(file)
            QUERY threat_intel_platform for hash
            IF match_found: ALERT (High Severity)
          FOR each email in smtp.log:
            QUERY threat_intel_platform for sender_ip, from_domain, reply_to_domain
            IF match_found OR auth_results contains 'fail': ALERT (High Severity)
  - question: Have we received emails with attachments from rare or newly registered domains?
    context: This question helps identify suspicious senders that are not yet on blacklists. Adversaries often use newly created domains for short-lived campaigns. By baselining sender domain frequency and checking the registration date of rare domains, we can uncover these 'sleeper' threats before they are widely known. An email from a rare and new domain containing an attachment is a significant anomaly.
    answer_sources:
      - Zeek files.log
      - Zeek smtp.log
      - Threat Intelligence Platform Data
      - Email Gateway
      - Mail Servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE sender domains from smtp.log over 30 days
          IDENTIFY domains in bottom 5% frequency (rare_domains)
          FOR each domain in rare_domains:
            age = WHOIS_LOOKUP(domain).creation_date
            IF age < 30 days AND email from domain has attachment:
              FLAG for review
  - question: Can we use a machine learning model to assign a risk score to inbound emails based on their collective features?
    context: This question moves beyond single indicators to a holistic, probabilistic assessment. A supervised model can learn complex patterns of maliciousness from various features like sender reputation, domain age, attachment type, and subject line characteristics. This allows for the detection of novel threats that might evade simple rule-based checks and enables automated actions like blocking or quarantining based on a calculated risk score.
    answer_sources:
      - Zeek files.log
      - Zeek smtp.log
      - Threat Intelligence Platform Data
      - Email Gateway
      - Mail Servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each email:
            EXTRACT feature vector (IP reputation, domain age, TLD rarity, auth_results, attachment_type, size, subject_entropy, on_IOC_list)
            SCORE with pre-trained classification model
            IF score > 0.90:
              BLOCK or QUARANTINE
  - question: Has a common document-handling application (e.g., Word, Acrobat) spawned a command-line interpreter or a known reconnaissance tool?
    context: This is a classic indicator of compromise for malicious documents. Legitimate documents rarely, if ever, need to spawn processes like powershell.exe, cmd.exe, or whoami.exe. Such an event is a strong signal that a malicious macro or exploit has executed and is attempting to perform discovery or further actions on the host.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User Workstations
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers (e.g., Citrix)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          WATCH for Process Creation Events (Sysmon EID 1, WEF EID 4688)
          Parent_Whitelist = {OUTLOOK.EXE, WINWORD.EXE, EXCEL.EXE, POWERPNT.EXE, ACROBAT.EXE, ACROREAD32.EXE}
          Child_Blacklist = {powershell.exe, cmd.exe, wscript.exe, cscript.exe, whoami.exe, systeminfo.exe, ipconfig.exe, net.exe, dsquery.exe}
          IF ParentProcessName in Parent_Whitelist AND NewProcessName in Child_Blacklist:
            ALERT (High Severity)
  - question: Has an anomalous parent-child process relationship with high-entropy command-line arguments been observed?
    context: This question aims to find evasive threats that use uncommon execution chains or obfuscated commands. By baselining normal process relationships and command-line complexity, we can spot statistical outliers. A rare parent-child pair combined with unusually complex or random-looking command-line arguments suggests an attempt to hide malicious activity from signature-based detection.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User Workstations
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers (e.g., Citrix)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE frequency of all parent-child process pairs over 90 days
          BASELINE command-line entropy for each child process
          FOR each new process creation event:
            IF parent-child_pair_frequency is in bottom 1% AND command_line_entropy > 3 * stdev(baseline_entropy):
              FLAG as anomalous execution
  - question: Can we identify outlier process creation events originating from document handlers using unsupervised machine learning?
    context: This question uses anomaly detection to find "unknown unknowns." By clustering all process creation events based on features like parent/child names and command-line characteristics, normal activity will form dense clusters. Events that do not fit any cluster (identified as noise by algorithms like DBSCAN) are extreme outliers. When such an outlier involves a document handler as a parent, it represents a highly suspicious execution chain that warrants immediate investigation.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User Workstations
      - Virtual Desktop Infrastructure (VDI)
      - Application Servers (e.g., Citrix)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each process creation event:
            CREATE feature vector (parent_hash, child_hash, cmd_length, cmd_entropy, special_char_count)
          APPLY DBSCAN clustering algorithm to all vectors
          IDENTIFY noise points (outliers) from the clustering result
          IF outlier_parent is a document handler:
            INVESTIGATE immediately
  - question: Have we observed a burst of emails from a new external domain to a small, targeted group of internal users, all containing similar attachments?
    context: This question identifies the hallmark of a targeted spearphishing campaign. A sender domain never seen before that suddenly sends emails to a small, specific group (e.g., 5-15 people) within a short time frame is highly suspicious, especially if all the emails carry attachments of the same type. This pattern strongly suggests a coordinated attack.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Directory Services Data
      - Email Gateway
      - Directory Services
      - Human Resources Information System (HRIS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          WATCH smtp.log for sender domains not seen in last 60 days
          IF new_domain sends to > 2 AND < 20 unique recipients within 1 hour:
            CORRELATE with files.log to check for attachments
            IF all emails have attachments of same file type:
              ALERT
  - question: Are there email bursts from new domains where the recipients are non-random and share a common attribute, like being in the same department?
    context: This enhances the previous question by adding organizational context. A low-entropy recipient list means the recipients were deliberately chosen. By enriching this data with directory service information (e.g., department), we can confirm if the attack is targeting a specific business unit. A new domain sending emails with attachments to the entire accounting team is a much stronger signal than sending to a random group.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Directory Services Data
      - Email Gateway
      - Directory Services
      - Human Resources Information System (HRIS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each email burst from a new domain:
            CALCULATE Shannon entropy of the recipient list
            QUERY directory service for attributes of all recipients
            IF entropy is low AND recipients share a common attribute (e.g., department):
              ELEVATE suspicion score
  - question: Can clustering algorithms identify small, dense groups of emails that represent a targeted campaign?
    context: This question applies unsupervised learning to email metadata to automatically discover campaigns. By clustering emails based on sender, attachment type, and recipient department, a targeted attack will appear as a small, dense, and isolated clusterâ€”for example, a handful of points representing emails from a new domain with PDFs sent only to the 'Finance' department. This automates the discovery of campaign patterns.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Directory Services Data
      - Email Gateway
      - Directory Services
      - Human Resources Information System (HRIS)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR emails in a 1-hour window:
            CREATE feature vector (sender_domain, attachment_type, recipient_department)
          APPLY DBSCAN clustering algorithm
          FLAG small, dense clusters that are distinct from large, general clusters for review
  - question: Has a process spawned by a document handler made a network connection to an IP or domain on a threat intelligence blocklist?
    context: This question seeks to confirm command-and-control (C2) activity initiated by a malicious document. Correlating host-based process creation with network connection events provides a powerful, high-confidence alert. If a process spawned from Word or Outlook connects to a known malicious C2 server, it's a clear sign of compromise. This can be detected on the host (Sysmon) and corroborated at the network egress (Zeek, firewall logs).
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - User Workstations
      - Network Egress Points
      - Internal DNS Resolvers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON HOST:
            CORRELATE Sysmon EID 1 and EID 3 on ProcessGuid
            IF process parent is document_handler AND destination_ip is on C2_blocklist:
              ALERT (High Confidence)
          ON NETWORK:
            CORRELATE dns.log and conn.log
            IF destination_ip or fqdn is on C2_blocklist:
              ALERT
  - question: Has a process spawned by a document handler made a network connection to a statistically rare domain using a rare TLS client fingerprint (JA3)?
    context: This question uses statistical analysis to find novel C2 channels. Adversaries often use domains that are not yet on blacklists and may use custom malware with unique TLS implementations, resulting in a rare JA3 hash. A connection from a document-spawned process to a rare domain using a rare TLS fingerprint is a strong statistical anomaly indicative of malicious C2 communication.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - User Workstations
      - Network Egress Points
      - Internal DNS Resolvers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE FQDN frequency (dns.log) and JA3 hash frequency (ssl.log) over 90 days
          FOR each new connection from a document-spawned process:
            IF destination_fqdn_frequency is in bottom 1% AND connection_ja3_hash_frequency is rare for client:
              FLAG as strong statistical anomaly
  - question: Can a one-class SVM model detect anomalous network connections originating from processes spawned by document handlers?
    context: This question proposes using a machine learning model trained only on "normal" network behavior to detect malicious outliers. A one-class SVM can create a boundary around what constitutes normal activity. Any new connection from a document-spawned process that falls outside this boundary is, by definition, anomalous and likely represents malicious C2 activity that doesn't conform to any previously seen pattern.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - User Workstations
      - Network Egress Points
      - Internal DNS Resolvers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN one-class SVM on normal network connection feature vectors
          FOR new connections from document-spawned processes:
            CREATE feature vector (ProcessName, DstPort, Protocol, Bytes, DGA_score, JA3_rarity, etc.)
            CLASSIFY with trained SVM
            IF classified as outlier:
              ALERT as anomalous C2 beacon