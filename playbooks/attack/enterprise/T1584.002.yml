name: 'T1584.002: DNS Server'
id: 'f47ac10b-58cc-4372-a567-0e02b2c3d479'
description: 'Investigates whether an adversary is developing resources by compromising DNS servers for use in operations. This involves detecting DNS queries that resolve to malicious IPs, unauthorized DNS zone transfers, anomalous child processes spawned by DNS services, suspicious administrative logins to DNS servers, hijacking of critical external domains, and queries to newly registered or algorithmically-generated domains (DGA).'
type: technique
related:
  - 'TA0042: Resource Development'
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
  - question: Are internal clients receiving DNS responses containing known malicious IP addresses, or are administrative connections being made to DNS servers from these IPs?
    context: This question aims to detect direct communication with adversary infrastructure. If a DNS query resolves to a known malicious IP, it suggests a client is attempting to connect to a C2 server or a malicious site. Similarly, an administrative connection from a malicious IP to a DNS server could indicate the server itself is compromised or under attack.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Internal recursive DNS servers
      - External-facing authoritative DNS servers
      - Network egress points
      - DNS server management consoles
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH dns_logs WHERE answer_ip IN threat_feed_ips; SEARCH connection_logs WHERE dest_port IN [22, 3389, 5985, 5986] AND source_ip IN threat_feed_ips
  - question: Are domains resolving to IP addresses in new or statistically rare Autonomous Systems (ASNs) for that specific domain?
    context: Adversaries often use newly provisioned or compromised infrastructure that resides in different network blocks (ASNs) than a legitimate service. By baselining the normal ASNs for a given domain, we can detect DNS hijacking or domain shadowing when a domain suddenly resolves to an IP in a rare or unprecedented ASN, indicating a potential redirection to malicious infrastructure.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Internal recursive DNS servers
      - External-facing authoritative DNS servers
      - Network egress points
      - DNS server management consoles
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE domain_ip_asn_combinations; SCORE rarity of new resolutions; AGGREGATE risk by client_ip; ALERT on high scores
  - question: Is there a statistically significant spike in the volume of DNS resolutions to IPs flagged as 'suspicious' by reputation providers?
    context: A sudden, anomalous increase in queries to suspicious IPs across the organization can indicate a widespread campaign, such as a phishing attack or malware outbreak, where multiple hosts are attempting to contact the same malicious infrastructure. Time-series analysis helps distinguish a coordinated attack from random, baseline noise.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Internal recursive DNS servers
      - External-facing authoritative DNS servers
      - Network egress points
      - DNS server management consoles
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL dns_volume_to_suspicious_ips using time_series; ALERT on significant deviation from forecast
  - question: Are DNS zone transfers (AXFR/IXFR) being requested by unauthorized source IPs?
    context: Zone transfers are used to replicate DNS databases between servers. An adversary can use a zone transfer request to map an organization's entire network infrastructure. This question checks if these powerful requests are coming from IPs that are not on a pre-approved list of secondary DNS servers or administrative hosts, which is a strong indicator of reconnaissance.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Internal recursive DNS servers
      - External-facing authoritative DNS servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH dns_logs WHERE query_type IN ['AXFR', 'IXFR'] AND source_ip NOT IN authorized_ip_list; ALERT on match
  - question: Are there anomalous patterns in zone transfer activity, such as requests from new sources or unusual frequency from authorized sources?
    context: Beyond simple allowlists, this question seeks to behaviorally baseline zone transfer activity. A request from a historically unknown IP is a high-confidence alert. Additionally, a sudden spike in requests from an authorized server could indicate that the server itself has been compromised and is being used to exfiltrate DNS data.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Internal recursive DNS servers
      - External-facing authoritative DNS servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE axfr_source_ips_and_frequency; ALERT on new_source_ip OR frequency > 99.5th_percentile
  - question: Can we predictively classify DNS zone transfer attempts as 'unauthorized' in real-time?
    context: This leverages machine learning to build a more sophisticated detection mechanism than static rules. By training a model on features like source IP/ASN, time of day, and target server, the system can learn the subtle characteristics of legitimate versus illegitimate requests, potentially catching novel or evasive reconnaissance attempts.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Internal recursive DNS servers
      - External-facing authoritative DNS servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL zone_transfer_requests with features (source_ip, asn, time); CLASSIFY new requests; ALERT on 'unauthorized'
  - question: Is the primary DNS server process ('dns.exe') spawning suspicious child processes like command shells or script interpreters?
    context: The Windows DNS server process ('dns.exe') should not normally spawn child processes, especially not command shells (cmd.exe) or PowerShell. Such an event is a very strong indicator that the DNS server has been compromised and an adversary is executing commands, likely through a vulnerability or a previously established backdoor.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - DNS Server infrastructure (both authoritative and recursive)
      - Domain Controller servers (if running DNS role)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_logs WHERE parent_process = 'dns.exe' AND child_process IN ['cmd.exe', 'powershell.exe', ...]; ALERT on match
  - question: Has a new, never-before-seen parent-child process relationship involving 'dns.exe' appeared on a DNS server?
    context: This question uses historical data to define normalcy. By creating a baseline of all legitimate parent-child process relationships on a DNS server, any new relationship involving 'dns.exe' as the parent is, by definition, anomalous. This can detect novel attack tools or techniques that don't use common shell names.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - DNS Server infrastructure (both authoritative and recursive)
      - Domain Controller servers (if running DNS role)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE parent_child_process_pairs; ALERT on new pair where parent_process = 'dns.exe'
  - question: Can an unsupervised machine learning model identify anomalous process creation events on DNS servers?
    context: This approach automates the detection of outliers in process activity. An Isolation Forest or similar model can learn the multi-dimensional profile of normal process events (parent, child, command line, user) and automatically flag any new event that deviates significantly from this learned baseline, indicating potential compromise.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - DNS Server infrastructure (both authoritative and recursive)
      - Domain Controller servers (if running DNS role)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL process_events with features (parent, child, cmdline); SCORE new events; ALERT on outlier_score
  - question: Has a successful administrative login to a DNS server occurred from a geographically forbidden location?
    context: This is a straightforward but effective security control. Many organizations have policies prohibiting administrative access from certain countries. This question verifies that control by checking if any successful admin logins to critical DNS servers originate from IPs that geolocate to a country on this deny-list.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - DNS Server infrastructure
      - Domain Controllers
      - VPN concentrators
      - Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH admin_logins (LogonType 3 or 10); GEO-IP lookup source_ip; ALERT if country IN deny_list
  - question: Has an administrator logged into a DNS server from a country or network (ASN) that is rare or new for that specific user?
    context: This moves beyond a static deny-list to user-specific behavioral analytics. An administrator might legitimately log in from two or three different countries or networks. However, a login from a fourth, never-before-seen country or a very rare ASN for that user is suspicious and could indicate a compromised account. This is a classic 'impossible travel' or 'anomalous location' scenario.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - DNS Server infrastructure
      - Domain Controllers
      - VPN concentrators
      - Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE login_attributes (ip, asn, country) per_user; ALERT if new_login_country not in user_baseline OR new_login_asn is rare for user
  - question: Does a recent administrative login to a DNS server fall outside the user's normal cluster of behavior?
    context: This is an advanced UEBA technique. A clustering model groups a user's past logins based on multiple features (time, source IP, etc.) to define 'normal' behavior. A new login that doesn't fit into any existing cluster is flagged as an outlier. This can detect more subtle anomalies than single-factor checks, such as a login from a known location but at a highly unusual time.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - DNS Server infrastructure
      - Domain Controllers
      - VPN concentrators
      - Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL user_logins with features (time, source_ip, etc.) using clustering; SCORE new logins; ALERT if login is not in a normal cluster
  - question: Are critical external domains (e.g., SSO provider, Office 365) resolving to IPs or ASNs that are not on the approved allowlist?
    context: DNS hijacking of critical services is a high-impact threat. This question aims to detect it by verifying that DNS responses for vital external domains *only* contain IPs from a pre-vetted list of known-good addresses and networks. Any deviation is a critical alert, suggesting a Man-in-the-Middle (MitM) attack or DNS cache poisoning.
    answer_sources:
      - Zeek dns.log
      - Network egress points
      - Internal recursive DNS servers
      - Endpoint devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH dns_logs WHERE domain IN critical_domains AND resolved_ip NOT IN allowlist; ALERT on match
  - question: Has the diversity (entropy) of resolved IP addresses for a critical domain suddenly and significantly dropped?
    context: Large, legitimate services (like CDNs) use many IP addresses, resulting in high entropy in DNS responses across an organization. If an attacker hijacks the domain to point to a single malicious IP, the entropy of resolved IPs will plummet. This question seeks to detect that sudden drop, which is a strong statistical indicator of a hijack.
    answer_sources:
      - Zeek dns.log
      - Network egress points
      - Internal recursive DNS servers
      - Endpoint devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE rolling_entropy of resolved_ips per critical_domain; ALERT on significant drop vs. baseline
  - question: Is the number of unique IPs resolved for a critical domain significantly different from the forecasted number?
    context: This is another statistical method to detect hijacking. A time-series model learns the normal daily or hourly pattern of unique IP resolutions for a domain. A hijack could cause this number to collapse to one (or a few) or, in a domain shadowing scenario, explode to many new IPs. An actual count falling far outside the model's prediction signals an anomaly.
    answer_sources:
      - Zeek dns.log
      - Network egress points
      - Internal recursive DNS servers
      - Endpoint devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL unique_ip_count_per_domain using time_series; ALERT if actual_count is outside prediction_interval
  - question: Are internal clients querying newly registered or DGA-flagged domains that resolve to known malicious IPs?
    context: This question combines multiple risk factors for a high-confidence alert. Malware often uses Domain Generation Algorithms (DGAs) to create rendezvous points, and adversaries frequently use newly registered domains (NRDs) for campaigns. Combining this with a query that resolves to a known bad IP address creates a strong signal of a malware-infected host.
    answer_sources:
      - Zeek dns.log
      - Network egress points
      - Endpoint devices
      - Internal recursive DNS servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH dns_logs WHERE (domain_age < 30d OR is_dga) AND ip_reputation = 'malicious'; ALERT on match
  - question: Are high-entropy (likely DGA) domains being queried that also resolve to an IP in a completely new or rare ASN?
    context: This question aims to find DGA activity without relying on pre-existing DGA feeds. DGA domains have high character randomness (high entropy). Combining a high-entropy domain name with a resolution to an IP in an ASN the organization has never seen traffic from before creates a strong, self-contained signal of potential C2 communication.
    answer_sources:
      - Zeek dns.log
      - Network egress points
      - Endpoint devices
      - Internal recursive DNS servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE entropy of domain_names; FLAG high_entropy_domains; ALERT if flagged_domain resolves to IP in new_ASN
  - question: Can a deep learning model classify a queried domain as DGA, and does that domain resolve to an IP associated with other DGA domains?
    context: This is an advanced, machine learning-based approach to DGA detection. An LSTM model can learn the sequential patterns of characters in domain names to identify DGAs more accurately than simple entropy. The detection is further strengthened by correlating the finding with the reputation of the resolved IP, specifically if that IP is a 'hotspot' for other domains also classified as DGAs.
    answer_sources:
      - Zeek dns.log
      - Network egress points
      - Endpoint devices
      - Internal recursive DNS servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL domain_names with LSTM; CLASSIFY as DGA; CLUSTER DGA-resolved IPs; ALERT if new DGA resolves to known DGA_IP_cluster