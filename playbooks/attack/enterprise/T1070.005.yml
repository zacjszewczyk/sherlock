name: T1070.005: Network Share Connection Removal
id: 54b1f4c2-901c-4b9e-8c34-2e920d3f789d
description: Investigates whether an adversary is attempting to evade defenses by removing network share connections. This involves detecting the deletion of network share connections via malicious processes identified by hash, direct execution of built-in commands like 'net use /delete' or 'Remove-SmbMapping', observing a rapid sequence of SMB connection, file access, and then connection deletion, or identifying anomalously short SMB sessions in network telemetry. The goal is to uncover attempts to cover tracks after data exfiltration or lateral movement.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a process known to be malicious based on its file hash executing a command to delete a network share?
    context: This question aims to identify the use of known malicious tools for defense evasion. By calculating the hash of every process that initiates a share deletion and comparing it against a threat intelligence feed, analysts can quickly find high-fidelity indicators of compromise. A match suggests an adversary is using a recognized malicious binary to cover their tracks after accessing a network share.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - End-user Workstations
      - Domain Controllers
      - File Servers
      - Application Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process creation logs | HASH process_image | LOOKUP hash against threat_intel_feed | WHERE match_found
  - question: Is a statistically rare process executing commands to remove network share connections?
    context: This question focuses on identifying unknown or custom malware by leveraging statistical rarity. Legitimate share deletions are often performed by common system tools. If a process that is very rare in the environment is observed performing this action, it is highly suspicious. This approach helps detect novel threats that are not yet present in threat intelligence feeds.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - End-user Workstations
      - Domain Controllers
      - File Servers
      - Application Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process creation logs FOR command_line CONTAINS ('net use /delete' OR 'Remove-SmbMapping') | STATS count BY file_hash | CALCULATE prevalence | WHERE prevalence < 0.1%
  - question: Does a machine learning model classify a process executing a share deletion as malicious?
    context: This question uses a supervised machine learning model to score the likelihood that a share deletion event is malicious. The model considers multiple features like process hash prevalence, parent process, user context, and command-line arguments to provide a more nuanced assessment than simple rule-based detections. A high probability score from the model indicates a strong likelihood of malicious activity that warrants immediate investigation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - End-user Workstations
      - Domain Controllers
      - File Servers
      - Application Servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT process creation events with share deletion commands INTO ML_model | FILTER for events where model_score > threshold
  - question: Are there direct executions of built-in commands like 'net use /delete' or 'Remove-SmbMapping' to remove network shares?
    context: This question seeks to find direct, explicit evidence of an adversary using native Windows tools to remove network share connections. Monitoring for the specific command-line arguments ('net use /delete') or PowerShell cmdlets ('Remove-SmbMapping') provides a clear and direct indicator of this defense evasion technique. It's a fundamental check for this type of activity.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104 (PowerShell Script Block Logging)
      - End-user Workstations
      - Application Servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process logs FOR (process_name IN ('net.exe', 'net1.exe') AND command_line CONTAINS 'use' AND command_line CONTAINS '/delete') OR (powershell logs FOR script_block CONTAINS 'Remove-SmbMapping' OR 'Remove-PSDrive')
  - question: Is a share deletion command being executed by an unusual parent process or at an anomalous time?
    context: This question aims to add context to share deletion events by baselining normal behavior. Legitimate share deletions are often initiated by predictable parent processes (e.g., 'explorer.exe' during logoff). An alert triggered by a rare parent process, such as 'svchost.exe' or a script host like 'wscript.exe', especially outside of normal business hours, is highly indicative of malicious activity trying to masquerade as legitimate system behavior.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104 (PowerShell Script Block Logging)
      - End-user Workstations
      - Application Servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH share deletion events | BASELINE parent_process per user | IDENTIFY executions with a rare parent_process | CORRELATE with time of day | ALERT on rare parent AND off-hours
  - question: Has a logistic regression model classified a share deletion event as 'Suspicious' rather than 'Benign'?
    context: This question leverages a machine learning model to classify share deletion events based on contextual features like time of day, user account, and parent process. Unlike simple rules, a logistic regression model can learn the complex patterns that differentiate benign activity (like logoff scripts) from suspicious actions. A 'Suspicious' classification provides a prioritized lead for an analyst to investigate.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104 (PowerShell Script Block Logging)
      - End-user Workstations
      - Application Servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT share deletion events with features (time, user, parent) INTO logistic_regression_model | FILTER for events classified as 'Suspicious'
  - question: Has a user or host connected to an SMB share, accessed files, and then quickly deleted the share connection within a short time frame?
    context: This question looks for a specific sequence of actions that strongly indicates a 'smash and grab' data theft or lateral movement scenario. An adversary connects, performs an action (like exfiltrating data or executing a file), and then immediately cleans up the connection to hide their tracks. Correlating these events in a tight time window (e.g., 15 minutes) is a powerful way to detect this behavior.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Zeek smb_files.log
      - Zeek conn.log
      - File Servers
      - Network Security Monitoring Sensors
      - Domain Controllers
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CORRELATE logs by user and host within 15 mins | LOOK FOR sequence (1) SMB connection, (2) File access, (3) Share deletion command | ALERT on sequence match
  - question: Was an SMB session anomalously short and immediately followed by a share deletion command?
    context: This question uses statistical analysis of network traffic to find suspicious behavior. Normal user interactions with file shares have a typical duration. An extremely short session, especially one that is an outlier for a specific user-share pair, suggests the connection was made for a rapid, automated task. When this is immediately followed by a command to delete the connection, it strongly implies an attempt to cover tracks.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Zeek smb_files.log
      - Zeek conn.log
      - File Servers
      - Network Security Monitoring Sensors
      - Domain Controllers
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE historical SMB session duration percentiles per user-share | MONITOR new sessions | IF new_session_duration < 5th_percentile AND followed by share_deletion_command THEN ALERT
  - question: Did a sequence of user actions that included a share deletion deviate from normal, learned behavior patterns?
    context: This question employs advanced sequence analysis to model entire chains of user activity. The model learns what normal 'stories' look like from event logs. A sequence of events that includes a share deletion but is given a low probability score by the model is, by definition, anomalous. This can detect sophisticated adversaries whose individual actions might seem benign but whose overall sequence of operations is suspicious.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Zeek smb_files.log
      - Zeek conn.log
      - File Servers
      - Network Security Monitoring Sensors
      - Domain Controllers
      - Endpoint Devices
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT event sequences (process, file, network) into HMM | IF sequence contains share_deletion AND has low_probability_score THEN ALERT
  - question: Was there an extremely short SMB session that was not associated with a user logging off?
    context: This question seeks to identify short-lived SMB sessions that are not explained by normal user logoffs. A legitimate short session might occur if a user logs in and immediately logs out. By checking for a corresponding logoff event, we can filter out this benign noise and focus on sessions that are suspiciously short (e.g., under 60 seconds), which could indicate an automated script performing a quick action and then cleaning up.
    answer_sources:
      - Zeek conn.log
      - Zeek smb_mapping.log
      - Windows Event ID 4634
      - Network Security Monitoring Sensors (e.g., Zeek)
      - Core Switches
      - File Servers
      - Authentication Logs from Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for new SMB mappings | GET connection duration | IF duration < 60s AND NO corresponding user_logoff_event within 2 minutes THEN ALERT
  - question: Was there a sudden, significant drop in SMB traffic from a client that cannot be explained by a user logoff?
    context: This question analyzes network traffic volume over time to spot anomalies. A sudden, sharp drop in SMB traffic from a client can indicate that all its network shares were disconnected simultaneously. While this could be due to a logoff, the absence of a logoff event makes it suspicious. This method can detect when an attacker or script forcibly terminates all connections to cover tracks, which would manifest as a statistical anomaly in traffic volume.
    answer_sources:
      - Zeek conn.log
      - Zeek smb_mapping.log
      - Windows Event ID 4634
      - Network Security Monitoring Sensors (e.g., Zeek)
      - Core Switches
      - File Servers
      - Authentication Logs from Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR SMB traffic volume per client IP | IDENTIFY drops > 3 standard deviations from moving average | CHECK for corresponding user_logoff_event | IF no_logoff_event THEN ALERT
  - question: Did an SMB session have a duration that a time-series model flagged as anomalously short?
    context: This question uses a sophisticated time-series model to predict expected SMB session durations, accounting for factors like time of day and day of week. A session whose actual duration is significantly shorter than the model's prediction (i.e., outside the confidence interval) is flagged as an anomaly. This is a powerful technique for detecting rapid 'connect, act, disconnect' behavior that deviates from established user patterns.
    answer_sources:
      - Zeek conn.log
      - Zeek smb_mapping.log
      - Windows Event ID 4634
      - Network Security Monitoring Sensors (e.g., Zeek)
      - Core Switches
      - File Servers
      - Authentication Logs from Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INPUT SMB session durations into time-series_model (e.g., Prophet) | IDENTIFY sessions where duration is outside predicted confidence interval | ALERT on anomalously short sessions