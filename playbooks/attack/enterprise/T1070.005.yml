name: T1070.005: Network Share Connection Removal
id: 0c8d9e1f-6b2a-4f9c-8e3d-7a1b4c6d8e0f
description: This playbook helps investigate whether an adversary is attempting to evade defenses by removing network share connections to cover their tracks. Detections focus on identifying the execution of processes known to be malicious that perform share deletions, direct use of built-in commands like 'net use /delete' or 'Remove-SmbMapping', correlated event sequences showing a connection followed by file access and then a quick deletion, and anomalously short SMB session durations observed in network telemetry.
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is a process known to be malicious based on its file hash executing a network share deletion?
  context: This question aims to identify the use of known malicious tools for defense evasion. An adversary might use a custom or publicly available hacking tool to remove traces of their network activity, such as deleting a mapped drive used for data exfiltration. Matching the file hash of the process responsible for the deletion against a threat intelligence feed provides a high-confidence indicator of compromise.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - End-user Workstations, Domain Controllers, File Servers, Application Servers
  - Threat Intelligence Feeds
  range: Last 90 days
  queries:
  - pseudocode: FOR each process_creation_event | HASH process_image | CHECK hash against threat_intel_feed | IF match THEN ALERT
- question: Is a statistically rare process executing commands to remove a network share connection?
  context: Legitimate share deletions are often performed by common system processes or scripts. An adversary might use a custom tool or a less common utility to perform this action, which would appear as a low-prevalence hash in the environment. Identifying executions by rare processes helps uncover custom adversary tooling or living-off-the-land binaries (LOLBins) used in an unusual context.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - End-user Workstations, Domain Controllers, File Servers, Application Servers
  range: Last 90 days
  queries:
  - pseudocode: SEARCH process_creation_events with command_line ~ "net use /delete" OR "Remove-SmbMapping" | CALCULATE prevalence of process_hash | IF prevalence < 0.1% THEN ALERT
- question: Does a machine learning model classify a process executing a share deletion as malicious?
  context: This question uses a predictive approach to identify subtle signs of malicious activity that may not be caught by simple rules. By training a model on features like parent process, user context, and command-line arguments, the system can learn the characteristics of both benign and malicious share deletions. A high-probability score from the model indicates that the observed activity strongly resembles known malicious patterns, even if the specific tool is unknown.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - End-user Workstations, Domain Controllers, File Servers, Application Servers
  - ML Model Scores
  range: Last 90 days
  queries:
  - pseudocode: FOR each process_creation_event with share_deletion_command | EXTRACT features (hash_prevalence, parent_process, user, etc.) | SCORE with classification_model | IF score > threshold THEN ALERT
- question: Has a user or process directly executed a standard Windows or PowerShell command to remove a network share?
  context: Adversaries often "live off the land" by using built-in system utilities to avoid introducing new files that could be detected. This question focuses on finding direct, explicit command-line or script block evidence of 'net.exe' or 'Remove-SmbMapping' being used to delete a share connection, which is a common technique for post-activity cleanup.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104 (PowerShell Script Block Logging)
  - End-user Workstations, Application Servers, Domain Controllers
  range: Last 90 days
  queries:
  - pseudocode: SEARCH process_events for (process_name="net.exe" OR "net1.exe") AND command_line ~ "use" AND "/delete" | UNION | SEARCH powershell_logs for script_block ~ "Remove-SmbMapping" OR "Remove-PSDrive" | ALERT
- question: Is a network share deletion command being initiated by an unusual parent process?
  context: Legitimate share deletions are typically initiated by predictable parent processes, such as 'explorer.exe' (user action) or a logon/logoff script host. If a share deletion command is spawned by an anomalous parent, like a web server process, a Microsoft Office application, or 'svchost.exe', it could indicate a compromised process is being used to cover tracks. This is especially suspicious outside of normal business hours.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104 (PowerShell Script Block Logging)
  - End-user Workstations, Application Servers, Domain Controllers
  range: Last 90 days
  queries:
  - pseudocode: FOR each share_deletion_event | LOOKUP historical parent_processes for user | IF current_parent_process is rare for user THEN ALERT
- question: Does a machine learning model classify a share deletion event as suspicious based on its context?
  context: This question leverages a machine learning model to distinguish between normal, expected share deletions (e.g., as part of a logoff script) and suspicious ones. The model considers contextual features like the time of day, user account, and parent process to make its classification. A 'Suspicious' flag prompts an analyst to investigate an event that deviates from established benign patterns.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104 (PowerShell Script Block Logging)
  - End-user Workstations, Application Servers, Domain Controllers
  - ML Model Scores
  range: Last 90 days
  queries:
  - pseudocode: FOR each share_deletion_event | EXTRACT features (time_of_day, user, parent_process) | CLASSIFY with logistic_regression_model | IF classification == 'Suspicious' THEN ALERT
- question: Is there a rapid sequence of an SMB connection, file activity, and subsequent share deletion from the same user and host?
  context: This sequence of events is highly indicative of an adversary mounting a network share, performing an action (like staging or exfiltrating data), and then immediately cleaning up by removing the share to hide their tracks. Correlating these events within a short time frame (e.g., 15 minutes) helps to reconstruct the adversary's actions and provides strong evidence of malicious intent.
  answer_sources:
  - Windows Event ID 5145
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Zeek smb_files.log
  - Zeek conn.log
  - File Servers, Network Security Monitoring Sensors, Domain Controllers, Endpoint Devices
  range: Last 90 days
  queries:
  - pseudocode: CORRELATE by user, host over 15_min_window: EVENT_1 (smb_connection) FOLLOWED BY EVENT_2 (file_access) FOLLOWED BY EVENT_3 (share_deletion) | IF sequence_matches THEN ALERT
- question: Was an anomalously short SMB session immediately followed by a share deletion command?
  context: Adversaries performing quick "smash and grab" operations often establish network connections for a very short period. This question aims to identify these outliers by baselining normal SMB session durations for each user and share. A session that is unusually short (e.g., in the bottom 5th percentile) and is immediately followed by a share deletion command is highly suspicious and suggests automated or scripted cleanup activity.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4688
  - File Servers, Network Security Monitoring Sensors, Domain Controllers, Endpoint Devices
  range: Last 90 days
  queries:
  - pseudocode: FOR each smb_session | CALCULATE duration | IF duration < 5th_percentile_for_user_share_pair AND followed_by_share_deletion_event THEN ALERT
- question: Does a sequence of user actions involving a share deletion deviate from behavior learned by a sequence analysis model?
  context: This question uses advanced modeling to understand the normal "grammar" of user actions on the network. A sequence analysis model (like a Hidden Markov Model) can learn typical event sequences. When a new sequence containing a share deletion appears and the model assigns it a low probability, it means the sequence is abnormal and does not fit learned benign patterns, warranting an investigation.
  answer_sources:
  - Windows Event ID 5145
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Zeek smb_files.log
  - Zeek conn.log
  - File Servers, Network Security Monitoring Sensors, Domain Controllers, Endpoint Devices
  - ML Model Scores
  range: Last 90 days
  queries:
  - pseudocode: FOR each new_event_sequence_containing_share_deletion | SCORE sequence_probability with HMM_model | IF probability < threshold THEN ALERT
- question: Did a very short SMB session occur without a corresponding user logoff event?
  context: A short SMB session is often normal if it's tied to a user logging off. However, a very short session (e.g., under 60 seconds) that is not associated with a logoff event is anomalous. This could represent an automated script connecting, performing a quick action, and disconnecting, which is a common pattern for adversary tools trying to minimize their footprint.
  answer_sources:
  - Zeek conn.log
  - Zeek smb_mapping.log
  - Windows Event ID 4634
  - Network Security Monitoring Sensors (e.g., Zeek), Core Switches, File Servers, Authentication Logs from Domain Controllers
  range: Last 90 days
  queries:
  - pseudocode: FIND smb_sessions with duration < 60s | FOR each session, CHECK for user_logoff_event on source_host within 2_mins | IF no_logoff_event THEN ALERT
- question: Was there a sudden, significant drop in a client's SMB traffic that cannot be explained by a user logging off?
  context: This question looks for macro-level changes in network behavior. A sudden, sharp drop in SMB traffic from a specific client, identified through statistical analysis (e.g., more than 3 standard deviations below the moving average), could indicate that active shares were abruptly disconnected. If this drop doesn't align with a normal user logoff, it may be the result of a malicious process cleaning up multiple connections at once.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4634
  - Network Security Monitoring Sensors (e.g., Zeek), Core Switches, File Servers, Authentication Logs from Domain Controllers
  range: Last 90 days
  queries:
  - pseudocode: MODEL smb_traffic_volume per client using time_series | DETECT drops > 3_std_dev | IF drop is not correlated with a user_logoff_event THEN ALERT
- question: Does a time-series anomaly detection model identify an SMB session as having an anomalously short duration?
  context: This question applies a sophisticated time-series model to account for complex patterns like time of day and day of the week (seasonality) when judging session durations. An anomalously short session, as identified by a model like Prophet, is a stronger indicator of suspicious activity than one identified by a simple threshold, as it has been judged abnormal against a learned, dynamic baseline of normal behavior.
  answer_sources:
  - Zeek conn.log
  - Network Security Monitoring Sensors (e.g., Zeek), Core Switches, File Servers, Authentication Logs from Domain Controllers
  - ML Model Scores
  range: Last 90 days
  queries:
  - pseudocode: MODEL normal_smb_session_durations with Prophet | FOR each new_session, PREDICT expected_duration_range | IF actual_duration is outside confidence_interval THEN ALERT