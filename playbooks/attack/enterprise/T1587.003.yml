name: T1587.003: Digital Certificates
id: a7f9c1b0-3e2d-4c5b-8a1f-9e8d7c6b5a4d
description: >
  This playbook helps determine if an adversary is developing resources related to digital certificates for future operations. It focuses on identifying malicious or suspicious certificates by checking against known threat intelligence indicators (SHA1, serial number, issuer), detecting self-signed certificates or those from free CAs for new or typosquatted domains, analyzing anomalous characteristics like high entropy or unusual validity periods, identifying certificate reuse across multiple distinct IP addresses or SNIs, and flagging certificates that are newly issued for newly registered domains. These activities are precursors to phishing, C2 communications, and other malicious actions.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
investigative_questions:
  - question: Are any observed digital certificates matching known malicious indicators based on their SHA1 hash, serial number, or issuer?
    context: This question performs a direct comparison of certificate attributes against a blocklist from threat intelligence. A match provides a high-fidelity signal of a known malicious certificate being used in the environment, enabling rapid detection of established threats.
    answer_sources:
      - Zeek ssl.log
      - Network egress points, web proxies, mail gateways, and inline TLS decryption devices where TLS inspection is performed.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each certificate IN Zeek_ssl_logs:
            IF certificate.sha1 IN malicious_ioc_list OR
               certificate.serial IN malicious_ioc_list OR
               certificate.issuer IN malicious_ioc_list:
              ALERT(high, "Malicious Certificate IOC Match", certificate)
  - question: Are there any extremely rare certificate issuers observed on the network that are not on an approved allowlist?
    context: This question seeks to identify potentially malicious C2 infrastructure by flagging certificates from very uncommon issuers. Adversaries may use custom or obscure CAs. By calculating the prevalence of all issuers and focusing on the rarest ones (e.g., bottom 0.1 percentile), analysts can uncover suspicious certificates that might otherwise be missed. Correlating with low-reputation IPs adds further context for prioritization.
    answer_sources:
      - Zeek ssl.log
      - Network egress points, web proxies, mail gateways, and inline TLS decryption devices where TLS inspection is performed.
    range: last 30 days
    queries:
      - search_technology: pseudocode
        query: |
          CALCULATE issuer_prevalence over last 30 days from Zeek_ssl_logs.
          FOR each certificate in Zeek_ssl_logs:
            IF issuer_prevalence[certificate.issuer] < 0.1_percentile AND
               certificate.issuer NOT IN known_good_issuer_list:
              ALERT(medium, "Rare Certificate Issuer Detected", certificate)
  - question: Can a machine learning model identify previously unseen certificates that are likely malicious based on their attributes?
    context: This question uses a predictive approach for certificates that don't match known IOCs. By training a classification model on features like validity period, key algorithm, and subject/issuer information, the system can score new certificates for their probability of being malicious. This helps detect novel threats and zero-day attack infrastructure.
    answer_sources:
      - Zeek ssl.log
      - Network egress points, web proxies, mail gateways, and inline TLS decryption devices where TLS inspection is performed.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each new_certificate in Zeek_ssl_logs:
            IF new_certificate NOT IN known_ioc_list:
              features = EXTRACT_FEATURES(new_certificate)
              score = ML_MODEL.predict_proba(features)
              IF score > 0.85:
                ALERT(medium, "High Probability Malicious Certificate Detected by ML", new_certificate)
  - question: Have any self-signed certificates been observed in network traffic, and have any of them been installed as a root CA on endpoints?
    context: This question identifies self-signed certificates, which are often used for internal services but can also be a hallmark of C2 infrastructure or man-in-the-middle attacks. Correlating a network-observed self-signed certificate with its installation as a trusted root CA on an endpoint (via Windows Event ID 41) is a strong indicator of a T1553.004 compromise.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Windows Event ID 41 (Microsoft-Windows-CAPI2/Operational)
      - Network egress points, corporate DNS resolvers, and all enterprise Windows endpoints' certificate trust stores.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each certificate IN Zeek_ssl_logs:
            IF certificate.issuer == certificate.subject:
              ALERT(low, "Self-Signed Certificate Observed", certificate)
              SEARCH Windows_Event_Logs(ID=41) for certificate.thumbprint
              IF found:
                ALERT(high, "Self-Signed Root CA Installed on Endpoint", certificate)
  - question: Are there any certificates issued by free CAs for domains that are either very new or potential typosquats of our corporate or partner domains?
    context: Adversaries frequently use free CAs (like Let's Encrypt) and typosquatted domains for phishing and C2. This question combines multiple suspicious signals: a free certificate, a recently created domain (low age percentile), and a domain name that is visually similar to a legitimate one (low Levenshtein distance). The combination of these factors significantly increases the likelihood of malicious intent.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Windows Event ID 41 (Microsoft-Windows-CAPI2/Operational)
      - Network egress points, corporate DNS resolvers, and all enterprise Windows endpoints' certificate trust stores.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          CALCULATE domain_age_percentiles from passive_dns.
          FOR each certificate IN Zeek_ssl_logs:
            IF certificate.issuer IN free_ca_list:
              domain = certificate.subject_cn
              IF LEVENSHTEIN_DISTANCE(domain, internal_domains) < 3 OR
                 DOMAIN_AGE_PERCENTILE(domain) < 5:
                ALERT(medium, "Suspicious Free Certificate Detected", certificate)
  - question: Has there been an anomalous spike in DNS queries for domains associated with self-signed or free CA certificates?
    context: This question uses time-series anomaly detection to find unusual patterns of interest in potentially suspicious domains. A sudden, significant increase in DNS lookups for a domain using a self-signed or free CA certificate, deviating from its historical baseline, can indicate the activation of C2 channels or the start of a phishing campaign.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Windows Event ID 41 (Microsoft-Windows-CAPI2/Operational)
      - Network egress points, corporate DNS resolvers, and all enterprise Windows endpoints' certificate trust stores.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each suspicious_domain (self-signed or free-CA cert):
            MODEL DNS query volume for suspicious_domain using time-series forecast.
            IF current_query_volume > forecasted_upper_bound:
              ALERT(medium, "Anomalous DNS Activity for Suspicious Domain", suspicious_domain)
  - question: Are there any observed certificates with an unusually short (<30 days) or long (>825 days) validity period?
    context: This question establishes a simple rule-based check for certificate validity periods that fall outside the common industry standards. While some legitimate CAs use short periods (e.g., Let's Encrypt's 90 days), extremely short or long durations are anomalous and often associated with malicious C2 or auto-generated self-signed certificates. This provides a quick filter for potentially suspicious certificates.
    answer_sources:
      - Zeek ssl.log
      - Network egress points, web proxies, and inline TLS decryption devices where full certificate details are visible.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each certificate IN Zeek_ssl_logs:
            validity = certificate.not_valid_after - certificate.not_valid_before
            IF (validity < 30_days OR validity > 825_days) AND
               certificate.issuer NOT IN known_short_lived_issuer_list:
              ALERT(low, "Anomalous Certificate Validity Period", certificate)
  - question: Are any certificates statistical outliers based on the entropy of their subject/issuer fields or their validity duration compared to the network baseline?
    context: This question aims to identify certificates that deviate significantly from the norm established within the organization's network. High entropy in subject/issuer fields can indicate algorithmically generated domain names (DGAs), while outliers in validity period can also signal malicious activity. Using statistical measures like z-scores or IQR helps to dynamically define "normal" and flag deviations without hardcoded thresholds.
    answer_sources:
      - Zeek ssl.log
      - Network egress points, web proxies, and inline TLS decryption devices where full certificate details are visible.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          CALCULATE baseline stats (mean, stddev) for entropy and validity over last 90 days.
          FOR each new_certificate:
            CALCULATE z_score for entropy(subject), entropy(issuer), validity.
            IF any_z_score > 3:
              ALERT(medium, "Statistical Outlier Certificate Detected", new_certificate)
  - question: Can a clustering algorithm identify certificates with an unusual combination of attributes that should be reviewed by an analyst?
    context: This question uses unsupervised machine learning to find "needles in a haystack." Instead of looking for one specific bad attribute, it looks for combinations of attributes that are collectively rare. A clustering algorithm like DBSCAN can group typical certificates together and classify the anomalous ones as "noise." These noise points represent certificates that don't fit any normal profile and are prime candidates for manual investigation.
    answer_sources:
      - Zeek ssl.log
      - Network egress points, web proxies, and inline TLS decryption devices where full certificate details are visible.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          CREATE feature_vectors for all certificates (entropy, validity, etc.).
          RUN DBSCAN clustering on the feature vectors.
          FOR each certificate classified as "noise":
            ALERT(low, "Anomalous Certificate Cluster (Noise) Detected", certificate)
  - question: Is a suspicious certificate (e.g., self-signed, high entropy) being used to communicate with multiple distinct IP addresses in a short time frame?
    context: This question looks for the reuse of a single, already-suspicious certificate across a wide range of destination IPs. This pattern is highly indicative of shared C2 infrastructure, where one certificate is deployed on multiple compromised hosts or redirectors. Limiting the check to IPs in different subnets helps reduce false positives from legitimate load-balanced services.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network egress points, flow data collectors (e.g., NetFlow/IPFIX), and inline TLS decryption devices.
    range: last 24 hours
    queries:
      - search_technology: pseudocode
        query: |
          FOR each certificate on suspicious_watchlist:
            COUNT unique destination_ips in different /24 subnets over 24 hours.
            IF count > 3:
              ALERT(high, "Suspicious Certificate Reused Across Multiple IPs", certificate)
  - question: Are any certificates associated with an unusually high number of unique IP addresses or Server Name Indications (SNIs) compared to the network baseline?
    context: This question identifies certificate reuse at scale by finding certificates whose IP/SNI association count is in the top percentile. While some large CDNs will have high counts, a non-CDN certificate appearing across many distinct endpoints is a strong signal of a large C2 network. This statistical approach helps to dynamically identify what "too many" means in the context of the specific network environment.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network egress points, flow data collectors (e.g., NetFlow/IPFIX), and inline TLS decryption devices.
    range: last 7 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each certificate_sha1:
            COUNT unique IPs and SNIs over last 7 days.
          CALCULATE 99th percentile for IP_counts and SNI_counts.
          FOR each certificate_sha1:
            IF its_ip_count > 99th_percentile OR its_sni_count > 99th_percentile:
              ALERT(medium, "Certificate Associated with Anomalously High IPs/SNIs", certificate_sha1)
  - question: Can graph analysis identify certificates that act as central hubs connecting disparate groups of servers and SNIs?
    context: This question models the relationships between certificates, IPs, and SNIs as a graph to uncover complex infrastructure patterns. Community detection algorithms group related assets together (e.g., a legitimate service and its IPs). A certificate that has high centrality and connects to many nodes outside of a well-defined community is likely a shared resource across unrelated malicious infrastructure, making it a key pivot point for investigation.
    answer_sources:
      - Zeek ssl.log
      - Zeek conn.log
      - Network egress points, flow data collectors (e.g., NetFlow/IPFIX), and inline TLS decryption devices.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          BUILD graph with nodes for cert_sha1s, IPs, and SNIs.
          RUN community detection algorithm (e.g., Louvain).
          CALCULATE degree centrality for all cert_sha1 nodes.
          IDENTIFY cert_sha1 nodes with high centrality connecting multiple communities.
          ALERT(medium, "Certificate Identified as C2 Hub via Graph Analysis", certificate_node)
  - question: Are employees connecting to domains that were registered very recently (e.g., within the last 7 days) and that also use a very new certificate?
    context: This question targets a common adversary TTP known as "just-in-time" infrastructure provisioning. Attackers register a domain and immediately get a certificate for it right before a campaign. A connection to a domain where both the domain and its certificate are brand new is highly suspicious and could indicate phishing or a C2 connection.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points, corporate DNS resolvers, and external threat intelligence platforms providing passive DNS data.
    range: last 7 days
    queries:
      - search_technology: pseudocode
        query: |
          FOR each connection in ssl.log:
            domain = connection.server_name
            cert_issue_date = connection.certificate.not_valid_before
            domain_first_seen = GET_PASSIVE_DNS_FIRST_SEEN(domain)
            IF domain_first_seen < 7_days_ago AND cert_issue_date < 7_days_ago:
              ALERT(medium, "Connection to Newly Registered Domain with New Certificate", connection)
  - question: Are there any connections where the time between the domain's registration and the certificate's issuance is unusually short?
    context: This question refines the previous one by focusing on the delta between domain registration and certificate issuance. A very short delta (e.g., under 24 hours) is a strong indicator of automated, ephemeral infrastructure setup used by adversaries. By identifying deltas in the bottom percentile, we can flag the most suspicious cases of this "just-in-time" behavior.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points, corporate DNS resolvers, and external threat intelligence platforms providing passive DNS data.
    range: last 30 days
    queries:
      - search_technology: pseudocode
        query: |
          CALCULATE distribution of (cert_issue_date - domain_first_seen_date) over 30 days.
          FOR each new connection:
            delta = connection.cert.issue_date - connection.domain.first_seen
            IF delta < 1st_percentile_of_deltas (e.g., < 24 hours):
              ALERT(medium, "Anomalously Short Time Between Domain Reg and Cert Issue", connection)
  - question: Has there been an anomalous spike in the registration of new domains that correlates with a spike in new certificates from free or self-signed CAs?
    context: This question looks for macro-level trends indicating a large-scale campaign setup. A time-series model can predict the normal daily volume of new domains and new suspicious certificates. When both metrics spike simultaneously and exceed their forecasted values, it suggests a coordinated effort to build out a large volume of malicious infrastructure, warranting a high-priority investigation.
    answer_sources:
      - Zeek ssl.log
      - Zeek dns.log
      - Network egress points, corporate DNS resolvers, and external threat intelligence platforms providing passive DNS data.
    range: last 90 days
    queries:
      - search_technology: pseudocode
        query: |
          MODEL daily_new_domain_count with time-series forecast.
          MODEL daily_new_suspicious_cert_count with time-series forecast.
          IF current_new_domain_count > forecast AND
             current_new_suspicious_cert_count > forecast:
            ALERT(high, "Correlated Spike in New Domains and Suspicious Certs", trend_data)