name: T1480.001: Environmental Keying
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: "This playbook helps determine if an adversary is evading defenses by checking for specific environmental properties before executing their main payload. This technique, known as environmental keying, involves the malware conducting reconnaissance to determine if it is running in a sandbox, a virtual machine, or on a specific target's network. Indicators include a process executing a series of host-based discovery commands within a short time window before connecting to a malicious C2 server; a process executing a specific, ordered sequence of system discovery commands; a process executing an unusually high number or variety of discovery commands; an unsigned executable terminating almost immediately after creation, suggesting a key mismatch; or a host performing network reconnaissance to determine its own hostname or external IP address."
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: "Is a process executing discovery commands and then connecting to a known malicious C2 server?"
    context: "This question aims to identify a common pattern of environmental keying where malware first performs reconnaissance on the host (e.g., using 'whoami', 'systeminfo') to ensure it is on a legitimate target and not a sandbox. Immediately following these checks, it establishes a connection to a Command and Control (C2) server. Correlating process discovery activity with subsequent network connections to known malicious IPs or domains within a short time window is a high-fidelity indicator of this technique."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Endpoint devices, Domain Controllers, Network egress points (Firewall/Proxy), DNS Resolvers"
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (EID 4688) with discovery commands. JOIN by host IP with network connection logs (Zeek) within a 5-minute window. FILTER for destination IPs/domains in C2 threat feed."
  - question: "Is a process that executed discovery commands making an unusually rare network connection for its host?"
    context: "This question focuses on anomaly detection to find environmental keying activity without relying on known malicious signatures. By establishing a baseline of normal process and network behavior for each host, we can identify outliers. A process that runs discovery commands and then connects to a destination that is rarely or never seen for that host is highly suspicious, as it deviates from established patterns and may indicate the first stage of a malware infection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Endpoint devices, Domain Controllers, Network egress points (Firewall/Proxy), DNS Resolvers"
    range: "last 90 days"
    queries:
      - "FOR each host, CREATE a 30-day baseline of process-to-destination connections. CALCULATE rarity for new connections made by processes that previously ran discovery commands. ALERT if rarity is in the top 1%."
  - question: "Can a machine learning model classify a process as malicious based on its execution of discovery commands followed by network activity?"
    context: "This question proposes using a supervised machine learning model to automate the detection of malicious sequences. By training a classifier on features like process name, command-line arguments, and subsequent network activity (destination, port, etc.), the system can learn to distinguish between benign and malicious behavior patterns. This allows for the detection of novel threats that use environmental keying, as long as they exhibit similar structural characteristics to known malware."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Endpoint devices, Domain Controllers, Network egress points (Firewall/Proxy), DNS Resolvers"
    range: "last 90 days"
    queries:
      - "TRAIN a Random Forest classifier on labeled data (process features, network features). PREDICT on new events where discovery commands are followed by network connections. ALERT if prediction is 'malicious' with high confidence."
  - question: "Is a process executing a specific, ordered sequence of discovery commands known to be used by malware?"
    context: "This question focuses on signature-based detection for known environmental keying patterns. Certain malware families use a consistent, hardcoded sequence of commands to check the environment (e.g., checking UUID, then MAC address, then domain trusts). Detecting this exact sequence of commands executed by the same process within a very short time frame is a high-confidence indicator of a specific, known threat."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows endpoints and servers, Active Directory domain controllers"
    range: "last 90 days"
    queries:
      - "SEARCH for process creation events (EID 4688). TRIGGER alert if 'wmic csproduct get uuid', 'getmac', 'nltest /domain_trusts' are executed by the same PID/PPID within 30 seconds."
  - question: "Is a process executing a statistically rare sequence of commands?"
    context: "This question applies n-gram analysis, a technique from natural language processing, to find unusual sequences of command-line executions. By baselining common command pairs (bigrams) and triplets (trigrams) on a host, we can calculate the probability of any new sequence occurring. A sequence with a very low probability is anomalous and could represent a scripted attack, such as an adversary's environmental keying logic."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows endpoints and servers, Active Directory domain controllers"
    range: "last 90 days"
    queries:
      - "CREATE a 30-day baseline of command bigram/trigram probabilities. CALCULATE joint probability of new command sequences. ALERT if probability is below the 1st percentile."
  - question: "Does a sequence of command-line executions deviate from the normal behavior learned by an LSTM model?"
    context: "This question leverages a sophisticated anomaly detection model, an LSTM autoencoder, which is ideal for sequential data like command-line executions. The model learns the 'grammar' of normal command sequences for users and hosts. When a new sequence is observed that the model cannot accurately reconstruct, it signals a high reconstruction error, indicating the sequence is a significant anomaly and warrants investigation for malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows endpoints and servers, Active Directory domain controllers"
    range: "last 90 days"
    queries:
      - "TRAIN an LSTM autoencoder on historical command sequences. FEED new sequences into the model. ALERT if the reconstruction error is high."
  - question: "Is a single process executing an excessive number of distinct discovery commands in a short time frame?"
    context: "This question is based on a simple but effective thresholding rule. While an administrator might run one or two discovery commands, it is highly unusual for a single automated process to execute a large variety of them (e.g., 'systeminfo', 'whoami', 'ipconfig', 'netstat', 'tasklist') in under a minute. This behavior is a strong sign of automated reconnaissance, often performed by malware as part of its environmental checks."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows endpoints and servers, User workstations, Critical servers"
    range: "last 90 days"
    queries:
      - "SEARCH for process creation events (EID 4688). COUNT distinct discovery commands per PID within a 60-second window. ALERT if count > 5."
  - question: "Is there a sudden spike in the variety of commands being executed, or an unusually high frequency of discovery commands on a host?"
    context: "This question uses information theory to detect anomalous command-line activity. By calculating the Shannon entropy of commands in a rolling time window, we can detect a sudden increase in variety, which may indicate a shift from normal operations to reconnaissance. This is complemented by a frequency analysis to flag hosts that are executing an unusually high volume of discovery commands compared to their peers, pointing to potential malware activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows endpoints and servers, User workstations, Critical servers"
    range: "last 90 days"
    queries:
      - "CALCULATE a rolling 5-minute Shannon entropy of commands per host. ALERT if entropy exceeds baseline by 3 standard deviations. Also, ALERT if discovery command frequency is in the 99th percentile."
  - question: "Does a host's command execution activity deviate from its normal profile as defined by a one-class SVM model?"
    context: "This question proposes building a machine learning model of 'normal' for each host profile (e.g., developer, HR). A one-class SVM is trained exclusively on normal activity vectors (representing command frequency and variety). It then classifies new activity in real-time. Any activity that the model flags as an anomaly suggests behavior outside the established norm, which could be an indicator of environmental keying or other malicious actions."
    answer_sources:
      - "Windows Event ID 4688"
      - "All Windows endpoints and servers, User workstations, Critical servers"
    range: "last 90 days"
    queries:
      - "TRAIN a one-class SVM model on vectors of normal command frequency/variety per host profile. CLASSIFY new 5-minute activity vectors. ALERT if classified as an anomaly."
  - question: "Is an unsigned process from a non-standard path terminating almost immediately after creation?"
    context: "This question looks for a key symptom of a failed environmental keying check. If malware determines it is in a sandbox or analysis environment, it may immediately terminate to prevent analysis. By correlating process creation and termination events, we can identify processes with a very short lifespan (<2 seconds). If such a process is also unsigned and running from a temporary or unusual directory, it is highly suspicious."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4689"
      - "All Windows endpoints and servers, especially user workstations"
    range: "last 90 days"
    queries:
      - "CORRELATE process creation (EID 4688) and termination (EID 4689). ALERT if process duration < 2 seconds AND process is unsigned AND path is non-standard (e.g., %TEMP%)."
  - question: "Is a process terminating significantly faster than its historical average execution time?"
    context: "This question applies statistical analysis to process execution durations. For every process name, we can establish a baseline of its normal runtime. An instance of a process that terminates in a duration that is a significant statistical outlier (e.g., more than two standard deviations below the mean) is anomalous. This could indicate a crash, but in the context of a security investigation, it can also point to a self-terminating malicious process after a failed environmental check."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4689"
      - "All Windows endpoints and servers, especially user workstations"
    range: "last 90 days"
    queries:
      - "CALCULATE mean and standard deviation of execution duration per process name. ALERT if a process instance's duration is < (mean - 2*stdev) or < 1 second. Increase risk if unsigned."
  - question: "Can unsupervised machine learning identify clusters of short-lived, unsigned processes that indicate malicious activity?"
    context: "This question uses an unsupervised approach (clustering) to find new threats. By grouping processes based on features like execution duration, parent process, file path, and signature status, we can automatically surface clusters of suspicious activity. Investigating clusters of processes that are short-lived and unsigned can help analysts discover previously unknown malware families that use environmental keying and self-termination."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4689"
      - "All Windows endpoints and servers, especially user workstations"
    range: "last 90 days"
    queries:
      - "CLUSTER processes using DBSCAN on features (duration, signature, path, etc.). INVESTIGATE clusters of short-lived, unsigned processes."
  - question: "Is a host trying to discover its own internal FQDN or external IP address via network requests?"
    context: "This question looks for overt network-based reconnaissance. Malware may need to know its public IP address or its internal hostname to make decisions or report back to its C2 server. This can be accomplished by connecting to public 'what-is-my-IP' services (e.g., 'api.ipify.org') or by sending a DNS query for its own internal hostname to an external DNS resolver. Both actions are unusual for legitimate applications and are strong indicators of environmental keying."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS servers, Network egress points (Firewall/Proxy), Web Proxies"
    range: "last 90 days"
    queries:
      - "SEARCH DNS logs for internal hostnames queried against external resolvers. SEARCH connection logs for traffic to known 'what-is-my-ip' services."
  - question: "Is a host connecting to 'what-is-my-ip' services more frequently than its peers, or exhibiting unusual DNS query patterns?"
    context: "This question adds a layer of behavioral analytics to network reconnaissance detection. While a single connection to an IP-checking service might be benign, frequent connections are not. By baselining this activity, we can flag hosts that exhibit this behavior more often than their peers. Additionally, analyzing the Shannon entropy of Top-Level Domains (TLDs) in DNS requests can reveal unusual patterns that deviate from a host's normal browsing activity."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS servers, Network egress points (Firewall/Proxy), Web Proxies"
    range: "last 90 days"
    queries:
      - "BASELINE host connections to 'what-is-my-ip' services. ALERT if host frequency is in 95th percentile. CALCULATE Shannon entropy of TLDs; ALERT on sudden changes."
  - question: "Can a machine learning model classify network traffic as reconnaissance based on its characteristics?"
    context: "This question seeks to automate the detection of network reconnaissance using a supervised machine learning model. By training a classifier on features from network logs (e.g., destination port, protocol, data volume, DNS query type, User-Agent), the model can learn to distinguish benign traffic from malicious reconnaissance. This enables the system to flag suspicious network events with high confidence, even if they don't match a predefined rule or signature."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS servers, Network egress points (Firewall/Proxy), Web Proxies"
    range: "last 90 days"
    queries:
      - "TRAIN a Logistic Regression classifier on labeled network data. PREDICT on new network events. ALERT if classified as 'reconnaissance' with high confidence."