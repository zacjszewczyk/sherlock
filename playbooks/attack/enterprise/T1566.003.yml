name: 'T1566.003: Spearphishing via Service'
id: '3a4f8b1c-9d0e-4a6f-b8e7-1c2d3e4f5a6b'
description: This playbook helps investigate whether an adversary has gained initial access by delivering a malicious payload via a third-party service. It focuses on detecting threats by analyzing network and endpoint data for indicators such as known-bad file hashes or domains associated with downloads from services like LinkedIn or personal webmail; suspicious process execution chains following a download (e.g., an Office application spawning a shell); high-risk file types or deceptive filenames; subsequent outbound connections to newly registered or high-entropy domains; and an unusually high number of hosts downloading the same file from a service in a short period.
type: technique
related:
  - 'TA0001: Initial Access'
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
  - question: Has a file downloaded from a third-party service been identified as malicious by threat intelligence?
    context: This question aims to directly identify known threats by correlating network download logs (Zeek files.log, http.log) from non-corporate, third-party services with high-confidence threat intelligence feeds. A match on a file hash or destination host provides a strong, direct indicator of a malicious file delivery attempt, allowing for rapid response.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - Network Security Monitoring (NSM) sensors at internet egress points
      - Centralized log aggregator (SIEM)
      - Threat intelligence platform.
    range: last 90 days
    queries:
      - 'Search network file logs for downloads from third-party services. Correlate file hashes and destination hosts against threat intelligence feeds. Alert on matches.'
  - question: Is there an anomalous spike in threat intelligence matches for downloads from a specific third-party service?
    context: This question seeks to identify a targeted campaign that may be leveraging a specific third-party service for payload delivery. By establishing a baseline of "normal" threat intelligence match rates for each service, a significant deviation from this baseline (e.g., exceeding the 99th percentile) can indicate a concentrated attack effort, even if the individual indicators are not new.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - Network Security Monitoring (NSM) sensors at internet egress points
      - Centralized log aggregator (SIEM)
      - Threat intelligence platform.
    range: last 90 days
    queries:
      - 'For each third-party service, calculate the hourly rate of threat intel matches. Compare this rate to a historical 30-day baseline. Alert if the current rate exceeds the 99th percentile.'
  - question: Has a machine learning model predicted that a file downloaded from a third-party service is malicious?
    context: This question leverages a predictive approach to identify potentially unknown or zero-day threats. By training a classification model on various features from network logs (MIME type, file size, domain reputation, etc.), it is possible to score downloads for maliciousness in near real-time. An alert on a high-confidence score can surface threats that might be missed by signature-based detection alone.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - Network Security Monitoring (NSM) sensors at internet egress points
      - Centralized log aggregator (SIEM)
      - Threat intelligence platform.
    range: last 90 days
    queries:
      - 'Score all file downloads from third-party services using a trained ML model. Alert on any download with a malicious score > 0.90.'
  - question: Did an office application spawn a shell or scripting engine shortly after a file was downloaded from a third-party service?
    context: This question identifies a classic malware execution pattern. Legitimate office applications rarely spawn command-line interpreters like powershell.exe or cmd.exe. Correlating a file download from a web service with this suspicious post-execution behavior on the endpoint within a short time window (5 minutes) strongly indicates that a malicious document or payload was opened by the user.
    answer_sources:
      - Windows Event ID 4688
      - Zeek files.log
      - Zeek http.log
      - Endpoint Detection and Response (EDR) agents on user workstations
      - Virtual Desktop Infrastructure (VDI) environment
      - Centralized Security Information and Event Management (SIEM) system.
    range: last 90 days
    queries:
      - 'Correlate network download logs from third-party services with endpoint process creation logs. Alert if an office process spawns a shell/scripting process on the same host within 5 minutes of the download.'
  - question: Has an office application spawned an anomalous child process or a process with unusually complex command-line arguments after a download from a third-party service?
    context: This question aims to detect stealthier execution techniques by baselining normal user and application behavior. Adversaries may use legitimate but unusual process chains. By profiling what child processes are normally spawned by parent processes like winword.exe for each user, any deviation from this baseline—such as a new child process or one with abnormally high command-line entropy—can signal malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Zeek files.log
      - Zeek http.log
      - Endpoint Detection and Response (EDR) agents on user workstations
      - Virtual Desktop Infrastructure (VDI) environment
      - Centralized Security Information and Event Management (SIEM) system.
    range: last 90 days
    queries:
      - 'Following a third-party download, compare child processes spawned by office applications against a 90-day user/parent process baseline. Alert on new child processes or command-line entropy > 3 standard deviations from the norm.'
  - question: Following a download from a third-party service, did a graph-based model identify the subsequent process execution chain as a high-scoring anomaly?
    context: This question uses advanced analytics to detect sophisticated attacks. By modeling entire process execution trees (parent-child-grandchild relationships) as a graph, it becomes possible to identify anomalous chains that might appear benign when looking at individual process pairs. A high anomaly score for a process tree originating from an office application after a download is a strong indicator of a complex, multi-stage payload execution.
    answer_sources:
      - Windows Event ID 4688
      - Zeek files.log
      - Zeek http.log
      - Endpoint Detection and Response (EDR) agents on user workstations
      - Virtual Desktop Infrastructure (VDI) environment
      - Centralized Security information and Event Management (SIEM) system.
    range: last 90 days
    queries:
      - 'After a third-party download, analyze the subsequent process tree on the endpoint using a graph anomaly detection model. Alert on any chain originating from an office app that is flagged as a high-scoring outlier.'
  - question: Was a file with a high-risk file type or a deceptive filename (e.g., double extension) downloaded from a third-party service?
    context: This question targets common social engineering tricks used in filenames and file types. Adversaries often use double extensions (e.g., report.pdf.exe) to disguise executable files or use high-risk types like HTA files or macro-enabled documents. Directly alerting on the download of such files from external services provides an early warning of a potential spearphishing attempt before the user even executes the file.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Network Security Monitoring (NSM) sensors at the network perimeter
      - Web content filters
      - Centralized log aggregator (SIEM).
    range: last 90 days
    queries:
      - 'Monitor file download logs from third-party services. Alert if filename matches a double-extension regex or if the MIME type is on a high-risk blocklist.'
  - question: Is there an anomalous increase in the proportion of high-risk file types being downloaded from a specific third-party service?
    context: This question helps detect a potential campaign focused on a specific service. While occasional high-risk file downloads might be normal, a sudden surge in their proportion relative to benign files from a single service is abnormal. Exceeding a statistical threshold (98th percentile) of the historical baseline suggests a targeted attack leveraging that service.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Network Security Monitoring (NSM) sensors at the network perimeter
      - Web content filters
      - Centralized log aggregator (SIEM).
    range: last 90 days
    queries:
      - 'For each third-party service, calculate the hourly proportion of high-risk vs. benign MIME types. Compare to a 30-day baseline. Alert if the proportion exceeds the 98th percentile.'
  - question: Has a machine learning model, based on file metadata, predicted a high probability of malicious intent for a file downloaded from a third-party service?
    context: This question uses predictive analytics on file characteristics to spot malicious downloads. Features like filename entropy, length, and the presence of keywords like 'invoice' or 'urgent', combined with MIME type, can be powerful predictors of maliciousness. A model trained on this metadata can flag suspicious files for review, even if the file hash is not yet known to be malicious.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Network Security Monitoring (NSM) sensors at the network perimeter
      - Web content filters
      - Centralized log aggregator (SIEM).
    range: last 90 days
    queries:
      - 'Score all files from third-party services using an ML model trained on file metadata (name, entropy, keywords, MIME type). Flag files with a high malicious probability score.'
  - question: Did a host connect to a newly registered domain (NRD) within 5 minutes of downloading a file from a third-party service?
    context: This question links a potential malware download to subsequent command-and-control (C2) activity. Adversaries frequently use newly registered domains for C2 infrastructure. Detecting a connection to a domain less than 30 days old, immediately following a file download from an external service, is a very strong indicator that the downloaded file was malicious and has initiated a callback.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek dns.log
      - DNS logs from internal resolvers
      - Firewall logs from egress points
      - Network Security Monitoring (NSM) sensors
      - Threat intelligence feeds.
    range: last 90 days
    queries:
      - 'Correlate file downloads from third-party services with subsequent DNS queries from the same host. Enrich DNS queries with WHOIS data. Alert if a query is made to a domain <30 days old within 5 minutes of the download.'
  - question: Following a file download from a third-party service, did the host query a rare domain with high character entropy?
    context: This question aims to detect algorithmically generated domains (DGAs), a common technique for C2 communication. DGA domains often appear as random, high-entropy strings. Identifying a DNS query for a domain that is both rare for the organization and has high entropy, shortly after a file download, strongly suggests malware attempting to contact its C2 server.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek dns.log
      - DNS logs from internal resolvers
      - Firewall logs from egress points
      - Network Security Monitoring (NSM) sensors
      - Threat intelligence feeds.
    range: last 90 days
    queries:
      - 'After a third-party download, analyze DNS queries from the host. Calculate domain name entropy. Alert if entropy is > 3.5 and the domain is not in the top 95% of historically accessed domains.'
  - question: After a file download from a third-party service, did the host exhibit an anomalous increase in outbound network traffic compared to its forecast?
    context: This question seeks to identify C2 beaconing or data exfiltration by looking for changes in the volume of network traffic. By creating a time series forecast of a host's normal outbound traffic, any significant, unexpected spike after a file download can indicate malicious activity. This method can catch beaconing that uses common ports and protocols, which might otherwise be missed.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek dns.log
      - DNS logs from internal resolvers
      - Firewall logs from egress points
      - Network Security Monitoring (NSM) sensors
      - Threat intelligence feeds.
    range: last 90 days
    queries:
      - 'Model a host''s expected outbound traffic volume using a time series forecast. After a third-party download, compare actual outbound traffic to the forecast. Alert on significant positive deviations.'
  - question: Have an unusually large number of hosts downloaded the exact same file from a third-party service in a short timeframe?
    context: This question is designed to detect the 'fan-out' of a coordinated spearphishing campaign. It is highly unusual for more than a few hosts to download the identical file (same hash) from a service like personal webmail within an hour. Detecting this pattern, for example, with a threshold of >10 hosts, is a powerful indicator of a widespread, targeted attack in progress.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek conn.log
      - Centralized logging infrastructure (SIEM)
      - Network traffic monitoring points at the network perimeter.
    range: last 90 days
    queries:
      - 'Count the number of distinct internal IPs downloading the same file hash from a third-party service within a one-hour window. Alert if the count exceeds a set threshold (e.g., 10).'
  - question: Is there a statistically significant spike in the number of unique hosts connecting to a specific third-party service?
    context: This question identifies a coordinated campaign by observing anomalous access patterns to the service itself. A threat actor might direct many users to the same service to download different payloads. A sudden surge in unique internal hosts connecting to that service, exceeding a statistical baseline by several standard deviations, can reveal the campaign's delivery infrastructure.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek conn.log
      - Centralized logging infrastructure (SIEM)
      - Network traffic monitoring points at the network perimeter.
    range: last 90 days
    queries:
      - 'Establish a 30-day baseline of unique source IPs connecting to each third-party service per hour. Alert if the current hourly count exceeds the baseline by >3 standard deviations.'
  - question: Has a clustering algorithm detected an anomalous, dense grouping of connections from many internal hosts to a new or rare third-party service?
    context: This question uses unsupervised machine learning to discover coordinated access patterns. A density-based algorithm like DBSCAN can analyze connection data and identify clusters. A dense cluster showing many unique internal hosts all connecting to a previously uncommon third-party domain in a tight time window is a strong signal of a campaign staging or delivery point.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek conn.log
      - Centralized logging infrastructure (SIEM)
      - Network traffic monitoring points at the network perimeter.
    range: last 90 days
    queries:
      - 'Apply a density-based clustering algorithm (e.g., DBSCAN) to network connection logs. Flag dense clusters showing many unique source IPs connecting to the same rare/new third-party service in a short time.'