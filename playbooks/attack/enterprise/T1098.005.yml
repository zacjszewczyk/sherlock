name: T1098.005: Device Registration
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps analysts investigate whether adversaries are establishing
  persistence (TA0003) or elevating privileges (TA0004) by registering malicious
  devices. It provides questions to detect anomalous registration activity, such
  as registrations from suspicious IP addresses or using malicious tools, devices
  with unusual naming conventions, registrations immediately following multiple failed
  login attempts, or an abnormally high volume of registrations. It also covers post-registration
  malicious behavior, including communication with command-and-control (C2) servers,
  rapid automated access to sensitive resources, bypassing conditional access policies,
  and internal network scanning from the newly registered device.
type: technique
related:
- TA0003: Persistence
- TA0004: Privilege Escalation
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a device registration originated from a known malicious IP address
    or been performed using a known malicious tool?
  context: This question aims to identify device registrations that are highly likely
    to be malicious by cross-referencing the source IP address against threat intelligence
    feeds or by matching the HTTP User-Agent string against signatures of known adversary
    tools like AADInternals or BPRT. A match indicates an attempt to establish persistence
    using compromised infrastructure or specialized tooling.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Azure AD Signin Logs
  - Internet Gateway (for Zeek logs)
  - Cloud Identity Provider (IdP) consoles (e.g., Azure AD, Okta, Duo)
  - VPN concentrators
  - Threat Intelligence Feeds
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Zeek conn.log WHERE destination_ip IN [IdP registration endpoints]
      | JOIN source_ip WITH threat_intel_feed | IF match, ALERT
  - technology: Pseudocode
    query: SEARCH Zeek http.log WHERE user_agent MATCHES ('AADInternals', 'BPRT')
      | ALERT
- question: Is a device registration originating from an unusually rare Autonomous
    System (AS) or country?
  context: Adversaries may use infrastructure in geographic locations or networks
    that are not typical for the organization. This question identifies device registrations
    from ASN/country pairs that are statistically rare compared to a 90-day baseline.
    Such anomalies may indicate that an adversary is using a compromised machine
    or a VPS in an unusual location to perform the registration.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Azure AD Signin Logs
  - Internet Gateway (for Zeek logs)
  - Cloud Identity Provider (IdP) consoles (e.g., Azure AD, Okta, Duo)
  - VPN concentrators
  - Geolocation/ASN database
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new registration GET source_ip_asn, source_ip_country | LOOKUP
      frequency of (asn, country) in 90-day baseline | IF frequency < 5th_percentile,
      ALERT
- question: Does a device registration event exhibit a combination of features that
    a machine learning model classifies as malicious?
  context: This question leverages a machine learning model to perform multi-faceted
    analysis of device registration events. By training on features like IP geolocation,
    ASN, time of day, User-Agent rarity, and known TOR/cloud provider status, the
    model can identify complex patterns of malicious behavior that simple rules might
    miss. An alert from a high-confidence classification suggests a sophisticated
    registration attempt.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Azure AD Signin Logs
  - Internet Gateway (for Zeek logs)
  - Cloud Identity Provider (IdP) consoles (e.g., Azure AD, Okta, Duo)
  - VPN concentrators
  - Machine Learning Model output
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new registration EXTRACT features (ip_geo, asn, time, user_agent_rarity,
      etc.) | INPUT features into classification_model | IF model_prediction == 'malicious'
      AND confidence > threshold, ALERT
- question: Has a device been registered with a name that violates the organizational
    naming convention or matches a known malicious signature?
  context: Organizations often have a standard naming convention for corporate devices.
    A device registered with a name that does not comply with this convention is
    anomalous and could be an adversary's personal device. This question uses regular
    expressions to check for non-compliance or for names associated with malicious
    tools.
  answer_sources:
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs (for Azure AD `OperationName Add device`)
  - Network decryption points for SSL/TLS inspection (for Zeek http.log visibility)
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Azure AD Audit Logs WHERE OperationName == 'Add device' | FILTER
      device_name NOT MATCHES regex(org_naming_convention) | ALERT
  - technology: Pseudocode
    query: SEARCH Zeek http.log (decrypted) | FILTER device_name MATCHES regex(malicious_tool_signatures)
      | ALERT
- question: Does a newly registered device have a name with unusually high randomness
    (entropy)?
  context: Adversaries may use randomly generated strings for device names to avoid
    easy identification or to automate device creation. This question involves calculating
    the Shannon entropy (a measure of randomness) of a new device name and comparing
    it to the historical distribution of entropy for legitimate devices. An exceptionally
    high entropy score is suspicious and warrants investigation.
  answer_sources:
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs (for Azure AD `OperationName Add device`)
  - Network decryption points for SSL/TLS inspection (for Zeek http.log visibility)
  range: last 180 days
  queries:
  - technology: Pseudocode
    query: FOR each new device_name CALCULATE shannon_entropy(device_name) | LOOKUP
      95th_percentile_entropy from 180-day baseline | IF entropy > 95th_percentile,
      ALERT
- question: Does a newly registered device's name fall into a cluster of other anomalous
    device names?
  context: This question uses unsupervised machine learning (clustering) to group
    device names based on characteristics like length, character types, and entropy.
    This can reveal previously unknown or emergent malicious naming patterns that
    don't fit a predefined rule. A new device falling into an identified anomalous
    cluster is highly suspicious.
  answer_sources:
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs (for Azure AD `OperationName Add device`)
  - Network decryption points for SSL/TLS inspection (for Zeek http.log visibility)
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR all device_names EXTRACT features (length, entropy, char_ratios) |
      RUN clustering_algorithm(features) | IDENTIFY anomalous_clusters | FOR each
      new device IF new_device_name in anomalous_cluster, ALERT
- question: Was a successful device registration for a user immediately preceded
    by numerous failed login attempts for that same user?
  context: A burst of failed login attempts followed by a successful device registration
    is a strong indicator of a brute-force or password spray attack culminating in
    an account compromise. The adversary, having gained access, then immediately
    registers their own device to establish persistent access. This temporal correlation
    is a critical detection opportunity.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Azure AD Signin Logs
  - Azure AD Audit Logs
  - Azure AD Risky Users
  - Authentication servers (Active Directory Domain Controllers for Windows Events)
  - Cloud Identity Provider (IdP) sign-in and audit logs
  - VPN concentrators
  range: last 15 minutes
  queries:
  - technology: Pseudocode
    query: ON event (Azure AD Audit Log `OperationName Add device` for user U) SEARCH
      Azure AD Signin Logs in last 15 mins for user U WHERE resultType == 50126 |
      IF count > 5, ALERT
- question: Does a new device registration deviate significantly from the user's
    established historical registration patterns?
  context: This question seeks to identify anomalous registrations by building a
    behavioral profile for each user based on their past registration activity (e.g.,
    source country, ASN, time of day). A new registration that deviates from this
    profile (e.g., from a new country or at an unusual time) is assigned a risk score.
    Exceeding a risk threshold suggests the activity may not be from the legitimate
    user.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Azure AD Signin Logs
  - Azure AD Audit Logs
  - Azure AD Risky Users
  - Authentication servers (Active Directory Domain Controllers for Windows Events)
  - Cloud Identity Provider (IdP) sign-in and audit logs
  - VPN concentrators
  range: last 180 days
  queries:
  - technology: Pseudocode
    query: FOR each new registration for user U CALCULATE risk_score (e.g., +3 for
      new_country, +2 for new_ASN, +1 for off-hours) based on user's 180-day profile
      | IF risk_score > 4, ALERT
- question: Is a new device registration by a user considered an outlier by a machine
    learning model trained on that user's past behavior?
  context: This question uses a per-user anomaly detection model (like a One-Class
    SVM) to establish a fine-grained baseline of normal registration behavior for
    each individual. The model is trained on features from a user's historical registrations.
    Any new registration that the model classifies as an outlier is highly anomalous
    and likely not performed by the legitimate user.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Azure AD Signin Logs
  - Azure AD Audit Logs
  - Azure AD Risky Users
  - Authentication servers (Active Directory Domain Controllers for Windows Events)
  - Cloud Identity Provider (IdP) sign-in and audit logs
  - VPN concentrators
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new registration for user U EXTRACT features (ip_geo, asn, time,
      etc.) | INPUT features into user_U_one_class_svm_model | IF model_prediction
      == 'outlier', ALERT
- question: Has an unusually high number of devices been registered from a single
    IP address or by a single user within one hour?
  context: Automated scripts used by adversaries can often result in a high volume
    of device registrations in a short period. This question uses simple thresholding
    to detect suspicious spikes, such as more than 5 devices registered from one
    IP or more than 2 devices registered by one user within an hour, which is not
    typical for normal user behavior.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs
  - Internet gateway
  range: last 1 hour
  queries:
  - technology: Pseudocode
    query: COUNT Azure AD device registrations over 1-hour window, GROUP BY source_ip
      | IF count > 5, ALERT
  - technology: Pseudocode
    query: COUNT Azure AD device registrations over 1-hour window, GROUP BY user
      | IF count > 2, ALERT
- question: Is the overall number of device registrations in the last hour a statistical
    anomaly compared to the 30-day norm?
  context: This question looks for organization-wide spikes in device registration
    activity. By comparing the current hourly count to a 30-day rolling average and
    standard deviation, it can detect significant deviations from the norm (e.g.,
    exceeding 3 standard deviations). Such a spike could indicate a large-scale,
    automated attack.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs
  - Internet gateway
  range: last 30 days
  queries:
  - technology: Pseudocode
    query: CALCULATE hourly_registration_count | CALCULATE 30-day_rolling_avg and
      std_dev | IF hourly_registration_count > (rolling_avg + 3 * std_dev), ALERT
- question: Has the hourly device registration count significantly exceeded the volume
    predicted by a time-series forecasting model?
  context: This question employs a more sophisticated statistical method than simple
    averages. A time-series forecasting model (like Prophet) can account for seasonality
    (e.g., time of day, day of week). An alert is triggered only when the actual number
    of registrations exceeds the upper bound of the model's 99% confidence interval,
    indicating a spike that is highly unlikely to be due to normal fluctuations.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs
  - Internet gateway
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: GET current_hourly_registration_count | GET predicted_count_upper_bound
      from forecasting_model | IF current_hourly_registration_count > predicted_count_upper_bound,
      ALERT
- question: Is a newly registered device communicating with known command-and-control
    (C2) infrastructure?
  context: One of the first actions an adversary's implant takes after installation
    is to "call home" to its C2 server. This question focuses on detecting this critical
    post-exploitation step by monitoring DNS queries and network connections from
    devices registered within the last 24 hours and checking them against a threat
    intelligence feed of known C2 domains and IPs.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Internet gateway (for Zeek logs)
  - DNS resolvers
  - Endpoint devices (for Windows Event Logs)
  - C2 Threat Intelligence Feed
  range: last 24 hours
  queries:
  - technology: Pseudocode
    query: GET IPs of devices registered in last 24 hours | SEARCH Zeek logs WHERE
      source_ip IN registered_device_ips | JOIN destination_ip_or_domain WITH c2_threat_intel_feed
      | IF match, ALERT
- question: Is a newly registered device making DNS queries to an unusual distribution
    of Top-Level Domains (TLDs)?
  context: Adversaries often use domains registered under cheap, low-reputation
    TLDs (e.g., .xyz, .top) for their C2 infrastructure. This question analyzes the
    TLDs in DNS queries from new devices. A device making a disproportionately high
    number of queries to such TLDs, compared to the organizational baseline, is suspicious
    and may be communicating with C2 servers.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Internet gateway (for Zeek logs)
  - DNS resolvers
  - Endpoint devices (for Windows Event Logs)
  range: last 24 hours
  queries:
  - technology: Pseudocode
    query: FOR each new_device GET dns_queries in last 24h | CALCULATE TLD_frequency_distribution
      | COMPARE to org_baseline_distribution | IF distribution shows high % of low-reputation_TLDs,
      ALERT
- question: Is a newly registered device attempting to resolve domain names that appear
    to be algorithmically generated (DGA)?
  context: Domain Generation Algorithms (DGAs) are used by malware to create a large
    number of potential C2 domains, making blocklisting difficult. This question
    uses a machine learning model (e.g., an LSTM) to analyze the syntax of domain
    names queried by new devices. A high DGA score indicates the domain is likely
    not human-generated and is probably part of a C2 mechanism.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Internet gateway (for Zeek logs)
  - DNS resolvers
  - Endpoint devices (for Windows Event Logs)
  - DGA detection model
  range: last 24 hours
  queries:
  - technology: Pseudocode
    query: FOR each dns_query from new_device INPUT query_string into dga_detection_model
      | IF dga_score > 0.85, ALERT
- question: Is a newly registered device rapidly accessing multiple distinct high-value
    assets?
  context: After gaining a foothold, adversaries often perform reconnaissance and
    data collection, which can look like rapid, automated access to multiple sensitive
    systems or files. This question identifies this behavior by monitoring access
    from new devices to a predefined list of "crown jewel" assets and alerting if
    multiple assets are accessed in a short time frame.
  answer_sources:
  - Zeek http.log
  - Zeek conn.log
  - Windows Event ID 4663
  - Windows Event ID 5145
  - Web servers hosting sensitive applications
  - File servers hosting sensitive data
  - Internal network segments monitored by network taps
  range: last 5 minutes
  queries:
  - technology: Pseudocode
    query: ON access to crown_jewel_asset from new_device_ip COUNT distinct crown_jewel_assets
      accessed by new_device_ip in last 5 mins | IF count > 3, ALERT
- question: Is a user's activity from a new device significantly faster than their
    normal, human-driven pace?
  context: Automated scripts operate much faster than human users. This question
    establishes a baseline of a user's typical "think time"â€”the delay between accessing
    different resources. If activity from that user's new device shows a median time
    delay that is statistically much shorter (e.g., below the 1st percentile) than
    their historical norm, it strongly suggests automated, non-human activity.
  answer_sources:
  - Zeek http.log
  - Zeek conn.log
  - Windows Event ID 4663
  - Windows Event ID 5145
  - Web servers hosting sensitive applications
  - File servers hosting sensitive data
  - Internal network segments monitored by network taps
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new_device_session for user U CALCULATE median_time_delta between
      resource accesses | GET user_U_baseline_time_delta_1st_percentile | IF median_time_delta
      < baseline_time_delta_1st_percentile, ALERT
- question: Is a user's sequence of application access from a new device inconsistent
    with their established pattern of behavior?
  context: Users typically access applications in predictable sequences (e.g., email
    -> intranet -> fileshare). This question models these typical sequences using
    a Markov chain for each user. An access sequence from a new device that has a
    very low probability of occurring according to the user's historical model suggests
    a deviation in behavior, possibly due to an adversary performing different tasks.
  answer_sources:
  - Zeek http.log
  - Zeek conn.log
  - Windows Event ID 4663
  - Windows Event ID 5145
  - Web servers hosting sensitive applications
  - File servers hosting sensitive data
  - Internal network segments monitored by network taps
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each new_device_session for user U GET sequence_of_apps_accessed |
      CALCULATE probability_of_sequence using user_U_markov_model | IF probability
      < threshold, ALERT
- question: Has a newly registered device been used to successfully bypass a Conditional
    Access policy that previously blocked the user?
  context: Adversaries may register a device specifically to meet compliance requirements
    and bypass Conditional Access policies (e.g., requiring a compliant or hybrid-joined
    device). This question explicitly looks for this scenario by identifying when
    a user, previously blocked from accessing a resource, suddenly gains access from
    a newly registered device.
  answer_sources:
  - Zeek http.log
  - Azure AD Signin Logs
  - Azure AD Conditional Access Logs
  - Azure AD Identity Protection Logs
  - Cloud Identity Provider (IdP) conditional access policy logs
  - Web Application Firewalls (WAFs)
  - Application-level authentication logs
  range: last 24 hours
  queries:
  - technology: Pseudocode
    query: ON successful_login for user U to app A from new_device SEARCH login_history
      for user U to app A in last 90 days | IF all_previous_logins == 'failure',
      ALERT
- question: Has a newly registered device been used to access a resource that is
    almost always inaccessible to that user?
  context: Some resources may be consistently denied to a user by policy. A successful
    access to such a resource is a powerful indicator of a policy change or bypass.
    This question identifies a "denied set" of resources for each user and alerts
    on any successful access to them from a new device, as this is a statistically
    significant event.
  answer_sources:
  - Zeek http.log
  - Azure AD Signin Logs
  - Azure AD Conditional Access Logs
  - Azure AD Identity Protection Logs
  - Cloud Identity Provider (IdP) conditional access policy logs
  - Web Application Firewalls (WAFs)
  - Application-level authentication logs
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each user U, maintain a denied_set of resources (where access_failure_rate
      > 99%) | ON successful_access by user U to resource R from new_device IF R
      in denied_set, ALERT
- question: Did a successful access from a new device occur when a machine learning
    model predicted it should have failed?
  context: This question uses a predictive model to determine the likely outcome
    of an access request based on features like device compliance, IP location, and
    time of day. When the model predicts a failure but the actual outcome is a success
    (especially from a new device), it's a strong signal that something has changed
    to bypass the expected controls. This is a high-confidence indicator of a policy
    bypass.
  answer_sources:
  - Zeek http.log
  - Azure AD Signin Logs
  - Azure AD Conditional Access Logs
  - Azure AD Identity Protection Logs
  - Cloud Identity Provider (IdP) conditional access policy logs
  - Web Application Firewalls (WAFs)
  - Application-level authentication logs
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR each successful_access_from_new_device EXTRACT features (device_compliance,
      ip_geo, time) | GET prediction from access_prediction_model | IF prediction
      == 'failure', ALERT
- question: Is a newly registered device connecting to an unusually large number
    of internal hosts on common administrative or reconnaissance ports?
  context: After establishing a foothold, adversaries often perform internal reconnaissance
    by scanning the network for open administrative ports (like RDP, SSH, WinRM,
    SMB) to find other systems to move to. This question detects this scanning behavior
    by counting the number of unique internal hosts a new device attempts to connect
    to on these key ports within a short time window.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Internal network segments (monitored by network taps for Zeek)
  - Endpoint devices (for Windows Event Logs)
  - Core switches (for NetFlow/IPFIX data)
  range: last 5 minutes
  queries:
  - technology: Pseudocode
    query: FOR new_device_ip COUNT distinct destination_ips on admin_ports (22, 445,
      3389, etc.) in last 5 mins | IF count > 10, ALERT
- question: Is the set of internal hosts being contacted by a new device unusually
    random, indicating scanning behavior?
  context: Normal workstation traffic is often directed to a small, predictable
    set of servers. Network scanning, in contrast, involves connecting to a wide
    and often random-seeming set of IP addresses. This question applies Shannon entropy
    to the set of destination IPs contacted by a new device. A high entropy value
    indicates a lack of pattern and is a strong statistical indicator of scanning.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Internal network segments (monitored by network taps for Zeek)
  - Endpoint devices (for Windows Event Logs)
  - Core switches (for NetFlow/IPFIX data)
  range: last 1 minute
  queries:
  - technology: Pseudocode
    query: FOR new_device_ip GET set_of_destination_ips in last 1 min | CALCULATE
      shannon_entropy(set_of_destination_ips) | IF entropy > (baseline_entropy +
      3 * std_dev), ALERT
- question: Does the overall network traffic profile of a newly registered device
    differ significantly from that of a typical workstation?
  context: This question moves beyond single metrics to create a holistic behavioral
    profile of a normal workstation, using multiple features from network traffic
    (protocols, connection counts, data volumes, etc.). An anomaly detection algorithm
    like Isolation Forest can then score how much a new device's behavior deviates
    from this multi-dimensional baseline. A high anomaly score indicates the device
    is not behaving like a normal workstation and could be performing malicious activities
    like scanning or data exfiltration.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Internal network segments (monitored by network taps for Zeek)
  - Endpoint devices (for Windows Event Logs)
  - Core switches (for NetFlow/IPFIX data)
  range: last 5 minutes
  queries:
  - technology: Pseudocode
    query: FOR new_device_ip EXTRACT traffic_features over 5 mins (protocol_dist,
      conn_count, byte_count, etc.) | GET anomaly_score from isolation_forest_model
      | IF anomaly_score > threshold, ALERT