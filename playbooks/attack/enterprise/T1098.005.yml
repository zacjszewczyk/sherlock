name: T1098.005: Device Registration
id: 5a6b1c3d-8e9f-4a0b-9c1d-2e3f4a5b6c7d
description: This playbook focuses on detecting adversaries who establish persistence or elevate privileges by registering new devices within an identity provider like Azure AD. The investigation looks for signs of malicious registration, such as events originating from suspicious IPs or using malicious tool signatures, devices with non-standard or high-entropy names, registrations that follow a series of failed logins, or anomalous volumes of registration activity. It also covers post-registration malicious activity, such as a new device communicating with C2 infrastructure, performing internal network scanning, or accessing high-value assets in an automated fashion to bypass security policies.
type: technique
related:
- TA0003: Persistence
- TA0004: Privilege Escalation
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is a device registration originating from a known malicious IP or using a recognized malicious tool's User-Agent string?
  context: This is a high-fidelity detection that directly ties a registration event to known adversary infrastructure or tooling. An alert from this query indicates that a compromised identity is likely being used to establish a persistent foothold via a new device registration, using methods seen in tools like AADInternals.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Azure AD Signin Logs
  - Internet Gateway (for Zeek logs)
  - Cloud Identity Provider (IdP) consoles (e.g., Azure AD, Okta, Duo)
  - VPN concentrators
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SEARCH device registration logs WHERE (source_ip IN threat_intel_feed) OR (user_agent MATCHES malicious_tool_signatures).
- question: Is a device registration originating from a statistically rare Autonomous System Number (ASN) or country compared to historical data?
  context: Adversaries often operate from infrastructure that is not typical for an organization's user base. By baselining normal registration locations (by ASN and country), this question helps identify registrations from anomalous sources that warrant further investigation as potential adversary activity.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Azure AD Signin Logs
  - Internet Gateway (for Zeek logs)
  - Cloud Identity Provider (IdP) consoles (e.g., Azure AD, Okta, Duo)
  - VPN concentrators
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: CALCULATE registration frequency by ASN/country over 90 days. TRIGGER alert if new registration's ASN/country pair is in bottom 5th percentile.
- question: Does a machine learning model classify a new device registration event as malicious based on its collective attributes?
  context: This question moves beyond single indicators to a holistic assessment. A machine learning model can learn complex, non-obvious patterns from historical data (e.g., IP reputation, time of day, User-Agent rarity) to identify suspicious registrations that might evade simpler, rule-based detections.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Azure AD Signin Logs
  - Internet Gateway (for Zeek logs)
  - Cloud Identity Provider (IdP) consoles (e.g., Azure AD, Okta, Duo)
  - VPN concentrators
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: PREDICT malice_score for new registration event using trained model. TRIGGER alert if score > confidence_threshold.
- question: Is a newly registered device name inconsistent with our organization's naming standards or does it match signatures of malicious tools?
  context: Deviations from established device naming conventions can indicate a user or process that is unaware of or intentionally ignoring corporate policy. This is common with adversary tools that use default or randomly generated names. This query checks for both non-compliance and known bad names.
  answer_sources:
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs (for Azure AD OperationName: Add device)
  - Network decryption points for SSL/TLS inspection (for Zeek http.log visibility)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SEARCH device registration logs WHERE device_name NOT MATCHES 'ORGANIZATIONAL-NAMING-REGEX' OR device_name MATCHES malicious_tool_signatures.
- question: Does a newly registered device name have unusually high character entropy compared to a historical baseline?
  context: Algorithmically generated names, often used by malware or attacker scripts for creating numerous unique devices, tend to have higher character randomness (entropy) than human-created names. Comparing the entropy of a new device name to the norm helps detect such automated or malicious activity.
  answer_sources:
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs (for Azure AD OperationName: Add device)
  - Network decryption points for SSL/TLS inspection (for Zeek http.log visibility)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: CALCULATE Shannon entropy for new device_name. TRIGGER alert if entropy > 95th percentile of 180-day baseline.
- question: Does a newly registered device name fall into an anomalous cluster when grouped with other device names based on its structural features?
  context: This question uses unsupervised machine learning to find new or unknown patterns of malicious naming. By clustering all device names based on features like length and character types, analysts can identify groups of outliers that don't fit any legitimate pattern and investigate new devices that match these anomalous clusters.
  answer_sources:
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs (for Azure AD OperationName: Add device)
  - Network decryption points for SSL/TLS inspection (for Zeek http.log visibility)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: CLUSTER all device names using features (length, entropy, etc.). REVIEW new device names falling into anomalous clusters.
- question: Was a successful device registration immediately preceded by a series of failed login attempts for the same user account?
  context: This sequence of events is a classic indicator of an account compromise. An adversary first gains access through brute-force or password spraying (the failed logins) and then immediately establishes persistence by registering their own device to the compromised account.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Azure AD Signin Logs
  - Azure AD Audit Logs
  - Azure AD Risky Users
  - Authentication servers (Active Directory Domain Controllers for Windows Events)
  - Cloud Identity Provider (IdP) sign-in and audit logs
  - VPN concentrators
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: COUNT failed logins for user in 15-min window. IF count > 5 AND successful device registration for same user occurs, TRIGGER alert.
- question: Does a new device registration for a user deviate significantly from their established historical profile of registration behavior?
  context: This User and Entity Behavior Analytics (UEBA) approach builds a profile of what is 'normal' for each user. A registration from a new country, a new ISP (ASN), or at an unusual time of day for that specific user is flagged as a potential account takeover, even if the activity would be normal for another user.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Azure AD Signin Logs
  - Azure AD Audit Logs
  - Azure AD Risky Users
  - Authentication servers (Active Directory Domain Controllers for Windows Events)
  - Cloud Identity Provider (IdP) sign-in and audit logs
  - VPN concentrators
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SCORE new registration based on deviations from user profile (country, ASN, time). TRIGGER alert if risk_score > 4.
- question: Is a new device registration event classified as an outlier by a machine learning model trained on that specific user's past registration behavior?
  context: This is a more advanced form of behavioral analysis. Instead of relying on a few hard-coded rules, a one-class SVM model learns a nuanced, multi-dimensional profile of a user's normal registration activity. It can then flag any new registration that doesn't fit this learned profile, detecting subtle anomalies that might otherwise be missed.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 4625
  - Windows Event ID 4624
  - Azure AD Signin Logs
  - Azure AD Audit Logs
  - Azure AD Risky Users
  - Authentication servers (Active Directory Domain Controllers for Windows Events)
  - Cloud Identity Provider (IdP) sign-in and audit logs
  - VPN concentrators
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: CLASSIFY new registration using user-specific one-class SVM. TRIGGER alert if classified as outlier.
- question: Has a single source IP registered an unusually high number of devices, or has a single user registered multiple devices in a short time frame?
  context: Legitimate users rarely register multiple devices in a short period. This simple thresholding rule is effective at detecting automated scripts or an adversary attempting to establish multiple points of persistence quickly, either from a single external machine or using a single compromised account.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs
  - Internet gateway
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: COUNT device registrations over 1 hour, grouped by IP and user. TRIGGER alert IF count_per_ip > 5 OR count_per_user > 2.
- question: Does the overall volume of device registrations in a given hour represent a statistically significant spike compared to the organization's recent history?
  context: This question looks for large-scale anomalies affecting the entire organization. A sudden spike in registrations far exceeding the normal hourly average (plus a buffer for normal variation) could indicate a widespread campaign, a misconfiguration, or a novel attack technique.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs
  - Internet gateway
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: CALCULATE 30-day rolling average and stddev of hourly registrations. TRIGGER alert if current_hour_count > (average + 3 * stddev).
- question: Does the current number of device registrations significantly exceed the amount forecasted by a time-series model that accounts for seasonality?
  context: This is a more sophisticated version of the previous volumetric question. A time-series model like Prophet can account for predictable patterns (e.g., fewer registrations on weekends, more at the start of the workday). An alert triggers only when the registration count exceeds the model's predicted upper bound, resulting in fewer false positives than a simple standard deviation approach.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Azure AD Audit Logs
  - Cloud Identity Provider (IdP) audit logs
  - Internet gateway
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FORECAST expected registration count using Prophet model. TRIGGER alert if actual_count > predicted_upper_bound.
- question: Is a newly registered device communicating with known command and control (C2) infrastructure?
  context: This is a critical question for identifying a compromised device. After persistence is established, the adversary's malware will often 'call home' to a C2 server for instructions. Detecting this communication from a device registered in the last 24 hours is a strong indicator of an active intrusion.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Internet gateway (for Zeek logs)
  - DNS resolvers
  - Endpoint devices (for Windows Event Logs)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: MONITOR network traffic from new devices (last 24h). TRIGGER alert if destination_ip or resolved_domain in C2_threat_feed.
- question: Is a newly registered device making DNS requests for an unusual distribution of top-level domains (TLDs) compared to the organizational norm?
  context: Adversary C2 domains often use cheap, obscure, or low-reputation TLDs (e.g., .xyz, .top) that are rarely used in normal business operations. A newly registered device making an abnormally high number of requests to these TLDs suggests it may be trying to contact malicious infrastructure.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Internet gateway (for Zeek logs)
  - DNS resolvers
  - Endpoint devices (for Windows Event Logs)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: ANALYZE TLD distribution for new devices. TRIGGER alert if distribution contains high percentage of low-reputation TLDs.
- question: Are DNS queries from a newly registered device being flagged as algorithmically generated (DGA) by a detection model?
  context: Domain Generation Algorithms (DGAs) are used by malware to create a large number of potential C2 domains, making them difficult to block. A machine learning model trained to recognize the patterns of DGAs can identify these queries, providing a strong signal that a newly registered device is infected and attempting C2 communication.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Internet gateway (for Zeek logs)
  - DNS resolvers
  - Endpoint devices (for Windows Event Logs)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: PROCESS DNS queries from new devices with DGA detection model. TRIGGER alert if DGA_score > 0.85.
- question: Is a newly registered device being used to rapidly access multiple high-value assets or 'crown jewels'?
  context: Once an adversary has a foothold, their next step is often to find and access valuable data. This query looks for automated 'smash and grab' activity, where a newly registered device quickly accesses several predefined sensitive servers or file shares in a short window, a pattern inconsistent with normal user exploration.
  answer_sources:
  - Zeek http.log
  - Zeek conn.log
  - Windows Event ID 4663
  - Windows Event ID 5145
  - Web servers hosting sensitive applications
  - File servers hosting sensitive data
  - Internal network segments monitored by network taps
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: TRACK access to 'crown jewel' list from new device IPs. TRIGGER alert if distinct_asset_access_count > 3 in 5 minutes.
- question: Is a user accessing resources from a new device at a speed inconsistent with their normal, human-driven behavior?
  context: Automated scripts operate at machine speed, far faster than a human user. By baselining the typical time delay between a user's resource accesses, this query can detect when their account, operating from a new device, is exhibiting behavior that is too fast to be human, strongly suggesting automation or scripting.
  answer_sources:
  - Zeek http.log
  - Zeek conn.log
  - Windows Event ID 4663
  - Windows Event ID 5145
  - Web servers hosting sensitive applications
  - File servers hosting sensitive data
  - Internal network segments monitored by network taps
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: COMPARE time delta between resource accesses from new device to user's historical baseline. TRIGGER alert if median_delta < 1st percentile.
- question: Is the sequence of applications being accessed by a user from a new device highly improbable compared to their established access patterns?
  context: Users typically have predictable workflows, accessing applications in a common order (e.g., email, then CRM, then finance portal). An adversary has different goals and will access resources in a sequence that deviates from the user's norm. This query models the user's normal access path and flags improbable sequences from a new device.
  answer_sources:
  - Zeek http.log
  - Zeek conn.log
  - Windows Event ID 4663
  - Windows Event ID 5145
  - Web servers hosting sensitive applications
  - File servers hosting sensitive data
  - Internal network segments monitored by network taps
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: MODEL user access patterns with Markov chain. CALCULATE probability of access sequence from new device. TRIGGER alert if probability is anomalously low.
- question: Is a newly registered device enabling a user to bypass a Conditional Access policy that previously blocked them from a resource?
  context: This is a direct test for privilege escalation. If a user was consistently blocked from an application due to a policy (e.g., requiring a compliant device), and then succeeds after registering a new device, it's a strong sign that the device registration was used specifically to circumvent that security control.
  answer_sources:
  - Zeek http.log
  - Azure AD Signin Logs
  - Azure AD Conditional Access Logs
  - Azure AD Identity Protection Logs
  - Cloud Identity Provider (IdP) conditional access policy logs
  - Web Application Firewalls (WAFs)
  - Application-level authentication logs
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FOR new device user, check past 90 days of sign-in logs. IF new device allows access to a resource that was always blocked before, TRIGGER alert.
- question: Has a newly registered device been used to successfully access a resource that is almost always inaccessible to that user?
  context: This is a statistical method to find policy bypasses without needing to know the exact policy logic. By identifying resources a user almost never successfully accesses, any new success from a newly registered device becomes a statistically significant anomaly, indicating a potential circumvention of controls.
  answer_sources:
  - Zeek http.log
  - Azure AD Signin Logs
  - Azure AD Conditional Access Logs
  - Azure AD Identity Protection Logs
  - Cloud Identity Provider (IdP) conditional access policy logs
  - Web Application Firewalls (WAFs)
  - Application-level authentication logs
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: IDENTIFY user's 'always-denied' resources. TRIGGER alert if new device successfully accesses any resource from that set.
- question: Did a machine learning model predict an access attempt from a new device would fail, but it succeeded anyway?
  context: This query leverages a machine learning model that has learned the complex rules of your access policies. When the model predicts a failure but the logs show a success, it indicates a 'policy contradiction'. This is a high-confidence alert that a control was bypassed, likely due to the attributes of the newly registered device.
  answer_sources:
  - Zeek http.log
  - Azure AD Signin Logs
  - Azure AD Conditional Access Logs
  - Azure AD Identity Protection Logs
  - Cloud Identity Provider (IdP) conditional access policy logs
  - Web Application Firewalls (WAFs)
  - Application-level authentication logs
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: PREDICT access outcome with ML model. IF prediction is 'fail' but actual outcome is 'success' for new device, TRIGGER alert.
- question: Is a newly registered device conducting network scanning on common administrative or reconnaissance ports across the internal network?
  context: After gaining a foothold, adversaries often perform internal reconnaissance to map the network and find valuable targets. A newly registered device connecting to many different hosts on ports like RDP (3389), SSH (22), or WinRM (5985) is a classic sign of this scanning activity.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Internal network segments (monitored by network taps for Zeek)
  - Endpoint devices (for Windows Event Logs)
  - Core switches (for NetFlow/IPFIX data)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: FROM new device IP, count distinct internal hosts contacted on admin ports in 5 mins. TRIGGER alert if count > 10.
- question: Does the set of destination IPs being contacted by a newly registered device show high entropy, indicative of network scanning?
  context: Normal workstation traffic is often directed to a small, predictable set of servers. Network scanning, by contrast, involves contacting many different, unrelated hosts. Calculating the entropy of the destination IPs provides a mathematical measure of this randomness, allowing for the detection of scanning behavior.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Internal network segments (monitored by network taps for Zeek)
  - Endpoint devices (for Windows Event Logs)
  - Core switches (for NetFlow/IPFIX data)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: CALCULATE entropy of destination IPs from new device per minute. TRIGGER alert if entropy > 3 stddev above baseline.
- question: Does the overall network behavior of a newly registered device, across multiple metrics, deviate significantly from the profile of a standard workstation?
  context: This query provides a holistic, multi-variate assessment of a device's network behavior. An anomaly detection model like Isolation Forest can simultaneously analyze metrics like protocol mix, connection counts, and data volumes to create a comprehensive profile of 'normal'. It can then flag a new device whose overall behavior is anomalous, even if no single metric is high enough to trigger a simpler rule.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Internal network segments (monitored by network taps for Zeek)
  - Endpoint devices (for Windows Event Logs)
  - Core switches (for NetFlow/IPFIX data)
  range: last 90 days
  queries:
  - search_technology: Pseudocode
    query: SCORE network behavior of new device using Isolation Forest model trained on normal workstations. TRIGGER alert for high anomaly scores.