name: T1557.003: DHCP Spoofing
id: f8a1b2c3-d4e5-4f6a-b7c8-d9e0f1a2b3c4
description: This playbook focuses on detecting DHCP Spoofing, a technique where an adversary
  introduces a rogue DHCP server on a network to issue malicious network configurations
  to clients. The goal is often to gain credential access or collect sensitive data
  by performing a Man-in-the-Middle (MitM) attack. Detections in this playbook identify
  the precursor activities, the attack itself, and the follow-on actions. This includes
  detecting DHCP starvation attacks (indicated by server scope exhaustion logs and
  anomalous discovery rates), identifying rogue servers (through allow lists, statistical
  baselining, and clustering), spotting the DHCP race condition (multiple offers
  for one request), and detecting malicious configurations (by checking assigned
  IPs against threat intelligence or for statistical rarity). The playbook also covers
  the detection of post-compromise activity, such as clients connecting to malicious
  destinations, leaking cleartext credentials, being routed through unauthorized gateways,
  and exhibiting anomalous DNS behavior after receiving a new lease.
type: technique
related:
- TA0006: Credential Access
- TA0009: Collection
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is a client being assigned a malicious IP address for its DNS server or
    default gateway via DHCP?
  context: Adversaries use DHCP spoofing to assign malicious infrastructure (like
    DNS servers or gateways) to clients, allowing them to intercept traffic for credential
    harvesting or to redirect users. This question checks if any IP address assigned
    to a client via a DHCP Offer or Acknowledgement message matches a known malicious
    IP from a threat intelligence feed.
  answer_sources:
  - Zeek dhcp.log
  - Threat Intelligence Feed
  - 'NAI: Network segments containing client endpoints, Core network switch SPAN/TAP
    ports, DNS resolvers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log WHERE msg_type IN ('Offer', 'Ack') | JOIN assigned_ip,
      dns_servers, routers WITH threat_intel_feed ON ip_address | RETURN client_mac,
      assigned_ip, threat_intel_match
- question: Has a statistically rare or unusual DNS server or gateway been assigned
    to a client via DHCP?
  context: Legitimate DHCP configurations are typically stable. An adversary introducing
    a rogue server will likely assign a new, previously unseen DNS or gateway IP.
    This question aims to detect such anomalies by building a historical baseline
    of assigned IPs per subnet and alerting on assignments that are statistically
    infrequent.
  answer_sources:
  - Zeek dhcp.log
  - 'NAI: Network segments containing client endpoints, Core network switch SPAN/TAP
    ports, DNS resolvers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log | GROUP BY subnet, dns_servers, routers | CALCULATE
      frequency_over_90_days | SEARCH current_dhcp_assignment | IF frequency < 1st_percentile,
      ALERT
- question: Does a DHCP transaction exhibit characteristics of a malicious spoofing
    attempt based on a machine learning model?
  context: A sophisticated DHCP spoofing attack might use subtle characteristics that
    are hard to catch with simple rules. This question involves using a trained machine
    learning model to score DHCP transactions based on multiple features (IP reputation,
    MAC address history, lease time, etc.) to identify complex or novel spoofing attempts.
  answer_sources:
  - Zeek dhcp.log
  - Threat Intelligence Feed
  - 'NAI: Network segments containing client endpoints, Core network switch SPAN/TAP
    ports, DNS resolvers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: STREAM Zeek dhcp.log | EXTRACT features (ip_rep, mac_freq, lease_time)
      | APPLY ML_model_dhcp_spoofing | IF score > confidence_threshold, ALERT
- question: Is a DHCP Offer or Acknowledgement originating from an unauthorized server?
  context: In a managed network, the set of legitimate DHCP servers is known. Any
    DHCP offer coming from a server not on an authorized list is a strong indicator
    of a rogue DHCP server attempting to control client network configurations. This
    question checks DHCP server IPs against a pre-defined allow list.
  answer_sources:
  - Zeek dhcp.log
  - Windows DHCP Server Audit Logs
  - syslog
  - 'NAI: DHCP Server Infrastructure, Core network switch SPAN/TAP ports, VLAN interfaces
    on routers and switches, Network Access Control (NAC) logs'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log WHERE msg_type IN ('Offer', 'Ack') | IF server_addr
      NOT IN authorized_dhcp_server_list, ALERT
- question: Is there an anomalous volume of DHCP offers from a known server, or are
    offers coming from a new, previously unseen server?
  context: This question looks for two types of anomalies: the sudden appearance of
    a new DHCP server, or a legitimate server sending a massively increased number
    of offers. Both can indicate a rogue server is active on the network. It relies
    on baselining normal server activity over time.
  answer_sources:
  - Zeek dhcp.log
  - Windows DHCP Server Audit Logs
  - syslog
  - 'NAI: DHCP Server Infrastructure, Core network switch SPAN/TAP ports, VLAN interfaces
    on routers and switches, Network Access Control (NAC) logs'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log WHERE msg_type = 'Offer' | BASELINE count BY server_addr
      over time | IF new server_addr appears OR count > 3_std_dev_from_baseline, ALERT
- question: Can active DHCP servers be clustered to identify a rogue server as an
    outlier?
  context: Legitimate DHCP servers often share similar characteristics. This question
    uses unsupervised machine learning to group servers by features like subnets
    served and lease times. A rogue server with different characteristics will fail
    to join a primary cluster and be flagged as a statistical outlier.
  answer_sources:
  - Zeek dhcp.log
  - Windows DHCP Server Audit Logs
  - syslog
  - 'NAI: DHCP Server Infrastructure, Core network switch SPAN/TAP ports, VLAN interfaces
    on routers and switches, Network Access Control (NAC) logs'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH dhcp_logs | EXTRACT features (server_ip, server_mac_oui, subnets_served)
      | APPLY DBSCAN clustering | IF server is noise_point, ALERT
- question: Is a client receiving DHCP offers from multiple servers for the same request?
  context: When a rogue DHCP server is on the network, it will "race" to respond
    to a client's request alongside the legitimate server. Seeing multiple offers
    for the same transaction ID in a very short time window is a classic sign of a
    DHCP spoofing race condition.
  answer_sources:
  - Zeek dhcp.log
  - 'NAI: Endpoint subnets, Core network switch SPAN/TAP ports'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log WHERE msg_type = 'Offer' | GROUP BY trans_id over 2_seconds
      | IF distinct_count(server_addr) > 1, ALERT
- question: Is the number of competing offers for a single DHCP request statistically
    anomalous for the network?
  context: This question establishes what is "normal" for the number of offers per
    DHCP request across the network (which is almost always 1) and alerts on any
    transaction that significantly exceeds this norm (e.g., falls in the 99.9th percentile),
    indicating a rare and suspicious race condition.
  answer_sources:
  - Zeek dhcp.log
  - 'NAI: Endpoint subnets, Core network switch SPAN/TAP ports'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log WHERE msg_type = 'Offer' | CALCULATE distribution
      of unique server_addr counts per trans_id | IF current_transaction_offer_count
      > 99.9th_percentile, ALERT
- question: Has there been a sudden spike in the overall rate of DHCP race conditions
    across the network?
  context: While a single race condition is suspicious, a sudden increase in the rate
    of these events across the network is a strong indicator that a new, aggressive
    rogue DHCP server has become active. This question uses time-series anomaly detection
    to alert on a systemic increase in DHCP conflicts.
  answer_sources:
  - Zeek dhcp.log
  - 'NAI: Endpoint subnets, Core network switch SPAN/TAP ports'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: CALCULATE rate of multi-offer_transactions per minute | APPLY time_series_anomaly_detection
      | IF rate is anomalous, ALERT
- question: Are authoritative DHCP servers logging errors related to IP address pool
    exhaustion?
  context: A DHCP starvation attack, where an adversary exhausts the legitimate server's
    IP address pool, often precedes a spoofing attack. This makes clients more likely
    to accept an offer from the rogue server. Specific server error logs (e.g., Windows
    Event ID 1020 or syslog 'no free leases') are direct evidence of this attack.
  answer_sources:
  - Windows Event ID 1020
  - Windows Event ID 1063
  - Zeek dhcp.log
  - syslog
  - 'NAI: Authoritative DHCP servers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH dhcp_server_logs | IF event_id IN (1020, 1063) OR message CONTAINS
      'no free leases', ALERT
- question: Is there an anomalous spike in DHCP Discover messages on a specific subnet?
  context: A DHCP starvation attack involves sending a huge volume of DHCP Discover
    messages from spoofed MAC addresses. Monitoring the rate of these messages and
    comparing it to a historical baseline can detect the beginning of a starvation
    attack before the IP pool is exhausted.
  answer_sources:
  - Zeek dhcp.log
  - syslog
  - 'NAI: Authoritative DHCP servers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log WHERE msg_type = 'Discover' | BASELINE count per hour
      by subnet | IF current_rate > 5_std_dev_from_baseline, ALERT
- question: Is the number of available IP addresses in a DHCP scope depleting faster
    than predicted?
  context: This provides a predictive approach to detecting DHCP starvation. It models
    the expected usage of IP addresses in a scope and alerts if the actual number
    of available IPs drops significantly faster than the forecast predicts, providing
    an early warning before the pool is completely exhausted.
  answer_sources:
  - Windows Event ID 1020
  - Windows Event ID 1063
  - Zeek dhcp.log
  - syslog
  - 'NAI: Authoritative DHCP servers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: INGEST dhcp_scope_stats | FORECAST expected_available_ips using ARIMA |
      IF actual_available_ips < forecasted_confidence_interval, ALERT
- question: Did a client connect to a known malicious IP or domain shortly after receiving
    a new DHCP lease?
  context: A primary goal of DHCP spoofing is to redirect victim traffic. This question
    looks for this follow-on activity by correlating a new DHCP lease with immediate
    connections or DNS lookups to destinations on a threat intelligence feed, indicating
    a successful compromise.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek dhcp.log
  - Threat Intelligence Feed
  - 'NAI: Network Egress Points, DNS Resolvers, Endpoint subnets'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH Zeek dhcp.log WHERE msg_type = 'Ack' | CORRELATE client_ip with
      conn.log, dns.log within 15 minutes | JOIN dest_ip, domain WITH threat_intel_feed
      | IF match, ALERT
- question: Did a client's DNS query behavior change significantly after receiving
    a new DHCP lease?
  context: A compromised client using a malicious DNS server may exhibit drastically
    different DNS behavior. This question establishes a baseline of a client's normal
    DNS query patterns and alerts if there is a major shift in those patterns immediately
    following a new DHCP lease.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek dhcp.log
  - Threat Intelligence Feed
  - 'NAI: Network Egress Points, DNS Resolvers, Endpoint subnets'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: ON dhcp_ack_event for client_ip: | COMPARE dns_queries_1hr_before with
      dns_queries_1hr_after | CALCULATE Jaccard_similarity | IF similarity < 0.2 AND
      new_domain_count is high, ALERT
- question: Is a client exhibiting network traffic patterns consistent with C2 communication
    shortly after a DHCP event?
  context: This question focuses on detecting command-and-control (C2) activity by
    applying a specialized C2 detection model to a client's traffic. Prioritizing
    alerts for clients that just received a new DHCP lease increases the likelihood
    of finding a successful compromise.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Zeek dhcp.log
  - Threat Intelligence Feed
  - 'NAI: Network Egress Points, DNS Resolvers, Endpoint subnets'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: STREAM outbound_traffic | APPLY ML_model_c2_detection | IF alert_triggered
      AND client recently received DHCP_lease, INCREASE alert_priority
- question: Are cleartext credentials (e.g., HTTP Basic Auth, FTP, NTLM) being sent
    to unauthorized or suspicious servers?
  context: After redirecting traffic, an adversary can capture credentials sent over
    unencrypted protocols. This question creates specific rules to look for common
    forms of cleartext authentication being sent to servers that are not on an approved
    list of internal resources, a strong sign of credential harvesting.
  answer_sources:
  - Zeek http.log
  - Zeek smb_cmd.log
  - Zeek ntlm.log
  - Zeek ftp.log
  - Zeek conn.log
  - 'NAI: Core network switches, Application server segments, Authentication servers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH http.log WHERE auth_header = 'Basic' AND dest_ip NOT IN allow_list
      | OR SEARCH ftp.log WHERE command = 'PASS' AND dest_ip NOT IN allow_list | ALERT
- question: Has there been a statistical increase in the use of unencrypted authentication
    protocols?
  context: A successful MitM attack might involve downgrading authentication protocols
    to weaker, unencrypted forms. This question baselines the normal ratio of secure
    vs. insecure authentication on the network. A sudden, anomalous shift towards
    insecure protocols could indicate an active attack.
  answer_sources:
  - Zeek http.log
  - Zeek smb_cmd.log
  - Zeek ntlm.log
  - Zeek ftp.log
  - Zeek conn.log
  - 'NAI: Core network switches, Application server segments, Authentication servers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: BASELINE daily volume of NTLM, HTTP_Basic_Auth | IF current_volume > 3_std_dev_from_baseline,
      ALERT
- question: Does network traffic analysis reveal a new cluster of activity involving
    cleartext authentication to an unusual destination?
  context: This question uses machine learning to find novel patterns of credential
    exposure. By clustering all network sessions, a new, small cluster representing
    sessions with "cleartext authentication to a new server" will stand out as a
    high-risk anomaly, potentially identifying a previously unknown credential harvesting
    point.
  answer_sources:
  - Zeek http.log
  - Zeek smb_cmd.log
  - Zeek ntlm.log
  - Zeek ftp.log
  - Zeek conn.log
  - 'NAI: Core network switches, Application server segments, Authentication servers'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH conn.log | ENRICH with protocol_auth_details | APPLY k-means clustering
      | IF new_cluster_properties = (cleartext_auth AND unusual_destination), ALERT
- question: Is a client's internet traffic being routed through an unauthorized gateway?
  context: A successful DHCP spoofing attack can assign a malicious default gateway
    to a client, forcing all of its off-subnet traffic through an attacker-controlled
    device. This question checks NetFlow data to see if the 'next hop' IP for a client's
    traffic matches the designated gateway for its subnet.
  answer_sources:
  - NetFlow/IPFIX data
  - Router/Firewall logs
  - 'NAI: Core network switches, Network Egress Points, Router flow data sources'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH NetFlow | FOR each flow, IF src_ip_subnet_gateway != next_hop_ip,
      ALERT
- question: Is a new, previously unseen 'next hop' or gateway IP being used by clients
    on a subnet?
  context: This discovery-based approach learns the normal gateways used by each
    subnet over time. It then alerts when a new 'next hop' IP appears in the flow
    data, which could indicate the introduction of a rogue gateway that is not on
    any pre-compiled list.
  answer_sources:
  - NetFlow/IPFIX data
  - Router/Firewall logs
  - 'NAI: Core network switches, Network Egress Points, Router flow data sources'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: BASELINE set of next_hop_ips per subnet | SEARCH NetFlow | IF next_hop_ip
      is NEW for src_subnet, ALERT
- question: Does a graph-based analysis of network flows reveal a new, anomalous
    traffic choke point?
  context: Visualizing network traffic as a graph can reveal high-level structural
    patterns. A rogue gateway will manifest as a new, unexpected hub that diverts
    traffic from a community of clients. This question uses graph analysis algorithms
    to detect such significant structural changes in traffic patterns.
  answer_sources:
  - NetFlow/IPFIX data
  - Router/Firewall logs
  - 'NAI: Core network switches, Network Egress Points, Router flow data sources'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: CREATE graph from NetFlow data | APPLY community_detection | DETECT changes
      in community routing structure | IF new choke_point_node appears, ALERT
- question: Is a client experiencing a high rate of DNS errors (NXDOMAIN) shortly
    after getting a new DHCP lease?
  context: A malicious DNS server, assigned via DHCP spoofing, may fail to resolve
    many legitimate domains, resulting in a high number of NXDOMAIN responses. This
    question looks for a sudden spike in the NXDOMAIN rate for a client immediately
    after it receives a new IP configuration.
  answer_sources:
  - Zeek dns.log
  - Zeek dhcp.log
  - 'NAI: DNS Resolvers, Endpoint subnets, Network Egress Points'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: ON dhcp_ack_event for client_ip: | MONITOR dns.log for 10 minutes | CALCULATE
      nxdomain_ratio | IF ratio > 0.60, ALERT
- question: Does a host's overall DNS activity profile become anomalous after receiving
    a new DHCP lease?
  context: This question builds a comprehensive baseline of a host's normal DNS behavior
    (query volume, entropy, record types). It then alerts if the host's behavior
    deviates significantly from its own historical norm after a DHCP event, indicating
    a potential compromise of its DNS resolution.
  answer_sources:
  - Zeek dns.log
  - Zeek dhcp.log
  - 'NAI: DNS Resolvers, Endpoint subnets, Network Egress Points'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: BASELINE per-host DNS metrics (volume, entropy, nx_rate) | ON dhcp_ack_event:
      | RECALCULATE metrics | IF any_metric > 3_std_dev_from_baseline, ALERT
- question: Does a client's DNS traffic profile, following a new DHCP lease, fail
    to match the patterns of benign activity learned by an autoencoder?
  context: This advanced approach uses an autoencoder trained to recognize only normal
    DNS traffic. When fed an anomalous pattern (e.g., from a client using a malicious
    DNS server), it will have a high "reconstruction error," flagging the traffic
    as something that does not conform to any learned pattern of normal behavior.
  answer_sources:
  - Zeek dns.log
  - Zeek dhcp.log
  - 'NAI: DNS Resolvers, Endpoint subnets, Network Egress Points'
  range: last 90 days
  queries:
  - technology: pseudocode
    query: STREAM per-host DNS feature_vectors | ON dhcp_ack_event: | FEED vector
      to trained_autoencoder | IF reconstruction_error > threshold, ALERT