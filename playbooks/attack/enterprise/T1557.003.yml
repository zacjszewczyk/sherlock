name: "T1557.003: DHCP Spoofing"
id: a1b1c5a9-6b5e-4f0e-8c3d-987654321fed
description: "This playbook helps investigate whether an adversary is attempting to gain credential access or collect data by conducting a DHCP spoofing attack. This involves an attacker's rogue DHCP server providing false configuration information (like a malicious DNS server or gateway) to legitimate clients. Investigative context includes detecting DHCP offers with malicious IPs, offers from unauthorized servers, DHCP race conditions, DHCP pool exhaustion attacks, subsequent client traffic to malicious destinations, cleartext credential harvesting, rerouted traffic through unauthorized gateways, and anomalous DNS query patterns following a new DHCP lease."
type: technique
related:
  - "TA0006: Credential Access"
  - "TA0009: Collection"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are DHCP servers assigning configuration parameters (e.g., DNS server, default gateway) that point to known malicious IP addresses?"
    context: "This action checks if DHCP responses (Offers/Acks) are giving clients malicious IPs for critical services like DNS or routing. This is a direct method for an attacker to perform a man-in-the-middle attack. By joining DHCP logs with a threat intelligence feed, we can proactively detect when clients are being configured to trust malicious infrastructure."
    answer_sources:
      - "Zeek dhcp.log"
      - "Threat Intelligence Feed"
      - "Network segments containing client endpoints, Core network switch SPAN/TAP ports, DNS resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dhcp.log WHERE msg_type IN ('Offer', 'Ack') | JOIN threat_intel_feed ON (dhcp.assigned_ip = threat_intel.ip OR dhcp.dns_servers = threat_intel.ip OR dhcp.routers = threat_intel.ip) | RETURN suspicious_dhcp_events"
  - question: "Are any subnets receiving DHCP assignments for DNS servers or gateways that are statistically rare or have never been seen before?"
    context: "This question aims to detect rogue DHCP servers by identifying anomalous assignments. Legitimate DHCP servers typically assign from a consistent pool of DNS servers and gateways. A new or rarely seen IP address being assigned could indicate a malicious server has been introduced to the network. By baselining normal behavior, we can spot these statistical outliers."
    answer_sources:
      - "Zeek dhcp.log"
      - "Network segments containing client endpoints, Core network switch SPAN/TAP ports, DNS resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dhcp.log | GROUP BY subnet | CALCULATE frequency_distribution(dns_servers, routers) OVER 90 days | SEARCH dhcp.log for new events | COMPARE new_assignment_ip with historical_distribution | ALERT if frequency < 1st_percentile"
  - question: "Can we use machine learning to classify DHCP transactions as malicious based on multiple features?"
    context: "This is a more advanced detection method. Instead of relying on a single indicator, it combines several features (IP reputation, server MAC frequency, lease time, race condition indicators) into a machine learning model. This model can learn complex patterns associated with malicious DHCP activity and provide a confidence score, reducing false positives and detecting more subtle attacks."
    answer_sources:
      - "Zeek dhcp.log"
      - "Threat Intelligence Feed"
      - "Network segments containing client endpoints, Core network switch SPAN/TAP ports, DNS resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT dhcp_transaction_features (ip_rep, mac_freq, lease_time, is_race_condition) | PREDICT with trained_random_forest_model | IF prediction == 'malicious' AND confidence > threshold | ALERT"
  - question: "Are DHCP Offer or ACK messages originating from IP addresses that are not on the authorized list of DHCP servers for a given network segment?"
    context: "This is a fundamental check for rogue DHCP servers. In a well-managed network, the IP addresses of legitimate DHCP servers are known. This question involves creating an allow list of these servers and alerting on any DHCP server activity that doesn't come from a pre-approved source, providing a clear and high-fidelity signal of a potential rogue server."
    answer_sources:
      - "Zeek dhcp.log"
      - "Windows DHCP Server Audit Logs"
      - "syslog"
      - "DHCP Server Infrastructure, Core network switch SPAN/TAP ports, VLAN interfaces on routers and switches, Network Access Control (NAC) logs"
    range: "last 90 days"
    queries:
      - "pseudocode: DEFINE authorized_dhcp_servers_per_subnet | SEARCH dhcp.log WHERE msg_type IN ('Offer', 'Ack') | IF server_addr NOT IN authorized_dhcp_servers_per_subnet[client_subnet] | ALERT"
  - question: "Is there an anomalous volume of DHCP 'Offer' messages from a specific server, or are offers coming from a previously unseen server IP?"
    context: "This question uses anomaly detection on the volume of DHCP offers. A sudden spike in offers from a known server or any offers from a new server can indicate malicious activity. For example, an attacker might be attempting a DHCP starvation attack or trying to race against the legitimate server. Baselining normal offer counts per server helps identify these deviations."
    answer_sources:
      - "Zeek dhcp.log"
      - "Windows DHCP Server Audit Logs"
      - "syslog"
      - "DHCP Server Infrastructure, Core network switch SPAN/TAP ports, VLAN interfaces on routers and switches, Network Access Control (NAC) logs"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dhcp.log WHERE msg_type == 'Offer' | BASELINE hourly/daily count per server_addr | IF current_count > (baseline_mean + 3 * baseline_stddev) OR server_addr is new | ALERT"
  - question: "Can we identify rogue DHCP servers by clustering them based on their operational characteristics?"
    context: "This question proposes an unsupervised machine learning approach. Legitimate DHCP servers often share similar characteristics (subnets served, lease times, vendor OUI). A rogue server, set up by an attacker, will likely have different characteristics and will therefore not fit into the existing clusters of legitimate servers. It would be identified as a noise point or a small, separate cluster, making it stand out."
    answer_sources:
      - "Zeek dhcp.log"
      - "Windows DHCP Server Audit Logs"
      - "syslog"
      - "DHCP Server Infrastructure, Core network switch SPAN/TAP ports, VLAN interfaces on routers and switches, Network Access Control (NAC) logs"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT dhcp_server_features (ip, mac_oui, subnets_served, typical_lease_time) | APPLY DBSCAN clustering | IF server is identified as 'noise' or forms a new singleton cluster | ALERT"
  - question: "Is a single client DHCP request receiving offers from multiple different servers simultaneously?"
    context: "This directly targets the 'race condition' aspect of DHCP spoofing, where a rogue server tries to respond to a client's request faster than the legitimate server. A client should typically only receive one offer per request. Receiving multiple offers for the same transaction ID within a very short time window is a strong indicator of a rogue DHCP server on the network."
    answer_sources:
      - "Zeek dhcp.log"
      - "Endpoint subnets, Core network switch SPAN/TAP ports"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dhcp.log WHERE msg_type == 'Offer' | GROUP BY trans_id over 2s window | CALCULATE distinct_count(server_addr) | IF distinct_count > 1 | ALERT"
  - question: "Are we observing a statistically unusual number of unique server offers for a single DHCP transaction ID?"
    context: "This is a statistical variation of the previous question. Instead of a fixed threshold of '>1', it establishes a baseline for how many offers a transaction normally receives (which should be 1). By alerting on transactions that fall into the extreme upper percentile (e.g., 99.9th), this method can dynamically adapt to network noise while still effectively catching race conditions."
    answer_sources:
      - "Zeek dhcp.log"
      - "Endpoint subnets, Core network switch SPAN/TAP ports"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dhcp.log | CALCULATE distribution of unique_server_offers_per_transaction | ALERT on transactions where count > 99.9th_percentile"
  - question: "Is there a sudden, anomalous spike in the overall rate of 'multi-offer transactions' across the network?"
    context: "This question looks at the macro-level picture. Instead of focusing on a single transaction, it monitors the network-wide rate of race conditions. A sudden increase in the frequency of these events suggests a new, widespread attack campaign may have started, possibly by a new rogue server that is actively competing with legitimate ones across multiple subnets."
    answer_sources:
      - "Zeek dhcp.log"
      - "Endpoint subnets, Core network switch SPAN/TAP ports"
    range: "last 90 days"
    queries:
      - "pseudocode: CALCULATE rate of transactions with >1 offer per minute | APPLY time-series anomaly detection (e.g., ESD) | IF rate is flagged as anomalous spike | ALERT"
  - question: "Are authoritative DHCP servers logging errors related to IP address pool exhaustion?"
    context: "This question looks for evidence of a DHCP starvation attack, a common precursor or accompaniment to DHCP spoofing. The attacker floods the network with DHCP requests to exhaust the legitimate server's IP address pool. This causes a denial of service for legitimate clients and makes it easier for the attacker's rogue server to answer new requests. Specific event IDs or log messages indicate this exhaustion."
    answer_sources:
      - "Windows Event ID 1020"
      - "Windows Event ID 1063"
      - "Zeek dhcp.log"
      - "syslog"
      - "Authoritative DHCP servers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH logs for (Windows EventID IN (1020, 1063)) OR (syslog message CONTAINS 'no free leases') | TRIGGER high-severity alert"
  - question: "Is there a statistically anomalous increase in the rate of DHCP 'Discover' messages on any subnet?"
    context: "This is another way to detect a potential DHCP starvation attack. A flood of DHCP 'Discover' messages from spoofed MAC addresses is the mechanism of the attack. By baselining the normal rate of these messages, a sudden and significant spike (e.g., >5 standard deviations) can be detected, signaling an active attack."
    answer_sources:
      - "Windows Event ID 1020"
      - "Windows Event ID 1063"
      - "Zeek dhcp.log"
      - "syslog"
      - "Authoritative DHCP servers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dhcp.log WHERE msg_type == 'Discover' | BASELINE hourly rate per subnet over 30 days | IF current_rate > (baseline_mean + 5 * baseline_stddev) | ALERT"
  - question: "Is the number of available IP addresses in our DHCP scopes depleting faster than predicted by historical trends?"
    context: "This is a proactive, predictive approach to detecting DHCP starvation. By using a forecasting model (like ARIMA or Prophet) on DHCP scope statistics, we can predict the expected number of available IPs. If the actual number drops significantly below the forecast, it suggests an abnormal rate of consumption, likely due to a starvation attack, allowing for an earlier warning than waiting for the pool to be fully exhausted."
    answer_sources:
      - "Windows Event ID 1020"
      - "Windows Event ID 1063"
      - "Zeek dhcp.log"
      - "syslog"
      - "Authoritative DHCP servers"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT historical_scope_statistics | FORECAST expected_available_ips with confidence_interval | GET current_available_ips | IF current_available_ips < lower_bound_of_confidence_interval | ALERT"
  - question: "Are clients connecting to known malicious IPs or resolving malicious domains shortly after receiving a new DHCP lease?"
    context: "This question seeks to confirm the impact of a successful DHCP spoofing attack. If an attacker successfully assigns a malicious DNS server or gateway, the next step is to direct the victim's traffic. This action correlates a new DHCP lease event with subsequent network connections and DNS queries from the same client. If that traffic goes to a destination on a threat intelligence feed, it's a strong indicator of a successful compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek dhcp.log"
      - "Threat Intelligence Feed"
      - "Network Egress Points, DNS Resolvers, Endpoint subnets"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dhcp.log for 'Ack' events | For each client_ip, WITHIN 15m of 'Ack' | SEARCH conn.log or dns.log | IF destination_ip or resolved_domain IN threat_intel_feed | ALERT"
  - question: "Does a client's DNS query behavior change significantly after receiving a new DHCP lease?"
    context: "A compromised client, now using a malicious DNS server, may exhibit very different DNS patterns. This question looks for that behavioral change. By comparing the set of domains a client resolves before and after a new lease, a drastic shift (measured by low Jaccard similarity) combined with a high number of new domains can indicate the client is now being directed by a malicious actor."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek dhcp.log"
      - "Threat Intelligence Feed"
      - "Network Egress Points, DNS Resolvers, Endpoint subnets"
    range: "last 90 days"
    queries:
      - "pseudocode: ON new DHCP 'Ack' for client_ip | GET dns_queries_1hr_before, GET dns_queries_1hr_after | CALCULATE jaccard_similarity(before, after) | CALCULATE new_domain_count | IF similarity < 0.2 AND new_domain_count > 90th_percentile | ALERT"
  - question: "Is a client exhibiting Command and Control (C2) traffic patterns after recently receiving a new DHCP lease?"
    context: "This question focuses on identifying the ultimate goal of many attacks: establishing C2 communication. By applying a specialized C2 detection model to outbound traffic, we can look for patterns like beaconing, unusual data volumes, or specific TLS fingerprints. Prioritizing alerts for clients that have just received a new DHCP lease helps connect the potential DHCP spoofing event to its malicious consequence."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek dhcp.log"
      - "Threat Intelligence Feed"
      - "Network Egress Points, DNS Resolvers, Endpoint subnets"
    range: "last 90 days"
    queries:
      - "pseudocode: APPLY C2_detection_model to all outbound traffic | IF C2 traffic detected AND client recently received DHCP lease | INCREASE alert priority"
  - question: "Are cleartext credentials (e.g., HTTP Basic Auth, FTP passwords, NTLM) being sent over the network to unauthorized or suspicious servers?"
    context: "A primary goal of a man-in-the-middle attack (enabled by DHCP spoofing) is to intercept credentials. This question looks for the direct evidence of this interception. By monitoring for unencrypted authentication protocols and comparing the destination server against an allow list of legitimate servers, we can detect when credentials are being sent to a potentially malicious endpoint."
    answer_sources:
      - "Zeek http.log"
      - "Zeek smb_cmd.log"
      - "Zeek ntlm.log"
      - "Zeek ftp.log"
      - "Zeek conn.log"
      - "Core network switches, Application server segments, Authentication servers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH for cleartext auth (HTTP 'Authorization: Basic', FTP 'PASS', NTLM) | IF destination_ip NOT IN approved_server_list | ALERT"
  - question: "Is there a statistically significant increase in the volume of unencrypted authentication attempts, especially to new destinations?"
    context: "An attacker who has successfully performed a MitM attack may try to downgrade connections to harvest credentials, leading to a spike in less secure authentication protocols like NTLMv1 or cleartext HTTP/FTP. This question aims to detect this shift by baselining the normal volume of different authentication types and alerting on significant increases in risky protocols."
    answer_sources:
      - "Zeek http.log"
      - "Zeek smb_cmd.log"
      - "Zeek ntlm.log"
      - "Zeek ftp.log"
      - "Zeek conn.log"
      - "Core network switches, Application server segments, Authentication servers"
    range: "last 90 days"
    queries:
      - "pseudocode: BASELINE daily volume of NTLM, cleartext_HTTP_auth, etc. per destination | IF current_volume > (baseline_mean + 3 * baseline_stddev) for unencrypted protocols | ALERT"
  - question: "Can we use machine learning to identify anomalous clusters of network sessions that involve cleartext authentication to unusual destinations?"
    context: "This question uses clustering to find the 'needle in the haystack.' Normal network traffic forms large, predictable clusters. A small number of sessions where an attacker is harvesting credentials will have a unique combination of features (e.g., protocol, destination, presence of authentication data) and will likely form a new, small cluster or be flagged as an anomaly. This can detect attacks that might be missed by simple thresholding."
    answer_sources:
      - "Zeek http.log"
      - "Zeek smb_cmd.log"
      - "Zeek ntlm.log"
      - "Zeek ftp.log"
      - "Zeek conn.log"
      - "Core network switches, Application server segments, Authentication servers"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT session_features (protocol, destination_ip, has_auth_header) | APPLY k-means clustering | ANALYZE new or small clusters | IF cluster represents cleartext auth to unusual destination | ALERT"
  - question: "Is any client's outbound internet traffic being routed through a 'next hop' IP that is not the authorized default gateway for its subnet?"
    context: "This question directly checks if a rogue gateway, assigned via DHCP spoofing, is being used. By analyzing NetFlow or IPFIX data, we can see the actual routing path ('next_hop') for traffic. If this 'next_hop' does not match the officially designated gateway for that client's subnet, it's a clear indication that traffic is being illegitimately rerouted."
    answer_sources:
      - "NetFlow/IPFIX data"
      - "Router/Firewall logs"
      - "Core network switches, Network Egress Points, Router flow data sources"
    range: "last 90 days"
    queries:
      - "pseudocode: DEFINE authorized_gateway_per_subnet | SEARCH NetFlow/IPFIX data | IF flow_record.next_hop != authorized_gateway_per_subnet[flow_record.source_subnet] | ALERT"
  - question: "Is a new, previously un-baselined 'next hop' IP being used for external traffic by clients in a subnet?"
    context: "Similar to baselining DHCP servers, this question involves baselining the legitimate 'next hop' routers used by each subnet. The appearance of a new 'next hop' IP in flow data is a strong anomaly. If more than a few clients suddenly start using this new router, it strongly suggests a successful DHCP spoofing attack has redirected a portion of the subnet's traffic."
    answer_sources:
      - "NetFlow/IPFIX data"
      - "Router/Firewall logs"
      - "Core network switches, Network Egress Points, Router flow data sources"
    range: "last 90 days"
    queries:
      - "pseudocode: BASELINE set of next_hop IPs per subnet | SEARCH NetFlow/IPFIX data | IF new_next_hop IP appears AND is used by >1% of clients in subnet | ALERT"
  - question: "Can we detect the introduction of a rogue gateway by analyzing structural changes in the network traffic graph?"
    context: "This advanced technique models the entire network's traffic flow as a graph. Normal traffic patterns form stable communities. A rogue gateway introduced via DHCP spoofing would create a new 'choke point' node, fundamentally altering the graph's structure as it reroutes traffic from a community. Detecting these significant structural changes using graph algorithms can reveal the presence and impact of a rogue gateway."
    answer_sources:
      - "NetFlow/IPFIX data"
      - "Router/Firewall logs"
      - "Core network switches, Network Egress Points, Router flow data sources"
    range: "last 90 days"
    queries:
      - "pseudocode: CONSTRUCT traffic graph from NetFlow (nodes=IPs, edges=flows) | APPLY community detection algorithm (e.g., Louvain) | MONITOR for significant changes in graph structure or community assignments | ALERT on changes indicating a new choke point"
  - question: "Are clients experiencing an unusually high rate of NXDOMAIN (non-existent domain) DNS responses shortly after receiving a new DHCP lease?"
    context: "A malicious DNS server, assigned via DHCP spoofing, might be configured to deny resolution for many domains, or it might be poorly configured. This can result in a high rate of NXDOMAIN errors for the victim client. Correlating a new DHCP lease with a subsequent, immediate spike in NXDOMAIN responses for that client can be an indicator of a malicious or malfunctioning DNS configuration."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek dhcp.log"
      - "DNS Resolvers, Endpoint subnets, Network Egress Points"
    range: "last 90 days"
    queries:
      - "pseudocode: ON new DHCP 'Ack' for client_ip | WITHIN 10m, SEARCH dns.log | CALCULATE ratio of NXDOMAIN_responses / total_queries | IF ratio > 60% | ALERT"
  - question: "Does a host's DNS activity profile (e.g., query volume, entropy, NXDOMAIN rate) deviate significantly from its established baseline after acquiring a new DHCP lease?"
    context: "This question expands on the previous one by creating a more comprehensive behavioral profile for each host's DNS activity. Instead of just one metric (NXDOMAIN rate), it tracks multiple metrics. A significant deviation in any of these metrics (e.g., query entropy suddenly drops, or the query type distribution changes) after a DHCP event is a strong signal that the client's DNS resolution has been compromised."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek dhcp.log"
      - "DNS Resolvers, Endpoint subnets, Network Egress Points"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each host, BASELINE DNS metrics (volume, entropy, NXDOMAIN_rate, etc.) over 30 days | ON new DHCP 'Ack' for host | RECALCULATE metrics | IF any metric > (baseline_mean + 3 * baseline_stddev) | ALERT"
  - question: "Can a machine learning model (autoencoder) detect anomalous DNS activity patterns following a new DHCP lease?"
    context: "This is a sophisticated anomaly detection method. An autoencoder is trained to 'reconstruct' normal DNS traffic patterns. When it's fed a pattern that is anomalous (like the kind generated by a malicious DNS server), it will have a high 'reconstruction error.' By monitoring this error for traffic immediately following a new DHCP lease, we can detect subtle DNS anomalies that might be missed by simple statistical methods."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek dhcp.log"
      - "DNS Resolvers, Endpoint subnets, Network Egress Points"
    range: "last 90 days"
    queries:
      - "pseudocode: TRAIN autoencoder on benign DNS feature vectors | ON new DHCP 'Ack' for host | CREATE DNS feature vector for subsequent traffic | FEED vector to autoencoder | IF reconstruction_error > learned_threshold | ALERT"