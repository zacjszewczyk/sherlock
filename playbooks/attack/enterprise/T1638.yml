name: T1638: Adversary-in-the-Middle
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: |
  This playbook helps detect Adversary-in-the-Middle (AitM) attacks targeting corporate mobile devices. It focuses on identifying attempts to intercept or manipulate traffic by looking for several key indicators: TLS sessions with certificate validation errors, suggesting TLS interception; connections to unsanctioned VPNs, which could indicate a rogue tunnel; traffic to newly registered or high-entropy domains followed by large data uploads, a potential C2 channel; anomalous network behavior following the installation of sideloaded applications (APKs); and mobile devices connecting to spoofed Wi-Fi access points (rogue APs).
type: technique
related:
  - TA0035: Collection
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are mobile devices establishing TLS sessions with invalid or non-trusted certificates?
    context: |
      This question aims to detect potential TLS interception (AitM) attacks. An adversary might use a self-signed or otherwise untrusted certificate to decrypt and inspect traffic. By monitoring for TLS validation statuses other than 'ok' in Zeek logs (e.g., 'self signed certificate in certificate chain'), analysts can identify connections that are being intercepted. Enriching alerts with certificate issuer and subject details and comparing them against trusted Certificate Authority (CA) lists and Certificate Transparency (CT) logs helps confirm if the interception is malicious or a misconfiguration.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Corporate Wi-Fi network segments
      - network egress points
      - DNS resolvers
      - network sensor collectors (e.g., Zeek cluster)
      - Certificate Authority infrastructure
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          JOIN Zeek_ssl_log AND Zeek_x509_log ON uid WHERE source_ip IN mobile_device_range AND validation_status != 'ok'. ALERT with certificate_issuer, certificate_subject.
  - question: Is there a statistical anomaly in the rate of TLS connection errors for specific mobile devices or the entire mobile network?
    context: |
      This question focuses on identifying subtle or widespread AitM activity through statistical baselining. A sudden increase in the ratio of TLS errors for a specific device-server pair, or a network-wide spike in certificate validation errors, can indicate an attack that isn't caught by simple signature-based rules. Alerting on deviations from historical norms (e.g., exceeding the 99th percentile or 3 standard deviations from a baseline) helps detect targeted and large-scale interception campaigns.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Corporate Wi-Fi network segments
      - network egress points
      - DNS resolvers
      - network sensor collectors (e.g., Zeek cluster)
      - Certificate Authority infrastructure
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          For each (device_ip, sni), CALCULATE ratio = (count(tls_errors) / count(total_tls)) over 30 days. ALERT if current_ratio > 99th_percentile(historical_ratios).
  - question: Can a machine learning model detect anomalous patterns in certificate validation errors that suggest a sophisticated AiTM attack?
    context: |
      This question leverages advanced machine learning to detect complex AiTM attacks. A time-series anomaly detection model can learn the normal patterns of certificate errors, considering various features like SNI, issuer, and geo-data. An alert is triggered when the model observes a significant, unexplained deviation from its forecast, which could signify a coordinated or novel interception technique that evades simpler statistical methods.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Corporate Wi-Fi network segments
      - network egress points
      - DNS resolvers
      - network sensor collectors (e.g., Zeek cluster)
      - Certificate Authority infrastructure
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          PREDICT error_count using time-series_model(features: sni, validation_status, issuer, geo_data). ALERT if actual_count exceeds model's confidence_interval.
  - question: Are mobile devices connecting to non-sanctioned VPN services?
    context: |
      This question seeks to identify unauthorized VPN usage, which could be a method for an adversary to create a malicious tunnel for data exfiltration or command and control. By maintaining a list of approved corporate VPN gateways and alerting on any connections from mobile devices to other IPs on common VPN ports (e.g., UDP 500/4500, TCP 1194), analysts can quickly spot potential rogue connections. Cross-referencing with MDM logs for recent VPN profile installations adds crucial context.
    answer_sources:
      - Zeek conn.log
      - MDM/UEM logs
      - Network egress points
      - VPN concentrators
      - corporate firewalls
      - MDM/UEM servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FROM Zeek_conn_log, ALERT WHERE source_ip IN mobile_range AND dest_port IN vpn_ports AND dest_ip NOT IN sanctioned_vpn_list.
  - question: Does network traffic to a non-sanctioned external destination exhibit characteristics of automated C2 beaconing?
    context: |
      This question aims to find covert C2 channels masquerading as VPN traffic by analyzing their behavioral patterns. Legitimate user traffic is often bursty and irregular, while automated malware beacons are typically highly periodic. A very low variance in the time between connections (inter-arrival time) to a non-sanctioned destination suggests automated, non-human activity. Similarly, unusually long connection durations or large data transfers can also indicate malicious behavior.
    answer_sources:
      - Zeek conn.log
      - MDM/UEM logs
      - Network egress points
      - VPN concentrators
      - corporate firewalls
      - MDM/UEM servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          For each (source_ip, dest_ip), CALCULATE variance(inter_arrival_time). ALERT if variance < 5th_percentile(historical_variance) for non-sanctioned destination.
  - question: Can an unsupervised machine learning model identify anomalous network sessions indicative of a rogue VPN tunnel?
    context: |
      This question employs an unsupervised learning approach to detect rogue VPN connections that might not be caught by simple rules. An Isolation Forest or similar model can analyze multiple features of a network session simultaneously (port, duration, data volume, destination rarity, etc.) to identify outliers that deviate from the normal cluster of legitimate traffic. This is effective for finding novel or evasive tunneling techniques.
    answer_sources:
      - Zeek conn.log
      - MDM/UEM logs
      - Network egress points
      - VPN concentrators
      - corporate firewalls
      - MDM/UEM servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          IDENTIFY outliers using Isolation_Forest_model(features: dest_port, duration, total_bytes, dest_asn_rarity). FLAG anomalous sessions as potential rogue VPNs.
  - question: Are mobile devices connecting to newly registered or known malicious domains and subsequently uploading large amounts of data?
    context: |
      This question aims to detect C2 communications established through an AitM attack. Adversaries often use newly registered domains (NRDs) or domains generated by algorithms (DGAs) for their infrastructure. Alerting when a mobile device resolves a suspicious domain (newly registered or on a threat feed) and immediately follows it with a significant data upload can reveal a potential data exfiltration event or C2 channel.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Corporate DNS resolvers
      - web proxies/egress points
      - network traffic sensors (e.g., Zeek cluster)
      - threat intelligence platform feeds
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CORRELATE dns_log, http_log, conn_log. ALERT if domain_age < 30_days AND (http_method == 'POST' OR upload_bytes > 95th_percentile) within 60s of DNS query.
  - question: Are mobile devices performing DNS lookups for domains that are algorithmically generated or rarely seen within the organization?
    context: |
      This question focuses on identifying algorithmically generated domains (DGAs) and other suspicious domains by their intrinsic properties. High Shannon entropy in a domain name often indicates it was machine-generated. Similarly, a domain that has been requested by very few devices in the entire organization is suspicious. These analytics help find C2 domains without relying solely on threat intelligence feeds, which may not be up-to-date.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Corporate DNS resolvers
      - web proxies/egress points
      - network traffic sensors (e.g., Zeek cluster)
      - threat intelligence platform feeds
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CALCULATE shannon_entropy(dns_query). ALERT if entropy > 98th_percentile. Separately, ALERT if domain_request_count < 3 organization-wide in 30 days.
  - question: Can a sequence-based machine learning model detect the specific pattern of 'DNS query -> HTTP connection -> large upload' as an anomaly?
    context: |
      This question uses a sophisticated sequence model to understand the temporal relationship between events in a user session. By training a model like an LSTM on legitimate sequences of network events, it can learn what constitutes normal behavior. When it encounters a sequence matching a malicious pattern, such as a query to a rare domain followed by a large upload, it can classify the entire session as anomalous, providing a high-fidelity alert for a potential C2 channel facilitated by an AitM attack.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Corporate DNS resolvers
      - web proxies/egress points
      - network traffic sensors (e.g., Zeek cluster)
      - threat intelligence platform feeds
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CLASSIFY event_sequence(dns_entropy, domain_age, http_method, upload_bytes) using LSTM_model. ALERT if sequence is classified as anomalous.
  - question: Are managed Android devices downloading application packages (APKs) from untrusted, non-corporate sources?
    context: |
      This question is designed to detect the sideloading of potentially malicious applications, a common vector for malware delivery in an AitM attack. By monitoring network file transfers for Android APKs and checking the download source against an allow-list of approved app stores (like Google Play or a corporate store), analysts can immediately flag unauthorized app installations. Automating the submission of the app's hash to sandboxes provides rapid threat analysis.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - MDM/UEM logs
      - Managed mobile devices
      - MDM/UEM servers
      - network egress points
      - corporate application store
      - network file analysis systems
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FROM files_log, WHERE mime_type == 'application/vnd.android.package-archive'. GET download_host from http_log. ALERT if download_host NOT IN approved_store_list.
  - question: Following the installation of a sideloaded application, does the device exhibit anomalous data upload behavior?
    context: |
      This question links an unauthorized app installation to subsequent suspicious network activity. A malicious app installed via an AitM attack will often begin to exfiltrate data or communicate with a C2 server. By establishing a baseline of normal upload volume and destination patterns for each device, an alert can be triggered if a significant spike in uploads occurs shortly after a sideloaded APK is detected, strongly indicating the new app is malicious.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - MDM/UEM logs
      - Managed mobile devices
      - MDM/UEM servers
      - network egress points
      - corporate application store
      - network file analysis systems
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CORRELATE apk_install_event with conn_log. ALERT if daily_upload_volume > (avg + 3*std_dev) within 24 hours of install.
  - question: Can a machine learning model calculate a risk score for network connections to determine if a sideloaded app is malicious?
    context: |
      This question proposes a risk-based approach to evaluating the behavior of sideloaded apps. Rather than a single binary alert, a classifier model can generate a risk score for network activity following the installation. The model considers multiple features, such as the reputation of the download source, the rarity of the destination IP, and the size of the data transfer. A high cumulative risk score provides a strong, evidence-backed signal to security teams to quarantine the device.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - MDM/UEM logs
      - Managed mobile devices
      - MDM/UEM servers
      - network egress points
      - corporate application store
      - network file analysis systems
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CALCULATE risk_score using RandomForest_model(features: apk_source_rep, time_since_install, dest_ip_rarity, total_bytes). ALERT if cumulative_score > threshold.
  - question: Are mobile devices connecting to a Wi-Fi access point that is spoofing a corporate network name (SSID)?
    context: |
      This question aims to detect 'Evil Twin' or rogue access point attacks. An adversary can set up a malicious Wi-Fi access point with the same name as a legitimate corporate network to trick devices into connecting and intercepting their traffic. By maintaining a list of all approved hardware MAC addresses (BSSIDs) for corporate SSIDs, an alert can be generated whenever a device connects to an unknown BSSID that is broadcasting a corporate SSID, indicating a potential spoofing attack.
    answer_sources:
      - MDM/UEM logs
      - Network Access Control (NAC) logs
      - Managed mobile devices
      - MDM/UEM servers
      - corporate wireless LAN controllers
      - NAC systems
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FROM mdm_nac_logs, ALERT WHERE device_ssid IN corporate_ssids AND device_bssid NOT IN approved_bssid_list.
  - question: Is a new, unexpected Wi-Fi access point broadcasting a corporate SSID, and does its hardware profile differ from legitimate corporate hardware?
    context: |
      This question provides a way to detect rogue access points without a pre-built allow-list, by using historical data. It identifies any newly observed BSSID broadcasting a corporate SSID. The suspicion is heightened if the manufacturer of the new AP (identified by its OUI) is a consumer-grade brand (e.g., TP-Link, Netgear) in an environment that exclusively uses enterprise-grade hardware (e.g., Cisco, Aruba), as this is a strong indicator of a rogue device.
    answer_sources:
      - MDM/UEM logs
      - Network Access Control (NAC) logs
      - Managed mobile devices
      - MDM/UEM servers
      - corporate wireless LAN controllers
      - NAC systems
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          BASELINE bssids and ouis per corporate_ssid. ALERT on any new bssid, especially if oui_manufacturer is consumer-grade.
  - question: Can an unsupervised machine learning model identify connections to rogue access points by flagging them as outliers?
    context: |
      This question uses clustering to identify rogue AP connections based on multiple Wi-Fi properties. Legitimate connections to corporate APs should form dense clusters when analyzing features like BSSID, manufacturer, signal strength, and security type. A connection to a rogue AP will likely have different characteristics and will be identified as a 'noise point' or outlier by a model like DBSCAN, flagging it for investigation without relying on predefined rules or lists.
    answer_sources:
      - MDM/UEM logs
      - Network Access Control (NAC) logs
      - Managed mobile devices
      - MDM/UEM servers
      - corporate wireless LAN controllers
      - NAC systems
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          IDENTIFY outliers using DBSCAN_model(features: bssid, oui_manufacturer, signal_strength, channel). FLAG noise points as potential rogue AP connections.