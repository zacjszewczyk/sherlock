name: T1052.001: Exfiltration over USB
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps determine if an adversary is exfiltrating data using a USB device. It focuses on detecting the execution of known malicious tools from removable media, the abuse of native system utilities for copying data, unusually large data transfers, specific sequences of actions like connecting a device and archiving data, and anomalous activity based on user context or time of day.
type: technique
related:
- TA0010: Exfiltration
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is a known malicious tool being executed from a removable drive?
  context: This question aims to detect the most direct form of attack: an adversary plugging in a USB drive and running a pre-staged, known-malicious tool. By cross-referencing process creation events from removable media with a threat intelligence feed of malicious file hashes, we can quickly identify high-confidence threats.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers, particularly those with sensitive data access or used by privileged accounts.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH process_creation_events (EventID=4688) WHERE drive_type=removable AND file_hash IN known_malicious_hashes
- question: Is a process launched from a removable drive using an obfuscated name or arguments?
  context: Adversaries often obfuscate or pack their tools to evade signature-based detection. High Shannon entropy in a process name or its command-line arguments can be a strong indicator of this obfuscation. This question helps identify suspicious processes that might not be caught by hash lookups by flagging statistically unusual process characteristics.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers, particularly those with sensitive data access or used by privileged accounts.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH process_creation_events (EventID=4688) WHERE drive_type=removable | CALCULATE entropy(process_name), entropy(command_line) | ALERT if entropy > baseline_95th_percentile
- question: Does a process launched from a USB device exhibit characteristics of malware according to a machine learning model?
  context: This question leverages machine learning to move beyond simple rules and identify novel or polymorphic threats. By training a model on features like parent process, user context, and command-line structure, the system can learn to distinguish between benign and malicious activity, scoring new processes from USBs and alerting on those that appear malicious with high confidence.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers, particularly those with sensitive data access or used by privileged accounts.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SCORE process_creation_events (EventID=4688) WHERE drive_type=removable WITH ml_model(features) | ALERT if score > high_confidence_threshold
- question: Is a native copy utility being used to move data from a sensitive internal location to a removable drive?
  context: Adversaries often "live off the land" by using legitimate, built-in system utilities to perform malicious actions. This question focuses on detecting the abuse of tools like `robocopy`, `xcopy`, or PowerShell's `Copy-Item` to exfiltrate data. The query looks for specific command-line patterns indicating a copy from a sensitive source to a USB destination.
  answer_sources:
  - Windows Event ID 4688
  - Endpoints with access to network shares, document management systems, and code repositories.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH process_creation_events (EventID=4688) WHERE process_name IN (robocopy.exe, xcopy.exe, powershell.exe) AND command_line MATCHES REGEX 'copy sensitive_path to removable_drive_path'
- question: Is a user's use of a copy utility to target a removable drive anomalous compared to their historical behavior?
  context: This question aims to identify suspicious activity by establishing a behavioral baseline for each user. A user who rarely uses `xcopy` with recursive flags suddenly using it to copy a large directory to a USB drive is a significant deviation from their norm. By baselining usage patterns, we can detect outliers that may indicate a compromised account or insider threat.
  answer_sources:
  - Windows Event ID 4688
  - Endpoints with access to network shares, document management systems, and code repositories.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH process_creation_events (EventID=4688) WHERE process_name IN (copy_utilities) AND destination=removable_drive | COMPARE command_features to user_baseline | ALERT if deviation > 3_std_dev
- question: Is a user executing a sequence of commands that resembles a data staging and exfiltration pattern?
  context: Data exfiltration is rarely a single action. It often involves a sequence of discovery (`whoami`, `dir`), staging, and then copying. This question uses a sequence analysis model to learn normal user command progressions. It can then flag sessions where the sequence of commands is anomalous and indicative of exfiltration, such as reconnaissance followed by a large copy to a USB.
  answer_sources:
  - Windows Event ID 4688
  - Endpoints with access to network shares, document management systems, and code repositories.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: ANALYZE command_sequences_per_session per_user | COMPARE to benign_sequence_model | ALERT if sequence matches known_exfil_pattern (e.g., discovery -> copy_to_usb)
- question: Has a user written an unusually large volume of data or number of files to a removable drive in a short time window?
  context: A common indicator of bulk data exfiltration is the rapid transfer of a large amount of data. This question sets a simple, high-volume threshold (e.g., >1 GB or >1000 files in 15 minutes) to catch egregious exfiltration attempts. It requires file system auditing to be enabled on critical data stores to generate the necessary file write events.
  answer_sources:
  - Windows Event ID 4663
  - Workstations of users in departments handling PII, PHI, or intellectual property (e.g., HR, Finance, R&D).
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH file_write_events (EventID=4663) WHERE destination=removable_drive | AGGREGATE sum(bytes), count(files) by user, 15_minute_window | ALERT if sum(bytes) > 1GB OR count(files) > 1000
- question: Is the volume of data a user is writing to a USB device significantly higher than their own historical baseline?
  context: Rather than a static threshold, this question uses a dynamic baseline tailored to each user and host. A 1 GB transfer might be normal for a video editor but highly anomalous for an HR employee. By establishing a rolling 30-day baseline of write activity, we can alert when a user's behavior deviates significantly from their own normal patterns, reducing false positives.
  answer_sources:
  - Windows Event ID 4663
  - Workstations of users in departments handling PII, PHI, or intellectual property (e.g., HR, Finance, R&D).
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH file_write_events (EventID=4663) WHERE destination=removable_drive | AGGREGATE sum(bytes) by user, host, hour | COMPARE to user_host_baseline | ALERT if hourly_volume > baseline_99th_percentile
- question: Does the pattern of file writes to a removable drive deviate from the user's normal, time-based behavior according to a predictive model?
  context: This question applies advanced time-series analysis to model a user's typical data transfer behavior, including regular cycles like weekly or monthly reports. The model can predict the expected volume of data transfer for any given time. An alert is generated if the actual observed activity falls outside the model's predicted confidence interval, indicating a statistically significant anomaly that is not just high volume, but unexpectedly timed.
  answer_sources:
  - Windows Event ID 4663
  - Workstations of users in departments handling PII, PHI, or intellectual property (e.g., HR, Finance, R&D).
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: MODEL time_series_of(file_writes_to_usb) per_user with SARIMA/Prophet | PREDICT expected_volume_and_confidence_interval | ALERT if actual_volume is outside_interval
- question: Has a USB device connection been immediately followed by data archival and a large file write to that same device?
  context: This question looks for a classic data staging and exfiltration chain of events: connect, compress, copy. By correlating a USB connection event, the launch of an archival tool (like 7-Zip or WinRAR), and subsequent high-volume file writes to the new device all within a short time window, we can detect this multi-step attack pattern with high confidence.
  answer_sources:
  - Microsoft-Windows-Kernel-PnP/Configuration Event ID 400
  - Windows Event ID 4688
  - Windows Event ID 4663
  - All enterprise endpoints, with a focus on air-gapped or high-security zone systems where USB is a primary vector for data movement.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: CORRELATE events on host within 10min: (1) USB_connect (Kernel-PnP 400), then (2) process_start (EventID=4688, process_name IN archival_tools), then (3) high_volume_file_writes (EventID=4663) to new_usb_drive
- question: Is a user creating an archive file shortly after connecting a USB device, when this is not their normal behavior?
  context: This question adds a behavioral baseline to the sequence detection. Some users may legitimately connect a USB and then archive files to it. This approach focuses on the rarity of the event for a specific user. By calculating the historical probability of this sequence for each user, we can flag it as anomalous only when it's a significant deviation from their established workflow.
  answer_sources:
  - Microsoft-Windows-Kernel-PnP/Configuration Event ID 400
  - Windows Event ID 4688
  - Windows Event ID 4663
  - All enterprise endpoints, with a focus on air-gapped or high-security zone systems where USB is a primary vector for data movement.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH for sequence (USB_connect -> archive_process) by user | CALCULATE probability of sequence for that user | ALERT if current_sequence_probability < low_p_value_threshold (e.g., 0.01)
- question: Does the relationship between a user, a USB device, an archival process, and file writes form a graph pattern indicative of malicious activity?
  context: This question models system activity as a graph to uncover complex relationships that simple sequential rules might miss. The sequence of connecting a USB, running an archiver, and writing files creates a specific subgraph. By using a graph neural network (GNN), we can train a model to recognize normal, benign subgraphs and flag any patterns that deviate, indicating a likely malicious chain of actions.
  answer_sources:
  - Microsoft-Windows-Kernel-PnP/Configuration Event ID 400
  - Windows Event ID 4688
  - Windows Event ID 4663
  - All enterprise endpoints, with a focus on air-gapped or high-security zone systems where USB is a primary vector for data movement.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: BUILD graph from events (nodes: user, host, process, drive) | ANALYZE subgraphs representing (USB_connect -> archive -> write) sequence | ALERT if subgraph_pattern is anomalous via GNN_model
- question: Is a service account, or a user account outside of business hours, writing data to a removable drive?
  context: This question focuses on two high-confidence indicators of compromise. Service accounts should almost never interact with removable media, so any such activity is highly suspicious. Similarly, a standard user writing data to a USB drive late at night is a significant anomaly. This rule creates high-priority alerts for these specific, risky scenarios.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - Windows Event ID 4624
  - Windows Event ID 4634
  - All servers (especially Domain Controllers, database servers) and workstations of privileged users (e.g., Domain Admins, developers).
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: SEARCH file_write_events_to_usb (EventID=4663, 4688) | ALERT if (user_account_type = service_account) OR (user_account_type = standard AND time is outside_business_hours)
- question: Is a user writing to a USB drive during a time of day or day of week when they are normally inactive?
  context: This question refines the "off-hours" detection by creating a personalized activity baseline for each user. It analyzes login/logoff history to build a profile of a user's typical working hours. An alert is then triggered if USB write activity occurs during a time slot that is statistically unusual for that specific user, providing a more accurate detection of anomalous off-hours behavior.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - Windows Event ID 4624
  - Windows Event ID 4634
  - All servers (especially Domain Controllers, database servers) and workstations of privileged users (e.g., Domain Admins, developers).
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: BUILD user_activity_histogram by hour/day from login_events (EventID=4624, 4634) | SEARCH file_write_events_to_usb (EventID=4663) | ALERT if write_event_time falls in user's bottom_5th_percentile_activity_window
- question: Does a USB write event appear as a statistical outlier when compared to all other normal activity?
  context: This question uses unsupervised machine learning to find "unknown unknowns." By clustering all USB write events based on features like user type, time of day, and data volume, the algorithm can group normal activities together. Any event that doesn't fit into a main cluster and is flagged as an outlier (an anomaly) is a strong candidate for investigation, as it represents a behavior that is fundamentally different from the norm.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - Windows Event ID 4624
  - Windows Event ID 4634
  - All servers (especially Domain Controllers, database servers) and workstations of privileged users (e.g., Domain Admins, developers).
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: CLUSTER usb_write_events using DBSCAN/IsolationForest on features (user_type, time, volume) | ALERT on events classified as outliers/noise