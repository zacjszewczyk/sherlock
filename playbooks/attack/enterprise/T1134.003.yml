name: "T1134.003: Make and Impersonate Token"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook focuses on detecting adversaries using the 'Make and Impersonate Token' technique (T1134.003) for privilege escalation and defense evasion. It provides investigative steps to identify when adversaries manipulate tokens to gain higher privileges or operate under the context of another user. This includes scenarios such as a malicious process creating a privileged logon, an unusual parent process (like a web server) creating a logon session, a low-privilege user impersonating a high-privilege account to access sensitive resources like LSASS, or using commands like 'runas.exe' with '/netonly' or '/savecred' flags to move laterally or persist credentials. The playbook also helps detect when token impersonation is followed by suspicious network activity or attempts to clear security logs to cover tracks."
type: "technique"
related:
  - "TA0004: Privilege Escalation"
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are known malicious processes creating new, higher-privileged logon sessions within a short timeframe?"
    context: "This question attempts to identify a classic privilege escalation chain. A malicious executable, identified by its file hash, runs and then immediately impersonates a more powerful user. Detecting this sequence of a known bad file followed by a privilege-increasing logon is a high-fidelity indicator of compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Domain Controllers"
      - "Member Servers"
      - "Administrative Workstations"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process_creation (EID 4688) where hash in malicious_hash_list | JOIN logon_events (EID 4624, LogonType=9) where logon.host = process.host AND logon.time is within 60s of process.time | FILTER logon.TargetUser.privileges > process.SubjectUser.privileges"
  - question: "Are processes impersonating users they have rarely or never impersonated before?"
    context: "This question aims to detect anomalous impersonation behavior by statistically profiling normal activity. Adversaries often use legitimate processes to perform malicious actions. By identifying which processes typically impersonate which users, we can flag rare combinations as suspicious. A process like svchost.exe impersonating a domain administrator for the first time is a significant anomaly that warrants investigation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Domain Controllers"
      - "Member Servers"
      - "Administrative Workstations"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each logon_event (EID 4624, LogonType=9): GET parent_process_name, target_user | LOOKUP historical frequency of (parent_process_name, target_user) pair | IF frequency is in bottom 1st percentile, ALERT"
  - question: "Can we predict if a new logon session is part of a malicious privilege escalation chain based on its characteristics?"
    context: "This question uses a machine learning model to proactively identify malicious token impersonation. By training a model on features from both the logon event and its parent process (e.g., command line entropy, process rarity, privilege increase), the system can assign a risk score to each new logon session, allowing analysts to focus on the most probable threats."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Domain Controllers"
      - "Member Servers"
      - "Administrative Workstations"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each logon_event (EID 4624, LogonType=9): EXTRACT features (parent process entropy, rarity, privilege delta, etc.) | INPUT features into trained classification model | IF model_output_probability > threshold, ALERT"
  - question: "Are suspicious or non-standard processes creating new logon sessions?"
    context: "This question looks for processes that should not normally be creating impersonation logon sessions. For example, a web server process (w3wp.exe) or Microsoft Word (WINWORD.EXE) creating a new logon session is highly irregular and could indicate a compromised application or a document-based attack vector attempting to escalate privileges."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Application Servers"
      - "Web Servers"
      - "User Workstations"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH logon_events (EID 4624, LogonType=9) | GET parent_process_name | IF parent_process_name in suspicious_process_list, ALERT"
  - question: "Is a process suddenly starting to impersonate a much wider and more diverse set of users?"
    context: "This question detects when a process's impersonation behavior changes. A process that normally impersonates a small, consistent set of accounts but suddenly begins creating sessions for many different new accounts could be compromised. This is measured by a significant increase in the entropy of target usernames for that parent process."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Application Servers"
      - "Web Servers"
      - "User Workstations"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each logon_event (EID 4624, LogonType=9): GET parent_process_name, target_user | CALCULATE entropy of target_user set for parent_process_name over 30 days | IF new_entropy is a statistical outlier, ALERT"
  - question: "Are there clusters of anomalous logon and parent process behaviors that differ from normal activity?"
    context: "This question uses unsupervised machine learning to find outliers without pre-defined rules. By clustering logon events based on features like process names, user names, and command line attributes, the model can identify small, isolated clusters or 'noise' points that represent rare and potentially malicious impersonation activity distinct from common administrative patterns."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Application Servers"
      - "Web Servers"
      - "User Workstations"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "EXTRACT features (process, user, cmdline) from logon events (EID 4624, Type 9) | APPLY clustering algorithm (e.g., DBSCAN) | ANALYZE small clusters and noise points as anomalies"
  - question: "Is a low-privilege user impersonating a high-privilege user and then immediately accessing sensitive system resources?"
    context: "This question looks for a specific, high-impact attack chain: a non-privileged account creates a logon session for a privileged account and then uses that session to access credentials from memory (LSASS). Correlating the logon event with the subsequent sensitive object access provides strong evidence of a credential dumping attack."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Windows Event ID 4656"
      - "Windows Event ID 4657"
      - "Domain Controllers"
      - "High-Value Asset Servers"
      - "Tier 0 Administrator Workstations"
      - "Certificate Authorities"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH logon_event (EID 4624, LogonType=9) where TargetUser.privileges > SubjectUser.privileges | CORRELATE logon_event.TargetLogonId with object_access_event (EID 4656) on lsass.exe within 5 minutes"
  - question: "Is a user impersonating an account with a privilege level that is a significant outlier compared to their normal behavior?"
    context: "This question establishes a baseline of impersonation behavior for each user. An alert is triggered if a user impersonates an account where the 'privilege gap' between their own account and the target account is statistically unusual for them. This helps distinguish between routine administrative tasks and anomalous, potentially malicious privilege escalation."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Windows Event ID 4656"
      - "Windows Event ID 4657"
      - "Domain Controllers"
      - "High-Value Asset Servers"
      - "Tier 0 Administrator Workstations"
      - "Certificate Authorities"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each logon_event (EID 4624, LogonType=9): CALCULATE privilege_gap_score(TargetUser, SubjectUser) | IF score > 99th percentile of historical scores for SubjectUser, ALERT"
  - question: "Does the sequence of actions following a logon impersonation event match known attack patterns?"
    context: "This question uses a time-series model to analyze the 'story' of a logon session. After a user is impersonated, the model tracks the sequence of events associated with that session ID. Sequences that are improbable or that closely match known malicious kill chains (e.g., access credentials, create scheduled task, connect to C2) are flagged as high-risk."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Windows Event ID 4656"
      - "Windows Event ID 4657"
      - "Domain Controllers"
      - "High-Value Asset Servers"
      - "Tier 0 Administrator Workstations"
      - "Certificate Authorities"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "AFTER logon_event (EID 4624, LogonType=9): MONITOR sequence of subsequent events for that TargetLogonId | INPUT event sequence into anomaly detection model | IF model flags sequence as improbable or malicious, ALERT"
  - question: "Is 'runas.exe /netonly' being used by a web server or other unusual process to connect to internal systems?"
    context: "This question looks for adversaries using 'runas.exe /netonly' for lateral movement after compromising a server. A web server process spawning 'runas' to authenticate to other internal machines is a strong indicator that an attacker is using a web shell to expand their foothold within the network."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Internal-facing Servers"
      - "Staging Servers"
      - "User Workstations"
      - "Network Egress Points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process_creation (EID 4688) for 'runas.exe' with '/netonly' in command line | IF parent_process is 'w3wp.exe' or similar | CORRELATE with outbound network connections to internal IPs on ports 445, 3389, 5985"
  - question: "Is 'runas.exe /netonly' being used by an anomalous user or to connect to a rare destination?"
    context: "This question establishes a baseline for legitimate use of 'runas.exe /netonly' and alerts on deviations. An alert is triggered if a service account uses it for the first time, or if a legitimate user employs it to connect to a destination host they have never accessed before, suggesting the command is being used for reconnaissance or lateral movement."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Internal-facing Servers"
      - "Staging Servers"
      - "User Workstations"
      - "Network Egress Points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH for 'runas.exe /netonly' usage | IF user or source_host is not in baseline OR destination_host is rare for that user/host pair, ALERT"
  - question: "Does a graph of process and network interactions show a suspicious path involving 'runas.exe /netonly'?"
    context: "This question models system activity as a graph to find anomalous attack paths. A sequence like 'web server -> command shell -> runas.exe /netonly -> critical database' forms a path in the graph. If this path is rare or has never been seen before, it is flagged as a potential threat, indicating a web shell performing lateral movement."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Internal-facing Servers"
      - "Staging Servers"
      - "User Workstations"
      - "Network Egress Points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "MODEL activity as a graph (nodes=users,processes,hosts) | SEARCH for paths like 'w3wp.exe -> cmd.exe -> runas.exe /netonly -> DB_SERVER' | IF path is statistically anomalous, ALERT"
  - question: "Is 'runas.exe /savecred' being executed from a non-interactive session or a suspicious file path?"
    context: "This question targets the malicious use of '/savecred' to persist credentials. Execution by a non-interactive process (like a Windows Service) or from a user-writable temporary directory is highly suspicious, as it suggests an automated script or malware is trying to save credentials for later use, rather than a legitimate administrator."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Multi-user Servers (e.g., Citrix, RDS)"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process_creation (EID 4688) for 'runas.exe' with '/savecred' | IF SubjectLogonId is non-interactive OR ParentProcessPath is in a temp/suspicious location, ALERT"
  - question: "Is 'runas.exe /savecred' being launched from a process with a high-entropy or rare file path?"
    context: "This question uses statistical properties of the parent process path to find malware. Adversaries often place tools in randomly named folders or deeply nested temporary directories. A high-entropy path or a path that is statistically rare across the enterprise can indicate that 'runas.exe /savecred' is being launched by malware rather than a legitimate tool."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Multi-user Servers (e.g., Citrix, RDS)"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each 'runas.exe /savecred' execution: CALCULATE entropy and rarity of parent process path | IF path_entropy or path_rarity is a statistical outlier, ALERT"
  - question: "Can we distinguish malicious 'runas.exe /savecred' executions from legitimate ones based on their context?"
    context: "This question applies a machine learning model to classify the legitimacy of '/savecred' usage. By analyzing features like the parent process, user context (interactive vs. service), and path characteristics, the model can learn the patterns of normal administrative use and flag executions that deviate, indicating potential credential theft."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Multi-user Servers (e.g., Citrix, RDS)"
      - "SIEM/Log Aggregator"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each 'runas.exe /savecred' execution: EXTRACT features (parent process, user context, path attributes) | INPUT to classification model | IF model flags as malicious, ALERT"
  - question: "Is a new logon impersonation session immediately followed by connections to known malicious domains?"
    context: "This question links token impersonation directly to network-based indicators of compromise. An attacker may impersonate a user to inherit their network permissions or to obfuscate the source of malicious traffic. Correlating a Logon Type 9 event with immediate DNS queries or connections to known C2 servers is a strong signal of active compromise."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Network Egress Points"
      - "DNS Servers"
      - "Critical Asset Subnets"
      - "Proxy Logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ON logon_event (EID 4624, LogonType=9), CORRELATE ProcessId with DNS queries and network connections within 60s | IF destination domain is on C2 blocklist or newly registered, ALERT"
  - question: "After a user is impersonated, does their network behavior become anomalous?"
    context: "This question establishes a baseline of normal network activity for each user (e.g., common destinations, ports, protocols). If, after an impersonation event, the network traffic associated with that user suddenly deviates—such as connecting to a new country or using a rare port—it suggests the impersonated session is being used by an attacker for command and control or data exfiltration."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Network Egress Points"
      - "DNS Servers"
      - "Critical Asset Subnets"
      - "Proxy Logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "AFTER logon_event (EID 4624, LogonType=9), MONITOR subsequent network traffic for the user | IF traffic deviates from user's historical baseline (e.g., new country, rare port, high entropy domain), ALERT"
  - question: "Is there an unpredicted spike in outbound network traffic immediately following a logon impersonation event?"
    context: "This question uses a time-series forecasting model to predict a host's normal network traffic volume. A significant, unpredicted spike in outbound data immediately following a Logon Type 9 event is a strong anomaly, suggesting that an attacker has impersonated a user and is now using that session for a high-volume activity like data exfiltration."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Network Egress Points"
      - "DNS Servers"
      - "Critical Asset Subnets"
      - "Proxy Logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FORECAST host's outbound traffic volume using time-series model | AFTER logon_event (EID 4624, LogonType=9), COMPARE actual traffic to forecast | IF actual traffic significantly exceeds forecast, ALERT"
  - question: "Has the SYSTEM account been impersonated immediately before security logs were cleared?"
    context: "This is a high-fidelity detection for a common defense evasion sequence. An attacker impersonates the highly privileged SYSTEM account and then uses those privileges to clear the security event log (wevtutil.exe cl Security or Event ID 1102), effectively erasing their tracks. Chaining these two events together provides a very strong indication of malicious activity."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Windows Event ID 1102"
      - "Windows Event ID 4663"
      - "Log Aggregation Servers"
      - "Domain Controllers"
      - "Security Appliance Management Interfaces"
      - "EDR servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH for logon_event (EID 4624, LogonType=9, TargetUser='SYSTEM') | IF within 2 minutes, a log clear event (EID 1102) OR process_creation of 'wevtutil.exe cl' occurs on the same host, ALERT"
  - question: "Is there a statistically unusual temporal relationship between a privileged impersonation and a log clearing event?"
    context: "This question looks for log clearing events that happen anomalously soon after a privileged account is impersonated. While both events might occur legitimately, an attacker's automated script will often clear logs immediately after gaining privileges. An alert is triggered if the time delta between these events is a statistical outlier (e.g., unusually short), suggesting automated evasion."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Windows Event ID 1102"
      - "Windows Event ID 4663"
      - "Log Aggregation Servers"
      - "Domain Controllers"
      - "Security Appliance Management Interfaces"
      - "EDR servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE baseline for time delta between privileged Logon Type 9 events and log clear events (EID 1102) | IF a new time delta is a statistical outlier (e.g., in the 1st percentile), ALERT"
  - question: "Does a sequence of security events match the pattern of impersonation followed by defense evasion?"
    context: "This question uses a state-transition model (HMM) to understand the narrative of an attack. The model learns the probability of moving from one state to another (e.g., 'Normal' -> 'Impersonation' -> 'Evasion'). A sequence of events like 'Logon Type 9 for SYSTEM', followed by 'Access to EDR process', then 'Terminate Process', represents a low-probability path through the model, triggering a high-confidence alert for a sophisticated evasion attempt."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Windows Event ID 1102"
      - "Windows Event ID 4663"
      - "Log Aggregation Servers"
      - "Domain Controllers"
      - "Security Appliance Management Interfaces"
      - "EDR servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "INPUT sequence of security events into a trained Hidden Markov Model | IF model identifies a low-probability path corresponding to an attack pattern (e.g., Logon -> Terminate Security Tool -> Clear Logs), ALERT"