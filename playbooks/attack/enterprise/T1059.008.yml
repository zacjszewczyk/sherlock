name: T1059.008: Network Device CLI
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps determine if an adversary has gained execution on a network device by abusing its command-line interface (CLI). It investigates suspicious network management sessions from malicious IPs, anomalous command sequences indicative of malicious TTPs (like disabling logging before creating a user), administrative logins with anomalous properties (e.g., unusual location or time), unauthorized configuration changes, and outbound network connections from infrastructure devices to non-approved destinations.
type: technique
related:
  - TA0002: Execution
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are network management sessions (SSH/Telnet) originating from known malicious IP addresses?
    context: This question aims to identify if an adversary is attempting to log into a network device from an IP address that is part of a threat intelligence feed. A match indicates a high probability of a targeted attack or automated scanning from a malicious source. The action involves continuously correlating source IPs from SSH (port 22) and Telnet (port 23) connection logs against a list of known malicious IPs.
    answer_sources: Zeek conn.log, Zeek ssh.log, Zeek telnet.log, Zeek syslog.log, Windows Event ID 4624, Windows Event ID 4776. Relevant assets include Edge firewalls, core routers, distribution/access layer switches, VPN concentrators, RADIUS/TACACS+ servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each event in connection_logs WHERE destination_port is 22 or 23
            CHECK if source_ip exists in threat_intelligence_feed
            IF match FOUND, ALERT
  - question: Are statistically rare or novel commands being executed on network devices?
    context: This question looks for unusual commands that deviate from normal administrative behavior. By baselining the frequency of all command words (1-grams) over 30 days, we can identify commands that are rarely used. An alert on a command word falling below the 1st percentile of frequency could indicate an adversary using custom tools or attempting obfuscation.
    answer_sources: Zeek conn.log, Zeek ssh.log, Zeek telnet.log, Zeek syslog.log, Windows Event ID 4624, Windows Event ID 4776. Relevant assets include Edge firewalls, core routers, distribution/access layer switches, VPN concentrators, RADIUS/TACACS+ servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE command_word_frequencies from syslog over last 30 days
          FOR each new command_event in syslog
            FOR each word in command_event
              IF frequency of word < 1st percentile of baseline
                ALERT on rare_command_execution
  - question: Are executed network device commands indicative of obfuscation or exploitation based on machine learning models?
    context: This question uses a pre-trained Natural Language Processing (NLP) model to analyze the structure and content of commands executed on network devices. The model, trained on known malicious commands and exploit code, can identify complex patterns of obfuscation or exploitation. An alert with a high confidence score (>0.9) suggests a strong likelihood of malicious intent.
    answer_sources: Zeek conn.log, Zeek ssh.log, Zeek telnet.log, Zeek syslog.log, Windows Event ID 4624, Windows Event ID 4776. Relevant assets include Edge firewalls, core routers, distribution/access layer switches, VPN concentrators, RADIUS/TACACS+ servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each new command_string from syslog
            PROCESS command_string with NLP_exploit_classifier
            IF classification_score > 0.9
              ALERT on likely_exploitation_attempt
  - question: Is a user disabling logging and then creating a privileged user within a short time frame?
    context: This question looks for a specific, high-confidence malicious sequence of actions. An adversary may first disable logging to hide their subsequent activities, such as creating a new privileged account for persistence. Detecting this sequence in a single session within a 10-minute window is a strong indicator of compromise.
    answer_sources: Zeek syslog.log, Network device configuration backups. Relevant assets include Centralized syslog servers, TACACS+/RADIUS authentication servers, core network infrastructure.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each session (grouped by source_ip, device_hostname)
            IF event "disable logging" is followed by "create privileged user" within 10 minutes
              ALERT on suspicious_user_creation_sequence
  - question: Are administrators executing statistically rare sequences of commands?
    context: This question aims to identify unusual workflows by modeling command sequences as Markov chains. Normal administrative tasks often follow predictable patterns. By calculating the probability of transitioning from one command to another based on a 90-day baseline, we can flag sequences that are statistically improbable and potentially malicious.
    answer_sources: Zeek syslog.log, Network device configuration backups. Relevant assets include Centralized syslog servers, TACACS+/RADIUS authentication servers, core network infrastructure.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE command_transition_probabilities from syslog over last 90 days
          FOR each new session
            FOR each command_pair (cmd1, cmd2) in session
              IF transition_probability(cmd1, cmd2) < 0.005
                ALERT on rare_command_sequence
  - question: Do network device command sequences deviate significantly from normal patterns, as identified by an LSTM autoencoder?
    context: This question uses a Long Short-Term Memory (LSTM) autoencoder to learn the deep, sequential patterns of normal administrative sessions. The model is trained to reconstruct benign command sequences. When a new, potentially malicious sequence is processed, the model will struggle to reconstruct it, resulting in a high 'reconstruction error' that indicates a highly suspicious anomaly.
    answer_sources: Zeek syslog.log, Network device configuration backups. Relevant assets include Centralized syslog servers, TACACS+/RADIUS authentication servers, core network infrastructure.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN LSTM_autoencoder on benign command sequences
          CALCULATE baseline reconstruction_error_distribution
          FOR each new command_sequence
            CALCULATE reconstruction_error using trained LSTM model
            IF reconstruction_error > 99th percentile of baseline
              ALERT on anomalous_command_sequence
  - question: Are administrative logins to network devices occurring from unauthorized geographic locations or ASNs?
    context: This question checks if successful administrative connections (SSH/Telnet) to network devices originate from countries or Autonomous System Numbers (ASNs) that are not on a pre-defined allow-list. This is a straightforward way to detect potential unauthorized access from unexpected network locations.
    answer_sources: Zeek conn.log, Zeek ssh.log, Zeek telnet.log, Windows Event ID 4624, Windows Event ID 4776. Relevant assets include VPN concentrators, jump boxes/bastion hosts, network management subnets, Domain Controllers, RADIUS/TACACS+ servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN allow_list of admin_countries and admin_asns
          FOR each successful admin_login
            IF source_country or source_asn NOT IN allow_list
              ALERT on login_from_unauthorized_location
  - question: Do administrative sessions exhibit a combination of multiple risky behaviors?
    context: This question uses a risk-scoring model to identify suspicious sessions. Instead of relying on a single indicator, it aggregates risk by assigning points for multiple anomalous properties, such as a login from a rare country, an unusual time, or a session duration that is significantly longer than the user's average. A cumulative score of 3 or more indicates a high-risk session requiring investigation.
    answer_sources: Zeek conn.log, Zeek ssh.log, Zeek telnet.log, Windows Event ID 4624, Windows Event ID 4776. Relevant assets include VPN concentrators, jump boxes/bastion hosts, network management subnets, Domain Controllers, RADIUS/TACACS+ servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each admin_user, PROFILE baseline login_hours, source_locations, session_durations
          FOR each new admin_session
            CALCULATE risk_score (e.g., +2 for rare country, +1 for off-hours, +1 for long duration)
            IF risk_score >= 3
              ALERT on high_risk_session
  - question: Are there any administrative sessions that are outliers compared to established normal behavior?
    context: This question uses a clustering algorithm like DBSCAN to define 'normal' behavior based on session features (user, source ASN, time, duration). The algorithm groups similar, frequent sessions into clusters. Any session that does not fit into an established cluster is flagged as a 'noise point' or outlier, representing a potentially anomalous or malicious activity that deviates from all known patterns.
    answer_sources: Zeek conn.log, Zeek ssh.log, Zeek telnet.log, Windows Event ID 4624, Windows Event ID 4776. Relevant assets include VPN concentrators, jump boxes/bastion hosts, network management subnets, Domain Controllers, RADIUS/TACACS+ servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON a daily basis, CLUSTER all session_feature_vectors using DBSCAN
          IDENTIFY stable clusters as normal_behavior
          FOR each new session
            IF session is classified as noise_point (outlier) by DBSCAN
              ALERT on anomalous_outlier_session
  - question: Are there network device configuration changes that are not tied to an approved change request?
    context: This question provides a direct method for detecting unauthorized changes. It correlates configuration change events from device logs with the organization's change management system (e.g., ServiceNow, Jira). If a configuration change is detected without a corresponding approved ticket within a +/- 1-hour window, it generates an alert, indicating a potential policy violation or malicious activity.
    answer_sources: Zeek syslog.log, Network device configuration backups, CMDB/ITSM API. Relevant assets include Configuration backup repositories, change management system (e.g., ServiceNow, Jira), centralized syslog servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each config_change_event from syslog
            QUERY change_management_system_api for approved_ticket for device within 1 hour
            IF no_ticket_found
              ALERT on unauthorized_configuration_change
  - question: Have any network devices undergone an unusually large configuration modification?
    context: This question detects suspiciously large changes to a device's configuration. By performing a daily 'diff' between the current and previous day's configuration backup and calculating the normalized edit distance, we can quantify the magnitude of the change. An alert is triggered if this distance exceeds the 99th percentile for that device type, flagging a modification that is significantly larger than normal.
    answer_sources: Zeek syslog.log, Network device configuration backups, CMDB/ITSM API. Relevant assets include Configuration backup repositories, change management system (e.g., ServiceNow, Jira), centralized syslog servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE per-device-type normalized_edit_distance for daily config diffs
          FOR each device, daily
            CALCULATE edit_distance between current and previous config
            IF edit_distance > 99th percentile for device_type
              ALERT on unusually_large_config_change
  - question: Is there an anomalous spike in the number of configuration changes for a specific device?
    context: This question uses time-series analysis to find an abnormal frequency of configuration changes. A decomposition model separates the daily count of changes into trend, seasonal, and residual components. A spike in the residual component (the part not explained by normal trends) indicates an anomalous number of changes, which could signal a misconfiguration or malicious activity.
    answer_sources: Zeek syslog.log, Network device configuration backups, CMDB/ITSM API. Relevant assets include Configuration backup repositories, change management system (e.g., ServiceNow, Jira), centralized syslog servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each device, MODEL daily_config_change_count using time-series decomposition
          CALCULATE mean and std_dev of the residual_component
          IF today's residual > 3 * std_dev from mean
            ALERT on anomalous_change_frequency
  - question: Are network devices initiating outbound connections to unapproved destinations?
    context: This question enforces a strict egress policy for network infrastructure. Network devices should only connect to a limited set of approved destinations (like NTP, syslog, etc.). This action involves maintaining an explicit allow-list of destination IP and port pairs. Any outbound connection from a device to a destination not on this list is a high-confidence indicator of a potential compromise or misconfiguration.
    answer_sources: Zeek conn.log, Zeek dns.log. Relevant assets include Network device management VLANs, core and edge routers, internet gateways.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN allow_list of approved destination_ip:port for network devices
          FOR each outbound_connection from a network_device
            IF destination_ip:port NOT IN allow_list
              ALERT on unauthorized_outbound_connection
  - question: Is a network device connecting to an anomalously diverse set of destination ports?
    context: This question identifies when a network device's connection patterns change suspiciously. By calculating the Shannon entropy of the set of destination ports a device connects to over a 24-hour window, we can measure the randomness or diversity of its connections. A sudden spike in entropy compared to its historical baseline suggests the device is connecting to many new or unusual ports, which could be a sign of compromise (e.g., C2 beaconing, scanning).
    answer_sources: Zeek conn.log, Zeek dns.log. Relevant assets include Network device management VLANs, core and edge routers, internet gateways.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each device, BASELINE Shannon_entropy of destination_ports over 30 days
          FOR each device, in a 24-hour sliding window
            CALCULATE current_entropy of destination_ports
            IF current_entropy > 98th percentile of baseline
              ALERT on anomalous_port_diversity
  - question: Are network devices initiating outbound connections that are anomalous according to a machine learning model?
    context: This question uses a One-Class Support Vector Machine (OC-SVM) to create a precise profile of normal outbound connections from network devices, based on features like protocol, destination port, and bytes sent. The trained model can then classify any new connection as either normal or anomalous. This method can detect subtle deviations from established behavior that might be missed by static rules or simpler statistical methods.
    answer_sources: Zeek conn.log, Zeek dns.log. Relevant assets include Network device management VLANs, core and edge routers, internet gateways.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN a One-Class SVM on feature vectors of benign outbound connections
          FOR each new outbound_connection from a network_device
            CLASSIFY the connection using the trained OC-SVM model
            IF connection is classified as anomaly
              ALERT on anomalous_outbound_connection