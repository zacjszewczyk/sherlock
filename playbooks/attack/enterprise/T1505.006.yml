name: T1505.006: vSphere Installation Bundles
id: f1a8e2d4-5b6c-4f7e-8d9a-0c1b3e4f5a6b
description: This playbook focuses on detecting adversaries who maintain persistence on ESXi hypervisors by installing malicious vSphere Installation Bundles (VIBs). The investigation covers multiple angles, including identifying the network transfer of known malicious VIBs by hash, detecting VIBs transferred from rare or unauthorized sources, and flagging the use of command-line arguments that bypass security controls like signature checking. It also aims to detect suspicious post-installation activity, such as an ESXi host making unusual outbound network connections, and enforces policy by identifying VIB installations performed by unauthorized users or outside of approved maintenance windows.
type: technique
related:
- TA0003: Persistence
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is a VIB file with a known malicious hash being transferred to an ESXi host?
  context: Adversaries may use known malicious VIBs with pre-calculated hashes. This question aims to detect the transfer of these files by comparing the hash of any transferred VIB file against a threat intelligence feed. A match is a high-fidelity indicator of a compromise attempt.
  answer_sources:
  - Zeek files.log
  - Zeek conn.log
  - Network traffic sensors monitoring traffic to and from the ESXi management network (vmk0 interfaces) and vCenter servers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH files.log WHERE filename ENDS WITH '.vib' OR '.vgz' | JOIN conn.log ON uid WHERE dest_ip IN esxi_host_list | LOOKUP file_hash against threat_intel_feed | RETURN results WHERE match_found
- question: Is a VIB file being transferred to an ESXi host from a statistically rare source IP address?
  context: Legitimate VIB transfers typically originate from a small, consistent set of sources like vCenter servers or official update repositories. This question establishes a baseline of normal source IPs and flags transfers from rare or new sources, which could indicate an attacker staging tools from an unauthorized location.
  answer_sources:
  - Zeek files.log
  - Zeek conn.log
  - Network traffic sensors monitoring traffic to and from the ESXi management network (vmk0 interfaces) and vCenter servers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH files.log WHERE filename ENDS WITH '.vib' OR '.vgz' | JOIN conn.log on uid | STATS count by source_ip | CALCULATE frequency | RETURN results WHERE frequency < 5th_percentile
- question: Does a VIB file transfer exhibit characteristics that a machine learning model classifies as malicious?
  context: This question uses a machine learning approach to identify subtle anomalies in VIB transfers that rule-based methods might miss. By analyzing a combination of features like file size, protocol, time of day, and source subnet, the model can detect novel or evasive techniques that deviate from established benign patterns.
  answer_sources:
  - Zeek files.log
  - Zeek conn.log
  - Network traffic sensors monitoring traffic to and from the ESXi management network (vmk0 interfaces) and vCenter servers.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: INPUT VIB_transfer_events (file_size, source_subnet, protocol, time_of_day) | PREDICT using classification_model | RETURN results WHERE prediction is 'malicious'
- question: Is an administrator using `esxcli` commands with arguments designed to bypass security controls, such as forcing installation or disabling signature checks?
  context: The use of arguments like `--force`, `--no-sig-check`, or setting the acceptance level to `CommunitySupported` allows for the installation of untrusted or unsigned VIBs. This is a key tactic for adversaries to install malware on an ESXi host. Detecting these arguments provides a strong signal of malicious intent or risky administrative behavior.
  answer_sources:
  - Windows Event ID 4688
  - Linux auditd logs
  - Command line logging on vCenter Server Appliances (VCSA), Windows-based vCenter servers, and administrative jump boxes with VMware PowerCLI or other management tools installed.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH process_creation_logs WHERE process_name = 'esxcli' AND command_line CONTAINS ('--force' OR '--no-sig-check' OR 'acceptance set --level=CommunitySupported') | ALERT
- question: Is an administrator executing a VIB-related `esxcli` command using a statistically rare combination of arguments for their user profile?
  context: Every administrator tends to use a typical set of commands and arguments for their role. This question baselines the command argument combinations for each user and flags when a user executes a sensitive VIB installation command with a combination of arguments they have rarely or never used before. This can indicate that their account has been compromised and is being used by an attacker.
  answer_sources:
  - Windows Event ID 4688
  - Linux auditd logs
  - Command line logging on vCenter Server Appliances (VCSA), Windows-based vCenter servers, and administrative jump boxes with VMware PowerCLI or other management tools installed.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH process_creation_logs WHERE process_name = 'esxcli' | BASELINE command_arguments by user | DETECT VIB_install_command where argument_combination_rarity < 1% for user | ALERT
- question: Has a sequence of `esxcli` commands occurred that is highly improbable based on a machine learning model of normal administrative workflows?
  context: Attackers often execute a sequence of preparatory commands before deploying malware, such as disabling a firewall, installing the VIB, and then re-enabling the firewall. This question uses a sequence analysis model to learn what normal command progressions look like and flags any sequence that has a very low probability of being benign.
  answer_sources:
  - Windows Event ID 4688
  - Linux auditd logs
  - Command line logging on vCenter Server Appliances (VCSA), Windows-based vCenter servers, and administrative jump boxes with VMware PowerCLI or other management tools installed.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: INPUT esxcli_command_sequence | SCORE probability using HMM_model | RETURN results WHERE probability is low | ALERT
- question: Did an ESXi host initiate contact with a known malicious domain or IP address shortly after a VIB was installed or the host was rebooted?
  context: Malicious VIBs often establish command and control (C2) communication immediately after installation or upon a system reboot. This question correlates VIB installation/reboot events from vCenter with subsequent outbound network traffic from the ESXi host. A connection to a destination on a threat intelligence feed within this short time window is a strong indicator of compromise.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - VMware vCenter event logs
  - ESXi host management interfaces (vmk0), network perimeter firewalls, DNS server logs, and vCenter server event logs.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH vcenter_logs for VIB_install OR host_reboot events | WITHIN 60m AFTER event, SEARCH network_logs WHERE source_ip=esxi_host_ip | LOOKUP destination against threat_intel | ALERT on match
- question: Following a VIB installation or reboot, did an ESXi host connect to a destination port that is statistically rare for that host?
  context: ESXi hosts typically communicate over a predictable set of management ports. A malicious VIB may initiate C2 communication over a non-standard or high-numbered port. This question baselines normal port usage for each host and flags new connections to statistically rare ports that occur shortly after a potential compromise event.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - VMware vCenter event logs
  - ESXi host management interfaces (vmk0), network perimeter firewalls, DNS server logs, and vCenter server event logs.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH vcenter_logs for VIB_install OR host_reboot events | WITHIN 60m AFTER event, SEARCH conn.log WHERE source_ip=esxi_host_ip | BASELINE destination_ports by host | ALERT if new_connection_port is rare
- question: Did an ESXi host exhibit a significant and anomalous spike in outbound data volume shortly after a VIB installation or reboot?
  context: A sudden, unforecasted increase in data transfer from an ESXi host's management interface could signify data exfiltration or heavy C2 traffic initiated by a malicious VIB. This question uses time series analysis to model expected traffic volumes and alerts when a significant deviation occurs shortly after a software change.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - VMware vCenter event logs
  - ESXi host management interfaces (vmk0), network perimeter firewalls, DNS server logs, and vCenter server event logs.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH vcenter_logs for VIB_install OR host_reboot events | WITHIN 60m AFTER event, SEARCH conn.log WHERE source_ip=esxi_host_ip | INPUT outbound_bytes to time_series_model | ALERT on high anomaly_score
- question: Was a VIB file transferred to an ESXi host from a source IP that is not on the approved list of vCenter servers or update repositories?
  context: In a properly configured environment, VIB files should only be transferred from a small set of authorized sources. This question checks the source IP of every VIB transfer against a predefined allowlist. Any transfer originating from an IP not on this list is a high-confidence indicator of an unauthorized and potentially malicious software installation.
  answer_sources:
  - Zeek files.log
  - Zeek conn.log
  - Zeek http.log
  - Network taps monitoring traffic between administrative subnets and the ESXi management network; perimeter firewall logs showing traffic to and from VMware update domains.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH files.log WHERE filename ENDS WITH '.vib' OR '.vgz' | JOIN conn.log on uid | LOOKUP source_ip against authorized_source_allowlist | ALERT on no_match
- question: Was a VIB file downloaded using a rare or suspicious User-Agent string, such as a command-line utility instead of a standard VMware tool?
  context: Legitimate VMware processes use predictable User-Agent strings when downloading files. Attackers often use common scripting tools or command-line utilities like 'curl' or 'wget' to transfer their payloads. This question flags VIB downloads that use these suspicious or statistically rare user agents.
  answer_sources:
  - Zeek files.log
  - Zeek conn.log
  - Zeek http.log
  - Network taps monitoring traffic between administrative subnets and the ESXi management network; perimeter firewall logs showing traffic to and from VMware update domains.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH http.log for VIB_download | BASELINE user_agent_strings | ALERT if user_agent_frequency < 1% OR user_agent IN ('curl', 'wget', 'python-requests')
- question: Did a VIB file transfer occur that is a statistical outlier compared to the clusters of normal, legitimate transfers?
  context: Normal, automated VIB transfers from a central management server tend to have very similar network characteristics (protocol, port, file size, etc.). These legitimate transfers will form a dense cluster when analyzed. This question uses a clustering algorithm to automatically identify any VIB transfer that does not fit this pattern and is flagged as an outlier, indicating a deviation from the norm.
  answer_sources:
  - Zeek files.log
  - Zeek conn.log
  - Zeek http.log
  - Network taps monitoring traffic between administrative subnets and the ESXi management network; perimeter firewall logs showing traffic to and from VMware update domains.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: INPUT VIB_transfer_features (source_ip, port, protocol, JA3) into DBSCAN_model | ALERT on events classified as 'noise' or 'outlier'
- question: Was an `esxcli software vib install` command executed by a user not in an authorized admin group, or was it executed outside of an approved maintenance window?
  context: This question enforces organizational policy as a detection method. VIB installation is a privileged operation that should be restricted to specific administrative groups and performed only during scheduled maintenance windows. An alert on this activity indicates either a policy violation or malicious activity by an unauthorized user.
  answer_sources:
  - Windows Event ID 4688
  - Linux auditd logs
  - Active Directory security logs
  - Domain Controllers, administrative workstations, vCenter servers (Windows and VCSA), and change management databases or ticketing systems that define maintenance windows.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH process_logs for 'esxcli software vib install' | GET user, timestamp | LOOKUP user in 'ESXi Admins' group | LOOKUP timestamp in maintenance_schedule | ALERT if user not in group OR timestamp outside window
- question: Did an authorized administrator execute a VIB installation command at a time of day that is highly unusual for that specific user?
  context: This is a user behavior analytics (UBA) question that aims to detect compromised credentials. Even if a legitimate administrative account is used to install a VIB, if the action occurs at a time that is statistically abnormal for that user (e.g., in the middle of the night), it is highly suspicious and could indicate an attacker is using their account.
  answer_sources:
  - Windows Event ID 4688
  - Linux auditd logs
  - Active Directory security logs
  - Domain Controllers, administrative workstations, vCenter servers (Windows and VCSA), and change management databases or ticketing systems that define maintenance windows.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH process_logs for 'esxcli software vib install' | GET user, timestamp | BASELINE activity_hours by user | CALCULATE Z-score for timestamp | ALERT if Z-score > 3
- question: Has a VIB installation event been classified as 'unauthorized' by a machine learning model based on a combination of factors like user role, source host, and time of day?
  context: This question provides a sophisticated, risk-based assessment of a VIB installation. A machine learning model can consider multiple contextual factors simultaneously—such as the user's role, the source of the command, the time of day, and whether it was preceded by an anomalous login—to generate a risk score and predict if the action is truly authorized or likely malicious.
  answer_sources:
  - Windows Event ID 4688
  - Linux auditd logs
  - Active Directory security logs
  - Domain Controllers, administrative workstations, vCenter servers (Windows and VCSA), and change management databases or ticketing systems that define maintenance windows.
  range: last 90 days
  queries:
  - technology: pseudocode
    query: INPUT VIB_install_features (user_role, source_host, time_of_day) | PREDICT using authorization_model | ALERT where prediction is 'unauthorized'