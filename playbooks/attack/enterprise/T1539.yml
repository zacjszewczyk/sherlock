name: T1539: Steal Web Session Cookie
id: 4e2e1d7a-8b1f-4c9e-9d0a-6f7a1b3c4d5e
description: This playbook helps investigate whether an adversary has stolen web session cookies to impersonate a user. The investigation focuses on detecting known cookie-stealing tools via file hashes or connections to malicious infrastructure, identifying suspicious command-line arguments or scripts accessing cookie stores, monitoring for unapproved processes reading cookie database files or browser memory, analyzing network traffic for anomalies indicative of Adversary-in-the-Middle (AitM) attacks, and identifying instances of browsers spawning anomalous child processes like command shells.
type: technique
related:
- TA0006: Credential Access
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Have any file hashes or network connections matched threat intelligence feeds for known cookie-stealing malware or Adversary-in-the-Middle (AitM) infrastructure?
  context: This question seeks to identify direct evidence of cookie theft tools or infrastructure by comparing observed file hashes and network destinations against curated lists of known malicious indicators. A match provides a high-confidence signal that an adversary is attempting to steal session cookies.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek http.log
  - Zeek files.log
  - User Workstations, Network Egress Points, Web Proxies
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH (EID 4688 file hashes OR Zeek file hashes) IN threat_intel_malware_hashes. JOIN (Zeek destination IPs OR Zeek server names) IN threat_intel_aitm_c2_ips_or_domains. ALERT on match.
- question: Are there any unusually rare file hashes or destination domains being observed in the environment?
  context: This statistical approach aims to uncover novel or unknown cookie-stealing tools by identifying executables and network destinations that are statistical outliers. Adversary tools are often rare within a specific environment, so low prevalence can be a strong indicator of malicious activity, especially when correlated with other suspicious behaviors.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek http.log
  - Zeek files.log
  - Zeek dns.log
  - User Workstations, Network Egress Points, Web Proxies
  range: Last 30 days
  queries:
  - technology: pseudocode
    query: CALCULATE prevalence of (EID 4688 file hashes AND Zeek DNS domains) over 30 days. ALERT where prevalence < 1st percentile.
- question: Have any newly observed executables been classified as malicious or related to credential theft by a machine learning model?
  context: This question leverages a machine learning model to proactively classify unknown executables. By analyzing the features of a file, the model can predict its maliciousness even if its hash is not present in any threat intelligence feed, providing an early warning of a potential cookie theft attempt.
  answer_sources:
  - Windows Event ID 4688
  - Zeek files.log
  - User Workstations, Network Egress Points, Web Proxies
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: FOR each new executable hash from (EID 4688 OR Zeek files.log), SUBMIT to file_classification_ml_model. ALERT if classification is 'malicious' or 'credential_theft' AND confidence > 0.85.
- question: Are there any command-line executions or PowerShell scripts containing strings associated with known cookie theft tools or direct access to browser cookie storage?
  context: This question looks for explicit commands used by adversaries to steal cookies. By searching for specific tool names (e.g., 'sekurlsa::cookies') or file paths to cookie databases, analysts can find direct evidence of an attacker's actions on an endpoint.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - User Workstations, Terminal Servers, Developer Laptops
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH (EID 4688 command line OR EID 4104 script block) for regex matching ('sekurlsa::cookies', 'lazagne.exe browsers', '...\\Cookies'). ALERT on match.
- question: Have any command-line or PowerShell script executions exhibited unusually high entropy for a given user?
  context: Adversaries often use obfuscation (like Base64 encoding) to hide their malicious commands, which results in high-entropy strings. This question establishes a baseline of normal command complexity for each user and flags significant deviations, which can help detect obfuscated cookie theft scripts.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - User Workstations, Terminal Servers, Developer Laptops
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: FOR each user, CALCULATE baseline Shannon entropy of (EID 4688 command line AND EID 4104 script block). ALERT when new execution entropy > 98th percentile of user baseline.
- question: Has a machine learning model classified any command-line executions as malicious based on their structure and content?
  context: This question employs a machine learning classifier to analyze features of a command line (e.g., length, special characters, keywords) to predict its intent. This can catch novel or slightly modified attack commands that might evade simple string or regex matching.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - User Workstations, Terminal Servers, Developer Laptops
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: EXTRACT features from new command lines (EID 4688, EID 4104). SUBMIT to command_line_classifier_ml_model. ALERT if prediction is 'malicious' with high confidence.
- question: Has an unapproved process attempted to access a browser's cookie database files?
  context: This question enforces a strict access control policy on sensitive cookie store directories. By whitelisting known good processes (like the browsers themselves), any other process attempting to read these files is treated as a high-fidelity indicator of a cookie theft attempt.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4656
  - User Workstations, Virtual Desktop Infrastructure (VDI) instances
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: ENABLE SACLs on browser cookie directories. SEARCH (EID 4663 OR EID 4656) where object is a cookie file. ALERT if Process Name is NOT IN ('chrome.exe', 'firefox.exe', ...).
- question: Has the set of processes accessing cookie store files on a given host deviated significantly from its historical baseline?
  context: Instead of a static whitelist, this question creates a dynamic baseline of normal access patterns for each host. It can detect when a new, potentially malicious process starts accessing cookie files, even if that process is legitimate in other contexts. A low similarity score indicates a significant change worth investigating.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4656
  - User Workstations, Virtual Desktop Infrastructure (VDI) instances
  range: Last 30 days
  queries:
  - technology: pseudocode
    query: CREATE 30-day baseline of processes accessing cookie files per host. DAILY, compare current accessing processes to baseline using Jaccard similarity. ALERT if score < 0.8.
- question: Has a machine learning model identified any anomalous access events to browser cookie stores?
  context: This question uses an anomaly detection model (like a one-class SVM or isolation forest) trained on legitimate access patterns. The model learns what 'normal' access looks like based on features like process name, parent, user, and time. It then flags any new access that doesn't fit this learned profile, uncovering sophisticated or novel theft techniques.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4656
  - User Workstations, Virtual Desktop Infrastructure (VDI) instances
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: TRAIN one-class SVM model on benign cookie store access features. SCORE new access events (EID 4663, 4656) in real time. ALERT if event is flagged as an outlier.
- question: Has a non-standard process requested a high-privilege handle, such as for memory reading, to a running browser process?
  context: This question targets memory scraping techniques where an attacker's tool reads the memory of a browser process to extract session cookies. By monitoring for handle requests with powerful access rights (like 'PROCESS_VM_READ') from unexpected source processes, this can detect a direct attempt to steal credentials from memory.
  answer_sources:
  - Windows Event ID 4656
  - Windows Event ID 4688
  - User Workstations, Critical System Servers with browser access
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH EID 4656 where Object Name is a browser process. ALERT if Source Process Name is NOT a known system/security process AND AccessList contains 'PROCESS_VM_READ' or 'PROCESS_ALL_ACCESS'.
- question: Has there been a 'first-seen' handle request to a browser, or an anomalous rate of high-privilege requests on a host?
  context: This question uses two statistical methods to find suspicious handle requests. The 'first-seen' analysis flags when a process interacts with a browser for the first time ever in the environment. The rate analysis detects a sudden spike in high-privilege requests on a single host, which could indicate a tool attempting to scrape memory from multiple browser processes.
  answer_sources:
  - Windows Event ID 4656
  - Windows Event ID 4688
  - User Workstations, Critical System Servers with browser access
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: TRACK source-to-browser handle requests. ALERT on first-seen combination. Additionally, MONITOR rate of high-privilege requests per host. ALERT if rate > 3 standard deviations from daily average.
- question: Has the volume of memory read requests targeting browser processes significantly exceeded the forecasted volume?
  context: This question uses time series forecasting to model the normal rhythm of high-privilege requests to browsers. A significant, unexpected spike in this activity that deviates from the model's prediction can indicate a large-scale, automated memory scraping event that is out of character for normal system operations.
  answer_sources:
  - Windows Event ID 4656
  - Windows Event ID 4688
  - User Workstations, Critical System Servers with browser access
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: MODEL hourly volume of 'PROCESS_VM_READ' requests to browsers using a time series model (e.g., ARIMA). ALERT if observed volume exceeds the predicted upper confidence interval.
- question: Have any SSL/TLS connections to high-value websites used a certificate from an unexpected or unapproved Certificate Authority (CA)?
  context: This question is designed to detect Adversary-in-the-Middle (AitM) attacks. High-value services have a predictable set of CAs that issue their certificates. If a connection to one of these services presents a certificate from a different, untrusted CA, it is a critical sign that traffic is being intercepted.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Zeek ssl.log
  - Zeek dns.log
  - Network Egress Points, DNS Servers, VPN Concentrators
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: FOR connections to high-value domains, SEARCH Zeek ssl.log. ALERT if 'issuer' field is NOT IN whitelist of expected Certificate Authorities.
- question: Have any user sessions to high-value domains exhibited a rare JA3/JA3S fingerprint or an unusually large cookie header?
  context: This question looks for subtle signs of session hijacking or AitM. A JA3/JA3S fingerprint represents the client's TLS profile; a sudden change for a user can indicate a different client (e.g., an attacker's tool) is being used. An abnormally large cookie header could signify a session replay attack where an attacker is injecting a stolen cookie.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Zeek ssl.log
  - Zeek dns.log
  - Network Egress Points, DNS Servers, VPN Concentrators
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: BASELINE JA3/JA3S and cookie header length per user/domain. ALERT if new session has first-seen JA3/JA3S for that user/domain OR if cookie length > 99th percentile of historical distribution.
- question: Has a machine learning clustering model identified any anomalous user sessions to sensitive web applications?
  context: This question uses unsupervised machine learning to find sessions that don't conform to normal patterns. By clustering sessions based on multiple network features (IP, user-agent, JA3, cookie size, etc.), the model can identify outliers that represent anomalous activity which may correspond to AitM or session hijacking.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Zeek ssl.log
  - Zeek dns.log
  - Network Egress Points, DNS Servers, VPN Concentrators
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: CLUSTER web sessions using features from Zeek logs (IP, user-agent, JA3, cookie length, etc.). ALERT on sessions classified as noise or outliers.
- question: Has a browser process spawned a command shell or scripting interpreter as a child process?
  context: Web browsers should not normally launch command-line shells or script engines like PowerShell. Such an event strongly suggests that an exploit, malicious extension, or other compromise has occurred within the browser, leading to code execution on the host.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - User Workstations, Web Proxies, DNS Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: SEARCH EID 4688 where ParentProcessName is in ('chrome.exe', 'msedge.exe', ...) AND NewProcessName is in ('cmd.exe', 'powershell.exe', ...). ALERT on match.
- question: Have any statistically rare parent-child process relationships involving a browser been observed?
  context: This question looks for any parent-child relationship involving a browser that is highly unusual across the entire enterprise. This can uncover novel attack techniques where an attacker uses a less common or legitimate-looking utility as the child process to evade detection.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - User Workstations, Web Proxies, DNS Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: CALCULATE prevalence of all parent-child process relationships. ALERT if Parent is a browser AND prevalence < 0.1st percentile.
- question: Has a machine learning model classified any parent-child process relationships originating from a browser as malicious?
  context: This question uses a supervised learning model to automatically identify malicious process chains. The model is trained on known good and bad examples and can learn complex patterns, such as a browser spawning PowerShell with specific encoded commands, providing a more robust detection method.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - User Workstations, Web Proxies, DNS Servers
  range: Last 90 days
  queries:
  - technology: pseudocode
    query: EXTRACT features from parent-child events (parent name, child name, command line). SUBMIT to process_relationship_classifier_ml_model. ALERT if prediction is 'malicious'.