name: "T1614: System Location Discovery"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps identify if an adversary is attempting to discover the geographic location of systems on the network. This is often done to tailor attacks, avoid specific regions, or understand the environment they have compromised. Detection strategies include monitoring for connections to public IP geolocation services, execution of command-line utilities that query system locale or time zone, anomalous processes performing these actions, correlation of these discovery activities with suspicious outbound network connections, and queries to cloud instance metadata services for location information."
type: "technique"
related:
  - "TA0007: Discovery"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Is an internal host making a symbolic connection (DNS query or HTTP/S request) to a known public IP geolocation service?"
    context: "Adversaries use public geolocation services (e.g., ipinfo.io, ifconfig.me) to determine a compromised system's external IP address and physical location. This information helps them orient themselves, tailor subsequent attacks, or avoid targeting organizations in certain countries. This question focuses on detecting the most direct indicator: a connection from an internal host to a watchlist of known geolocation service domains."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network Egress Points"
      - "Internal DNS Resolvers"
      - "Egress Proxy Servers"
    range: "last 90 days"
    queries:
      - "SEARCH Zeek logs (dns, http, ssl) WHERE query OR host IN [geolocation_service_watchlist] AND source_ip IS internal"
  - question: "Is an internal host exhibiting a statistically unusual frequency of connections to public IP geolocation services compared to its baseline?"
    context: "While a single connection to a geolocation service might be benign user activity, a sudden increase in frequency can indicate an automated script or tool performing reconnaissance. This question aims to identify hosts that start checking their location far more often than they normally do, or more often than their peers, by comparing their activity against a historical baseline."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network Egress Points"
      - "Internal DNS Resolvers"
      - "Egress Proxy Servers"
    range: "last 90 days"
    queries:
      - "COMPARE hourly connection count to geolocation services AGAINST 30-day rolling baseline for host AND peer group. ALERT if count > 99th percentile."
  - question: "Can we use machine learning to determine if a connection to a geolocation service is malicious (e.g., script-initiated) rather than benign (e.g., browser-initiated)?"
    context: "To reduce false positives from legitimate user activity, this question applies a machine learning model to distinguish between benign and malicious connections. The model analyzes various network traffic features (e.g., user-agent, connection duration, data volume, SSL fingerprint) to classify the intent behind the connection, flagging those that appear automated or otherwise suspicious."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network Egress Points"
      - "Internal DNS Resolvers"
      - "Egress Proxy Servers"
    range: "last 90 days"
    queries:
      - "APPLY ML model to Zeek connection features (user-agent, duration, volume, JA3/JA3S). ALERT if classification is 'malicious' with high confidence."
  - question: "Has a command been executed to query the system's time zone, locale, or keyboard layout?"
    context: "Adversaries execute built-in commands like `tzutil /g`, `Get-TimeZone`, or `systeminfo` to gather information about the system's configuration. The time zone and language settings are strong indicators of the system's geographic location. This question looks for the execution of these specific commands in process execution logs."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Domain Controllers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - "SEARCH Windows Event ID 4688 logs WHERE ProcessCommandLine CONTAINS 'Get-Culture', 'Get-TimeZone', 'tzutil /g', etc. ANALYZE parent process for suspiciousness."
  - question: "Has a user or host exhibited a statistically unusual spike in the variety of system discovery commands being executed in a short time frame?"
    context: "A normal user rarely runs multiple different discovery commands in quick succession. A sudden burst of varied commands (e.g., checking time, then locale, then system info) is a strong indicator of an automated script or an adversary manually performing reconnaissance. This question aims to detect this abnormal sequencing by measuring the entropy of commands."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Domain Controllers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - "CALCULATE Shannon entropy of unique commands per user/host in a 10-min window. ALERT on sudden entropy spike."
  - question: "Can a sequence of commands executed by a user be classified as a malicious reconnaissance pattern using a machine learning model?"
    context: "This question moves beyond simple counts and analyzes the entire sequence of commands within a user session. By training a model (e.g., a Hidden Markov Model) on known benign and malicious command sequences, it can identify patterns of behavior characteristic of adversarial reconnaissance, even if individual commands seem benign in isolation."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Domain Controllers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - "APPLY sequence analysis model (e.g., HMM) to command-line logs for a user session. ALERT if session is classified as malicious reconnaissance."
  - question: "Has a location discovery command been executed by a non-standard process, such as a web server or a system service account?"
    context: "Server applications (e.g., sqlservr.exe, nginx.exe) and non-interactive system accounts (e.g., NT AUTHORITY\\SYSTEM) have no legitimate reason to query system location or locale information. Such activity is highly anomalous and strongly suggests that the process or account has been compromised and is being used for reconnaissance."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Privileged Access Workstations"
      - "Critical Servers"
    range: "last 90 days"
    queries:
      - "SEARCH Windows Event ID 4688 WHERE ProcessCommandLine contains discovery strings AND ParentProcess is a server app (sqlservr.exe, etc.) OR User is a system account."
  - question: "Is a user account executing location discovery commands at a statistically anomalous time, such as outside of normal business hours?"
    context: "Adversaries often operate after hours to avoid detection. This question establishes a baseline of normal activity for each user during and outside of business hours. A significant deviation from this baseline, such as a user suddenly running discovery commands late at night, is a strong indicator of account compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Privileged Access Workstations"
      - "Critical Servers"
    range: "last 90 days"
    queries:
      - "COMPARE hourly count of discovery commands AGAINST baseline for business vs. non-business hours. ALERT if count exceeds 3 standard deviations (Z-score > 3)."
  - question: "Can we identify hosts that are outliers based on their command-line execution patterns related to system discovery?"
    context: "This question uses unsupervised machine learning (e.g., clustering) to group similar hosts based on their command execution behavior. Hosts that don't fit into any group (outliers) or form a small, suspicious cluster (e.g., high discovery command usage) are flagged. This helps find compromised machines without relying on pre-existing signatures."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Privileged Access Workstations"
      - "Critical Servers"
    range: "last 90 days"
    queries:
      - "APPLY clustering algorithm (e.g., DBSCAN) to host command-line features. IDENTIFY and ALERT on outlier hosts or small, anomalous clusters."
  - question: "Did a host execute a location discovery command and then, within 5 minutes, connect to a known malicious or newly registered domain?"
    context: "This question looks for the classic 'recon followed by C2' pattern. The adversary discovers the system's location and then immediately communicates that information to a command-and-control server. Correlating the internal command with a subsequent external connection to a suspicious destination provides strong evidence of a compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Network Egress Points"
      - "User Workstations"
      - "Servers with Internet Access"
    range: "last 90 days"
    queries:
      - "JOIN Windows Event 4688 (with discovery commands) with Zeek conn.log (within 5 mins). ALERT if destination IP is on blocklist OR domain is newly registered."
  - question: "Does a host show a statistically significant increase in connections to new IP addresses immediately following the execution of location discovery commands?"
    context: "This question seeks a statistical link between reconnaissance and outbound connections, even if the destination is not on a known threat list. If a host's rate of connecting to new, unknown IPs spikes right after it runs discovery commands, it suggests that the discovered information is being exfiltrated to a newly provisioned C2 server."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Network Egress Points"
      - "User Workstations"
      - "Servers with Internet Access"
    range: "last 90 days"
    queries:
      - "COMPARE rate of connections to new IPs post-discovery-command with overall baseline rate. ALERT if post-discovery rate is > 3 standard deviations higher."
  - question: "Is there a strong time-series correlation between location discovery command events and outbound connections exhibiting C2-like characteristics on a given host?"
    context: "This advanced technique models two streams of activity over time: discovery commands and suspicious network traffic. By looking for a strong correlation where the network traffic consistently follows the discovery commands by a short delay, it can identify automated toolkits that perform reconnaissance and then call home to a C2 server."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Network Egress Points"
      - "User Workstations"
      - "Servers with Internet Access"
    range: "last 90 days"
    queries:
      - "ANALYZE cross-correlation between time series of discovery commands and time series of outbound connections with C2 features. ALERT on strong positive correlation with short lag."
  - question: "Has an unapproved process on a cloud instance queried the metadata service for location-specific information?"
    context: "Cloud metadata services provide information about an instance, including its region or availability zone. While legitimate cloud tools use this, access from unexpected processes (like a reverse shell) or specific requests for location data are highly suspicious and indicate an adversary is trying to orient themselves within the cloud environment."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Cloud Compute Instances (e.g., AWS EC2, Azure VM)"
      - "Cloud Network Flow Logs"
    range: "last 90 days"
    queries:
      - "SEARCH network logs for connections to 169.254.169.254. ALERT if process is not whitelisted OR if HTTP path requests location data (e.g., /placement/region)."
  - question: "Has a cloud instance accessed the metadata service with a statistically unusual frequency or requested paths not typical for its role?"
    context: "Different types of cloud instances (e.g., web servers, databases) have predictable patterns of interacting with the metadata service. This question establishes a baseline for each instance role and flags any instance that deviates, such as accessing the service more often than its peers or requesting unusual data like its location, which could indicate compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Cloud Compute Instances (e.g., AWS EC2, Azure VM)"
      - "Cloud Network Flow Logs"
    range: "last 90 days"
    queries:
      - "COMPARE hourly metadata access count/variety against baseline for instance role. ALERT if count > 99th percentile or if a new path is accessed."
  - question: "Can machine learning classify a metadata service access request as malicious based on its context?"
    context: "This question uses a classifier to make a sophisticated judgment about a metadata access request. By considering features like the process that made the request, its command line, and the time since the instance was launched, it can distinguish legitimate startup scripts from malicious queries made by a post-exploitation tool."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Cloud Compute Instances (e.g., AWS EC2, Azure VM)"
      - "Cloud Network Flow Logs"
    range: "last 90 days"
    queries:
      - "APPLY ML model to metadata request features (URI, user-agent, parent process). ALERT if classification is 'anomalous' or 'malicious' with high confidence."