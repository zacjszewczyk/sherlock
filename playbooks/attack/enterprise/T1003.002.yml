name: T1003.002: Security Account Manager
id: 5a9b8c7d-6e5f-4a3b-2c1d-0e9f8a7b6c5d
description: This playbook helps investigate attempts by an adversary to access credentials stored in the Security Account Manager (SAM) database. This involves looking for the execution of known credential dumping tools, the misuse of system utilities to copy or save the SAM and SYSTEM registry hives, direct file access to the SAM database file by unauthorized processes, unauthorized process memory access to LSASS, and direct access to the HKLM\SAM or HKLM\SYSTEM registry hives by non-whitelisted processes.
type: technique
related:
  - TA0006: Credential Access
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any processes been created that match the name or file hash of known credential dumping tools?
    context: This question looks for direct evidence of credential dumping by checking for the execution of known malicious tools like Mimikatz or gsecdump. Detecting their execution via process names or file hashes from a curated threat intelligence list is a high-fidelity indicator of an active credential access attempt.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Command-line and process execution logs on critical assets like Domain Controllers, Tier 0/1 Servers, and Administrator Workstations.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_logs WHERE process_name IN known_dumper_tools_list OR process_hash IN known_dumper_hashes_list
  - question: Has a process been executed with an unusually random name, especially from a common parent process?
    context: Adversaries may randomize tool names to evade simple signature-based detection. This question attempts to find such tools by calculating the Shannon entropy of new process names and comparing it to a baseline. A high entropy score, especially for a process spawned by a common parent like explorer.exe from a temporary directory, suggests a potentially obfuscated malicious tool.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Command-line and process execution logs on critical assets like Domain Controllers, Tier 0/1 Servers, and Administrator Workstations.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ANALYZE process_creation_logs, CALCULATE shannon_entropy(process_name), ALERT if entropy > 99th_percentile_for_parent_process
  - question: Have any newly executed processes been classified as a credential dumper by a machine learning model?
    context: This question leverages a machine learning model trained on process execution features (e.g., parent process, command-line arguments, entropy) to classify new processes. This provides a more sophisticated detection method that can identify novel or heavily obfuscated dumping tools that may be missed by symbolic and statistical methods.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Command-line and process execution logs on critical assets like Domain Controllers, Tier 0/1 Servers, and Administrator Workstations.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR new_process_event, PREDICT classification using random_forest_model. ALERT if classification == 'credential_dumper' with high_confidence
  - question: Have system utilities like reg.exe, vssadmin.exe, or ntdsutil.exe been used with command-line arguments indicative of dumping the SAM or SYSTEM hives?
    context: Adversaries often live off the land, using legitimate system utilities for malicious purposes. This question looks for specific command-line patterns, such as 'reg.exe save hklm\sam' or 'vssadmin.exe create shadow', which are commonly used to create copies of credential stores for offline cracking.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Command-line and process execution logs on critical assets, particularly Domain Controllers and Tier 0 Servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_logs for command_line MATCHES regex_patterns_for_hive_dumping
  - question: Has there been an unusual frequency in the execution of system utilities (reg.exe, vssadmin.exe, ntdsutil.exe) with suspicious arguments?
    context: While a single execution of a backup utility might be normal, a sudden spike in their usage, especially outside of normal backup windows, can indicate malicious activity. This question establishes a baseline for the execution frequency of these tools and alerts when a host significantly exceeds its normal behavior.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Command-line and process execution logs on critical assets, particularly Domain Controllers and Tier 0 Servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: COUNT executions of system_utilities_with_suspicious_args per host over 24h. ALERT if count > 95th_percentile_baseline
  - question: Has a time-series anomaly been detected in the hourly count of 'vssadmin create shadow' commands across the environment?
    context: The creation of volume shadow copies is often a precursor to credential dumping. This activity typically follows a predictable weekly pattern tied to backup schedules. This question applies a time-series model to detect significant, unexplained spikes in shadow copy creation that deviate from this seasonal pattern, indicating a potential attack.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Command-line and process execution logs on critical assets, particularly Domain Controllers and Tier 0 Servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY Seasonal-ARIMA model to hourly_count('vssadmin create shadow'). ALERT on significant positive anomaly
  - question: Has the SAM database file been accessed by a process not on an established whitelist?
    context: Direct access to the SAM file (%SystemRoot%\system32\config\SAM) is highly restricted. This question uses a tightly controlled whitelist of legitimate system processes (like lsass.exe) and approved backup agents. Any access from a process not on this list is a high-confidence indicator of a credential access attempt.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 11 (Sysmon)
      - File system audit logs on Domain Controllers and Tier 0 Servers, specifically monitoring the %SystemRoot%\system32\config\ directory.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH file_access_logs WHERE target_file == 'SAM' and process_name NOT IN sam_access_whitelist
  - question: Has a statistically rare process accessed the SAM database file?
    context: Instead of a rigid whitelist, this question identifies anomalous access by looking for processes that have historically never, or very rarely, accessed the SAM file. By building a frequency distribution of accessing processes, any process in the lowest percentile is flagged as suspicious, potentially identifying a novel tool or a legitimate but compromised process.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 11 (Sysmon)
      - File system audit logs on Domain Controllers and Tier 0 Servers, specifically monitoring the %SystemRoot%\system32\config\ directory.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ANALYZE file_access_logs to 'SAM', CALCULATE process_name_frequency. ALERT if process_frequency is in bottom 1st percentile
  - question: Has an unsupervised machine learning model flagged any access events to the SAM file as anomalous?
    context: This question uses an unsupervised model (like Isolation Forest) to learn the multi-dimensional profile of normal access to the SAM file, considering features like process, user, host, and time of day. It can detect sophisticated attacks that subtly deviate from normalcy, which might be missed by rules based on a single feature.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 11 (Sysmon)
      - File system audit logs on Domain Controllers and Tier 0 Servers, specifically monitoring the %SystemRoot%\system32\config\ directory.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR new_sam_access_event, CALCULATE anomaly_score using isolation_forest_model. ALERT if score is high
  - question: Has an unauthorized process requested a handle to the LSASS process with memory read permissions?
    context: The Local Security Authority Subsystem Service (LSASS) stores credentials in memory. Adversaries use tools to access this process memory and dump credentials. This question monitors for process access events (Sysmon Event ID 10) where a non-whitelisted process attempts to read from lsass.exe, a classic credential dumping technique.
    answer_sources:
      - Windows Event ID 10 (Sysmon)
      - Process memory access logs on critical assets like Domain Controllers, Tier 0/1 Servers, and Administrator Workstations.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_access_logs WHERE target_process == 'lsass.exe' AND source_process NOT IN lsass_access_whitelist AND access_mask INCLUDES 'PROCESS_VM_READ'
  - question: Has a process that rarely accesses LSASS suddenly attempted to do so?
    context: This question establishes a baseline of normal process interactions with LSASS. An alert is triggered if a process that has historically never or rarely accessed LSASS suddenly requests a handle. This statistical approach can detect when a legitimate process is compromised and used to dump credentials, or when a novel malicious tool is introduced.
    answer_sources:
      - Windows Event ID 10 (Sysmon)
      - Process memory access logs on critical assets like Domain Controllers, Tier 0/1 Servers, and Administrator Workstations.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ANALYZE lsass_access_history. ALERT if a source_process with low historical access frequency attempts access
  - question: Has a process attempted to access LSASS that does not belong to a normal cluster of interacting processes?
    context: This question models normal system behavior as a graph of process interactions. By identifying established 'communities' of processes that normally interact with LSASS, any new process attempting to connect to the LSASS node from outside these communities can be flagged as a high-confidence anomaly, indicative of an attack.
    answer_sources:
      - Windows Event ID 10 (Sysmon)
      - Process memory access logs on critical assets like Domain Controllers, Tier 0/1 Servers, and Administrator Workstations.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MODEL process interactions as a graph. USE community detection. ALERT if a process outside normal LSASS community connects to LSASS node
  - question: Has a non-whitelisted process accessed the HKLM\SAM or HKLM\SYSTEM registry hives?
    context: Similar to direct file access, adversaries may try to access the SAM and SYSTEM hives directly through the registry. This question uses auditing and a whitelist of legitimate processes to detect any unauthorized process creating, reading, or modifying these critical registry keys, which is highly indicative of a credential access attempt.
    answer_sources:
      - Windows Event ID 4656
      - Windows Event ID 12 (Sysmon)
      - Windows Event ID 13 (Sysmon)
      - Windows Registry audit logs on Domain Controllers, Tier 0/1 Servers, and Administrator Workstations, specifically monitoring the HKLM\SAM and HKLM\SYSTEM hives.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH registry_access_logs WHERE target_key CONTAINS 'HKLM\SAM' OR 'HKLM\SYSTEM' and process_name NOT IN registry_access_whitelist
  - question: Has there been a statistically significant spike in the rate of access to the HKLM\SAM registry hive by any single process?
    context: A brute-force or enumeration attempt against the SAM hive might manifest as a rapid succession of access events from a single process. This question calculates a Z-score for the access count over a short, rolling time window, allowing it to detect a statistically significant and anomalous burst of activity from any process.
    answer_sources:
      - Windows Event ID 4656
      - Windows Event ID 12 (Sysmon)
      - Windows Event ID 13 (Sysmon)
      - Windows Registry audit logs on Domain Controllers, Tier 0/1 Servers, and Administrator Workstations, specifically monitoring the HKLM\SAM and HKLM\SYSTEM hives.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each process, CALCULATE Z-score of HKLM\SAM access count over 5-min window. ALERT if Z-score > 3.0
  - question: Has an anomalous sequence of user or process actions led to access of the SAM or SYSTEM registry hives?
    context: Credential dumping is often part of a larger chain of actions. This question uses a sequence analysis model (like a Hidden Markov Model) to learn legitimate sequences of events that lead to registry access. An unusual sequence, such as a web server spawning a shell that then accesses the SAM hive, would be flagged as a low-probability, malicious event.
    answer_sources:
      - Windows Event ID 4656
      - Windows Event ID 12 (Sysmon)
      - Windows Event ID 13 (Sysmon)
      - Windows Registry audit logs on Domain Controllers, Tier 0/1 Servers, and Administrator Workstations, specifically monitoring the HKLM\SAM and HKLM\SYSTEM hives.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ANALYZE sequence of events leading to registry access using HMM. ALERT if sequence has low probability score