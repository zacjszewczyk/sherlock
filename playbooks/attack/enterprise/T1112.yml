name: T1112: Modify Registry
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate if an adversary is maintaining persistence or evading defenses by modifying the Windows Registry. Adversaries may modify registry keys to execute malicious code on system startup, disable security controls, or store malicious data. This playbook looks for modifications to known persistence locations (e.g., Run keys), the use of reg.exe to add or import malicious entries, modifications by unusual processes, remote registry modifications from unauthorized sources, the disabling of security software keys (e.g., Windows Defender, AMSI), the storage of large or high-entropy binary data, and rapid, successive modifications to multiple security-related keys by a single process.
type: technique
related:
  - TA0003: Persistence
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a known persistence-related registry key being modified with a value that matches a known indicator of compromise from threat intelligence?
    context: This question provides a high-fidelity method for detecting known threats. It directly correlates a modification to a sensitive registry location used for persistence (like Run or RunOnce keys) with a value (e.g., file path, command) that is present in an active threat intelligence feed. A match is a strong indicator of a successful persistence attempt using a recognized malicious artifact.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Threat Intelligence Feed of malicious file paths, commands, or CLSIDs
      - Applicable to: Windows endpoints, Windows servers, Domain Controllers, Application servers
    range: last 90 days
    queries:
      - "SIEM Pseudocode: SEARCH Windows Event ID 4657 WHERE (RegistryKeyPath IN [PersistenceKeysList]) AND (NewValue IN [ThreatIntelFeed])"
  - question: Has a process made a statistically rare modification to a known persistence registry key on a specific host?
    context: This question aims to detect novel or unusual persistence attempts that do not rely on known-bad indicators. By establishing a baseline of normal (process, registry key) modification pairs on a per-host basis, analysts can be alerted to activity that deviates from established patterns. A rare modification, even from a legitimate process, could indicate process abuse or a new, undocumented technique.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: Windows endpoints, Windows servers, Domain Controllers, Application servers
    range: last 90 days
    queries:
      - "Analytic Pseudocode: For each host, calculate 30-day frequency of (Process, RegistryKey) pairs. ALERT if a new modification to a persistence key results in a pair with a frequency in the bottom 1st percentile."
  - question: Does a machine learning model classify a modification to a persistence registry key as malicious based on its contextual features?
    context: This question leverages a sophisticated machine learning model to evaluate registry modifications. Instead of relying on simple rules, a model can analyze multiple features simultaneously (e.g., process name, parent process, command line, key path, value length, value entropy) to identify complex malicious patterns that might otherwise be missed. A high-confidence prediction from a well-trained model serves as a strong signal of malicious activity.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: Windows endpoints, Windows servers, Domain Controllers, Application servers
    range: last 90 days
    queries:
      - "ML Pseudocode: INPUT registry modification event features (ProcessName, ParentProcess, CommandLine, KeyPath, ValueLength, ValueEntropy) into a trained Random Forest model. ALERT if malicious prediction probability > 0.85."
  - question: Is the reg.exe utility being used to add or import data into a persistence key, or is its command line obfuscated?
    context: This question targets the direct use of a native Windows utility, reg.exe, for malicious purposes. Adversaries often use `reg.exe add` or `reg.exe import` to create or modify persistence keys. The query also checks for common obfuscation techniques, such as embedded null characters, which are used to hide the true key path from simple detection rules.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Applicable to: User workstations, Windows servers, Development environments
    range: last 90 days
    queries:
      - "SIEM Pseudocode: SEARCH Process Creation Events WHERE (ProcessName ends with 'reg.exe') AND (CommandLine contains 'add' OR 'import') AND (CommandLine targets a persistence key OR CommandLine matches regex for obfuscation)."
  - question: Is a reg.exe command execution anomalous based on the length or entropy of its command line?
    context: This question seeks to identify malicious `reg.exe` usage by focusing on statistical outliers. Adversaries may use long, complex, or obfuscated command lines to execute their payload in a single command. By baselining the typical length and Shannon entropy of `reg.exe` commands, we can flag executions that are statistically unusual and therefore suspicious.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Applicable to: User workstations, Windows servers, Development environments
    range: last 90 days
    queries:
      - "Analytic Pseudocode: For all 'reg.exe' executions, calculate command line length and entropy. Maintain a 30-day rolling baseline. ALERT if a new execution's length or entropy exceeds the 98th percentile."
  - question: Does a sequence of host events indicate a 'download and execute' pattern involving a registry modification?
    context: This question attempts to identify a common attack chain. Adversaries often download a malicious tool or script and then create a registry key to execute it for persistence. By using a sequence-based model (like an LSTM), we can detect this specific pattern of [network download -> registry modification] occurring in a short time frame, which is highly indicative of malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Windows Event ID 4657
      - Applicable to: User workstations, Windows servers, Development environments
    range: last 90 days
    queries:
      - "ML Pseudocode: INPUT time-ordered event sequences (process creation, network connection, registry mod) into an LSTM autoencoder. ALERT on sequences with high reconstruction error, especially those matching a [download -> reg.exe add] pattern within 5 minutes."
  - question: Is a process that is not an approved installer or system tool modifying a persistence-related registry key?
    context: This question enforces a policy of least privilege for registry modifications. Normal software installations and system updates are performed by a predictable set of processes (e.g., `msiexec.exe`, `svchost.exe`). A modification to a persistence key by an unexpected process, such as a web browser or office application, is highly suspicious and could indicate code execution from a malicious document or exploit.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: User workstations, Virtual Desktop Infrastructure (VDI) instances, Critical application servers
    range: last 90 days
    queries:
      - "SIEM Pseudocode: CORRELATE Registry Modification (Event 4657) with Process Creation (Event 4688). ALERT if the modifying process is NOT IN [ApprovedProcessList] AND the target key is a persistence key."
  - question: Has a statistically rare process modified a persistence key on a given host?
    context: This question uses host-level behavioral analysis to find anomalies. While a process might be common enterprise-wide, its activity on a specific host might be rare. By calculating a rarity score for processes that modify persistence keys on each host, we can identify when a process performs an action that is out of character for that specific system, which could signal a compromise.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: User workstations, Virtual Desktop Infrastructure (VDI) instances, Critical application servers
    range: last 90 days
    queries:
      - "Analytic Pseudocode: For each host, calculate a rarity score for each process that modifies a persistence key based on historical frequency. ALERT if the score for a new modification exceeds a defined threshold (e.g., top 5%)."
  - question: Does a machine learning model identify an anomalous (process, registry key) modification pair based on enterprise-wide activity?
    context: This question uses an unsupervised machine learning model (Isolation Forest) to detect outliers against a baseline of normal behavior across the entire enterprise. The model learns what legitimate (process, key) modification pairs look like. Any pair that the model flags as an anomaly is suspicious because it does not conform to the established patterns of legitimate activity seen across the organization.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: User workstations, Virtual Desktop Infrastructure (VDI) instances, Critical application servers
    range: last 90 days
    queries:
      - "ML Pseudocode: INPUT (ProcessName, TargetRegistryKey) pair into a trained Isolation Forest model. ALERT if the model flags the pair as an outlier/anomaly."
  - question: Is a remote registry modification to a persistence key originating from a non-administrative user or workstation?
    context: This question focuses on securing against lateral movement and unauthorized remote administration. Remote registry modifications are powerful and should only be performed from specific administrative workstations by authorized users. This rule correlates network and host events to verify that any remote modification to a sensitive key originates from an approved source IP and is performed by an administrative account.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 5145
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Applicable to: Domain Controllers, File Servers, Internal network segments (East-West traffic), VPN gateways
    range: last 90 days
    queries:
      - "SIEM Pseudocode: CORRELATE Remote Registry Network Event (Zeek dce_rpc 'winreg' or Event 5145) with Registry Modification (Event 4657) and Logon (Event 4624). ALERT if SourceIP or User is NOT IN [AdminList]."
  - question: Is a server experiencing a remote registry modification from a new or infrequent (source IP, user account) pair?
    context: This question uses behavioral baselining for remote access. By tracking which users and IP addresses typically perform remote registry modifications on each server, we can detect novel or rare access patterns. An alert for a brand-new (source, user) pair or a pair that acts very infrequently is a strong indicator of suspicious lateral movement or unauthorized access.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 5145
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Applicable to: Domain Controllers, File Servers, Internal network segments (East-West traffic), VPN gateways
    range: last 90 days
    queries:
      - "Analytic Pseudocode: For each server, baseline (SourceIP, User) tuples performing remote registry mods. ALERT if a new modification comes from a never-before-seen tuple or a tuple in the lowest 5th percentile of frequency."
  - question: Does a remote registry modification represent a connection between previously disconnected groups of users and hosts?
    context: This question applies graph analytics to detect anomalous lateral movement. By modeling users and hosts as a network graph, we can identify normal clusters of activity (e.g., an 'IT Admins' cluster interacting with 'Domain Controllers'). A remote registry operation that creates a link between two previously separate clusters (e.g., a user from a 'Marketing' cluster modifying a key on a server in the 'IT Admins' cluster) is highly anomalous and suspicious.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 5145
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Applicable to: Domain Controllers, File Servers, Internal network segments (East-West traffic), VPN gateways
    range: last 90 days
    queries:
      - "Graph Analytic Pseudocode: Model users and hosts as nodes and remote registry ops as edges. Apply community detection. ALERT when a new edge bridges two previously disconnected communities."
  - question: Has a critical security registry key been modified or deleted to an insecure state?
    context: This question provides a direct, high-confidence check for defense evasion. It involves monitoring a specific list of registry keys that control security tools (like antivirus or EDR). Any modification that disables or weakens these controls (e.g., setting `DisableAntiSpyware` to 1) or deletes the key entirely is a critical event that requires immediate investigation, as it is a common precursor to further malicious activity.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4660
      - Windows Event ID 4688
      - Applicable to: All Windows endpoints and servers with security software (AV/EDR) installed.
    range: last 90 days
    queries:
      - "SIEM Pseudocode: SEARCH Registry Modification (Event 4657) or Deletion (Event 4660) WHERE TargetKey IN [CriticalSecurityKeysList] AND (NewValue IN [InsecureValuesList] OR event is deletion)."
  - question: Has the percentage of hosts with insecure security settings increased significantly across the environment?
    context: This question aims to detect widespread, coordinated tampering campaigns rather than single-host incidents. By baselining the daily state of critical security keys across all hosts, a sudden, statistically significant increase in the number of non-compliant machines can indicate a large-scale attack, such as one spread by a worm or a GPO misconfiguration.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4660
      - Windows Event ID 4688
      - Applicable to: All Windows endpoints and servers with security software (AV/EDR) installed.
    range: last 90 days
    queries:
      - "Analytic Pseudocode: Daily, baseline the percentage of hosts with insecure security key settings. ALERT if the daily percentage increases by > 3 standard deviations from the 30-day mean."
  - question: Does a machine learning model classify a modification to a security key as malicious?
    context: This question uses a specialized machine learning model to distinguish between legitimate administrative changes (e.g., via GPO) and malicious tampering of security keys. The model considers contextual features like the modifying process and its command line to make an informed decision, reducing false positives from legitimate changes while accurately identifying malicious attempts to disable defenses.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4660
      - Windows Event ID 4688
      - Applicable to: All Windows endpoints and servers with security software (AV/EDR) installed.
    range: last 90 days
    queries:
      - "ML Pseudocode: INPUT security key modification event features into a trained Gradient Boosting model. ALERT if malicious prediction probability > 0.9."
  - question: Has a large binary value been written to a non-standard registry key?
    context: This question targets the technique of storing malicious code or data directly in the registry. Adversaries may do this to create a fileless payload. This rule looks for the creation of `REG_BINARY` values that are unusually large and not in a location where such data is expected, which is a strong indicator of a payload being staged in the registry.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: All Windows hosts, especially those with PowerShell or scripting engines enabled.
    range: last 90 days
    queries:
      - "SIEM Pseudocode: SEARCH Registry Modification (Event 4657) WHERE (ValueType is 'REG_BINARY') AND (ValueSize > 4096 bytes) AND (TargetKey NOT IN [AllowedBinaryKeysList])."
  - question: Has a registry value been modified with data that has high entropy?
    context: This question seeks to identify encrypted or compressed data hidden in the registry. Malicious payloads are often packed or encrypted to evade signature-based detection. This results in high Shannon entropy (a measure of randomness). By calculating the entropy of all new registry values and alerting on those that are unusually high, we can detect potential hidden payloads regardless of their specific content.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: All Windows hosts, especially those with PowerShell or scripting engines enabled.
    range: last 90 days
    queries:
      - "Analytic Pseudocode: For all registry modifications, calculate Shannon entropy of the new value. ALERT if entropy > 7.5 OR if entropy is in the 99th percentile for its key group."
  - question: Does a machine learning model predict that a binary registry value contains a malicious payload?
    context: This question uses a specialized machine learning model to analyze the raw content of binary registry values. By training on features like size, entropy, and byte frequency distribution from known good and bad samples, the model can learn to distinguish benign binary data from malicious payloads, providing a sophisticated method for detecting fileless malware stored in the registry.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4688
      - Applicable to: All Windows hosts, especially those with PowerShell or scripting engines enabled.
    range: last 90 days
    queries:
      - "ML Pseudocode: INPUT binary registry value features (size, entropy, byte histogram) into a trained classifier. ALERT if the model predicts the value is a malicious payload."
  - question: Has a single process rapidly modified or deleted multiple security or logging-related registry keys?
    context: This question identifies a common defense evasion pattern where an adversary's script or tool quickly disables multiple security controls at once. A single process modifying or deleting several critical keys (e.g., for AV, EDR, and event logging) in a short time window (e.g., under 60 seconds) is highly indicative of a malicious, automated tampering script.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4660
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Applicable to: All Windows endpoints and servers, especially those with privileged access or hosting critical applications.
    range: last 90 days
    queries:
      - "SIEM Pseudocode: COUNT distinct security/logging keys modified/deleted by the same ProcessID on the same Host within a 60-second window. ALERT if count >= 3."
  - question: Is a host experiencing a statistically significant burst of modifications to security-related registry keys?
    context: This question uses dynamic, per-host baselining to detect an unusual volume of security-related registry changes. Instead of a fixed threshold, it compares the current rate of modifications to the host's own recent history. A sudden spike that is several standard deviations above the norm indicates an anomalous burst of activity that warrants investigation, even if the total number of changes is low.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4660
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Applicable to: All Windows endpoints and servers, especially those with privileged access or hosting critical applications.
    range: last 90 days
    queries:
      - "Analytic Pseudocode: For each host, maintain a 7-day moving average and standard deviation of 1-minute counts of security key modifications. ALERT if the current count exceeds the average by > 4 standard deviations."
  - question: Does a sequence of multi-source events indicate a 'tamper and C2' pattern?
    context: This question looks for a more complex attack chain by correlating host and network events. An adversary might first disable security controls (registry modifications), then establish a connection to a command-and-control server. A sequence-based model trained on benign activity can detect this anomalous pattern of [Multiple Security Registry Mods -> New DNS Query -> External Network Connection] as a high-reconstruction-error event, signaling a sophisticated attack.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4660
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek dns.log
      - Applicable to: All Windows endpoints and servers, especially those with privileged access or hosting critical applications.
    range: last 90 days
    queries:
      - "ML Pseudocode: INPUT multi-source event streams into an LSTM autoencoder. ALERT on sequences with high reconstruction error, especially those matching the [Process -> Multi-Reg-Mod -> DNS -> Conn] pattern."