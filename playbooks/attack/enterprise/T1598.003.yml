name: T1598.003: Spearphishing Link
id: c8a9f5d6-0e7f-4b1a-8c3d-9e0f1a2b3c4d
description: This playbook addresses the threat of adversaries performing reconnaissance by sending spearphishing links. The goal is to detect various stages and indicators of this technique, from the initial click to potential data exfiltration. Investigative context includes identifying connections to known malicious domains from threat intelligence, detecting URLs with phishing characteristics like typosquatting or obfuscation, and spotting statistical anomalies such as a sudden spike in connections from multiple endpoints to a new domain. It also covers looking for HTTP POST requests to suspicious sites, which could indicate credential submission, and identifying tracking pixels used to validate email receipt. Further, the playbook helps investigate phishing attempts targeting mobile devices (e.g., via QR codes) and anomalous process behavior on endpoints (e.g., Browser-in-the-Browser attacks) that may follow a successful phish.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are internal hosts communicating with domains, IPs, or URLs known to be associated with phishing or reconnaissance based on threat intelligence?
    context: This question aims to identify direct communication with known malicious infrastructure. Correlating network logs against a high-confidence threat intelligence feed is a fundamental detection method for catching spearphishing clicks. A match provides a strong signal that a user has interacted with a malicious link.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Zeek http.log
      - Network egress points (e.g., Firewalls, Web Proxies)
      - Internal DNS Resolvers
      - Mail Gateway
      - Threat Intelligence Feed
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH Zeek logs (dns, conn, http) for domain, dest_ip, http_host
          JOIN results with Threat_Intelligence_Feed on indicators
          WHERE a match is found
          RETURN time, src_ip, dest_ip, domain, user, matched_indicator
  - question: Are any specific users or departments showing a statistically significant higher rate of interaction with known malicious infrastructure compared to the rest of the organization?
    context: This question moves beyond single alerts to identify patterns of targeting. A user or department with an unusually high rate of threat intelligence hits might be the focus of a concentrated spearphishing campaign. Detecting this allows for proactive intervention, such as targeted user awareness training or enhanced monitoring for that group.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Zeek http.log
      - Threat Intelligence Feed
      - HR/Identity Data
    range: last 30 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE threat_intel_hits_per_user over a 30-day window
          CALCULATE 95th percentile threshold for the organization's hit rate
          FIND users where hit_rate > threshold
          RETURN user, department, hit_count, threshold
  - question: Can machine learning models predictively identify outbound connections that are likely malicious, even if they don't match known threat intelligence?
    context: This question addresses the detection of novel or zero-day phishing infrastructure not yet present in threat feeds. By training a model on the characteristics of known good and bad connections (e.g., duration, data volume, user agent), we can develop a predictive capability to score new, unknown connections in real-time.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Labeled training data
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each new outbound connection
          EXTRACT features (duration, bytes_transferred, user_agent, etc.)
          APPLY trained classification model to score the connection
          IF score > high_probability_threshold
            ALERT on connection with src_ip, dest_ip, score
  - question: Are users accessing URLs that contain structural patterns or keywords commonly associated with phishing, such as obfuscation or credential-related terms?
    context: This question focuses on detecting phishing attempts by analyzing the structure of the URL itself. Adversaries often craft URLs with specific keywords ('login', 'verify') or use obfuscation techniques (like the '@' symbol) to trick users. Detecting these patterns can uncover phishing sites that are too new to be on intelligence lists.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Internal DNS Resolvers
      - Web Proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH Zeek logs (dns, http) for requested URLs and hosts
          APPLY regex for URL obfuscation (e.g., '@' in host)
          APPLY regex for keywords ('login', 'verify') in non-corporate domains
          RETURN suspicious URLs, src_ip, user
  - question: Can we detect potential phishing domains by identifying those with high character randomness or those that are typosquatted versions of legitimate domains?
    context: This question uses statistical properties of domain names for detection. High entropy (randomness) is common in domains generated by algorithms (DGAs), while a small Levenshtein distance (edit distance) to a known good domain can indicate typosquatting. These methods help find suspicious domains without prior knowledge.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - List of legitimate company/partner domains
    range: last 30 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE Shannon entropy for all requested subdomains/paths
          CALCULATE Levenshtein distance between requested domains and known good domains
          FLAG domains with entropy > 99th percentile OR low Levenshtein distance
          RETURN flagged_domain, src_ip, reason (entropy/typosquat)
  - question: Can an unsupervised machine learning model identify anomalous URLs that may indicate phishing?
    context: This question leverages unsupervised learning to find outliers in URL structures without needing pre-labeled data. By modeling the features of legitimate URLs (length, character types, entropy), an Isolation Forest or similar model can flag URLs that deviate significantly from the norm, pointing to potentially malicious, algorithmically generated, or obfuscated links.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          EXTRACT features (length, entropy, keyword_count) from all requested URLs
          TRAIN an Isolation Forest model on the feature set
          IDENTIFY URLs that the model flags as anomalies/outliers
          RETURN anomalous_url, src_ip, anomaly_score
  - question: Are multiple internal hosts making connections to a newly registered domain within a short time frame?
    context: This is a classic indicator of a coordinated spearphishing campaign where multiple recipients click a link around the same time. A domain registered very recently that suddenly receives traffic from many distinct internal hosts is highly suspicious and warrants immediate investigation.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - WHOIS data
    range: last 30 days
    queries:
      - technology: pseudocode
        query: |
          IDENTIFY domains not seen in the last 30 days
          PERFORM WHOIS lookup to find registration date
          IF domain registered < 30 days ago AND receives connections from > 5 unique hosts in 1 hour
            ALERT on domain, count of hosts, and list of hosts
  - question: Are there statistically significant spikes in the number of unique internal hosts connecting to any single external domain?
    context: This question aims to detect a sudden convergence of traffic towards a single destination, which is characteristic of a successful phishing campaign. By monitoring the number of unique clients per domain in short time windows, we can spot abnormal flocking behavior that deviates from the baseline.
    answer_sources:
      - Zeek conn.log
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each 5-minute window
          CALCULATE unique source IPs per destination domain
          CALCULATE mean and standard deviation of unique sources across all domains
          IF source_count for a domain > (mean + 3 * std_dev)
            ALERT on domain, source_count
  - question: Can a time-series model predict and detect anomalous spikes in request volume to specific domains?
    context: This question applies predictive analytics to network traffic. By establishing a normal traffic pattern (a time-series forecast) for destination domains, a model like ARIMA can detect significant positive deviations. Such a deviation indicates a sudden, unexpected surge in traffic, a strong signal of a coordinated event like mass phishing click-throughs.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each destination domain
          TRAIN time-series model (e.g., ARIMA) on historical request volume
          PREDICT expected request volume for current time window
          IF observed_volume >> predicted_volume
            ALERT on domain, observed_volume, predicted_volume
  - question: Are users submitting data via HTTP POST requests to external domains that are malicious, un-vetted, or not on an explicit allow-list?
    context: This question targets the critical moment of credential or data theft. An HTTP POST to an external site is how form data is submitted. By restricting such submissions to an allow-list of approved business partners and correlating against threat intelligence, we can detect potential exfiltration of sensitive information to phishing sites.
    answer_sources:
      - Zeek http.log
      - Threat Intelligence Feed
      - Organizational allow-list for POST submissions
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FILTER Zeek http.log for method = 'POST' and external destination
          CHECK destination against Threat_Intel and POST_Allow_List
          IF destination is on threat_intel OR NOT on allow_list
            ALERT on src_ip, destination, url
  - question: Are there any HTTP POST requests being sent to extremely rare or never-before-seen external domains?
    context: This statistical approach helps find credential theft to novel phishing sites. Legitimate POST submissions typically go to a relatively stable set of partner or service domains. A POST directed to a domain that has never, or very rarely, received one from the organization is a strong anomaly indicative of a user submitting data to an unfamiliar, potentially malicious, site.
    answer_sources:
      - Zeek http.log
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN baseline of external domains receiving POSTs and their frequency
          FOR each new POST request
          IF destination_domain is not in baseline OR its frequency < 5th percentile
            ALERT on src_ip, destination_domain
  - question: Can we identify clusters of suspicious HTTP POST behavior, especially those involving low-reputation domains?
    context: This question uses machine learning to group similar POST requests. By clustering based on features like URL path, data size, and destination reputation, we can surface groups of anomalous activity. A cluster forming around a new or low-reputation domain could represent a new phishing campaign that multiple users have fallen for.
    answer_sources:
      - Zeek http.log
      - Zeek conn.log
      - Domain reputation service
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          EXTRACT features from POST requests (URI structure, content_type, domain_rep)
          APPLY clustering algorithm (e.g., DBSCAN)
          INVESTIGATE clusters that are small and centered on low-reputation domains
          RETURN cluster_members (src_ip, destination)
  - question: Are there immediate, short, low-data network connections to new domains following user email activity, indicative of tracking pixels?
    context: Adversaries use tracking pixels (1x1 images) in emails to verify that a target has opened the message. This activity appears as a very brief connection with minimal data transfer. Detecting this behavior, especially when the connection is to a newly observed domain, can provide an early warning that a user is being targeted by a reconnaissance campaign.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FIND DNS query followed within 2s by a TCP connection from same host
          WHERE total_bytes < 500 AND duration < 1s
          AND domain is newly observed
          ALERT on src_ip, domain, time
  - question: Are we observing network connections with exceptionally low duration and data transfer volumes, especially to new or high-entropy domains?
    context: This question uses statistical analysis to find connections that are outliers in terms of their brevity and small data footprint, characteristics of tracking pixels or web bugs. By cross-referencing these anomalous connections with other suspicious indicators like domain age or randomness, we can increase the confidence that they are part of a phishing reconnaissance effort.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE 1st percentile for connection 'duration' and 'total_bytes'
          IDENTIFY connections below both thresholds
          CROSS-REFERENCE destination domain with list of new or high-entropy domains
          IF match found, ALERT on src_ip, destination, duration, bytes
  - question: Can a machine learning model be trained to distinguish malicious 'pingback' connections from legitimate, brief API calls?
    context: Many legitimate applications make short, low-data connections. This question aims to use machine learning to differentiate these from malicious tracking pixels. By training a classifier on features like domain age and entropy in addition to connection stats, we can build a more nuanced detector that reduces false positives from benign 'ping' traffic.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN logistic regression model on labeled 'pingback' and 'legit ping' data
          USE features like duration, byte_count, domain_age, domain_entropy
          APPLY model to new, short connections
          ALERT on connections classified as high-probability 'pingback'
  - question: Are mobile devices on the corporate network connecting to known malicious domains associated with QR code phishing campaigns?
    context: This question addresses the rising threat of 'quishing' (QR code phishing), where a user scans a code on one device and their mobile phone connects to the malicious site. By filtering for mobile user agents and correlating their network activity against threat intelligence specific to mobile or QR code campaigns, we can detect these cross-device attacks.
    answer_sources:
      - Zeek http.log
      - Zeek conn.log
      - Threat Intelligence Feed
      - Corporate Wi-Fi Network Segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FILTER http.log for mobile user agents ('iPhone', 'Android')
          EXTRACT connections from the corresponding source IPs in conn.log
          CORRELATE destination domains with QR-phishing threat intelligence
          ALERT on any match
  - question: Are mobile devices accessing newly registered or typosquatted domains that they do not normally visit?
    context: This question provides a statistical method to detect 'quishing' without specific threat intelligence. By baselining normal mobile browsing behavior, an alert can be triggered when a mobile device connects to a domain that is both anomalous for that user type and suspicious in its own right (e.g., newly registered or a typosquatted version of a known brand).
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - List of legitimate domains
    range: last 30 days
    queries:
      - technology: pseudocode
        query: |
          FILTER for mobile user agents
          IDENTIFY destination domains that are newly registered (< 30 days)
          CALCULATE Levenshtein distance to known good domains
          IF new domain AND high Levenshtein distance, ALERT on mobile device, src_ip, domain
  - question: Can we detect anomalous network sessions from mobile devices that may indicate interaction with a malicious QR code?
    context: This question applies unsupervised machine learning to model the network behavior of mobile devices. An anomaly detection model can learn what constitutes a 'normal' session for a mobile user (e.g., common sites, data volumes). It can then flag sessions that deviate significantly, such as a connection to a rare, low-reputation domain, which could be the result of a 'quishing' attack.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Domain reputation service
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN anomaly detection model on features from mobile device sessions
          FEATURES include domain_rep, connection_frequency, data_volume
          APPLY model to new mobile sessions
          FLAG sessions identified as highly anomalous for investigation
  - question: Are web browsers spawning unexpected or suspicious child processes, potentially indicating a Browser-in-the-Browser (BitB) attack?
    context: This question looks for post-compromise activity on the endpoint. A successful BitB attack might involve the browser launching a malicious script or another process. This rule detects when a browser process (like chrome.exe) spawns an unusual child (like powershell.exe), especially if it occurs shortly after connecting to a low-reputation domain.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - User Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH for process creation events (EID 4688)
          WHERE parent_process is a browser AND child_process is unexpected (powershell.exe)
          CORRELATE with recent network connections to low-reputation domains from the same host
          ALERT on parent, child, command_line, and related network connection
  - question: Are there statistically rare parent-child process relationships originating from web browsers?
    context: This question establishes a baseline of normal process behavior to find anomalies. Most of the time, browsers spawn a predictable set of child processes. By identifying process creation events that are statistical outliers (i.e., they happen very infrequently in the environment), we can uncover novel or unusual attack techniques without a predefined rule.
    answer_sources:
      - Windows Event ID 4688
      - User Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE frequency of all parent-child process relationships where parent is a browser
          IDENTIFY relationships that occur < 0.1% of the time
          ALERT on the rare relationship, providing host, parent, child, and command line
  - question: Can a machine learning model classify browser-initiated process creation events as benign or suspicious?
    context: This question uses a supervised model to automate the detection of malicious process activity following a click. By training a classifier on features like the process names and command-line arguments, the model can learn to distinguish legitimate browser functions from suspicious actions, providing a scalable way to detect threats like BitB frameworks.
    answer_sources:
      - Windows Event ID 4688
      - Labeled training data
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each browser-spawned process event
          EXTRACT features (parent_name, child_name, cmd_line_keywords)
          APPLY trained decision tree model
          IF classified as 'suspicious'
            ALERT with event details