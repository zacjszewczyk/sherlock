name: "T1083: File and Directory Discovery"
id: "c8a0b1d2-5e7f-4b0a-8d6c-3f9e2a1b4c5d"
description: "This playbook helps identify if an adversary is performing file and directory discovery on enterprise systems. This involves detecting the use of known malicious discovery tools (e.g., Seatbelt, SharpHound), the misuse of native command-line utilities (`dir`, `tree`, `find`), statistically significant spikes in file access or discovery commands, access to multiple sensitive directories, anomalous network scanning for SMB shares, and correlated sequences of events that indicate a reconnaissance-to-staging attack chain."
type: "technique"
related:
  - "TA0007: Discovery"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are known malicious discovery tools (like Seatbelt or SharpHound) being executed on enterprise systems?"
    context: "This question focuses on detecting the direct execution of known malicious discovery tools by their process names or file hashes. A match is a high-confidence indicator of compromise, as these tools are specifically designed for reconnaissance within a compromised network. Alerting on these helps catch adversaries early in their discovery phase."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Log aggregation platform (SIEM) containing process execution logs from all enterprise endpoints and servers, with a focus on high-value assets like Domain Controllers, file servers, and developer workstations."
    range: "last 90 days"
    queries:
      - "SEARCH process_creation_logs WHERE process_name IN (watchlist_of_discovery_tools) OR file_hash IN (watchlist_of_discovery_tool_hashes)"
  - question: "Is an unusually rare process being executed from an interactive shell, potentially indicating an unknown or custom discovery tool?"
    context: "This question aims to find unknown or custom discovery tools by looking for processes that are statistically rare in the environment. Adversaries often use custom-compiled or less common tools to evade signature-based detection. A low-prevalence executable launched from a command shell (`cmd.exe`, `powershell.exe`) is a strong anomaly worth investigating."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Log aggregation platform (SIEM) containing process execution logs from all enterprise endpoints and servers, with a focus on high-value assets like Domain Controllers, file servers, and developer workstations."
    range: "last 90 days"
    queries:
      - "CALCULATE prevalence of all process_hashes. SEARCH process_creation_logs WHERE parent_process IN ('powershell.exe', 'cmd.exe') AND process_hash_prevalence < 5 hosts."
  - question: "Can machine learning models identify suspicious process executions indicative of discovery activity based on their characteristics?"
    context: "This question leverages a machine learning approach to identify malicious discovery activity that might not be caught by simple rules. By analyzing features like process name entropy (randomness), parent process, and command-line length, a model can score the likelihood of a process being malicious, providing a more nuanced and robust detection method than static indicators alone."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Log aggregation platform (SIEM) containing process execution logs from all enterprise endpoints and servers, with a focus on high-value assets like Domain Controllers, file servers, and developer workstations."
    range: "last 90 days"
    queries:
      - "FOR EACH process_creation_event, SCORE with ML_model(features=[process_name_entropy, parent_process, cmd_line_length, hash_prevalence]). ALERT if score > 0.9."
  - question: "Are native command-line utilities like 'dir', 'tree', or 'find' being used with arguments that suggest wide-scale or sensitive file discovery?"
    context: "This question focuses on detecting the misuse of legitimate, built-in system tools for discovery. Adversaries use these 'living-off-the-land' binaries (LOLBins) to blend in. Searching for specific command-line patterns, like recursive searches (`/s`), output redirection (`> file.txt`), or searches for sensitive file extensions (`.pem`, `.kdbx`), can uncover this malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Log aggregation platform (SIEM) containing process execution logs from all endpoints and servers, particularly those where interactive command-line use is rare or should be highly scrutinized (e.g., web servers, database servers, application servers)."
    range: "last 90 days"
    queries:
      - "SEARCH process_creation_logs WHERE process_name IN ('dir.exe', 'tree.com', 'find.exe') AND command_line MATCHES REGEX ('/s.*>', 'findstr .pem .kdbx')"
  - question: "Are users or hosts executing discovery commands with arguments that are anomalous compared to their own historical behavior?"
    context: "This question aims to detect unusual discovery activity by baselining normal command-line usage for each user and host. A user who typically uses simple `dir` commands and suddenly executes a complex, recursive search is an anomaly. This behavioral approach can catch sophisticated adversaries who are attempting to blend in by using legitimate tools in a non-standard way."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Log aggregation platform (SIEM) containing process execution logs from all endpoints and servers, particularly those where interactive command-line use is rare or should be highly scrutinized (e.g., web servers, database servers, application servers)."
    range: "last 90 days"
    queries:
      - "FOR EACH user_host_pair, BASELINE command_line_arguments. FOR EACH new_execution, CALCULATE Jaccard_distance_from_baseline. ALERT if distance > 98th_percentile."
  - question: "Does the sequence of commands executed by a user deviate from normal workflow patterns, especially when discovery commands are involved?"
    context: "This question looks beyond single commands to analyze the entire sequence of actions within a user session. A benign user might run `dir` then edit a file. An adversary might run `dir`, then `whoami`, then `net user`, then `tree`. A sequence analysis model can learn these normal patterns and flag sessions that contain an illogical or suspicious flow of commands, indicating reconnaissance activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Log aggregation platform (SIEM) containing process execution logs from all endpoints and servers, particularly those where interactive command-line use is rare or should be highly scrutinized (e.g., web servers, database servers, application servers)."
    range: "last 90 days"
    queries:
      - "FOR EACH user_session, ANALYZE command_sequence with LSTM_model. ALERT if sequence_probability is low AND sequence contains ('dir', 'tree', 'find')."
  - question: "Has a user or process generated a burst of file access events or discovery commands that exceeds a fixed, high-volume threshold?"
    context: "This question uses a simple, high-volume threshold to detect brute-force discovery activity. While potentially noisy, a massive spike (e.g., thousands of file accesses or hundreds of `dir` commands in minutes) is a strong indicator of automated scanning or scripting, which is characteristic of an adversary quickly mapping out a system's file structure."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Log aggregation platform (SIEM) containing process creation and file audit logs from critical assets like file servers, SharePoint servers, source code repositories, and Domain Controllers."
    range: "last 90 days"
    queries:
      - "COUNT file_access_events (4663) and discovery_commands (4688) by user/process over 5min. ALERT if file_access_count > 1000 OR discovery_command_count > 100."
  - question: "Is a user or host exhibiting a statistically significant increase in file access or discovery command activity compared to their own baseline?"
    context: "This question refines the volume-based approach by creating a dynamic baseline for each user and host. Instead of a fixed number, it alerts when activity is abnormal *for that specific entity*. This is more effective at finding unusual behavior, as what's normal for a backup service would be highly anomalous for a regular user account."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Log aggregation platform (SIEM) containing process creation and file audit logs from critical assets like file servers, SharePoint servers, source code repositories, and Domain Controllers."
    range: "last 90 days"
    queries:
      - "FOR EACH user_host, BASELINE hourly file_access and discovery_command counts. ALERT if current_hour_count > (mean + 3 * std_dev) of baseline."
  - question: "Does the time series of file access events for a user or process show an anomaly that cannot be explained by normal daily or weekly patterns (seasonality)?"
    context: "This question applies advanced time-series analysis to detect subtle anomalies in file access patterns. Algorithms like SARIMA or Prophet can model complex seasonal behavior (e.g., higher activity during work hours, lower on weekends). An alert is triggered only when activity deviates significantly from what the model *predicts*, making it highly effective at filtering out normal business operations and spotting true outliers."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Log aggregation platform (SIEM) containing process creation and file audit logs from critical assets like file servers, SharePoint servers, source code repositories, and Domain Controllers."
    range: "last 90 days"
    queries:
      - "MODEL time_series of file_access_events (4663) per user/process using SARIMA/Prophet. ALERT if actual_count exceeds predicted_confidence_interval."
  - question: "Is a single process or user rapidly accessing multiple pre-defined sensitive directories or files?"
    context: "This question focuses on 'canary' files and directories. By creating a watchlist of known sensitive locations (like where password hashes are stored or private keys reside), an alert can be triggered when a single entity starts 'hopping' between them. This behavior is highly suspicious as legitimate access is typically confined to a single, relevant sensitive location at a time."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 11"
      - "File audit logs (Event ID 4663) from servers hosting sensitive departmental data (Finance, HR, Legal), Domain Controllers (SYSVOL, NTDS.dit location), and source code repositories."
    range: "last 90 days"
    queries:
      - "SEARCH file_access_logs (4663) for paths in critical_directory_watchlist. COUNT distinct directories accessed by process in 1min. ALERT if count > 3."
  - question: "Is a process exhibiting unusually broad or random directory traversal, as measured by the entropy of the paths it accesses?"
    context: "This question uses information theory to detect widespread discovery. High entropy in accessed directory paths suggests the process is not following a predictable, narrow workflow but is instead touching many different, unrelated parts of the file system. This is a strong mathematical indicator of automated scanning or an adversary manually exploring the system."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 11"
      - "File audit logs (Event ID 4663) from servers hosting sensitive departmental data (Finance, HR, Legal), Domain Controllers (SYSVOL, NTDS.dit location), and source code repositories."
    range: "last 90 days"
    queries:
      - "FOR EACH process, CALCULATE Shannon_entropy of accessed_directory_paths over 10min. ALERT if entropy > 99th_percentile for that process_name/user."
  - question: "Does a user's file access behavior fall outside of the normal clusters of activity established by their peers?"
    context: "This question uses clustering to find behavioral outliers. By grouping users with similar file access patterns (e.g., the HR department accessing HR folders, developers accessing source code), any user whose activity doesn't fit into a defined cluster is flagged as an anomaly. This is a powerful way to spot compromised accounts being used for purposes outside their normal role."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 11"
      - "File audit logs (Event ID 4663) from servers hosting sensitive departmental data (Finance, HR, Legal), Domain Controllers (SYSVOL, NTDS.dit location), and source code repositories."
    range: "last 90 days"
    queries:
      - "CLUSTER users based on vectorized file_access_patterns using DBSCAN. ALERT on users classified as outliers, especially if their activity involves sensitive directories."
  - question: "Is a single host attempting to connect to an unusually high number of network shares, especially administrative shares (C$, ADMIN$)?"
    context: "This question aims to detect network-level file and directory discovery. An adversary, having compromised one host, will often use it to scan the network for open and accessible file shares. A large number of connection attempts to unique shares from a single source, particularly to administrative shares, is a classic sign of lateral movement and reconnaissance."
    answer_sources:
      - "Zeek smb_files.log"
      - "Zeek conn.log"
      - "Zeek smb_mapping.log"
      - "Windows Event ID 5145"
      - "Network traffic data from network taps monitoring East-West traffic between subnets. Zeek sensors deployed at key network chokepoints (e.g., data center core, user access layer). Windows Security logs from all file servers and domain controllers."
    range: "last 90 days"
    queries:
      - "SEARCH smb_logs (Zeek smb_mapping.log, Win 5145). COUNT unique host/share combinations per source_IP in 5min. ALERT if count > 10. INCREASE severity if share_name IN ('C$', 'ADMIN$')."
  - question: "Is a host exhibiting an anomalous 'fan-out' of SMB (port 445) connections compared to its peers?"
    context: "This question focuses on the network connection pattern itself, rather than the share names. It identifies hosts that are connecting to a much larger number of other machines over SMB than is typical for their role (e.g., a workstation suddenly connecting to 50 other workstations). This 'fan-out' behavior is a strong indicator of an automated SMB scanning tool being run from the source host."
    answer_sources:
      - "Zeek smb_files.log"
      - "Zeek conn.log"
      - "Zeek smb_mapping.log"
      - "Windows Event ID 5145"
      - "Network traffic data from network taps monitoring East-West traffic between subnets. Zeek sensors deployed at key network chokepoints (e.g., data center core, user access layer). Windows Security logs from all file servers and domain controllers."
    range: "last 90 days"
    queries:
      - "COUNT unique destination_IPs on port 445 per source_IP per hour. BASELINE this 'fan-out' metric for peer groups. ALERT if a host's fan-out > 95th_percentile of its peer group."
  - question: "Are new SMB connections forming that are unusual from a network graph perspective, such as bridging otherwise separate user groups or showing a sudden increase in centrality?"
    context: "This question applies graph analysis to network traffic to find structural anomalies. Normal traffic often forms distinct communities (e.g., finance servers talk to finance workstations). An adversary moving laterally will create new connections that bridge these communities or cause a compromised node to suddenly become much more 'central' in the graph. This detects the structural change in communication patterns caused by an attack."
    answer_sources:
      - "Zeek smb_files.log"
      - "Zeek conn.log"
      - "Zeek smb_mapping.log"
      - "Windows Event ID 5145"
      - "Network traffic data from network taps monitoring East-West traffic between subnets. Zeek sensors deployed at key network chokepoints (e.g., data center core, user access layer). Windows Security logs from all file servers and domain controllers."
    range: "last 90 days"
    queries:
      - "BUILD graph with hosts as nodes, SMB connections as edges. IDENTIFY communities. ALERT on new edges that bridge communities OR on nodes with a sudden increase in degree centrality."
  - question: "Has a host exhibited a correlated sequence of events indicative of the reconnaissance-to-staging attack chain (e.g., local discovery -> network discovery -> data compression)?"
    context: "This question seeks to identify a multi-stage attack pattern by correlating different types of events over time. An adversary's workflow often follows a logical progression: first, they discover files locally; next, they discover files on the network; finally, they package the discovered data for exfiltration. A stateful rule that looks for this specific sequence provides a very high-fidelity alert for an active intrusion."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 11"
      - "Zeek smb_mapping.log"
      - "Zeek conn.log"
      - "Centralized log management platform (e.g., SIEM, data lake) capable of correlating events from disparate sources, including endpoint process logs (Windows, Sysmon) and network traffic logs (Zeek)."
    range: "last 90 days"
    queries:
      - "CREATE stateful rule. IF host performs (recursive dir) AND THEN (SMB enum >5 servers) AND THEN (creates .zip/.rar/.7z) within 1hr, ALERT."
  - question: "Has a host accumulated a high risk score by performing a series of individually suspicious, but not necessarily malicious, actions in a short period?"
    context: "This question uses a risk-scoring model to detect attacks. Instead of relying on one high-severity event, it aggregates risk from multiple lower-severity events. A recursive `dir` might be low risk on its own, as might a single SMB connection. But when a host does both, plus accesses a sensitive file, its cumulative risk score can cross a threshold, indicating a likely compromise that would be missed by looking at each event in isolation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 11"
      - "Zeek smb_mapping.log"
      - "Zeek conn.log"
      - "Centralized log management platform (e.g., SIEM, data lake) capable of correlating events from disparate sources, including endpoint process logs (Windows, Sysmon) and network traffic logs (Zeek)."
    range: "last 90 days"
    queries:
      - "DEFINE risk scores for events (e.g., recursive_dir=5, smb_scan=15). SUM risk score for each host over 30min. ALERT if total_score > threshold (e.g., 4 std_dev above peer group mean)."
  - question: "Can a probabilistic model, like a Hidden Markov Model, infer that a host has transitioned into a 'Reconnaissance' or 'Staging' attack phase based on its sequence of observed security events?"
    context: "This question applies a sophisticated probabilistic model to infer the adversary's intent. An HMM assumes there are hidden 'states' (like 'Benign' or 'Reconnaissance') that can only be inferred through 'observations' (the security events we log). By feeding the stream of events from a host into the model, we can calculate the probability that the host is in a malicious state, allowing for detection even when the individual events themselves are ambiguous."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 11"
      - "Zeek smb_mapping.log"
      - "Zeek conn.log"
      - "Centralized log management platform (e.g., SIEM, data lake) capable of correlating events from disparate sources, including endpoint process logs (Windows, Sysmon) and network traffic logs (Zeek)."
    range: "last 90 days"
    queries:
      - "FEED stream of events per host into HMM. MODEL calculates probability of hidden states ('Benign', 'Recon', 'Staging'). ALERT if P(state='Recon' or 'Staging') > threshold."