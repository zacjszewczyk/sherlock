name: "T1672: Email Spoofing"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: |
  This playbook helps investigate whether an adversary is using email spoofing for defense evasion. It focuses on identifying suspicious inbound emails by checking for several key indicators: emails originating from sources on high-confidence threat intelligence lists; emails from high-value domains that fail SPF or DKIM authentication or have weak DMARC policies; mismatches between the friendly 'From' header and the SMTP envelope 'MAIL FROM' for trusted domains; significant spikes in email volume from a single source IP purporting to be from a trusted domain; and emails from trusted domains originating from anomalous network locations (ASN), geographic regions, or sources with poor reputation.
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are any inbound emails originating from source IPs or containing header domains that are on a high-confidence list of malicious indicators?"
    context: |
      This question aims to detect emails from known malicious infrastructure. By comparing the source IP and key email header domains ('From', 'Reply-To', 'Return-Path') against a trusted threat intelligence list, analysts can quickly identify and triage emails associated with active phishing or malware campaigns. A match provides a strong signal that the email is part of a malicious attack.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "DMZ network segment hosting email gateways"
      - "Network perimeter firewalls"
      - "Threat Intelligence Platform API endpoint"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each inbound_email in last 90 days
          GET source_ip, from_domain, reply_to_domain, return_path_domain
          IF source_ip OR from_domain OR reply_to_domain OR return_path_domain IN malicious_indicator_list THEN
            ALERT
          ENDIF
  - question: "Do any inbound emails have an aggregated threat intelligence risk score that exceeds the established threshold for known-bad indicators?"
    context: |
      This question moves beyond simple blocklists to use a more nuanced risk-based approach. By aggregating reputation scores for the sender's IP and domain from multiple threat intelligence feeds, we can identify suspicious emails that might not appear on a single high-confidence list. Calculating a weighted average and comparing it to a threshold based on historical data of known malicious indicators helps to flag emails that are statistically likely to be malicious.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "DMZ network segment hosting email gateways"
      - "Network perimeter firewalls"
      - "Threat Intelligence Platform API endpoint"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each inbound_email
          GET source_ip, sender_domain
          CALCULATE weighted_risk_score from threat_intel_feeds
          IF weighted_risk_score > threshold (85th percentile of known-bad) THEN
            ALERT
          ENDIF
  - question: "Has our machine learning model identified any inbound emails with a high probability of being malicious based on their features?"
    context: |
      This question leverages a supervised machine learning model to provide predictive analysis. The model is trained on a labeled dataset of good and bad emails, using features like ASN, sender domain age, and threat intelligence scores. It can identify complex, non-linear patterns that simple rules or scoring might miss, allowing for the detection of novel or sophisticated spoofing attempts in real-time.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "DMZ network segment hosting email gateways"
      - "Network perimeter firewalls"
      - "Threat Intelligence Platform API endpoint"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each new inbound_email
          EXTRACT features (ASN, domain_age, etc.)
          PREDICT malicious_probability with ML_model
          IF probability > 0.90 THEN
            ALERT
          ENDIF
  - question: "Are there any inbound emails from high-value domains that are failing SPF or DKIM authentication, or originating from domains with a weak DMARC policy?"
    context: |
      This question targets a common spoofing tactic where an attacker impersonates a trusted internal or partner domain. SPF and DKIM are authentication mechanisms designed to prevent this. An authentication failure from a high-value domain is a strong indicator of a spoofing attempt. Additionally, identifying emails from domains with a weak DMARC policy (`p=none`) is important, as it signals that the domain owner is not enforcing email authentication, making it an easier target for spoofing.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek dns.log"
      - "Email security gateway"
      - "Corporate DNS resolvers"
      - "Directory of trusted partner domains"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each inbound_email
          GET from_domain, spf_result, dkim_result, dmarc_policy
          IF (from_domain IN high_value_list AND (spf_result == 'fail' OR dkim_result == 'fail')) THEN
            HIGH_SEVERITY_ALERT
          ENDIF
          IF (from_domain IN high_value_list AND dmarc_policy == 'p=none') THEN
            LOW_SEVERITY_ALERT
          ENDIF
  - question: "Has the daily rate of SPF/DKIM authentication failures for any external sender domain significantly exceeded its historical baseline?"
    context: |
      This question aims to detect anomalies in authentication failure patterns. A sudden spike in SPF/DKIM failures from a specific domain, even if it's not a high-value one, could indicate the beginning of a larger spoofing campaign targeting that domain. By comparing the current day's failure rate to a statistical threshold (95th percentile) of its 30-day history, we can spot abnormal activity that might be missed by per-email rules.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek dns.log"
      - "Email security gateway"
      - "Corporate DNS resolvers"
      - "Directory of trusted partner domains"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each sender_domain
          CALCULATE daily_failure_rate
          CALCULATE historical_95th_percentile_failure_rate
          IF daily_failure_rate > historical_95th_percentile_failure_rate THEN
            ALERT
          ENDIF
  - question: "Is there a time-series anomaly in the hourly count of SPF/DKIM failures for any high-value sender domain, suggesting a targeted campaign?"
    context: |
      This question uses a more advanced time-series model to detect sophisticated, targeted attacks. A spoofing campaign might manifest as a sudden, sharp increase in authentication failures that deviates from normal daily or weekly email patterns. By applying a model like Seasonal-Hybrid ESD, we can account for normal business seasonality and isolate true anomalies, providing a high-fidelity alert for potential targeted spoofing campaigns.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek dns.log"
      - "Email security gateway"
      - "Corporate DNS resolvers"
      - "Directory of trusted partner domains"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each high_value_domain
          APPLY time_series_model to hourly_auth_failure_count
          IF current_count > forecasted_range THEN
            ALERT
          ENDIF
  - question: "Are we receiving emails where the friendly 'From' header domain is a trusted entity, but the envelope 'MAIL FROM' domain does not match?"
    context: |
      This question looks for a classic spoofing indicator: a mismatch between the human-readable 'From' address (RFC5322) and the technical 'MAIL FROM' address used in the SMTP transaction (RFC5321). Attackers often spoof the friendly 'From' to appear as a trusted source (e.g., your own company) while the underlying envelope sender is a malicious domain. This check is crucial for catching impersonations of internal or high-value partner domains.
    answer_sources:
      - "Zeek smtp.log"
      - "Mail Transfer Agent (MTA) logs"
      - "Email security gateway inspection point"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each inbound_email
          GET from_domain, mailfrom_domain
          IF (tld_plus_one(from_domain) != tld_plus_one(mailfrom_domain)) AND (from_domain IN high_value_list) THEN
            ALERT
          ENDIF
  - question: "For emails claiming to be from a trusted domain, is the combination of the 'From' domain and 'MAIL FROM' domain a new or very infrequent pairing?"
    context: |
      This question uses historical data to establish a baseline of normal sender behavior. Legitimate services sending email on behalf of a trusted domain (e.g., a marketing platform) will create consistent ('From', 'MAIL FROM') pairs. A spoofed email is likely to introduce a new or rare pair. By flagging pairs that have never been seen or are in the bottom 5th percentile of frequency, we can identify suspicious sender relationships that might indicate a spoofing attempt.
    answer_sources:
      - "Zeek smtp.log"
      - "Mail Transfer Agent (MTA) logs"
      - "Email security gateway inspection point"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each inbound_email from trusted_domain
          GET from_domain, mailfrom_domain
          CHECK frequency of (from_domain, mailfrom_domain) pair in last 90 days
          IF pair is new OR frequency < 5th_percentile THEN
            ALERT
          ENDIF
  - question: "Is our autoencoder model detecting an anomalous 'MAIL FROM' domain for an email purporting to be from a high-value 'From' domain?"
    context: |
      This question applies an unsupervised machine learning approach to detect abnormal sender relationships. An autoencoder is trained to learn the 'normal' set of envelope senders ('MAIL FROM' domains) for a specific high-value 'From' domain. When a new email arrives, the model attempts to reconstruct its 'MAIL FROM' domain. A high reconstruction error signifies that the domain is unlike any legitimate sender seen in the training data, strongly indicating it is an anomaly and likely spoofed.
    answer_sources:
      - "Zeek smtp.log"
      - "Mail Transfer Agent (MTA) logs"
      - "Email security gateway inspection point"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each new_email from high_value_domain
          GET mailfrom_domain
          CALCULATE reconstruction_error using trained_autoencoder
          IF reconstruction_error > threshold THEN
            ALERT
          ENDIF
  - question: "Has any single source IP sent an unusually large number of emails (e.g., >100) in a short time frame (e.g., 5 minutes) while purporting to be from a trusted domain?"
    context: |
      This question aims to detect bulk email spoofing campaigns. A common attacker tactic is to send a high volume of spoofed emails from a single compromised machine or server in a short burst. By using a simple sliding window and a static threshold, we can quickly identify these high-volume sending events that are characteristic of a spam or phishing campaign impersonating a trusted entity.
    answersources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "Network flow data collectors at the internet gateway"
      - "Email gateway transaction logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each trusted_from_domain
          COUNT emails per source_ip in 5_minute_window
          IF count > 100 THEN
            ALERT
          ENDIF
  - question: "Has the email volume from any specific (Source IP, From Domain) pair exceeded its historical average by a statistically significant amount (e.g., Z-score > 3)?"
    context: |
      This question refines the volume analysis by creating a dynamic, per-sender baseline. A static threshold might not be suitable for all senders. By calculating the mean and standard deviation of email volume for each (Source IP, From Domain) pair, we can detect statistically significant deviations. A Z-score greater than 3 indicates a rare event (less than 0.3% probability in a normal distribution), providing a more reliable alert for abnormal sending volume.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "Network flow data collectors at the internet gateway"
      - "Email gateway transaction logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each (source_ip, from_domain) pair
          CALCULATE mean and std_dev of volume over 30 days
          CALCULATE current_10_min_volume
          IF Z-score(current_volume) > 3 THEN
            ALERT
          ENDIF
  - question: "After accounting for normal trends and seasonality, is there an unexplained residual spike in the hourly email volume for any high-volume (Source IP, From Domain) pair?"
    context: |
      This question uses advanced time-series analysis to detect volume-based anomalies in complex environments. For high-volume senders, email traffic often has predictable daily and weekly patterns (seasonality). A time-series decomposition model can separate these normal patterns from the underlying trend and random residual noise. An alert on a large residual value means there's a volume spike that cannot be explained by normal business cycles, pointing to a potential spoofing campaign.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "Network flow data collectors at the internet gateway"
      - "Email gateway transaction logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each high_volume (source_ip, from_domain) pair
          DECOMPOSE hourly_email_count_series
          MONITOR residual_component
          IF residual > dynamic_threshold THEN
            ALERT
          ENDIF
  - question: "Did an email claiming to be from a critical internal or partner domain originate from a country or network (ASN) that is not on our explicit allow-list for that domain?"
    context: |
      This question implements a strict, high-confidence rule for the most critical domains. For your own domain or key financial partners, you likely know the legitimate geographic locations and network providers (ASNs) they send email from. By maintaining an explicit allow-list of these sources, any email that purports to be from that domain but originates from an unapproved source is highly suspicious and should be treated as a high-severity incident.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "Internet gateway routers"
      - "Subscription-based GeoIP and ASN databases"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each inbound_email from critical_domain
          GET source_country, source_asn
          IF source_country NOT IN allow_list OR source_asn NOT IN allow_list THEN
            HIGH_SEVERITY_ALERT
          ENDIF
  - question: "For a given trusted sender domain, did an inbound email originate from a source ASN or country that has never been seen before or is statistically rare?"
    context: |
      This question identifies deviations from established communication patterns without needing a rigid allow-list. Over time, a trusted domain builds a profile of typical source countries and ASNs. A spoofed email will often originate from an anomalous source. By flagging emails from new or statistically rare (high Shannon entropy) source locations for a given domain, we can detect suspicious changes in origination patterns that may indicate a spoofing attempt.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "Internet gateway routers"
      - "Subscription-based GeoIP and ASN databases"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each inbound_email from trusted_domain
          GET source_asn
          CHECK historical_profile_of_asns_for_domain
          IF source_asn is new OR statistically_rare THEN
            ALERT
          ENDIF
  - question: "Does the source IP of an email from a high-value domain fall outside the normal 'clusters' of legitimate sending infrastructure identified by our density-based clustering model?"
    context: |
      This question uses an unsupervised machine learning model to define 'normal' sending infrastructure based on multiple features like ASN, country, and IP reputation. The HDBSCAN algorithm can identify dense clusters of legitimate source IPs. An email originating from an IP that the model classifies as 'noise' or that falls far from any established cluster is considered a spatial anomaly. This method is effective at identifying outlier sources that don't fit the profile of legitimate senders for that domain.
    answer_sources:
      - "Zeek smtp.log"
      - "Zeek conn.log"
      - "Internet gateway routers"
      - "Subscription-based GeoIP and ASN databases"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each new_email from high_value_domain
          GET source_ip_features
          SCORE proximity to normal_clusters using HDBSCAN_model
          IF score is 'noise' or far_from_clusters THEN
            ALERT
          ENDIF