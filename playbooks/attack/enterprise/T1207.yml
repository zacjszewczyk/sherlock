name: T1207: Rogue Domain Controller
id: 5a9e1b2c-8f3d-4c6a-9e1b-2c8f3d4c6a9e
description: Investigates whether an adversary is manipulating Active Directory data
  by introducing a rogue domain controller into the environment. This technique involves
  an adversary-controlled machine masquerading as a legitimate Domain Controller
  to inject malicious data, such as creating new privileged users or modifying group
  memberships. This playbook looks for evidence of this activity by analyzing network
  traffic for signatures of tools like Mimikatz DCShadow (DCE/RPC calls), monitoring
  for process executions with tool-specific command-line arguments, identifying Active
  Directory replication traffic to or from unauthorized hosts, detecting Kerberos
  requests for DC-specific services from non-DC clients, observing the creation
  of new nTDSDSA objects which signal a new DC registration, and flagging anomalous
  bursts of AD object modifications originating from a single source.
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are there any NIDS alerts matching signatures for tools like Mimikatz
    DCShadow or Impacket secretsdump on network traffic involving the DRSUAPI service?
  context: This question seeks to identify known malicious replication attempts at
    the network level. Tools like Mimikatz DCShadow and Impacket's secretsdump use
    the Directory Replication Service (DRS) Remote Protocol (DRSUAPI) to push or
    pull AD data. They have specific network patterns that can be detected by Network
    Intrusion Detection Systems (NIDS) like Suricata. A signature match is a high-confidence
    indicator of an attempt to use a rogue domain controller or perform a DCSync
    attack.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Packet Capture (PCAP)
  - Network traffic at network chokepoints, such as core switches or firewalls segmenting
    Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH NIDS alerts WHERE signature CONTAINS "DCShadow" OR signature CONTAINS
      "secretsdump" AND service_uuid = "E3514235-4B06-11D1-AB04-00C04FC2DCD2"
- question: Are there any DRSUAPI transactions with unusually high payload entropy,
    suggesting the use of non-standard replication tools?
  context: This question aims to detect unknown or modified DCShadow/DCSync tools
    that might evade specific signatures. Legitimate replication traffic between
    Microsoft Domain Controllers tends to have a predictable structure and thus, a
    consistent entropy level. Malicious tools may structure their payloads differently,
    resulting in a statistically significant deviation in entropy. Flagging transactions
    in the 99th percentile helps uncover these outliers.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Packet Capture (PCAP)
  - Network traffic at network chokepoints, such as core switches or firewalls segmenting
    Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FROM Zeek dce_rpc.log WHERE service_uuid = "DRSUAPI_UUID" | CALCULATE entropy(payload)
      | COMPARE entropy > 99th_percentile_baseline
- question: Has a machine learning model classified any Active Directory replication
    sessions as malicious based on network traffic characteristics?
  context: This question leverages machine learning to identify subtle differences
    between legitimate and malicious replication traffic that are difficult to express
    with simple rules. By training a model on features like packet sizes, timing,
    and the sequence of remote procedure calls, it can learn to distinguish the behavior
    of tools like Mimikatz from normal Windows replication. An alert from this model
    indicates a session that strongly resembles known malicious activity.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Packet Capture (PCAP)
  - Network traffic at network chokepoints, such as core switches or firewalls segmenting
    Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: APPLY ML_Replication_Classifier to new network sessions on DRSUAPI port
      | SEARCH for sessions where prediction = "malicious"
- question: Have any processes been created or PowerShell scripts been executed containing
    keywords associated with DCShadow or DCSync tools?
  context: This question looks for direct evidence of an adversary executing known
    rogue DC or credential dumping tools on an endpoint. Searching for high-fidelity
    strings like 'dcshadow', 'drsgetncchanges', or 'secretsdump.py' in process command
    lines and PowerShell script blocks is a simple and highly effective way to detect
    the use of these tools.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Windows PowerShell Event ID 4104
  - Command-line and PowerShell script block logs from all domain-joined endpoints,
    especially member servers, Domain Controllers, and administrator workstations.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH process_creation_events OR powershell_script_logs WHERE command_line
      CONTAINS "dcshadow" OR "drsgetncchanges" OR "secretsdump.py" OR "Invoke-DCShadow"
- question: Have any rare command-line arguments related to Active Directory replication
    been observed on hosts that are not Domain Controllers?
  context: This question seeks to identify anomalous usage of legitimate Active Directory
    utilities or arguments that could be repurposed for malicious replication. Arguments
    related to replication ('drs', 'rep', 'sync') should almost never be seen on
    non-DC hosts. By baselining command-line argument frequency across the enterprise,
    we can flag their rare occurrence on unexpected systems as a potential indicator
    of compromise.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Windows PowerShell Event ID 4104
  - Command-line and PowerShell script block logs from all domain-joined endpoints,
    especially member servers, Domain Controllers, and administrator workstations.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FROM process_creation_events WHERE host_is_not_DC | PARSE command_line_arguments
      | IF argument IN ("drs", "rep", "sync") AND historical_frequency(argument) <
      0.001 THEN ALERT
- question: Has a machine learning model detected any anomalous command-line executions,
    particularly on non-Domain Controller hosts?
  context: This question uses an unsupervised machine learning model to find unusual
    command-line executions without relying on predefined keywords. The model learns
    what 'normal' command lines look like for your environment. It can then flag
    any new command line that deviates significantly from this learned baseline. This
    is especially powerful for detecting abuse on non-DC hosts, where the variety
    of normal commands is different from that on DCs.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Windows PowerShell Event ID 4104
  - Command-line and PowerShell script block logs from all domain-joined endpoints,
    especially member servers, Domain Controllers, and administrator workstations.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: APPLY ML_Commandline_Anomaly_Detector to new process_creation_events |
      SEARCH for events where prediction = "anomaly" AND host_is_not_DC
- question: Has Active Directory replication traffic been observed between an authorized
    Domain Controller and an unauthorized host?
  context: This is a fundamental check to detect rogue domain controllers. Active
    Directory replication should only occur between known, authorized Domain Controllers.
    By maintaining an allowlist of DC IPs and hostnames, any replication traffic
    (identified via network logs like Zeek or Windows replication event logs) involving
    a host not on that list is a high-confidence indicator of a rogue DC or a misconfiguration.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Windows Event ID 4928
  - Windows Event ID 4929
  - Network traffic flows at network chokepoints and Directory Service replication
    logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH (dce_rpc.log WHERE service_uuid = "DRSUAPI_UUID") OR (Windows Events
      4928, 4929) | IF source_ip NOT IN DC_allowlist OR destination_ip NOT IN DC_allowlist
      THEN ALERT
- question: Has any Domain Controller exhibited an anomalous volume of replication
    traffic or started replicating with a new, previously unknown partner?
  context: This question seeks to identify deviations in the patterns of legitimate
    replication. A rogue DC injecting a large amount of data could cause a spike
    in outbound replication volume from a legitimate DC. Similarly, if a DC suddenly
    starts replicating with a new IP address, it could be the adversary's rogue machine.
    Baselining traffic volume and partners helps detect these statistical anomalies.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Windows Event ID 4928
  - Windows Event ID 4929
  - Network traffic flows at network chokepoints and Directory Service replication
    logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR EACH DC | CALCULATE hourly_replication_volume_baseline | IF current_volume
      > (baseline_mean + 3*stdev) OR destination_ip IS NEW THEN ALERT
- question: Have any network connections on AD replication ports been identified
    as outliers or noise by a clustering algorithm?
  context: This question uses unsupervised machine learning to group network connections
    into 'normal' replication patterns. Connections between legitimate DCs, which
    are regular and consistent, will form dense clusters. A one-off connection from
    an adversary's machine attempting to replicate will not fit into these clusters
    and will be flagged as noise or an outlier by algorithms like DBSCAN. This is
    a powerful way to find anomalous connections without a predefined allowlist.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Windows Event ID 4928
  - Windows Event ID 4929
  - Network traffic flows at network chokepoints and Directory Service replication
    logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: APPLY DBSCAN clustering to replication_port_connections | SEARCH for connections
      classified as "noise" or "outlier"
- question: Has a host that is not an authorized Domain Controller requested a Kerberos
    ticket for a DC-specific service like DRSUAPI or Global Catalog?
  context: This question identifies when a non-DC attempts to access services that
    should only be used by other DCs. Services like the Directory Replication Service
    (DRSUAPI) and Global Catalog ('GC/') have unique Service Principal Names (SPNs).
    A non-DC requesting a ticket for one of these SPNs is highly suspicious and could
    indicate an adversary's machine preparing to perform a rogue DC attack.
  answer_sources:
  - Windows Event ID 4769
  - Zeek krb.log
  - Security event logs on all Domain Controllers and Kerberos network traffic captured
    at network chokepoints.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Windows Event 4769 WHERE (service_name = "DRSUAPI_GUID" OR service_name
      STARTSWITH "GC/") AND client_address NOT IN DC_allowlist
- question: Has a non-Domain Controller host requested a Kerberos Service Principal
    Name (SPN) that is statistically used almost exclusively by Domain Controllers?
  context: This question moves beyond a hardcoded list of SPNs and uses data to define
    what is 'normal' for a DC versus a non-DC. By analyzing historical Kerberos logs,
    we can identify a set of SPNs that are rarely, if ever, requested by non-DCs.
    An alert is triggered when a workstation or member server requests one of these
    'DC-only' SPNs, which is a strong anomaly.
  answer_sources:
  - Windows Event ID 4769
  - Zeek krb.log
  - Security event logs on all Domain Controllers and Kerberos network traffic captured
    at network chokepoints.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: IDENTIFY "DC-only" SPN set from historical data | SEARCH new TGS requests
      WHERE client_is_not_DC AND requested_spn IN "DC-only" set
- question: Has any host requested a Kerberos SPN that is considered anomalous for
    its assigned peer group (e.g., a web server requesting a DC service)?
  context: This question uses peer group analysis to model normal behavior for different
    types of systems. A web server has a different 'normal' set of SPN requests than
    a workstation or a Domain Controller. By grouping hosts by role and learning
    the typical SPN request patterns for each group, the model can flag when a host
    deviates from its peers, such as a member server acting like a DC by requesting
    the DRSUAPI SPN.
  answer_sources:
  - Windows Event ID 4769
  - Zeek krb.log
  - Security event logs on all Domain Controllers and Kerberos network traffic captured
    at network chokepoints.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: APPLY Peer_Group_SPN_Model to TGS requests | SEARCH for requests where
      requested_spn is an outlier for host's peer_group
- question: Has a new nTDSDSA object been created in the Active Directory Configuration
    partition?
  context: This is a critical, high-fidelity question. The creation of an nTDSDSA
    object is a required step for registering a new server as a Domain Controller.
    This event is extremely rare during normal operations and should only occur during
    a planned and authorized promotion of a new DC. An unexpected alert for the creation
    of this object is a major red flag for a rogue DC being introduced into the environment.
  answer_sources:
  - Windows Event ID 5137
  - Active Directory configuration partition, monitored via Directory Service Changes
    logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH Windows Event 5137 WHERE object_class = "nTDSDSA"
- question: Has an nTDSDSA object been created without a corresponding, authorized
    change management record?
  context: This question adds an operational context layer to the detection of nTDSDSA
    object creation. While the event itself is rare, it can be legitimate. By baselining
    the creation count (which should be zero most of the time) and requiring correlation
    with change management records for any non-zero count, this analytic effectively
    filters out legitimate DC promotions and focuses investigations on truly unauthorized
    and suspicious activity.
  answer_sources:
  - Windows Event ID 5137
  - Active Directory configuration partition, monitored via Directory Service Changes
    logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH for nTDSDSA object creation events | IF event_exists AND NOT correlated_with_change_ticket
      THEN ALERT
- question: Has an anomaly detection model flagged the creation of an nTDSDSA object
    as suspicious based on its attributes?
  context: This question uses machine learning to scrutinize the context surrounding
    the creation of an nTDSDSA object. The model can learn the normal attributes
    associated with legitimate DC promotions, such as the user account that performs
    the action (typically a highly-privileged service or enterprise admin account)
    and the time it occurs (often within a maintenance window). An object created
    by an unusual user or at an odd time would be flagged as a high-confidence anomaly.
  answer_sources:
  - Windows Event ID 5137
  - Active Directory configuration partition, monitored via Directory Service Changes
    logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: APPLY ML_AD_Object_Creation_Model to Event 5137 | SEARCH for events where
      object_class = "nTDSDSA" AND prediction = "anomaly"
- question: Have there been modifications to critical Active Directory objects or
    groups, such as the krbtgt account or membership of Domain Admins?
  context: This question focuses on the *impact* of a potential rogue DC. A primary
    goal of a DCShadow attack is to inject malicious changes, like creating a 'golden
    ticket' by modifying the krbtgt password hash or elevating privileges by adding
    an account to a high-level group. Directly monitoring for these specific, high-impact
    changes provides a crucial detection opportunity, regardless of how the change
    was injected.
  answer_sources:
  - Windows Event ID 5136
  - Windows Event ID 4738
  - Windows Event ID 4732
  - Windows Event ID 4756
  - Security and Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: SEARCH for (Event 5136 WHERE object = "krbtgt" AND attribute = "msDS-KeyVersionNumber")
      OR (Events 4732, 4756 WHERE group_name = "Domain Admins" OR "Enterprise Admins")
- question: Has any single Domain Controller sourced an anomalously high number of
    Active Directory modification events in a short period?
  context: This question aims to detect the burst of activity that occurs when a
    rogue DC pushes a batch of malicious changes into the replication topology. Legitimate
    changes are typically distributed over time and across DCs. A sudden, massive
    spike in modifications originating from a single DC is highly abnormal and can
    be detected by comparing the activity rate against a statistical baseline. This
    points directly to the source of the potentially malicious changes.
  answer_sources:
  - Windows Event ID 5136
  - Windows Event ID 4738
  - Windows Event ID 4732
  - Windows Event ID 4756
  - Security and Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: FOR EACH DC | CALCULATE hourly_modification_event_baseline | IF current_count
      > (baseline_mean + 4*stdev) THEN ALERT
- question: Has the total volume of Active Directory object modifications across
    the entire domain significantly exceeded the forecasted amount?
  context: This question provides a domain-wide view of AD change velocity. By using
    a time-series forecasting model (like SARIMA), we can predict the expected number
    of AD object modifications for any given period, accounting for seasonality (e.g.,
    business hours vs. nights/weekends). If the actual number of changes far exceeds
    this prediction, it signals a massive, unexpected event, such as a large-scale
    malicious injection of data from a rogue DC.
  answer_sources:
  - Windows Event ID 5136
  - Windows Event ID 4738
  - Windows Event ID 4732
  - Windows Event ID 4756
  - Security and Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: APPLY SARIMA_AD_Modification_Model to event counts | IF observed_count
      > prediction_interval THEN ALERT