name: T1207: Rogue Domain Controller
id: a1a2b3c4-d5e6-4f7a-8b9c-0d1e2f3a4b5c
description: |
  Investigates whether an adversary is manipulating Active Directory data by introducing a rogue domain controller into the environment. This playbook looks for evidence of tools like Mimikatz (DCShadow) or Impacket (secretsdump) through network traffic signatures and command-line artifacts. It also aims to detect unauthorized AD replication activity by monitoring for replication traffic from non-DC hosts, anomalous Kerberos ticket requests for DC-specific services, the unauthorized creation of nTDSDSA objects required for DC registration, and sudden bursts of AD object modifications that could indicate injected changes.
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Have any NIDS signatures for known DCShadow or DCSync tools triggered on network traffic involving the DRSUAPI service?
  context: |
    This is a high-fidelity method to detect the use of specific malicious tools like Mimikatz or Impacket secretsdump. A signature match on traffic to the Directory Replication Service (DRS) Remote Protocol interface (DRSUAPI, UUID E3514235-4B06-11D1-AB04-00C04FC2DCD2) is a strong indicator of a rogue domain controller attempt.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Packet Capture (PCAP)
  - Network traffic at network chokepoints, such as core switches or firewalls segmenting Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: SEARCH NIDS_alerts WHERE signature CONTAINS 'Mimikatz DCShadow' OR signature CONTAINS 'Impacket secretsdump' AND destination_service_uuid = 'E3514235-4B06-11D1-AB04-00C04FC2DCD2'
- question: Are there any DRSUAPI transactions with abnormally high payload entropy, suggesting non-standard replication activity?
  context: |
    Malicious tools often have unique payload structures that differ from standard Windows replication traffic. Calculating the entropy of DCE/RPC request payloads can reveal these statistical anomalies. A transaction with entropy significantly higher than the established baseline for legitimate DC-to-DC communication may indicate tool usage.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Packet Capture (PCAP)
  - Network traffic at network chokepoints, such as core switches or firewalls segmenting Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: CALCULATE entropy for DRSUAPI payloads. COMPARE against baseline. ALERT if entropy > 99th_percentile_of_baseline.
- question: Has a machine learning model classified any AD replication network sessions as malicious?
  context: |
    This question leverages a supervised machine learning model trained to distinguish between legitimate and malicious (e.g., Mimikatz-based) replication traffic. The model analyzes features like packet sizes, timing, and operation sequences. An alert from this model indicates a high probability that a network session is associated with a rogue DC attack.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Packet Capture (PCAP)
  - Network traffic at network chokepoints, such as core switches or firewalls segmenting Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: SEARCH ML_alerts WHERE model_name = 'Replication_Classifier' AND prediction = 'malicious'
- question: Have any processes been created or PowerShell scripts executed containing keywords associated with DCShadow or DCSync tools?
  context: |
    Tools used for rogue DC attacks often have specific command-line arguments or function names. Searching for high-fidelity keywords like 'dcshadow', 'drsgetncchanges', or 'secretsdump.py' in process creation and PowerShell script block logs is a direct way to detect the execution of these tools on an endpoint.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Windows PowerShell Event ID 4104
  - Command-line and PowerShell script block logs from all domain-joined endpoints, especially member servers, Domain Controllers, and administrator workstations.
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_creation_logs OR powershell_logs WHERE command_line CONTAINS 'dcshadow' OR 'drsgetncchanges' OR 'secretsdump.py' OR 'Invoke-DCShadow'
- question: Have any historically rare Active Directory replication commands been executed on non-DC hosts?
  context: |
    Legitimate AD replication commands are typically executed only on Domain Controllers. By analyzing the historical frequency of all command-line arguments across the enterprise, we can identify arguments related to replication that are statistically rare on non-DC hosts. The appearance of such a command on a member server or workstation is highly suspicious.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Windows PowerShell Event ID 4104
  - Command-line and PowerShell script block logs from all domain-joined endpoints, especially member servers, Domain Controllers, and administrator workstations.
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_creation_logs WHERE host_is_not_DC AND command_line_argument IN ('drs', 'rep', 'sync') AND argument_frequency < 0.1%
- question: Has an anomaly detection model flagged any command-line executions as unusual, particularly on non-DC hosts?
  context: |
    This approach uses an unsupervised machine learning model (like Isolation Forest) to learn what normal command-line activity looks like. The model can then identify executions that deviate significantly from this learned baseline. An anomalous command flagged on a non-DC host is a potential indicator of malicious activity, including rogue DC tool execution.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Windows PowerShell Event ID 4104
  - Command-line and PowerShell script block logs from all domain-joined endpoints, especially member servers, Domain Controllers, and administrator workstations.
  range: last 90 days
  queries:
  - pseudocode: SEARCH ML_alerts WHERE model_name = 'CommandLine_Anomaly_Detector' AND prediction = 'anomaly'
- question: Has any Active Directory replication traffic been observed involving a host that is not an authorized Domain Controller?
  context: |
    AD replication should only occur between known, authorized Domain Controllers. By maintaining a strict allowlist of DC hostnames and IP addresses, any replication traffic (identified via network logs like Zeek or Windows Event Logs 4928/4929) to or from an unlisted machine is a critical security event and a strong indicator of a rogue DC.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Windows Event ID 4928
  - Windows Event ID 4929
  - Network traffic flows at network chokepoints and Directory Service replication logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: SEARCH (network_logs WHERE service = 'DRSUAPI') OR (windows_events WHERE event_id IN (4928, 4929)) AND (source_host NOT IN DC_allowlist OR destination_host NOT IN DC_allowlist)
- question: Has any Domain Controller exhibited anomalous replication traffic volume or initiated replication with a new, unknown partner?
  context: |
    Attackers might use a compromised DC to communicate with their rogue machine. This question aims to detect deviations in the established patterns of replication traffic. A sudden spike in the volume of data being replicated, or traffic being sent to a new IP address not previously seen as a replication partner, can indicate that a legitimate DC is being leveraged in an attack.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Windows Event ID 4928
  - Windows Event ID 4929
  - Network traffic flows at network chokepoints and Directory Service replication logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: CALCULATE hourly replication traffic volume per DC. ALERT if volume > (moving_average + 3 * stdev) OR if destination_IP is new_replication_partner.
- question: Has clustering analysis of network connection data identified any AD replication traffic as an outlier or part of an anomalous cluster?
  context: |
    Legitimate replication traffic between established DCs should form predictable, dense clusters when analyzed based on features like IP addresses, duration, and data volume. A clustering algorithm like DBSCAN can automatically identify these patterns. Any connection that falls outside these clusters (i.e., is flagged as noise or a small, distinct cluster) is a high-confidence anomaly that could represent a rogue DC connection.
  answer_sources:
  - Zeek dce_rpc.log
  - Zeek conn.log
  - Windows Event ID 4928
  - Windows Event ID 4929
  - Network traffic flows at network chokepoints and Directory Service replication logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: RUN DBSCAN on AD replication network logs. ALERT on connections classified as 'noise' or belonging to a small, anomalous cluster.
- question: Has a non-DC host requested a Kerberos ticket for a DC-specific service like the Directory Replication Service?
  context: |
    Certain Service Principal Names (SPNs), like the one for the Directory Replication Service (DRSUAPI) or Global Catalog (GC), should only be requested by other Domain Controllers. A Kerberos Ticket-Granting Service (TGS) request (Event ID 4769) for one of these SPNs coming from a client that is not on the authorized DC allowlist is a major red flag for a rogue DC attempt.
  answer_sources:
  - Windows Event ID 4769
  - Zeek krb.log
  - Security event logs on all Domain Controllers and Kerberos network traffic captured at network chokepoints.
  range: last 90 days
  queries:
  - pseudocode: SEARCH kerberos_logs WHERE event_id = 4769 AND (service_name = 'E3514235-4B06-11D1-AB04-00C04FC2DCD2' OR service_name STARTSWITH 'GC/') AND client_address NOT IN DC_allowlist
- question: Has a non-DC host requested an SPN that is statistically known to be used almost exclusively by Domain Controllers?
  context: |
    This question moves beyond a hardcoded list of SPNs and uses a data-driven approach. By analyzing historical Kerberos request data, we can identify a set of SPNs that are almost never requested by non-DC hosts. An alert is generated if a workstation or member server requests an SPN from this statistically-derived 'DC-only' set, indicating anomalous and potentially malicious behavior.
  answer_sources:
  - Windows Event ID 4769
  - Zeek krb.log
  - Security event logs on all Domain Controllers and Kerberos network traffic captured at network chokepoints.
  range: last 90 days
  queries:
  - pseudocode: IDENTIFY 'DC-only' SPNs based on historical request frequency. SEARCH kerberos_logs WHERE client_is_not_DC AND requested_spn IN 'DC-only' set.
- question: Did a peer group analysis model detect a host requesting an SPN that is a statistical outlier for its role?
  context: |
    Hosts can be grouped by their role (e.g., DCs, workstations, web servers), and each group will have a normal pattern of SPN requests. Peer group analysis models these patterns. An alert is generated when a host behaves differently from its peers, for example, a member server requesting a replication-related SPN that is normally only requested by the DC peer group.
  answer_sources:
  - Windows Event ID 4769
  - Zeek krb.log
  - Security event logs on all Domain Controllers and Kerberos network traffic captured at network chokepoints.
  range: last 90 days
  queries:
  - pseudocode: SEARCH ML_alerts WHERE model_name = 'SPN_Peer_Group_Analysis' AND prediction = 'outlier'
- question: Has a new nTDSDSA object been created in the Active Directory Configuration partition?
  context: |
    The creation of an nTDSDSA object is a mandatory step for registering a new, legitimate domain controller. This is an extremely rare event that should only happen during a planned DC promotion. An unexpected creation of this object, identified by monitoring Windows Event ID 5137 for an object class of 'nTDSDSA', is a critical indicator of a rogue DC being registered.
  answer_sources:
  - Windows Event ID 5137
  - Active Directory configuration partition, monitored via Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: SEARCH AD_change_logs WHERE event_id = 5137 AND object_class = 'nTDSDSA'
- question: Does the count of nTDSDSA object creations deviate from a zero-baseline without a corresponding change management record?
  context: |
    In a stable environment, the number of new nTDSDSA objects created should be zero. This question formalizes that expectation into a baseline. Any non-zero count of nTDSDSA object creations that cannot be correlated with a scheduled and approved DC promotion in change management systems should be treated as a high-severity incident.
  answer_sources:
  - Windows Event ID 5137
  - Active Directory configuration partition, monitored via Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: COUNT nTDSDSA creations FROM AD_change_logs. ALERT if count > 0 AND NOT found_in_change_management_records.
- question: Has an anomaly detection model flagged the creation of an nTDSDSA object as suspicious based on its attributes?
  context: |
    Even if an nTDSDSA object creation is expected, the context of its creation can be anomalous. A machine learning model can analyze attributes like which user principal created the object and when it was created. An object created by a standard user account instead of a designated service/admin account, or outside a planned maintenance window, would be flagged as a high-confidence anomaly.
  answer_sources:
  - Windows Event ID 5137
  - Active Directory configuration partition, monitored via Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: SEARCH ML_alerts WHERE model_name = 'AD_Config_Object_Anomaly_Detector' AND object_class = 'nTDSDSA' AND prediction = 'anomaly'
- question: Have critical Active Directory objects been modified, such as the krbtgt password or membership of privileged groups?
  context: |
    A common goal of a rogue DC attack is to inject malicious changes, such as resetting the krbtgt account password (to create golden tickets) or adding accounts to Domain Admins. This question focuses on creating high-fidelity alerts for the modification of these specific, critical objects and attributes, which should be immediately investigated.
  answer_sources:
  - Windows Event ID 5136
  - Windows Event ID 4738
  - Windows Event ID 4732
  - Windows Event ID 4756
  - Security and Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: SEARCH AD_change_logs WHERE (event_id = 5136 AND object = 'krbtgt' AND attribute = 'msDS-KeyVersionNumber') OR (event_id IN (4732, 4756) AND group_name IN ('Domain Admins', 'Enterprise Admins'))
- question: Has any single Domain Controller been the source of an anomalously high number of AD object modifications in a short time frame?
  context: |
    When a rogue DC injects changes, they are replicated from a single source DC to the rest of the environment. This can cause a sudden burst of modification events originating from that one source. By baselining the normal hourly rate of modifications for each DC, we can detect a statistically significant spike (e.g., >4 standard deviations) that indicates a possible injection of malicious changes.
  answer_sources:
  - Windows Event ID 5136
  - Windows Event ID 4738
  - Windows Event ID 4732
  - Windows Event ID 4756
  - Security and Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: CALCULATE hourly AD modification count per source DC. ALERT if count > (moving_average + 4 * stdev) for any DC.
- question: Did the overall volume of AD object modifications across the entire domain significantly deviate from forecasted levels?
  context: |
    This question takes a domain-wide view. A time-series forecasting model (like SARIMA) can predict the expected number of AD modifications for a given time period based on historical patterns and seasonality. A large, unexpected spike in the total number of modifications across all DCs that falls outside the model's prediction interval is a strong indicator of a large-scale change event, potentially a malicious one.
  answer_sources:
  - Windows Event ID 5136
  - Windows Event ID 4738
  - Windows Event ID 4732
  - Windows Event ID 4756
  - Security and Directory Service Changes logs on all Domain Controllers.
  range: last 90 days
  queries:
  - pseudocode: FORECAST expected AD modification volume. ALERT if observed_volume is outside the prediction_interval.