name: 'T1584.001: Domains'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: |
  This playbook helps determine if an adversary has registered, hijacked, or otherwise compromised domains that mimic an organization's identity to support malicious operations. It focuses on detecting connections to known malicious domains from threat intelligence, identifying queries for visually or structurally similar domains (typosquats, homographs, combosquats), discovering evidence of domain shadowing through anomalous subdomain activity, identifying potential DNS hijacking by monitoring for unauthorized IP resolutions, and flagging domains that exhibit a combination of multiple suspicious attributes simultaneously (e.g., newly registered, low TTL, very recent SSL certificate).
type: 'technique'
related:
  - 'TA0042: Resource Development'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: "Are internal hosts querying or connecting to domains identified as malicious by threat intelligence feeds?"
    context: |
      This question aims to detect direct communication with known-bad infrastructure, such as command and control (C2) servers, hijacked domains, or newly registered domains (NRDs) often used in phishing. Matching against curated threat intelligence lists is a high-fidelity method for identifying potential compromises or initial access attempts.
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Windows Event ID 5156"
      - "Enterprise DNS resolvers"
      - "Outbound web proxies and firewalls"
      - "Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dns_logs OR connection_logs WHERE domain IN threat_intel_blocklist"
  - question: "Is a newly registered domain (NRD) from a threat feed receiving an unusually high number of connections from unique internal hosts, suggesting a coordinated event?"
    context: |
      Adversaries often use NRDs for short-lived campaigns. A sudden spike in connections from many internal hosts to a single NRD shortly after its registration can indicate a widespread, coordinated attack, such as a phishing campaign where many users click a link simultaneously. This helps differentiate targeted attacks from isolated clicks.
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Windows Event ID 5156"
      - "Enterprise DNS resolvers"
      - "Outbound web proxies and firewalls"
      - "Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH connections_to_NRD in first_24h_of_registration | COUNT unique source_ip | COMPARE count to 95th_percentile_baseline"
  - question: "Can we use machine learning to score and prioritize alerts from threat intelligence matches based on connection characteristics?"
    context: |
      Threat intelligence feeds can generate a high volume of alerts, including false positives. This question proposes using a machine learning model (Random Forest) to analyze various features of a connection (e.g., domain age, data transfer volume, connection duration) to assign a probability score. This allows analysts to focus their efforts on the highest-risk alerts, improving efficiency.
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Windows Event ID 5156"
      - "Enterprise DNS resolvers"
      - "Outbound web proxies and firewalls"
      - "Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT threat_intel_match_features (domain_age, connection_count, bytes_transferred) | APPLY random_forest_model | OUTPUT maliciousness_score"
  - question: "Are hosts querying for domains that combine our organization's name with suspicious keywords, suggesting a combosquatting attack?"
    context: |
      Combosquatting involves registering domains that add words like 'login,' 'support,' or 'hr' to a legitimate domain (e.g., 'yourcompany-support.com'). This analytic checks DNS queries against an allow-list of known good domains and uses regular expressions to find these combosquatting patterns, which are often used for phishing or credential theft.
    answer_sources:
      - "Zeek dns.log"
      - "Certificate Transparency Logs"
      - "Enterprise DNS resolvers"
      - "Certificate Transparency log aggregators"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dns_logs WHERE domain NOT IN org_allowlist AND domain MATCHES combosquat_regex_patterns"
  - question: "Are hosts querying for domains that are structurally very similar to our domains (typosquats) or use visually deceptive characters (homographs)?"
    context: |
      This question targets two types of domain impersonation. Typosquatting relies on misspellings (e.g., 'gogle.com'). Homograph attacks use characters from different alphabets that look identical (e.g., Cyrillic 'Ð°' for Latin 'a'). By calculating string distance (Damerau-Levenshtein) and character randomness (Shannon entropy), we can programmatically detect these subtle but effective impersonation techniques.
    answer_sources:
      - "Zeek dns.log"
      - "Certificate Transparency Logs"
      - "Enterprise DNS resolvers"
      - "Certificate Transparency log aggregators"
    range: "last 90 days"
    queries:
      - "pseudocode: FOREACH domain NOT IN org_allowlist | CALCULATE levenshtein_distance to nearest_allowlist_domain | IF distance <= 2 OR shannon_entropy is high with punycode, ALERT"
  - question: "Can a machine learning model be trained to predict the likelihood that a newly observed domain is a typosquat?"
    context: |
      This moves beyond simple rules to a more sophisticated, predictive approach. By training a model on features of known legitimate and typosquatted domains (like character patterns, string distance, and keyword presence), the system can score any new, non-allow-listed domain in real-time. This provides a probabilistic assessment, helping to identify novel or complex typosquatting attempts that rules might miss.
    answer_sources:
      - "Zeek dns.log"
      - "Certificate Transparency Logs"
      - "Enterprise DNS resolvers"
      - "Certificate Transparency log aggregators"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT new_domain_features (n_grams, char_ratio, levenshtein_distance) | APPLY logistic_regression_model | OUTPUT typosquat_probability"
  - question: "Is there DNS activity for subdomains of our company-owned domains that are not part of our official, inventoried list?"
    context: |
      Domain shadowing occurs when an adversary compromises a domain's DNS records to create malicious subdomains under a legitimate, trusted domain. This question aims to detect this by comparing all observed subdomain queries against a master inventory of known, valid subdomains. A query for an unknown subdomain is a strong indicator of a potential compromise of the domain's DNS management.
    answer_sources:
      - "Zeek dns.log"
      - "Windows Event ID 22"
      - "Public-facing DNS records"
      - "Internal DNS resolvers"
      - "Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dns_queries for company_domains | FOREACH query | IF subdomain NOT IN known_subdomain_inventory, ALERT"
  - question: "Do any non-inventoried subdomains exhibit a high degree of randomness, suggesting they are algorithmically generated for C2 communications?"
    context: |
      Adversaries using domain shadowing often use Domain Generation Algorithms (DGAs) to create a large number of random-looking subdomains for C2. This question focuses on identifying these by measuring the character randomness (Shannon entropy) of any newly discovered subdomain. A score significantly higher than the baseline for legitimate subdomains is a strong signal of DGA activity.
    answer_sources:
      - "Zeek dns.log"
      - "Windows Event ID 22"
      - "Public-facing DNS records"
      - "Internal DNS resolvers"
      - "Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: FOREACH unknown_subdomain | CALCULATE shannon_entropy | IF entropy > 98th_percentile_of_legit_subdomains, ALERT"
  - question: "Has there been an anomalous spike in the rate of discovery of new, previously unseen subdomains for our domains?"
    context: |
      This question uses time-series analysis to establish a normal baseline for how often new, legitimate subdomains are created. A sudden, sharp increase in the number of new subdomains appearing within a short time frame would deviate significantly from this baseline. Such a spike could indicate that an adversary has activated a large number of shadowed subdomains for a campaign, providing an early warning of active malicious use.
    answer_sources:
      - "Zeek dns.log"
      - "Windows Event ID 22"
      - "Public-facing DNS records"
      - "Internal DNS resolvers"
      - "Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: MODEL new_subdomain_rate_per_hour | FORECAST prediction_interval | IF current_rate > 99%_prediction_interval, ALERT"
  - question: "Are any of our company-owned domains resolving to IP addresses outside of our organization's approved IP space?"
    context: |
      This is a direct check for DNS hijacking. By maintaining an allow-list of all legitimate IP addresses and CIDR blocks for company domains, any DNS response that points to an unauthorized IP is a critical indicator that the domain's DNS record has been maliciously altered. This could be redirecting users to a malicious site or intercepting traffic like email.
    answer_sources:
      - "Zeek dns.log"
      - "External DNS Monitoring Service Logs"
      - "Internal DNS resolvers"
      - "External DNS monitoring services (e.g., distributed probes)"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH dns_responses for company_domains | IF resolved_ip NOT IN approved_ip_allowlist, TRIGGER_CRITICAL_ALERT"
  - question: "Are our critical domains suddenly resolving from new or unexpected network locations (ASNs) or countries?"
    context: |
      Beyond just the IP address, the network context (like the Autonomous System Number and geographic location) provides a stable baseline. A legitimate domain will typically resolve from a predictable set of hosting providers and countries. A sudden shift to a completely new ASN or country, especially one with a poor reputation, is a strong signal of a hijack, even if the IP itself is unknown.
    answer_sources:
      - "Zeek dns.log"
      - "External DNS Monitoring Service Logs"
      - "Internal DNS resolvers"
      - "External DNS monitoring services (e.g., distributed probes)"
    range: "last 90 days"
    queries:
      - "pseudocode: BASELINE historical_asn_and_country for critical_domains | MONITOR current_resolutions | IF new_asn OR new_country NOT IN baseline, ALERT"
  - question: "Can an anomaly detection model identify DNS resolutions for our critical domains that are statistically different from historical norms?"
    context: |
      This question proposes using an unsupervised machine learning model (like Isolation Forest) to learn the normal patterns of DNS resolutions for critical domains, considering features like the IP, ASN, country, and TTL value. The model can then flag any new resolution that is a statistical outlier from this learned norm. This can detect subtle or novel hijacking techniques that might not be caught by static rules.
    answer_sources:
      - "Zeek dns.log"
      - "External DNS Monitoring Service Logs"
      - "Internal DNS resolvers"
      - "External DNS monitoring services (e.g., distributed probes)"
    range: "last 90 days"
    queries:
      - "pseudocode: TRAIN isolation_forest_model on historical_dns_data (ip, asn, country, ttl) | SCORE live_dns_resolutions | IF anomaly_score > threshold, ALERT"
  - question: "Are internal hosts connecting to a domain that is new to our environment, has a very recent SSL certificate, and uses a low DNS TTL value?"
    context: |
      Adversaries often set up infrastructure just before an attack. This combination of attributes is highly suspicious: a new domain (first time seen), a fresh SSL certificate (often free and automated), and a low TTL (allowing for quick changes to evade blocking). Correlating these individual, weaker signals into a single, high-confidence alert is an effective way to detect newly staged malicious infrastructure.
    answer_sources:
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Zeek conn.log"
      - "Zeek x509.log"
      - "Outbound web proxies and firewalls"
      - "Certificate Transparency logs"
      - "Enterprise DNS resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH for connections WHERE (is_new_domain AND cert_age < 72h AND dns_ttl < 300s)"
  - question: "Can we create a composite risk score for new connections by combining multiple suspicious attributes to identify the highest-risk activity?"
    context: |
      Rather than a binary alert, this question proposes a flexible risk-scoring system. By assigning points to various suspicious indicators (e.g., domain age, certificate issuer, TTL value, domain name randomness), we can calculate a total risk score for every new connection. This allows for more nuanced detection and prioritization, as analysts can focus on connections that accumulate the highest scores, representing the most suspicious activity.
    answer_sources:
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Zeek conn.log"
      - "Zeek x509.log"
      - "Outbound web proxies and firewalls"
      - "Certificate Transparency logs"
      - "Enterprise DNS resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: FOREACH new_connection | CALCULATE risk_score (weighted_sum_of_attributes) | IF score > 99th_percentile_of_historical_scores, ALERT"
  - question: "Can we use unsupervised clustering to automatically group newly observed domains and identify clusters that exhibit malicious characteristics?"
    context: |
      This question leverages unsupervised machine learning (DBSCAN) to discover patterns without pre-existing labels. By grouping new domains based on their features (TTL, cert age, entropy, etc.), the system can identify natural clusters. An analyst can then investigate and label these clusters (e.g., 'benign SaaS services', 'suspicious DGA-like domains'). Once labeled, any new domain falling into a 'suspicious' cluster can be automatically flagged, effectively automating the discovery of new threat patterns.
    answer_sources:
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Zeek conn.log"
      - "Zeek x509.log"
      - "Outbound web proxies and firewalls"
      - "Certificate Transparency logs"
      - "Enterprise DNS resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: FEATURIZE new_domains (ttl, cert_age, entropy) | APPLY DBSCAN clustering | IF domain in suspicious_cluster, ALERT"