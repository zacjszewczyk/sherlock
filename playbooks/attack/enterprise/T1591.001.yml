name: T1591.001: Determine Physical Locations
id: 5a8a1b9e-6b7c-4d3e-8f9a-0c1d2e3f4a5b
description: This playbook helps investigate whether an adversary is conducting reconnaissance to determine the organization's physical locations. This involves detecting external scanning from known malicious IPs and automated tools, anomalous internal DNS queries to geolocation services, unusual access to internal files containing location data (e.g., blueprints, address lists), and suspicious process chains involving network connections to mapping websites.
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are known malicious IP addresses from threat intelligence feeds connecting to our public-facing web servers?
    context: This question seeks to identify direct reconnaissance probes from known adversaries. Matching inbound traffic against a CTI feed is a high-fidelity method for detecting the earliest stages of a targeted attack. A successful match indicates that a malicious actor is actively mapping our external infrastructure.
    answer_sources:
      - Zeek conn.log
      - Cyber Threat Intelligence (CTI) feeds
      - Network sensors at the internet egress/ingress point (e.g., DMZ)
      - logs from public-facing web servers and load balancers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          JOIN zeek_conn_logs ON source_ip WITH cti_feed ON malicious_ip.
          ALERT if destination_ip is a public asset AND destination_port is 80 or 443.
  - question: Is there an anomalous increase in the percentage of inbound web traffic originating from known malicious IPs?
    context: This question aims to detect broader, potentially coordinated reconnaissance campaigns that might not be caught by single-connection alerts. A significant spike in the proportion of traffic from malicious sources, compared to a historical baseline, suggests a concerted effort to scan or probe our systems.
    answer_sources:
      - Zeek conn.log
      - Cyber Threat Intelligence (CTI) feeds
      - Network sensors at the internet egress/ingress point (e.g., DMZ)
      - logs from public-facing web servers and load balancers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE daily percentage of connections from CTI-listed IPs.
          COMPARE to 30-day rolling baseline.
          ALERT if daily_percentage > 95th_percentile_of_baseline.
  - question: Can we use a machine learning model to predict which inbound web connections are likely reconnaissance activity?
    context: This question leverages machine learning to move beyond simple signatures and baselines. By training a model on various connection features (CTI match, ASN, geolocation, frequency), we can identify complex patterns indicative of reconnaissance that might otherwise be missed. This provides a more nuanced, probabilistic approach to detecting sophisticated threats.
    answer_sources:
      - Zeek conn.log
      - Cyber Threat Intelligence (CTI) feeds
      - ASN and Geolocation databases
      - Network sensors at the internet egress/ingress point (e.g., DMZ)
      - logs from public-facing web servers and load balancers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each inbound connection, SCORE with classification model using features (CTI_match, ASN, geolocation, time_of_day, frequency).
          ALERT if score > 0.8.
  - question: Are inbound HTTP requests using User-Agent strings associated with known reconnaissance or scanning tools?
    context: This question focuses on identifying attackers by the tools they use. Many reconnaissance tools (like Nmap, sqlmap, etc.) use default or recognizable User-Agent strings. Scanning for these signatures in HTTP logs is a straightforward and effective way to detect automated scanning activity against our web applications.
    answer_sources:
      - Zeek http.log
      - Public-facing web application servers
      - Web application firewalls (WAFs)
      - Reverse proxy servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH zeek_http_logs for user_agent matching known recon tool strings (e.g., 'nmap', 'sqlmap', 'Recon-ng', 'FOCA').
          ALERT on match.
  - question: Are any source IPs exhibiting behavior of high-volume, low-variety URI requests, indicative of automated directory scanning?
    context: This question seeks to identify automated scanning behavior by its statistical properties. Scanners often make many requests for a limited set of common file or directory names (low URI entropy), unlike human users who browse diverse pages. Combining this with a high request count helps pinpoint brute-force scanning of web content.
    answer_sources:
      - Zeek http.log
      - Public-facing web application servers
      - Web application firewalls (WAFs)
      - Reverse proxy servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each source_ip in a 5-min window, CALCULATE URI_entropy and request_count.
          ALERT if URI_entropy is in bottom 5th percentile AND request_count is in top 5th percentile of all source IPs.
  - question: Is there a statistically significant and anomalous spike in the overall HTTP request volume to our public web applications?
    context: This question aims to detect large-scale reconnaissance or denial-of-service attempts by monitoring the overall traffic volume. A time series model learns the normal rhythm of web traffic. A sudden, unexpected spike that breaks this pattern is a strong indicator of anomalous activity, such as a coordinated scan, that requires investigation.
    answer_sources:
      - Zeek http.log
      - Public-facing web application servers
      - Web application firewalls (WAFs)
      - Reverse proxy servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FORECAST expected request volume using time series model.
          ALERT if actual volume > upper confidence bound.
          ENRICH alert with top requested URIs during the anomaly.
  - question: Is any internal host connecting to an unusually high number of external geolocation or mapping services in a short time frame?
    context: This question is designed to detect internal reconnaissance, where an adversary who has already gained a foothold uses an internal machine to gather information about physical locations. A sudden burst of connections to many different mapping or public records sites from a single host is highly abnormal for a typical user.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Internal DNS resolvers
      - network traffic from user subnets
      - egress filtering points
      - web proxy logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          COUNT unique domains from a 'location-recon' watchlist contacted by each internal host in a 1-hour window.
          ALERT if count > 10.
  - question: Has any internal host shown a statistically significant deviation from its own baseline behavior regarding connections to location-reconnaissance domains?
    context: This question provides a more tailored approach to detecting internal reconnaissance by profiling each host's individual 'normal' behavior. It alerts when a host's activity is a major statistical outlier compared to its own history. This helps reduce false positives in environments where some limited access is normal.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Internal DNS resolvers
      - network traffic from user subnets
      - egress filtering points
      - web proxy logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each host, CALCULATE daily Z-score for (a) DNS queries to watchlist and (b) bytes sent to watchlist IPs, based on its 30-day baseline.
          ALERT if Z-score > 3.
  - question: Can we identify outlier internal hosts by clustering them based on their network traffic patterns to external location-related services?
    context: This question uses unsupervised machine learning to find the 'odd one out.' By grouping all hosts based on their network behavior, most users will form a large 'normal' cluster. Hosts that are behaving differently—the potential malicious actors—will form their own small, separate clusters, making them easy to identify for investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Internal DNS resolvers
      - network traffic from user subnets
      - egress filtering points
      - web proxy logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CLUSTER all internal hosts using DBSCAN/K-Means on features like (DNS_queries_to_watchlist, bytes_sent, unique_IPs, avg_duration).
          FLAG hosts in small, distinct clusters for investigation.
  - question: Is any user account rapidly accessing multiple sensitive files containing physical location information?
    context: This question aims to detect a 'smash and grab' data theft scenario. A user accessing several distinct, sensitive files (like blueprints or address lists) in a very short period is highly irregular and likely indicates a malicious attempt to collect this information.
    answer_sources:
      - Windows Event ID 4663
      - File servers hosting Facilities, Security, or HR data
      - SharePoint sites for corporate planning
      - Domain Controllers for audit policies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ENABLE auditing on tagged sensitive files.
          COUNT accesses (Event ID 4663) per user to these files in a 10-minute window.
          ALERT if count > 3.
  - question: Is any user accessing sensitive location files significantly more than their own past behavior and that of their peers?
    context: This question detects insider threats or compromised accounts by using a dual-baseline approach. It flags users who not only deviate from their own normal access patterns but also from the collective norm of their department or role. This helps distinguish legitimate work from truly anomalous behavior.
    answer_sources:
      - Windows Event ID 4663
      - File servers hosting Facilities, Security, or HR data
      - SharePoint sites for corporate planning
      - Domain Controllers for audit policies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each user, COMPARE daily access count to sensitive files against (a) user's own 99th percentile and (b) user's peer group's 99th percentile.
          ALERT if both are exceeded.
  - question: Can we use a machine learning model to identify anomalous file access patterns for users who legitimately handle location data?
    context: This question addresses the challenge of monitoring users who regularly access sensitive files. By training a model on the nuances of their normal behavior (e.g., which files they access, at what time), we can detect subtle deviations that might indicate their account is compromised or they are acting maliciously.
    answer_sources:
      - Windows Event ID 4663
      - File servers hosting Facilities, Security, or HR data
      - SharePoint sites for corporate planning
      - Domain Controllers for audit policies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each user group, TRAIN an anomaly detection model on normal file access patterns (time, frequency, specific files).
          SCORE new access events against the model. ALERT on events flagged as outliers.
  - question: Is a process spawned from a document or script (e.g., Office, PowerShell) immediately making network connections to location-related websites or accessing sensitive location files?
    context: This question looks for a common attack pattern where a malicious document or script is the initial infection vector. A legitimate application like Word should not typically spawn a process that immediately starts looking up mapping websites or facility blueprints. Correlating these events provides strong evidence of a post-exploitation payload.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek conn.log
      - User endpoints
      - Critical application servers
      - Virtual Desktop Infrastructure (VDI) instances
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CORRELATE events. TRIGGER if (Event 4688 with parent 'winword.exe', 'excel.exe', 'powershell.exe') is followed within 60s by (Zeek conn to recon-watchlist OR Event 4663 on sensitive file) from the same host.
  - question: Are we observing statistically rare and therefore suspicious chains of events, such as a specific parent process creating a child process that connects to a specific network destination?
    context: This question uses frequency analysis to find novel and suspicious behavior chains. An event chain that has never or very rarely been seen before is highly suspicious. This method can uncover new attack techniques without prior signatures.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - User endpoints
      - Critical application servers
      - Virtual Desktop Infrastructure (VDI) instances
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CALCULATE historical probability of all (parent_process, child_process, network_destination) combinations.
          ALERT if a newly observed combination has a probability < 0.001%.
  - question: Can graph analysis reveal anomalous pathways of interaction between processes, files, and network destinations that indicate reconnaissance?
    context: This question applies graph theory to model system activity. This analytical model can reveal complex, multi-step attack paths that are difficult to see with simple correlation rules. For example, a path like 'Word -> PowerShell -> maps.google.com' would stand out as a structurally anomalous graph.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek conn.log
      - User endpoints
      - Critical application servers
      - Virtual Desktop Infrastructure (VDI) instances
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BUILD behavior graph with (process, file, network) nodes and interaction edges.
          USE graph anomaly detection to identify and ALERT on rare or suspicious paths (e.g., winword.exe -> powershell.exe -> maps.googleapis.com).