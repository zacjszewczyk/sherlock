name: 'T1129: Shared Modules'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: 'This playbook helps to determine if an adversary has executed malicious code by loading a shared module. It investigates module loads that are suspicious due to several factors: the module hash or signature matches threat intelligence; the module is loaded from a high-risk, user-writable, or statistically rare file path; a sensitive system process loads a module that is unusual for that process; the module is loaded almost immediately after being created on disk, particularly by a browser or script interpreter; or a process makes an external network connection shortly after loading a suspicious module.'
type: 'technique'
related:
  - 'TA0002: Execution'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Have any modules been loaded that match known malicious hashes or are signed by untrusted entities?'
    context: 'This question aims to detect the execution of known malware or tools from threat actors by comparing loaded modules against threat intelligence feeds. A match is a high-fidelity indicator of compromise.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 7'
      - 'Enterprise Workstations and Servers'
      - 'Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'SEARCH Sysmon Event ID 7 WHERE (module_hash IN threat_intel_hashes) OR (module_signer IN threat_intel_signers)'
  - question: 'Has a module been loaded from a signer that is extremely rare across the enterprise?'
    context: 'Legitimate software is typically signed by common, well-known vendors. A module signed by an entity that has rarely or never been seen before is suspicious and could indicate a custom malware or an unauthorized tool. This helps find unknown threats not yet in threat intelligence feeds.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Enterprise Workstations and Servers'
      - 'Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'CALCULATE prevalence of each module_signer over 30 days. ALERT where current module_signer_prevalence < 1st_percentile.'
  - question: 'Does a loaded module''s metadata receive a high maliciousness score from a classification model?'
    context: 'This question leverages machine learning to score module load events based on various features like signature status, signer identity, and path characteristics. It provides a probabilistic assessment of risk, capable of detecting novel threats that mimic legitimate software but have subtle anomalous properties.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Enterprise Workstations and Servers'
      - 'Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'APPLY classification model to Sysmon Event ID 7 metadata. ALERT where malicious_score > threshold.'
  - question: 'Have any unsigned or invalidly signed modules been loaded from high-risk locations like network shares or user-writable directories?'
    context: 'Adversaries often place malicious DLLs in non-standard, writable locations to bypass protections. This question specifically looks for unsigned modules loaded from paths like Temp, AppData, or network shares, which is a common TTP for malware droppers and lateral movement.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 11'
      - 'Enterprise Workstations and Servers'
      - 'Network File Shares'
    range: 'last 90 days'
    queries:
      - 'SEARCH Sysmon Event ID 7 WHERE (image_path MATCHES high_risk_patterns) AND (signature_status IS NOT ''Valid'')'
  - question: 'Is any process loading modules from high-risk locations at a rate that is a significant statistical deviation from its normal behavior?'
    context: 'While some legitimate processes might occasionally load from a user profile, a sudden or significant increase in this activity for a specific process can indicate it has been compromised or is being used as part of an attack chain. This helps detect abnormal behavior even in otherwise legitimate processes.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 11'
      - 'Enterprise Workstations and Servers'
      - 'Network File Shares'
    range: 'last 90 days'
    queries:
      - 'CALCULATE z-score for frequency of loads from high-risk paths per process. ALERT where z-score > 3.0.'
  - question: 'Has a time-series anomaly detection model detected a sudden spike in module loads from high-risk paths on any given host?'
    context: 'This question uses a host-centric view to detect anomalies. A sudden burst of module loads from unusual directories on a single machine can signal a malware infection or the execution of a toolkit, even if the individual events don''t appear malicious in isolation.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 11'
      - 'Enterprise Workstations and Servers'
      - 'Network File Shares'
    range: 'last 90 days'
    queries:
      - 'APPLY time-series anomaly detection to count of module loads from high-risk paths per host. ALERT on significant deviation from norm.'
  - question: 'Has an unsigned module been loaded from a directory that is not on the standard allow-list of system and program file paths?'
    context: 'This question focuses on identifying modules loaded from unexpected locations by using an allow-list of known-good directories. An unsigned module loading from anywhere else is highly suspicious and warrants investigation.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'SEARCH Sysmon Event ID 7 WHERE (module_directory NOT IN allow_list) AND (signature_status IS ''false'')'
  - question: 'Is any process showing a sudden, significant increase in the diversity of its module load paths?'
    context: 'Processes typically load modules from a predictable set of directories. A sudden increase in the entropy or diversity of these paths suggests the process may be compromised and is being forced to load libraries from disparate, potentially malicious locations on the filesystem.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'CALCULATE Shannon entropy of module load paths per process. ALERT where entropy increases > 2 standard deviations from baseline.'
  - question: 'Has a clustering algorithm identified a module load event as an outlier based on its process-path combination?'
    context: 'This question uses unsupervised machine learning to find rare combinations of processes and the paths they load modules from. An outlier represents a combination that has not been seen during the model''s training on normal activity, making it a strong candidate for investigation.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'APPLY DBSCAN clustering to (process_name, module_load_path) vectors. INVESTIGATE any event classified as a noise point/outlier.'
  - question: 'Has a module file (.dll, .so, .dylib) been loaded within 5 minutes of its creation, especially if created by a browser, office app, or script interpreter?'
    context: 'This is a classic pattern for ''dropper'' malware. A process (like a browser or Word document) writes a malicious DLL to disk and then another process immediately loads it to execute the payload. This correlation is a high-fidelity indicator of malicious activity.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 11'
      - 'Sysmon Event ID 1'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'CORRELATE Sysmon EID 11 (FileCreate) and EID 7 (ImageLoad) for the same file within 5 minutes on the same host. RAISE severity if creating process is a browser, office app, or script interpreter.'
  - question: 'Has a module load occurred with a time-to-load (from file creation) that is in the 1st percentile, indicating an extremely fast write-to-load event?'
    context: 'Legitimate software updates might involve writing and then loading a DLL, but this often happens with a delay or during a specific maintenance window. An extremely short time delta between file creation and module load is statistically anomalous and characteristic of malware execution.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 11'
      - 'Sysmon Event ID 1'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'CALCULATE time delta between file creation (EID 11) and module load (EID 7). ALERT if delta is in the 1st percentile (shortest times).'
  - question: 'Has a sequence analysis model detected a low-probability chain of events, such as a browser creating a DLL that is then loaded by a system process?'
    context: 'This question looks beyond simple two-event correlation to analyze entire chains of activity. A sequence of events that is highly improbable based on models trained on normal behavior (e.g., chrome.exe -> file create -> svchost.exe -> image load) strongly suggests a multi-stage attack.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 11'
      - 'Sysmon Event ID 1'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'APPLY sequence analysis model (HMM) to event chains. ALERT on low-probability sequences like browser -> file_create -> system_process -> image_load.'
  - question: 'Has a hyper-sensitive process like lsass.exe or csrss.exe loaded a module that is not on its strict, pre-defined allow-list?'
    context: 'Processes like LSASS are critical to system security and have a very stable and predictable set of modules they should load. Any deviation from this, such as loading an unknown DLL, is a major red flag and could indicate credential dumping or other advanced attacks.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Windows Security Event ID 4688'
      - 'Critical Servers (e.g., Domain Controllers, Certificate Authorities)'
      - 'Enterprise Workstations'
    range: 'last 90 days'
    queries:
      - 'SEARCH for module loads by lsass.exe or csrss.exe. ALERT if loaded module path is NOT in the golden image allow-list.'
  - question: 'Has a sensitive process like svchost.exe loaded a module that is rarely or never seen being loaded by that process during a baseline period?'
    context: 'While svchost.exe hosts many different services and loads many DLLs, each service has a relatively stable set. A svchost instance loading a module that is statistically rare for its group is suspicious and could be a sign of DLL hijacking or a malicious service being installed.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Windows Security Event ID 4688'
      - 'Critical Servers (e.g., Domain Controllers, Certificate Authorities)'
      - 'Enterprise Workstations'
    range: 'last 90 days'
    queries:
      - 'CALCULATE frequency map of modules loaded by svchost.exe over 30 days. ALERT if a loaded module''s frequency is in the bottom 5th percentile.'
  - question: 'Did an autoencoder model flag a module load by a sensitive process as anomalous due to a high reconstruction error?'
    context: 'This question uses an autoencoder to learn the "normal" characteristics of modules loaded by a specific sensitive process. If a newly loaded module has characteristics (like path, signature, entropy) that the model cannot accurately reconstruct, it means the module deviates from the learned norm and is highly suspect.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Windows Security Event ID 4688'
      - 'Critical Servers (e.g., Domain Controllers, Certificate Authorities)'
      - 'Enterprise Workstations'
    range: 'last 90 days'
    queries:
      - 'APPLY autoencoder to module load feature vectors for a sensitive process. ALERT if reconstruction error is high.'
  - question: 'Did a process make an external network connection within 2 minutes of loading an unsigned or high-risk module?'
    context: 'This correlation links suspicious module loading with potential command-and-control (C2) or data exfiltration activity. The sequence of loading an untrusted library and immediately "calling home" is a strong indicator of a malicious implant being activated.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 3'
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Network Egress Points (Firewall, Proxy)'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'CORRELATE Sysmon EID 7 (unsigned/high-risk path) with Sysmon EID 3 (external IP) from the same process within 2 minutes. ENRICH with Zeek data.'
  - question: 'Following a suspicious module load, did the host connect to a domain or Autonomous System Number (ASN) that is statistically rare for the enterprise?'
    context: 'After detecting a suspicious load, this question helps qualify the subsequent network traffic. Connections to rarely seen domains (e.g., from newly registered or obscure TLDs) or ASNs are often associated with C2 infrastructure, adding weight to the initial alert.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 3'
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Network Egress Points (Firewall, Proxy)'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'POST-ALERT, query network logs for host. CALCULATE rarity of destination ASN and domain suffix. FLAG if rarity is in 1st percentile.'
  - question: 'After loading a suspicious module, did the process''s network activity significantly exceed its forecasted volume or diversity?'
    context: 'This question uses a time-series model to understand a process''s normal network "heartbeat". A significant, un-forecasted spike in network connections following a suspicious module load suggests the newly loaded code is performing an action, such as downloading a second stage or exfiltrating data.'
    answer_sources:
      - 'Sysmon Event ID 7'
      - 'Sysmon Event ID 3'
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'Network Egress Points (Firewall, Proxy)'
      - 'Enterprise Workstations and Servers'
    range: 'last 90 days'
    queries:
      - 'APPLY time-series forecast to process network activity. ALERT if activity post-suspicious-load significantly exceeds forecast.'