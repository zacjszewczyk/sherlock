name: 'T1590.003: Network Trust Dependencies'
id: a4b1c2d3-e4f5-4a6b-8c7d-9e0f1a2b3c4d
description: The playbook addresses the threat of adversaries conducting reconnaissance to identify an organization's network trust dependencies. It provides investigative questions to detect this activity by monitoring for several key indicators: anomalous network traffic from external or partner IP addresses, such as high connection volumes or deviations from baseline behavior; the execution of specific reconnaissance commands or tools from authenticated partner accounts; network and port scanning patterns characterized by high fan-out or connection failures; DNS-based enumeration techniques like zone transfer requests or high rates of NXDOMAIN responses; and unusual access to a large number of network shares by partner accounts, which may indicate file system enumeration.
type: technique
related:
  - 'TA0043: Reconnaissance'
contributors: Zachary Szewczyk, Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
  - question: Are external source IPs or queried domains matching known threat intelligence feeds for reconnaissance infrastructure?
    context: This question aims to identify if network traffic is originating from or communicating with infrastructure previously identified as malicious or associated with reconnaissance activities. A match against a threat intelligence feed is a strong indicator of a targeted or opportunistic attempt to gather information about the network.
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'NAI: Internet Gateway, Cloud Egress Points, External DNS Resolvers, VPN Concentrators'
    range: last 90 days
    queries:
      - query: SEARCH Zeek conn.log AND dns.log FOR source_ip OR destination_ip OR query_domain IN threat_intel_feed;
  - question: Is an external IP, not on a partner allowlist, communicating with internal resources in a way that deviates from normal partner behavior?
    context: This question helps detect reconnaissance from unknown or potentially masquerading external sources. By comparing their communication patterns (e.g., accessed ports and domains) to the established baseline of legitimate partners, we can identify outliers whose traffic patterns suggest they are not a typical partner and may be performing network discovery. A low similarity score indicates anomalous behavior.
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'NAI: Internet Gateway, Cloud Egress Points, External DNS Resolvers, VPN Concentrators'
    range: last 90 days
    queries:
      - query: COMPARE Jaccard similarity of destination_ports/domains from untrusted_external_IP AGAINST baseline_partner_behavior; ALERT if similarity < threshold;
  - question: Is a known partner or third-party network generating an anomalous volume of traffic, suggesting it might be compromised and used for reconnaissance?
    context: This question addresses the risk of a compromised partner network. Even trusted partners can become a vector for attack. By monitoring the volume of traffic from these partners and comparing it to a predictive model, we can detect significant deviations that could indicate the partner's infrastructure is being used for activities beyond its normal scope, such as large-scale network reconnaissance.
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek dns.log'
      - 'NAI: Internet Gateway, Cloud Egress Points, External DNS Resolvers, VPN Concentrators'
    range: last 90 days
    queries:
      - query: MODEL traffic volume from partner_IPs using ARIMA; ALERT if current_volume > 99% confidence_interval of prediction;
  - question: Is a partner account executing known reconnaissance commands or using reconnaissance tools on the internal network?
    context: This question focuses on detecting active, hands-on-keyboard reconnaissance from a potentially compromised partner account that has gained internal access. The execution of specific commands to enumerate domain trusts, users, and groups is a clear sign of an adversary trying to understand the internal Active Directory environment to plan their next move.
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Zeek http.log'
      - 'NAI: Domain Controllers, ADFS Servers, Partner-accessible Application Servers, Jump Boxes'
    range: last 90 days
    queries:
      - query: SEARCH EventID 4688 OR Zeek http.log FROM partner_accounts/IPs FOR command_line CONTAINS ('nltest', 'net group', 'AdFind') OR user_agent CONTAINS ('Nmap', 'PowerShell-AD-Recon');
  - question: Is a partner account executing commands with unusually high complexity or randomness, deviating from their normal behavior?
    context: This question helps identify sophisticated or obfuscated reconnaissance activity. Adversaries often use complex, one-off commands or scripts that differ from a user's routine activity. High command-line entropy can indicate obfuscation, long argument strings typical of enumeration scripts, or simply the use of unfamiliar tools, all of which warrant investigation for a partner account.
    answer_sources:
      - 'Windows Event ID 4688'
      - 'NAI: Domain Controllers, ADFS Servers, Partner-accessible Application Servers, Jump Boxes'
    range: last 90 days
    queries:
      - query: CALCULATE entropy of command_line for each process from partner_account; ALERT if entropy > 95th_percentile of user_baseline;
  - question: Is a partner account using commands or tools that are anomalous when compared to their historical activity profile?
    context: This question uses machine learning to detect novel and potentially malicious command-line activity that rule-based methods might miss. By training a model on what is "normal" for a partner account, we can flag any new command execution that the model considers an outlier. This is effective for catching new tools or unusual combinations of command arguments used for reconnaissance.
    answer_sources:
      - 'Windows Event ID 4688'
      - 'NAI: Domain Controllers, ADFS Servers, Partner-accessible Application Servers, Jump Boxes'
    range: last 90 days
    queries:
      - query: MODEL tokenized command_lines from partner_accounts using One-Class SVM/Isolation Forest; CLASSIFY new commands; ALERT if outlier;
  - question: Is traffic originating from an IP address known for internet-wide scanning or malicious activity?
    context: This question provides a high-confidence way to identify unwanted reconnaissance. Services like Shodan, Censys, and GreyNoise actively catalog internet scanners. If an IP from one of these lists is connecting to the network, it is almost certainly conducting reconnaissance and should be investigated and likely blocked.
    answer_sources:
      - 'Zeek conn.log'
      - 'NAI: Network Perimeter Firewalls, DMZ Segments, VPN Concentrators, Cloud Security Group Logs'
    range: last 90 days
    queries:
      - query: SEARCH Zeek conn.log for source_ip IN (Shodan, Censys, GreyNoise, internal_blocklist); ALERT on match;
  - question: Is an external IP address exhibiting network or port scanning behavior, characterized by connecting to many unique hosts or ports?
    context: This question aims to detect the classic signature of a network or port scan. A scanner will try to connect to many different IP addresses (high fan-out) or many different ports on one or more IPs (high port entropy). This behavior is fundamentally different from normal traffic. A high rate of failed or rejected connections further strengthens the evidence of a scan.
    answer_sources:
      - 'Zeek conn.log'
      - 'NAI: Network Perimeter Firewalls, DMZ Segments, VPN Concentrators, Cloud Security Group Logs'
    range: last 90 days
    queries:
      - query: CALCULATE fan-out_ratio AND port_entropy for each source_ip in 5min_window; ALERT if metrics > 3_std_dev from baseline;
  - question: Can we identify anomalous source IPs whose connection patterns do not cluster with legitimate traffic?
    context: This question uses unsupervised machine learning to find "weird" traffic that doesn't fit in. Legitimate traffic (e.g., web browsing, email) tends to form large, dense clusters of similar behavior. Scanning, on the other hand, is often sporadic and has unique characteristics, causing it to be flagged as noise or a small, isolated cluster by algorithms like DBSCAN. This can uncover scanning that doesn't trigger simple threshold-based rules.
    answer_sources:
      - 'Zeek conn.log'
      - 'NAI: Network Perimeter Firewalls, DMZ Segments, VPN Concentrators, Cloud Security Group Logs'
    range: last 90 days
    queries:
      - query: CLUSTER Zeek conn.log data using DBSCAN; IDENTIFY source_ips classified as noise or small clusters; ALERT on identification;
  - question: Is an unauthorized host attempting a DNS zone transfer?
    context: This question targets a specific and highly indicative reconnaissance technique. A DNS zone transfer (AXFR/IXFR) is designed to replicate DNS records between servers. An attempt from an unauthorized source is a blatant attempt to dump all DNS records for a domain, providing the adversary with a map of the network's hosts and services.
    answer_sources:
      - 'Zeek dns.log'
      - 'NAI: Authoritative and Recursive DNS Servers, Domain Controllers'
    range: last 90 days
    queries:
      - query: SEARCH Zeek dns.log for query_type IN ('AXFR', 'IXFR') AND source_ip NOT IN authorized_dns_server_list; ALERT on match;
  - question: Is an external source IP making a high volume of DNS queries for non-existent or varied subdomains?
    context: This question seeks to identify DNS enumeration or "subdomain bruteforcing." An adversary trying to discover hidden servers will often query a long list of potential subdomains (e.g., dev.example.com, test.example.com, vpn.example.com). This results in a high rate of "Non-Existent Domain" (NXDOMAIN) responses and high entropy in the queried names, patterns that are highly anomalous for legitimate clients.
    answer_sources:
      - 'Zeek dns.log'
      - 'NAI: Authoritative and Recursive DNS Servers, Domain Controllers'
    range: last 90 days
    queries:
      - query: CALCULATE subdomain_entropy AND nxdomain_ratio for each source_ip in 1min_window; ALERT if metrics > 98th_percentile of baseline;
  - question: Does the sequence and characteristics of DNS queries from a single source match a machine learning model of malicious reconnaissance?
    context: This question leverages a supervised machine learning model to perform a more nuanced classification of DNS traffic. Instead of relying on single metrics, the model can learn the complex interplay of features (query types, timing, name complexity) that distinguish automated reconnaissance tools from normal user or application behavior, allowing for more accurate detection.
    answer_sources:
      - 'Zeek dns.log'
      - 'NAI: Authoritative and Recursive DNS Servers, Domain Controllers'
    range: last 90 days
    queries:
      - query: MODEL DNS query sequences using Random Forest; CLASSIFY real-time DNS streams from source_ips; ALERT if classified as malicious;
  - question: Has any account, particularly a partner account, attempted to access a honeypot network share?
    context: This question describes a high-fidelity detection method using a honeypot. A honeypot is a decoy resource that has no legitimate business purpose. Any interaction with it is, by definition, suspicious. An alert on access to a honeypot share is a strong signal that an adversary is actively enumerating file systems.
    answer_sources:
      - 'Windows Event ID 5140'
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4656'
      - 'NAI: File Servers, SharePoint Sites, Code Repositories accessible by partners'
    range: last 90 days
    queries:
      - query: SEARCH EventIDs (5140, 4656, 4663) for access to honeypot_share_name; ALERT on any match;
  - question: Is a partner account accessing an anomalously high number of distinct network shares in a short period?
    context: This question aims to detect file share enumeration. While a user might access several shares during their normal work, an adversary will often try to browse as many shares as possible to find interesting data. This behavior results in a spike in the number of unique shares accessed, which can be detected by comparing it to the user's own historical baseline.
    answer_sources:
      - 'Windows Event ID 5140'
      - 'NAI: File Servers, SharePoint Sites, Code Repositories accessible by partners'
    range: last 90 days
    queries:
      - query: COUNT unique network shares accessed per hour by partner_account; ALERT if count > 3_std_dev above user's 30-day average;
  - question: Is a partner account's file and share access behavior deviating significantly from that of its peers?
    context: This question uses peer group analysis to spot anomalies. Users in similar roles (e.g., developers from a specific partner company) tend to access similar resources. If one user's access patterns suddenly change to look unlike their peers, it could indicate their account is compromised and being used for reconnaissance outside of its normal role.
    answer_sources:
      - 'Windows Event ID 5140'
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4656'
      - 'NAI: File Servers, SharePoint Sites, Code Repositories accessible by partners'
    range: last 90 days
    queries:
      - query: CLUSTER partner_accounts by resource_access_patterns; ALERT if a user's activity deviates from their cluster_centroid or changes clusters;