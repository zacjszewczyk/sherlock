name: "T1590.003: Network Trust Dependencies"
id: "f8a1b2c3-d4e5-4f6a-b7c8-d9e0f1a2b3c4"
description: "This playbook helps determine if an adversary is conducting reconnaissance to identify an organization's network trust dependencies. This involves detecting anomalous network traffic from external or partner sources, such as high volumes of connections, unusual DNS queries, or network scanning. It also includes monitoring for compromised partner accounts executing reconnaissance commands, enumerating domain trusts, or accessing an unusually high number of network shares, all of which indicate an effort to map the network and exploit trust relationships."
type: "technique"
related:
  - "TA0043: Reconnaissance"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are external IPs or domains associated with network connections matching known reconnaissance infrastructure from threat intelligence feeds?"
    context: "This question aims to identify if inbound traffic is originating from or communicating with infrastructure known to be malicious or involved in reconnaissance activities, providing a high-confidence signal of a targeted threat."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Threat Intelligence Feeds"
      - "Internet Gateway"
      - "Cloud Egress Points"
      - "External DNS Resolvers"
      - "VPN Concentrators"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each connection/DNS query, CHECK source/destination IP/domain against threat intel list. IF match, ALERT."
  - question: "Is an external IP, not on a partner allowlist, exhibiting communication patterns that deviate significantly from the established baseline of legitimate partners?"
    context: "This question helps detect reconnaissance from unknown sources by comparing their network behavior (e.g., destination ports, domains) to the typical patterns of trusted partners. A low similarity score suggests the traffic is anomalous and potentially malicious."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Partner Allowlist"
      - "Internet Gateway"
      - "Cloud Egress Points"
      - "External DNS Resolvers"
      - "VPN Concentrators"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each external IP not in allowlist, CALCULATE Jaccard similarity of its destination ports/domains against baseline. IF similarity < threshold, ALERT."
  - question: "Is a known partner or third-party IP range generating a volume of network traffic that is anomalous compared to its historical patterns?"
    context: "This question seeks to identify compromised partner networks being used for reconnaissance. A significant deviation from predicted traffic volume (e.g., a sudden spike in connections or data transfer) can indicate that a trusted external entity's infrastructure is being misused."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Internet Gateway"
      - "Cloud Egress Points"
      - "External DNS Resolvers"
      - "VPN Concentrators"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each partner IP range, APPLY time-series model to connection/byte volume. IF observed volume > confidence interval, ALERT."
  - question: "Is a partner-associated user account executing known reconnaissance commands or using tools indicative of enumeration?"
    context: "This question focuses on detecting insider threats or compromised partner accounts by looking for the execution of specific commands (like nltest, net group) or the use of tools (identified by User-Agent strings) that are commonly used to map out a network's trust relationships, users, and groups."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Domain Controllers"
      - "ADFS Servers"
      - "Partner-accessible Application Servers"
      - "Jump Boxes"
    range: "Last 90 days"
    queries:
      - "Pseudocode: MONITOR process creation events (4688) and HTTP logs from partner accounts/IPs. IF process name/User-Agent in recon list, ALERT."
  - question: "Is a partner user account executing commands with unusually high complexity or randomness in their arguments, deviating from their normal behavior?"
    context: "This question aims to detect obfuscated or novel command usage by a partner account. High command-line entropy can indicate attempts to hide malicious activity or the use of unfamiliar tools, suggesting a potential compromise or misuse of the account."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Domain Controllers"
      - "ADFS Servers"
      - "Partner-accessible Application Servers"
      - "Jump Boxes"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each new process from partner account, CALCULATE command-line entropy. IF entropy > user's historical 95th percentile, ALERT."
  - question: "Is a partner account executing a command whose arguments are flagged as an outlier by a machine learning model trained on their historical activity?"
    context: "This question uses anomaly detection to identify command-line activity that is inconsistent with a partner account's established role and behavior. Flagging outliers can reveal the use of new or unauthorized tools and techniques indicative of reconnaissance."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Domain Controllers"
      - "ADFS Servers"
      - "Partner-accessible Application Servers"
      - "Jump Boxes"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each new command from partner account, CLASSIFY tokenized arguments with ML model. IF flagged as outlier, ALERT."
  - question: "Is an external IP address exhibiting scanning behavior also listed on a known scanner or malicious actor blocklist?"
    context: "This question provides a high-confidence method for identifying network scanning by cross-referencing IPs showing high connection rates with intelligence sources that track known internet-wide scanners (like Shodan, GreyNoise) and other malicious actors."
    answer_sources:
      - "Zeek conn.log"
      - "Blocklists (Public and Internal)"
      - "Network Perimeter Firewalls"
      - "DMZ Segments"
      - "VPN Concentrators"
      - "Cloud Security Group Logs"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each source IP with high connection rate, CHECK against scanner/malicious blocklists. IF match, ALERT."
  - question: "Is an external source IP connecting to an anomalously high number of unique destination IPs or ports, indicative of network or port scanning?"
    context: "This question identifies scanning behavior by statistically analyzing connection patterns. A high fan-out ratio (connecting to many different hosts) or high port entropy (trying many different ports) for a single source IP are classic indicators of reconnaissance scanning."
    answer_sources:
      - "Zeek conn.log"
      - "Network Perimeter Firewalls"
      - "DMZ Segments"
      - "VPN Concentrators"
      - "Cloud Security Group Logs"
    range: "Last 90 days"
    queries:
      - "Pseudocode: IN 5-min window, CALCULATE fan-out ratio and port entropy for each source IP. IF metrics > 3 std dev from baseline, ALERT."
  - question: "Does an external source IP's connection behavior fall outside the normal clusters of legitimate traffic, suggesting it is anomalous scanning activity?"
    context: "This question uses unsupervised machine learning to identify scanners. Legitimate traffic often forms dense clusters based on similar behaviors, while scanning activity, being different, is likely to be classified as noise or form its own small, distinct cluster."
    answer_sources:
      - "Zeek conn.log"
      - "Network Perimeter Firewalls"
      - "DMZ Segments"
      - "VPN Concentrators"
      - "Cloud Security Group Logs"
    range: "Last 90 days"
    queries:
      - "Pseudocode: APPLY DBSCAN clustering to connection logs. IF source IP is classified as noise or a small outlier cluster, ALERT."
  - question: "Is an unauthorized external IP attempting a DNS zone transfer (AXFR/IXFR)?"
    context: "This question targets a specific and high-fidelity indicator of reconnaissance. DNS zone transfers are designed to replicate DNS records between servers and should never be initiated from an unauthorized external source. Such an attempt is a clear sign of an effort to map the organization's network infrastructure."
    answer_sources:
      - "Zeek dns.log"
      - "Authoritative and Recursive DNS Servers"
      - "Domain Controllers"
    range: "Last 90 days"
    queries:
      - "Pseudocode: MONITOR DNS logs for query type AXFR or IXFR. IF source IP is not on allowlist, ALERT."
  - question: "Is an external source IP generating DNS queries with high subdomain randomness or receiving an unusually high rate of 'domain not found' (NXDOMAIN) responses?"
    context: "This question helps detect DNS enumeration techniques. High entropy in subdomain queries can indicate brute-forcing attempts to discover internal hostnames, while a high rate of NXDOMAIN responses suggests the source is guessing non-existent hostnames."
    answer_sources:
      - "Zeek dns.log"
      - "Authoritative and Recursive DNS Servers"
      - "Domain Controllers"
    range: "Last 90 days"
    queries:
      - "Pseudocode: IN 1-min window, CALCULATE subdomain entropy and NXDOMAIN ratio for each source IP. IF metrics > 98th percentile of baseline, ALERT."
  - question: "Does a sequence of DNS queries from a single source IP get classified as malicious by a machine learning model?"
    context: "This question uses a supervised learning approach to identify complex patterns of malicious DNS reconnaissance that may not be obvious from simple statistical measures. The model can learn to recognize the subtle characteristics of query sequences associated with enumeration tools."
    answer_sources:
      - "Zeek dns.log"
      - "Authoritative and Recursive DNS Servers"
      - "Domain Controllers"
    range: "Last 90 days"
    queries:
      - "Pseudocode: APPLY trained ML classifier to real-time DNS query streams from a source IP. IF classified as malicious, ALERT."
  - question: "Has any partner account attempted to access a honeypot network share?"
    context: "This question uses a deception technique to create a high-fidelity alert. A honeypot share is a trap with no legitimate purpose; any access attempt is a strong indicator of unauthorized enumeration or malicious intent, likely from a compromised or malicious account."
    answer_sources:
      - "Windows Event ID 5140"
      - "Windows Event ID 4663"
      - "Windows Event ID 4656"
      - "Honeypot Share"
      - "File Servers"
      - "SharePoint Sites"
      - "Code Repositories accessible by partners"
    range: "Last 90 days"
    queries:
      - "Pseudocode: MONITOR for any access events (5140, 4656, 4663) on the honeypot share. IF any access is detected, ALERT."
  - question: "Has a partner account accessed a number of unique network shares that is anomalously high compared to their own historical baseline?"
    context: "This question aims to detect broad file share enumeration by a partner account. A sudden spike in the number of distinct shares accessed by a user, compared to their normal behavior, suggests they are actively searching for information outside their usual scope."
    answer_sources:
      - "Windows Event ID 5140"
      - "Windows Event ID 4663"
      - "Windows Event ID 4656"
      - "File Servers"
      - "SharePoint Sites"
      - "Code Repositories accessible by partners"
    range: "Last 90 days"
    queries:
      - "Pseudocode: FOR each partner account, COUNT unique shares accessed (Event 5140) per hour. IF count > 3 std dev above user's 30-day average, ALERT."
  - question: "Has a partner account's resource access behavior deviated significantly from that of its peer group?"
    context: "This question identifies anomalous behavior by comparing a user's actions to those of their peers with similar roles or access patterns. A significant deviation suggests the account may be compromised or misused, as its activity no longer aligns with its expected group behavior."
    answer_sources:
      - "Windows Event ID 5140"
      - "Windows Event ID 4663"
      - "Windows Event ID 4656"
      - "File Servers"
      - "SharePoint Sites"
      - "Code Repositories accessible by partners"
    range: "Last 90 days"
    queries:
      - "Pseudocode: CLUSTER partner accounts by resource access patterns. IF a user's activity vector moves significantly from their cluster centroid, ALERT."