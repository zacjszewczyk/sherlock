name: T1074.002: Remote Data Staging
id: 9d0f3a6e-4c1b-4f8a-9a9b-8d7e6f5c4b3a
description: This playbook helps investigate whether an adversary is collecting and staging data from multiple systems for exfiltration. This involves detecting the creation of archive files that are known-bad indicators, appear in unusual locations, or are created by non-standard processes. It also covers identifying hosts that are being used as central collection points by monitoring for anomalous inbound network traffic that correlates with the creation of large archives. Further investigation points include analyzing command-line activity for evidence of gathering files from multiple sources into a single file and detecting processes that are reading from an unusually high number of distinct directories, which is characteristic of a broad file gathering operation.
type: technique
related:
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a newly created archive file a known-bad indicator based on its hash or filename?
    context: Adversaries often reuse malware or tools. Comparing file hashes and names of newly created archives against threat intelligence feeds can quickly identify known malicious staging activities. This is a high-fidelity check for recognized adversary tools.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Common staging directories (%TEMP%, %PUBLIC%, C:\Perflogs)
      - file servers
      - domain controllers
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH file creation events AND process creation events WHERE file_extension IN ['.zip', '.rar', '.7z', '.tar', '.gz']. LOOKUP file_hash AND file_name against threat_intelligence_feed. ALERT on match.
  - question: Is an unusual process creating archive files, or is a legitimate process creating them at an anomalous rate?
    context: This question helps detect staging activity that doesn't use known-bad files. By baselining normal archiving behavior, it's possible to spot outliers, such as a non-standard tool creating a zip file or a backup utility running at an unusual time or frequency, which could indicate misuse.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Common staging directories (%TEMP%, %PUBLIC%, C:\Perflogs)
      - file servers
      - domain controllers
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: 1. PROFILE hourly frequency of archive creation per process name to create baseline. 2. SEARCH for archive creation events. 3. ALERT IF creating_process is not in allow_list OR hourly_count > 95th_percentile_of_baseline.
  - question: Does a file creation event, based on its context and associated process, have characteristics of malicious archiving activity?
    context: This question uses a machine learning model to perform a more sophisticated analysis than simple rules. It considers multiple features at once (e.g., parent process, command-line complexity, file location) to determine if an archiving event is likely malicious, even if the individual features alone are not suspicious.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Common staging directories (%TEMP%, %PUBLIC%, C:\Perflogs)
      - file servers
      - domain controllers
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: FOR each file creation event EXTRACT features (parent_process, cmd_entropy, file_extension, dir_reputation). INPUT features into classification_model. ALERT IF classification is 'malicious' AND confidence_score > 0.9.
  - question: Has an archive file been created in a sensitive or unusual directory by a process not typically used for archiving?
    context: Adversaries often write data to world-writable or temporary directories to stage it before exfiltration. They may also use living-off-the-land binaries (like powershell.exe) instead of dedicated archiving software. This question looks for this specific combination of suspicious location and suspicious tool.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - User workstations
      - publicly writable network shares
      - web server directories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: DEFINE sensitive_dirs_list AND standard_archivers_allow_list. SEARCH for archive creation events. ALERT IF target_directory IN sensitive_dirs_list AND creating_process NOT IN standard_archivers_allow_list.
  - question: Was an archive file created by a process whose parent process is anomalous for this type of activity?
    context: Legitimate archiving actions are often initiated by predictable parent processes (e.g., explorer.exe). An unusual parent, such as a web server process or a scheduled task running a strange script, could indicate that the archiving action is part of a malicious execution chain.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - User workstations
      - publicly writable network shares
      - web server directories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: PROFILE historical probability of archive creation given a parent process. SEARCH for archive creation events. ALERT IF P(archive_creation | parent_process) < 0.05.
  - question: Is there a statistically significant and anomalous spike in the volume of archive files being created in a specific type of directory?
    context: This question uses time-series analysis to detect sudden changes in the rate of data staging. A sudden surge in archive creation within temporary or system folders, which deviates from the normal forecasted rhythm, is a strong indicator of a mass data collection effort.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - User workstations
      - publicly writable network shares
      - web server directories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: FOR each directory_type (user, temp, public), FORECAST hourly archive creation volume using time-series model. SEARCH for real-time archive creation events. ALERT IF observed_volume significantly deviates from forecasted_volume.
  - question: Did a host receive an unusual number of inbound connections from internal systems shortly before a large archive file was created on it?
    context: This question directly looks for the pattern of a host being used as a central collection point. Adversaries may copy data from many compromised systems to a single staging server before exfiltration. This correlation rule links the network aggregation activity with the local file creation.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Internal network segments (core switches)
      - critical servers (file servers, database servers)
      - the DMZ
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: TRIGGER on host with >10 unique internal source IPs in 5 mins. IF subsequent large archive file (>100MB) created on same host within 10 mins, ALERT.
  - question: Has a host experienced an anomalous amount of inbound network traffic or connections, followed by the creation of a large archive file?
    context: Similar to the symbolic question, this uses statistical baselining to detect anomalies instead of fixed thresholds. It identifies hosts receiving an unusual volume of data or connections and escalates the alert if this is followed by a large archive creation, making it more adaptable to different network environments.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Internal network segments (core switches)
      - critical servers (file servers, database servers)
      - the DMZ
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: ALERT if host's inbound_bytes or unique_source_IPs > 3 standard deviations from baseline in 15 mins. ESCALATE alert to high if large archive (>100MB) is created on that host within 10 mins.
  - question: Can network traffic patterns identify a host acting as a data aggregator, and does host activity confirm this role through subsequent archiving commands?
    context: This question uses unsupervised machine learning to discover hosts that are central points in network traffic without pre-defined rules. By clustering network flows, it can identify potential staging servers. This discovery is then correlated with host-level logs to find the specific processes responsible for the staging.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Internal network segments (core switches)
      - critical servers (file servers, database servers)
      - the DMZ
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: CLUSTER network logs to find central aggregator hosts. CORRELATE aggregator hosts with process logs on those hosts. SEARCH for archiving commands executed shortly after aggregation activity.
  - question: Is there a command-line execution that copies files from multiple distinct locations into a single destination file?
    context: Adversaries may use a single command to gather files from various directories. This is a common pattern for "smash and grab" data collection. This question uses regular expressions to detect this specific command structure, often associated with living-off-the-land tools like 'robocopy' or 'Copy-Item'.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers
      - administrator workstations
      - servers hosting development or source code repositories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: PARSE command lines from process creation events. ALERT on 'copy', 'Copy-Item', 'robocopy' commands with >2 distinct source directory paths and a single destination.
  - question: Has a file manipulation command been executed with an unusually complex or obfuscated command-line string?
    context: To evade simple keyword-based detection, adversaries may obfuscate their commands. Measuring the entropy (randomness) of a command line can detect this complexity. A command with unusually high entropy compared to its baseline suggests it may be obfuscated to hide its true intent.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers
      - administrator workstations
      - servers hosting development or source code repositories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: CALCULATE Shannon entropy for command-line strings. ESTABLISH baseline entropy per process. ALERT if entropy for a file manipulation command > 98th percentile of its baseline.
  - question: Does a command-line's structure significantly deviate from established patterns of benign usage for that specific command?
    context: This question uses an autoencoder to learn the "normal" grammar and structure of command lines for different processes. When a new command is observed that the model cannot accurately reconstruct, it signals a structural anomaly. This can catch novel or complex malicious command variations that other methods might miss.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers
      - administrator workstations
      - servers hosting development or source code repositories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: TRAIN autoencoder on benign command-line sequences. FEED new command lines into the model. ALERT if reconstruction_error > dynamic_threshold.
  - question: Is a network service process reading files from user-specific or non-standard directories?
    context: System or network service accounts should typically only access a predictable set of files. If a process like 'svchost.exe' or a web server process starts reading from user document folders, it is highly suspicious and could indicate a compromised service is being used to gather data. This requires file access auditing to be enabled on critical assets.
    answer_sources:
      - Windows Event ID 4663
      - File shares containing PII, financial, or intellectual property data
      - user home directories
      - code repositories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: PREREQ Enable file access auditing on critical dirs. ALERT if network_service_process is observed reading files (Event 4663) from directories outside its expected scope (e.g., user profile folders).
  - question: Has a user or process suddenly started reading files from an anomalously large number of different directories?
    context: This question establishes a baseline for how many unique locations a user or process typically accesses. A sudden, sharp increase in this number indicates a "dragnet" style of data gathering, where an adversary is sweeping across the file system to find valuable data to stage.
    answer_sources:
      - Windows Event ID 4663
      - File shares containing PII, financial, or intellectual property data
      - user home directories
      - code repositories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: BASELINE the number of unique directories read per user/process per hour. ALERT if the count exceeds the 99th percentile of the baseline.
  - question: Does file access activity show a single process rapidly accessing a large number of previously unrelated files or directories?
    context: This question models file access as a graph to identify behavioral patterns. A mass data gathering operation appears as a "hub-and-spoke" pattern in the graph, where one process node (the hub) suddenly connects to many file nodes (the spokes). This graph-based approach is effective at spotting the structural signature of data collection.
    answer_sources:
      - Windows Event ID 4663
      - File shares containing PII, financial, or intellectual property data
      - user home directories
      - code repositories
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: MODEL file access events as a process-file bipartite graph. USE graph anomaly detection to identify a single process node rapidly creating edges to many previously unassociated file nodes.