name: "T1601: Modify System Image"
id: "42d45c5c-7b3b-4c54-94a2-1927d6f5f9e1"
description: "This playbook helps investigate whether an adversary has modified system images to evade defenses. Adversaries may replace legitimate system images on network devices with malicious or modified ones to establish persistence, evade security controls, or hijack the device's functionality. This is detected by analyzing file transfers for known malicious indicators, anomalous characteristics (filename, size, timing), correlating host and network activity, identifying unauthorized access, and monitoring for post-modification changes in the device's network behavior."
type: "technique"
related:
- "TA0005: Defense Evasion"
contributors:
- "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
- question: "Are file hashes of system images transferred to network devices associated with known malicious firmware?"
  context: "This question aims to identify the direct transfer of known malicious firmware to network devices. By comparing the hashes of transferred image files (.bin, .img, .swi) against a threat intelligence feed, we can detect if an adversary is attempting to replace a legitimate system image with a compromised one for persistence or defense evasion."
  answer_sources:
  - "Zeek files.log"
  - "Zeek ftp.log"
  - "Zeek http.log"
  - "Zeek ssh.log"
  - "Network egress/ingress points, management network segments, threat intelligence platform, file servers used for staging firmware updates."
  range: "last 90 days"
  queries:
  - "pseudocode: SEARCH Zeek files.log WHERE destination_subnet IN management_subnets | EXTRACT file_hash | LOOKUP file_hash in threat_intel_feed | RETURN matches"
- question: "Are the filenames of system images transferred to network devices statistically anomalous or random?"
  context: "Adversaries may use randomly generated or unusual filenames for their malicious firmware to avoid simple signature-based detection. This question focuses on identifying such files by calculating the Shannon entropy of their names. High entropy suggests randomness, which can be an indicator of malicious activity when compared to the predictable naming conventions of legitimate vendor updates."
  answer_sources:
  - "Zeek files.log"
  - "Zeek http.log"
  - "Network egress/ingress points, management network segments, threat intelligence platform, file servers used for staging firmware updates."
  range: "last 90 days"
  queries:
  - "pseudocode: SEARCH Zeek logs WHERE file_transfer to management_subnets | CALCULATE shannon_entropy(filename) | COMPARE entropy to baseline | ALERT on high_entropy_filenames"
- question: "Can machine learning classify file transfers to network devices as malicious based on their characteristics?"
  context: "This question leverages a supervised machine learning model to provide a more sophisticated detection method. By training a model on features like file type, IP reputation, filename entropy, protocol, and size, it can learn the subtle differences between legitimate maintenance and malicious firmware uploads, allowing for the classification of new, unseen transfers."
  answer_sources:
  - "Zeek files.log"
  - "Zeek ftp.log"
  - "Zeek http.log"
  - "Zeek ssh.log"
  - "Network egress/ingress points, management network segments, threat intelligence platform, file servers used for staging firmware updates."
  range: "last 90 days"
  queries:
  - "pseudocode: EXTRACT features from Zeek logs for file transfers | INPUT features into trained_classification_model | ALERT on transfers classified as malicious with high_confidence"
- question: "Is an administrative host executing a file transfer client process followed by a network connection to a network device's management port?"
  context: "This question seeks to correlate host-based activity with network activity to identify suspicious firmware updates. The sequence of a file transfer client (like tftp.exe or scp.exe) running on an admin host, immediately followed by a connection to a network device's management interface, strongly suggests a firmware transfer is occurring and provides context for investigation."
  answer_sources:
  - "Windows Event ID 4688"
  - "Zeek conn.log"
  - "Administrative workstations, jump servers, domain controllers, Endpoint Detection and Response (EDR) logs."
  range: "last 90 days"
  queries:
  - "pseudocode: SEARCH process_creation (EventID 4688) for transfer_clients | CORRELATE by host and time (within 2 mins) with network_connection (Zeek conn.log) to management_port | ALERT on correlation"
- question: "Is an administrative user executing a file transfer client process that is statistically unusual for their account?"
  context: "This question focuses on user behavior analytics to spot anomalies. Legitimate administrators typically have consistent workflows. An adversary, however, might use tools or processes that the legitimate user never does. By baselining normal process execution for each user, we can flag the rare or first-time use of a file transfer client as a potential indicator of compromise."
  answer_sources:
  - "Windows Event ID 4688"
  - "Zeek conn.log"
  - "Administrative workstations, jump servers, domain controllers, Endpoint Detection and Response (EDR) logs."
  range: "last 90 days"
  queries:
  - "pseudocode: BASELINE process execution frequency per user from EventID 4688 | SEARCH for new transfer_client executions | CALCULATE z-score against user's baseline | ALERT on statistical outliers"
- question: "Does an administrative user's session activity, involving process creation and network connections, deviate from their learned normal workflow?"
  context: "This question employs sequence analysis to detect deviations in an administrator's workflow. Normal administrative tasks often follow predictable patterns. A sequence analysis model (like an HMM or LSTM) can learn these patterns and flag an unusual sequence, such as an unexpected download followed by an upload of a firmware file, which may indicate malicious activity."
  answer_sources:
  - "Windows Event ID 4688"
  - "Zeek conn.log"
  - "Administrative workstations, jump servers, domain controllers, Endpoint Detection and Response (EDR) logs."
  range: "last 90 days"
  queries:
  - "pseudocode: BUILD user session sequences from EventID 4688 and Zeek conn.log | INPUT sequences into trained_sequence_analysis_model | ALERT on sequences with low probability scores"
- question: "Is a system image file being transferred to a network device outside of a scheduled maintenance window?"
  context: "Legitimate firmware updates on critical network infrastructure are typically performed during planned maintenance windows to minimize disruption. This question aims to detect firmware transfers that occur outside of these authorized times. Such out-of-band activity is highly suspicious and could indicate an adversary's attempt to modify a system image without authorization."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek files.log"
  - "Zeek ftp.log"
  - "Zeek http.log"
  - "Network device management interfaces, core network traffic sensors, change management system/schedule."
  range: "last 90 days"
  queries:
  - "pseudocode: SEARCH for firmware_file_transfers in Zeek logs | CHECK if transfer_timestamp is outside of approved_maintenance_windows | ALERT on matches"
- question: "Is the size of a transferred firmware file statistically anomalous for that class of network device?"
  context: "Firmware images for a specific model or class of device tend to have consistent file sizes. An adversary's modified image may be significantly larger or smaller due to added malicious code. This question identifies suspicious transfers by comparing the file size against a historical baseline for that device type, flagging outliers that could be malicious."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek files.log"
  - "Zeek ftp.log"
  - "Zeek http.log"
  - "Network device management interfaces, core network traffic sensors, change management system/schedule."
  range: "last 90 days"
  queries:
  - "pseudocode: BASELINE firmware file sizes per device_class | SEARCH Zeek files.log for transfers | COMPARE transfer_size to baseline | ALERT on statistical outliers (e.g., > 99th percentile)"
- question: "Is there an anomalous spike in data volume to the network device management subnet that corresponds to a large file transfer?"
  context: "This question uses time-series analysis to detect unusual network traffic patterns. A large firmware transfer will create a noticeable spike in data volume. By modeling the normal traffic flow to the management subnet, including seasonal patterns like maintenance windows, an anomaly detection model can identify unexpected spikes and correlate them with file transfer events, indicating a potential unauthorized image modification."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek files.log"
  - "Zeek ftp.log"
  - "Zeek http.log"
  - "Network device management interfaces, core network traffic sensors, change management system/schedule."
  range: "last 90 days"
  queries:
  - "pseudocode: AGGREGATE bytes_transferred to management_subnet into time_buckets | APPLY time-series_anomaly_detection_model | ALERT on anomalies that correlate with large_file_transfers"
- question: "Is a network device receiving a large data transfer from an IP address not on the authorized administrator allow-list?"
  context: "Access to network device management interfaces should be strictly controlled. This question checks for connections from unauthorized source IPs. An alert is triggered if a connection from an unknown IP involves a large data transfer, which is characteristic of a firmware update, suggesting an unauthorized attempt to modify the device's system image."
  answer sources:
  - "Zeek conn.log"
  - "Zeek ssh.log"
  - "Network device management interfaces, authentication servers, asset inventory database, IP address management (IPAM) system."
  range: "last 90 days"
  queries:
  - "pseudocode: SEARCH Zeek conn.log for connections to management_ports | FILTER where source_ip NOT IN authorized_ip_list AND session_bytes > 10MB | ALERT on matches"
- question: "Is a network device's management interface receiving a large data transfer from a rare or never-before-seen source IP address?"
  context: "This question uses behavioral baselining to identify suspicious source IPs without relying on a static allow-list. It profiles the historical frequency of connections from all source IPs to a device's management port. A session from a new or very infrequent source IP that also involves a large amount of data transfer is highly anomalous and warrants investigation."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek ssh.log"
  - "Network device management interfaces, authentication servers, asset inventory database, IP address management (IPAM) system."
  range: "last 90 days"
  queries:
  - "pseudocode: BASELINE connection frequency per source_ip to management_ports | SEARCH for new connections | ALERT where source_ip is infrequent AND session_bytes is high"
- question: "Does a management session to a network device, particularly one with a large data transfer, fall outside the clusters of normal activity?"
  context: "This question applies unsupervised machine learning to detect anomalous management sessions. By converting session features (IP, protocol, bytes, duration) into vectors, a clustering algorithm can group normal, legitimate sessions together. Any session that does not fit into a normal cluster (i.e., an outlier), especially one involving a large data transfer, is flagged as suspicious and potentially malicious."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek ssh.log"
  - "Network device management interfaces, authentication servers, asset inventory database, IP address management (IPAM) system."
  range: "last 90 days"
  queries:
  - "pseudocode: VECTORIZE management sessions from Zeek logs | APPLY clustering_algorithm (e.g., DBSCAN) | ALERT on sessions classified as outliers, especially with large_data_transfers"
- question: "After a suspected image modification, is the network device communicating with known malicious command and control (C2) infrastructure?"
  context: "A compromised system image will often cause the device to 'call home' to an adversary's C2 server. This question focuses on post-compromise detection. Following an alert for a potential image modification, it monitors the device's outbound traffic for any connections to IPs or domains on threat intelligence blocklists, which would confirm the compromise."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek notice.log"
  - "Zeek dns.log"
  - "Zeek software.log"
  - "Network traffic sensors monitoring traffic to/from network devices, DNS servers, threat intelligence feeds, device configuration backups."
  range: "last 90 days"
  queries:
  - "pseudocode: ON alert for image_modification, MONITOR outbound traffic from device_ip | LOOKUP destination_ip/domain in C2_blocklist | ESCALATE on match"
- question: "After a suspected image modification, has the network device's network behavior (e.g., destination IPs, ports, protocols, JA3 hash) significantly deviated from its established baseline?"
  context: "This question seeks to identify a compromise by detecting changes in the device's fundamental network behavior. A legitimate network device has a predictable traffic profile. A compromised one may start communicating with new destinations, using different protocols, or exhibit a new TLS fingerprint (JA3). Comparing post-modification activity to a historical baseline can reveal these anomalous changes."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek notice.log"
  - "Zeek dns.log"
  - "Zeek software.log"
  - "Network traffic sensors monitoring traffic to/from network devices, DNS servers, threat intelligence feeds, device configuration backups."
  range: "last 90 days"
  queries:
  - "pseudocode: BASELINE device network behavior (dest_ips, ports, protocols, JA3) | AFTER suspected modification, COMPARE new behavior to baseline | ALERT on statistical deviations (e.g., new JA3, chi-squared test fail)"
- question: "After a suspected image modification, is the device's network activity pattern anomalous when analyzed by a time-series model?"
  context: "This question uses a machine learning model to detect subtle, ongoing changes in behavior post-compromise. A time-series model (like an LSTM autoencoder) is trained on normal network metrics (connection frequency, data volume). After a suspected modification, the device's new telemetry is fed to the model. If the model consistently fails to 'reconstruct' or predict the new behavior (high reconstruction error), it indicates a persistent deviation from the norm, suggestive of C2 activity."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek notice.log"
  - "Zeek dns.log"
  - "Zeek software.log"
  - "Network traffic sensors monitoring traffic to/from network devices, DNS servers, threat intelligence feeds, device configuration backups."
  range: "last 90 days"
  queries:
  - "pseudocode: TRAIN LSTM autoencoder on device's normal network metrics | AFTER suspected modification, FEED new metrics into model | ALERT on sustained high reconstruction_error"