name: T1601: Modify System Image
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook focuses on detecting adversaries modifying system images on network devices to evade defenses. It identifies suspicious file transfers by analyzing file hashes against threat intelligence, looking for anomalous filenames, and using machine learning to classify transfers. The playbook also correlates administrative host process executions with network connections to devices, flags unusual user behavior, and detects transfers that occur outside maintenance windows or are anomalously sized. Additionally, it monitors for management sessions from unauthorized sources and analyzes post-modification network traffic for signs of command-and-control communication or other deviations from established baselines.
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Have any system image files transferred to network devices matched known malicious indicators from threat intelligence?
  context: This question aims to identify the direct transfer of known malicious firmware or system images. Matching a file hash against a threat intelligence feed is a high-confidence indicator of compromise, suggesting an adversary is attempting to replace legitimate system software with a compromised version.
  answer_sources:
  - Zeek files.log
  - Zeek ftp.log
  - Zeek http.log
  - Zeek ssh.log
  - Threat intelligence platform
  range: Last 90 days
  queries:
  - pseudocode: SEARCH Zeek files.log WHERE destination_subnet IN [network_device_management_subnets] | LOOKUP file_hash against threat_intelligence_feed | RETURN matched_transfers
- question: Are there any system image filenames transferred to network devices that exhibit unusually high randomness, deviating from standard vendor naming conventions?
  context: Adversaries may use randomly generated filenames to obfuscate malicious payloads and evade simple signature-based detection. High Shannon entropy in a filename can indicate such randomization, helping to uncover suspicious files that are not yet known to threat intelligence.
  answer_sources:
  - Zeek files.log
  - Zeek http.log
  - Baseline of legitimate firmware update filenames
  range: Last 90 days
  queries:
  - pseudocode: SEARCH Zeek files.log, http.log WHERE destination_subnet IN [network_device_management_subnets] | CALCULATE shannon_entropy(filename) | COMPARE entropy_score to baseline | RETURN transfers with high_entropy_filenames
- question: Can machine learning models classify new file transfers to network devices as malicious based on their characteristics?
  context: This question uses a predictive approach to identify malicious file transfers. By training a model on features like file type, IP reputation, filename entropy, and size, it can proactively flag suspicious transfers that may not trigger simpler, rule-based alerts, thereby detecting novel threats.
  answer_sources:
  - Zeek logs (files, http, ftp, ssh)
  - Source/destination IP reputation data
  - Labeled historical transfer data
  range: Last 90 days
  queries:
  - pseudocode: INPUT Zeek log features (MIME type, IP reputation, filename entropy, protocol, size) INTO classification_model | PREDICT classification (malicious/benign) | RETURN transfers classified as malicious with high_confidence_score
- question: Has an administrative host executed a file transfer client for a firmware file immediately before connecting to a network device's management port?
  context: This question correlates host-based activity (process execution) with network activity (connection to a device) to detect the specific action of uploading a system image. This two-pronged view provides stronger evidence of a deliberate firmware modification attempt than either event would in isolation.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Endpoint Detection and Response (EDR) logs
  range: Last 90 days
  queries:
  - pseudocode: SEARCH Windows Event ID 4688 for process IN [tftp.exe, scp.exe, curl.exe, wget.exe] with command_line containing [.bin, .img, .swi] | CORRELATE source_host within 2 minutes with Zeek conn.log WHERE destination_ip is network_device AND destination_port IN [22, 23, 69] | RETURN correlated_events
- question: Has any administrative user executed a file transfer client in a manner that is statistically unusual compared to their own historical activity?
  context: This question seeks to identify anomalous user behavior. An administrator who rarely or never uses a specific file transfer tool suddenly using it to move a firmware file could indicate a compromised account or an insider threat performing an unauthorized action.
  answer_sources:
  - Windows Event ID 4688
  - Historical user activity baseline
  range: Last 90 days
  queries:
  - pseudocode: FOR each user | SEARCH Windows Event ID 4688 for process IN [tftp.exe, scp.exe, curl.exe, wget.exe] | COMPARE execution_frequency to user_baseline | RETURN executions with outlier_frequency (e.g., z-score > 3)
- question: Have any administrative user sessions shown a sequence of actions (process executions and network connections) that deviates from their normal, learned workflow patterns?
  context: This question uses advanced sequence analysis to model entire user workflows. It can detect subtle deviations that might be missed by single-event analysis, such as an unusual sequence of downloading and then uploading a firmware file, which could indicate staging and deployment of a malicious image.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Labeled historical user session data
  range: Last 90 days
  queries:
  - pseudocode: INPUT user_activity_sequence (process_events, network_connections) INTO sequence_analysis_model | CALCULATE probability_score | RETURN sequences with low_probability_score
- question: Have any system image files been transferred to network devices outside of scheduled maintenance windows?
  context: Legitimate firmware updates are typically performed during planned maintenance windows to minimize disruption. A transfer occurring outside of these times is highly suspicious and could indicate unauthorized activity by an adversary attempting to install a modified image without approval.
  answer_sources:
  - Zeek logs (files, http, ftp)
  - Change management system/schedule
  range: Last 90 days
  queries:
  - pseudocode: SEARCH Zeek logs for file_transfers containing [.bin, .img, .swi] to network_device_ips | CHECK if transfer_timestamp is OUTSIDE maintenance_window_schedule | RETURN out_of_window_transfers
- question: Have any firmware files transferred to network devices been unusually large compared to the historical average for that device type?
  context: Malicious firmware may be larger than legitimate versions due to embedded tools, backdoors, or other payloads. Flagging transfers of an anomalous size can help detect modified images, even if the filename or hash is unknown.
  answer_sources:
  - Zeek files.log
  - Asset inventory database
  - Baseline of legitimate file sizes per device class
  range: Last 90 days
  queries:
  - pseudocode: SEARCH Zeek files.log for transfers to network_devices | GET device_class from asset_inventory | COMPARE file_size to baseline_for_device_class | RETURN transfers with outlier_file_size (e.g., > 99th percentile)
- question: Has the total volume of data transferred to the network device management subnet shown anomalous spikes that correlate with large file transfers?
  context: This question looks at network traffic volume from a time-series perspective. A sudden, anomalous spike in traffic to the management subnet, especially when correlated with a specific file transfer event, can indicate a firmware upload and help detect activity that might be missed by per-file analysis.
  answer_sources:
  - Zeek conn.log
  - Zeek files.log
  - Time-series traffic volume baseline
  range: Last 90 days
  queries:
  - pseudocode: INPUT time_series_data (total_bytes to management_subnet) INTO anomaly_detection_model | IDENTIFY anomalous_time_buckets | CORRELATE with Zeek files.log events in same bucket | RETURN correlated_anomalies
- question: Have any large data transfers occurred during management sessions to network devices from unauthorized IP addresses?
  context: Access to network device management interfaces should be strictly controlled via allow-lists. A connection from an unauthorized source IP, especially one involving a large data transfer consistent with a firmware update, is a major red flag for a potential breach and unauthorized image modification.
  answer_sources:
  - Zeek conn.log
  - Authorized administrative host IP allow-list
  - IP address management (IPAM) system
  range: Last 90 days
  queries:
  - pseudocode: SEARCH Zeek conn.log for connections to network_device_management_ports | CHECK if source_ip is NOT IN authorized_ip_list | CHECK if session_bytes > firmware_size_threshold (e.g., 10MB) | RETURN unauthorized_large_transfers
- question: Have any large data transfers to network devices originated from new or infrequent source IP addresses?
  context: This question uses historical frequency to identify suspicious connections. An IP address that has never connected before, or connects very rarely, suddenly performing a large data transfer is anomalous and warrants investigation, as it could be an external attacker or a newly compromised internal host.
  answer_sources:
  - Zeek conn.log
  - Historical source IP connection frequency baseline
  range: Last 90 days
  queries:
  - pseudocode: SEARCH Zeek conn.log for connections to network_device_management_ports | CALCULATE connection_frequency for source_ip | CHECK if frequency is new or low_percentile AND session_bytes is high_percentile | RETURN anomalous_source_transfers
- question: Can machine learning identify management sessions to network devices that are outliers compared to normal, clustered activity, particularly those involving large data transfers?
  context: This question applies unsupervised machine learning to detect anomalous sessions without pre-defined rules. By clustering sessions based on multiple features (source, protocol, bytes, duration), the model can identify novel attack patterns or unusual combinations of attributes that might indicate a compromise.
  answer_sources:
  - Zeek conn.log
  - Zeek ssh.log
  range: Last 90 days
  queries:
  - pseudocode: INPUT session_features (source subnet, protocol, bytes, duration) INTO clustering_model | IDENTIFY outlier_sessions | RETURN outliers, especially those with large_data_transfers
- question: Following a suspected image modification, has the affected network device attempted to communicate with known malicious command-and-control (C2) infrastructure?
  context: This is a post-compromise detection question. If a device's image has been maliciously modified, it will likely try to "call home" to an attacker's C2 server. Correlating an image modification alert with subsequent C2 traffic provides strong confirmation of a successful compromise.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Threat intelligence feeds (C2 blocklists, DGA watchlists)
  range: Last 90 days
  queries:
  - pseudocode: TRIGGER on image_modification_alert for device_ip | MONITOR subsequent outbound traffic from device_ip | CHECK destination_ip/domain against C2_blocklist/DGA_watchlist | RETURN matched_c2_traffic
- question: After a suspected modification, has the network device's behavior (e.g., destination IPs, ports, protocols, encryption fingerprints) deviated significantly from its established baseline?
  context: A compromised device will behave differently. This question aims to detect those behavioral changes by comparing post-modification activity against a detailed, historical baseline. New protocols, ports, or encryption fingerprints (like JA3/HASSH) are strong indicators that the device's software has been altered.
  answer_sources:
  - Zeek conn.log
  - Zeek ssh.log
  - Zeek notice.log
  - JA3/HASSH fingerprint databases
  - Historical network behavior baseline for the device
  range: Last 90 days
  queries:
  - pseudocode: TRIGGER on image_modification_alert for device_ip | CAPTURE post-event activity (dest_ips, ports, protocols, ja3_hashes) | COMPARE post-event_activity to pre-event_baseline | RETURN statistically_significant_deviations
- question: Does a time-series model indicate that a network device's post-modification network traffic patterns are anomalous and do not match its learned normal behavior?
  context: This question uses a time-series model (like an LSTM autoencoder) to learn the "rhythm" of a device's normal network activity. After a potential compromise, if the new traffic patterns cannot be accurately "reconstructed" by the model, it generates a high error score, signaling a significant deviation from the norm, which could be C2 activity.
  answer_sources:
  - Zeek conn.log
  - Zeek software.log
  - Historical time-series network metrics for the device
  range: Last 90 days
  queries:
  - pseudocode: TRIGGER on image_modification_alert for device_ip | INPUT post-event time-series_metrics INTO trained_autoencoder_model | CALCULATE reconstruction_error | RETURN alerts on sustained_high_reconstruction_error