name: "T1102.002: Bidirectional Communication"
id: "a3b1c2d3-e4f5-4a6b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps investigate whether an adversary is communicating with compromised systems via legitimate web services. It focuses on detecting C2 channels that are disguised as normal user traffic to services like cloud storage, social media, or code repositories. Detections include matching network traffic against known malicious indicators, identifying anomalous traffic patterns (such as rare URIs or User-Agents), analyzing network session characteristics (like data transfer ratios and beaconing), correlating suspicious host processes with network activity, and monitoring for unusual egress from critical servers."
type: "technique"
related:
  - "TA0011: Command And Control"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is outbound network traffic to legitimate web services matching known malicious indicators from threat intelligence feeds?"
    context: "This question aims to detect C2 communication using known bad domains, IPs, or URLs that are hosted on or resolve to a legitimate service. By correlating DNS queries, HTTP host headers, full URIs, and destination IPs against threat intelligence, analysts can quickly identify confirmed malicious activity masquerading as legitimate traffic."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Zeek conn.log"
      - "Egress network gateways"
      - "DNS resolvers"
      - "forward proxy servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH dns.log, http.log, conn.log WHERE (query, host, uri, id.resp_h) IN threat_intel_feed_c2_infra GENERATE high_severity_alert"
  - question: "Are there any unusually rare URI paths being accessed on legitimate web services that could indicate a unique C2 endpoint?"
    context: "This question focuses on identifying C2 channels by their uniqueness. Adversaries using web services for C2 might use a specific, hardcoded, and therefore rare URI. By baselining URI access frequency, analysts can pinpoint statistical outliers that are highly suspicious and warrant investigation as potential C2 endpoints."
    answer_sources:
      - "Zeek http.log"
      - "Egress network gateways"
      - "DNS resolvers"
      - "forward proxy servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH http.log WHERE domain IN legitimate_web_services | CALCULATE_FREQUENCY(uri) by domain over 24h | FILTER uri_frequency > 99.9_percentile"
  - question: "Are there any algorithmically generated or suspicious-looking DNS queries resolving to legitimate web service IP ranges?"
    context: "This question uses machine learning to detect Domain Generation Algorithms (DGAs) or other non-human-generated domains used for C2. Features like domain entropy, length, and character ratios can help a classifier identify suspicious queries. Even if these domains resolve to IPs belonging to a legitimate provider, the query's characteristics can reveal its malicious nature."
    answer_sources:
      - "Zeek dns.log"
      - "Egress network gateways"
      - "DNS resolvers"
      - "forward proxy servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR EACH query in dns.log | CALCULATE_FEATURES(entropy, length, char_ratio, etc.) | SCORE with ML_model | IF score > 0.9 AND resolved_ip IN web_service_ips THEN ALERT"
  - question: "Are there any HTTP requests containing User-Agents, URIs, or POST bodies that match signatures of known C2 frameworks like Cobalt Strike or Empire?"
    context: "This question seeks to identify C2 activity by matching specific, known toolmarks left by popular C2 frameworks. Even when using legitimate services, these tools often have default or configurable patterns in their User-Agent strings, URI structures, or POST data. Using signature-based detection (YARA/regex) allows for high-fidelity alerts on these known patterns."
    answer_sources:
      - "Zeek http.log"
      - "Egress network gateways and forward proxy servers with TLS inspection capabilities"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH http.log | SCAN user_agent, uri, post_body WITH c2_yara_rules | ALERT on match"
  - question: "Are any hosts using rare or previously unseen User-Agent strings when connecting to specific legitimate web services?"
    context: "This question focuses on anomaly detection within User-Agent strings. Adversaries might use a non-standard User-Agent or one that is unusual for a specific destination service. By baselining normal User-Agents for each service, analysts can flag connections using a new or statistically rare agent, which could indicate a malicious tool."
    answer_sources:
      - "Zeek http.log"
      - "Egress network gateways and forward proxy servers with TLS inspection capabilities"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR EACH service_destination in http.log | BASELINE user_agent over 30d | SEARCH http.log FOR new_user_agent OR rare_user_agent (< 0.1% freq) | ALERT"
  - question: "Are there any HTTP requests with a URI structure that is anomalous compared to the typical, learned patterns for a given web service?"
    context: "This question applies deep learning to detect malformed or unusual URI structures. An LSTM autoencoder can learn the 'grammar' of legitimate URI paths. When a C2 tool generates a URI that doesn't fit this learned grammar, the model will have a high reconstruction error, flagging the request as a significant anomaly."
    answer_sources:
      - "Zeek http.log"
      - "Egress network gateways and forward proxy servers with TLS inspection capabilities"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR EACH new_uri in http.log | CALCULATE reconstruction_error with LSTM_autoencoder_model | IF error > 3_std_dev THEN ALERT"
  - question: "Are there any 'low and slow' data exfiltration patterns where a host sends significantly more data than it receives from a legitimate web service?"
    context: "This question targets data exfiltration where an attacker uploads data to a legitimate service. The signature is an imbalanced connection: a small request from the server followed by a much larger upload from the compromised client. This rule helps detect exfiltration hiding within what appears to be normal web traffic."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "Egress network gateways and network tap/span ports with full packet capture or deep packet inspection"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH conn.log WHERE domain IN whitelisted_web_services AND orig_bytes > 5 * resp_bytes AND orig_bytes > 1024 AND resp_pkts > orig_pkts | ALERT"
  - question: "Are any internal hosts exhibiting periodic, machine-like 'heartbeat' beaconing to a web service, or are they sending highly randomized/encrypted data?"
    context: "This question looks for two key C2 indicators: the regular, timed check-ins malware makes to its C2 server (beaconing), and potentially encrypted C2 data. Beaconing is detected by finding connections with very low standard deviation in their timing. Encrypted data is detected by calculating Shannon entropy of payloads, where high entropy suggests randomness."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "Egress network gateways and network tap/span ports with full packet capture or deep packet inspection"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR EACH source_ip, dest_service | CALCULATE time_delta_std_dev over 6h | IF std_dev < 5s AND mean_delta is 10s-30m THEN ALERT | CONCURRENTLY SEARCH http.log, files.log | CALCULATE entropy(payload) | IF entropy > 7.5 THEN ALERT"
  - question: "Are there any significant spikes in a host's outbound data volume to web services that cannot be explained by normal daily or weekly traffic patterns?"
    context: "This question uses time-series analysis to find anomalous data transfers. An STL model breaks down traffic into trend, seasonality, and residual components. A large, unexplained residual value represents a spike in traffic that deviates from the host's normal behavior, which could signify an unscheduled C2 communication or data exfiltration event."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "Egress network gateways and network tap/span ports with full packet capture or deep packet inspection"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR EACH host | AGGREGATE orig_bytes in 10m intervals | APPLY STL_model | IF residual > 3_std_dev_from_mean THEN ALERT"
  - question: "Is a script interpreter or living-off-the-land binary (LOLBin), running from a suspicious location, making network connections to cloud or social media services?"
    context: "This question aims to detect malware execution that leverages built-in Windows tools (LOLBins) like `rundll32.exe`. When these processes, especially if run from temporary directories, initiate connections to services not typically used by system processes (like Dropbox or GitHub), it is a strong indicator of malicious C2 activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "Zeek conn.log"
      - "Endpoint devices (workstations, servers)"
      - "Domain Controllers"
      - "Virtual Desktop Infrastructure (VDI) hosts"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "JOIN process_events (Sysmon1) with network_events (Sysmon3) | WHERE process_name IN (rundll32, mshta, cscript) OR process_path IN (%APPDATA%, %TEMP%) AND dest_domain_category IN (Social, Cloud, Code) | ALERT"
  - question: "Is a process initiating a network connection being spawned by an unusual parent process?"
    context: "This question focuses on detecting anomalous process ancestry. Normal system operations have predictable parent-child process relationships. An attacker might inject code into a process like Microsoft Word, causing it to spawn a command shell for C2. This unusual parent-child relationship is a strong indicator of compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "Zeek conn.log"
      - "Endpoint devices (workstations, servers)"
      - "Domain Controllers"
      - "Virtual Desktop Infrastructure (VDI) hosts"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "BASELINE parent_process by child_process over 30d | SEARCH process_events WHERE parent_process_is_rare (< 1% freq) for that child_process AND child_process_has_network_connection | ALERT"
  - question: "Can we identify small, isolated clusters of process, file, and network activity that represent a self-contained malicious execution chain?"
    context: "This question uses graph analysis to detect entire attack chains. Benign activity typically forms a large, interconnected graph. Malicious activity, however, often appears as a small, separate cluster of nodes: an email client spawns a document, which spawns a shell, which connects to a C2 domain. These isolated 'islands' of activity are highly anomalous."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 3"
      - "Zeek conn.log"
      - "Endpoint devices (workstations, servers)"
      - "Domain Controllers"
      - "Virtual Desktop Infrastructure (VDI) hosts"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CREATE_GRAPH from process, file, network events | APPLY clustering_algorithm | IDENTIFY small, disconnected clusters | ALERT on clusters"
  - question: "Is a critical server (like a Domain Controller) connecting to any destination that is not on its pre-approved egress allow-list?"
    context: "This question implements a high-fidelity control for critical assets. Servers typically have predictable and limited network requirements. By defining a strict allow-list of necessary destinations, any connection to a destination not on that list is an immediate and critical sign of a potential compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Server subnets"
      - "critical asset network segments"
      - "data center core network taps"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH network_logs WHERE source_ip IN critical_server_group AND destination NOT IN server_allow_list | GENERATE critical_alert"
  - question: "Has a server recently started communicating with a significant number of new, previously unseen domains?"
    context: "This question provides a dynamic way to detect changes in a server's network behavior. The Jaccard index measures the similarity between the domains a server contacted today versus its historical baseline. A sudden drop in this index means the server is talking to many new places, which is highly anomalous and could indicate compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Server subnets"
      - "critical asset network segments"
      - "data center core network taps"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR EACH server | BASELINE unique_domains over 30d | CALCULATE Jaccard_index(domains_today, baseline_domains) | IF index < 0.8 THEN ALERT"
  - question: "Are there any network connections from a server that a machine learning model, trained on its normal behavior, classifies as anomalous?"
    context: "This question uses an unsupervised machine learning model (OC-SVM) to create a sophisticated baseline of normal network behavior for a server. The model learns the multi-dimensional boundary of 'normal' based on features like port and protocol. Any new connection that falls outside this boundary is flagged as an outlier, enabling the detection of novel C2 activity."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Server subnets"
      - "critical asset network segments"
      - "data center core network taps"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR EACH server | TRAIN OC-SVM model on baseline traffic | FOR EACH new_connection | CLASSIFY as inlier/outlier | IF outlier THEN ALERT"