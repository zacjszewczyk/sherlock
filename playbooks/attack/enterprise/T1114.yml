name: T1114: Email Collection
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: >-
  Identifies if an adversary is collecting sensitive information by accessing or exfiltrating data from user mailboxes. This playbook covers multiple methods, including the creation of malicious inbox rules to auto-forward email, the use of administrative tools like PowerShell to search and export mailboxes, the staging of emails into archive files (.pst, .ost) for exfiltration, unauthorized access to local email data files, anomalous logins to email services, and unauthorized processes connecting to mail servers.
type: technique
related:
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are new or modified inbox rules forwarding emails to unapproved external domains?
    context: >-
      This question seeks to identify malicious inbox rules created by adversaries. Such rules are a common technique for email collection, allowing attackers to stealthily exfiltrate data by automatically forwarding sensitive emails to an external account they control. Monitoring for the creation of these rules, especially those pointing to non-allow-listed domains, is crucial for early detection.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Zeek smtp.log
      - Zeek http.log
      - Mail Gateway (e.g., Exchange Online, On-prem Exchange)
      - Network Egress Points
      - Webmail Application Servers
    range: last 90 days
    queries:
      - pseudocode: Search M365 logs for New-InboxRule/Set-InboxRule events with external ForwardTo/ForwardingSmtpAddress. Correlate with SMTP logs for X-MS-Exchange-Organization-AutoForwarded headers to the same domains.
  - question: Is any user exhibiting an anomalous volume of auto-forwarded emails or forwarding to new external domains?
    context: >-
      This question uses statistical analysis to find deviations from normal user behavior. A sudden spike in auto-forwarded emails or the first instance of forwarding to a new external domain can indicate that a legitimate account's forwarding rules have been hijacked for data exfiltration, even if the rule creation event was missed.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Zeek smtp.log
      - Zeek http.log
      - Mail Gateway (e.g., Exchange Online, On-prem Exchange)
      - Network Egress Points
      - Webmail Application Servers
    range: last 90 days
    queries:
      - pseudocode: For each user, baseline daily count of auto-forwarded emails from SMTP logs. Alert if daily count exceeds 95th percentile or if a new external forwarding domain is seen.
  - question: Can a machine learning model identify suspicious inbox rule creation events based on contextual features?
    context: >-
      This question leverages machine learning to detect subtle or sophisticated attempts to create malicious forwarding rules. By analyzing a combination of features like the time of day, user's role, and destination domain reputation, a model can identify high-risk rule creations that might appear benign to simpler symbolic checks.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Zeek smtp.log
      - Zeek http.log
      - Mail Gateway (e.g., Exchange Online, On-prem Exchange)
      - Network Egress Points
      - Webmail Application Servers
    range: last 90 days
    queries:
      - pseudocode: Train a classifier on M365 rule creation events. Features - time of day, user role, domain TLD/age, source IP range. Alert on high probability scores.
  - question: Is a non-administrative user or host executing PowerShell cmdlets to search or export mailboxes?
    context: >-
      This question aims to detect the abuse of powerful Exchange management cmdlets like `Search-Mailbox` or `New-MailboxExportRequest`. When these tools are run from unusual locations (non-admin workstations) or by unauthorized users, it is a strong indicator of an adversary attempting to bulk-collect email data from compromised systems.
    answer_sources:
      - Windows Event ID 4688
      - Windows PowerShell Log Event ID 4104
      - Exchange Servers
      - Administrator Workstations
      - Domain Controllers
      - User Endpoints
    range: last 90 days
    queries:
      - pseudocode: Search process creation/PowerShell logs for 'Search-Mailbox', 'New-MailboxExportRequest', or '.Ews.ExchangeService' on non-admin hosts or by non-admin users.
  - question: Is a user executing rare or high-risk PowerShell mail-related cmdlets for the first time?
    context: >-
      This statistical approach helps identify abuse by profiling cmdlet usage across the organization. Cmdlets for exporting mailboxes are typically used infrequently and by a small number of administrators. When a user runs such a rare cmdlet for the first time, it represents a significant deviation from their normal behavior and warrants investigation.
    answer_sources:
      - Windows Event ID 4688
      - Windows PowerShell Log Event ID 4104
      - Exchange Servers
      - Administrator Workstations
      - Domain Controllers
      - User Endpoints
    range: last 90 days
    queries:
      - pseudocode: Profile cmdlet rarity across the org from PowerShell logs. Alert when a user executes a high-rarity cmdlet like 'New-MailboxExportRequest' for the first time.
  - question: Can an anomaly detection model identify malicious PowerShell activity related to email collection?
    context: >-
      This question applies machine learning to find unusual PowerShell execution patterns. Malicious scripts often have different characteristics (e.g., length, entropy, obfuscation) than legitimate administrative scripts. An anomaly detection model can learn the normal patterns and flag suspicious script executions that combine multiple anomalous features.
    answer_sources:
      - Windows Event ID 4688
      - Windows PowerShell Log Event ID 4104
      - Exchange Servers
      - Administrator Workstations
      - Domain Controllers
      - User Endpoints
    range: last 90 days
    queries:
      - pseudocode: Use an Isolation Forest model on PowerShell event features (script length, entropy, user, host). Flag high-scoring anomalies.
  - question: Has an email archive file been created in an unusual location and then exfiltrated over the network?
    context: >-
      This question looks for a common adversary workflow - consolidate emails into an archive file (like a .pst or .zip), then transfer it out. By correlating file creation events in strange directories with subsequent network connections of a similar size from the same host, analysts can detect this multi-stage exfiltration tactic.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek files.log
      - Zeek conn.log
      - User Endpoints
      - File Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - pseudocode: Correlate file creation of .pst/.zip in temp locations, with a non-email client reading the file, and a subsequent outbound connection of similar size.
  - question: Is there a statistical anomaly in the creation of email archive files or subsequent network traffic on a given host?
    context: >-
      This question uses baselining to detect unusual archiving activity. A host that suddenly starts creating many more .pst or .zip files than its historical norm, especially when followed by an anomalous spike in outbound network traffic, is a strong candidate for investigation for data staging and exfiltration.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek files.log
      - Zeek conn.log
      - User Endpoints
      - File Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - pseudocode: Baseline daily count/size of .pst/.zip files created outside standard paths. Alert if count exceeds 99th percentile, especially if followed by outbound traffic spike.
  - question: Can a time-series model detect network exfiltration following the creation of an email archive file?
    context: >-
      This question uses a sophisticated time-series model to predict normal network traffic. The creation of a large archive file is used as an external signal. If the actual network traffic significantly exceeds the model's prediction immediately after a .pst file is created, it provides strong, model-driven evidence of exfiltration.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek files.log
      - Zeek conn.log
      - User Endpoints
      - File Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - pseudocode: Train an ARIMA model on host outbound traffic. Use .pst file creation events as an exogenous variable. Alert on large residual errors post-event.
  - question: Has there been a successful login to an email service from a known malicious IP or as part of an 'impossible travel' scenario?
    context: >-
      This question focuses on high-confidence indicators of account compromise. A login from an IP address on a threat intelligence list or a login that is geographically impossible given the user's previous login location are strong, clear-cut signs that an adversary has stolen credentials and is accessing the email account.
    answer_sources:
      - Windows Event ID 4624
      - Microsoft 365 Unified Audit Log
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Authentication Servers (Active Directory)
      - Cloud Identity Provider (Azure AD)
      - VPN Concentrators
      - Webmail Application Servers
      - Mail Gateway
    range: last 90 days
    queries:
      - pseudocode: Alert on successful email service logins from IPs on threat intel lists or where geolocation violates impossible travel rules.
  - question: Does a successful email service login exhibit a combination of statistically rare attributes for that user?
    context: >-
      This question seeks to identify compromised accounts by looking at logins that are 'strange' for a specific user, even if no single attribute is definitively malicious. A combination of a new location, a new device (user-agent), a new network (ASN), and a new client fingerprint (JA3) can collectively build a high-risk score, indicating a likely compromise.
    answer_sources:
      - Windows Event ID 4624
      - Microsoft 365 Unified Audit Log
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Authentication Servers (Active Directory)
      - Cloud Identity Provider (Azure AD)
      - VPN Concentrators
      - Webmail Application Servers
      - Mail Gateway
    range: last 90 days
    queries:
      - pseudocode: Baseline user login attributes (country, ASN, user-agent, JA3). Score new logins based on rarity of attributes. Alert when score exceeds threshold.
  - question: Can an unsupervised machine learning model detect anomalous email service logins that deviate from a user's normal profile?
    context: >-
      This question employs machine learning to build a multi-dimensional profile of 'normal' login behavior for each user. The model can learn complex relationships between features like time, location, and client properties. Any login that falls outside this learned normal pattern is flagged as an anomaly, catching sophisticated attackers who may try to blend in.
    answer_sources:
      - Windows Event ID 4624
      - Microsoft 365 Unified Audit Log
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Authentication Servers (Active Directory)
      - Cloud Identity Provider (Azure AD)
      - VPN Concentrators
      - Webmail Application Servers
      - Mail Gateway
    range: last 90 days
    queries:
      - pseudocode: Use a One-Class SVM or autoencoder on login event vectors (user, country, ASN, time). Flag logins that the model identifies as anomalous.
  - question: Is a non-allow-listed process reading a local email data file and subsequently making an outbound network connection?
    context: >-
      This question targets the direct access and exfiltration of local email files (e.g., Outlook .pst/.ost files). An adversary might use a scripting engine like PowerShell or a living-off-the-land binary to read the file and send its contents to a C2 server. This rule looks for that specific sequence - unapproved process reads mail file, then connects out.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - User Endpoints
      - Network Egress Points
      - DNS Servers
    range: last 90 days
    queries:
      - pseudocode: Alert when a non-allow-listed process reads a .pst/.ost file, followed by an outbound connection from the same host to a non-known-good IP.
  - question: Has a process accessed a local email data file for the first time on a given host, followed by an anomalous amount of outbound data?
    context: >-
      This statistical approach identifies this behavior without a rigid allow-list. It baselines which processes normally access email files on each host. When a new process (e.g., `powershell.exe`) accesses these files for the first time, it's a significant anomaly. Correlating this with a spike in outbound data transfer reinforces the likelihood of exfiltration.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - User Endpoints
      - Network Egress Points
      - DNS Servers
    range: last 90 days
    queries:
      - pseudocode: Baseline processes that access .pst/.ost files per host. Alert on 'first-seen' access, especially if followed by outbound traffic > 99th percentile.
  - question: Can a sequence-based machine learning model identify the chain of events corresponding to unauthorized email file access and exfiltration?
    context: >-
      This question uses advanced ML to understand the 'story' of user and system activity. A model is trained on normal sequences of events (process starts, file access, network connections). It can then identify a malicious sequence, like PowerShell reading a .pst file and then connecting to an unusual IP, as a low-probability and therefore suspicious event chain.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - User Endpoints
      - Network Egress Points
      - DNS Servers
    range: last 90 days
    queries:
      - pseudocode: Train a sequence model (HMM) on event logs. Alert on low-probability sequences, e.g., [powershell starts -> reads .pst -> connects to new IP].
  - question: Is a process not on the approved email client allow-list initiating a connection to a mail server on a standard mail port?
    context: >-
      This question establishes a simple but effective security boundary. Only approved applications (like Outlook) should be communicating with mail servers. If any other process, such as a web shell on a server or a malicious tool on a workstation, attempts to connect to a mail server port, it is a clear violation of policy and a strong indicator of malicious activity.
    answer_sources:
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - Mail Gateway
      - User Endpoints
      - Application Servers
      - Internal Network Segments
    range: last 90 days
    queries:
      - pseudocode: Maintain allow-list of processes authorized to connect to mail servers on mail ports. Alert on any connection from a process not on the list.
  - question: Is a host exhibiting a 'first-time' anomalous connection, where a new process connects to a mail port?
    context: >-
      This question uses host-level behavioral baselining to detect suspicious connections. By tracking the pairs of (process, destination port) over time, the system can learn what is normal for each host. A new pair involving a mail port, like a web server process connecting to port 993 for the first time, is a statistical anomaly that warrants investigation.
    answer_sources:
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - Mail Gateway
      - User Endpoints
      - Application Servers
      - Internal Network Segments
    range: last 90 days
    queries:
      - pseudocode: Baseline (process, dest_port) tuples for each host. Alert on new tuple where port is a mail port and process is not a known mail client.
  - question: Can a graph-based machine learning model identify anomalous connections between different types of hosts in the network?
    context: >-
      This question models the network as a graph to learn high-level communication patterns. The model understands that 'workstations' talk to 'mail servers', but 'web servers' typically do not. A GNN can flag a new connection from a web server to a mail server as a structural anomaly in the graph, indicating a potential compromise and lateral movement.
    answer_sources:
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - Mail Gateway
      - User Endpoints
      - Application Servers
      - Internal Network Segments
    range: last 90 days
    queries:
      - pseudocode: Model network as a graph (nodes=hosts with roles, edges=connections). Use a GNN to flag anomalous new edges, e.g., web-server -> mail-server.