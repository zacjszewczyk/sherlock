name: 'T1596.003: Digital Certificates'
id: 'f47ac10b-58cc-4372-a567-0e02b2c3d479'
description: 'This playbook helps investigate potential adversary reconnaissance activities focused on gathering information about an organization''s digital certificates. It addresses scenarios where adversaries search public digital certificate data, such as Certificate Transparency (CT) logs, to discover hostnames, subdomains, and infrastructure. The playbook provides methods to detect this activity by monitoring for internal hosts connecting to known reconnaissance services, analyzing HTTP requests for tool-like characteristics, identifying anomalous DNS query patterns related to CT logs, and detecting external scanners probing public-facing servers for certificate information via SNI fields.'
type: 'technique'
related:
  - 'TA0043: Reconnaissance'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Has an internal host connected to or queried domains/IPs associated with known certificate reconnaissance tools or adversary infrastructure?'
    context: 'This question aims to detect direct communication from inside the network to external services known to be used for certificate reconnaissance (like crt.sh) or other malicious activities. A match against a threat intelligence feed is a strong indicator of potential compromise or unauthorized reconnaissance activity. Identifying the responsible process provides crucial context for remediation and understanding the execution chain.'
    answer_sources:
      - 'Zeek dns.log'
      - 'Zeek conn.log'
      - 'Windows Event ID 4688'
      - 'Internal DNS Resolvers'
      - 'Network Egress Points (e.g., Firewalls, Proxies)'
      - 'Endpoints'
    range: 'last 90 days'
    queries:
      - 'SEARCH dns_logs OR network_logs WHERE destination_ip IN (threat_intel_feed) OR destination_domain IN (threat_intel_feed); CORRELATE process_logs WITH network_events ON (host, timestamp) TO find_parent_process;'
  - question: 'Is any internal host contacting an unusually high number of known reconnaissance domains compared to its own history and its peer group?'
    context: 'This question seeks to identify anomalous behavior by baselining normal activity. An individual host suddenly accessing many reconnaissance domains is suspicious. Comparing this activity to a peer group helps reduce false positives, as some roles (like security researchers) may have legitimate reasons for such traffic. A deviation from both personal and peer baselines strongly suggests abnormal activity.'
    answer_sources:
      - 'Zeek dns.log'
      - 'Zeek conn.log'
      - 'Windows Event ID 4688'
      - 'Internal DNS Resolvers'
      - 'Network Egress Points (e.g., Firewalls, Proxies)'
      - 'Endpoints'
    range: 'last 90 days'
    queries:
      - 'FOR each_host, CALCULATE hourly_unique_recon_domains; COMPARE current_hour_count TO (98th_percentile(host_baseline) AND 98th_percentile(peer_group_baseline)); ALERT if exceeded;'
  - question: 'Has the overall volume of network traffic to known reconnaissance domains deviated from established seasonal patterns?'
    context: 'This question uses a macro-level, network-wide view to detect sophisticated or widespread reconnaissance campaigns. Instead of focusing on a single host, it analyzes the aggregate traffic volume. A time-series anomaly detection model can identify subtle, coordinated spikes in activity that might be missed by per-host thresholding, accounting for normal fluctuations like time of day or day of the week.'
    answer_sources:
      - 'Zeek dns.log'
      - 'Zeek conn.log'
      - 'Windows Event ID 4688'
      - 'Internal DNS Resolvers'
      - 'Network Egress Points (e.g., Firewalls, Proxies)'
      - 'Endpoints'
    range: 'last 90 days'
    queries:
      - 'APPLY time_series_anomaly_detection_model TO (total_connections_to_recon_domains); ALERT on anomalies flagged by model;'
  - question: 'Are there any HTTP/S requests to Certificate Transparency (CT) log domains containing User-Agents or URI patterns characteristic of automated reconnaissance tools?'
    context: 'This question focuses on identifying the specific tools an adversary might be using by inspecting the content of web traffic. Automated tools often leave tell-tale signatures, such as unique User-Agent strings or predictable query structures, that differ from standard web browser traffic. Detecting these signatures in requests to CT log services provides direct evidence of tool-based reconnaissance.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek ssl.log'
      - 'Zeek dns.log'
      - 'Web Proxies with SSL/TLS Decryption'
      - 'Network Egress Points'
      - 'Endpoint Detection and Response (EDR) agents'
    range: 'last 90 days'
    queries:
      - 'SEARCH http_logs WHERE destination_domain IN (ct_log_domains) AND (user_agent MATCHES (tool_signatures_regex) OR uri_path MATCHES (tool_query_regex));'
  - question: 'Is any internal host using an unusually diverse or random set of User-Agent strings when communicating with CT log domains?'
    context: 'This question aims to detect adversaries attempting to evade signature-based detection by randomizing their User-Agent strings. A legitimate user''s browser typically uses a single, consistent User-Agent. A high degree of randomness or variety (high entropy) in User-Agents from a single host over a short period is highly anomalous and suggests the use of a sophisticated script or tool designed to cloak its identity.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek ssl.log'
      - 'Zeek dns.log'
      - 'Web Proxies with SSL/TLS Decryption'
      - 'Network Egress Points'
      - 'Endpoint Detection and Response (EDR) agents'
    range: 'last 90 days'
    queries:
      - 'FOR each_host, CALCULATE shannon_entropy(user_agents in http_logs to ct_domains) per hour; COMPARE current_entropy TO (historical_mean + 3 * std_dev); ALERT if exceeded;'
  - question: 'Can machine learning classify any outbound HTTP traffic to CT log domains as malicious based on a combination of its features?'
    context: 'This question leverages a machine learning model to make a more holistic and robust determination of malicious activity. Instead of relying on a single indicator, the model considers multiple features of an HTTP request simultaneously (e.g., User-Agent, URI structure, timing). This approach can detect novel or previously unseen reconnaissance tools that might evade simpler rule-based or statistical methods.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek ssl.log'
      - 'Zeek dns.log'
      - 'Web Proxies with SSL/TLS Decryption'
      - 'Network Egress Points'
      - 'Endpoint Detection and Response (EDR) agents'
    range: 'last 90 days'
    queries:
      - 'APPLY trained_classifier_model TO http_requests to ct_domains; ALERT on requests classified as ''malicious'' with probability > 0.9;'
  - question: 'Has a host from a ''low-risk'' user group, which should not be accessing such services, made a DNS query for a CT log domain?'
    context: 'This question uses environmental knowledge and host profiling to create a high-fidelity, zero-tolerance detection. Certain business units (like HR or Finance) have no legitimate reason to query certificate transparency logs. Any such activity from a host in these groups is immediately suspicious and warrants a high-priority investigation. Identifying the process is critical for understanding the infection or execution vector.'
    answer_sources:
      - 'Zeek dns.log'
      - 'Windows Event ID 5156'
      - 'Windows Event ID 4688'
      - 'Internal DNS Resolvers'
      - 'Domain Controllers'
      - 'Endpoint Devices'
    range: 'last 90 days'
    queries:
      - 'SEARCH dns_logs WHERE source_host IN (low_risk_group) AND query IN (ct_log_domains); CORRELATE with process_creation_logs and network_connection_logs to find originating_process;'
  - question: 'Is any internal host exhibiting both an unusually high volume and an unusually high diversity of DNS queries for CT log domains?'
    context: 'This question seeks to identify hosts performing broad reconnaissance across multiple CT log providers. An adversary might query various services (crt.sh, googleapis.com, etc.) to gather a comprehensive picture. Requiring both high volume (many queries) and high diversity (many different CT services) to trigger an alert creates a more specific and reliable signal, reducing false positives from a host that might legitimately query a single service frequently.'
    answer_sources:
      - 'Zeek dns.log'
      - 'Windows Event ID 5156'
      - 'Windows Event ID 4688'
      - 'Internal DNS Resolvers'
      - 'Domain Controllers'
      - 'Endpoint Devices'
    range: 'last 90 days'
    queries:
      - 'FOR each_host, CALCULATE hourly_dns_query_count_to_ct_domains and hourly_entropy_of_sld; ALERT if (count > 99th_percentile_baseline) AND (entropy > 99th_percentile_baseline);'
  - question: 'Does a host''s current DNS query pattern to CT domains fall outside its individually trained model of ''normal'' behavior?'
    context: 'This question applies an unsupervised machine learning model to create a highly personalized baseline of normal behavior for each host. A one-class SVM is ideal for learning a profile from only ''normal'' data. This method is powerful because it doesn''t rely on predefined thresholds or peer groups and can detect subtle deviations in a host''s specific query patterns (e.g., querying at an unusual time of day, even with low volume), which might indicate compromise.'
    answer_sources:
      - 'Zeek dns.log'
      - 'Windows Event ID 5156'
      - 'Windows Event ID 4688'
      - 'Internal DNS Resolvers'
      - 'Domain Controllers'
      - 'Endpoint Devices'
    range: 'last 90 days'
    queries:
      - 'FOR each_host, APPLY one-class_svm_model to current_dns_patterns; ALERT if pattern is flagged as anomaly (outside normal boundary);'
  - question: 'Is a known malicious external IP address, identified by a threat intelligence feed, attempting to initiate SSL/TLS connections with our public-facing servers?'
    context: 'This question provides a straightforward, high-confidence method for detecting inbound scanning from known bad actors. By cross-referencing incoming connection attempts with a curated list of malicious IPs (e.g., from services like GreyNoise or Shodan), security teams can quickly identify and block reconnaissance probes from known scanners or compromised hosts, preventing them from gathering information about the organization''s certificates and services.'
    answer_sources:
      - 'Zeek ssl.log'
      - 'Zeek conn.log'
      - 'Network DMZ'
      - 'Public-facing Web Servers'
      - 'Edge Routers'
      - 'Load Balancers'
      - 'Cloud-hosted Application Frontends'
    range: 'last 90 days'
    queries:
      - 'SEARCH ssl_logs OR conn_logs WHERE source_ip IN (scanner_threat_intel_feed) AND destination_ip IN (public_assets); ALERT and BLOCK source_ip;'
  - question: 'Is any single external IP address requesting an abnormally high number of unique certificates (via SNI) or contacting an abnormally high number of our servers in a short time frame?'
    context: 'This question aims to detect external scanning behavior by analyzing the scale and diversity of an actor''s requests. A legitimate client typically connects to one or a few hosts and requests a limited set of certificates. A scanner, however, will often iterate through many hostnames (in the SNI field) or IP addresses in a short period. Alerting on high counts of unique SNIs or destination hosts helps distinguish automated scanning from normal user traffic.'
    answer_sources:
      - 'Zeek ssl.log'
      - 'Zeek conn.log'
      - 'Network DMZ'
      - 'Public-facing Web Servers'
      - 'Edge Routers'
      - 'Load Balancers'
      - 'Cloud-hosted Application Frontends'
    range: 'last 90 days'
    queries:
      - 'FOR each_external_ip, COUNT unique_destination_hosts and unique_sni_names per 5_minutes; ALERT if sni_count > 99.5th_percentile_baseline; UPGRADE_ALERT if (sni_count > baseline AND host_count > baseline);'
  - question: 'Can any inbound connection patterns be identified as anomalous ''noise'' by a clustering algorithm, separating them from large clusters of normal traffic?'
    context: 'This question uses the DBSCAN clustering algorithm to automatically discover patterns of normal and anomalous inbound traffic without pre-defined rules. Normal, high-volume traffic (like from search engine crawlers) will form large, dense clusters. Malicious scanning or reconnaissance activity, which is often sporadic or uses unique parameters, will not fit into these large clusters and will be classified as ''noise'' by the algorithm. This provides a powerful way to surface unusual and potentially malicious activity for investigation.'
    answer_sources:
      - 'Zeek ssl.log'
      - 'Zeek conn.log'
      - 'Network DMZ'
      - 'Public-facing Web Servers'
      - 'Edge Routers'
      - 'Load Balancers'
      - 'Cloud-hosted Application Frontends'
    range: 'last 90 days'
    queries:
      - 'APPLY DBSCAN_clustering to inbound_connection_events using features (source_ip, dest_port, unique_sni_count, etc.); ALERT on events classified as ''noise'' or part of small, dense clusters;'