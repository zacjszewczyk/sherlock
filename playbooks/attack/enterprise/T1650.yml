name: "T1650: Acquire Access"
id: "a3f5b6e1-8d2c-4b7a-9f1e-0c9d8e7f6a5b"
description: "This playbook helps investigate if an adversary has acquired and used access to the enterprise environment. It focuses on detecting initial access attempts through various means, such as the use of compromised credentials from CTI feeds, brute-force or password spraying attacks identified by a high volume of failed authentications, and successful logins from anomalous or high-risk IP addresses. The playbook also covers post-access indicators, including high-risk activities following a suspicious login and the activation of web shells by server processes spawning command-line interpreters."
type: "technique"
related:
  - "TA0042: Resource Development"
contributors:
  - "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Are there any successful or failed login attempts from user accounts that appear on a CTI feed of breached credentials?"
    context: "Adversaries frequently acquire credentials from public data breaches to use in credential stuffing or password spraying attacks. Detecting a login attempt, even a failed one, from an account known to be compromised provides an early warning that the organization is being targeted with credentials specific to its users. This question helps identify these initial access attempts before an adversary can establish a foothold."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services (e.g., VPN gateways, Microsoft Entra ID), Domain Controller security logs, CTI feed aggregation platforms"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          DEFINE watchlist as CTI_breached_credentials
          SEARCH authentication_logs (EventID 4624 OR 4625)
          JOIN on username with watchlist
          RETURN matching_events
  - question: "Has a user account from a breach list successfully authenticated from an IP address with an anomalous Autonomous System Number (ASN)?"
    context: "Following a successful login from a compromised account, it is critical to determine if the activity is anomalous. Adversaries often operate from infrastructure that is different from a legitimate user's typical network environment. By comparing the source ASN of a suspicious login against the user's historical baseline, analysts can identify logins from entirely new network blocks, which significantly increases the likelihood of a compromise."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services (e.g., VPN gateways, Microsoft Entra ID), Domain Controller security logs, CTI feed aggregation platforms"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          DEFINE compromised_user_login as successful_auth_from_CTI_watchlist
          ENRICH compromised_user_login with source_ASN from network_logs
          COMPARE source_ASN against user_historical_ASN_baseline
          IF source_ASN is new for user, ALERT
  - question: "Do real-time login events involving breached credentials exhibit features associated with malicious activity according to a machine learning model?"
    context: "A machine learning model can analyze multiple features of a login event simultaneously to provide a more nuanced risk assessment than a simple rule. By training a model on features like IP reputation, time of day, geolocation, and whether the account is on a breach list, analysts can automate the detection of complex malicious patterns that might otherwise be missed, allowing for a more proactive and scalable defense."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Externally-facing authentication services (e.g., VPN gateways, Microsoft Entra ID), Domain Controller security logs, CTI feed aggregation platforms"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each new login event:
            GATHER features (IP reputation, time, ASN, geolocation, on_breach_list)
            SCORE features with trained_classification_model
            IF score > malicious_threshold (e.g., 0.85), ALERT
  - question: "Is a single source IP address generating a high volume of failed login attempts against many different user accounts in a short time frame?"
    context: "This question aims to detect password spraying or credential stuffing attacks, where an adversary uses a list of usernames and attempts to log in with a few common passwords or known breached passwords. A high count of unique targeted accounts from a single source IP is a strong indicator of such an attack, as legitimate login failures are typically isolated to a single user."
    answer_sources:
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Perimeter firewalls, VPN concentrators, Web Application Firewalls (WAFs), Identity Provider logs (e.g., Microsoft Entra ID Sign-in logs), Domain Controller security logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH failed_logins (EventID 4625)
          GROUP by source_IP over 5-minute window
          COUNT distinct usernames per source_IP
          IF distinct_username_count > 50, ALERT
  - question: "Is any single source IP targeting an unusually diverse set of usernames, as measured by Shannon entropy?"
    context: "While a simple count of failed logins is useful, Shannon entropy provides a more robust measure of randomness. A high entropy score for the set of targeted usernames indicates that the attacker is cycling through a large, non-repetitive list of accounts, which is characteristic of a broad password spraying attack. This method can detect stealthier attacks that might stay below simple volume-based thresholds."
    answer_sources:
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Perimeter firewalls, VPN concentrators, Web Application Firewalls (WAFs), Identity Provider logs (e.g., Microsoft Entra ID Sign-in logs), Domain Controller security logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH failed_logins (EventID 4625) over 15-minute window
          FOR each source_IP:
            CALCULATE Shannon_entropy of targeted_usernames
            COMPARE entropy to dynamic_baseline (e.g., 99th percentile)
            IF entropy > baseline, ALERT
  - question: "Has the enterprise-wide rate of failed logins anomalously spiked compared to historical patterns?"
    context: "This question seeks to identify large-scale, distributed credential attacks that may not be obvious when looking at a single source IP. A time-series anomaly detection model learns the normal rhythm (seasonality) of login failures across the organization. A significant deviation from this expected pattern can indicate a widespread attack originating from multiple sources, which would be missed by rules focused on a single attacker IP."
    answer_sources:
      - "Windows Event ID 4625"
      - "Zeek conn.log"
      - "Perimeter firewalls, VPN concentrators, Web Application Firewalls (WAFs), Identity Provider logs (e.g., Microsoft Entra ID Sign-in logs), Domain Controller security logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          MONITOR aggregate rate of failed_logins (EventID 4625) per minute
          APPLY time-series anomaly detection model (e.g., Seasonal-Hybrid ESD)
          IF observed_rate > forecasted_upper_bound, ALERT
  - question: "Has a successful external login occurred from an IP address known to be a TOR exit node, anonymous proxy, or malicious C2 server?"
    context: "Adversaries use anonymizing services like TOR and proxies to obscure their true location and infrastructure. A successful login from an IP associated with these high-risk services is a major red flag, as it is highly unlikely to be legitimate user activity. This question helps prioritize these logins for immediate investigation, as they indicate a high probability of an active compromise."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Externally-facing authentication services, CTI data feeds for IP reputation, Geolocation databases, Network flow log collectors"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH successful_external_logins (EventID 4624)
          ENRICH source_IP with CTI_reputation_feed
          IF source_IP_tag is in ('TOR', 'Proxy', 'C2'), ALERT
  - question: "Has a user successfully logged in from a country-ASN pair that is both new for that user and globally rare across the entire organization?"
    context: "This is a form of 'impossible travel' or anomalous behavior detection. While a user traveling to a new country might generate an alert, this two-factor check adds more context. If the network (ASN) in that new country is also one that is rarely, if ever, used by anyone in the company, the activity is much more likely to be malicious. It filters out common travel scenarios and focuses on truly unusual and high-risk connections."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Externally-facing authentication services, CTI data feeds for IP reputation, Geolocation databases, Network flow log collectors"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each successful_login:
            GET source_country_ASN_pair
            CHECK if pair is new for user's 90-day baseline
            IF new for user:
              CALCULATE global_rarity of pair across all users
              IF global_rarity < 1%, ALERT
  - question: "Does a user's recent login exhibit anomalous characteristics (time, location, ASN) when compared to their established pattern of life using an unsupervised ML model?"
    context: "Every user develops a unique 'pattern of life' for their login activity. An unsupervised anomaly detection model, like an Isolation Forest, can learn this complex pattern without needing pre-labeled data. This allows the model to flag any login that significantly deviates from the user's normal behavior across multiple dimensions (e.g., a login from a new ASN at 3 AM). This provides a powerful, individualized detection capability."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Externally-facing authentication services, CTI data feeds for IP reputation, Geolocation databases, Network flow log collectors"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each user, train Isolation_Forest_model on their historical login features
          FOR each new login:
            CLASSIFY login with user's model
            IF login is classified as 'outlier', ALERT
  - question: "After the first successful login for a user whose credentials were in a data breach, did that user session involve privilege escalation?"
    context: "An adversary who has just gained initial access with breached credentials will often move quickly to escalate privileges to secure their foothold. This question focuses on the critical time window immediately following the first use of a compromised credential. By correlating this specific type of login with subsequent high-risk activities like being added to an admin group, analysts can rapidly detect and respond to an active intrusion."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4732"
      - "Windows Event ID 4728"
      - "Windows Event ID 4672"
      - "Zeek dns.log"
      - "Domain Controllers, Member Servers, CTI data feeds, Privileged Access Management (PAM) systems, DNS servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          DEFINE suspicious_login as first_login_post_credential_breach
          SEARCH for privilege_escalation_events (e.g., 4732, 4728, 4672)
          CORRELATE by user_session
          IF suspicious_login is followed by privilege_escalation in same session, ALERT
  - question: "Does a session initiated by a 'first use post-breach' account accumulate a high risk score based on subsequent actions?"
    context: "Instead of looking for a single high-risk action, this approach aggregates risk over an entire session. Minorly suspicious activities (like a DNS query to a new domain) that might not trigger an alert on their own can, in combination, indicate a compromise. By assigning weights to different post-login actions, a cumulative risk score can identify a malicious session even if it doesn't contain a single critical-level event."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4732"
      - "Windows Event ID 4728"
      - "Windows Event ID 4672"
      - "Zeek dns.log"
      - "Domain Controllers, Member Servers, CTI data feeds, Privileged Access Management (PAM) systems, DNS servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each session from 'first_use_post_breach' account:
            INITIALIZE session_risk_score = 0
            MONITOR subsequent events (DNS queries, group changes, etc.)
            ADD weighted score for each event
            IF session_risk_score > threshold, ALERT
  - question: "Is the sequence of actions in a session initiated by a 'first use post-breach' account anomalous compared to normal user behavior?"
    context: "Legitimate users follow predictable sequences of actions after logging in (e.g., open email, access file share). Adversaries often follow a different playbook (e.g., login, immediately escalate privileges, conduct reconnaissance). A sequence analysis model like an LSTM autoencoder can learn the normal 'grammar' of user behavior and flag sessions where the sequence of actions is illogical or has a high reconstruction error, indicating a probable compromise."
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4732"
      - "Windows Event ID 4728"
      - "Windows Event ID 4672"
      - "Zeek dns.log"
      - "Domain Controllers, Member Servers, CTI data feeds, Privileged Access Management (PAM) systems, DNS servers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          TRAIN LSTM_autoencoder on normal user action sequences
          FOR each 'first_use_post_breach' session:
            FEED action_sequence into LSTM_model
            CALCULATE reconstruction_error
            IF reconstruction_error is high, ALERT
  - question: "Has a web server process spawned a command-line interpreter or other high-risk reconnaissance tool?"
    context: "This is a classic indicator of a web shell. A web server's job is to serve web pages; it should not be spawning processes like 'cmd.exe' or 'powershell.exe'. Such an event strongly suggests that an attacker has compromised the web server, uploaded a malicious script (a web shell), and is now using it to execute commands on the underlying operating system to further their attack."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Externally-facing web servers, Application servers, Web server process logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH process_creation_logs (EventID 4688)
          FILTER for parent_process in ('w3wp.exe', 'apache.exe', 'nginx')
          FILTER for child_process in ('cmd.exe', 'powershell.exe', 'bash', 'whoami.exe')
          IF match found, ALERT
  - question: "Has a web server process spawned a child process that has never been seen before in its historical baseline?"
    context: "While some web applications may legitimately spawn child processes, this behavior is typically repetitive and predictable. By establishing a baseline of normal parent-child process relationships for web servers, analysts can use a 'zero-frequency' test to detect novel activity. The first time a web server spawns a new, previously unseen process, it represents a significant deviation from normal behavior and warrants immediate investigation for a potential web shell."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Externally-facing web servers, Application servers, Web server process logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          MAINTAIN 30-day baseline of (parent_process, child_process) pairs for web servers
          FOR each new process_creation_event:
            GET (parent, child) pair
            IF parent is web_server_process AND pair is not in baseline, ALERT
  - question: "Does a machine learning model classify a child process spawned by a web server as malicious?"
    context: "Adversaries may attempt to disguise their malicious executables or scripts with benign-sounding names to evade simple detection rules. A supervised machine learning model can perform a more sophisticated analysis, using features like the full command-line arguments to make a determination. By training the model on known malicious and benign process creation events, it can learn to identify suspicious patterns and alert on activity that signature-based methods might miss."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Externally-facing web servers, Application servers, Web server process logs"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each process creation where parent is web_server:
            EXTRACT features from child_process (name, command-line arguments)
            SCORE features with trained_classification_model
            IF predicted_class is 'malicious' with high confidence, ALERT