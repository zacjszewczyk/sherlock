name: T1027.012: LNK Icon Smuggling
id: f8e9a2b1-c3d4-4e5f-6a7b-8c9d0e1f2a3b
description: >-
  This playbook helps investigate potential defense evasion using the LNK Icon Smuggling technique (T1027.012). Adversaries embed malicious code or references within the icon path of a Windows shortcut (.lnk) file. When a user views the file, explorer.exe attempts to resolve the icon path, which can trigger the download and execution of a payload from a remote source. This playbook focuses on detecting the creation of suspicious LNK files by analyzing their icon paths for indicators like high-entropy strings, rare TLDs, UNC paths, and matches against threat intelligence. It also looks for the resulting anomalous network activity from the explorer.exe process and correlates these events with subsequent suspicious process execution to identify the full attack chain.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a newly created LNK file been observed with an icon path containing a URL, IP, or domain known to be malicious?
    context: >-
      This question aims to identify the most direct evidence of LNK icon smuggling. Adversaries often embed direct links to their command and control (C2) servers or payload delivery sites within the icon path. When a user navigates to the folder containing the LNK file, explorer.exe automatically tries to resolve this path, fetching the malicious content. Matching the extracted path against high-confidence threat intelligence provides a strong signal of malicious activity.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Zeek conn.log
      - Zeek http.log
      - Zeek dns.log
      - Endpoints (user workstations, servers), specifically in user-writable directories like Desktop and Downloads; Email security gateway sandboxes; Web proxy and DNS server logs.
    range: last 90 days
    queries:
      - SIEM_QUERY: >-
          ` (event_id=11 OR event_id=4663) AND file_name LIKE '%.lnk' | PARSE file_content to get icon_path | LOOKUP icon_path against threat_intel_feed | WHERE threat_match=true `
  - question: Is a newly created LNK file using a statistically rare Top-Level Domain (TLD) in its icon path?
    context: >-
      Adversaries may use newly registered or obscure TLDs to host malicious payloads, bypassing reputation filters that focus on common TLDs like .com or .org. This statistical approach helps detect novel threats that haven't yet been added to threat intelligence feeds. An LNK file pointing to a domain with a TLD that is rarely seen across the organization is a significant anomaly.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Zeek conn.log
      - Zeek http.log
      - Zeek dns.log
      - Endpoints (user workstations, servers), specifically in user-writable directories like Desktop and Downloads; Email security gateway sandboxes; Web proxy and DNS server logs.
    range: last 90 days
    queries:
      - SIEM_QUERY: >-
          ` (event_id=11 OR event_id=4663) AND file_name LIKE '%.lnk' | PARSE file_content to get icon_path | EXTRACT TLD from icon_path | COMPARE TLD_frequency against 30-day baseline | WHERE TLD_frequency < 5th_percentile `
  - question: Does a newly created LNK file's icon path have characteristics that a machine learning model classifies as malicious?
    context: >-
      This question leverages a machine learning model to identify subtle malicious characteristics in LNK icon paths that rule-based detections might miss. By analyzing features like string length, randomness (entropy), and domain reputation, the model can score the likelihood of a path being malicious. A high probability score (>0.85) provides a data-driven, automated way to flag suspicious LNK files for investigation.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Zeek conn.log
      - Zeek http.log
      - Zeek dns.log
      - Endpoints (user workstations, servers), specifically in user-writable directories like Desktop and Downloads; Email security gateway sandboxes; Web proxy and DNS server logs.
    range: last 90 days
    queries:
      - ML_MODEL_PSEUDOCODE: >-
          ` features = extract_features(icon_path) -> [length, entropy, has_ip, tld_encoded, tld_rank] | prediction = model.predict(features) | IF prediction_score > 0.85 THEN ALERT `
  - question: Has a new LNK file been created with an icon path pointing to a remote UNC path or a non-standard local directory?
    context: >-
      This question seeks to identify LNK files configured to fetch icons from unusual locations. Legitimate LNK files typically point to local executables in standard directories. An icon path pointing to a remote server via a UNC path (e.g., \\attacker.com\payload) is a classic method for forcing an SMB connection to a malicious host. Similarly, paths pointing to temporary or user-writable directories (%APPDATA%, %TEMP%) are suspicious, as these locations are often used by malware to stage files.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Zeek smb_files.log
      - Zeek conn.log
      - Endpoints (user workstations, terminal servers), network file shares, and logs from domain controllers and SMB file servers.
    range: last 90 days
    queries:
      - SIEM_QUERY: >-
          ` event_id=11 AND file_name LIKE '%.lnk' | PARSE file_content to get icon_path | IF icon_path MATCHES_REGEX ('^\\\\\\\\', '@SSL', '%TEMP%', '%PUBLIC%', '%APPDATA%') THEN ALERT `
  - question: Does a new LNK file contain an icon path with an abnormally high level of randomness (entropy)?
    context: >-
      This question attempts to detect obfuscated commands or data smuggled within the icon path. Adversaries may encode scripts or commands directly into the icon path string, which often results in a higher character entropy (randomness) than a typical file path. By comparing the entropy of a new LNK's icon path to a historical baseline, we can flag statistical outliers that may indicate obfuscation.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Zeek smb_files.log
      - Zeek conn.log
      - Endpoints (user workstations, terminal servers), network file shares, and logs from domain controllers and SMB file servers.
    range: last 90 days
    queries:
      - SIEM_QUERY: >-
          ` event_id=11 AND file_name LIKE '%.lnk' | PARSE file_content to get icon_path | CALCULATE shannon_entropy(icon_path) | COMPARE entropy_score to 90-day baseline | IF entropy_score > 98th_percentile THEN ALERT `
  - question: Does a new LNK file's icon path have structural features that an anomaly detection model flags as an outlier?
    context: >-
      This question uses an unsupervised machine learning model to find LNK icon paths that 'don't look right' compared to the vast majority of benign ones. The model learns the normal patterns of path length, directory structure, and hostname formats. It can then flag icon paths that deviate significantly, such as those that are unusually long, have an abnormal directory depth, or use a numeric IP address as a hostname, all of which can be indicators of malicious intent.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Zeek smb_files.log
      - Zeek conn.log
      - Endpoints (user workstations, terminal servers), network file shares, and logs from domain controllers and SMB file servers.
    range: last 90 days
    queries:
      - ML_MODEL_PSEUDOCODE: >-
          ` features = extract_features(icon_path) -> [length, dir_depth, has_numeric_host, is_unc] | prediction = model.predict(features) | IF prediction == 'outlier' THEN ALERT `
  - question: Has the Windows Explorer process (explorer.exe) been observed making a network connection to an unapproved external IP address?
    context: >-
      This question focuses on the secondary effect of LNK icon smuggling. The explorer.exe process is responsible for rendering the user interface, including file icons. It should not be making direct outbound connections to arbitrary external IP addresses. Such an event is highly anomalous and a strong indicator that Explorer is attempting to resolve a malicious path, likely from an LNK file's icon resource, to download a payload or contact a C2 server.
    answer_sources:
      - Windows Sysmon Event ID 3
      - Windows Sysmon Event ID 1
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek files.log
      - Zeek dns.log
      - Endpoint EDR/process monitoring logs; Network security monitoring logs at egress points (e.g., firewalls, proxies); DNS server query logs.
    range: last 90 days
    queries:
      - SIEM_QUERY: >-
          ` event_id=3 AND process_name='explorer.exe' AND is_external(destination_ip) | WHERE destination_ip NOT IN (approved_ip_list) | ALERT `
  - question: Has a host shown an increase in the number of distinct external IP addresses contacted by explorer.exe?
    context: >-
      This question establishes a behavioral baseline for explorer.exe network activity. For any given host, the expected number of external IPs contacted by Explorer is zero. Any deviation from this baseline is a statistical anomaly. This method is effective for detecting low-and-slow activity or connections to novel infrastructure, with the alert's severity increasing based on the reputation and rarity of the destination IP.
    answer_sources:
      - Windows Sysmon Event ID 3
      - Windows Sysmon Event ID 1
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek files.log
      - Zeek dns.log
      - Endpoint EDR/process monitoring logs; Network security monitoring logs at egress points (e.g., firewalls, proxies); DNS server query logs.
    range: last 90 days
    queries:
      - SIEM_QUERY: >-
          ` event_id=3 AND process_name='explorer.exe' AND is_external(destination_ip) | STATS count(distinct destination_ip) by host | WHERE count > 0 | ENRICH destination_ip with reputation_data | CALCULATE risk_score | ALERT `
  - question: Has there been a statistically significant deviation in the volume of outbound network traffic or connection counts originating from explorer.exe?
    context: >-
      This question uses time-series analysis to detect anomalies in the network behavior of explorer.exe. By modeling the expected (near-zero) outbound traffic volume and connection frequency over time, the algorithm can automatically flag any uncharacteristic spikes. This is useful for detecting the download of a large payload or a 'heartbeat' C2 communication pattern initiated by the resolution of a malicious LNK icon.
    answer_sources:
      - Windows Sysmon Event ID 3
      - Windows Sysmon Event ID 1
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek files.log
      - Zeek dns.log
      - Endpoint EDR/process monitoring logs; Network security monitoring logs at egress points (e.g., firewalls, proxies); DNS server query logs.
    range: last 90 days
    queries:
      - TIME_SERIES_PSEUDOCODE: >-
          ` data = aggregate_network_flows(process_name='explorer.exe') | model = train_timeseries_model(data) | prediction = model.predict_next_interval() | IF actual_value is statistically_different_from(prediction) THEN ALERT `
  - question: Has a host exhibited the specific event sequence of LNK file creation, followed by an explorer.exe network connection, and then a suspicious child process execution?
    context: >-
      This question seeks to identify the full attack chain of LNK icon smuggling by correlating discrete events in a specific sequence. This pattern—a new LNK file appears, explorer.exe reaches out to the network (to fetch the payload), and then a new process is spawned from that activity—is a high-confidence indicator of successful execution. Correlating these events within a short time window on a single host creates a critical alert that is highly unlikely to be a false positive.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Windows Sysmon Event ID 3
      - Windows Sysmon Event ID 1
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek files.log
      - Aggregated security logs in a central SIEM or data lake containing endpoint process, file, and network events; EDR platform consoles.
    range: last 90 days
    queries:
      - SIEM_CORRELATION_QUERY: >-
          ` SEQUENCE on host within 5m: [event_id=11 AND file_name LIKE '%.lnk'] -> [event_id=3 AND process_name='explorer.exe' AND is_external(destination_ip)] -> [event_id=1 AND (parent_process_name='explorer.exe' OR parent_process_name='rundll32.exe')] | ALERT `
  - question: Has a host accumulated a high risk score based on a combination of suspicious activities related to LNK files and process execution?
    context: >-
      This question moves beyond single indicators to a holistic risk-based approach. Instead of alerting on one event, it aggregates the risk of several related, but not necessarily sequential, suspicious behaviors within an hour. Events like an LNK file creation, an outbound explorer.exe connection, and the execution of an unsigned process from a temp directory are each assigned a risk value. When a host's cumulative score crosses a dynamic, statistically-defined threshold, it signals that a significant, multi-faceted event is likely underway.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Windows Sysmon Event ID 3
      - Windows Sysmon Event ID 1
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek files.log
      - Aggregated security logs in a central SIEM or data lake containing endpoint process, file, and network events; EDR platform consoles.
    range: last 90 days
    queries:
      - SIEM_RISK_SCORING_QUERY: >-
          ` AGGREGATE events by host over 1h | CALCULATE score = (count(lnk_creation)*10 + count(explorer_outbound)*50 + count(unsigned_proc)*25) | COMPARE host_score to 24h baseline | IF host_score > 99th_percentile THEN ALERT `
  - question: Can a graph-based analysis of endpoint data reveal a connected chain of events matching the LNK icon smuggling attack pattern?
    context: >-
      This question uses a powerful graph database approach to visualize and query relationships between security events. By modeling processes, files, and network connections as a graph, we can explicitly search for the causal chain of the attack: a process writes an LNK file, which leads to explorer.exe creating a network connection. This method is highly effective at uncovering complex attack paths and providing analysts with a clear, contextualized view of the entire event sequence, making it a high-confidence detection technique.
    answer_sources:
      - Windows Sysmon Event ID 11
      - Windows Event ID 4663
      - Windows Sysmon Event ID 3
      - Windows Sysmon Event ID 1
      - Windows Event ID 4688
      - Zeek conn.log
      - Zeek files.log
      - Aggregated security logs in a central SIEM or data lake containing endpoint process, file, and network events; EDR platform consoles.
    range: last 90 days
    queries:
      - GRAPH_DB_QUERY: >-
          ` MATCH (f:File {name: '*.lnk'})<-[:WROTE]-(p1:Process)-[:CREATED]->(p2:Process {name: 'explorer.exe'})-[:INITIATED]->(c:Connection {direction: 'outbound'}) RETURN p1, p2, f, c `