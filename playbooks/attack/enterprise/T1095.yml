name: "T1095: Non-Application Layer Protocol"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps investigate whether an adversary has established command and control (C2) using a non-application layer protocol, such as ICMP, or raw UDP/TCP on non-standard ports. This technique is often used to bypass security controls that focus on application-layer traffic. The investigation focuses on identifying outbound connections to known C2 infrastructure, detecting anomalous traffic patterns like unusual payload sizes or entropy, finding signatures of known ICMP tunneling tools, identifying unexpected processes initiating ICMP connections on hosts, and detecting periodic beaconing behavior indicative of automated malware."
type: "technique"
related:
  - "TA0011: Command and Control"
contributors: "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are internal hosts communicating with known C2 IP addresses using ICMP, raw UDP, or TCP?"
    context: "This question aims to detect direct communication with known malicious infrastructure. Matching outbound traffic against a high-fidelity threat intelligence feed is a primary method for identifying active C2 channels."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points (e.g., Internet Gateway, VPN Concentrators)"
    range: "last 90 days"
    queries:
      - "SEARCH Zeek logs (conn, icmp) WHERE protocol in (icmp, udp, tcp) | JOIN destination_ip WITH threat_intel_feed ON ip_address | ALERT if match"
  - question: "Is any internal host contacting an anomalously high number of unique external IPs via ICMP?"
    context: "This question seeks to identify hosts that exhibit scanning behavior or are using a wide-spread C2 infrastructure. A sudden spike in the number of unique destinations contacted via ICMP, compared to the host's normal behavior, is a strong indicator of compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points (e.g., Internet Gateway, VPN Concentrators)"
    range: "last 90 days"
    queries:
      - "FOR EACH source_ip | CALCULATE daily_unique_destination_ip_count FOR ICMP traffic | COMPARE count to 30-day rolling average + 3*std_dev | ALERT if count > threshold"
  - question: "Are internal hosts connecting to external IPs predicted to be C2 servers by a machine learning model?"
    context: "This question uses predictive analytics to identify potential C2 servers that may not yet be on known threat intelligence lists. By analyzing various network and enriched features, a machine learning model can flag suspicious destinations with high confidence, enabling proactive threat detection."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points (e.g., Internet Gateway, VPN Concentrators)"
    range: "last 90 days"
    queries:
      - "FOR EACH outbound_connection | EXTRACT features (duration, bytes, proto, ASN, geo, etc.) | INPUT features into pre-trained classification model | ALERT if classification is 'C2' with high confidence"
  - question: "Is any ICMP traffic matching signatures of known ICMP tunneling C2 tools?"
    context: "This question aims to detect the use of specific, known tools that tunnel C2 communications over ICMP. By inspecting ICMP packet payloads for unique byte sequences or patterns, we can identify malware like 'icmpsh' or 'Loki' with high precision."
    answer_sources:
      - "Zeek icmp.log"
      - "Internal Network Segments and Core Switches"
    range: "last 90 days"
    queries:
      - "SEARCH Zeek icmp.log | APPLY regex/signature matching on payload FOR known ICMP C2 tools | ALERT on match"
  - question: "Are there any ICMP flows with a highly skewed ratio of echo-requests to echo-replies?"
    context: "This question identifies anomalous ICMP communication patterns. Legitimate 'ping' activity typically has a request-to-reply ratio near 1:1. A highly imbalanced ratio suggests one-way data transfer, a common characteristic of ICMP tunneling for data exfiltration or command delivery."
    answer_sources:
      - "Zeek icmp.log"
      - "Internal Network Segments and Core Switches"
    range: "last 90 days"
    queries:
      - "FOR EACH source_dest_ip_pair | CALCULATE ratio of ICMP echo-requests to echo-replies over 1-hour window | ALERT if ratio is highly skewed (e.g., >10 or <0.1)"
  - question: "Does any ICMP traffic exhibit sequential anomalies detected by an RNN/LSTM model?"
    context: "This question uses advanced anomaly detection to find subtle, stateful C2 communication over ICMP. An RNN/LSTM model learns the normal sequence of ICMP packet characteristics (size, timing, type) and can flag new sequences that deviate significantly, indicating a hidden communication channel."
    answer_sources:
      - "Zeek icmp.log"
      - "Internal Network Segments and Core Switches"
    range: "last 90 days"
    queries:
      - "FOR EACH ICMP flow | CREATE time-series of features (payload_length, inter-arrival_time, type/code) | INPUT to trained RNN/LSTM model | ALERT if reconstruction error is high"
  - question: "Are there any outbound ICMP, UDP, or TCP flows with unusually large payloads?"
    context: "This question helps find hidden data transfers. ICMP packets and non-standard UDP/TCP flows typically have small payloads. An unusually large payload can indicate that an attacker is tunneling data, such as exfiltrating files or receiving large command blocks."
    answer_sources:
      - "Zeek icmp.log"
      - "Zeek conn.log"
      - "Network Egress Points"
    range: "last 90 days"
    queries:
      - "SEARCH Zeek icmp/conn logs for outbound traffic | ALERT if ICMP payload > 1024 bytes OR if UDP/TCP on non-standard port has average packet size > 1024 bytes"
  - question: "Are there any outbound ICMP, UDP, or TCP flows with unusually high payload entropy?"
    context: "This question aims to detect encrypted or compressed C2 traffic. High Shannon entropy indicates a high degree of randomness, which is characteristic of encrypted or packed data. Finding this in protocols or on ports where it's not expected is a strong indicator of malicious activity."
    answer_sources:
      - "Zeek icmp.log"
      - "Zeek conn.log"
      - "Network Egress Points"
    range: "last 90 days"
    queries:
      - "FOR EACH outbound flow (ICMP, UDP, TCP) | CALCULATE Shannon entropy of payload | COMPARE to historical baseline for that protocol | ALERT if entropy > 99th percentile"
  - question: "Can unsupervised clustering identify anomalous groups of network flows?"
    context: "This question uses machine learning to find 'unknown unknowns'. By grouping all network flows based on their characteristics, clustering algorithms can automatically identify small, outlier clusters that do not conform to normal traffic patterns. These outlier clusters often represent suspicious or malicious activity, such as C2, that warrants investigation."
    answer_sources:
      - "Zeek icmp.log"
      - "Zeek conn.log"
      - "Network Egress Points"
    range: "last 90 days"
    queries:
      - "COLLECT network flows with features (proto, port, bytes, avg_size, entropy) | APPLY clustering algorithm (e.g., DBSCAN) | INVESTIGATE outlier clusters"
  - question: "Is a non-standard application initiating outbound ICMP connections?"
    context: "This question focuses on host-level evidence to identify abuse of the ICMP protocol. While network tools like 'ping.exe' are expected to create ICMP traffic, an application like 'powershell.exe' or a document reader doing so is highly suspicious and could indicate a process has been compromised to act as a C2 agent."
    answer_sources:
      - "Windows Event ID 5156"
      - "Windows Event ID 4688"
      - "User Workstations and Critical Servers"
    range: "last 90 days"
    queries:
      - "SEARCH for Event ID 5156 with Protocol=1 (ICMP) | IF 'Application Name' is NOT in allowlist (ping.exe, etc.) | CORRELATE with Event ID 4688 for process details | ALERT"
  - question: "Are rare or unique processes initiating ICMP connections across the enterprise?"
    context: "This question uses the 'stack counting' or 'least frequency of occurrence' analysis method to find outliers. A process that very few machines use to make ICMP connections is inherently suspicious. This technique is effective at finding novel malware or living-off-the-land techniques without prior signatures."
    answer_sources:
      - "Windows Event ID 5156"
      - "Windows Event ID 4688"
      - "User Workstations and Critical Servers"
    range: "last 90 days"
    queries:
      - "AGGREGATE all processes making ICMP connections across all endpoints | CALCULATE rarity of each process | ALERT on least frequent processes (e.g., bottom 1%)"
  - question: "Is a machine learning model flagging any process-network connection events as malicious?"
    context: "This question leverages a predictive model to evaluate the context surrounding a network connection. By considering not just the process and protocol, but also its parent, its path, and recent file system activity, a model can make a more informed decision about whether a connection is legitimate or part of a malicious toolchain."
    answer_sources:
      - "Windows Event ID 5156"
      - "Windows Event ID 4688"
      - "User Workstations and Critical Servers"
    range: "last 90 days"
    queries:
      - "FOR EACH network connection event (EID 5156) | ENRICH with process metadata (EID 4688) and behavioral features | INPUT features to trained classification model | ALERT if classified as malicious with high confidence"
  - question: "Has Zeek detected any weird or non-standard network behavior for UDP or ICMP traffic?"
    context: "This question leverages the built-in anomaly detection capabilities of Zeek. Notices in 'weird.log' often point to protocol violations or unusual behaviors that don't fit standard models, which can be a strong indicator of custom C2 protocols designed to evade typical firewalls and IDS/IPS systems."
    answer_sources:
      - "Zeek weird.log"
      - "Network Egress Points and Internal Network Segments"
    range: "last 90 days"
    queries:
      - "SEARCH Zeek weird.log for notices like 'active_connection_without_SYN' or 'data_before_established' | FILTER for UDP/ICMP protocols | ALERT on any match"
  - question: "Are there any network flows with highly regular, periodic connection intervals?"
    context: "This question seeks to identify the 'heartbeat' of malware C2 communications. Automated tools often communicate at very precise intervals (e.g., every 60 seconds). A very low standard deviation in the time between connections is a classic sign of this machine-generated beaconing, distinguishing it from human-driven traffic."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points and Internal Network Segments"
    range: "last 90 days"
    queries:
      - "FOR EACH source_dest_pair (ICMP/UDP) | CALCULATE standard deviation of time between connections | ALERT if std_dev is below a low threshold (e.g., < 1 second)"
  - question: "Can frequency analysis (FFT) detect periodic signaling in any network flows?"
    context: "This question uses a more sophisticated signal processing technique to detect beaconing, even if it's 'jittered' or has some variation. A Fast Fourier Transform (FFT) can convert a time series of network events into the frequency domain, making it easy to spot a dominant, repeating frequency that represents a C2 beacon."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points and Internal Network Segments"
    range: "last 90 days"
    queries:
      - "FOR EACH source_dest_flow | CREATE time-series of connection events | APPLY FFT algorithm | ALERT if a strong, dominant frequency is detected"