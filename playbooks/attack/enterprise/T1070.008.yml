name: "T1070.008: Clear Mailbox Data"
id: "9c1b9e9a-7f1a-4c9b-8f1a-9c1b9e9a7f1a"
description: "This playbook helps investigate whether an adversary is attempting to evade defenses by clearing mailbox data. This involves looking for evidence such as the execution of known malicious mailbox clearing tools, the use of specific PowerShell cmdlets or command-line arguments for deleting mail content (e.g., 'Search-Mailbox -DeleteContent'), the direct deletion of mail server database files (.edb) or user archives (.pst, .ost), a high volume of deletion commands from a single user or host in a short time frame, or mailbox clearing activities occurring in close temporal proximity to other suspicious events like anomalous logins or credential access."
type: "technique"
related: "TA0005: Defense Evasion"
contributors: "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a known malicious mailbox clearing tool been executed, based on command-line arguments or script block hash?"
    context: "This question seeks to identify the use of known malicious tools by matching their execution signatures (command-line arguments or PowerShell script block hashes) against a curated list. A direct match provides a high-confidence indicator that an adversary is attempting to clear mailbox data as part of a defense evasion strategy."
    answer_sources: "Windows Event ID 4688, Windows PowerShell Event ID 4104 from Microsoft Exchange Servers, Mail Gateway Servers, Administrator Workstations, and Microsoft 365 / Exchange Online tenancy."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "SEARCH process_creation_events OR powershell_script_logs WHERE (command_line IN (known_malicious_signatures) OR script_block_hash IN (known_malicious_hashes))"
  - question: "Has a rare or uncommon command been executed on a mail server or by an administrator, suggesting a potentially malicious action?"
    context: "This question aims to uncover suspicious commands that are not part of known malicious toolsets but deviate from normal activity. By analyzing the prevalence of command-line hashes across the enterprise, we can identify rare executions on critical mail infrastructure or by privileged users. Such rarity is a strong statistical indicator of a non-standard, and possibly malicious, tool being used to clear mailbox data."
    answer_sources: "Windows Event ID 4688, Windows PowerShell Event ID 4104 from Microsoft Exchange Servers, Mail Gateway Servers, Administrator Workstations, and Microsoft 365 / Exchange Online tenancy."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "GROUP command_line_executions BY command_line_hash | COUNT hosts per hash | FILTER host_count < 5 AND (is_mail_server OR is_admin_user)"
  - question: "Is there anomalous command-line or PowerShell script activity on mail servers that deviates from the established baseline of normal administrative behavior?"
    context: "This question uses a machine learning approach to detect novel or unknown threats. By training a model on what constitutes 'normal' command-line and script execution on mail servers, it can identify outliers that don't fit this profile. This is useful for catching obfuscated or custom tools that would be missed by signature-based or simple statistical methods."
    answer_sources: "Windows Event ID 4688, Windows PowerShell Event ID 4104 from Microsoft Exchange Servers, Mail Gateway Servers, Administrator Workstations, and Microsoft 365 / Exchange Online tenancy."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "EXTRACT features (length, arg_count, entropy) from command_lines and scripts on mail_servers | APPLY one-class_SVM_model | IDENTIFY outliers flagged as anomalous"
  - question: "Have any specific cmdlets or command-line arguments associated with mailbox data deletion been executed?"
    context: "This question focuses on finding direct evidence of data clearing attempts by searching for specific, known commands and cmdlets used for this purpose (e.g., 'Search-Mailbox -DeleteContent', 'New-ComplianceSearchAction -Purge'). Identifying these keywords in process, script, or cloud audit logs is a strong indicator of malicious intent, especially when executed by non-administrative or unusual user accounts."
    answer_sources: "Windows Event ID 4688, Windows PowerShell Event ID 4104, Microsoft 365 Unified Audit Log from Microsoft Exchange Servers, Microsoft 365 / Exchange Online tenancy, Domain Controllers, and Administrator Workstations."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "SEARCH process_logs, powershell_logs, m365_audit_logs FOR REGEX ('Remove-MailboxExportRequest' OR 'Search-Mailbox -DeleteContent' OR 'New-ComplianceSearchAction -Purge' OR 'Set-InboxRule -Delete')"
  - question: "Has any user executed an unusually high number of deletion-related Exchange cmdlets compared to their personal baseline, or shown signs of repetitive, scripted activity?"
    context: "This question aims to detect abnormal user behavior that might indicate a compromised account or insider threat. Instead of a fixed global threshold, it uses a personalized baseline for each user's activity. An alert is triggered when a user's execution of deletion-related cmdlets significantly exceeds their own normal behavior, or if the pattern of commands suggests automated scripting (low entropy), which is more sensitive to subtle anomalies."
    answer_sources: "Windows Event ID 4688, Windows PowerShell Event ID 4104, Microsoft 365 Unified Audit Log from Microsoft Exchange Servers, Microsoft 365 / Exchange Online tenancy, Domain Controllers, and Administrator Workstations."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "FOR each_user, CALCULATE daily_baseline of deletion_cmdlet_count | ALERT if daily_count > 95th_percentile_of_baseline | ALSO, calculate cmdlet_name_entropy_per_session | ALERT on sudden entropy_decrease"
  - question: "Has a sequence of executed cmdlets deviated from normal, learned administrative workflows?"
    context: "This question uses a sequence analysis model to understand the context and flow of administrative actions. A normal workflow might involve creating, checking, and then modifying a mail rule. An anomalous sequence, like creating an export request and then immediately deleting it, has a low probability of being a legitimate action and strongly suggests an adversary trying to cover their tracks."
    answer_sources: "Windows Event ID 4688, Windows PowerShell Event ID 4104, Microsoft 365 Unified Audit Log from Microsoft Exchange Servers, Microsoft 365 / Exchange Online tenancy, Domain Controllers, and Administrator Workstations."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "MODEL cmdlet_sequences from normal admin_sessions using LSTM | FEED real-time cmdlet_sequences to model | ALERT if sequence has low probability"
  - question: "Have critical mail server database files or user mail archives been deleted?"
    context: "This question looks for the most direct form of data destruction: the deletion of the files themselves. By monitoring file system events for deletions of Exchange database files (*.edb), logs (*.log), or user archives (*.pst, *.ost), an analyst can detect blatant attempts to destroy evidence. Correlating this with the process that initiated the deletion (e.g., `powershell.exe` vs. a legitimate backup service) adds critical context."
    answer_sources: "Windows Event ID 4663, Sysmon Event ID 23 from Microsoft Exchange Server database and log directories, and User profile directories containing PST/OST files on endpoints and file servers."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "SEARCH file_delete_events WHERE (target_path_endsWith('.edb', '.pst', '.ost') AND access_type CONTAINS 'DELETE') | ESCALATE if process_name NOT IN (legit_backup_processes)"
  - question: "Is there a statistically significant spike in file deletions within mail-related directories initiated by a non-standard process?"
    context: "This question aims to find anomalous file deletion activity that might otherwise be lost in noise. By establishing a baseline of normal file deletion rates per process in mail directories, it can flag when a process like `cmd.exe` or `powershell.exe` suddenly starts deleting files at a rate that is several standard deviations above its norm, which is highly suspicious."
    answer_sources: "Windows Event ID 4663, Sysmon Event ID 23 from Microsoft Exchange Server database and log directories, and User profile directories containing PST/OST files on endpoints and file servers."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "FOR each_process, CALCULATE baseline hourly_deletion_count in mail_directories | ALERT if hourly_count > (mean + 3 * std_dev) AND process_name IS NOT standard_mail_process"
  - question: "Are there anomalous clusters of file deletion activity that differ from normal operational patterns?"
    context: "This question uses unsupervised machine learning to find unusual patterns of file deletions without prior knowledge of what is 'bad'. By clustering events based on features like the process name, user account, file type, and time of day, the model can isolate outliers. For example, a cluster of *.pst file deletions by `rundll32.exe` outside of business hours would be distinct from normal activity and warrant investigation."
    answer_sources: "Windows Event ID 4663, Sysmon Event ID 23 from Microsoft Exchange Server database and log directories, and User profile directories containing PST/OST files on endpoints and file servers."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "CLUSTER file_deletion_events using DBSCAN on features (process, user, file_ext, time_of_day) | INVESTIGATE anomalous clusters"
  - question: "Has a single user or host generated a high volume of mail deletion events in a very short time frame?"
    context: "This question acts as a simple but effective tripwire for brute-force or scripted data clearing. It uses a fixed threshold to detect a large number of deletion-related actions (cmdlets or file deletions) from a single source within a small window (e.g., >50 events in 10 minutes). Such a burst of activity is highly unlikely to be legitimate manual user behavior."
    answer_sources: "Windows Event ID 4688, Windows Event ID 4663, Windows PowerShell Event ID 4104, Microsoft 365 Unified Audit Log from Microsoft Exchange Servers, user endpoints, and Microsoft 365 / Exchange Online tenancy."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "COUNT deletion_events BY user, source_host over 10-minute_windows | ALERT if count > 50"
  - question: "Has a user's mail deletion activity significantly exceeded their own historical baseline?"
    context: "This question provides a more nuanced approach than a fixed threshold by creating a personalized activity profile for each user. It detects when a user's hourly mail deletion count spikes above their own 99th percentile. This method is more sensitive and can flag a compromised account or insider threat whose activity might not be high enough to trigger a global threshold but is highly abnormal for them."
    answer_sources: "Windows Event ID 4688, Windows Event ID 4663, Windows PowerShell Event ID 4104, Microsoft 365 Unified Audit Log from Microsoft Exchange Servers, user endpoints, and Microsoft 365 / Exchange Online tenancy."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "FOR each_user, PROFILE hourly_deletion_count over 30_days | ALERT if current_hourly_count > 99th_percentile_of_profile"
  - question: "Has there been a sudden, anomalous burst of mail deletion activity across the entire organization that deviates from normal patterns?"
    context: "This question uses time-series analysis to model the normal 'rhythm' of mail deletion activity for the whole organization, accounting for patterns like time of day and day of the week. This allows it to detect sudden, sharp spikes in deletions that are anomalous when compared to the established seasonal patterns, indicating a possible automated or coordinated attack."
    answer_sources: "Windows Event ID 4688, Windows Event ID 4663, Windows PowerShell Event ID 4104, Microsoft 365 Unified Audit Log from Microsoft Exchange Servers, user endpoints, and Microsoft 365 / Exchange Online tenancy."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "MODEL organization_wide_deletion_events_per_minute using time_series_model | ALERT on anomalous_spikes that deviate from learned seasonal_patterns"
  - question: "Did a mailbox clearing event occur within 30 minutes of another high-confidence security alert for the same user or host?"
    context: "This question focuses on correlating events to build a more complete attack narrative. A mailbox clearing event on its own is suspicious, but when it happens immediately before or after another malicious event (like credential dumping or a remote login from an unusual IP), it significantly increases the confidence that this is part of a broader attack, likely to cover tracks after a compromise."
    answer_sources: "Windows Event ID 4688, Windows Event ID 4663, Windows Event ID 4624, Windows PowerShell Event ID 4104, Zeek conn.log, Zeek files.log from the entire enterprise network."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "CORRELATE mailbox_clearing_alert with other_high_confidence_alerts (e.g., lsass_access, anomalous_logon) for same_user/host within a 30_minute_window"
  - question: "Has a host or user accumulated a high composite risk score by exhibiting multiple suspicious behaviors, including mailbox clearing?"
    context: "This question moves beyond single alerts to a risk-based approach. It aggregates various suspicious activities, each assigned a weight, into a single risk score for a host or user. A mailbox clearing event would contribute a high value to this score. When combined with other anomalies like logins from rare geolocations or large data uploads, the cumulative score can cross a threshold and trigger a high-fidelity alert on a compromised entity."
    answer_sources: "Windows Event ID 4688, Windows Event ID 4663, Windows Event ID 4624, Windows PowerShell Event ID 4104, Zeek conn.log, Zeek files.log from the entire enterprise network."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "MAINTAIN risk_score for each host/user | INCREMENT score for weighted_events (e.g., mailbox_clearing, rare_geo_login) | ALERT when risk_score > threshold"
  - question: "Does the mailbox clearing activity form part of a larger graph of suspicious behaviors that matches a known attack pattern?"
    context: "This question uses advanced graph analytics to connect disparate events into a coherent attack chain. Entities like users, hosts, and processes are nodes, and their actions are edges. A machine learning model can then identify subgraphs where a 'mailbox-clearing' node is linked to other malicious activity nodes like 'credential-dumping' and 'lateral-movement' for the same user/host, revealing the full scope of the attack."
    answer_sources: "Windows Event ID 4688, Windows Event ID 4663, Windows Event ID 4624, Windows PowerShell Event ID 4104, Zeek conn.log, Zeek files.log from the entire enterprise network."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: "BUILD entity_graph (users, hosts, processes) | TRAIN GNN_model on known_attack_patterns | IDENTIFY subgraphs where 'mailbox_clearing' is linked to 'credential_dumping', 'lateral_movement', etc."