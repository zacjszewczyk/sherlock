name: T1070.008: Clear Mailbox Data
id: 6f54c93c-2384-469b-9806-38d5e1f062a4
description: This playbook helps investigate whether an adversary is attempting to evade defenses by clearing mailbox data. This can involve running known malicious tools, executing specific PowerShell cmdlets to delete or purge mail items, directly deleting mail database files (*.edb) or archives (*.pst), executing a high volume of deletion commands in a short time, or performing these actions in close proximity to other suspicious activities like anomalous logins or credential access.
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a known malicious mailbox clearing tool been executed, identified by its command-line or script hash?
  context: This question seeks to identify the use of known malicious tools by matching their exact signatures (command-line arguments or script block SHA256 hashes) against process creation and PowerShell logs. A match provides high-confidence evidence of a defense evasion attempt using pre-existing malware or scripts.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Microsoft Exchange Servers
  - Mail Gateway Servers
  - Administrator Workstations
  - Microsoft 365 / Exchange Online tenancy
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_creation_logs OR powershell_script_logs WHERE (command_line IN (known_malicious_signatures)) OR (script_block_hash IN (known_malicious_hashes))
- question: Has a rare command been executed on a mail server or by an administrator, suggesting a potentially malicious or unauthorized tool?
  context: This question aims to uncover novel or custom tools not caught by signature-based detections. By calculating the prevalence of every command hash across the enterprise, commands that are exceptionally rare but executed on sensitive assets like mail servers can be flagged as suspicious, indicating a possible targeted attack tool.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Microsoft Exchange Servers
  - Mail Gateway Servers
  - Administrator Workstations
  - Microsoft 365 / Exchange Online tenancy
  range: last 30 days
  queries:
  - pseudocode: AGGREGATE command_line_hash from process_creation_logs over 30 days. COUNT hosts per hash. FILTER for hashes seen on < 5 hosts AND executed on mail_servers.
- question: Has an anomalous command-line or PowerShell script been executed on a mail server that deviates from the normal profile of administrative activity?
  context: This question uses a machine learning model to establish a baseline of normal command-line and script activity on mail servers. The purpose is to detect outliers that do not conform to this learned profile. This can identify sophisticated adversaries using custom or obfuscated commands that are not explicitly malicious but are anomalous in the context of normal administrative behavior.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Microsoft Exchange Servers
  - Mail Gateway Servers
  - Administrator Workstations
  - Microsoft 365 / Exchange Online tenancy
  range: last 90 days
  queries:
  - pseudocode: EXTRACT features (length, arg_count, entropy) from new command_lines. APPLY pre-trained SVM model. ALERT on outliers.
- question: Is there evidence of specific PowerShell cmdlets or command-line arguments being used to delete mailbox content, remove export requests, or manipulate inbox rules?
  context: This question looks for the direct use of commands and cmdlets known to be associated with mailbox data destruction. By searching for keywords like 'Remove-MailboxExportRequest', 'Search-Mailbox -DeleteContent', or 'Set-InboxRule -Delete', analysts can find explicit attempts to cover tracks or destroy evidence, especially when executed by non-administrative or unexpected user accounts.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Microsoft 365 Unified Audit Log
  - Microsoft Exchange Servers
  - Microsoft 365 / Exchange Online tenancy
  - Domain Controllers (for PowerShell remoting logs)
  - Administrator Workstations
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_logs, powershell_logs, m365_audit_logs FOR keywords like 'Remove-MailboxExportRequest', 'Search-Mailbox -DeleteContent', 'New-ComplianceSearchAction -Purge'.
- question: Has any user exhibited an unusually high frequency or atypical pattern of executing mail deletion-related cmdlets compared to their own baseline?
  context: This question focuses on detecting abuse of legitimate credentials by establishing a personalized activity baseline for each user. An alert is triggered when a user's execution of deletion-related cmdlets significantly exceeds their own historical norm. This approach is more precise than a global threshold and can effectively identify a compromised account being used to perform actions that are abnormal for that specific user.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Microsoft 365 Unified Audit Log
  - Microsoft Exchange Servers
  - Microsoft 365 / Exchange Online tenancy
  - Domain Controllers (for PowerShell remoting logs)
  - Administrator Workstations
  range: last 90 days
  queries:
  - pseudocode: FOR each user, CALCULATE baseline of deletion_cmdlet_count. ALERT if current_day_count > 95th_percentile_of_baseline.
- question: Has a sequence of executed cmdlets deviated from the learned, normal workflow of administrative sessions, suggesting malicious intent?
  context: This question leverages a sequence analysis model to understand the logical order of commands in a typical administrative session. The goal is to identify command sequences that are highly improbable or nonsensical from an administrative standpoint, such as creating a mailbox export and then immediately deleting the request. Such a sequence strongly suggests an adversary's attempt to acquire data and then quickly cover their tracks.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Microsoft 365 Unified Audit Log
  - Microsoft Exchange Servers
  - Microsoft 365 / Exchange Online tenancy
  - Domain Controllers (for PowerShell remoting logs)
  - Administrator Workstations
  range: last 90 days
  queries:
  - pseudocode: INPUT real-time cmdlet sequences into trained LSTM model. ALERT if sequence probability is below a set threshold.
- question: Have critical mail data files like databases (.edb), logs (.log), or archives (.pst, .ost) been deleted?
  context: This question seeks to identify direct and destructive attacks against mail infrastructure by monitoring for the deletion of critical data files. By auditing file deletions on paths corresponding to Exchange databases, transaction logs, and user archives, analysts can detect blatant attempts to destroy evidence. Alert fidelity is increased by filtering out deletions from known benign processes like backup services.
  answer_sources:
  - Windows Event ID 4663
  - Sysmon Event ID 23
  - Microsoft Exchange Server database and log directories
  - User profile directories containing PST/OST files on endpoints and file servers
  range: last 90 days
  queries:
  - pseudocode: SEARCH file_audit_logs WHERE (event_type IS 'delete') AND (file_path MATCHES '*.edb' OR '*.pst') AND (process_name NOT IN (standard_backup_apps)).
- question: Has there been a statistically significant spike in the deletion of mail-related files by a non-standard process?
  context: This question aims to detect anomalous file deletion activity that might be missed by single-event rules. It establishes a baseline for the normal rate of file deletions by various processes in mail directories. An alert is triggered if a process not normally associated with mail management (e.g., powershell.exe) begins deleting files at a rate that is a statistical anomaly (e.g., more than three standard deviations above its average), indicating potential misuse.
  answer_sources:
  - Windows Event ID 4663
  - Sysmon Event ID 23
  - Microsoft Exchange Server database and log directories
  - User profile directories containing PST/OST files on endpoints and file servers
  range: last 90 days
  queries:
  - pseudocode: AGGREGATE file_deletion_count per hour by process_name in mail_directories. CALCULATE baseline and std_dev. ALERT if hourly_count for non-standard_process > (mean + 3*std_dev).
- question: Are there anomalous clusters of file deletion events that are distinct from normal activity based on their combined attributes?
  context: This question uses unsupervised machine learning to identify novel attack patterns by clustering file deletion events. Rather than looking at a single feature, it groups events based on a combination of factors like the process used, user account, file type, and time of day. This can highlight outliers, such as a system utility deleting mail files outside of business hours, that would be distinct from dense clusters of normal, expected activity.
  answer_sources:
  - Windows Event ID 4663
  - Sysmon Event ID 23
  - Microsoft Exchange Server database and log directories
  - User profile directories containing PST/OST files on endpoints and file servers
  range: last 90 days
  queries:
  - pseudocode: CLUSTER file_deletion_events using features (process, user, time, file_ext). ANALYZE and ALERT on outlier clusters identified by DBSCAN.
- question: Has a 'tripwire' for bulk mail data deletion been triggered by a single user or host?
  context: This question is designed to catch unsophisticated, high-volume deletion attacks. By implementing a simple threshold-based rule (e.g., more than 50 deletion events from one user in 10 minutes), it acts as a tripwire for automated scripts or brute-force efforts to rapidly purge mailbox data, providing a clear signal of malicious intent.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4663
  - Windows PowerShell Event ID 4104
  - Microsoft 365 Unified Audit Log
  - Microsoft Exchange Servers
  - User endpoints
  - Microsoft 365 / Exchange Online tenancy audit logs
  range: last 90 days
  queries:
  - pseudocode: COUNT deletion_events per user per 10-min_window. ALERT if count > 50.
- question: Has any user's rate of mail deletion events significantly exceeded their own personal baseline?
  context: This question provides a more adaptive alternative to a static global threshold by profiling each user's normal activity. It generates an alert if a user's hourly mail deletion count spikes above their personal 99th percentile. This method is highly effective at detecting when a specific account's behavior changes, which could indicate a compromise, while minimizing false positives from users who normally perform many deletions.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4663
  - Windows PowerShell Event ID 4104
  - Microsoft 365 Unified Audit Log
  - Microsoft Exchange Servers
  - User endpoints
  - Microsoft 365 / Exchange Online tenancy audit logs
  range: last 90 days
  queries:
  - pseudocode: FOR each user, PROFILE hourly deletion_event_count. ALERT if current_hour_count > user_99th_percentile.
- question: Has there been an anomalous burst in the overall volume of mail deletion events across the organization that deviates from established daily and weekly patterns?
  context: This question takes a macro view by using time-series analysis to model the normal rhythm of mail deletion activity for the entire organization. The model learns daily and weekly seasonal patterns. Its purpose is to detect sudden, sharp spikes in the aggregate deletion count that break from this established rhythm, which could be an early indicator of a widespread, automated attack script running across multiple systems.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4663
  - Windows PowerShell Event ID 4104
  - Microsoft 365 Unified Audit Log
  - Microsoft Exchange Servers
  - User endpoints
  - Microsoft 365 / Exchange Online tenancy audit logs
  range: last 90 days
  queries:
  - pseudocode: APPLY time-series anomaly detection model (e.g., Seasonal-Hybrid ESD) to organization-wide mail deletion event stream. ALERT on detected anomalies.
- question: Did a mailbox clearing event occur within 30 minutes of another high-confidence security alert for the same user or host?
  context: This question aims to increase investigation confidence by correlating a mailbox clearing event with other suspicious activities. By creating a rule that links a clearing alert to another high-confidence alert (e.g., credential access, anomalous login) for the same entity within a short time window, analysts can move from investigating an isolated event to confirming a multi-stage attack sequence.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4663
  - Windows Event ID 4624
  - Windows PowerShell Event ID 4104
  - Zeek conn.log
  - Zeek files.log
  - Entire enterprise network, including Domain Controllers, Exchange Servers, VPN Concentrators, and Internet Gateway
  range: last 90 days
  queries:
  - pseudocode: CORRELATE mailbox_clearing_alert with other high-confidence_alerts (e.g., credential_dumping, lateral_movement) for same user/host within a 30-minute window.
- question: Has a host or user accumulated a high composite risk score by performing a series of suspicious actions, including mailbox clearing?
  context: This question uses a risk-scoring system to identify malicious patterns over time. Instead of relying on a single trigger, it assigns weighted scores to various suspicious events, with mailbox clearing receiving a high weight. An alert is triggered when an entity's cumulative score crosses a threshold, indicating a persistent pattern of malicious behavior rather than a single, isolated anomaly.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4663
  - Windows Event ID 4624
  - Windows PowerShell Event ID 4104
  - Zeek conn.log
  - Zeek files.log
  - Entire enterprise network, including Domain Controllers, Exchange Servers, VPN Concentrators, and Internet Gateway
  range: last 90 days
  queries:
  - pseudocode: INCREMENT risk_score for user/host upon suspicious events (e.g., mailbox_clearing, rare_geo_login). ALERT when total_score exceeds threshold.
- question: Does the activity surrounding a mailbox clearing event form a subgraph that matches a known attack pattern?
  context: This question applies graph-based analysis to model the relationships between entities (users, hosts, processes) and their actions. A machine learning model is trained to recognize the structure of known attack chains within this graph. This allows the system to automatically identify and flag a complex scenario where a mailbox clearing action is contextually linked to other attack stages like credential dumping and lateral movement, revealing the entire attack narrative.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4663
  - Windows Event ID 4624
  - Windows PowerShell Event ID 4104
  - Zeek conn.log
  - Zeek files.log
  - Entire enterprise network, including Domain Controllers, Exchange Servers, VPN Concentrators, and Internet Gateway
  range: last 90 days
  queries:
  - pseudocode: CONSTRUCT entity graph from security logs. APPLY trained GNN to identify subgraphs matching attack patterns that include a 'mailbox-clearing' node.