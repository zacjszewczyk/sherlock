name: "T1521: Encrypted Channel"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps identify if an adversary is using a non-standard or custom encrypted channel for command and control on managed mobile devices. It focuses on detecting anomalous TLS sessions by examining certificate and domain attributes, such as self-signed certificates, non-approved CAs, or connections to newly registered or disreputable domains. It also looks for anomalies in TLS client fingerprints (JA3/JA3S hashes) by identifying unlisted or statistically rare clients. Finally, it analyzes encrypted TCP connection patterns for C2 beaconing characteristics, such as highly periodic connections, consistent data transfer sizes, and unusually long connection durations."
type: "technique"
related:
  - "TA0037: Command And Control"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are managed mobile devices establishing TLS sessions with servers using self-signed certificates, non-approved Certificate Authorities, or domains known to be malicious or newly registered?"
    context: "Adversaries often use self-signed certificates or certificates from untrusted Certificate Authorities (CAs) to encrypt command and control (C2) traffic. This avoids the cost and potential scrutiny associated with obtaining legitimate certificates. This question helps identify such suspicious TLS sessions, and correlating them with threat intelligence on domain reputation can confirm if the destination is a known malicious entity."
    answer_sources:
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Internet Egress Points (e.g., corporate Wi-Fi gateways, VPN concentrators) instrumented with Zeek sensors."
      - "Cloud Access Security Broker (CASB) providing visibility into cloud app traffic."
      - "Mobile Device Management (MDM) platform for device and user context."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          JOIN ssl.log with x509.log on uid
          FILTER where x509.validation_status is 'self-signed certificate' OR x509.issuer is not in <allowlist_of_CAs>
          ENRICH results with dns.log to get server_name
          CHECK server_name against threat intelligence feeds for malicious or newly registered domains
          ALERT on matches"
  - question: "Are managed mobile devices connecting to new, previously unseen domains that exhibit characteristics of Domain Generation Algorithms (DGA) or have a poor reputation?"
    context: "Domain Generation Algorithms (DGAs) are used by malware to create a large number of domain names for C2 servers, making them difficult to block via static lists. High Shannon entropy in a domain name is a strong indicator of a DGA. This question aims to detect these algorithmically generated domains, as well as other new domains with poor reputation, to uncover resilient C2 infrastructure."
    answer_sources:
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Internet Egress Points (e.g., corporate Wi-Fi gateways, VPN concentrators) instrumented with Zeek sensors."
      - "Cloud Access Security Broker (CASB) providing visibility into cloud app traffic."
      - "Mobile Device Management (MDM) platform for device and user context."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          IDENTIFY server_names from ssl.log not seen in last 30 days
          FOR each new server_name:
            CALCULATE Shannon entropy of the domain string
            QUERY threat intelligence for reputation score
            ALERT if entropy > <high_threshold> OR reputation < <low_threshold>"
  - question: "Can a machine learning model identify malicious TLS sessions in real-time based on features like certificate attributes, key length, and domain age?"
    context: "This question explores a proactive, machine-learning-based approach to threat detection. By training a model on various features of a TLS session (e.g., certificate validity, entropy of subject/issuer fields, public key algorithm, self-signed status), it is possible to score new sessions for their likelihood of being malicious. This provides a more adaptive and scalable detection method that can catch novel threats missed by rule-based systems."
    answer_sources:
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Internet Egress Points (e.g., corporate Wi-Fi gateways, VPN concentrators) instrumented with Zeek sensors."
      - "Cloud Access Security Broker (CASB) providing visibility into cloud app traffic."
      - "Mobile Device Management (MDM) platform for device and user context."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          FOR each new TLS session:
            EXTRACT features (cert duration, subject entropy, key length, self-signed flag, etc.)
            INPUT feature vector into trained Random Forest model
            SCORE the session
            ALERT if malicious_probability > <dynamic_threshold>"
  - question: "Are managed mobile devices making TLS connections using client applications whose JA3/JA3S fingerprints are not on the approved application allowlist?"
    context: "A JA3 or JA3S hash is a fingerprint of the client-side of a TLS connection, which can effectively identify the specific application or library that initiated it. An unknown or unapproved hash suggests the presence of unauthorized software on the device. This question helps detect such software, which could be a malicious implant, by comparing observed fingerprints against a baseline of known, sanctioned applications."
    answer_sources:
      - "Zeek ssl.log"
      - "Network sensors (e.g., Zeek) at internet egress points and virtual network taps monitoring traffic to/from the mobile device subnet."
      - "The Mobile Device Management (MDM) platform is used as a contextual source for application and device inventories."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          MAINTAIN allowlist of known good JA3/JA3S hashes
          QUERY ssl.log in real-time for connections from mobile IP range
          ALERT if JA3 or JA3S hash is NOT IN allowlist
          ENRICH alert with device/user info from MDM"
  - question: "Are there any managed mobile devices using statistically rare client applications (identified by JA3 hash) across the entire device fleet?"
    context: "Even if an application is not explicitly disallowed, its rarity can be a significant indicator of a threat. A specialized tool used by an adversary or a targeted malware implant will likely have a TLS fingerprint (JA3 hash) that is uncommon across the organization's devices. Investigating these statistical outliers helps uncover threats that might otherwise go unnoticed."
    answer_sources:
      - "Zeek ssl.log"
      - "Network sensors (e.g., Zeek) at internet egress points and virtual network taps monitoring traffic to/from the mobile device subnet."
      - "The Mobile Device Management (MDM) platform is used as a contextual source for application and device inventories."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          QUERY last 30 days of ssl.log from mobile fleet
          CALCULATE frequency of each unique JA3 hash
          IDENTIFY JA3 hashes with prevalence in the bottom 1st percentile
          ALERT on connections using these rare hashes"
  - question: "Can clustering algorithms identify devices with anomalous TLS fingerprinting behavior compared to their peers?"
    context: "This question shifts the analysis from individual connections to the overall behavior of a device. By profiling devices based on the set of applications (represented by JA3 hashes) they use over time, we can use clustering algorithms like DBSCAN to group devices with similar behavior. Devices that are flagged as noise or form very small, distinct clusters are outliers and warrant investigation, as they have a unique software profile that could indicate compromise."
    answer_sources:
      - "Zeek ssl.log"
      - "Network sensors (e.g., Zeek) at internet egress points and virtual network taps monitoring traffic to/from the mobile device subnet."
      - "The Mobile Device Management (MDM) platform is used as a contextual source for application and device inventories."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          FOR each mobile device:
            CREATE feature vector of unique JA3 hashes used in last 7 days
          APPLY DBSCAN clustering to the population of device vectors
          INVESTIGATE devices classified as noise or in very small clusters"
  - question: "Are there any long-lived, low-throughput encrypted TCP connections originating from managed mobile devices that could indicate an idle C2 channel?"
    context: "Adversaries frequently establish persistent, long-duration connections that transfer very little data as they lie in wait for commands from a C2 server. These 'idle' or 'sleeper' channels are a key tactic for maintaining persistence. Detecting encrypted connections that stay open for many hours but transmit minimal data is a direct way to uncover these potentially compromised devices."
    answer_sources:
      - "Zeek conn.log"
      - "Network flow data collected from core network switches, VPN concentrators, and network taps monitoring traffic from mobile device subnets, including traffic subject to split-tunneling policies."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          QUERY conn.log for TCP connections from mobile IP range
          FILTER where connection_state is 'SF' AND duration > 8 hours AND (orig_bytes + resp_bytes) < 10 KB
          ALERT on matching connections"
  - question: "Are there encrypted connections from mobile devices exhibiting highly regular 'heartbeat' patterns, such as consistent timing and data sizes?"
    context: "Automated C2 communications from malware often exhibit machine-like regularity, unlike typical user-driven traffic. This 'beaconing' or 'heartbeat' behavior is characterized by very low variance in the time between connections (jitter) and the amount of data sent. Identifying source-destination pairs with this highly predictable pattern is a strong indicator of a C2 channel."
    answer_sources:
      - "Zeek conn.log"
      - "Network flow data collected from core network switches, VPN concentrators, and network taps monitoring traffic from mobile device subnets, including traffic subject to split-tunneling policies."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          FOR each source-destination pair (mobile device to server) over 1-hour window:
            CALCULATE standard deviation of inter-arrival times
            CALCULATE standard deviation of payload sizes
            ALERT if both standard deviations are below a low threshold (e.g., bottom 5th percentile)"
  - question: "Can frequency analysis (FFT) be used to detect strong periodicity in encrypted connection patterns, indicative of C2 beaconing?"
    context: "This question proposes a more advanced signal processing technique to detect C2 beaconing. A Fast Fourier Transform (FFT) can convert a time series of connection events into its constituent frequencies. A highly periodic signal, like a C2 beacon, will appear as a strong, distinct spike in the frequency domain. This method can robustly detect regular beaconing even when there is some minor noise or jitter in the timing."
    answer_sources:
      - "Zeek conn.log"
      - "Network flow data collected from core network switches, VPN concentrators, and network taps monitoring traffic from mobile device subnets, including traffic subject to split-tunneling policies."
    range: "last 90 days"
    queries:
      - "pseudocode: |
          FOR each high-volume source-destination pair:
            EXTRACT time series of connection timestamps from conn.log
            APPLY Fast Fourier Transform (FFT) to the time series
            ANALYZE the resulting power spectrum
            ALERT if a single frequency spike indicates strong periodicity"