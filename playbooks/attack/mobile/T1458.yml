name: T1458: Replication Through Removable Media
id: 6d8b9e3a-5f7c-4d1a-8b9c-0e1f2a3b4c5d
description: This playbook helps investigate potential adversary activity involving initial access and lateral movement through removable media, specifically USB-connected mobile devices. It focuses on identifying anomalous process behavior, suspicious network connections, unusual DNS queries, malicious file drops, and internal network scanning that occur shortly after a USB device is connected to a host.
type: technique
related:
- TA0027: Initial Access
- TA0033: Lateral Movement
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a mobile management process initiated a network connection to a known malicious destination within 5 minutes of a USB device connection, especially if the process is unsigned or running from a non-standard directory?
  context: This question targets a high-confidence indicator of compromise where a USB-connected device leverages legitimate mobile management software on the host to establish a command and control channel. Correlating the USB connection with the execution of a suspicious process that immediately communicates with a malicious IP or domain helps detect initial access attempts. Unsigned processes or those running from unusual locations further increase the suspicion level.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - Sysmon Event ID 3
  - Zeek conn.log
  - Zeek dns.log
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Endpoints with USB ports (corporate workstations, employee laptops, IT helpdesk workstations), public charging kiosks within corporate facilities, DNS servers, network gateways, VPN concentrators, and Mobile Device Management (MDM) servers.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: Correlate USB connection (Event ID 2003) with process creation (Sysmon 1) from mobile management watchlist within 5 mins. Check if process is unsigned or in non-standard path. Correlate with network connection (Sysmon 3) to a destination on a malicious threat feed.
- question: Following a USB device connection, has a mobile management process been executed with unusually complex or numerous command-line arguments compared to its historical baseline?
  context: Adversaries often use obfuscated or unusually long command lines to pass malicious instructions to legitimate processes. This question seeks to identify such anomalies. By baselining the normal command-line entropy and argument count for mobile management tools, we can detect deviations that occur shortly after a USB connection, which may indicate that the tool is being used for malicious purposes like code execution or configuration changes.
  answer_sources:
  - Sysmon Event ID 1
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Endpoints with USB ports (corporate workstations, employee laptops, IT helpdesk workstations), public charging kiosks within corporate facilities, DNS servers, network gateways, VPN concentrators, and Mobile Device Management (MDM) servers.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: After a USB connection (Event ID 2003), find executions of mobile management processes (Sysmon 1). Calculate command-line entropy and argument count. Alert if entropy > 98th percentile or arg count > 3 standard deviations from the 30-day baseline for that process.
- question: Has a process associated with mobile device management made an anomalous network connection (e.g., to a new country, ASN, or using an unusual port) within 5 minutes of a USB device connection?
  context: This question uses machine learning to detect novel or unusual network behavior that might be missed by signature-based rules. A model trained on normal network activity for mobile management tools can identify outliers based on features like destination IP, port, protocol, and geolocation. An anomalous connection occurring right after a USB device is plugged in is a strong signal of a potential compromise, such as data exfiltration or C2 communication to a new server.
  answer_sources:
  - Sysmon Event ID 3
  - Zeek conn.log
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Endpoints with USB ports (corporate workstations, employee laptops, IT helpdesk workstations), public charging kiosks within corporate facilities, DNS servers, network gateways, VPN concentrators, and Mobile Device Management (MDM) servers.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: After a USB connection (Event ID 2003), find network connections (Sysmon 3, Zeek conn.log) from mobile management watchlist processes. Use a pre-trained ML model (Isolation Forest/One-Class SVM) to score the connection. Alert on connections classified as anomalous.
- question: Within 5 minutes of a USB device connection, has the host attempted to resolve a domain name known to be associated with malicious activity (C2, DGA, phishing)?
  context: This is a direct check for connections to known-bad infrastructure. Malware delivered via a USB-connected device will often need to resolve a domain for its command and control server. By correlating DNS queries with recent USB connection events and checking them against threat intelligence, we can quickly identify infected hosts at the point of initial access.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Sysmon Event ID 22
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, guest network segments, internet gateway, recursive DNS resolvers, corporate DNS servers, and Endpoint Detection and Response (EDR) logs.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: Correlate USB connection (Event ID 2003) with DNS queries (Sysmon 22, Zeek dns.log) from the same host within 5 mins. Alert if a queried domain is on a malicious C2/DGA/phishing threat intelligence feed.
- question: Following a USB device connection, did the host exhibit anomalous DNS query patterns, such as a sudden spike in unique domains, an increase in high-entropy domain names, or a high ratio of rare Top-Level Domains (TLDs)?
  context: This question aims to detect Domain Generation Algorithms (DGAs) or other automated malicious DNS activity. Adversaries use DGAs to create a large number of potential C2 domains. A sudden increase in unique domains, high-entropy names (which look random), or queries for unusual TLDs (like .xyz, .club) are all statistical indicators of DGA behavior, especially when they occur shortly after a USB connection.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Sysmon Event ID 22
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, guest network segments, internet gateway, recursive DNS resolvers, corporate DNS servers, and Endpoint Detection and Response (EDR) logs.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: After a USB connection (Event ID 2003), monitor host DNS activity (Sysmon 22, Zeek dns.log) for 5 mins. Compare stats (unique domain count, entropy, rare TLD ratio) to the host's 30-day baseline. Alert if stats exceed predefined thresholds (e.g., 3 standard deviations, 99th percentile).
- question: Has a machine learning model identified any DNS queries as anomalous within 5 minutes of a USB device connection on the host?
  context: This question leverages an unsupervised machine learning model to find DNS queries that don't fit normal patterns, even if they don't match a known-bad signature. The model considers features like query length, subdomain count, and entropy to identify outliers. A cluster of such outlier queries occurring right after a USB connection is a strong indicator of malicious software attempting to establish communication.
  answer_sources:
  - Zeek dns.log
  - Sysmon Event ID 22
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, guest network segments, internet gateway, recursive DNS resolvers, corporate DNS servers, and Endpoint Detection and Response (EDR) logs.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: After a USB connection (Event ID 2003), feed DNS query data (Sysmon 22, Zeek dns.log) into a pre-trained ML model (Isolation Forest/Autoencoder). Alert on any query flagged as an outlier, especially if multiple outliers occur in a short time frame.
- question: Within 10 minutes of a USB connection, was a new file created and executed that is either a known piece of malware or that launched PowerShell with suspicious arguments?
  context: This question targets the classic "dropper" scenario, where a connected device writes a malicious executable to the host and then runs it. Correlating the USB event with the file creation and subsequent execution provides a clear narrative of the attack. Checking the file's hash against malware feeds provides high-confidence alerts, while monitoring for suspicious PowerShell child processes helps detect fileless or living-off-the-land techniques used for second-stage payloads.
  answer_sources:
  - Sysmon Event ID 11
  - Sysmon Event ID 1
  - Windows Event ID 4688
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, IT administrator workstations, software development environments, user profile directories (Downloads, Temp, AppData), and shared network drives.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: Correlate USB connection (Event ID 2003) with file creation (Sysmon 11) and process execution (Sysmon 1) within 10 mins. Alert if file hash is on a malware feed. Also alert if the new process spawns powershell.exe with arguments like '-enc', '-e', or '-w hidden'.
- question: After a USB connection, was a rare or never-before-seen executable file dropped and run, or did it create an unusual parent-child process relationship?
  context: This question helps find unknown or targeted malware that wouldn't be on a threat intelligence feed. A file that has only been seen on a few hosts in the entire organization (low prevalence) is inherently suspicious. Similarly, a legitimate process spawning an unexpected child process (e.g., 'notepad.exe' spawning 'cmd.exe') is a common indicator of process injection or other malicious activity. Correlating these low-prevalence events with a recent USB connection strengthens the case for investigation.
  answer_sources:
  - Sysmon Event ID 11
  - Sysmon Event ID 1
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, IT administrator workstations, software development environments, user profile directories (Downloads, Temp, AppData), and shared network drives.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: After a USB connection (Event ID 2003), find files created (Sysmon 11) by mobile management processes. If the file is executed, check its hash prevalence. Alert if prevalence < 5 hosts. Also, analyze parent-child relationships (Sysmon 1) and alert if the pair is in the bottom 5th percentile of historical frequency.
- question: Based on a machine learning model, was a file execution that occurred within 10 minutes of a USB connection predicted to be malicious?
  context: This question uses a supervised machine learning model to score file execution events based on a variety of features like file path, signature status, and parent process. The model can learn complex patterns that distinguish malicious executions from benign ones. By flagging executions that the model scores as highly probable to be malicious, especially when temporally linked to a USB connection, security teams can prioritize the most critical events for investigation.
  answer_sources:
  - Sysmon Event ID 1
  - Sysmon Event ID 11
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, IT administrator workstations, software development environments, user profile directories (Downloads, Temp, AppData), and shared network drives.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: For any process execution (Sysmon 1) occurring within 10 mins of a USB connection (Event ID 2003), gather features (file path, signature, prevalence, parent process). Use a pre-trained ML model (Random Forest/Gradient Boosting) to score the event. Alert if malicious probability > 0.9.
- question: Did a host begin scanning the internal network for open ports or active hosts within 15 minutes of a USB device being connected to it?
  context: This question aims to detect the reconnaissance phase of lateral movement. After gaining initial access, malware will often scan the local network to find other vulnerable machines to spread to. Network security monitoring tools like Zeek can explicitly detect this scanning behavior. Tying a scan detection directly back to a recent USB connection on the scanning host provides a strong, actionable alert that an adversary is attempting to move from their initial foothold.
  answer_sources:
  - Zeek conn.log
  - Zeek notice.log
  - Sysmon Event ID 3
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, network segments containing high-value assets (Domain Controllers, Database Servers), internal network traffic choke points, East-West traffic monitoring points (e.g., network TAPs, virtual switch monitoring), and VLANs with sensitive servers.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: Monitor Zeek notice.log for 'Scan::Address_Scan' or 'Scan::Port_Scan' events. For the source host of the scan, check for a USB connection (Event ID 2003) within the last 15 minutes. If found, generate a high-severity alert.
- question: Following a USB device connection, did the host show signs of network scanning, such as connecting to an unusually high number of internal IPs on common ports (e.g., 445, 3389) or having a very high ratio of failed-to-successful connections?
  context: This question provides a way to detect network scanning behavior directly from endpoint or network flow logs, even without a dedicated scan detection engine. A host rapidly trying to connect to many other internal systems, especially with a high failure rate (indicating it's probing for open ports), is a classic sign of a worm or an attacker performing reconnaissance. Baselining this behavior and alerting on significant deviations after a USB event can catch lateral movement attempts early.
  answer_sources:
  - Zeek conn.log
  - Zeek notice.log
  - Sysmon Event ID 3
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, network segments containing high-value assets (Domain Controllers, Database Servers), internal network traffic choke points, East-West traffic monitoring points (e.g., network TAPs, virtual switch monitoring), and VLANs with sensitive servers.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: After a USB connection (Event ID 2003), monitor the host's internal network connections (Sysmon 3, Zeek conn.log). In 5-minute windows, count unique internal IPs on ports like 135, 445, 3389 and calculate the ratio of failed to successful connections. Alert if unique IP count > 20 or if the failure ratio is > 3 standard deviations above the host's baseline.
- question: Did a host's network behavior profile change from 'normal' to 'scanner-like' within 15 minutes of a USB device connection?
  context: This is an advanced, behavior-based question that uses machine learning to profile and cluster hosts. Hosts are grouped based on their typical network activity (e.g., 'normal user', 'web server', 'scanner'). A host that suddenly and rapidly changes its cluster membership—specifically, moving into a cluster characterized by scanning behavior—is a major anomaly. Linking this cluster transition to a recent USB event creates a very high-confidence alert for lateral movement activity.
  answer_sources:
  - Zeek conn.log
  - Zeek notice.log
  - Sysmon Event ID 3
  - Windows-DriverFrameworks-UserMode/Operational Event ID 2003
  - Corporate workstations, network segments containing high-value assets (Domain Controllers, Database Servers), internal network traffic choke points, East-West traffic monitoring points (e.g., network TAPs, virtual switch monitoring), and VLANs with sensitive servers.
  range: last 90 days
  queries:
  - search_technology: pseudocode
    query: Periodically cluster hosts using ML (K-Means/DBSCAN) based on network behavior features from Zeek conn.log. If a host changes from a 'normal' cluster to a 'scanner' cluster, check if a USB connection (Event ID 2003) occurred on that host in the prior 15 minutes. If so, alert.