name: T1437: Application Layer Protocol
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps identify adversarial command and control (C2) activity on mobile devices that leverages standard application layer protocols like HTTP/S and DNS. The investigation focuses on detecting three primary patterns of malicious behavior: (1) C2 beaconing, characterized by highly periodic connections with small, uniform payloads; (2) DNS-based C2, identified by anomalous query patterns such as high-entropy subdomains, unusual query type ratios, or matches against DGA threat feeds; and (3) the use of suspicious client signatures, such as rare or known-malicious User-Agents and TLS (JA3/S, JA4+) fingerprints. The goal is to uncover hidden C2 channels by analyzing network traffic for both known indicators and statistical anomalies.
type: technique
related:
  - TA0037: Command and Control
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a mobile device communicating with a destination IP, domain, or URI known to be associated with command and control infrastructure?
    context: This question aims to detect low-hanging fruit by matching network traffic from mobile devices against curated lists of malicious indicators. A match provides a high-confidence signal that a device may be compromised and is communicating with an adversary's C2 server.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Threat Intelligence Feeds
      - Network egress points
      - Corporate Wi-Fi infrastructure
      - VPN concentrators
      - Mobile Device Management (MDM) platforms
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH Zeek conn.log, http.log WHERE source_ip IN mobile_device_ip_range AND (destination_ip IN c2_ip_feed OR destination_domain IN c2_domain_feed OR uri IN c2_uri_feed) | ALERT
  - question: Is a mobile device exhibiting non-human, automated communication patterns indicative of C2 beaconing?
    context: This question seeks to identify automated C2 communications by analyzing the statistical properties of network connections. Human-generated traffic is typically bursty and irregular, whereas malware beacons are often highly periodic (low time variation) and use consistent, small packet sizes (low payload variation). Detecting this machine-like regularity can uncover C2 channels that don't use known malicious indicators.
    answer_sources:
      - Zeek conn.log
      - Network egress points
      - Corporate Wi-Fi infrastructure
      - VPN concentrators
      - Mobile Device Management (MDM) platforms
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH Zeek conn.log WHERE source_ip IN mobile_device_ip_range | GROUP BY source_ip, destination_ip over 1_hour | CALCULATE time_variation, payload_std_dev | WHERE time_variation < 0.2 AND payload_std_dev < 100 | ALERT
  - question: Can we identify anomalous clusters of mobile device network traffic that represent machine-like C2 beaconing?
    context: This question uses unsupervised machine learning (DBSCAN) to find outliers in network traffic. By clustering traffic based on features like port, protocol, and timing/size statistics, we can isolate small, dense clusters that deviate from the large, diffuse clusters of normal user activity. These outlier clusters are strong candidates for C2 beaconing.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Network egress points
      - Corporate Wi-Fi infrastructure
      - VPN concentrators
      - Mobile Device Management (MDM) platforms
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: EXTRACT features (port, protocol, time_variance, payload_stats, uri_diversity) from Zeek logs for mobile_device_ips | APPLY DBSCAN on feature set | IDENTIFY and investigate outlier clusters | ALERT
  - question: Is a mobile device performing DNS lookups for domains known to be used for Domain Generation Algorithms (DGAs) or DNS tunneling?
    context: This question focuses on detecting known malicious DNS activity. Adversaries use DGAs to create a large number of potential C2 domains and DNS tunneling to exfiltrate data. Matching DNS queries against threat intelligence feeds of known DGA patterns and tunneling domains is a direct way to identify compromised mobile devices.
    answer_sources:
      - Zeek dns.log
      - Threat Intelligence Feeds
      - Internal DNS resolvers
      - DNS forwarders
      - Network egress points
      - Corporate Wi-Fi infrastructure
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH Zeek dns.log WHERE source_ip IN mobile_device_ip_range AND query MATCHES (regex_dga_feed OR explicit_dga_feed) | ALERT
  - question: Does a mobile device's DNS query behavior exhibit statistical anomalies, such as high subdomain randomness or an unusual ratio of query types, suggesting DNS-based C2?
    context: This question aims to find unknown DNS C2 channels by looking for statistical deviations from normal behavior. High entropy (randomness) in subdomains is a hallmark of DGAs, while a high ratio of TXT to A queries can indicate data exfiltration via DNS. Flagging devices that exceed established baselines for these metrics can uncover novel threats.
    answer_sources:
      - Zeek dns.log
      - Internal DNS resolvers
      - DNS forwarders
      - Network egress points
      - Corporate Wi-Fi infrastructure
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH Zeek dns.log WHERE source_ip IN mobile_device_ip_range | GROUP BY source_ip, parent_domain over 1_hour | CALCULATE subdomain_entropy, txt_to_a_ratio | WHERE subdomain_entropy > 4.5 OR txt_to_a_ratio > baseline_threshold | ALERT
  - question: Can a machine learning model classify DNS queries from mobile devices as benign or malicious to detect potential DGA or DNS tunneling activity?
    context: This question leverages a supervised machine learning model (Random Forest) to proactively identify malicious DNS queries. By training the model on features like query length, entropy, character ratios, and query type, it can learn to distinguish between legitimate and malicious traffic with high accuracy, enabling the detection of sophisticated DNS-based C2 channels.
    answer_sources:
      - Zeek dns.log
      - Internal DNS resolvers
      - DNS forwarders
      - Network egress points
      - Corporate Wi-Fi infrastructure
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: EXTRACT features (query_length, entropy, char_ratio, query_type, response_size) from Zeek dns.log for mobile_ips | APPLY pre-trained Random Forest model | IF classification == 'malicious' | ALERT
  - question: Is a mobile device using an HTTP User-Agent or TLS/SSL fingerprint (JA3/S, JA4+) that is known to be associated with malware or a C2 framework?
    context: This question aims to identify compromised devices by matching their client-side communication signatures against a blocklist. Malware and C2 tools often use unique or hardcoded User-Agents and TLS libraries, resulting in specific fingerprints. A match provides a strong indication that a malicious tool is running on the device.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - Zeek ja4.log
      - Threat Intelligence Feeds
      - Web Application Firewalls (WAFs)
      - Reverse proxies
      - Internet gateways
      - MDM/UEM platforms for device context
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH Zeek http.log, ssl.log, ja4.log WHERE source_ip IN mobile_device_ip_range AND (user_agent IN malicious_ua_feed OR ja3 IN malicious_ja3_feed OR ja4_hash IN malicious_ja4_feed) | ALERT
  - question: Is a mobile device using a client signature (User-Agent, JA3/S, JA4+) that is statistically rare across the entire mobile device fleet?
    context: This question uses the principle of "stack counting" or frequency analysis to find anomalies. Legitimate mobile applications are used by many devices, creating common signatures. A signature used by very few devices (e.g., less than 0.1% of the fleet) is highly suspicious and could indicate a custom C2 implant or an uncommon malicious tool.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - Zeek ja4.log
      - Web Application Firewalls (WAFs)
      - Reverse proxies
      - Internet gateways
      - MDM/UEM platforms for device context
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: CALCULATE frequency of all (user_agents, ja3_hashes, ja4_hashes) from mobile_ips over 30_days | SEARCH live traffic from mobile_ips | WHERE signature_prevalence < 0.1% | ALERT
  - question: Can an anomaly detection model identify mobile device connections with client signatures that significantly deviate from the established baseline of normal traffic?
    context: This question applies unsupervised machine learning (Isolation Forest) to detect novel and unusual client signatures. The model learns what constitutes "normal" traffic based on features from User-Agents and TLS fingerprints. It can then score new connections in real-time, flagging those that are highly anomalous and warrant investigation, even if they are not on any known threat list.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - Zeek ja4.log
      - Web Application Firewalls (WAFs)
      - Reverse proxies
      - Internet gateways
      - MDM/UEM platforms for device context
    range: Last 90 days
    queries:
      - search_technology: Pseudocode
        query: EXTRACT features (ua_length, token_count, tls_version, cipher_suites) from Zeek logs for mobile_ips | APPLY pre-trained Isolation Forest model | IF anomaly_score > threshold | ALERT