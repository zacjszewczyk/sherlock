name: T1634: Credentials from Password Store
id: a6f8b0c1-3e5d-4f7a-9c1b-8d0e2f4a6b9c
description: This playbook helps investigate if adversaries are accessing and using credentials stolen from corporate mobile device password stores. It focuses on detecting indicators of compromise such as a mobile device being jailbroken or rooted, followed by anomalous authentication activity and data exfiltration. It also looks for the installation of unauthorized applications that exhibit command-and-control (C2) behavior, like DGA or periodic beaconing. Finally, it identifies successful logins from atypical geolocations or anonymizing proxies, followed by unusual data access, which suggests stolen credentials are in use.
type: technique
related:
  - TA0031: Credential Access
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a jailbroken or rooted mobile device being used in a brute-force or password spray attack, and is it communicating with known malicious infrastructure?
    context: This question aims to detect the immediate aftermath of a device compromise. A jailbreak disables security controls, allowing an adversary to extract credentials. A subsequent spike in failed logins for the associated user account indicates a brute-force or password spray attempt. Correlating the device's network traffic with threat intelligence feeds can confirm if the device is communicating with attacker-controlled infrastructure.
    answer_sources:
      - MDM/UEM device compliance logs
      - Zeek conn.log
      - Windows Event ID 4625
      - Windows Event ID 4624
      - Windows Event ID 4768
      - Windows Event ID 4769
      - Corporate MDM/UEM management server; Network egress points instrumented with Zeek sensors; VPN concentrators; Corporate Wi-Fi Access Point Controllers; Domain Controllers and Authentication Servers; Cloud identity provider logs (e.g., Azure AD, Okta).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH MDM/UEM logs FOR compliance_status='non-compliant' AND reason IN ('jailbreak_detected', 'root_detected').
          FOR each event, GET user and device_ip.
          WITHIN 5 minutes, SEARCH authentication logs for that user and COUNT failed logins (EventID 4625).
          IF count > 10, ALERT.
          SEARCH network logs for device_ip and MATCH against threat_intel_feed.
          IF match, ALERT.
  - question: Following a device jailbreak, is the associated user account exhibiting anomalous login behavior from a new location, and is the device exfiltrating an unusual amount of data?
    context: This question focuses on detecting two key post-compromise activities: credential abuse and data exfiltration. A successful login from a new country or ASN after a device compromise suggests the credentials have been stolen and are being used by the attacker. A simultaneous spike in outbound data from the compromised device can indicate the theft of sensitive information from the device or internal resources.
    answer_sources:
      - MDM/UEM device compliance logs
      - Zeek conn.log
      - Windows Event ID 4625
      - Windows Event ID 4624
      - Windows Event ID 4768
      - Windows Event ID 4769
      - Corporate MDM/UEM management server; Network egress points instrumented with Zeek sensors; VPN concentrators; Corporate Wi-Fi Access Point Controllers; Domain Controllers and Authentication Servers; Cloud identity provider logs (e.g., Azure AD, Okta).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each jailbroken_device, CALCULATE 30-day baseline of daily outbound_bytes from Zeek logs.
          IF current_day_bytes > 95th_percentile of baseline, ALERT.
          FOR the affected_user, GET 90-day baseline of successful login countries and ASNs from authentication logs.
          IF new successful login occurs from a country or ASN not in the user's baseline, ALERT.
  - question: Can machine learning models be used to detect anomalous network traffic and calculate a credential compromise risk score for users with jailbroken devices?
    context: This question explores using advanced analytics to proactively identify compromised accounts. A time-series model can detect subtle spikes in network traffic that simple thresholds might miss. A classification model can synthesize multiple weak signals (jailbreak status, data volume, login failures, new locations) into a single, actionable risk score, helping analysts prioritize investigations.
    answer_sources:
      - MDM/UEM device compliance logs
      - Zeek conn.log
      - Windows Event ID 4625
      - Windows Event ID 4624
      - Windows Event ID 4768
      - Windows Event ID 4769
      - Corporate MDM/UEM management server; Network egress points instrumented with Zeek sensors; VPN concentrators; Corporate Wi-Fi Access Point Controllers; Domain Controllers and Authentication Servers; Cloud identity provider logs (e.g., Azure AD, Okta).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL 1 (Time-Series): For each device, analyze per-hour outbound byte counts from Zeek logs using an ARIMA model. If an anomaly is detected within 24 hours of a jailbreak event, ALERT.
          MODEL 2 (Classifier): For each user, compute features (is_jailbroken, outbound_bytes_zscore, failed_login_count_1hr, is_new_country_login). Predict 'credential_compromise_risk_score' using a trained Random Forest model. ALERT on high scores and provide top contributing features.
  - question: Is a device with a non-allowlisted application making direct-to-IP connections, bypassing DNS?
    context: This question aims to identify malicious applications that attempt to hide their C2 communication. Legitimate applications typically resolve a domain name before connecting to an IP address. Direct-to-IP connections, especially from an unauthorized application not on the corporate allowlist, are highly suspicious and can indicate a hardcoded C2 server address used by malware.
    answer_sources:
      - MDM/UEM application inventory logs
      - Zeek dns.log
      - Zeek conn.log
      - Corporate MDM/UEM management server; Corporate DNS resolvers logging to Zeek; Network egress points instrumented with Zeek sensors; Cloud Access Security Broker (CASB) logs; Mobile Application Management (MAM) servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH MDM/UEM logs for newly installed applications.
          COMPARE application package/hash against corporate allowlist and threat intelligence.
          IF app is not allowlisted, ALERT and get device_ip.
          FOR that device_ip, monitor Zeek conn.log for new connections.
          IF a connection is made to a destination_ip with no corresponding successful DNS query in the last 5 minutes, ALERT.
  - question: Is a device with an unauthorized application exhibiting signs of C2 communication, such as DGA activity or periodic beaconing?
    context: This question looks for two common C2 communication patterns associated with malware. High Shannon entropy in DNS queries suggests the use of a Domain Generation Algorithm (DGA) to dynamically find C2 servers. Highly periodic network connections (i.e., low variance in the time between connections) are a classic sign of automated 'beaconing' as malware calls home for instructions.
    answer_sources:
      - MDM/UEM application inventory logs
      - Zeek dns.log
      - Zeek conn.log
      - Corporate MDM/UEM management server; Corporate DNS resolvers logging to Zeek; Network egress points instrumented with Zeek sensors; Cloud Access Security Broker (CASB) logs; Mobile Application Management (MAM) servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR devices with unauthorized_apps:
          QUERY Zeek dns.log over a 1-hour window. CALCULATE Shannon entropy on requested domain names.
          IF average_entropy > 3.5, ALERT for potential DGA.
          QUERY Zeek conn.log for direct-to-IP connections over 24 hours. CALCULATE standard deviation of inter-arrival time to the same destination.
          IF std_dev < 10 seconds AND connection_count > 10, ALERT for potential beaconing.
  - question: Can unsupervised machine learning models identify anomalous network behavior from devices running unauthorized applications?
    context: This question leverages machine learning to find 'unknown unknowns' in network traffic. Clustering algorithms can group all mobile device traffic and automatically identify small, outlier groups that represent anomalous activity without prior labeling. An autoencoder, trained only on normal traffic from compliant devices, will fail to accurately reconstruct anomalous traffic, providing a clear signal of deviation from the baseline that warrants investigation.
    answer_sources:
      - MDM/UEM application inventory logs
      - Zeek dns.log
      - Zeek conn.log
      - Corporate MDM/UEM management server; Corporate DNS resolvers logging to Zeek; Network egress points instrumented with Zeek sensors; Cloud Access Security Broker (CASB) logs; Mobile Application Management (MAM) servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL 1 (Clustering): From Zeek logs, extract features (protocol, port, duration, bytes, periodicity_score, dns_entropy_score). Apply DBSCAN algorithm. Flag traffic from devices with unauthorized apps that falls into small, distant clusters.
          MODEL 2 (Autoencoder): Train an autoencoder neural network on the same feature set using only traffic from compliant devices. If the reconstruction error for traffic from a device with an unauthorized app is high, ALERT.
  - question: Are successful user authentications originating from known anonymizing services like TOR or commercial VPNs?
    context: This question aims to detect credential abuse where an attacker is hiding their true location. While some users may have a business need for VPNs, successful logins from anonymizing proxies (e.g., TOR exit nodes) are highly suspicious. Such activity often indicates that compromised credentials are being used by an external adversary who is attempting to obfuscate their origin.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Cloud/SaaS application access logs
      - VPN Logs
      - Domain Controllers; VPN Concentrators; Cloud Identity Providers (e.g., Azure AD, Okta); SaaS application platforms (e.g., O365, Salesforce); Network egress points instrumented with Zeek sensors.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each successful login (EventID 4624), GET the source_ip.
          ENRICH source_ip with threat intelligence data (e.g., from Zeek logs or a TI feed).
          IF ip_category is 'anonymizing_proxy' or 'TOR_exit_node' AND the user's role does not require such tools, generate a HIGH-PRIORITY ALERT.
  - question: Has a user successfully logged in from a new country or Autonomous System (ASN) for the first time, suggesting an 'impossible travel' scenario?
    context: This question focuses on detecting credential abuse based on geolocation. An 'impossible travel' alert is a classic indicator of a compromised account. Baselining each user's normal login locations (by country and ASN) allows for the detection of a successful login from a location that is abnormal for that specific user, which is a strong signal of account takeover.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Cloud/SaaS application access logs
      - VPN Logs
      - Domain Controllers; VPN Concentrators; Cloud Identity Providers (e.g., Azure AD, Okta); SaaS application platforms (e.g., O365, Salesforce); Network egress points instrumented with Zeek sensors.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each user, MAINTAIN a 90-day rolling baseline of source_countries and source_ASNs from successful logins.
          ON each new successful login, get the current_country and current_ASN.
          IF current_country OR current_ASN is not in the user's baseline, generate an 'impossible travel' ALERT.
          CALCULATE a risk score based on the rarity of the ASN/country across the entire organization.
  - question: Can machine learning models, such as peer group analysis and supervised classification, be used to detect anomalous user login behavior indicative of credential reuse?
    context: This question applies advanced analytics to user behavior. Peer group analysis can automatically identify users with similar login patterns and flag an individual who deviates significantly from their peer group. A supervised model, trained on previously labeled incidents, can learn the complex features of credential reuse and provide a predictive risk score for new logins.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Cloud/SaaS application access logs
      - VPN Logs
      - Domain Controllers; VPN Concentrators; Cloud Identity Providers (e.g., Azure AD, Okta); SaaS application platforms (e.g., O365, Salesforce); Network egress points instrumented with Zeek sensors.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL 1 (Peer Group Analysis): Using k-means clustering, group users by login behavior features (source ASNs, time-of-day, day-of-week). If a new login shifts a user's profile to a new, distant cluster, FLAG as anomalous.
          MODEL 2 (Supervised Classifier): Train an XGBoost model on labeled historical data to predict credential reuse. Use features like 'is_new_ASN_for_user', 'time_of_day_zscore', and 'is_anonymizer_IP'. ALERT on logins with a high prediction score.