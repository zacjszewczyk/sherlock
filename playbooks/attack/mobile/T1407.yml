name: "T1407: Download New Code at Runtime"
id: "e9a3b1c8-4f2d-4e9a-8b1c-0e02b2c3d479"
description: "This playbook addresses the threat of adversaries bypassing mobile application security by downloading and executing new code at runtime. It provides investigative steps to detect this activity across Android and iOS platforms. Key indicators include network sessions from mobile devices to suspicious external destinations (identified by threat intelligence, low reputation, or recent domain registration) transferring executable file types ('application/java-archive', 'application/x-dex', 'application/x-sharedlib', 'application/octet-stream'). On Android, this involves monitoring for API calls to dynamic code loading functions like `dalvik.system.DexClassLoader` or `java.lang.System.load` from unapproved applications. For iOS, the focus is on detecting connections to domains known for hosting malicious JSPatch scripts or the use of similar unapproved dynamic code loading frameworks."
type: "technique"
related:
  - "TA0030: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a mobile device downloaded a file indicative of executable code from a suspicious destination?"
    context: "This question aims to detect the direct download of potentially malicious code. Adversaries often host payloads on newly registered domains or servers with poor reputation to evade blocklists. By correlating network connections with file transfers and enriching this with threat intelligence and domain age data, we can identify high-risk downloads that bypass traditional security controls."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Zeek dns.log"
      - "Corporate Wi-Fi network segments, VPN concentrators, and cloud-based secure web gateways used by mobile devices."
    range: "last 90 days"
    queries:
      - "JOIN Zeek conn.log with files.log ON session_id. FILTER for source IP in mobile range. ALERT IF (destination in threat_intel_feed OR domain_age < 30_days) AND mime_type IN ('application/java-archive', 'application/x-dex', 'application/x-sharedlib', 'application/octet-stream')."
  - question: "Is a mobile device communicating over a statistically rare or obfuscated channel, potentially to download code?"
    context: "This question seeks to identify command-and-control (C2) or payload delivery channels that use non-standard TLS clients or obfuscated URIs to hide their activity. A rare JA3/JA3S hash suggests a unique or uncommon client application, while high URI entropy can indicate the use of Domain Generation Algorithms (DGA) or other randomization techniques. The combination is a strong signal of malicious behavior."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Zeek dns.log"
      - "Corporate Wi-Fi network segments, VPN concentrators, and cloud-based secure web gateways used by mobile devices."
    range: "last 90 days"
    queries:
      - "CALCULATE frequency of JA3/JA3S hashes over 30 days. CALCULATE Shannon entropy for URI path/query. ALERT IF (JA3/JA3S_frequency_percentile < 5) AND (URI_entropy > 4.5)."
  - question: "Can a machine learning model identify network sessions highly likely to be malicious dynamic code downloads?"
    context: "This question leverages machine learning to build a more sophisticated detection model that can identify complex, non-linear patterns indicative of malicious downloads. By combining multiple features like domain age, threat intelligence, JA3/JA3S rarity, URI entropy, and file characteristics, the model can achieve higher accuracy and reduce false positives compared to simple rule-based alerts."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek files.log"
      - "Zeek ssl.log"
      - "Zeek x509.log"
      - "Zeek dns.log"
      - "Corporate Wi-Fi network segments, VPN concentrators, and cloud-based secure web gateways used by mobile devices."
    range: "last 90 days"
    queries:
      - "APPLY Random Forest model to new network sessions. FEATURES: domain_age, threat_intel_match, reputation, JA3/JA3S_freq_percentile, URI_entropy, file_mime_type, file_size, cert_validity, cert_issuer. ALERT IF prediction_probability > 0.85."
  - question: "Has an unapproved or known-bad application on an Android device made an API call associated with dynamic code loading?"
    context: "This question focuses on detecting the direct execution of dynamically loaded code on Android. Certain API calls are primary indicators of this behavior. By correlating these calls with the application's status (i.e., is it on the corporate allowlist?), we can quickly identify unauthorized and potentially malicious activity and trigger an automated response, like quarantining the device."
    answer_sources:
      - "Mobile Threat Defense (MTD) API monitoring logs"
      - "Mobile Device Management (MDM) Application Inventory Logs"
      - "Managed Android mobile devices enrolled in MDM/MTD solutions."
    range: "last 90 days"
    queries:
      - "ON MTD_log_event. FILTER for API_call IN ('dalvik.system.DexClassLoader', 'java.lang.System.load', 'addJavascriptInterface'). JOIN app_package_name with MDM_app_allowlist. ALERT IF app_is_not_allowlisted."
  - question: "Is an application on an Android device exhibiting anomalous behavior by suddenly using or increasing its use of dynamic code loading APIs?"
    context: "This question seeks to identify behavioral changes in applications that might indicate compromise or a newly activated malicious feature. A legitimate application might start using these APIs after a malicious update, or an adversary might trigger a dormant feature. Baselining normal behavior and alerting on deviations (first-time use or frequency spikes) helps detect these subtle shifts."
    answer_sources:
      - "Mobile Threat Defense (MTD) API monitoring logs"
      - "Mobile Device Management (MDM) Application Inventory Logs"
      - "Managed Android mobile devices enrolled in MDM/MTD solutions."
    range: "last 90 days"
    queries:
      - "BASELINE API call counts for dynamic_code_loading_functions per user-app pair over 30 days. ALERT IF (first_time_use_fleet_wide) OR (daily_count > 99th_percentile_of_baseline)."
  - question: "Can an unsupervised machine learning model detect anomalous application behavior on Android, specifically related to dynamic code loading?"
    context: "This question uses unsupervised anomaly detection to find unknown threats without relying on predefined rules or signatures. By modeling the normal behavior of 'known-good' applications based on features like API call sequences and timing, the model can flag applications that deviate significantly. This is particularly effective for identifying novel malware or sophisticated attacks that blend in with normal activity."
    answer_sources:
      - "Mobile Threat Defense (MTD) API monitoring logs"
      - "Mobile Device Management (MDM) Application Inventory Logs"
      - "Managed Android mobile devices enrolled in MDM/MTD solutions."
    range: "last 90 days"
    queries:
      - "APPLY Isolation Forest/LOF model to MTD telemetry streams. FEATURES: API_call_ngrams, time_between_calls, requested_permissions, network_volume. ALERT IF behavior is flagged as anomaly, especially involving dynamic_code_loading_APIs."
  - question: "Has an iOS device connected to a known malicious JSPatch-related domain or has an MTD agent detected the use of a JSPatch function?"
    context: "JSPatch and similar frameworks are a known vector for bypassing Apple's App Store security controls on iOS. This question aims to detect this activity by either matching network traffic against known malicious infrastructure from threat intelligence feeds or by directly observing the use of JSPatch functions via a Mobile Threat Defense (MTD) agent."
    answer_sources:
      - "Mobile Threat Defense (MTD) logs"
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "MDM Application Inventory Logs"
      - "Managed iOS mobile devices enrolled in MDM/MTD solutions and their associated network traffic."
    range: "last 90 days"
    queries:
      - "JOIN iOS network logs (DNS, conn) with mobile_threat_intel_feed. ALERT ON match. SEPARATELY, ALERT ON MTD_log reporting JSPatch function use in non-allowlisted app."
  - question: "Is a non-browser application on an iOS device making suspicious DNS queries (high entropy, rare TLD) followed by a significant data download?"
    context: "This question seeks to identify potential payload delivery to iOS apps through suspicious domains. High entropy in a domain name often indicates algorithmic generation (DGA), a common C2 technique. Similarly, rare TLDs are often abused by attackers. Correlating these suspicious DNS queries from a non-browser app with a subsequent large download is a strong indicator of malicious code being fetched."
    answer_sources:
      - "Mobile Threat Defense (MTD) logs"
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "MDM Application Inventory Logs"
      - "Managed iOS mobile devices enrolled in MDM/MTD solutions and their associated network traffic."
    range: "last 90 days"
    queries:
      - "CALCULATE Shannon entropy for new domains from iOS DNS logs. IDENTIFY queries to rare TLDs. ALERT IF (app is not browser) AND (domain_entropy > 4.0 OR TLD is rare) AND (followed by download > 1MB from domain)."
  - question: "Is a critical iOS application generating an anomalously high volume of network connections?"
    context: "This question uses time-series analysis to baseline the normal network behavior of critical applications and detect significant deviations. A sudden, sustained spike in outbound connections could indicate that an application has been compromised and is being used for C2 communication, data exfiltration, or is downloading additional malicious components. This method can detect suspicious activity even when the destination is not on a known blocklist."
    answer_sources:
      - "Mobile Threat Defense (MTD) logs"
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "MDM Application Inventory Logs"
      - "Managed iOS mobile devices enrolled in MDM/MTD solutions and their associated network traffic."
    range: "last 90 days"
    queries:
      - "FORECAST expected hourly network connections for critical apps using SARIMA/Prophet model. ALERT IF actual_connection_volume > 95%_confidence_interval for > 10 minutes."