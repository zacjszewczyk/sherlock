name: "T1646: Exfiltration Over C2 Channel"
id: "a8e6e24b-3d6f-4c8a-9a9b-7e6d5c4b3a21"
description: "This playbook helps identify if an adversary is exfiltrating data from mobile devices over an established command and control (C2) channel. It focuses on detecting anomalies in network traffic patterns that suggest data theft. Key indicators include anomalously high data volumes or connection durations, especially to destinations flagged by threat intelligence; an abnormally high ratio of outbound POST/PUT requests compared to GET requests, suggesting data upload rather than browsing; and high Shannon entropy in unencrypted traffic, which indicates the use of custom encryption or compression to obfuscate exfiltrated data."
type: "technique"
related:
  - "TA0036: Exfiltration"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has a mobile device connected to a known C2 server, used a malicious TLS client, or sent an unusually large amount of data in a single session?"
    context: "This question seeks to identify high-confidence indicators of C2 communication and data exfiltration. Matching destination IPs against threat intelligence feeds or JA3 hashes against known malware signatures provides strong evidence of malicious activity. A large, single-session data transfer is a classic sign of bulk data exfiltration, which this query can detect using a simple static threshold."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network gateways for corporate Wi-Fi, VPN concentrators, Cloud Access Security Broker (CASB) egress points, and other network egress points monitoring mobile device traffic."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          SEARCH conn.log from mobile_ip_range
          JOIN with c2_threat_feed ON destination_ip
          OR JOIN with ssl.log WHERE ja3_hash IN malicious_ja3_watchlist
          OR WHERE outbound_bytes > 25MB
          RETURN source_ip, destination_ip, outbound_bytes, ja3_hash
  - question: "Has a mobile device exhibited a statistically significant anomaly in its data transfer volume or connection duration to a specific destination compared to its own historical baseline?"
    context: "This question moves beyond static thresholds to detect subtle, anomalous behavior specific to a device's normal communication patterns. An attacker might try to exfiltrate data in volumes that are not large in absolute terms but are highly unusual for that specific device and destination. Comparing activity to a 99th percentile baseline makes this a powerful detection method for such deviations."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network gateways for corporate Wi-Fi, VPN concentrators, Cloud Access Security Broker (CASB) egress points, and other network egress points monitoring mobile device traffic."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          FOR EACH source_ip, destination_ip pair:
            CALCULATE 30_day_baseline_bytes = 99th_percentile(outbound_bytes)
            CALCULATE 30_day_baseline_duration = 99th_percentile(duration)
          SEARCH conn.log WHERE outbound_bytes > 30_day_baseline_bytes OR duration > 30_day_baseline_duration
          RETURN source_ip, destination_ip, outbound_bytes, duration
  - question: "Is the total daily outbound data volume from a mobile device to a specific destination deviating from what a time series model would predict?"
    context: "This is an advanced statistical approach that models the expected data flow over time. It can detect more sophisticated, 'low-and-slow' exfiltration techniques that might not trigger single-session or simple baseline alerts. A deviation from a model's predicted 95% confidence interval is a strong statistical indicator of an abnormal change in the communication pattern that warrants investigation."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek ssl.log"
      - "Network gateways for corporate Wi-Fi, VPN concentrators, Cloud Access Security Broker (CASB) egress points, and other network egress points monitoring mobile device traffic."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          FOR EACH source_ip, destination_ip pair:
            TRAIN time_series_model on 90_days_of(daily_sum(outbound_bytes))
            PREDICT today_expected_volume_range
          SEARCH daily_aggregated_conn.log
          IF today_actual_volume > today_expected_volume_range.upper_bound
            ALERT source_ip, destination_ip, today_actual_volume
  - question: "Is a mobile device making large HTTP POST/PUT requests to suspicious domains, using malicious User-Agent strings, or sending generic binary data to unapproved services?"
    context: "This question hunts for a combination of suspicious indicators within HTTP traffic. DNS lookups for known C2 or high-entropy domains are a primary red flag. When combined with large POST/PUT requests (indicative of data upload), malicious user agents, or generic content types like 'application/octet-stream', the evidence for data exfiltration becomes very strong."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet-facing web proxies, DNS resolvers used by mobile devices, and Unified Endpoint Management (UEM) proxy logs."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          SEARCH dns.log WHERE query IN c2_domain_blocklist OR entropy(query) > high
          CORRELATE source_ip with http.log
          WHERE (method IN ['POST', 'PUT'] AND request_body_len > 1MB)
          OR user_agent IN malicious_user_agent_list
          OR (content_type = 'application/octet-stream' AND destination NOT IN approved_file_services)
          RETURN source_ip, destination_host, user_agent, content_type
  - question: "Is the ratio of data uploads (POSTs) to data downloads (GETs) for a mobile device to a specific web server abnormally high, or is the average size of the uploads statistically unusual compared to its baseline?"
    context: "Normal web browsing involves far more GET requests (downloading content) than POST requests (uploading data). A high POST:GET ratio is a strong indicator that the primary purpose of the communication is data upload. Similarly, a sudden increase in the average size of POST requests suggests that the nature of the uploaded data has changed, potentially to include exfiltrated files."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet-facing web proxies, DNS resolvers used by mobile devices, and Unified Endpoint Management (UEM) proxy logs."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          FOR EACH source_ip, destination_host pair:
            CALCULATE daily_post_get_ratio = count(POST)/count(GET)
            CALCULATE baseline_post_size_avg, baseline_post_size_stdev from 30_day_history
          SEARCH aggregated http.log
          WHERE daily_post_get_ratio > 10
          OR avg(request_body_len) > (baseline_post_size_avg + 3 * baseline_post_size_stdev)
          RETURN source_ip, destination_host, daily_post_get_ratio
  - question: "Does a mobile device's HTTP traffic pattern fall into a cluster of behavior that is anomalous when compared to the majority of network activity?"
    context: "This question uses unsupervised machine learning to find 'unknown unknowns.' By grouping all HTTP sessions based on various features (e.g., size ratios, entropy), most traffic will form large clusters of normal behavior. Outliers—small, isolated clusters—represent highly unusual activity that deviates significantly from the norm and warrants investigation for C2 and exfiltration."
    answer_sources:
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet-facing web proxies, DNS resolvers used by mobile devices, and Unified Endpoint Management (UEM) proxy logs."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          FOR EACH http_session in last hour:
            EXTRACT features (post_get_ratio, size_ratio, ua_entropy, uri_entropy, content_type_dist)
          APPLY DBSCAN clustering algorithm to feature_set
          INVESTIGATE sessions identified as outliers/noise
          RETURN outlier_session_details
  - question: "Is a mobile device transferring archived files (like ZIP or RAR) over unencrypted channels to destinations that are not approved corporate cloud services?"
    context: "Adversaries often compress and archive data before exfiltration to reduce its size and bundle many files together. Detecting the transfer of these archive file types over cleartext protocols (like HTTP or FTP) to non-standard or unapproved destinations is a strong indicator of data staging and exfiltration."
    answer_sources:
      - "Zeek files.log"
      - "Zeek conn.log"
      - "PCAP"
      - "Network TAPs capturing traffic from mobile subnets, Virtual Private Cloud (VPC) traffic mirroring, and Wi-Fi access points configured for full packet capture."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          SEARCH files.log WHERE mime_type IN ['application/zip', 'application/x-rar-compressed']
          CORRELATE conn_uids with conn.log to get destination_ip
          WHERE destination_ip NOT IN approved_cloud_service_ips
          RETURN source_ip, destination_ip, file_mime_type
  - question: "Is unencrypted traffic from a mobile device to an unapproved destination exhibiting high entropy, suggesting it is compressed or custom-encrypted?"
    context: "Shannon entropy measures the randomness of data. Plain text has low entropy, while compressed or encrypted data has very high entropy. If an adversary uses a custom encryption scheme or simply compresses data before sending it over a non-TLS channel, the high entropy of the payload will be a key indicator of exfiltration, especially when the destination is not an approved service."
    answer_sources:
      - "Zeek files.log"
      - "Zeek conn.log"
      - "PCAP"
      - "Network TAPs capturing traffic from mobile subnets, Virtual Private Cloud (VPC) traffic mirroring, and Wi-Fi access points configured for full packet capture."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          FOR EACH unencrypted_flow from mobile_device:
            IF destination_ip NOT IN enterprise_allow_list:
              CALCULATE payload_entropy
              IF payload_entropy > 7.5:
                ALERT source_ip, destination_ip, payload_entropy
  - question: "Can a machine learning model, trained on a wide range of network features, classify a given network flow from a mobile device as potential exfiltration?"
    context: "This represents a holistic, machine learning-driven approach. By combining numerous features—from connection metadata (duration, bytes) to payload analysis (entropy) and threat intelligence—a classification model can learn the complex patterns of exfiltration traffic. This allows it to identify malicious flows with higher confidence and detect novel techniques that might evade simpler, single-indicator rules."
    answer_sources:
      - "Zeek files.log"
      - "Zeek conn.log"
      - "PCAP"
      - "Network TAPs capturing traffic from mobile subnets, Virtual Private Cloud (VPC) traffic mirroring, and Wi-Fi access points configured for full packet capture."
    range: "last 90 days"
    queries:
      - search_technology: "Pseudocode"
        query: |
          features = [payload_entropy, protocol, port, duration, bytes_out, bytes_in, packet_size_stats, is_on_threat_list]
          TRAIN classification_model on labeled_flows(features) -> 'benign' or 'exfil'
          FOR EACH live_network_flow:
            prediction = model.predict(flow_features)
            IF prediction == 'exfil':
              ALERT flow_details