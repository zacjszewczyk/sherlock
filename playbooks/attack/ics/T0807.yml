name: "T0807: Command-Line Interface"
id: "f8a9b1c0-2d3e-4f5a-b6c7-d8e9f0a1b2c3"
description: |
  This playbook helps answer the question: Is an adversary executing commands on critical ICS assets via a command-line interface? It provides investigative steps to detect anomalous command-line usage that could indicate malicious activity. This includes identifying when known ICS management shells (e.g., cmd.exe, powershell.exe, vendor CLIs) spawn un-whitelisted or statistically rare child processes. It also covers scenarios where a remote interactive logon from an untrusted source is immediately followed by command-line activity. Finally, it addresses the detection of commands that contain signs of obfuscation, defense evasion, or discovery through pattern matching, entropy analysis, and machine learning classification.
type: "technique"
related:
  - "TA0104: Execution"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is an unauthorized child process being spawned by a known shell on a critical ICS asset?"
    context: |
      This question aims to detect malicious activity by identifying process creations that deviate from a pre-approved whitelist. Known shells like cmd.exe or vendor-specific CLIs should only spawn a predictable set of child processes on critical systems. Any deviation could indicate an adversary attempting to execute discovery commands, install persistence, or move laterally.
    answer_sources:
      - "Windows Event ID 4688"
      - "Applicable to: Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Historian Servers, Process Control Servers (PCS), Data Gateways, Application Servers within the Process Control Network (PCN) and Manufacturing Zone (MZ)."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (EID 4688) WHERE parent_process is a shell AND (hostname, parent_process, child_process) NOT IN whitelist. ALERT high severity."
  - question: "Has a new or rarely seen child process been executed by a shell on an ICS host?"
    context: |
      This question focuses on detecting novel or infrequent process relationships that might be missed by a static whitelist. By baselining normal parent-child process behavior over 90 days, we can flag new or statistically rare executions. This is useful for catching living-off-the-land (LOLBin) attacks or the initial stages of a compromise where an attacker uses legitimate tools for malicious purposes for the first time.
    answer_sources:
      - "Windows Event ID 4688"
      - "Applicable to: Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Historian Servers, Process Control Servers (PCS), Data Gateways, Application Servers within the Process Control Network (PCN) and Manufacturing Zone (MZ)."
    range: "last 90 days"
    queries:
      - "FOR each host, SEARCH process creation events (EID 4688) WHERE parent_process is a shell. IF child_process not in 90-day baseline for parent_host, ALERT medium. IF child_process is LOLBin, ESCALATE high."
  - question: "Is there a statistical anomaly in the number of unique commands being executed from a shell on a critical host?"
    context: |
      This question seeks to identify anomalous bursts of command-line activity. An adversary performing reconnaissance or executing a malicious script will often spawn many different child processes in a short period. By modeling the normal hourly count of unique processes and applying anomaly detection, we can detect these unusual spikes that deviate from regular operational patterns, even if the individual commands themselves are not inherently malicious.
    answer_sources:
      - "Windows Event ID 4688"
      - "Applicable to: Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Historian Servers, Process Control Servers (PCS), Data Gateways, Application Servers within the Process Control Network (PCN) and Manufacturing Zone (MZ)."
    range: "last 90 days"
    queries:
      - "FOR each host and shell, MODEL hourly unique child process count. APPLY time-series anomaly detection. ALERT if count > forecast + 3 * std_dev."
  - question: "Did a remote logon from an untrusted network result in the immediate execution of reconnaissance commands?"
    context: |
      This question correlates network logon events with subsequent process execution to detect initial access and discovery. An attacker gaining remote access (e.g., via RDP) from an unusual location (like a non-corporate IP) and immediately running commands like 'whoami' or 'net user' within a short time window (90 seconds) is a strong indicator of a hands-on-keyboard attack.
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek rdp.log"
      - "Zeek ssh.log"
      - "Applicable to: ICS DMZ/Perimeter, Remote Access Gateways, Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Jump Servers, and Terminal Servers within the ICS network."
    range: "last 90 days"
    queries:
      - "CORRELATE remote logon (EID 4624 Type 10, Zeek SSH success) with process creation (EID 4688) within 90s on same Logon ID. IF source_ip is untrusted AND command is for reconnaissance, ALERT."
  - question: "Does a user's current remote session exhibit behavior that deviates significantly from their historical profile?"
    context: |
      This question aims to detect compromised user accounts by scoring the risk of a remote session based on behavioral analytics. It builds a profile of normal user behavior (e.g., typical source locations, times, commands). A session initiated from a new country, outside of normal work hours, and using an entirely different set of commands would generate a high risk score, suggesting the credentials may be compromised.
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek rdp.log"
      - "Zeek ssh.log"
      - "Applicable to: ICS DMZ/Perimeter, Remote Access Gateways, Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Jump Servers, and Terminal Servers within the ICS network."
    range: "last 90 days"
    queries:
      - "FOR each remote session, CALCULATE risk score based on deviations from user's 90-day baseline (new ASN, new country, off-hours, low command similarity). IF score > threshold, ALERT."
  - question: "Is a user's remote session a statistical outlier when compared to all historical user sessions?"
    context: |
      This question uses unsupervised machine learning to identify anomalous remote sessions without pre-defined rules. By creating a feature vector for each session (e.g., duration, number of commands, command entropy), a model like Isolation Forest can learn what constitutes 'normal' session behavior across the entire user base. It can then flag sessions that are statistically different, which could represent a novel attack pattern or a compromised account being used in an unusual way.
    answer_sources:
      - "Windows Event ID 4624"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek rdp.log"
      - "Zeek ssh.log"
      - "Applicable to: ICS DMZ/Perimeter, Remote Access Gateways, Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Jump Servers, and Terminal Servers within the ICS network."
    range: "last 90 days"
    queries:
      - "FOR each new remote session, CREATE feature vector (duration, process_count, command_entropy, etc.). USE trained Isolation Forest/VAE model to score session. IF score is outlier, ALERT."
  - question: "Is a command line being executed that contains known malicious or suspicious patterns?"
    context: |
      This question focuses on detecting known-bad command line patterns using signature-based detection. It involves searching for specific strings and flags commonly used by attackers, such as PowerShell encoding ('-enc'), download cradles ('IEX'), and file transfer utilities like 'bitsadmin' or 'certutil' used to fetch remote payloads. This provides a direct and effective way to catch common TTPs.
    answer_sources:
      - "Windows Event ID 4688"
      - "Applicable to: All Windows-based ICS assets, including HMIs, EWS, Historian Servers, Process Control Servers (PCS), and Data Gateways within the Process Control Network (PCN) and higher zones."
    range: "last 90 days"
    queries:
      - "SEARCH process creation events (EID 4688) WHERE command_line MATCHES regex for malicious patterns ('-enc', 'IEX(...)', 'bitsadmin /transfer', etc.). ALERT."
  - question: "Is a command line exhibiting high entropy or a high ratio of special characters, suggesting obfuscation?"
    context: |
      This question aims to detect obfuscated commands that might evade simple signature-based rules. Attackers often encode or obfuscate their payloads, resulting in command-line arguments with high Shannon entropy or an unusually high number of non-alphanumeric characters. By baselining these metrics for normal commands, we can flag significant deviations that point to obfuscated script execution.
    answer_sources:
      - "Windows Event ID 4688"
      - "Applicable to: All Windows-based ICS assets, including HMIs, EWS, Historian Servers, Process Control Servers (PCS), and Data Gateways within the Process Control Network (PCN) and higher zones."
    range: "last 90 days"
    queries:
      - "FOR each command (EID 4688), CALCULATE entropy and non-alphanumeric ratio of arguments. IF entropy > 4.5 OR > 3*std_dev from baseline OR ratio > 99th percentile, ALERT."
  - question: "Does a machine learning model classify a command line as malicious?"
    context: |
      This question uses a supervised machine learning model (like an LSTM) to provide a more sophisticated and adaptable method for detecting malicious command lines. Trained on a large dataset of both benign and malicious examples, the model can learn the subtle, complex patterns and structures of malicious commands that are difficult to capture with regex or simple statistical measures. This allows for the detection of novel or highly obfuscated attack techniques.
    answer_sources:
      - "Windows Event ID 4688"
      - "Applicable to: All Windows-based ICS assets, including HMIs, EWS, Historian Servers, Process Control Servers (PCS), and Data Gateways within the Process Control Network (PCN) and higher zones."
    range: "last 90 days"
    queries:
      - "FOR each command (EID 4688), PASS command_line to trained classification model (e.g., LSTM). IF model_output is 'malicious' with confidence > 0.9, ALERT."