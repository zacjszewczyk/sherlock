name: T0865: Spearphishing Attachment
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook is designed to answer the primary investigative requirement of whether an adversary is attempting to gain initial access to an Industrial Control System (ICS) environment via spearphishing attachments. It outlines a multi-stage detection strategy, beginning with the identification of suspicious emails containing high-risk attachments sent to key ICS personnel. It then details methods for detecting the subsequent execution of a malicious payload on an endpoint, characterized by anomalous process creation events (e.g., an email client spawning a command shell). Finally, it provides guidance on identifying command-and-control (C2) activity by monitoring for anomalous outbound network connections originating from the compromised process.
type: technique
related:
  - TA0108: Initial Access
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a high-value ICS user received an email from an external source with a high-risk attachment based on file type, keywords, or known-bad hash?
    context: This question aims to identify the initial delivery of a malicious spearphishing attachment. By monitoring emails sent to key personnel like ICS engineers and OT operators, we can proactively detect threats. This involves checking for attachments with risky file types (executables, scripts, macro-enabled documents, ICS project files), specific keywords related to industrial control systems ('PLC', 'SCADA', 'HMI'), or attachments whose hash matches a known malicious file from threat intelligence feeds. Answering this helps catch the attack at its earliest stage.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Zeek dns.log
      - Zeek x509.log
      - Active Directory Logs
      - Corporate Email Gateway
      - OT Network Mail Relay (if present)
      - Corporate-to-OT DMZ
      - Engineering Workstations (local email client logs)
      - Control System Network (for internal email traffic if applicable)
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: JOIN Zeek smtp.log with files.log ON fuid. FILTER for emails to high-value users from external senders. ALERT if attachment hash is in threat_intel_list OR (attachment file_type is in high_risk_list AND (email_subject CONTAINS ics_keywords OR attachment_filename CONTAINS ics_keywords)).
  - question: Has a high-risk ICS user received a suspicious email attachment from an infrequent or new sender, or does the email exhibit signs of obfuscation through high entropy in the subject or filename?
    context: This question focuses on detecting anomalies in communication patterns and content. Attackers often use new domains or try to obfuscate their intentions. By baselining normal sender-recipient communication frequency, we can flag emails from rare or previously unseen senders. Additionally, calculating the Shannon entropy of filenames and subjects helps identify randomized or algorithmically generated text, a common tactic to bypass simple filters. This provides a statistical method to uncover sophisticated phishing attempts.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Zeek dns.log
      - Zeek x509.log
      - Active Directory Logs
      - Corporate Email Gateway
      - OT Network Mail Relay (if present)
      - Corporate-to-OT DMZ
      - Engineering Workstations (local email client logs)
      - Control System Network (for internal email traffic if applicable)
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: FOR emails to high-value users with high-risk attachments, CALCULATE 90-day baselines. ALERT if sender_domain_frequency < 1st percentile. ALERT if filename_entropy > 99th percentile OR subject_entropy > 99th percentile.
  - question: Based on a machine learning model, what is the probability that an email with an attachment sent to a high-risk user is a spearphishing attempt?
    context: This question leverages machine learning to provide a holistic risk assessment of incoming emails. Instead of relying on single indicators, a classification model can analyze a multitude of features simultaneouslyâ€”such as sender reputation, email authentication results (DMARC/SPF/DKIM), keyword density, and attachment properties. This approach allows for the detection of nuanced phishing attacks that might evade rule-based systems, generating a high-confidence alert when the probability score exceeds a critical threshold.
    answer_sources:
      - Zeek smtp.log
      - Zeek files.log
      - Zeek dns.log
      - Zeek x509.log
      - Active Directory Logs
      - Corporate Email Gateway
      - OT Network Mail Relay (if present)
      - Corporate-to-OT DMZ
      - Engineering Workstations (local email client logs)
      - Control System Network (for internal email traffic if applicable)
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: INPUT email metadata (sender_reputation, auth_results, keyword_density, attachment_type, etc.) into ML_phishing_model. ALERT if recipient is high-value_user AND model_output_score > 0.90.
  - question: Has a common document or email application (e.g., Outlook, Word, Acrobat) spawned a suspicious child process like a command-line interpreter or scripting engine on an ICS asset?
    context: This question targets the user execution phase of an attack. A legitimate user opening a malicious attachment often triggers a chain of events where the parent application (e.g., WINWORD.EXE) launches a child process (e.g., powershell.exe) to execute malicious code. This is highly abnormal behavior. By monitoring for these unauthorized parent-child process relationships using Windows Event ID 4688 and comparing them against a pre-defined allowlist, we can detect the moment a malicious payload is activated on a critical workstation or HMI.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Windows Event ID 4103
      - Windows Event ID 4624
      - Engineering Workstations
      - Human-Machine Interfaces (HMIs)
      - Operator Consoles
      - Jump Servers within the OT network
      - Data Historians
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH for Windows Event ID 4688. ALERT if parent_process is in (OUTLOOK.EXE, WINWORD.EXE, etc.) AND child_process is in (cmd.exe, powershell.exe, etc.) AND the (parent_process, child_process) pair is NOT IN process_allowlist.
  - question: Has a statistically anomalous process execution event occurred on an ICS asset, such as a never-before-seen parent-child process pair or a command-line with unusually high entropy?
    context: This question uses behavioral analytics to find novel or obfuscated execution patterns. This approach establishes a baseline of normal process activity and command-line usage. It can then flag two types of anomalies: 1) The first-ever occurrence of a specific parent-child process relationship, and 2) The use of highly randomized or obfuscated command-line arguments, detected by a spike in entropy. This is effective against fileless malware and living-off-the-land techniques.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Windows Event ID 4103
      - Windows Event ID 4624
      - Engineering Workstations
      - Human-Machine Interfaces (HMIs)
      - Operator Consoles
      - Jump Servers within the OT network
      - Data Historians
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: FOR Windows Event ID 4688, BASELINE parent-child pairs and command-line statistics. ALERT if a new pair involving a document_handler and LOLBAS is seen. ALERT if command-line entropy > 98th percentile for a suspicious process.
  - question: Did a machine learning model detect an anomalous process execution chain originating from a document or email application on an ICS asset?
    context: This question applies advanced machine learning to model complex process behaviors. A graph-based or RNN model can learn the normal sequences and trees of process creation on a system, including entire execution chains and command-line arguments. This allows it to detect sophisticated attacks that use multiple legitimate-looking steps to hide their activity. An alert is triggered when an execution sequence deviates significantly from the learned normal behavior.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Windows Event ID 4103
      - Windows Event ID 4624
      - Engineering Workstations
      - Human-Machine Interfaces (HMIs)
      - Operator Consoles
      - Jump Servers within the OT network
      - Data Historians
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: INPUT process execution chain data (process_name, parent_process, command_line, etc.) into ML_process_anomaly_model. ALERT if the chain originates from a document_handler AND model_output_score > 0.9.
  - question: Is a suspicious process, spawned from a document or email, making outbound network connections to a known-malicious destination or using a self-signed certificate?
    context: This question seeks to confirm malicious activity by tracking the network behavior of a process already flagged as suspicious. By linking the ProcessID from the execution event to network connection events, we can check if the process is communicating with command-and-control (C2) servers. A connection to an IP/domain on a threat intelligence list, or a TLS connection using a self-signed certificate, is a very strong indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek x509.log
      - Engineering Workstations
      - HMIs
      - OT Network Egress Firewalls
      - Industrial Demilitarized Zone (IDMZ) Firewalls
      - Corporate-to-OT DMZ
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: FOR suspicious_process from EventID 4688, GET ProcessID. FIND network connections (EventID 5156, Zeek) with that ProcessID. ALERT if destination_IP/domain/SNI/JA3 is in threat_intel_list OR TLS_cert is self-signed.
  - question: Is a suspicious process exhibiting anomalous network behavior, such as communicating over a rare port, beaconing at regular intervals, or exfiltrating an unusually large amount of data?
    context: This question aims to detect C2 communications and data exfiltration through statistical analysis of network traffic. By baselining normal network activity for each host, we can flag deviations such as communication on an extremely rare port, highly periodic connection intervals (low variance) indicating beaconing, or an unusually high ratio of outgoing to incoming data, which could signify data theft.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek x509.log
      - Engineering Workstations
      - HMIs
      - OT Network Egress Firewalls
      - Industrial Demilitarized Zone (IDMZ) Firewalls
      - Corporate-to-OT DMZ
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: FOR connections from suspicious_process, BASELINE network statistics. ALERT if destination port_frequency < 1st percentile. ALERT if connection interval variance is near zero. ALERT if outbound/inbound byte ratio > 98th percentile.
  - question: Has a machine learning model detected an anomalous sequence of network connections originating from a suspicious process on a critical ICS host?
    context: This question applies a sophisticated time-series anomaly detection model (e.g., LSTM Autoencoder) to identify complex malicious network patterns. The model learns the normal sequences of network flows for a host. When a new sequence of connections from a suspicious process doesn't match the learned patterns, the model produces a high "reconstruction error," signaling a significant anomaly that could be C2 beaconing or data exfiltration.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek x509.log
      - Engineering Workstations
      - HMIs
      - OT Network Egress Firewalls
      - Industrial Demilitarized Zone (IDMZ) Firewalls
      - Corporate-to-OT DMZ
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: INPUT network flow sequence from suspicious_process into ML_network_anomaly_model. ALERT if model reconstruction_error > 0.9.