name: "T0890: Exploitation for Privilege Escalation"
id: "4e8b5d3a-1b7c-4a9e-8c6d-2f0b9a3e1d7f"
description: "This playbook helps determine if an adversary is exploiting vulnerabilities to escalate privileges on critical ICS assets like Engineering Workstations or HMIs. It provides methods to detect anomalous child processes (e.g., cmd.exe) spawned by legitimate, high-privilege ICS applications, the installation of new suspicious services running with elevated privileges in non-standard locations, and the correlation of these host-based events with preceding suspicious network activity like connections to rare external IPs or internal transfers of executable files."
type: "technique"
related:
  - "TA0111: Privilege Escalation"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a known, high-privilege ICS application spawning a suspicious utility like a command shell or hacking tool?"
    context: "This question aims to detect a common attack pattern where an adversary, having compromised a legitimate ICS application, uses its elevated privileges to launch system tools for further reconnaissance or lateral movement. Legitimate ICS applications rarely spawn command shells, so such an event is highly suspicious and indicative of post-exploitation activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Historian Servers, and OPC Servers within the Process Control Network (PCN) and Manufacturing Zone (MZ)."
    range: "last 90 days"
    queries:
      - technology: "SIEM"
        query: |
          SEARCH process_creation_events (event_id=4688 OR event_id=1)
          WHERE parent_process IN (ics_app_allowlist)
          AND child_process IN (suspicious_utility_watchlist)
          AND (privilege_level='High' OR integrity_level='System')
  - question: "Has a new or rare parent-child process relationship appeared on a critical ICS asset?"
    context: "This question focuses on detecting novel process behaviors that deviate from an established baseline. Adversaries often introduce new process execution chains that have never been seen before on a specific host. By identifying these first-time occurrences and assessing their rarity across the entire environment, analysts can uncover stealthy exploitation attempts that might not involve known suspicious tools."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Historian Servers, and OPC Servers within the Process Control Network (PCN) and Manufacturing Zone (MZ)."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: |
          FOR each new process_creation_event:
            tuple = (event.parent_process, event.child_process, event.command_line)
            IF tuple IS NOT IN host_baseline(90d):
              rarity = calculate_global_rarity(tuple)
              IF rarity < threshold:
                ALERT (High Priority)
              ELSE:
                ALERT (Medium Priority)
  - question: "Does a recent process creation event on an ICS asset register as a statistical anomaly according to a machine learning model?"
    context: "This question leverages unsupervised machine learning to find outliers in process creation data. Unlike rule-based methods, ML models can identify complex and subtle deviations across multiple features (e.g., process names, command line length/entropy, user context) that collectively indicate anomalous behavior. This is effective for catching novel or sophisticated attack techniques."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), Historian Servers, and OPC Servers within the Process Control Network (PCN) and Manufacturing Zone (MZ)."
    range: "last 90 days"
    queries:
      - technology: "ML Model (Pseudocode)"
        query: |
          FOR each new process_creation_event:
            features = extract_features(event)
            anomaly_score = model.predict(features)
            IF anomaly_score > anomaly_threshold (e.g., 99th percentile):
              ALERT (High Priority)
  - question: "Has a new service been installed to run with high privileges from an unusual, user-writable directory or using an unapproved executable?"
    context: "This question looks for adversaries establishing persistence by installing a malicious service. Attackers often place service executables in non-standard directories like Temp or ProgramData to bypass stricter permissions on system folders. By checking for services running as LocalSystem from these locations or using executables not on an allowlist, analysts can detect this common privilege escalation and persistence technique."
    answer_sources:
      - "Windows Event ID 4697"
      - "Windows Event ID 7045"
      - "Sysmon Event ID 13"
      - "Engineering Workstations (EWS), HMIs, Historian Servers, OPC Servers, and other critical Windows-based ICS infrastructure components within the PCN/MZ."
    range: "last 90 days"
    queries:
      - technology: "SIEM"
        query: |
          SEARCH service_creation_events (event_id=4697 OR event_id=7045)
          WHERE service_account IN ('LocalSystem', 'NT AUTHORITY\\SYSTEM')
          AND (service_path IN (user_writable_dirs) OR service_executable NOT IN (approved_service_exe_allowlist))
  - question: "Does a newly installed service have a randomly generated name or executable filename?"
    context: "This question aims to identify services created with randomized names, a technique adversaries use to evade signature-based detections and make their tools harder to track. Legitimate service names are typically descriptive, while malicious ones are often a random string of characters. By measuring the character randomness (entropy) and comparing it to a baseline of normal services, analysts can flag suspicious installations."
    answer_sources:
      - "Windows Event ID 4697"
      - "Windows Event ID 7045"
      - "Sysmon Event ID 13"
      - "Engineering Workstations (EWS), HMIs, Historian Servers, OPC Servers, and other critical Windows-based ICS infrastructure components within the PCN/MZ."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: |
          FOR each new service_creation_event:
            name_entropy = calculate_shannon_entropy(event.service_name)
            filename_entropy = calculate_shannon_entropy(event.service_filename)
            IF name_entropy > baseline_95th_percentile OR filename_entropy > baseline_95th_percentile:
              ALERT (Medium Priority)
  - question: "Does a new service installation exhibit a combination of characteristics deemed malicious by a machine learning classifier?"
    context: "This question applies a supervised machine learning model to classify new service installations as benign or malicious. The model is trained to recognize complex patterns across various features, such as file path depth, name entropy, account type, and start type. This provides a more robust and context-aware detection method than simple rules, allowing it to catch sophisticated threats."
    answer_sources:
      - "Windows Event ID 4697"
      - "Windows Event ID 7045"
      - "Sysmon Event ID 13"
      - "Engineering Workstations (EWS), HMIs, Historian Servers, OPC Servers, and other critical Windows-based ICS infrastructure components within the PCN/MZ."
    range: "last 90 days"
    queries:
      - technology: "ML Model (Pseudocode)"
        query: |
          FOR each new service_creation_event:
            features = extract_features(event)
            malicious_probability = model.predict_proba(features)
            IF malicious_probability > 0.90:
              ALERT (High Priority)
  - question: "Did a suspicious network event, such as a connection to an unknown external IP or the download of an executable, immediately precede an anomalous process or service creation on an ICS asset?"
    context: "This question seeks to connect the dots between potential exploit delivery and host-based execution. An adversary often needs to transfer a payload to the target before they can execute it to escalate privileges. By correlating suspicious network activity with subsequent host-based anomalies within a short time window, analysts can build a stronger, higher-fidelity alert that captures multiple stages of the attack chain."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Zeek smb_files.log"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4697"
      - "Windows Event ID 7045"
      - "Sysmon Event ID 1"
      - "Network segments connecting EWS, HMIs, and servers within the PCN/MZ; industrial demilitarized zones (IDMZ) and network gateways connecting the PCN to enterprise IT networks."
    range: "last 90 days"
    queries:
      - technology: "SIEM Correlation Rule"
        query: |
          JOIN by IP address, time window 120s
          STREAM A: network_events WHERE (is_suspicious_download OR is_external_untrusted_conn)
          STREAM B: host_events WHERE (is_anomalous_process OR is_suspicious_service)
          TRIGGER when Stream A is followed by Stream B for same IP
  - question: "Following a rare network event from an ICS asset (e.g., a connection to a first-seen IP or domain), did any other host-based anomaly occur on that same asset shortly after?"
    context: "This question uses the detection of a rare network behavior as a trigger to scrutinize subsequent host activity more closely. The premise is that communication with a novel external entity is a potential indicator of C2 communication or payload download. By creating a short, heightened monitoring window after such an event, security systems can link the otherwise disparate network and host alerts, providing valuable context that a privilege escalation attempt may be underway."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Zeek smb_files.log"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4697"
      - "Windows Event ID 7045"
      - "Sysmon Event ID 1"
      - "Network segments connecting EWS, HMIs, and servers within the PCN/MZ; industrial demilitarized zones (IDMZ) and network gateways connecting the PCN to enterprise IT networks."
    range: "last 90 days"
    queries:
      - technology: "Pseudocode"
        query: |
          FOR each new network_event:
            IF event.destination IS NOT IN host_baseline(90d):
              MONITOR event.source_ip for 120s
              IF high_priority_host_alert occurs on event.source_ip in window:
                CORRELATE and ALERT (High Priority)
  - question: "Has an ICS asset accumulated a high risk score from a combination of lower-confidence alerts related to anomalous processes, services, and network activity?"
    context: "This question addresses the problem of alert fatigue by aggregating multiple, potentially low-priority signals into a single, high-confidence risk score. Instead of firing separate alerts for a rare process, a suspicious service, and an odd network connection, the RBA framework combines them. When the cumulative risk for a single asset (like an HMI) crosses a threshold, it generates one composite alert, presenting the analyst with a unified view of a potential multi-stage attack."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Zeek http.log"
      - "Zeek smb_files.log"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4697"
      - "Windows Event ID 7045"
      - "Sysmon Event ID 1"
      - "Network segments connecting EWS, HMIs, and servers within the PCN/MZ; industrial demilitarized zones (IDMZ) and network gateways connecting the PCN to enterprise IT networks."
    range: "last 90 days"
    queries:
      - technology: "RBA Framework (Pseudocode)"
        query: |
          FOR each new security_event for an entity:
            entity.risk_score += event.score * event.weight
          IF entity.risk_score > critical_threshold within a 5-min window:
            GENERATE composite alert for entity
            RESET entity.risk_score