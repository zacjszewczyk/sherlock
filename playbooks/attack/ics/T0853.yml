name: 'T0853: Scripting'
id: 'a9d8e7c6-f5b4-4c3d-2b1a-0e9f8d7c6b5a'
description: 'This playbook helps detect if an adversary is executing unauthorized scripts (PowerShell, Python, Wscript/Cscript) on critical ICS assets like Engineering Workstations or HMIs. It focuses on identifying suspicious execution patterns such as high-risk command-line arguments, execution from non-standard parent processes, anomalous script content based on entropy or machine learning classification, execution from temporary locations, and outbound network connections to malicious destinations or rare domains.'
type: 'technique'
related:
  - 'TA0104: Execution'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: '1.0'
tags: 'none'
questions:
  - question: 'Is PowerShell being executed with high-risk command-line arguments, from an unusual parent process, or is it connecting to known malicious destinations?'
    context: 'This question aims to detect common PowerShell abuse patterns. Adversaries often use encoded commands, bypass execution policies, or hide windows to evade detection. Execution from unexpected parent processes (like Office applications) can indicate macro-based attacks. Outbound connections to threat-listed IPs can signify C2 communication or data exfiltration.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 3'
      - 'Zeek conn.log'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Data Historians'
      - 'Process Servers'
      - 'Jump Servers'
      - 'Domain Controllers'
      - 'OT DMZ'
      - 'Remote Access Servers'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_logs WHERE process_name = "powershell.exe" AND (command_line CONTAINS "-enc" OR command_line CONTAINS "-ep bypass" OR command_line CONTAINS "IEX(" OR command_line CONTAINS "-w hidden") OR parent_process NOT IN ("explorer.exe", "cmd.exe", "pwsh.exe", "sqlagent.exe", "mmc.exe"); JOIN network_logs ON host_ip, timestamp; FILTER destination_ip IN threat_intel_feed;'
  - question: 'Is there anomalous PowerShell script content or command-line length that deviates significantly from historical baselines for a specific host or user?'
    context: 'This question focuses on statistical anomaly detection. High Shannon entropy in a script block often indicates obfuscation or encryption, common techniques used to hide malicious code. Similarly, an unusually long command line for a specific user on a specific host can be a sign of a complex, non-standard, and potentially malicious operation.'
    answer_sources:
      - 'Windows Event ID 4104'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Data Historians'
      - 'Process Servers'
      - 'Jump Servers'
      - 'Domain Controllers'
      - 'OT DMZ'
      - 'Remote Access Servers'
    range: 'last 90 days'
    queries:
      - 'CALCULATE shannon_entropy_baseline(script_block_logs, host, 30_days); ALERT on new_log WHERE entropy > 98th_percentile; CALCULATE cmd_length_baseline(process_logs, user, host, 30_days); ALERT on new_process WHERE length > mean + 3*std_dev;'
  - question: 'Can machine learning models classify PowerShell script content as malicious or identify anomalous PowerShell process execution behavior?'
    context: 'This question leverages advanced machine learning to move beyond simple signatures. A text classification model can identify malicious intent within script code itself, even if it does not use obvious keywords. Anomaly detection models like Isolation Forest can learn the "normal" patterns of process execution (parent process, user, time of day, etc.) and flag any deviation, catching novel or sophisticated attack techniques.'
    answer_sources:
      - 'Windows Event ID 4104'
      - 'Sysmon Event ID 1'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Data Historians'
      - 'Process Servers'
      - 'Jump Servers'
      - 'Domain Controllers'
      - 'OT DMZ'
      - 'Remote Access Servers'
    range: 'last 90 days'
    queries:
      - 'CLASSIFY script_block_content(log_4104) using text_classification_model; ALERT where probability > 0.85; DETECT_ANOMALY process_features(log_1) using isolation_forest_model; ALERT on anomaly_flag;'
  - question: 'Is an unauthorized version of Python being used, is a Python script being executed shortly after being written to disk, or is a Python process connecting to known malicious IPs?'
    context: 'This question targets the unauthorized introduction and execution of Python scripts. Adversaries may bring their own Python interpreter to bypass restrictions. The "write-then-execute" pattern is a classic indicator of a dropped payload. Connecting to a threat-listed IP is a strong signal of malicious activity.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 11'
      - 'Zeek files.log'
      - 'Sysmon Event ID 3'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Process Control Servers'
      - 'Data Historians'
      - 'OT Network Segments'
      - 'Jump Servers'
      - 'OT DMZ'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_logs WHERE process_name IN ("python.exe", "pythonw.exe") AND process_path NOT IN allowlist; CORRELATE file_creation_events(".py", ".pyc") with process_creation_events ON host, filename WHERE time_delta < 15_minutes; JOIN process_creation_events with network_logs; ALERT if destination_ip IN threat_intel_feed;'
  - question: 'Is a Python script being executed from a novel file path on a host, or is a Python process making DNS requests for exceptionally rare domains?'
    context: 'This question uses "first seen" and rarity analysis to find anomalies. Execution from a new path could mean a newly dropped malicious script. A DNS request for a rare domain (high IDF score) is highly suspicious, as legitimate software usually contacts common, well-known domains. This is a strong indicator of algorithmically generated domains (DGAs) used for C2.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Zeek dns.log'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Process Control Servers'
      - 'Data Historians'
      - 'OT Network Segments'
      - 'Jump Servers'
      - 'OT DMZ'
    range: 'last 90 days'
    queries:
      - 'MAINTAIN baseline of executed_python_script_paths per host; ALERT on "first_seen" script_path execution; CALCULATE IDF for all domains network-wide from DNS_logs; ALERT when python.exe process queries domain with IDF_score in top 1%;'
  - question: 'Can machine learning models identify anomalous Python execution events or classify the content of newly written Python files as malicious?'
    context: 'This question applies machine learning to detect suspicious Python activity. A One-Class SVM can learn the characteristics of normal Python executions and flag outliers that do not fit the model. A Gradient Boosting classifier can analyze the source code of a Python script itself, identifying malicious intent based on imported libraries and function calls, providing a deeper level of inspection.'
    answer_sources:
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 11'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Process Control Servers'
      - 'Data Historians'
      - 'OT Network Segments'
      - 'Jump Servers'
      - 'OT DMZ'
    range: 'last 90 days'
    queries:
      - 'SCORE python_execution_events using One_Class_SVM_model; ALERT on outliers; CLASSIFY python_file_content using Gradient_Boosting_model; ALERT if malicious_score > 0.90;'
  - question: 'Is a Windows Script Host process (wscript.exe/cscript.exe) being launched by an unusual parent process, executing a script from a temporary directory shortly after creation, or connecting to a malicious IP?'
    context: 'This question targets common delivery and execution methods for malicious scripts. Launching from Office applications or browsers is a classic sign of a phishing attachment or drive-by download. Dropping a script to a temporary directory and immediately executing it is a hallmark of malware droppers. Connections to threat-listed IPs are a strong indicator of C2 activity.'
    answer_sources:
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 11'
      - 'Sysmon Event ID 3'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Data Historians'
      - 'Process Servers'
      - 'Jump Servers'
      - 'OT DMZ'
    range: 'last 90 days'
    queries:
      - 'SEARCH process_creation_logs WHERE process_name IN ("wscript.exe", "cscript.exe") AND parent_process IN ("winword.exe", "excel.exe", "outlook.exe", "acrord32.exe", "chrome.exe", "firefox.exe"); CORRELATE file_creation_events(".js", ".vbs", ".wsf") in temp_dirs with process_execution_events on same host/file WHERE time_delta < 5_minutes; JOIN wscript/cscript process_events with network_logs; ALERT if destination_ip IN threat_intel_feed;'
  - question: 'Is a Windows Script Host execution using an unusually long command line or executing a script with a rare or never-before-seen file extension?'
    context: 'This question uses statistical and frequency analysis to spot anomalies. Adversaries may use long command lines to pass obfuscated code or parameters. The use of an uncommon script extension (like .jse or .vbe) can be an attempt to evade simple signature-based detections that only look for common extensions.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Data Historians'
      - 'Process Servers'
      - 'Jump Servers'
      - 'OT DMZ'
    range: 'last 90 days'
    queries:
      - 'CALCULATE cmd_length_baseline(wscript/cscript_logs, host, 90_days); ALERT on new_execution WHERE length > 99th_percentile; CALCULATE script_extension_frequency_map(all_wscript/cscript_logs, 90_days); ALERT on execution of "first_seen" or rare extension;'
  - question: 'Can an unsupervised machine learning model (DBSCAN) identify anomalous Windows Script Host executions that do not cluster with known, normal behaviors?'
    context: 'This question uses density-based clustering to find outliers without pre-existing labels. DBSCAN groups similar execution events (based on features like parent process, arguments, user, time) into clusters of "normal" behavior. Any event that does not fit into a dense cluster is labeled as "noise" and is, by definition, an anomaly worth investigating. This is powerful for detecting novel attack patterns.'
    answer_sources:
      - 'Sysmon Event ID 1'
      - 'Engineering Workstations (EWS)'
      - 'Human-Machine Interfaces (HMIs)'
      - 'Data Historians'
      - 'Process Servers'
      - 'Jump Servers'
      - 'OT DMZ'
    range: 'last 90 days'
    queries:
      - 'CLUSTER wscript/cscript_process_events using DBSCAN_model on features (parent_process, arguments, user, hour); ALERT on events classified as "noise";'