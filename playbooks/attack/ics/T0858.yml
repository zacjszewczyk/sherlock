name: T0858: Change Operating Mode
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook is designed to detect if an adversary is changing Programmable Logic Controller (PLC) operating modes for evasion or execution purposes. It identifies mode changes that occur outside of scheduled maintenance windows, originate from unauthorized source IP addresses, are part of a specific sequence indicating a program download (Mode Change -> Program Download -> Mode Change), or are initiated by an unapproved process on an Engineering Workstation (EWS). The goal is to provide actionable intelligence on unauthorized manipulation of PLC states, which is a critical step in many industrial control system (ICS) attacks.
type: technique
related:
  - TA0103: Evasion
  - TA0104: Execution
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are PLC operating mode changes occurring outside of approved maintenance windows?
    context: This question helps identify unauthorized PLC mode changes by cross-referencing the time of the change with a known maintenance schedule. Any change outside a scheduled window is highly suspicious and could indicate an adversary attempting to manipulate the PLC for malicious purposes, such as preparing to upload new logic or disrupt operations.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Maintenance Schedule Data
      - Network monitoring points (e.g., network taps, SPAN ports) on Level 1 (Control Network) and Level 2 (Supervisory Network) segments, and at the boundary of the Industrial DMZ (IDMZ) to capture all PLC-related traffic.
    range: last 90 days
    queries:
      - query: SEARCH s7comm OR enip FOR mode_change_command; EXTRACT timestamp, src_ip, dest_plc_ip; LOOKUP timestamp, dest_plc_ip IN maintenance_schedule; ALERT IF NOT found;
  - question: Is there an anomalous frequency of PLC operating mode changes from a specific source?
    context: This question aims to detect unusual spikes in mode change activity. Adversaries, especially those using automated scripts, may issue mode change commands more frequently than a human operator. By baselining normal activity and alerting on deviations (e.g., exceeding the 99th percentile), this can catch suspicious behavior even if it occurs within a maintenance window.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Maintenance Schedule Data
      - Network monitoring points (e.g., network taps, SPAN ports) on Level 1 (Control Network) and Level 2 (Supervisory Network) segments, and at the boundary of the Industrial DMZ (IDMZ) to capture all PLC-related traffic.
    range: last 90 days
    queries:
      - query: SEARCH s7comm OR enip FOR mode_change_command; COUNT events BY hour, src_ip, dest_plc_ip; COMPARE current_count to historical_99th_percentile; ALERT IF current_count > threshold;
  - question: Does the pattern of PLC operating mode changes deviate from the historically learned normal behavior?
    context: This question uses a machine learning model to identify subtle or complex anomalies in mode change patterns that simple thresholding might miss. The model considers features like the time of day, source IP subnet, and the specific mode being set, allowing it to detect deviations in the overall cadence and context of changes, which could signify sophisticated adversary activity.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Maintenance Schedule Data
      - Network monitoring points (e.g., network taps, SPAN ports) on Level 1 (Control Network) and Level 2 (Supervisory Network) segments, and at the boundary of the Industrial DMZ (IDMZ) to capture all PLC-related traffic.
    range: last 90 days
    queries:
      - query: INPUT stream of mode_change_events (timestamp, src_subnet, mode_type) INTO anomaly_detection_model; SCORE each event; ALERT IF anomaly_score > threshold;
  - question: Did a PLC operating mode change originate from an IP address not on the authorized Engineering Workstation (EWS) allowlist?
    context: This question verifies if the system initiating a PLC mode change is an approved asset. Since mode changes are privileged operations, they should only originate from a limited set of authorized systems, such as EWS or jump servers. A change from any other source is a strong indicator of a compromised device or an unauthorized lateral movement attempt.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Asset Inventory Data
      - Network segments containing Engineering Workstations (EWS), jump servers, and maintenance access points. Also, Level 1 (Control Network) and Level 2 (Supervisory Network) segments to monitor all communications to PLCs, and industrial firewall logs at the IT/OT boundary.
    range: last 90 days
    queries:
      - query: SEARCH s7comm OR enip FOR mode_change_command; EXTRACT src_ip; LOOKUP src_ip IN authorized_ews_iplist; ALERT IF NOT found;
  - question: Has a PLC operating mode change been initiated by a source IP that has never performed this action before?
    context: This question helps detect potentially unauthorized activity without relying on a static, manually-maintained allowlist. By baselining which source IPs normally perform mode changes, it can flag the first time a new or unusual asset communicates with a PLC in this manner. This is effective for identifying newly compromised devices being used by an adversary.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Asset Inventory Data
      - Network segments containing Engineering Workstations (EWS), jump servers, and maintenance access points. Also, Level 1 (Control Network) and Level 2 (Supervisory Network) segments to monitor all communications to PLCs, and industrial firewall logs at the IT/OT boundary.
    range: last 90 days
    queries:
      - query: SEARCH s7comm OR enip FOR mode_change_command; EXTRACT src_ip; COMPARE src_ip to 30_day_baseline_of_src_ips; ALERT IF src_ip is new;
  - question: Does the network connection associated with a PLC mode change exhibit characteristics of an unauthorized session?
    context: This question employs a machine learning model to analyze the full context of the network connection that delivered the mode change command. By using features like port, protocol, connection duration, and bytes transferred, the model can learn to distinguish between the typical network behavior of legitimate engineering software and anomalous connections, providing a more robust detection method than simple IP allowlisting.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Asset Inventory Data
      - Network segments containing Engineering Workstations (EWS), jump servers, and maintenance access points. Also, Level 1 (Control Network) and Level 2 (Supervisory Network) segments to monitor all communications to PLCs, and industrial firewall logs at the IT/OT boundary.
    range: last 90 days
    queries:
      - query: ON mode_change_event, GATHER associated_connection_features (port, proto, duration, bytes); INPUT features INTO classification_model; SCORE connection; ALERT IF classification is 'unauthorized' AND confidence > 0.9;
  - question: Has a PLC operating mode change occurred as part of a sequence indicative of a program download?
    context: This question looks for a high-confidence attack pattern where an adversary changes the PLC mode to 'PROGRAM', downloads malicious code, and then changes the mode back to 'RUN' to execute it. Correlating these three events in a tight time window provides strong evidence of an unauthorized and potentially malicious program modification.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Network monitoring points on Level 1 (Control Network) segments housing critical PLCs, and Level 2 (Supervisory Network) segments connecting PLCs to SCADA/HMI systems and Engineering Workstations (EWS).
    range: last 90 days
    queries:
      - query: CORRELATE events by src_ip, dest_plc_ip over 15_minutes; TRIGGER on sequence [mode_change_to_program] -> [program_download] -> [mode_change_to_run]; ALERT on successful sequence detection;
  - question: Is the timing between steps in a program download sequence anomalously fast or slow?
    context: This question focuses on the timing (delta) between the events in a program download sequence. Automated adversary scripts often execute these steps much faster than a human operator would. By baselining the normal timing of authorized downloads, this can detect sequences that are statistical outliers and therefore suspicious.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Network monitoring points on Level 1 (Control Network) segments housing critical PLCs, and Level 2 (Supervisory Network) segments connecting PLCs to SCADA/HMI systems and Engineering Workstations (EWS).
    range: last 90 days
    queries:
      - query: ON program_download_sequence, CALCULATE time_delta_1 (mode_change to download) and time_delta_2 (download to run); COMPARE deltas to historical_baseline (median, IQR); ALERT IF delta is statistical outlier;
  - question: Does the sequence of commands leading to a mode change deviate from normal operational patterns?
    context: This question uses a sophisticated model to understand the 'grammar' of ICS command sequences. The model learns which command transitions are common and which are rare. A sequence like [Mode Change] -> [Download] -> [Run] might be normal during maintenance but highly anomalous at other times. The model can flag this sequence as improbable and suspicious based on the broader context of preceding events.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Network monitoring points on Level 1 (Control Network) segments housing critical PLCs, and Level 2 (Supervisory Network) segments connecting PLCs to SCADA/HMI systems and Engineering Workstations (EWS).
    range: last 90 days
    queries:
      - query: INPUT stream of ICS_command_sequences INTO sequence_anomaly_model (HMM/LSTM); CALCULATE likelihood_score for each sequence; ALERT IF score is below anomaly_threshold;
  - question: Was a PLC mode change command preceded by the execution of an unapproved process on an Engineering Workstation?
    context: This question links host-based events on an EWS with network events targeting a PLC. It specifically looks for a chain of evidence where an unauthorized application is launched on an EWS, which then makes a network connection to a PLC and issues a mode change command. A successful correlation of these events across a short time window is a critical finding, strongly suggesting the EWS has been compromised and is being used to attack the control system.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Software Allowlist Data
      - All endpoint devices designated as Engineering Workstations (EWS) and Maintenance Laptops, monitored via host-based agents (EDR/Sysmon). Also, the network segments where these EWS devices reside to capture their outbound traffic to the OT environment.
    range: last 90 days
    queries:
      - query: CORRELATE events by EWS_ip over 60_seconds; TRIGGER on sequence [WinEvent 4688 from unapproved_process] -> [WinEvent 5156 to PLC_ip] -> [Zeek mode_change from EWS_ip to PLC_ip]; ALERT on successful correlation;
  - question: Did an anomalous parent-child process relationship on an EWS initiate a PLC mode change?
    context: This question investigates the process lineage on the EWS that leads to a mode change. Legitimate engineering software has predictable process chains (e.g., 'explorer.exe' launching 'TIA_Portal.exe'). An adversary might use a different process, like 'powershell.exe', to initiate the connection. Detecting a new or rare process chain associated with a PLC mode change can uncover such malicious activity.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Software Allowlist Data
      - All endpoint devices designated as Engineering Workstations (EWS) and Maintenance Laptops, monitored via host-based agents (EDR/Sysmon). Also, the network segments where these EWS devices reside to capture their outbound traffic to the OT environment.
    range: last 90 days
    queries:
      - query: ON PLC_mode_change, GET initiating_process_chain from EWS (parent_process, child_process); COMPARE chain to historical_baseline_of_chains; ALERT IF chain is new or rare;
  - question: Does the combination of host and network behavior associated with a PLC mode change classify as malicious by a machine learning model?
    context: This question uses a holistic machine learning approach, combining features from both the EWS host (process name, command line) and the network (protocol, port, data volume) to make a single, high-confidence judgment. This model can identify complex attack patterns where individual indicators are weak, but their combination strongly points to malicious intent, providing a powerful tool for detecting sophisticated threats.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Software Allowlist Data
      - All endpoint devices designated as Engineering Workstations (EWS) and Maintenance Laptops, monitored via host-based agents (EDR/Sysmon). Also, the network segments where these EWS devices reside to capture their outbound traffic to the OT environment.
    range: last 90 days
    queries:
      - query: ON PLC_mode_change, AGGREGATE host_features (process_name, cmd_line) and network_features (port, proto, bytes); INPUT aggregated_features into classification_model; ALERT IF classification is 'malicious' and confidence is high;