name: T0849: Masquerading
id: 85d1c080-60b2-4d08-981f-7988350d3a77
description: |
  This playbook helps determine if an adversary is attempting to evade detection by masquerading malicious files as legitimate ICS software or processes. Adversaries may rename their tools to match the names of legitimate, commonly used ICS applications (e.g., RSLinx.exe) or core system processes (e.g., svchost.exe) to blend in with normal activity. This playbook looks for evidence of this behavior by identifying processes executing from non-standard locations, files created in critical directories with suspicious naming conventions (like double extensions), and core system processes making unusual outbound network connections.
type: technique
related:
  - TA0103: Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a known ICS process executing from an unapproved or suspicious directory?
    context: |
      Adversaries may place a malicious executable with the same name as a legitimate ICS application (like RSLinx.exe) in a non-standard directory (e.g., C:\Temp, C:\Users\Public) to trick users or systems into running it. This question helps detect this activity by comparing the execution path of a process against a pre-defined whitelist of legitimate, approved paths for that specific application name. A mismatch is a strong indicator of masquerading.
    answer_sources:
      - Windows Event ID 4688
      - Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), ICS Application Servers, Data Historians, Jump Servers within the ICS network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process_creation_events (e.g., Windows Event ID 4688)
          WHERE process_name IN [ics_application_whitelist]
          AND (command_line_path NOT IN [approved_paths_for_that_process] OR command_line_path STARTS WITH [known_suspicious_dirs])
  - question: Has a known ICS process recently executed from a statistically rare location?
    context: |
      This question moves beyond static whitelists to find anomalous execution paths by baselining what is "normal" over a long period. An execution from a path that has rarely or never been seen before for a specific process is a strong indicator of potential masquerading, even if that path is not on a known "bad" list. This helps catch novel attempts that bypass simple list-based detections.
    answer_sources:
      - Windows Event ID 4688
      - Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), ICS Application Servers, Data Historians, Jump Servers within the ICS network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each unique_ics_process_name:
            BUILD historical distribution of its execution paths from the last 90 days.
          FOR each new_process_creation_event:
            COMPARE its execution_path to the historical distribution for that process.
            ALERT if the path's historical frequency is below a set threshold (e.g., 5th percentile).
  - question: Is the execution path of a known ICS process being flagged as an outlier by an anomaly detection model?
    context: |
      This question leverages machine learning for a more sophisticated form of anomaly detection. A model (e.g., Isolation Forest) trained on the features of legitimate process execution paths can identify subtle deviations that might be missed by simple frequency analysis or whitelisting. This approach is effective at finding novel or complex masquerading attempts that don't fit obvious patterns.
    answer_sources:
      - Windows Event ID 4688
      - Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), ICS Application Servers, Data Historians, Jump Servers within the ICS network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN one-class anomaly detection model on historical legitimate ICS process creation events (features from CommandLine path).
          DEPLOY model to score new process creation events in real-time.
          ALERT if an event involving a known ICS application is scored as an 'outlier' or 'anomaly'.
  - question: Has a file with a suspicious name (e.g., double extension, blacklisted extension) been created in a critical ICS directory?
    context: |
      Adversaries often try to hide malicious executables by giving them misleading names, such as 'project.plc.exe' to make the '.exe' part less obvious, or by using script extensions like '.vbs' or '.scr'. This question looks for these specific malicious naming conventions in sensitive directories where project files, PLC programs, and configurations are stored.
    answer_sources:
      - Windows Event ID 4663
      - Engineering Workstations (EWS) local drives, Shared Network Drives (e.g., for project files, backups), ICS Application Servers, Data Historians.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH file_write_events (e.g., Windows Event ID 4663) in [critical_ics_directories]
          WHERE filename MATCHES REGEX for double extensions (e.g., '.*\..{2,5}\..{2,5}$')
          OR file_extension IN [blacklist_of_non-standard_extensions e.g., .bat, .scr, .js].
  - question: Has a file with a statistically rare extension or a high-entropy (random-looking) name been created in a critical ICS directory?
    context: |
      This is a data-driven approach to finding suspicious files. Instead of relying on a predefined blacklist of extensions, it establishes a baseline of what file types are normally seen in a directory. A file with a rare extension (e.g., a '.zip' in a directory that only ever contains '.acd' files) or a filename that appears algorithmically generated (high entropy) is anomalous and warrants investigation.
    answer_sources:
      - Windows Event ID 4663
      - Engineering Workstations (EWS) local drives, Shared Network Drives (e.g., for project files, backups), ICS Application Servers, Data Historians.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each critical_directory:
            PROFILE historical file extension frequency and filename entropy.
          FOR each new_file_creation_event:
            ALERT if file_extension is statistically rare for that directory (e.g., <1% historical occurrence)
            OR if filename entropy score exceeds the 95th percentile of the established baseline.
  - question: Is a machine learning model classifying newly created filenames in critical directories as 'suspicious'?
    context: |
      This question applies supervised machine learning, which is trained on examples of both "good" and "bad" filenames. This allows the model to learn complex patterns associated with malicious naming schemes (e.g., character sequences, length, special characters) beyond what simple rules or statistical analysis can catch, providing a more robust detection capability.
    answer_sources:
      - Windows Event ID 4663
      - Engineering Workstations (EWS) local drives, Shared Network Drives (e.g., for project files, backups), ICS Application Servers, Data Historians.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN supervised classification model (e.g., Random Forest) on features from historical filenames, labeled as 'benign' or 'suspicious'.
          DEPLOY model to classify new filenames created in protected directories.
          ALERT if any filename is classified as 'suspicious'.
  - question: Is a core Windows system process on an ICS asset making a network connection to an unapproved destination or a known malicious IP/domain?
    context: |
      Core system processes like 'svchost.exe' or 'lsass.exe' are common targets for masquerading or process injection. Their network behavior is typically predictable. This question checks if one of these critical processes is communicating with an IP, domain, or port that is not on an established whitelist, or one that appears on a threat intelligence feed, indicating a potential compromise.
    answer_sources:
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek dns.log
      - ICS Network Segments (Control/Process LAN, DMZ), Corporate-to-ICS DMZ, Internet Gateway (for outbound connections from ICS assets), Firewalls logging connection attempts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          JOIN process_network_events (EventID 5156) with network_connection_logs (Zeek conn.log) on source_ip and timestamp.
          WHERE process_name IN [core_system_processes]
          AND (destination_ip/port NOT IN [process_destination_whitelist] OR destination_domain IN [threat_intel_feed]).
  - question: Is a core Windows system process exhibiting anomalous network behavior compared to its historical baseline?
    context: |
      This question moves beyond static whitelists to detect behavioral anomalies. It establishes a baseline of normal network activity for each critical system process on each host (e.g., who it talks to, how much data it sends). A deviation from this baseline, such as connecting to a brand-new IP address for the first time or transferring an unusually large amount of data, is flagged as suspicious.
    answer_sources:
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek dns.log
      - ICS Network Segments (Control/Process LAN, DMZ), Corporate-to-ICS DMZ, Internet Gateway (for outbound connections from ICS assets), Firewalls logging connection attempts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each critical_host and core_system_process:
            ESTABLISH a 30-day rolling baseline of network behavior (unique destination IPs, ports, data volumes).
          FOR each new_connection from a core system process:
            ALERT if destination_IP has never been seen for that process on that host
            OR if a quantitative metric (e.g., data volume) exceeds the 98th percentile of its historical baseline.
  - question: Is a machine learning model flagging network connections from system processes on ICS assets as anomalous?
    context: |
      This is the most advanced question, using an unsupervised ML model (e.g., Autoencoder) to learn the complex relationships between multiple network connection features (process, destination, port, data volume, etc.). It can detect subtle, coordinated anomalies across multiple variables that would be missed by single-metric baselining, indicating a sophisticated adversary that has compromised a system process.
    answer_sources:
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek dns.log
      - ICS Network Segments (Control/Process LAN, DMZ), Corporate-to-ICS DMZ, Internet Gateway (for outbound connections from ICS assets), Firewalls logging connection attempts.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN a multivariate anomaly detection model on a feature set from correlated Windows and Zeek logs (Process Name, Destination IP, Port, Protocol, Bytes Transferred, etc.).
          DEPLOY model to score all new connections from core system processes.
          ALERT if a connection receives a high anomaly score (reconstruction error).