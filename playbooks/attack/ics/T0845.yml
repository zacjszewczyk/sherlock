name: "T0845: Program Upload"
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: "This playbook helps investigate whether an adversary is attempting to upload PLC logic for reconnaissance or analysis. This can be identified by observing anomalously large network sessions on ICS programming ports, the unauthorized or unusual execution of ICS engineering applications on an Engineering Workstation (EWS), or successful EWS logons with anomalous attributes immediately followed by network activity consistent with a program upload."
type: technique
related:
  - "TA0100: Collection"
contributors:
  - "Zachary Szewczyk"
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
investigative_questions:
  - question: "Are program upload commands being sent to unauthorized devices or outside of maintenance windows?"
    context: "Legitimate program uploads are performed by specific Engineering Workstations (EWS) during scheduled maintenance. This question helps identify malicious activity by looking for specific ICS function codes associated with program uploads (e.g., S7comm 'Upload', EtherNet/IP 'Get_Attribute_All') that are directed at a device not on the authorized EWS whitelist or occur outside of a documented maintenance window. Such activity is a strong indicator of an adversary attempting to exfiltrate control logic."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Network taps or SPAN ports on Process Control Network (PCN) switches, specifically monitoring traffic between Purdue Model Level 1 (Control Devices) and Level 2 (Supervisory Control)."
    range: "last 90 days"
    queries:
      - "Search: ICS protocol logs (s7comm, enip). Query: For S7comm 'Upload' (0x1A) or EtherNet/IP 'Get_Attribute_All' (0x01) function codes, correlate the destination IP against an EWS whitelist. Alert if the destination is not in the whitelist or if the activity occurs outside a documented maintenance window."
  - question: "Has there been an unusually large data transfer from a PLC to a client, suggesting a program upload?"
    context: "A full program upload involves transferring a large amount of data from a PLC, which is significantly more than typical operational communications. This question focuses on establishing a baseline of normal data transfer volume ('resp_bytes' from the PLC) and then detecting statistical outliers. An alert on a transfer that exceeds the 99th percentile or is more than three standard deviations from the mean can effectively identify a potential program exfiltration event."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Network taps or SPAN ports on Process Control Network (PCN) switches, specifically monitoring traffic between Purdue Model Level 1 (Control Devices) and Level 2 (Supervisory Control)."
    range: "last 90 days"
    queries:
      - "Search: Network flow logs (Zeek conn.log). Query: For each PLC-to-client pair on an ICS port, calculate a 30-day rolling baseline (mean, std dev) of 'resp_bytes' in 5-minute intervals. Alert if any interval exceeds the 99th percentile or is 3+ standard deviations above the mean."
  - question: "Is there a significant deviation from a PLC's normal communication patterns that could indicate a program upload?"
    context: "Beyond just data volume, a program upload can alter multiple aspects of a PLC's network behavior, including connection counts and bytes sent/received. This question involves using an unsupervised machine learning model (like an autoencoder) to learn the complete, multi-faceted communication pattern of each PLC. The model can then detect any significant deviation from this learned norm, providing a more sensitive and robust method for identifying anomalous activities like a program upload."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Network taps or SPAN ports on Process Control Network (PCN) switches, specifically monitoring traffic between Purdue Model Level 1 (Control Devices) and Level 2 (Supervisory Control)."
    range: "last 90 days"
    queries:
      - "Search: Network flow logs (Zeek conn.log). Query: Apply a trained time-series anomaly detection model to aggregated features (e.g., resp_bytes, orig_bytes, connection count) for each PLC. Alert when the model's anomaly score or reconstruction error exceeds a dynamically tuned threshold."
  - question: "Is an ICS engineering application being executed by an unauthorized parent process?"
    context: "Legitimate ICS software is typically launched by a user from the desktop environment (parent process 'explorer.exe'). Adversaries often use scripts or command shells (e.g., 'powershell.exe', 'cmd.exe') to automate their actions. This question aims to detect this tradecraft by querying for process creation events where known engineering software is spawned by an unapproved parent process, which is a strong indicator of malicious use of a legitimate tool."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Endpoint Detection and Response (EDR) agents or host-based logging on Engineering Workstations (EWS) and Human-Machine Interfaces (HMIs) located at Purdue Model Level 2."
    range: "last 90 days"
    queries:
      - "Search: Process creation logs (Windows Event ID 4688). Query: For process names matching ICS engineering software, alert if the 'ParentProcessName' is not on an approved list (e.g., not 'explorer.exe')."
  - question: "Is an ICS engineering application being launched with unusually complex or random command-line arguments?"
    context: "Adversaries using scripts or obfuscation techniques often generate long and complex command-line arguments that differ from simple, user-driven executions. This question involves calculating the Shannon entropy of the command line for each engineering software execution to measure its complexity. An execution with an entropy score that is a statistical outlier (e.g., 98th percentile) compared to its historical baseline suggests potential scripting or obfuscation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Endpoint Detection and Response (EDR) agents or host-based logging on Engineering Workstations (EWS) and Human-Machine Interfaces (HMIs) located at Purdue Model Level 2."
    range: "last 90 days"
    queries:
      - "Search: Process creation logs (Windows Event ID 4688). Query: For each ICS engineering application execution, calculate the Shannon entropy of its 'CommandLine' argument. Alert if the entropy score exceeds the 98th percentile of its 30-day baseline."
  - question: "Does the execution of an ICS engineering application match the profile of known anomalous or malicious activity?"
    context: "To move beyond simple rules, a supervised machine learning model can be trained on labeled historical data to distinguish between legitimate and anomalous process executions. This question leverages a model that considers multiple features (process name, parent, command-line entropy, user) to classify new events in real-time. An alert on a process classified as 'Anomalous-Execution' provides a high-fidelity signal of potential malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Endpoint Detection and Response (EDR) agents or host-based logging on Engineering Workstations (EWS) and Human-Machine Interfaces (HMIs) located at Purdue Model Level 2."
    range: "last 90 days"
    queries:
      - "Search: Process creation logs (Windows Event ID 4688). Query: Input features (ProcessName, ParentProcessName, CommandLine entropy, user account) into a trained classification model. Alert if the model's prediction is 'Anomalous-Execution'."
  - question: "Did a remote logon from an untrusted location to an EWS immediately precede a connection to a PLC?"
    context: "A common adversary tactic is to gain remote access to a trusted system like an EWS and then pivot to the operational technology network. This question looks for this specific chain of events: a successful remote logon (Logon Type 10) to an EWS from an IP address not on a management whitelist, followed within a short time window (e.g., 10 minutes) by a network connection from that EWS to a PLC on a known ICS port. Correlating these events provides a strong indication of a potential intrusion."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Active Directory domain controllers, EDR agents on Engineering Workstations (EWS), and network sensors monitoring traffic between the EWS and PLCs."
    range: "last 90 days"
    queries:
      - "Search: Authentication logs (Windows Event ID 4624) and network logs (Zeek). Query: Trigger on a successful logon (Type 10) to an EWS from a non-whitelisted source IP. If found, search for a connection from the EWS to a PLC on an ICS port within the next 10 minutes. Alert if a match is found."
  - question: "Has a user logon to an EWS occurred with multiple anomalous characteristics?"
    context: "While a single anomalous attribute may be benign, a combination of unusual factors during a logon event is highly suspicious. This question involves creating a statistical baseline for each user's typical logon behavior on an EWS (e.g., hours, source subnets, logon types). By assigning risk points for each deviation from this baseline in a new logon, a cumulative risk score can be calculated. A session exceeding a predefined risk threshold indicates a multi-faceted anomaly that warrants investigation."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Active Directory domain controllers, EDR agents on Engineering Workstations (EWS), and network sensors monitoring traffic between the EWS and PLCs."
    range: "last 90 days"
    queries:
      - "Search: Authentication logs (Windows Event ID 4624). Query: For each EWS logon, compare logon hour, source subnet, and logon type against the user's 30-day baseline. Assign risk points for each deviation. Alert if the session's total risk score exceeds a set threshold (e.g., 3)."
  - question: "Does a user's session, including logon and subsequent network activity, significantly deviate from their established normal behavior?"
    context: "User and Entity Behavior Analytics (UEBA) provides a holistic approach by modeling a user's entire session, from logon attributes to subsequent network actions. This question uses an unsupervised model (like an Isolation Forest) trained on features from both authentication and network logs. The model assigns an anomaly score to each session, allowing it to detect complex, multi-stage deviations from a user's established norm. Flagging sessions with the highest anomaly scores helps focus analyst attention on the most suspicious activities."
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Active Directory domain controllers, EDR agents on Engineering Workstations (EWS), and network sensors monitoring traffic between the EWS and PLCs."
    range: "last 90 days"
    queries:
      - "Search: Authentication (Windows Event ID 4624) and network (Zeek) logs. Query: Feed session features (user, source IP, time, logon type, destination IP/port, bytes) into a trained UEBA model. Alert if a session's anomaly score is in the top 1% of historical scores."