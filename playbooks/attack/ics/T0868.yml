name: "T0868: Detect Operating Mode"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: |
  This playbook helps answer the information requirement: "Is an adversary attempting to determine the operating state of our PLCs?". It focuses on detecting when an adversary queries an ICS device for its operating mode (e.g., Run, Program, Remote). Such queries can originate from unauthorized IP addresses or from authorized, but potentially compromised, Engineering Workstations (EWS) exhibiting anomalous scanning behavior. The playbook also correlates these network events with host-based evidence, such as suspicious remote logons to an EWS or the execution of reconnaissance tools, to provide high-fidelity alerts.
type: "technique"
related:
  - "TA0100: Collection"
contributors: "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags:
  - "none"
questions:
  - question: "Is an unauthorized asset querying the operating mode of PLCs and executing suspicious processes?"
    context: |
      An adversary might use a non-standard or compromised machine, not on the authorized asset list, to probe the state of PLCs. This question aims to detect such queries from IPs not on the authorized Engineering Workstation (EWS) list and then check the source machine for related suspicious process executions (like scanning tools) within a short time frame to confirm malicious intent.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Zeek dnp3.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Network sensors (TAPs/SPANs) at the IT/OT boundary, within the Process Control Network (PCN), and in Cell/Area zones. Log aggregators for Engineering Workstations (EWS), SCADA servers, and data historians."
    range: "last 90 days"
    queries:
      - technology: "SIEM / Log Analytics"
        query: |
          SEARCH Zeek ICS logs (modbus, s7comm, enip) for operating mode queries
          WHERE source_ip NOT IN authorized_ews_watchlist
          JOIN with Windows Event ID 4688 logs ON source_ip
          WHERE event_time is within 15 minutes of query_time
          AND process_name IN (plcscan.py, nmap.exe)
  - question: "Is a known, authorized Engineering Workstation exhibiting anomalous PLC operating mode scanning behavior?"
    context: |
      Even authorized workstations can be compromised. This question focuses on detecting when a legitimate EWS starts scanning an unusually high number of distinct PLCs for their operating status within a short window. This behavior deviates from normal operational patterns and could indicate that an attacker has gained control of the EWS and is performing network-wide reconnaissance.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Zeek dnp3.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Network sensors (TAPs/SPANs) at the IT/OT boundary, within the Process Control Network (PCN), and in Cell/Area zones. Log aggregators for Engineering Workstations (EWS), SCADA servers, and data historians."
    range: "last 90 days"
    queries:
      - technology: "SIEM / Analytics Platform"
        query: |
          FOR each authorized_source_ip in Zeek ICS logs:
          CALCULATE 30-day rolling baseline of distinct_destination_plc_count per 5-minute window.
          ALERT if current_5_min_count > 99th_percentile_of_baseline.
  - question: "Are there statistically significant deviations from normal operating mode query patterns between specific source-destination pairs?"
    context: |
      This question uses advanced machine learning to establish a highly detailed baseline of normal communication between specific assets. It aims to detect subtle anomalies in the frequency, timing, and sequence of operating mode queries that might be missed by simple thresholding rules, indicating a more sophisticated or stealthy adversary attempting to blend in.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Zeek dnp3.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Network sensors (TAPs/SPANs) at the IT/OT boundary, within the Process Control Network (PCN), and in Cell/Area zones. Log aggregators for Engineering Workstations (EWS), SCADA servers, and data historians."
    range: "last 90 days"
    queries:
      - technology: "Machine Learning / Anomaly Detection Platform"
        query: |
          INPUT: Historical Zeek ICS log data (90+ days) for operating mode queries.
          MODEL: Train time-series anomaly detection model (e.g., ARIMA, LSTM) on frequency/timing for each source-destination pair.
          APPLY model to real-time data.
          ALERT on statistically significant deviations.
  - question: "Did a remote logon from an untrusted location to an EWS precede PLC operating mode queries from that same EWS?"
    context: |
      This question tries to link a potentially risky remote access event to subsequent reconnaissance activity in the OT network. A logon from an unapproved IP or geographic location is suspicious on its own; if it is followed within 30 minutes by PLC scanning from that same EWS, it strongly suggests a compromised EWS is being used for malicious purposes.
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek rdp.log"
      - "Zeek modbus.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Windows Event ID 4688"
      - "Log sources on Engineering Workstation (EWS) endpoints, Active Directory Domain Controllers, and remote access infrastructure (VPN concentrators, jump boxes). Network traffic sensors at the IT/OT boundary and monitoring EWS subnets."
    range: "last 90 days"
    queries:
      - technology: "SIEM / Log Analytics"
        query: |
          SEARCH Windows Event ID 4624 (Logon Type 10)
          WHERE source_ip NOT IN trusted_geo_or_ip_list
          JOIN with Zeek ICS logs ON ews_ip
          WHERE ics_query_time is within 30 minutes of logon_time.
  - question: "Did an anomalous remote logon to an EWS, based on user behavior, precede PLC operating mode queries?"
    context: |
      This question moves beyond simple IP blocklists to behavioral analysis. It aims to identify remote logons that are unusual for a specific user (e.g., wrong time of day, new ISP, rare geolocation). Correlating this behavioral anomaly with subsequent PLC scanning provides a high-fidelity indicator of a compromised user account being used to access and reconnoiter the OT network.
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek rdp.log"
      - "Zeek modbus.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Windows Event ID 4688"
      - "Log sources on Engineering Workstation (EWS) endpoints, Active Directory Domain Controllers, and remote access infrastructure (VPN concentrators, jump boxes). Network traffic sensors at the IT/OT boundary and monitoring EWS subnets."
    range: "last 90 days"
    queries:
      - technology: "UEBA / SIEM"
        query: |
          FOR each remote logon (Event 4624, Type 10):
          CALCULATE anomaly score based on user's historical attributes (time, ISP, country).
          IF score > 95th_percentile:
          JOIN with Zeek ICS logs ON ews_ip WHERE ics_query_time is within 30 minutes of logon_time.
          ESCALATE alert.
  - question: "Did a remote logon event classified as an outlier by a clustering model precede PLC operating mode queries?"
    context: |
      This question applies unsupervised machine learning to find remote logons that do not fit any established pattern of behavior across the entire user base. These "outlier" or "noise" logons are highly suspicious. Linking them to subsequent PLC scanning activity within a short timeframe provides a powerful method for detecting novel or sophisticated intrusion attempts that might evade other detection methods.
    answer_sources:
      - "Windows Event ID 4624"
      - "Zeek conn.log"
      - "Zeek rdp.log"
      - "Zeek modbus.log"
      - "Zeek s7comm.log"
      - "Zeek enip.log"
      - "Windows Event ID 4688"
      - "Log sources on Engineering Workstation (EWS) endpoints, Active Directory Domain Controllers, and remote access infrastructure (VPN concentrators, jump boxes). Network traffic sensors at the IT/OT boundary and monitoring EWS subnets."
    range: "last 90 days"
    queries:
      - technology: "UEBA / Machine Learning Platform"
        query: |
          INPUT: EWS remote logon data (Event 4624, Zeek rdp.log).
          MODEL: Train clustering model (e.g., DBSCAN) on logon features (source IP, user, duration).
          IDENTIFY outlier/noise logons.
          IF logon is an outlier:
          JOIN with Zeek ICS logs ON ews_ip WHERE ics_query_time is within 30 minutes of logon_time.
          CREATE high-severity alert.