name: "T0835: Manipulate I-O Image"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: |
  This playbook helps investigate whether an adversary is manipulating the I/O image of a PLC to inhibit its response function. This involves looking for unauthorized or anomalous Modbus commands that force coils or preset registers. Indicators include 'Force Single Coil' (Function Code 5), 'Force Multiple Coils' (Function Code 15), 'Preset Single Register' (Function Code 6), or 'Preset Multiple Registers' (Function Code 16) commands originating from unauthorized sources, unapproved processes, or occurring outside of normal operational windows. It also covers checks for register values written outside of pre-defined safe operational ranges.
type: "technique"
related:
  - "TA0107: Inhibit Response Function"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Have any Modbus 'Force Coil' commands (Function Code 5 or 15) been issued from an unauthorized source, by an unapproved process, or outside of a maintenance window?"
    context: |
      This question seeks to identify overtly unauthorized or suspicious Modbus 'Force Coil' commands. These commands can directly manipulate the binary state of outputs on a PLC. Detecting them from non-allowlisted IPs, unauthorized software, or outside planned operational windows is a strong indicator of malicious intent, as it suggests an adversary is attempting to alter the physical process without authorization.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Industrial Demilitarized Zone (IDMZ) network segments"
      - "Control Network segments (Level 3.5 and 3 of Purdue Model)"
      - "Process Control Network (PCN) segments (Level 2 of Purdue Model)"
      - "Engineering Workstation (EWS) endpoints"
      - "PLC network interfaces"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH Zeek modbus.log WHERE function_code IN [5, 15]
          IF source_ip NOT IN ews_allowlist THEN ALERT
          ELSE
            SEARCH Windows Event ID 4688 WHERE source_ip AND timestamp
            IF process_name NOT IN process_allowlist THEN ALERT
          END
          IF command_timestamp NOT IN maintenance_window THEN ALERT
  - question: "Has there been an anomalous frequency or volume of Modbus 'Force Coil' commands (Function Code 5 or 15) between any source IP and target PLC?"
    context: |
      This question aims to detect volumetric anomalies in 'Force Coil' commands. Even if the source is authorized, a sudden spike in the frequency of these commands can indicate a malfunction, a misconfiguration, or a malicious script attempting to disrupt a process through rapid state changes. Comparing current activity against a historical baseline helps identify statistically significant deviations from normal behavior.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Industrial Demilitarized Zone (IDMZ) network segments"
      - "Control Network segments (Level 3.5 and 3 of Purdue Model)"
      - "Process Control Network (PCN) segments (Level 2 of Purdue Model)"
      - "Engineering Workstation (EWS) endpoints"
      - "PLC network interfaces"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR EACH source_ip, destination_ip:
            BASELINE = Calculate 99th percentile of hourly count(FC 5, 15) over last 30 days
            CURRENT_COUNT = Hourly count(FC 5, 15) for current hour
            IF CURRENT_COUNT > BASELINE THEN ALERT
  - question: "Do any Modbus 'Force Coil' commands (Function Code 5 or 15) exhibit characteristics that a machine learning model classifies as malicious with high confidence?"
    context: |
      This question leverages a machine learning model to identify complex patterns indicative of malicious activity that might be missed by simple rule-based or statistical methods. By analyzing a combination of features like source, destination, timing, and originating process, the model can learn the subtle nuances of normal vs. malicious 'Force Coil' commands and flag suspicious events with a high degree of confidence.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Industrial Demilitarized Zone (IDMZ) network segments"
      - "Control Network segments (Level 3.5 and 3 of Purdue Model)"
      - "Process Control Network (PCN) segments (Level 2 of Purdue Model)"
      - "Engineering Workstation (EWS) endpoints"
      - "PLC network interfaces"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR EACH Modbus command (FC 5, 15):
            EXTRACT features (source_ip, dest_ip, coil_addr, time, process_name)
            PREDICTION = ML_Model.predict(features)
            PROBABILITY = ML_Model.predict_proba(features)
            IF PREDICTION == 'malicious' AND PROBABILITY > 0.9 THEN ALERT
  - question: "Have any Modbus 'Preset Register' commands (Function Code 6 or 16) been issued from an unauthorized source, by an unapproved process, or with a value outside of its safe operational range?"
    context: |
      This question focuses on detecting unauthorized or unsafe attempts to write values to PLC registers. 'Preset Register' commands can alter critical process parameters like setpoints, timers, or counters. An unauthorized source, unapproved software, or an unsafe value being written to a critical register are strong indicators of an attempt to sabotage or disrupt the controlled process.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Process Control Network (PCN) segments (Level 2 of Purdue Model)"
      - "critical PLC backplanes"
      - "Engineering Workstation (EWS) endpoints"
      - "PLC network interfaces"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH Zeek modbus.log WHERE function_code IN [6, 16]
          IF source_ip NOT IN ews_allowlist THEN ALERT
          ELSE
            SEARCH Windows Event ID 4688 WHERE source_ip AND timestamp
            IF process_name NOT IN process_allowlist THEN ALERT
          END
          IF register_address IN critical_registers AND register_value NOT IN safe_range THEN ALERT
  - question: "Has any critical PLC register been written with a value that is a statistically significant deviation from its historical norm?"
    context: |
      This question aims to detect anomalous register values that may still be within a theoretical safe range but are highly unusual for normal operations. By calculating the historical mean and standard deviation for a register's value, we can identify writes that are statistically improbable (e.g., more than 3 standard deviations away). Such an event could signal an adversary's attempt to subtly manipulate a process or a precursor to a more significant attack.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Process Control Network (PCN) segments (Level 2 of Purdue Model)"
      - "critical PLC backplanes"
      - "Engineering Workstation (EWS) endpoints"
      - "PLC network interfaces"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR EACH critical_register:
            MEAN, STD_DEV = Calculate mean and std deviation of value over last 30 days
          FOR EACH new write command (FC 6, 16) to critical_register:
            IF new_value > (MEAN + 3 * STD_DEV) OR new_value < (MEAN - 3 * STD_DEV) THEN ALERT
  - question: "Do any Modbus 'Preset Register' commands (Function Code 6 or 16) exhibit characteristics that an unsupervised anomaly detection model flags as highly unusual?"
    context: |
      This question employs unsupervised machine learning to find novel or complex anomalies in 'Preset Register' commands. Unlike supervised models, an Isolation Forest or similar model does not require pre-labeled malicious data. It identifies outliers based on how different they are from the established baseline of normal activity across multiple features. This is effective for catching previously unseen attack patterns or sophisticated manipulations that evade simpler detection logic.
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Process Control Network (PCN) segments (Level 2 of Purdue Model)"
      - "critical PLC backplanes"
      - "Engineering Workstation (EWS) endpoints"
      - "PLC network interfaces"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR EACH Modbus write command (FC 6, 16):
            EXTRACT features (source_ip, dest_ip, register_addr, register_val, time)
            ANOMALY_SCORE = Unsupervised_Model.score(features)
            IF ANOMALY_SCORE > 95th_percentile_threshold THEN ALERT