name: 'T0871: Execution through API'
id: 'a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d'
description: "This playbook is designed to detect adversarial execution through native Industrial Control System (ICS) Application Programming Interfaces (APIs). It focuses on identifying unauthorized or anomalous interactions with control system devices like PLCs, RTUs, and IEDs. The playbook addresses three primary indicators: 1) Network connections to ICS devices from unauthorized source IP addresses, which violate established allowlists. 2) The use of high-risk or write-capable ICS function codes (e.g., PLC Stop, Program Download) outside of authorized contexts or maintenance windows. 3) Anomalous communication patterns (e.g., unusual volume, timing, or sequencing of commands) between even authorized source-destination pairs, which may indicate a compromised host is being used for malicious execution."
type: 'technique'
related:
  - 'TA0104: Execution'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: "Has a network connection to a control device originated from an IP address not on the authorized allowlist, and if so, what process on the source host initiated it?"
    context: "This question aims to detect unauthorized communication attempts to critical control system devices. By maintaining a strict allowlist of authorized hosts (like Engineering Workstations) for each device and port, any deviation can indicate a misconfiguration, an unauthorized device, or a compromised host attempting to interact with the control system. Correlating network alerts with host-level process creation and network connection events helps pinpoint the exact software or script responsible for the unauthorized connection, providing crucial context for incident response."
    answer_sources:
      - "Zeek conn.log"
      - "Windows Event ID 5156"
      - "Windows Event ID 4688"
      - "Network ingress/egress points between the Enterprise Network (Level 4/5) and Process Control Network (Level 3), and network segments within the PCN containing Engineering Workstations (EWs), Human-Machine Interfaces (HMIs), and critical control devices (PLCs, RTUs)."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "SEARCH Zeek conn.log WHERE destination IP and port are for a critical device AND source IP is NOT in the allowlist for that device/port. CORRELATE the source IP and timestamp with host logs (Windows Event IDs 5156, 4688) to find the originating process."
  - question: "Is there an anomalous spike in the number of unique source IPs attempting to connect to a control device, potentially indicating a network scan?"
    context: "This question focuses on detecting reconnaissance or widespread access attempts against control devices. A sudden increase in the number of unique systems trying to communicate with a single PLC or RTU is highly abnormal in a stable ICS environment. It often signifies a network scanning activity where an adversary is probing for accessible devices. By baselining normal activity and alerting on statistical deviations, we can catch these early-stage reconnaissance activities before an exploit is attempted."
    answer_sources:
      - "Zeek conn.log"
      - "Network ingress/egress points between the Enterprise Network (Level 4/5) and Process Control Network (Level 3), and network segments within the PCN containing Engineering Workstations (EWs), Human-Machine Interfaces (HMIs), and critical control devices (PLCs, RTUs)."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "FROM Zeek conn.log, COUNT unique source IPs per hour for each destination control device. COMPARE the hourly count against a 30-day rolling baseline for that device. ALERT if the count exceeds the 99th percentile of the baseline."
  - question: "Are there any network connections to control devices that are statistically anomalous based on their combined characteristics (e.g., duration, bytes transferred, protocol)?"
    context: "This question uses a machine learning approach to find unusual connections that might not be caught by simple rules. An Isolation Forest model can identify outliers across multiple dimensions simultaneously. For example, a connection that uses a valid protocol but has an unusually long duration and transfers an uncharacteristically small amount of data might be flagged. This helps detect novel or subtle attack techniques that don't fit pre-defined patterns but deviate from established communication norms."
    answer_sources:
      - "Zeek conn.log"
      - "Network ingress/egress points between the Enterprise Network (Level 4/5) and Process Control Network (Level 3), and network segments within the PCN containing Engineering Workstations (EWs), Human-Machine Interfaces (HMIs), and critical control devices (PLCs, RTUs)."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "APPLY a trained Isolation Forest model to live Zeek conn.log data. The model should use features like source/destination IP, destination port, protocol, duration, and bytes transferred. FLAG any connection the model identifies as an anomaly for analyst review."
  - question: "Has a high-risk or write-capable ICS command, such as 'PLC Stop' or 'Program Download', been sent over the network?"
    context: "This question directly targets the most impactful and potentially destructive commands within ICS protocols. Unauthorized or unexpected use of function codes that can alter a device's state, logic, or operation (e.g., stopping a PLC, overwriting its program) is a critical indicator of an attack. Alerting on these specific commands, especially when cross-referenced with maintenance schedules to filter out legitimate activity, provides a high-fidelity signal of malicious execution."
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek s7comm.log"
      - "Network taps or SPAN ports deployed at critical choke points within the Process Control Network (Level 2), such as in front of safety PLCs, between HMI/EWS and control devices, and on links to Historian servers."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "SEARCH ICS protocol logs (Modbus, DNP3, S7comm) for the usage of pre-defined critical function codes (e.g., Modbus FC 5, 16; S7comm 'Stop'). GENERATE a high-severity alert, enriching it with asset data and checking against a maintenance calendar."
  - question: "Is the pattern or frequency of ICS function codes used between two devices statistically unusual, suggesting an automated attack or deviation from normal operations?"
    context: "This question looks for subtle changes in command usage that might indicate compromise. A drop in entropy (less variety in commands) can signal a repetitive, scripted attack, while a Z-score spike (a specific command used far more than usual) can indicate an adversary repeatedly attempting a specific malicious action. This method can detect attacks even when the commands themselves are technically valid, but their pattern of use is abnormal."
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek s7comm.log"
      - "Network taps or SPAN ports deployed at critical choke points within the Process Control Network (Level 2), such as in front of safety PLCs, between HMI/EWS and control devices, and on links to Historian servers."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "FOR each source-destination asset pair, calculate the Shannon entropy of function codes in a 10-minute window. Also, calculate the Z-score for the frequency of high-risk function codes. ALERT if entropy drops below the 5th percentile of a 60-day baseline OR if the Z-score exceeds 3.0."
  - question: "Does the sequence of ICS commands observed between devices follow a logical and expected operational workflow, or does it represent an improbable sequence indicative of malicious activity?"
    context: "This question uses a more advanced stateful model to understand the *logic* of an industrial process. A Hidden Markov Model (HMM) learns the normal sequence of operations (e.g., a 'startup' sequence involves command A, then B, then C). If it observes a sequence that has a very low probability of occurring under this learned model (e.g., a 'write' command in the middle of an 'idle' state), it signals a significant deviation from normal process control that could be malicious."
    answer_sources:
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek s7comm.log"
      - "Network taps or SPAN ports deployed at critical choke points within the Process Control Network (Level 2), such as in front of safety PLCs, between HMI/EWS and control devices, and on links to Historian servers."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "FEED observed sequences of ICS function codes into a trained Hidden Markov Model (HMM) specific to that industrial process. ALERT if the model calculates a very low probability for an observed sequence, indicating a deviation from the learned normal states."
  - question: "Has a sequence of commands that violates established safe operational procedures, such as a 'PLC Stop' followed by a 'Program Download' from an unauthorized source, been observed?"
    context: "This question leverages expert human knowledge to define explicitly forbidden or dangerous command sequences. These 'anti-patterns' represent combinations of actions that should never occur during normal operations and are almost certainly malicious or indicative of a severe malfunction. This is a rule-based approach that provides very high-fidelity alerts for known-bad scenarios."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek s7comm.log"
      - "Network segments within the Process Control Network (Level 2) that connect authorized Engineering Workstations (EWs) and Human-Machine Interfaces (HMIs) to their respective control devices (PLCs, RTUs)."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "DEFINE and search for specific 'anti-pattern' command sequences within a short time window (e.g., a 'PLC Stop' command immediately followed by a 'Program Download' from a non-EWS source). ALERT if a forbidden sequence is detected."
  - question: "Is an authorized host sending commands to a control device at a rate significantly faster than a human operator, suggesting the use of an automated script?"
    context: "This question aims to detect when a legitimate, authorized host (like an HMI) might be compromised and used to issue commands. Human operators have physical and cognitive limits on how fast they can interact with a system. By baselining the normal time between commands (inter-arrival time) and alerting on a significant speed-up, we can detect the presence of malicious automation on a compromised but otherwise authorized host."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek s7comm.log"
      - "Network segments within the Process Control Network (Level 2) that connect authorized Engineering Workstations (EWs) and Human-Machine Interfaces (HMIs) to their respective control devices (PLCs, RTUs)."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "FOR each authorized source-destination pair, calculate the mean inter-arrival time of requests in a 5-minute window. COMPARE this value to a historical baseline. ALERT if the mean inter-arrival time drops below the 1st percentile of the baseline."
  - question: "Does the time-series 'rhythm' of communication volume and command frequency between an authorized host and a control device deviate from its normal, learned pattern?"
    context: "This question employs a sophisticated deep learning model (LSTM autoencoder) to learn the complex, time-dependent patterns of normal communication. When live traffic no longer matches this learned normal rhythm, the model fails to 'reconstruct' it accurately, resulting in a high reconstruction error. This signals a subtle but significant deviation from normalcy, potentially indicating a compromised host is being used for malicious purposes."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek s7comm.log"
      - "Network segments within the Process Control Network (Level 2) that connect authorized Engineering Workstations (EWs) and Human-Machine Interfaces (HMIs) to their respective control devices (PLCs, RTUs)."
    range: "last 90 days"
    queries:
      - technology: 'Pseudocode'
        query: "PROCESS time-series data (e.g., bytes/sec, commands/sec) from logs through a trained LSTM autoencoder model for each authorized communication pair. ALERT if the model's reconstruction error for the live traffic exceeds a learned threshold."