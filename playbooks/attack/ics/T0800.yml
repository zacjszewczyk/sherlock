name: "T0800: Activate Firmware Update Mode"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps investigate if an adversary is attempting to inhibit or disable safety and protection functions by manipulating a device's operational mode, specifically by activating its firmware update mode. This can be observed through several indicators: 1) The execution of a firmware update utility on an Engineering Workstation (EWS) that correlates with a large file transfer or a sudden loss of communication from an ICS device. 2) The use of specific, low-prevalence ICS protocol commands designed to alter a device's state, followed by anomalous network behavior. 3) A scenario where a critical ICS device stops responding to application-layer status queries but remains responsive to basic network pings (ICMP), suggesting its primary functions are inhibited while it remains online."
type: "technique"
related: "TA0107: Inhibit Response Function"
contributors: "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is a firmware update utility being executed on an engineering workstation followed by a large file transfer or communication loss to a critical ICS asset?"
    context: "This question seeks to identify a direct attempt to update or alter a device's firmware. An adversary may use legitimate vendor utilities or scripting engines on an EWS to initiate a firmware update. This action is highly suspicious if it is correlated with either a large file transfer (indicative of a firmware image being sent) or a sudden stop in the device's normal communications, and occurs outside a planned maintenance window."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "Zeek ftp.log"
      - "Zeek http.log"
      - "Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), and Jump Servers within the Process Control and Supervisory network segments (Purdue Level 2/3), and network TAPs monitoring traffic to and from these assets."
    range: "last 90 days"
    queries:
      - "SIEM: SEARCH host_events (EventID=4688) on EWS hosts where process_name is a known utility (e.g., UnityPro.exe, powershell.exe) AND command_line contains keywords ('firmware', 'flash'). CORRELATE within 90s with network_logs where (src_ip=host_ip AND dest_ip=ics_asset AND bytes > 1MB) OR (src_ip=ics_asset AND communication_ceases)."
  - question: "Has a novel command-line argument been used for an engineering tool, followed by a disruption in the target device's heartbeat messages?"
    context: "This question aims to detect anomalous usage of legitimate tools. Adversaries may use standard engineering software in an unusual way to manipulate a device. By baselining normal command-line arguments, we can flag new or rare combinations. Correlating this host-based anomaly with a subsequent loss of periodic heartbeat messages from the target device strengthens the suspicion that the command was malicious and successfully altered the device's state."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "Zeek ftp.log"
      - "Zeek http.log"
      - "Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), and Jump Servers within the Process Control and Supervisory network segments (Purdue Level 2/3), and network TAPs monitoring traffic to and from these assets."
    range: "last 90 days"
    queries:
      - "Baselining: FOR each EWS process, CALCULATE Jaccard similarity of new command-line arguments against 30-day baseline. IF similarity < 0.2, CHECK network logs for target device heartbeat inter-arrival time > 99.9th percentile within 5 minutes."
  - question: "Can a machine learning model detect a suspicious process execution that correlates with anomalous network behavior from the target device?"
    context: "This question leverages a two-stage machine learning approach for high-fidelity detection. A supervised model first classifies process execution events on EWS as benign or suspicious based on features like command-line entropy and user context. Events classified as 'Suspicious-Update' are then used to trigger a second model (an LSTM autoencoder) that analyzes the target device's network traffic. An alert is raised only if the suspicious process is immediately followed by a statistically significant deviation in the device's network behavior, reducing false positives."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "Zeek ftp.log"
      - "Zeek http.log"
      - "Engineering Workstations (EWS), Human-Machine Interfaces (HMIs), and Jump Servers within the Process Control and Supervisory network segments (Purdue Level 2/3), and network TAPs monitoring traffic to and from these assets."
    range: "last 90 days"
    queries:
      - "ML: 1) CLASSIFY host events (EventID=4688) using Random Forest model. 2) IF classification is 'Suspicious-Update', FEED corresponding device network time-series data into LSTM autoencoder. 3) ALERT if LSTM reconstruction error spikes above threshold."
  - question: "Has a state-change ICS protocol command been sent to a critical asset from an unauthorized source or outside a maintenance window?"
    context: "This question focuses on detecting the direct use of specific ICS protocol functions known to alter a device's operational state, such as putting it into a bootloader or restart mode. By monitoring for low-prevalence, high-impact commands (e.g., Modbus Function Code 16, DNP3 Cold Restart) and enriching these events with contextual information (Is the source a known EWS? Is this happening during a maintenance window?), analysts can quickly identify unauthorized and potentially malicious state changes."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek enip.log"
      - "Zeek weird.log"
      - "Network sensor appliances (e.g., Zeek sensors) deployed on SPAN ports or network TAPs at the boundaries between Purdue Levels 1 (Basic Control), 2 (Area Supervisory Control), and 3 (Site Control), with a focus on traffic flows involving critical PLCs, RTUs, and protection relays."
    range: "last 90 days"
    queries:
      - "SIEM: SEARCH ICS protocol logs (zeek_modbus, zeek_dnp3) for state-change function codes targeting critical assets. IF (source_ip is NOT in EWS_allowlist) OR (event_time is NOT in maintenance_window), GENERATE high-priority alert."
  - question: "Following a potential state-change command, has the device's communication profile deviated significantly from its baseline?"
    context: "This question provides a method to confirm the impact of a suspected state-change command. After observing a potentially malicious command, this analytic checks for secondary effects in the device's communication patterns. A significant deviation, such as a shift from read to write commands or a halt in expected polling traffic for over two minutes, provides strong evidence that the device's state was successfully and maliciously altered."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek enip.log"
      - "Zeek weird.log"
      - "Network sensor appliances (e.g., Zeek sensors) deployed on SPAN ports or network TAPs at the boundaries between Purdue Levels 1 (Basic Control), 2 (Area Supervisory Control), and 3 (Site Control), with a focus on traffic flows involving critical PLCs, RTUs, and protection relays."
    range: "last 90 days"
    queries:
      - "Baselining: ON detection of state-change command, ANALYZE target device traffic for next 5 mins. IF (write-to-read_ratio > 99th_percentile_baseline) OR (polling_interval > 99.5th_percentile_baseline for > 120s), ALERT."
  - question: "Does a multivariate anomaly detection model show a significant deviation in a device's overall communication pattern, indicating a potential state change?"
    context: "This question proposes a sophisticated anomaly detection approach that looks at the device's communication holistically. Rather than tracking a single metric, a Variational Autoencoder (VAE) model is trained on a feature set including byte counts, protocol mix, and function code distributions. An alert is triggered when the device's real-time behavior no longer matches the learned 'normal' profile, allowing for the detection of subtle or complex state changes that might be missed by simpler rules."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek modbus.log"
      - "Zeek dnp3.log"
      - "Zeek enip.log"
      - "Zeek weird.log"
      - "Network sensor appliances (e.g., Zeek sensors) deployed on SPAN ports or network TAPs at the boundaries between Purdue Levels 1 (Basic Control), 2 (Area Supervisory Control), and 3 (Site Control), with a focus on traffic flows involving critical PLCs, RTUs, and protection relays."
    range: "last 90 days"
    queries:
      - "ML: AGGREGATE Zeek logs into 1-min feature vectors (byte count, port entropy, function code distribution, etc.) per device. INPUT vector into pre-trained VAE model. IF reconstruction_error > dynamic_threshold (e.g., 99.8th percentile), ALERT."
  - question: "Is a critical ICS asset responding to network pings (ICMP) but not to application-layer queries for an extended period?"
    context: "This question addresses a specific failure state where a device is 'alive' on the network but not performing its control function. This condition is highly indicative of a device stuck in a maintenance or bootloader mode. By creating a SIEM rule that maintains a state table of last seen application responses versus last seen ICMP responses, analysts can detect this 'zombie' state, which is a strong indicator of inhibited response functions."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Zeek modbus.log"
      - "Network TAPs monitoring traffic to and from critical controllers (PLCs, RTUs, IEDs) in Purdue Level 1 and 2, and the central network core where ICMP traffic might be observed."
    range: "last 90 days"
    queries:
      - "SIEM State Table: UPDATE state_table with 'last_app_response' from Modbus logs and 'last_icmp_response' from ICMP logs. TRIGGER alert IF (current_time - last_app_response > 10 minutes) AND (current_time - last_icmp_response < 2 minutes)."
  - question: "Is there an unusually long-lived TCP session to a control port on a critical device with no data being transferred?"
    context: "This question seeks to identify hung processes or devices stuck in a non-operational mode. A legitimate TCP session on a control port (like Modbus port 502) should involve data exchange. If a session remains established for an abnormally long time without any application data being sent, it could mean the device has entered a state (like firmware update mode) where it holds the connection open but is no longer processing control commands."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Zeek modbus.log"
      - "Network TAPs monitoring traffic to and from critical controllers (PLCs, RTUs, IEDs) in Purdue Level 1 and 2, and the central network core where ICMP traffic might be observed."
    range: "last 90 days"
    queries:
      - "Baselining: FOR each critical device/port, baseline normal TCP session duration. SEARCH for active TCP sessions (state=ESTABLISHED) where application byte count is zero. ALERT if session duration exceeds the 98th percentile of the historical baseline."
  - question: "Has a device's application-layer response count dropped to zero when a time-series forecast predicted significant activity?"
    context: "This question uses forecasting to detect unexpected silence. A model like Prophet can learn the daily and weekly patterns of a device's activity, including scheduled downtime. An alert is generated if the device stops responding during a period when it is normally active. Cross-validating this silence with a positive ICMP ping response confirms the device is online but non-functional, providing a high-confidence signal of a potential problem or malicious inhibition."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Zeek modbus.log"
      - "Network TAPs monitoring traffic to and from critical controllers (PLCs, RTUs, IEDs) in Purdue Level 1 and 2, and the central network core where ICMP traffic might be observed."
    range: "last 90 days"
    queries:
      - "Forecasting: FOR each device, use Prophet model to forecast expected application response count in 1-min bins. IF actual response count is zero for several bins where forecast > 0 (outside uncertainty interval), and device still responds to ICMP, ALERT."