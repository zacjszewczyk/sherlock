name: 'T0867: Lateral Tool Transfer'
id: 'f47ac10b-58cc-4372-a567-0e02b2c3d479'
description: |
  This playbook is designed to detect adversary activity involving the transfer of tools or files into an Industrial Control System (ICS) environment, a technique known as Lateral Tool Transfer. The playbook addresses two primary adversary goals: impacting the industrial process through the manipulation of control system operations, and moving laterally by staging unauthorized tools on critical assets. Detections focus on analyzing ICS network protocol commands (e.g., Modbus, DNP3) for unauthorized sources, anomalous frequencies, or unsafe values. It also covers the monitoring of network file transfers (SMB, FTP) and host-based events (Windows Event Logs) for the presence of high-risk files, access to sensitive shares, and the subsequent execution of transferred files on critical assets like HMIs, Engineering Workstations, and Historians.
type: 'technique'
related:
  - 'TA0105: Impact'
  - 'TA0109: Lateral Movement'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags:
  - 'none'
questions:
  - question: 'Are ICS write commands originating from unauthorized source IPs or attempting to set unsafe process values?'
    context: |
      This question helps detect direct manipulation attempts against PLCs and field controllers. Adversaries may try to send malicious commands from a compromised, non-standard device on the network. This query validates that the command originates from an approved HMI or engineering workstation and that the value being written to a process register is within its pre-defined safe operational limits, providing a fundamental defense against process disruption.
    answer_sources:
      - 'Zeek modbus.log'
      - 'Zeek dnp3.log'
      - 'Zeek s7comm.log'
      - 'Network interfaces of PLCs and other field controllers, particularly on segments accessible by engineering workstations and HMIs.'
    range: 'Last 90 days'
    queries:
      - 'SEARCH Zeek ICS logs (modbus, dnp3, s7comm) FOR write_commands WHERE source_ip NOT IN approved_workstation_list OR written_value NOT IN safe_value_range_for_register'
  - question: 'Is there a statistically unusual frequency or value in ICS write commands, even from authorized sources?'
    context: |
      This question addresses the scenario where an adversary has compromised an authorized host, such as an HMI, and is using it to launch an attack. By establishing a baseline of normal command frequency and value distributions for each HMI-PLC pair, this query can detect anomalous behavior that signature-based rules would miss. A sudden spike in write commands or a command with an outlier value could indicate a replay attack or a novel manipulation attempt from a trusted source.
    answer_sources:
      - 'Zeek modbus.log'
      - 'Zeek dnp3.log'
      - 'Zeek s7comm.log'
      - 'Network interfaces of PLCs and other field controllers, particularly on segments accessible by engineering workstations and HMIs.'
    range: 'Last 90 days'
    queries:
      - 'COMPARE current_hourly_write_count_per_host_pair WITH 99th_percentile_baseline. ALERT on exceed. COMPARE written_value with 4_std_dev_from_historical_mean. ALERT on exceed.'
  - question: 'Can machine learning models identify ICS write commands that are characteristic of malicious activity?'
    context: |
      This question explores a proactive, advanced detection method using machine learning. By training a classification model on various contextual features of historical command data (source, destination, function, value, time), it is possible to identify subtle and complex patterns indicative of an attack that evade simple statistical thresholds or whitelists. This helps to flag novel or sophisticated manipulation attempts for analyst review.
    answer_sources:
      - 'Zeek modbus.log'
      - 'Zeek dnp3.log'
      - 'Zeek s7comm.log'
      - 'Network interfaces of PLCs and other field controllers, particularly on segments accessible by engineering workstations and HMIs.'
    range: 'Last 90 days'
    queries:
      - 'APPLY trained_ML_classifier (Random Forest/Gradient Boosting) to new_write_command_features. ALERT if classified as suspicious.'
  - question: 'Are high-risk files or files being transferred to administrative shares on critical ICS assets from unauthorized sources?'
    context: |
      This question focuses on detecting the initial stage of tool transfer. Adversaries often move executables, scripts, or compressed archives to target systems before execution. This query looks for explicit indicators of this activity, such as files with high-risk extensions (.exe, .ps1) or ICS-specific project files (.ACD, .L5K), and monitors for access to administrative shares (e.g., C$) from systems not authorized for such actions. An alert provides a clear signal of potential lateral movement.
    answer_sources:
      - 'Zeek smb_files.log'
      - 'Zeek ftp.log'
      - 'Zeek files.log'
      - 'Zeek conn.log'
      - 'Network traffic sensors deployed at key chokepoints, such as the IT/OT boundary (Purdue Level 3.5), between control and supervisory zones (Purdue Level 2/3), and monitoring traffic to and from critical assets like Engineering Workstations (EWS), Human Machine Interfaces (HMIs), and Historian databases.'
    range: 'Last 90 days'
    queries:
      - 'SEARCH Zeek file logs (smb, ftp) FOR transfers_to_critical_assets WHERE (file_extension IN high_risk_list OR share_path IN admin_share_list) AND source_ip NOT IN approved_admin_list'
  - question: 'Are there statistically unusual file transfers to critical ICS assets, such as abnormally large files, files with randomized names, or transfers from new sources?'
    context: |
      This question uses a behavioral approach to detect tool transfers that may evade signature-based methods. Adversaries may rename tools or use custom packing to avoid detection. By baselining normal file transfer characteristics (size, name complexity/entropy) and communication patterns (source/destination pairs), this query identifies outliers that could represent obfuscated or novel tool transfers.
    answer_sources:
      - 'Zeek smb_files.log'
      - 'Zeek ftp.log'
      - 'Zeek files.log'
      - 'Zeek conn.log'
      - 'Network traffic sensors deployed at key chokepoints, such as the IT/OT boundary (Purdue Level 3.5), between control and supervisory zones (Purdue Level 2/3), and monitoring traffic to and from critical assets like Engineering Workstations (EWS), Human Machine Interfaces (HMIs), and Historian databases.'
    range: 'Last 90 days'
    queries:
      - 'COMPARE new_file_transfer_metrics (size, entropy, src_dst_pair) WITH 30-day_baseline. ALERT if file_size > 98th_percentile OR entropy > 98th_percentile OR src_dst_pair is new'
  - question: 'Can a machine learning model detect anomalous patterns in overall file transfer activity within the ICS network?'
    context: |
      This question leverages advanced analytics to find systemic changes in network behavior related to file movement. Instead of looking at individual files, it analyzes aggregate trends over time. A sudden shift in the types of files being moved, the volume of data transferred, or the source/destination subnets involved can indicate a large-scale lateral movement or data staging operation that might be missed when looking at events in isolation.
    answer_sources:
      - 'Zeek smb_files.log'
      - 'Zeek ftp.log'
      - 'Zeek files.log'
      - 'Zeek conn.log'
      - 'Network traffic sensors deployed at key chokepoints, such as the IT/OT boundary (Purdue Level 3.5), between control and supervisory zones (Purdue Level 2/3), and monitoring traffic to and from critical assets like Engineering Workstations (EWS), Human Machine Interfaces (HMIs), and Historian databases.'
    range: 'Last 90 days'
    queries:
      - 'APPLY trained_ML_anomaly_model (Isolation Forest/VAE) to time-series_file_transfer_features. ALERT on high_anomaly_score'
  - question: 'Is an unauthorized user or system writing files to sensitive network shares on critical ICS hosts?'
    context: |
      This question provides host-based evidence of file transfer, complementing network-based detection. Windows Event ID 5145 gives granular detail about who is accessing what share from where. By filtering for write actions ('WriteData' or 'AppendData') to sensitive locations (like administrative shares or PLC project directories) and checking the source account or IP against a whitelist, analysts can precisely identify unauthorized file placement on critical systems.
    answer_sources:
      - 'Windows Event ID 5145'
      - 'Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians, SCADA servers) where Windows security auditing for detailed file share access is enabled.'
    range: 'Last 90 days'
    queries:
      - 'SEARCH Windows Event Logs FOR EventID=5145 ON critical_hosts WHERE (accesses CONTAINS "WriteData") AND (sharename IS admin_share OR target_path IS sensitive) AND (source_ip OR account_name NOT IN approved_list)'
  - question: 'Is there a statistical anomaly in file write activity on the network shares of critical ICS hosts?'
    context: |
      This question seeks to find deviations from normal user and system behavior on the host itself. Even authorized users can be compromised. By baselining what is normal for each user/system combination (e.g., frequency of writes, types of files written), this method can detect when an account or system starts behaving unusually, such as writing an executable file for the first time or writing files at an abnormally high rate.
    answer_sources:
      - 'Windows Event ID 5145'
      - 'Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians, SCADA servers) where Windows security auditing for detailed file share access is enabled.'
    range: 'Last 90 days'
    queries:
      - 'COMPARE new_write_event (EventID 5145) metrics WITH 30-day_baseline. ALERT if hourly_count > 3_std_dev OR source_entity is new OR file_extension is new for that context'
  - question: 'Can a UEBA model identify anomalous file write access patterns that indicate malicious behavior by a user or entity?'
    context: |
      This question applies sophisticated User and Entity Behavior Analytics (UEBA) to detect compromised accounts or insider threats. A UEBA model can synthesize many features (source IP, account, target path, time of day) to create a rich profile of normal behavior. It can then identify complex deviations that simple rules or statistical thresholds would miss, such as an administrator writing a file to a share they rarely touch, or activity occurring at a strange time of day.
    answer_sources:
      - 'Windows Event ID 5145'
      - 'Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians, SCADA servers) where Windows security auditing for detailed file share access is enabled.'
    range: 'Last 90 days'
    queries:
      - 'APPLY trained_UEBA_model (One-Class SVM/Graph) to new_write_event (EventID 5145) features. ALERT on high_anomaly_score'
  - question: 'Has a file recently written to an ICS host from a network share been immediately executed?'
    context: |
      This is a high-fidelity question that directly links tool transfer to execution, a classic adversary technique. Correlating a file write event (Windows Event ID 5145) with a subsequent process creation event (Event ID 4688) for the same filename provides strong evidence of an adversary running a payload they just transferred. Filtering out legitimate software deployment activity makes this a very powerful alert for remote execution.
    answer_sources:
      - 'Windows Event ID 5145'
      - 'Windows Event ID 4688'
      - 'Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) with security event logging enabled for both detailed file share auditing and process creation.'
    range: 'Last 90 days'
    queries:
      - 'CORRELATE EventID=5145 (write) with EventID=4688 (execute) on same_host within 300s WHERE file_path = process_name. ALERT if parent_process or account NOT IN whitelist'
  - question: 'Is the observed "write-then-execute" behavior statistically unusual compared to historical norms?'
    context: |
      This question refines the previous correlation by adding a layer of behavioral analysis. Not all "write-then-execute" events are malicious. By baselining which processes are legitimately executed from shares, how often, and the typical time lag between the write and the execution, analysts can filter out noise and focus on truly anomalous events, such as a rarely seen process being executed almost instantly after being written.
    answer_sources:
      - 'Windows Event ID 5145'
      - 'Windows Event ID 4688'
      - 'Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) with security event logging enabled for both detailed file share auditing and process creation.'
    range: 'Last 90 days'
    queries:
      - 'COMPARE new "write-then-execute" event WITH historical_baseline. ALERT if process is rare OR time_delta < 5th_percentile OR file_path_entropy is high'
  - question: 'Can a sequence-based machine learning model detect anomalous "write-then-execute" event chains?'
    context: |
      This question proposes an advanced detection for this technique by modeling the entire sequence of events as a single pattern. A sequence model (like a Hidden Markov Model or Recurrent Neural Network) can learn the normal "grammar" of operations. It can then flag sequences that do not fit this grammar, such as a specific user causing a file write from an unusual host, which is then executed by an unexpected parent process, thereby detecting novel attack paths.
    answer_sources:
      - 'Windows Event ID 5145'
      - 'Windows Event ID 4688'
      - 'Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) with security event logging enabled for both detailed file share auditing and process creation.'
    range: 'Last 90 days'
    queries:
      - 'APPLY trained_sequence_model (HMM/RNN) to new "write-then-execute" event_sequence. ALERT if sequence_probability is low'