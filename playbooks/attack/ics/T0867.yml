name: T0867: Lateral Tool Transfer
id: f9e4c1b0-7d6a-4b8e-9c1f-2a5d7b3c6e4f
description: This playbook addresses the threat of lateral tool transfer within an Industrial Control System (ICS) environment, specifically focusing on whether unauthorized tools or files are being moved to critical assets like HMIs, Engineering Workstations, or Historians. It looks for evidence of file transfers over protocols like SMB, FTP, or SFTP containing high-risk or ICS-specific file types. It also monitors for Windows events indicating unauthorized write access to network shares (Event ID 5145) on critical hosts. Furthermore, it correlates these write events with subsequent process creation events (Event ID 4688) to detect a file-write-then-execute pattern, which is a strong indicator of malicious activity.
type: technique
related:
  - TA0109: Lateral Movement
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any high-risk files (e.g., executables, scripts, ICS project files) been transferred to critical ICS assets from an unauthorized source?
    context: This question aims to detect the direct transfer of potentially malicious or unauthorized tools to critical systems. Identifying transfers of files with extensions like .exe, .dll, .ps1, or specific ICS project files (.ACD, .XEF) from non-whitelisted sources can be an early indicator of an adversary staging tools for execution. Monitoring for access to administrative shares (like C$) is crucial as these provide broad access to the system.
    answer_sources:
      - Zeek smb_files.log
      - Zeek ftp.log
      - Zeek files.log
      - Zeek conn.log
      - Network traffic sensors deployed at key chokepoints, such as the IT/OT boundary (Purdue Level 3.5), between control and supervisory zones (Purdue Level 2/3), and monitoring traffic to and from critical assets like Engineering Workstations (EWS), Human Machine Interfaces (HMIs), and Historian databases.
    range: last 90 days
    queries:
      - technology: SIEM
        query: "SIEM Query Pseudocode: Search Zeek logs (smb_files.log, ftp.log, files.log) WHERE destination_ip IN [critical_ics_asset_list] AND (file_extension IN [high_risk_extensions] OR smb_path CONTAINS 'C$') AND source_ip NOT IN [authorized_source_list]."
  - question: Have there been any anomalous file transfers to critical ICS assets based on file size, name complexity, or new communication patterns?
    context: This question seeks to identify suspicious file transfers that might not be caught by simple signature-based rules. Adversaries may try to obfuscate malicious files. By baselining normal activity, we can detect outliers. A sudden transfer of an unusually large file, a file with a highly randomized name (high entropy), or a transfer from a new source to a critical asset could indicate a deviation from normal operations and potential malicious activity.
    answer_sources:
      - Zeek smb_files.log
      - Zeek ftp.log
      - Zeek files.log
      - Zeek conn.log
      - Network traffic sensors deployed at key chokepoints, such as the IT/OT boundary (Purdue Level 3.5), between control and supervisory zones (Purdue Level 2/3), and monitoring traffic to and from critical assets like Engineering Workstations (EWS), Human Machine Interfaces (HMIs), and Historian databases.
    range: last 90 days
    queries:
      - technology: Baselining
        query: "Baselining Pseudocode: For each destination asset, calculate 30-day baseline for file size, filename entropy, and source-destination pairs. ALERT if new_transfer.file_size > 98th_percentile OR new_transfer.filename_entropy > 98th_percentile OR (source_ip, destination_ip) is a new pair."
  - question: Does the overall pattern of file transfer activity to critical ICS assets deviate significantly from historically normal behavior?
    context: This question uses a machine learning approach to detect subtle, large-scale shifts in file transfer behavior that might indicate a coordinated attack. Instead of looking at individual transfers, it analyzes aggregate metrics over time (e.g., transfer counts, data volume, protocol distribution). A significant deviation from the learned 'normal' model, such as a sudden spike in .exe transfers to HMIs, could signal a widespread tool staging effort.
    answer_sources:
      - Zeek smb_files.log
      - Zeek ftp.log
      - Zeek files.log
      - Zeek conn.log
      - Network traffic sensors deployed at key chokepoints, such as the IT/OT boundary (Purdue Level 3.5), between control and supervisory zones (Purdue Level 2/3), and monitoring traffic to and from critical assets like Engineering Workstations (EWS), Human Machine Interfaces (HMIs), and Historian databases.
    range: last 90 days
    queries:
      - technology: ML Model
        query: "ML Model Pseudocode: Input time-series features (hourly transfer count, data volume, file extension distribution) into a trained anomaly detection model (e.g., Isolation Forest). ALERT if the model outputs a high anomaly score for the current time window."
  - question: Has an unauthorized user or system written data to a sensitive network share on a critical ICS host?
    context: This question focuses on monitoring the endpoint for evidence of a file being written to a sensitive location. Windows Event ID 5145 provides detailed information about network share access. By looking for 'WriteData' or 'AppendData' access to administrative shares (e.g., C$) or other critical directories from a source (user or IP) that is not explicitly authorized, we can detect attempts to place tools or malicious files directly onto a target system.
    answer_sources:
      - Windows Event ID 5145
      - Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) where Windows security auditing for detailed file share access is enabled.
    range: last 90 days
    queries:
      - technology: SIEM
        query: "SIEM Query Pseudocode: Search for EventID 5145 on critical ICS hosts WHERE (Accesses CONTAINS 'WriteData' OR Accesses CONTAINS 'AppendData') AND (ShareName CONTAINS 'C$' OR RelativeTargetName IN [sensitive_directories]) AND (SourceAddress NOT IN [authorized_source_list] OR AccountName NOT IN [authorized_account_list])."
  - question: Is there anomalous write activity to network shares on critical ICS hosts, based on volume, source, or file type?
    context: This question aims to detect deviations from normal write patterns on critical systems. Even authorized users and systems have predictable behaviors. By baselining write activity (Event ID 5145) for each host, we can flag anomalies like an unusual burst of write events, a write from a new or unexpected source IP or account, or the appearance of a file type that has never been written to that share before. Such anomalies could indicate compromised credentials or an attacker using an existing foothold.
    answer_sources:
      - Windows Event ID 5145
      - Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) where Windows security auditing for detailed file share access is enabled.
    range: last 90 days
    queries:
      - technology: Baselining
        query: "Baselining Pseudocode: For each host, baseline 30-day write activity (count, source, file extensions) by SourceAddress-AccountName-ShareName. ALERT if hourly_count > (mean + 3*std_dev) OR SourceAddress/AccountName is new OR file_extension is new for that share."
  - question: Is a specific file write event on a critical ICS host anomalous when compared to the learned behavior of that user or source entity?
    context: This question leverages a UEBA model to perform sophisticated, context-aware anomaly detection. The model learns the normal patterns of 'who, what, where, and when' for file write events (Event ID 5145). It can detect subtle deviations, such as an engineer's account writing to a share on a historian at 3 AM from an unknown IP, even if the account is technically authorized. A high anomaly score indicates the behavior is highly uncharacteristic for that user or entity and warrants investigation.
    answer_sources:
      - Windows Event ID 5145
      - Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) where Windows security auditing for detailed file share access is enabled.
    range: last 90 days
    queries:
      - technology: UEBA Model
        query: "UEBA Model Pseudocode: Input features from Event ID 5145 (source IP, account, share, path, time) into a trained UEBA model (e.g., One-Class SVM). ALERT if the model returns a high anomaly score for the event."
  - question: Was a file recently written to a critical ICS host via a network share and then immediately executed?
    context: This question seeks to identify the high-fidelity 'write-then-execute' pattern, a strong indicator of remote code execution. Correlating a file write event (Event ID 5145) with a subsequent process creation event (Event ID 4688) for the exact same file path within a short time window (e.g., 5 minutes) is a powerful detection technique. Filtering out legitimate software deployment and administrative activity by whitelisting parent processes and accounts makes this alert highly actionable.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) with security event logging enabled for both detailed file share auditing and process creation.
    range: last 90 days
    queries:
      - technology: SIEM
        query: "SIEM Correlation Pseudocode: TRIGGER on EventID 5145. Within 300s, look for EventID 4688 on the same host WHERE 5145.RelativeTargetName == 4688.NewProcessName. ALERT if 4688.ParentProcessName NOT IN [whitelist] AND 5145.AccountName NOT IN [whitelist]."
  - question: Is a recently observed "write-then-execute" sequence on a critical ICS host statistically unusual compared to historical patterns?
    context: This question builds on the basic correlation by adding a layer of statistical analysis to reduce false positives from legitimate, but infrequent, software maintenance. By baselining normal write-then-execute behavior, we can alert on sequences that are rare (e.g., a process that has almost never been executed from a share before) or have an unusually short time delay between the write and the execution, which can be indicative of automated attack scripts. Analyzing file path entropy can also catch randomized file names used to evade simple signatures.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) with security event logging enabled for both detailed file share auditing and process creation.
    range: last 90 days
    queries:
      - technology: Baselining
        query: "Baselining Pseudocode: Baseline historical 5145->4688 correlations. ALERT if a new correlation involves a process_name with frequency < 5 in 90 days OR time_delta < 5th_percentile for that process OR file_path_entropy > threshold."
  - question: Does a sequence of file write and process creation events on a critical ICS host represent a deviation from learned normal operational sequences?
    context: This is the most advanced question, using a sequence-aware model (like an HMM or RNN) to understand the entire context of an operation, not just two linked events. The model learns legitimate workflows, such as 'Admin-X logs in, writes patch file to server-Y from update-server-Z, which is then executed by the system service.' It can then flag a sequence like 'User-A writes an unknown .exe from a workstation to an HMI, which is then executed by explorer.exe' as highly anomalous because the entire sequence of user, source, target, and process parentage is improbable based on historical data.
    answer_sources:
      - Windows Event ID 5145
      - Windows Event ID 4688
      - Critical ICS hosts (e.g., HMIs, Engineering Workstations, Historians) with security event logging enabled for both detailed file share auditing and process creation.
    range: last 90 days
    queries:
      - technology: ML Model
        query: "ML Model Pseudocode: Input event sequence (Event 5145 features -> Event 4688 features) into a trained sequence model (e.g., HMM, RNN). ALERT if the model assigns a low probability score to the observed sequence."