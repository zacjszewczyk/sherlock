name: T0869: Standard Application Layer Protocol
id: 5a9b8c7d-6e3f-4a1b-9c8d-7e6f5a4b3c2d
description: This playbook helps identify adversaries leveraging standard application
  layer protocols (e.g., DNP3, Modbus, HTTP, RDP) for command and control (C2) within
  an ICS network. It focuses on detecting C2 by identifying protocol usage on non-standard
  ports, analyzing traffic for statistical deviations from established baselines (such
  as data volume, protocol function codes, and URL/User-Agent entropy), and flagging
  anomalous Remote Desktop Protocol (RDP) sessions based on source location, time,
  and duration.
type: technique
related:
- TA0101: Command And Control
contributors:
- Zachary Szewczyk
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
- question: Are critical ICS protocols (like DNP3, Modbus, RDP) being used on non-standard
    ports, potentially indicating C2 activity?
  context: Adversaries may use legitimate application layer protocols for C2 but run
    them on non-standard ports to evade simple port-based firewall rules and detection.
    This question helps identify such suspicious connections. The investigation is
    escalated if the connection involves an external IP address or crosses a critical
    network boundary (e.g., from the OT network to the IT network), as these are strong
    indicators of a potential breach.
  answer_sources:
  - Zeek conn.log
  - Zeek service.log
  - IT/OT Demarcation Points
  - ICS Zone Gateways
  - Enterprise Network Perimeter
  - Internet Proxies
  - EWS
  - HMIs
  - SCADA Servers
  - PLCs
  - RTUs
  - Jump Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      SEARCH Zeek conn.log
      WHERE service IN [critical_protocols_list]
      AND destination_port NOT IN [approved_ports_list_for_service]
      IF (source_ip IN [ot_subnets] AND destination_ip IS external) OR (connection crosses [it_ot_boundary])
      THEN ESCALATE_ALERT
- question: Are there any network connections using statistically rare service-port
    combinations, which could indicate an adversary's attempt to hide C2 traffic?
  context: This question aims to find outliers by baselining normal port usage for
    each network service. Adversaries might use a port that is technically valid
    but very rarely used in the environment to avoid detection. By identifying and
    alerting on connections to these statistically infrequent ports, analysts can
    uncover covert C2 channels that might otherwise be missed.
  answer_sources:
  - Zeek conn.log
  - Zeek service.log
  - IT/OT Demarcation Points
  - ICS Zone Gateways
  - Enterprise Network Perimeter
  - Internet Proxies
  - EWS
  - HMIs
  - SCADA Servers
  - PLCs
  - RTUs
  - Jump Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      SCHEDULED_SEARCH (daily):
        ANALYZE Zeek conn.log from last 30 days
        FOR each service:
          CALCULATE frequency of each destination_port
          IDENTIFY ports below 5th percentile of usage
          ADD (service, port) pair to 'rare_service_port_watchlist'
      SEARCH Zeek conn.log (real-time):
        WHERE (service, destination_port) IN 'rare_service_port_watchlist'
        GENERATE_ALERT
- question: Can we use machine learning to detect anomalous network connections that
    deviate from established normal behavior, potentially indicating C2?
  context: This question leverages machine learning (specifically, an Isolation Forest
    model) to identify anomalous network connections based on a combination of features
    like protocol, port, duration, and data volume. This method can detect novel
    or complex attack patterns that signature-based or simple rule-based detections
    might miss, providing a more robust defense against sophisticated C2 techniques.
  answer_sources:
  - Zeek conn.log
  - Zeek service.log
  - IT/OT Demarcation Points
  - ICS Zone Gateways
  - Enterprise Network Perimeter
  - Internet Proxies
  - EWS
  - HMIs
  - SCADA Servers
  - PLCs
  - RTUs
  - Jump Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      MODEL_TRAINING (offline):
        TRAIN IsolationForest on historical Zeek conn.log features (protocol, service, port, duration, bytes, etc.)
      MODEL_DEPLOYMENT (real-time):
        FOR each new connection:
          SCORE connection using trained model
          IF anomaly_score > threshold:
            GENERATE_ALERT
- question: Are there any unauthorized DNP3 commands (function codes) being sent
    between critical master and outstation devices?
  context: Industrial protocols like DNP3 use specific function codes for legitimate
    operations. An adversary might use unauthorized or rare function codes to manipulate
    or disrupt a process. This question focuses on enforcing a strict 'allowlist'
    of function codes for specific communication paths. An alert for an unapproved
    code is a high-fidelity indicator of potential malicious activity, especially
    when correlated with suspicious process activity on the source machine.
  answer_sources:
  - Zeek dnp3.log
  - Windows Event ID 4688
  - EWS
  - SCADA Servers
  - HMIs
  - PCN Segments
  - Domain Controllers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      SEARCH Zeek dnp3.log
      WHERE (source_ip, destination_ip) IN [critical_dnp3_pairs]
      AND function_code NOT IN [allowlist_for_pair]
      GENERATE_ALERT
      ENRICH alert with recent (e.g., last 5 mins) Windows Event ID 4688 from source_ip
- question: Are any hosts exhibiting anomalous HTTP traffic, such as unusually large
    data transfers or highly randomized URI/User-Agent strings, suggesting C2 communication?
  context: Adversaries often use HTTP for C2. This can manifest as data exfiltration
    (large outbound requests) or algorithmically generated domain/URI patterns (high
    entropy). This question establishes a behavioral baseline for each host's HTTP
    traffic. Deviations from this baseline, such as a sudden spike in data volume
    or the use of unusually random-looking URIs, can be strong indicators of malware
    beaconing or C2 activity.
  answer_sources:
  - Zeek conn.log
  - Zeek http.log
  - Windows Event ID 4688
  - EWS
  - SCADA Servers
  - Historian Servers
  - HMIs
  - DMZ Web Servers
  - PCN Segments
  - Enterprise Proxies
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      SCHEDULED_SEARCH (daily):
        FOR each source_host:
          CALCULATE 30-day baseline for http_requests (95th percentile of bytes, mean/stddev of URI/User-Agent entropy)
          STORE baselines
      SEARCH Zeek http.log (real-time):
        FOR each new http_request:
          COMPARE request_bytes, uri_entropy, user_agent_entropy to stored baseline for source_host
          IF request > baseline_thresholds:
            GENERATE_ALERT
- question: Can a machine learning model detect subtle deviations in the operational
    rhythm of communication between master-outstation pairs, indicating a potential
    compromise?
  context: This question proposes using an advanced machine learning model (LSTM
    Autoencoder) to learn the 'normal' pattern of communication between critical
    ICS devices over time. This model considers multiple variables simultaneously
    (message counts, timings, byte sizes, etc.). An alert is generated when current
    activity doesn't match the learned historical patterns, allowing for the detection
    of sophisticated, low-and-slow attacks that manipulate operational traffic in
    subtle ways.
  answer_sources:
  - Zeek conn.log
  - Zeek dnp3.log
  - Zeek modbus.log
  - EWS
  - SCADA Servers
  - Historian Servers
  - HMIs
  - PCN Segments
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      MODEL_TRAINING (offline):
        AGGREGATE Zeek logs into time-series windows for each master-outstation pair
        TRAIN LSTM Autoencoder on historical time-series data
      MODEL_DEPLOYMENT (real-time):
        FOR each new time window of data:
          CALCULATE reconstruction_error using trained model
          IF reconstruction_error > dynamic_threshold:
            GENERATE_ALERT
- question: Has a critical ICS asset been accessed via RDP from an unapproved external
    IP address?
  context: Remote Desktop Protocol (RDP) is a common vector for initial access and
    lateral movement. An RDP connection from an external, non-RFC1918 IP address
    that is not on a pre-approved allowlist is a major security risk and a strong
    indicator of a potential breach. This question aims to immediately detect and
    alert on such high-risk connections, enabling rapid response.
  answer_sources:
  - Windows Event ID 4624
  - Zeek rdp.log
  - EWS
  - HMIs
  - SCADA Servers
  - Jump Servers
  - Domain Controllers
  - IT/OT Demarcation Points
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      SEARCH Windows Event ID 4624
      WHERE logon_type = 10
      AND source_ip IS external
      AND source_ip NOT IN [rdp_allowlist]
      GENERATE_ALERT
      ENRICH alert with client version from Zeek rdp.log for the same session
- question: Are there any RDP sessions to critical assets that are anomalous in terms
    of timing or duration for a specific user?
  context: Adversaries using compromised credentials may not adhere to the normal
    working patterns of the legitimate user. This question focuses on detecting behavioral
    anomalies by baselining RDP session activity for each user-asset pair. An alert
    on a logon at an unusual time (e.g., 3 AM for a 9-to-5 engineer) or a session
    that lasts significantly longer than normal can indicate that the user's account
    has been compromised.
  answer_sources:
  - Windows Event ID 4624
  - Windows Event ID 4634
  - EWS
  - HMIs
  - SCADA Servers
  - Jump Servers
  - Domain Controllers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      SCHEDULED_SEARCH (daily):
        ANALYZE past 90 days of Windows Event ID 4624/4634
        FOR each user-asset pair:
          CALCULATE baseline for logon_hour (mean, stddev) and session_duration (95th percentile)
          STORE baselines
      SEARCH Windows Event ID 4624 (real-time):
        IF logon_hour is > 3 stddev from user's mean:
          GENERATE_ALERT
      CORRELATE with Event ID 4634 to calculate session_duration:
        IF session_duration > 95th percentile for user-asset pair:
          GENERATE_ALERT
- question: Can a graph-based machine learning model identify improbable RDP connections
    between users and assets that violate historical access patterns?
  context: This question uses a sophisticated graph-based approach to model the relationships
    between users, assets, and their RDP connections. This allows the system to learn
    'who connects to what'. A graph anomaly detection model can then identify highly
    unusual connections, such as a user from the IT department suddenly accessing
    a sensitive PLC for the first time, which would be a strong indicator of lateral
    movement or credential abuse.
  answer_sources:
  - Windows Event ID 4624
  - Windows Event ID 4634
  - Zeek conn.log
  - Zeek rdp.log
  - EWS
  - HMIs
  - SCADA Servers
  - Jump Servers
  - Domain Controllers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |-
      MODEL_TRAINING (offline):
        BUILD graph from historical RDP logs (nodes: users, assets; edges: connections)
        TRAIN GraphSAGE model on the graph structure and features
      MODEL_DEPLOYMENT (real-time):
        FOR each new RDP session:
          SCORE session as a new edge in the graph
          IF anomaly_score > threshold:
            GENERATE_ALERT