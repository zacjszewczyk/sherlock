name: "T0821: Modify Controller Tasking"
id: "1a2b3c4d-5e6f-4a7b-8c9d-9e8f7a6b5c4d"
description: "This playbook helps investigate whether an adversary has modified the tasking of an Industrial Control System (ICS) controller to execute unauthorized code. This can be detected by observing network traffic for unauthorized modification commands, such as those from unapproved IP addresses or outside maintenance windows. It also looks for signs on Engineering Workstations (EWS), like ICS software being run by unauthorized users or from suspicious parent processes. Finally, it provides methods to directly verify controller integrity by comparing running configurations against known-good baselines and analyzing the volume and sequence of configuration write commands for anomalies."
type: "technique"
related:
  - "TA0104: Execution"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Have any ICS modification commands been observed from an unapproved source or outside a scheduled maintenance window?"
    context: "This question aims to detect blatant policy violations. Authorized changes to controller logic should only come from designated Engineering Workstations (EWS) and during planned maintenance periods. An alert on this rule is a high-fidelity indicator of potentially unauthorized or malicious activity, as it bypasses established change control procedures."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek modbus.log"
      - "Zeek enip.log"
      - "Zeek dnp3.log"
      - "Network segments within the Process Control Network (PCN) where Engineering Workstations (EWS) communicate with controllers"
      - "Network taps at the PCN/DMZ boundary"
      - "SPAN ports on core switches"
      - "Virtual LANs (VLANs) dedicated to Safety Instrumented Systems (SIS) and Basic Process Control Systems (BPCS)"
    range: "last 90 days"
    queries:
      - "SIEM: SEARCH Zeek logs (s7comm, modbus, etc.) FOR modification_function_codes WHERE (source_ip NOT IN EWS_Allowlist OR event_time NOT IN Maintenance_Windows) | ENRICH with conn.log details"
  - question: "Has there been a statistically significant increase in modification commands between any specific source and controller?"
    context: "This question focuses on detecting anomalous volumes of activity that might otherwise be missed by simple rule-based logic. Even if commands originate from an approved EWS, a sudden, high-volume burst of modifications can indicate a compromised workstation or a malicious script. Using a 3-sigma threshold helps identify activity that is statistically rare and warrants investigation."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek modbus.log"
      - "Zeek enip.log"
      - "Zeek dnp3.log"
      - "Network segments within the Process Control Network (PCN) where Engineering Workstations (EWS) communicate with controllers"
      - "Network taps at the PCN/DMZ boundary"
      - "SPAN ports on core switches"
      - "Virtual LANs (VLANs) dedicated to Safety Instrumented Systems (SIS) and Basic Process Control Systems (BPCS)"
    range: "last 90 days"
    queries:
      - "SIEM: FOR each (source_ip, dest_ip) pair | CALCULATE 90-day hourly baseline (mean, std_dev) for modification_commands | ALERT IF current_hour_count > (mean + 3 * std_dev) AND current_hour_count > 5"
  - question: "Does the overall pattern of controller modification activity across the network deviate from the established operational rhythm?"
    context: "This question takes a holistic, network-wide view. It seeks to identify subtle deviations from normal operational patterns that might not be captured by per-host or per-pair analysis. A sophisticated time-series model can learn the complex rhythms of a plant (e.g., day vs. night, weekday vs. weekend, maintenance cycles) and flag activity that, while not violating a simple threshold, is inconsistent with these learned patterns."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek s7comm.log"
      - "Zeek modbus.log"
      - "Zeek enip.log"
      - "Zeek dnp3.log"
      - "Network segments within the Process Control Network (PCN) where Engineering Workstations (EWS) communicate with controllers"
      - "Network taps at the PCN/DMZ boundary"
      - "SPAN ports on core switches"
      - "Virtual LANs (VLANs) dedicated to Safety Instrumented Systems (SIS) and Basic Process Control Systems (BPCS)"
    range: "last 90 days"
    queries:
      - "ML Model: AGGREGATE modification_command_counts in 15-min intervals | INPUT to time-series model with features (count, day_of_week, hour, is_maintenance) | ALERT IF anomaly_score > 0.99"
  - question: "Has ICS engineering software been executed by an unauthorized user or spawned from a suspicious parent process on an Engineering Workstation?"
    context: "This question investigates the origin of the modification activity on the host itself. Legitimate use of engineering software should be by authorized personnel and initiated directly by the user, not by scripts or other non-interactive processes. Detecting execution by an unauthorized account or from a parent like powershell.exe is a strong indicator of a compromised host being used to pivot to the control system."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Windows Event ID 4672"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Dedicated Engineering Workstations (EWS)"
      - "Active Directory Domain Controllers authenticating PCN users"
      - "Endpoint Detection and Response (EDR) platforms deployed on EWS hosts"
    range: "last 90 days"
    queries:
      - "SIEM: SEARCH EID 4688 on EWS hosts WHERE (process_name IN ICS_Software_List AND (user NOT IN Authorized_Group OR parent_process IN Suspicious_List)) | CORRELATE with EID 5156 to controller_IP within 60s"
  - question: "Is an authorized user running ICS software from a workstation or at a time that is unusual for them?"
    context: "This question seeks to identify behavioral anomalies even for authorized users. An attacker who has stolen credentials may not know the typical routines of the compromised user. For example, an engineer who always works 9-5 from a specific EWS suddenly running software at 3 AM from a different machine is a significant anomaly that this question is designed to detect."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Windows Event ID 4672"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Dedicated Engineering Workstations (EWS)"
      - "Active Directory Domain Controllers authenticating PCN users"
      - "Endpoint Detection and Response (EDR) platforms deployed on EWS hosts"
    range: "last 90 days"
    queries:
      - "SIEM/UBA: CALCULATE 90-day probability for each (user, hostname, hour) tuple for ICS software execution | ALERT IF new event tuple probability < 5th percentile"
  - question: "Does a user's overall session activity on an Engineering Workstation appear anomalous when compared to their historical behavior?"
    context: "This question uses advanced User Behavior Analytics (UBA) to create a comprehensive profile of user sessions on critical assets like EWS. Instead of looking at a single event, it considers a collection of activities (logins, process execution, network connections, etc.) as a single entity. This allows it to detect sophisticated attackers who might try to blend in by keeping individual actions low-key, but whose overall session behavior deviates from the norm."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4624"
      - "Windows Event ID 4672"
      - "Windows Event ID 5156"
      - "Zeek conn.log"
      - "Dedicated Engineering Workstations (EWS)"
      - "Active Directory Domain Controllers authenticating PCN users"
      - "Endpoint Detection and Response (EDR) platforms deployed on EWS hosts"
    range: "last 90 days"
    queries:
      - "UBA Model: FOR each user session on EWS | CREATE feature vector (login_type, cmd_entropy, parent-child_rels, network_conns) | INPUT to UBA model (e.g., Isolation Forest) | ALERT IF session anomaly_score > 99.5th percentile"
  - question: "Does the running configuration on a critical controller match its last known-good baseline hash?"
    context: "This is a question of integrity verification. It provides a definitive ground truth by directly checking the controller's configuration against an authoritative 'golden image'. A hash mismatch is a very high-fidelity indicator that an unauthorized or undocumented change has occurred, regardless of how the change was made. This acts as a safety net to catch modifications that might evade network or host-based detection."
    answer_sources:
      - "Zeek s7comm.log"
      - "Zeek modbus.log"
      - "Zeek enip.log"
      - "Controller configuration backups / 'golden image' repository"
      - "Controller internal logs"
      - "Directly on Programmable Logic Controllers (PLCs) and Distributed Control Systems (DCS)"
      - "Secure baseline repository or Configuration Management Database (CMDB) storing controller golden images"
      - "Network segments carrying configuration traffic between EWS and controllers"
    range: "last 90 days"
    queries:
      - "Script: SCHEDULE script to run every 4 hours: POLL controller for config | COMPUTE SHA-256 hash of config | RETRIEVE golden_image_hash from repository | ALERT IF current_hash != golden_image_hash"
  - question: "Is a controller experiencing an unusually high volume or variety of configuration write commands?"
    context: "This question focuses on the characteristics of the modification traffic itself. An attacker attempting to brute-force a configuration or trying multiple different payloads might generate a higher volume (count) or a greater variety (entropy) of write commands than a typical, targeted engineering change. This method can detect suspicious modification patterns even if the source is authorized."
    answer_sources:
      - "Zeek s7comm.log"
      - "Zeek modbus.log"
      - "Zeek enip.log"
      - "Controller configuration backups / 'golden image' repository"
      - "Controller internal logs"
      - "Directly on Programmable Logic Controllers (PLCs) and Distributed Control Systems (DCS)"
      - "Secure baseline repository or Configuration Management Database (CMDB) storing controller golden images"
      - "Network segments carrying configuration traffic between EWS and controllers"
    range: "last 90 days"
    queries:
      - "SIEM: FOR each controller | CALCULATE 90-day baseline (98th percentile) for hourly command_count and command_entropy | ALERT IF current_hour_count > 98th_percentile_count OR current_hour_entropy > 98th_percentile_entropy"
  - question: "Can a machine learning model, trained on historical data, classify a new configuration change as potentially malicious?"
    context: "This question represents a proactive, predictive approach. By training a supervised model on labeled examples of both benign (e.g., routine maintenance) and malicious (e.g., from past incidents) activity, the system can learn the subtle, multi-faceted indicators of a malicious change. This allows it to make a real-time judgment on new, unseen events and flag them for immediate review."
    answer_sources:
      - "Zeek s7comm.log"
      - "Zeek modbus.log"
      - "Zeek enip.log"
      - "Controller configuration backups / 'golden image' repository"
      - "Controller internal logs"
      - "Directly on Programmable Logic Controllers (PLCs) and Distributed Control Systems (DCS)"
      - "Secure baseline repository or Configuration Management Database (CMDB) storing controller golden images"
      - "Network segments carrying configuration traffic between EWS and controllers"
    range: "last 90 days"
    queries:
      - "ML Model: ON new configuration change event | CREATE feature vector (source_ip, user, command_type, data_size, time_of_day, has_change_ticket) | INPUT to Random Forest classifier | ALERT IF classification == 'Malicious'"