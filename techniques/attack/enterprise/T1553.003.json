[
  {
    "information_requirement": "Has an adversary hijacked a SIP or Trust Provider to evade defenses? (TA0005 - Defense Evasion)",
    "tactic_id": "TA0005",
    "tactic_name": "Defense Evasion",
    "indicators": [
      {
        "technique_id": "T1553.003",
        "name": "SIP and Trust Provider Hijacking",
        "evidence": [
          {
            "description": "A file hash observed on the network or endpoint matches a known malicious hash associated with SIP hijacking tools, or a registry value modification points to a DLL path associated with a known threat actor's toolset.",
            "data_sources": [
              "Sysmon Event ID 13",
              "Sysmon Event ID 11",
              "Zeek files.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Endpoint file systems, Endpoint registry hives (HKLM\\SOFTWARE\\Microsoft\\Cryptography), Network egress points",
            "action": [
              "Symbolic: Create a detection rule that performs a real-time join between a threat intelligence feed of known malicious SIP hijacking file hashes (MD5, SHA256) and observed file hashes from Zeek files.log and Sysmon Event ID 11 (FileCreate). Trigger a high-severity alert upon match.",
              "Statistical: For every modification to a SIP/Trust Provider registry key (Sysmon Event ID 13), calculate the prevalence of the new DLL file path across the enterprise. If the path's enterprise-wide frequency is below a percentile threshold (e.g., 1st percentile) and the modification was not performed by a standard system process (e.g., TrustedInstaller.exe), flag it for investigation.",
              "Machine Learning: Train a logistic regression classifier on features from registry modification events (Sysmon Event ID 13) and the associated process (Sysmon Event ID 1). Features should include process name, parent process name, process command line, and boolean flags indicating if the target registry path is a known SIP/Trust Provider key and if the new DLL path is in a temporary/user-writable directory. The model will classify each modification event as benign or suspicious."
            ]
          },
          {
            "description": "A process, such as reg.exe or regsvr32.exe, modifies a registry value under HKLM\\SOFTWARE\\Microsoft\\Cryptography\\OID or HKLM\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\Trust.",
            "data_sources": [
              "Sysmon Event ID 1",
              "Sysmon Event ID 13",
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Endpoint registry hives (HKLM\\SOFTWARE\\Microsoft\\Cryptography), Endpoint process execution logs",
            "action": [
              "Symbolic: Create a high-fidelity rule to alert on any process creation (Sysmon Event ID 1) where the process is reg.exe or regsvr32.exe and the command line contains strings like CryptSIPDllGetSignedDataMsg, CryptSIPDllVerifyIndirectData, or FinalPolicy.",
              "Statistical: For all Sysmon Event ID 13 (Registry Value Set) events targeting the specified cryptography keys, calculate the entropy of the parent process name that initiated the change. A sudden spike in entropy for a given host or user may indicate an adversary using randomized or unusual process names to perform the modification. Alert when the hourly entropy score for a host exceeds 3 standard deviations from its 30-day baseline.",
              "Machine Learning: Use an anomaly detection model (e.g., Isolation Forest) on process creation events (Sysmon Event ID 1) that lead to modifications of these critical registry keys. Features should include the parent process, process path, user context, and command-line arguments. The model will identify highly unusual combinations of these features that deviate from established baselines of legitimate administrative activity."
            ]
          },
          {
            "description": "A process not on an established allowlist (e.g., TrustedInstaller.exe, msiexec.exe) modifies a SIP or Trust Provider registry key.",
            "data_sources": [
              "Sysmon Event ID 1",
              "Sysmon Event ID 13"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Endpoint registry hives (HKLM\\SOFTWARE\\Microsoft\\Cryptography), Enterprise-wide process execution baselines",
            "action": [
              "Symbolic: Create a detection rule that alerts when a Sysmon Event ID 13 event modifies a SIP/Trust Provider key, and the ProcessGuid of the modifying process does not correspond to a process name on a pre-defined allowlist (e.g., TrustedInstaller.exe, svchost.exe, msiexec.exe).",
              "Statistical: Maintain a frequency table of all process names that modify SIP/Trust Provider keys across the enterprise over a 30-day rolling window. Any modification (Sysmon Event ID 13) by a process name that falls in the bottom 5th percentile of frequency (i.e., is very rare) should be flagged as anomalous and investigated.",
              "Machine Learning: Implement a time-series analysis on the count of 'rare process' modifications per day. A sudden, sharp increase in the rate of these events, detected by a forecasting model like ARIMA or Prophet identifying a significant outlier, could indicate the start of a widespread campaign leveraging this technique."
            ]
          },
          {
            "description": "A temporal sequence of events is observed on a host: 1) A new DLL is created in a user-writable directory. 2) A SIP/Trust Provider registry key is modified to point to this new DLL. 3) A signed application is executed, and a successful signature validation event is logged.",
            "data_sources": [
              "Sysmon Event ID 11",
              "Sysmon Event ID 13",
              "Microsoft-Windows-CAPI2/Operational Event ID 11"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Endpoint file systems (user-writable paths like %APPDATA%, %TEMP%), Endpoint registry hives (HKLM\\SOFTWARE\\Microsoft\\Cryptography), Windows CAPI2 event logs",
            "action": [
              "Symbolic: Create a correlation rule that triggers an alert if the following sequence occurs on the same host within a 5-minute window: 1. Sysmon Event ID 11 (FileCreate) for a .dll file in a non-system directory. 2. Sysmon Event ID 13 (RegistryValueSet) where the TargetObject is a SIP/Trust key and the Details field contains the path to the newly created DLL. 3. CAPI2 Event ID 11 (Successful X509 Chain Building) for any process.",
              "Statistical: For each host, calculate the baseline rate of CAPI2 Event ID 11 (successful validation) events that occur within 5 minutes after a registry modification (Sysmon Event ID 13) to a SIP/Trust key. An event sequence where the post-modification validation rate for a host exceeds its 99th percentile baseline is highly suspicious.",
              "Machine Learning: Use a sequence-aware model, such as a Hidden Markov Model (HMM) or a Recurrent Neural Network (RNN), trained on event logs (Sysmon, CAPI2). Define states such as 'Benign Activity', 'File Write', 'Registry Modify', and 'Hijack Success'. Train the model on known benign sequences. When a live event stream matches the high-probability transition path from 'File Write' to 'Registry Modify' to a successful validation state, flag it as a likely hijack."
            ]
          },
          {
            "description": "A process, whose signature was successfully validated, is executed from an atypical directory (e.g., %APPDATA%, %TEMP%) and subsequently initiates external network communication to a low-reputation or newly-observed IP address or domain.",
            "data_sources": [
              "Sysmon Event ID 1",
              "Microsoft-Windows-CAPI2/Operational Event ID 11",
              "Zeek conn.log",
              "Zeek dns.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Endpoint process execution logs, Windows CAPI2 event logs, Network gateway and DNS server logs",
            "action": [
              "Symbolic: Create a correlation rule that joins Sysmon Event ID 1 with CAPI2 Event ID 11 on ProcessGUID. If a successfully validated process is executed from a path matching a blocklist of suspicious directories (e.g., C:\\Users\\*\\AppData\\Local\\Temp\\*, C:\\Windows\\Temp\\*) and is followed within 60 seconds by an outbound connection (Zeek conn.log) to an IP address on a threat intelligence feed, generate an alert.",
              "Statistical: For each process name, build a statistical profile of its normal execution paths and parent processes. For any execution of a validated process (CAPI2 Event ID 11), if its execution path or parent process is statistically rare (e.g., outside the top 95% most frequent paths/parents for that process name), temporarily elevate monitoring on its child processes and network activity. If that process then communicates with a domain seen for the first time in the last 7 days (Zeek dns.log), flag for investigation.",
              "Machine Learning: Use a graph-based anomaly detection model. Create a graph where nodes are processes, files, registry keys, and remote IP addresses, and edges represent interactions (e.g., 'creates', 'modifies', 'connects to'). Train the model on benign activity to learn normal graph structures. A hijack sequence would appear as an anomalous subgraph: a rare process modifying a SIP key, which then executes a 'validated' file from a strange path that connects to an unusual external node. The model would score this subgraph as a high anomaly."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.2",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk"
    ]
  }
]