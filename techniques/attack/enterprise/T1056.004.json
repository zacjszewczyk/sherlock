[
  {
    "information_requirement": "Is the adversary attempting to gain access to credentials using API hooking?",
    "tactic_id": "TA0006",
    "tactic_name": "Credential Access",
    "indicators": [
      {
        "technique_id": "T1056.004",
        "name": "Credential API Hooking",
        "evidence": [
          {
            "description": "A process creation event is observed where the executable's file hash matches a known malicious indicator for malware that performs API hooking.",
            "data_sources": [
              "Windows Security Event ID 4688",
              "Sysmon Event ID 1"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User workstations, Domain Controllers, Critical application servers (e.g., HR, Finance), Jump boxes",
            "action": [
              "Query all process creation events (Windows Security Event ID 4688 or Sysmon Event ID 1) and join the executable's hash against a threat intelligence database of known malicious file hashes. Generate a high-priority alert upon any match.",
              "Calculate the prevalence of each process hash across all endpoints over the last 30 days. Flag any hash that is present on a small number of systems (e.g., fewer than 5 hosts or less than 0.1% of the endpoint population) and is not associated with a known software deployment or administrative tool.",
              "Utilize a pre-trained supervised classification model (e.g., Random Forest) on process creation event features (parent process, command-line arguments, hash prevalence, user context) to assign a maliciousness score to each new process. A high probability score for a process with a low-prevalence hash is a strong indicator of malicious activity requiring immediate investigation."
            ]
          },
          {
            "description": "A process is executed with command-line arguments or parent-child relationships indicative of in-memory injection or the loading of a hooking module, such as rundll32.exe loading a non-system DLL.",
            "data_sources": [
              "Windows Security Event ID 4688",
              "Sysmon Event ID 1"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User workstations, Servers with administrative tools, Development environments, Authentication servers",
            "action": [
              "Apply regular expressions to process command-line arguments (from Windows Security Event ID 4688) to detect patterns associated with hooking tools or suspicious loading (e.g., 'SetWindowsHookEx', 'LdrLoadDll', rundll32.exe loading a DLL from a non-system path). Maintain and alert on a list of forbidden parent-child process relationships, such as lsass.exe spawning cmd.exe.",
              "Calculate the Shannon entropy of command-line arguments for each executed process. Establish a per-process baseline entropy score (e.g., for svchost.exe, powershell.exe) and alert on executions that exhibit a score significantly higher than the baseline (e.g., greater than 3 standard deviations from the mean for that specific process name), which can indicate obfuscation.",
              "Employ an unsupervised clustering algorithm (e.g., DBSCAN) on feature vectors derived from command-line arguments. This can identify novel clusters of anomalous command-line structures that deviate from established patterns of benign activity, potentially revealing new or unknown hooking tools and techniques."
            ]
          },
          {
            "description": "A legitimate credential-handling process (e.g., lsass.exe, chrome.exe, mstsc.exe, winlogon.exe) spawns an anomalous child process or initiates a network connection to a rare or suspicious destination.",
            "data_sources": [
              "Windows Security Event ID 4688",
              "Sysmon Event ID 1",
              "Zeek conn.log",
              "Zeek dns.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers (for lsass.exe), User workstations (for browsers, RDP clients), Jump boxes, Internet Gateway",
            "action": [
              "Define and enforce a strict allow-list of legitimate child processes for sensitive applications like lsass.exe and winlogon.exe. Any process creation (Windows Security Event ID 4688) that violates this defined parent-child relationship triggers a critical alert.",
              "For each sensitive process, build a statistical profile of its network destinations (IPs, domains, ports) using Zeek conn.log and dns.log. Alert when the process initiates a connection to a destination that is statistically rare for that process or the organization (e.g., a domain seen for the first time, or an IP in the bottom 1% of connection frequency).",
              "Use a time-series anomaly detection model (e.g., an LSTM Autoencoder) on sequences of network events (e.g., connections per minute, data volume) originating from credential-handling processes. The model learns the normal rhythm of network activity and flags significant deviations that could represent a hooked process initiating command and control communications."
            ]
          },
          {
            "description": "A process loads a DLL module from a non-standard path or a DLL that is a statistical outlier for that parent process, potentially indicating a hook procedure being loaded into memory.",
            "data_sources": [
              "Sysmon Event ID 7"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User workstations, Application servers, Virtual Desktop Infrastructure (VDI) environments",
            "action": [
              "Monitor for image load events (Sysmon Event ID 7) where a process loads a DLL from a suspicious path (e.g., C:\\Users\\Public\\, C:\\Temp\\) or where the DLL is unsigned. Create an alert for any DLL loaded by a critical process (e.g., lsass.exe) that is not on a pre-defined allow-list.",
              "For each common process name (e.g., chrome.exe, explorer.exe), create a baseline profile of all DLLs it normally loads. Alert when a process loads a DLL that has never been seen with that parent process before or is in the lowest percentile of prevalence across the environment.",
              "Train a classification model (e.g., Gradient Boosting) on image load event features, including DLL signature status, file path entropy, DLL prevalence, and parent process characteristics, to predict if a specific DLL load event is part of a malicious hooking attempt. A high-risk score from the model should trigger an investigation."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk"
    ]
  },
  {
    "information_requirement": "Is the adversary collecting sensitive data via API hooking?",
    "tactic_id": "TA0009",
    "tactic_name": "Collection",
    "indicators": [
      {
        "technique_id": "T1056.004",
        "name": "Credential API Hooking",
        "evidence": [
          {
            "description": "Network traffic originating from a host with suspected API hooking activity is directed to a destination IP or domain known to be associated with malicious command and control (C2) or data exfiltration.",
            "data_sources": [
              "Zeek conn.log",
              "Zeek dns.log",
              "Zeek ssl.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Network egress points, Internet Gateway, DNS servers, Proxy servers",
            "action": [
              "Continuously correlate all destination IPs and domains from network logs (Zeek conn.log, Zeek dns.log) against a threat intelligence feed of known malicious C2 infrastructures. A match from a host with other concurrent indicators of hooking is a high-confidence sign of active collection.",
              "Profile the JA3/JA3S TLS fingerprints from all outbound connections (Zeek ssl.log) to establish a baseline of legitimate client software. Identify and alert on rare or previously unseen fingerprints, as adversary tooling often uses non-standard TLS libraries, making their fingerprints statistical outliers.",
              "Use a supervised classifier (e.g., Gradient Boosting) to assign a risk score to every outbound network connection based on features like destination ASN, port, JA3 fingerprint, data volume, and domain age/reputation. A high score for a connection from a process suspected of hooking indicates likely data collection."
            ]
          },
          {
            "description": "An anomalous process initiates the creation of an archive file (e.g., .zip, .rar, .7z) containing data from temporary locations or user directories where hooked credentials may have been staged.",
            "data_sources": [
              "Windows Security Event ID 4688",
              "Sysmon Event ID 1"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User workstations, File servers, Staging servers, Temporary directories",
            "action": [
              "Monitor process creation events (Windows Security Event ID 4688 or Sysmon Event ID 1) for archiving utilities (e.g., 7z.exe, tar.exe, Compress-Archive). Alert if the command's source path targets sensitive locations (e.g., browser profile folders, AppData) and the parent process is anomalous (e.g., not explorer.exe or cmd.exe).",
              "For each user, establish a baseline of normal archiving activity (frequency, typical parent processes, time of day). An execution that is a statistical outlier (e.g., an accountant's account running 7z.exe at 3 AM with svchost.exe as the parent) should trigger an alert.",
              "Use an unsupervised anomaly detection model, such as an Isolation Forest, on process event features (process name, parent process, command-line entropy, user context) to identify anomalous archival activities that do not conform to learned patterns of benign behavior across the enterprise."
            ]
          },
          {
            "description": "A process spawned by a hooked, credential-handling parent (e.g., winlogon.exe) accesses or creates files in temporary staging directories or initiates network connections consistent with data exfiltration.",
            "data_sources": [
              "Windows Security Event ID 4688",
              "Sysmon Event ID 1",
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, Authentication servers, User workstations with privileged access",
            "action": [
              "Create a critical alert that triggers if the lsass.exe process spawns any child process, as captured by Windows Security Event ID 4688 or Sysmon Event ID 1. This behavior is almost exclusively malicious and is a strong indicator of credential theft and collection in progress.",
              "For child processes of other sensitive parents (e.g., winlogon.exe), analyze the destination of their network connections (Zeek conn.log). A connection to a destination IP/port combination that is statistically rare for the enterprise (e.g., has a prevalence of less than 0.01%) is a strong indicator of collection activity.",
              "Use a graph-based anomaly detection model where nodes represent processes and network endpoints. Identify anomalous subgraphs, such as a critical process spawning a previously unseen child process that connects to a new external destination, which deviates significantly from the learned 'normal' enterprise activity graph."
            ]
          },
          {
            "description": "A host exhibits a significant and anomalous increase in outbound data volume to a new or rare destination, occurring shortly after the execution of a process potentially associated with API hooking.",
            "data_sources": [
              "Zeek conn.log",
              "Windows Security Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Network egress points, Core network switches, Host-based firewalls, Internet Gateway",
            "action": [
              "Alert when the total outbound data (orig_bytes from Zeek conn.log) from a single host to a single destination IP exceeds a hard threshold (e.g., 100MB in 1 hour), provided the destination is not on a pre-approved allow-list for services like cloud backup or large file transfers.",
              "For each host, model the expected daily outbound data volume using a time-series analysis (e.g., Holt-Winters). An observation that exceeds a dynamic threshold, such as the 99th percentile of the trailing 30-day distribution for that host, indicates a statistically significant spike in traffic warranting investigation for data exfiltration.",
              "Use a K-Means clustering algorithm on network flow features (total bytes, duration, packets per second, destination ASN) to group flows into 'normal' behaviors (e.g., 'short interactive', 'bulk transfer to known cloud'). Flows that fall into a 'high-volume, long-duration' outlier cluster, especially to a rare destination, are flagged as potential exfiltration channels."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk"
    ]
  }
]