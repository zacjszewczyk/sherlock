[
  {
    "information_requirement": "Is the adversary using an internal system as a proxy for Command and Control? (PIR)",
    "tactic_id": "TA0011",
    "tactic_name": "Command and Control",
    "indicators": [
      {
        "technique_id": "T1090.001",
        "name": "Internal Proxy",
        "evidence": [
          {
            "description": "A process creation event is observed for a known proxy tool, followed by a connection from the same host to a known malicious external endpoint within a 5-minute time window.",
            "data_sources": [
              "Windows Event ID 4688",
              "Zeek conn.log",
              "Zeek dns.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Workstations, Application Servers, Domain Controllers, Network Egress Points",
            "action": [
              "Correlate process creation events (Windows Event ID 4688) where the file hash matches a known proxy tool IOC, with subsequent network connections (Zeek conn.log) from the same host to an IP or domain on a C2 threat intelligence feed within 5 minutes.",
              "For hosts executing potential proxy tools, baseline their network behavior by calculating the 95th percentile of outbound data volume (orig_bytes) and connection counts per hour. Alert if, in the hour following the process execution, the host's activity exceeds these established thresholds.",
              "Train a classification model, such as a Random Forest, using features from process creation events (e.g., parent process, command-line entropy, user context) and aggregated network behavior (e.g., number of connections, data volume, port variety) from the subsequent 10 minutes. Use the model to predict the probability that a new process execution is a malicious proxy."
            ]
          },
          {
            "description": "A process execution event for a legitimate utility, such as netsh.exe or ssh.exe, contains command-line arguments indicative of port forwarding or proxy configuration.",
            "data_sources": [
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Jump Servers, Bastion Hosts, Domain Controllers, Developer Workstations",
            "action": [
              "Scan command-line arguments in Windows Event ID 4688 for regular expression patterns associated with port forwarding, such as 'interface portproxy add', 'ssh -L', 'ssh -R', or 'plink.exe -L'.",
              "For each host and common utility (e.g., 'netsh.exe'), build a historical set of unique command-line argument tokens. For each new execution, calculate the Jaccard similarity between its argument tokens and the historical set. Alert on commands with a similarity score below a threshold, such as 0.2, indicating a novel and potentially malicious usage pattern.",
              "Train an autoencoder on the character-level or token-level representation of historical command-line arguments for high-risk utilities. Flag new command lines that produce a high reconstruction error, as they are structurally anomalous compared to the learned normal usage."
            ]
          },
          {
            "description": "A network connection recorded in Zeek conn.log shows a mismatch between the destination port's IANA-assigned protocol and the dynamically analyzed protocol in the 'service' field, or the connection's payload exhibits unusually high entropy for that port.",
            "data_sources": [
              "Zeek conn.log",
              "Zeek ssl.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Internal Network Segments (East-West Traffic), Network Egress Points, Server VLANs, DMZ",
            "action": [
              "Create a detection rule that triggers when Zeek conn.log shows a 'service' value of 'ssl', 'http', or 'unknown' on a destination port where that service is not expected (e.g., port 135/rpc, 445/smb, 3389/rdp).",
              "For each common destination port, establish a baseline distribution of payload entropy values from historical network traffic. Alert on new connections where the calculated payload entropy exceeds the 99th percentile for that port, suggesting encrypted or packed data in an unexpected tunnel.",
              "Develop a multivariate time-series forecasting model, such as VAR or LSTM, for key network segments, predicting the expected volume of traffic per protocol (e.g., http, smb, dns) in 15-minute intervals. Generate an alert when the observed traffic mix significantly deviates from the forecast, particularly with a surge in 'unknown' or 'ssl' traffic on non-standard ports."
            ]
          },
          {
            "description": "An internal host, not a designated gateway, acts as a network aggregator, receiving connections from numerous internal systems and funneling that traffic to a small number of external destinations.",
            "data_sources": [
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Internal Network Segments (East-West Traffic), Workstation VLANs, DMZ",
            "action": [
              "Maintain an allowlist of designated proxy servers and gateways. Alert on any host not on this list that receives connections from more than 15 unique internal source IPs while only connecting to 1-2 unique external destination IPs within a 1-hour window.",
              "Over a rolling 24-hour window, calculate a 'funnel ratio' for each host: (COUNT(DISTINCT internal_source_IPs) / COUNT(DISTINCT external_destination_IPs)). Establish a baseline mean and standard deviation for this ratio per host role. Alert when a host's ratio exceeds 3 standard deviations above its role's baseline mean.",
              "Model internal network traffic (Zeek conn.log) as a directed graph. Periodically calculate the 'betweenness centrality' for each node (host). Use a change point detection algorithm to identify hosts whose centrality score abruptly and significantly increases, indicating they have become a critical bridge for traffic, a characteristic of an internal proxy."
            ]
          },
          {
            "description": "A new, long-duration network connection is observed between two internal endpoints, such as workstation-to-workstation, that have no history of communication over a 30-day baseline.",
            "data_sources": [
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Workstation VLANs, Server VLANs, Interfaces between security zones",
            "action": [
              "Maintain a baseline set of all unique (source_ip, dest_ip, dest_port) tuples observed over the last 30 days. Alert on any new connection that does not match a tuple in this baseline, has a duration greater than 1 hour, and occurs between two non-server endpoints.",
              "For each internal source-destination IP pair, calculate the daily connection count and total duration. Establish a baseline where the norm for most pairs is zero. Alert on any pair that transitions from a zero-count baseline to having a connection duration in the top 5% (95th percentile) of all network connections for that day.",
              "Train a link prediction model on a graph of the network's 30-day communication baseline. For each new connection observed, use the model to predict the probability of that link's existence. Connections with a very low predicted probability are flagged as highly anomalous and potential C2 channels."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk",
      "Ask Sage"
    ]
  }
]