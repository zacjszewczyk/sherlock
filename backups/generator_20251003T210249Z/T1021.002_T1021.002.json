[
  {
    "information_requirement": "Is the adversary moving laterally through the network using Windows admin shares?",
    "tactic_id": "TA0008",
    "tactic_name": "Lateral Movement",
    "indicators": [
      {
        "technique_id": "T1021.002",
        "name": "SMB-Windows Admin Shares",
        "evidence": [
          {
            "description": "A file with a known-malicious hash is transferred to a Windows administrative share (C$, ADMIN$) via SMB, and is subsequently executed on the target host.",
            "data_sources": [
              "Zeek smb_files.log",
              "Zeek files.log",
              "Windows Event ID 4688",
              "Windows Event ID 5145"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, File Servers, Database Servers, Developer Workstations, Executive Laptops",
            "action": [
              "Create a correlation rule that triggers when: 1) A detailed file access event (Windows Event ID 5145) shows access to a share ending in '$'. 2) A Zeek smb_files.log entry shows a file write to that same host. 3) The file hash from Zeek files.log or an EDR agent matches a known-bad hash from a threat intelligence feed. 4) A process creation event (Windows Event ID 4688) for that file path occurs on the destination host within 5 minutes. An alert is generated upon a full sequence match with a known-bad hash.",
              "For each executable file identified in Zeek smb_files.log being transferred to an administrative share, calculate the file's entropy using the data from Zeek files.log. Establish a baseline entropy distribution for legitimate executables in the environment from a software inventory. Generate a statistical alert if a transferred file's entropy exceeds the 98th percentile of the baseline, as this indicates potential packing or encryption. Increase alert severity if this high-entropy file is subsequently executed (Windows Event ID 4688).",
              "Train a supervised classification model (e.g., Gradient Boosting, Random Forest) on labeled historical data of file transfers over admin shares. Extract features such as: file entropy, PE header details (imports, sections), file size, source/destination IP reputation, user account role, time-of-day, and whether the transfer is workstation-to-workstation. The model will output a probability score for each transfer being malicious. Alert on transfers with a probability score above a tuned threshold (e.g., 0.85)."
            ]
          },
          {
            "description": "A new service or named pipe is created on a host, and its name matches a known pattern associated with lateral movement tools (e.g., PsExec, Cobalt Strike), within a short time window following an inbound SMB connection (Logon Type 3).",
            "data_sources": [
              "Windows Event ID 7045",
              "Sysmon Event ID 17",
              "Sysmon Event ID 18",
              "Windows Event ID 4624"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, File Servers, Critical Application Servers, Privileged User Workstations",
            "action": [
              "Create a correlation rule that triggers when a successful network logon (Windows Event ID 4624, Logon Type 3) is followed within 5 minutes on the same host by either a new service creation (Windows Event ID 7045) or a named pipe creation event (Sysmon Event ID 17). The rule should check the 'ServiceName' or 'PipeName' field against a list of regular expressions for known malicious tools (e.g., PSEXESVC, msagent_.*, postex_.*, csexec). A match generates a high-severity alert.",
              "For all service names (Windows Event ID 7045) and named pipe names (Sysmon Event ID 17), calculate a character-level trigram frequency model from a 30-day baseline of all names in the environment. For each new name, compute its probability score based on the baseline model. Alert on names falling below a statistical threshold (e.g., 5th percentile), indicating an unusual character sequence. Prioritize alerts where the creating process is services.exe but the initiating user is not a standard administrative account.",
              "Apply a clustering algorithm (e.g., DBSCAN, Isolation Forest) to service creation (7045) and named pipe (17, 18) events. Vectorize each event using features like: length of the name, entropy of the name, ratio of numeric to alpha characters, the creating user account's rarity, and the parent process name. The model will group normal activity into dense clusters. Investigate any events identified as noise (outliers) by the model as they represent statistically unique and potentially malicious behavior not fitting established patterns."
            ]
          },
          {
            "description": "A successful network logon (Logon Type 3) occurs, followed by access to a default administrative share (e.g., C$, ADMIN$, IPC$), where the source-destination-account triplet is anomalous compared to a historical baseline. Anomalies include workstation-to-workstation admin share access or access from a user account that has never performed this action before.",
            "data_sources": [
              "Windows Event ID 4624",
              "Windows Event ID 5145",
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "All Windows Servers, All Windows Workstations, Network East-West traffic monitoring points, VPN Concentrators",
            "action": [
              "Implement a SIEM rule that alerts on any successful detailed file share event (Windows Event ID 5145) where the ShareName matches '\\\\*\\*$' (e.g., C$, ADMIN$) AND the ObjectType is 'File' AND the source and destination hosts are both categorized as 'workstations' in the asset inventory. Also, alert if the account performing the action is a standard user account, not a member of a privileged administrative group.",
              "Maintain a historical baseline of (user, source_host, destination_host) triplets for administrative share access (Windows Event ID 5145). For each new access event, calculate its rarity. Alert on any access triplet that has not been seen in the last 90 days. Additionally, count the number of distinct destination hosts accessed via admin shares by a single source host in a 1-hour window. Alert if this count exceeds the 99th percentile of the baseline for all source hosts.",
              "Construct a directed graph where nodes are users and hosts, and edges represent admin share access events (Windows Event ID 5145). Train a time-series forecasting model (e.g., Prophet, ARIMA) on the daily count of new, unique edges (first-time access between a user/source/destination triplet). Generate an anomaly alert when the number of new edges in a 24-hour period exceeds the forecasted value's upper confidence bound, suggesting a widespread lateral movement campaign."
            ]
          },
          {
            "description": "The behavioral sequence of an SMB connection to an administrative share, immediately followed by a file write, and then remote process execution of that same file on the destination host, all originating from the same source user/host.",
            "data_sources": [
              "Windows Event ID 4624",
              "Windows Event ID 5145",
              "Zeek smb_files.log",
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Internal network segments, East-West traffic monitoring points, Domain Controllers, Critical Servers",
            "action": [
              "Create a stateful correlation rule that triggers when the following sequence occurs within a 2-minute window from the same source IP and user account to the same destination host: 1. A successful network logon (Windows Event ID 4624, Logon Type 3). 2. Access to an administrative share (Windows Event ID 5145, ShareName ending in '$'). 3. A file write event via SMB (Zeek smb_files.log). 4. A process creation event (Windows Event ID 4688) where the process name matches the file written in the previous step. A full sequence match generates a high-confidence alert.",
              "For each correlated sequence of [SMB Write -> Process Execute], calculate a risk score. Add points for factors like: +10 for executable file type (.exe, .dll, .ps1), +15 for writing to a temporary or unusual directory (%TEMP%, %WINDIR%\\Temp), +20 if the source is a workstation and destination is a workstation, +5 if outside business hours. Establish a threshold (e.g., 25) and generate an alert for any sequence exceeding this score. Periodically tune scores and threshold based on false positive analysis.",
              "Train a sequence-aware model like a Recurrent Neural Network (RNN) or a Hidden Markov Model (HMM) on sequences of user activity logs (logon, file access, process creation). The model learns the probability of transitioning between event types for benign and malicious sequences. For each user session, feed the event sequence into the model. If the model assigns a high probability to the sequence belonging to the 'Lateral Movement' class or hidden state, generate an alert for investigation."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk",
      "Ask Sage"
    ]
  }
]