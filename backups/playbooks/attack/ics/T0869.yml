name: T0869: Standard Application Layer Protocol
id: 9e1b3c2d-8a7f-4b6e-9c5d-0f1e2d3c4b5a
description: This playbook helps determine if an adversary is leveraging standard application layer protocols (e.g., DNP3, Modbus, HTTP, RDP) for command and control within an ICS network. It focuses on identifying C2 activity hidden within legitimate traffic by detecting the use of standard protocols on non-standard ports, analyzing traffic for statistical deviations from established baselines (such as unusual data volumes, function codes, or metadata entropy), and identifying anomalous remote access patterns (like RDP logons from external IPs, at unusual times, or for extended durations).
type: technique
related:
  - TA0101: Command And Control
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are critical ICS protocols (like DNP3, Modbus, RDP) being used on non-standard, unapproved ports across critical network boundaries?
    context: This question aims to detect a common C2 evasion technique where adversaries use legitimate application protocols on non-standard ports to bypass simple, port-based firewall rules. By identifying traffic that uses a known protocol fingerprint but an unexpected destination port, analysts can uncover covert channels, especially when this traffic crosses sensitive network segments like the IT/OT boundary or involves external IP addresses.
    answer_sources:
      - Zeek conn.log
      - Zeek service.log
      - IT/OT Demarcation Points (e.g., firewalls, DMZ)
      - ICS Zone Gateways
      - Enterprise Network Perimeter
      - Internet Proxies
      - Engineering Workstations (EWS)
      - Human-Machine Interfaces (HMIs)
      - SCADA Servers
      - PLCs, RTUs
      - Jump Servers
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH network_logs WHERE protocol_identified IN (dnp3, modbus, rdp) AND destination_port NOT IN (approved_ports_for_protocol) AND (connection_crosses_boundary OR destination_ip_is_external)
  - question: Are there any service-port combinations being used that are statistically rare for the organization's network?
    context: This question focuses on finding outliers through frequency analysis. Adversaries may use legitimate but infrequently used service-port pairs for C2 to remain undetected. By establishing a baseline of normal port usage for each application protocol and then flagging connections that fall into the lowest percentile, analysts can proactively identify potential C2 channels that don't violate a hard-coded rule but are statistically anomalous.
    answer_sources:
      - Zeek conn.log
      - Zeek service.log
      - IT/OT Demarcation Points (e.g., firewalls, DMZ)
      - ICS Zone Gateways
      - Enterprise Network Perimeter
      - Internet Proxies
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: AGGREGATE network_logs over 30 days GROUP BY protocol, port | CALCULATE frequency | FILTER port_frequency < 5th_percentile_for_protocol | ALERT on new connections matching rare pairs
  - question: Are there any network connections that are flagged as anomalous by a machine learning model trained on historical connection data?
    context: This question leverages unsupervised machine learning to detect novel or complex anomalies that rule-based methods might miss. An Isolation Forest model learns the profile of 'normal' network connections based on multiple features (protocol, port, duration, data volume, etc.). It can then identify connections that are statistically different from the established norm, which could represent adversary C2 activity.
    answer_sources:
      - Zeek conn.log
      - Zeek service.log
      - IT/OT Demarcation Points (e.g., firewalls, DMZ)
      - ICS Zone Gateways
      - Enterprise Network Perimeter
      - Internet Proxies
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: SCORE new_network_connections using trained_isolation_forest_model | ALERT where anomaly_score > threshold
  - question: Are any DNP3 devices communicating using function codes that are not explicitly allowed for that specific master-outstation pair?
    context: This question targets misuse of the DNP3 protocol itself. In a stable ICS environment, communication between a master and an outstation uses a predictable set of function codes. An adversary attempting to manipulate a device might use unexpected or malicious function codes. By enforcing a strict allowlist of function codes for each critical communication path, analysts can immediately detect and respond to unauthorized protocol behavior.
    answer_sources:
      - Zeek dnp3.log
      - Windows Event ID 4688
      - Engineering Workstations (EWS)
      - SCADA Servers
      - Historian Servers
      - Human-Machine Interfaces (HMIs)
      - Process Control Networks (PCN) Segments
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH dnp3_logs WHERE (source_ip, destination_ip) is a critical_pair AND function_code NOT IN allowed_list_for_pair | CORRELATE with process_creation_events on source_ip
  - question: Are any ICS hosts sending outbound HTTP requests that are anomalously large or contain unusually random-looking URIs or user-agents?
    context: This question seeks to identify C2 over HTTP by looking for statistical deviations. Adversary C2 often involves transmitting data, which can cause a spike in outbound traffic volume. Furthermore, command-and-control URIs and custom user-agents can have higher entropy (randomness) than legitimate web traffic. By baselining these metrics for each host and alerting on significant deviations, analysts can spot potential HTTP-based C2.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Engineering Workstations (EWS)
      - SCADA Servers
      - Historian Servers
      - Human-Machine Interfaces (HMIs)
      - DMZ Web Servers
      - Enterprise Proxies
      - Internet Gateways
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: FOR each host, CALCULATE baseline (95th_percentile_bytes, mean/stddev_entropy) | SEARCH http_logs WHERE (bytes > baseline_bytes) OR (entropy(uri) > 3*stddev_from_mean) OR (entropy(user_agent) > 3*stddev_from_mean)
  - question: Does the overall communication pattern between a master-outstation pair deviate significantly from its learned normal operational rhythm, as identified by a time-series anomaly detection model?
    context: This question employs a sophisticated machine learning approach (LSTM Autoencoder) to understand the 'rhythm' of ICS communications over time. The model learns the complex, time-dependent relationships between various metrics (message counts, function code usage, etc.). An alert is generated when current activity cannot be accurately 'reconstructed' by the model, indicating a significant break from the established operational pattern, which could be caused by C2.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek dnp3.log
      - Zeek modbus.log
      - Engineering Workstations (EWS)
      - SCADA Servers
      - Process Control Networks (PCN) Segments
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: AGGREGATE network_logs into time_windows | SCORE new_time_windows using trained_lstm_autoencoder | ALERT where reconstruction_error > threshold
  - question: Has a critical ICS asset experienced a successful RDP logon from an external, non-allowlisted IP address?
    context: This question addresses a high-risk scenario: direct remote access to a critical ICS asset from the internet. RDP is a common vector for attack and C2. Any successful logon from an external IP that has not been explicitly vetted and approved on an allowlist is a major security incident and requires immediate investigation.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek rdp.log
      - Engineering Workstations (EWS)
      - Human-Machine Interfaces (HMIs)
      - SCADA Servers
      - Jump Servers/Bastion Hosts
      - Domain Controllers
      - Remote Access VPN Concentrators
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: SEARCH authentication_logs WHERE event_id = 4624 AND logon_type = 10 AND source_ip_is_external AND source_ip NOT IN rdp_allowlist | ALERT
  - question: Did a user log on to a critical ICS asset at a statistically unusual time or maintain a session for an abnormally long duration compared to their established baseline?
    context: This question seeks to identify compromised credentials by looking for behavioral anomalies. Adversaries using stolen accounts may not adhere to the legitimate user's normal work schedule or session patterns. By profiling each user's typical logon times and session durations on specific assets, analysts can detect deviations that suggest account misuse, such as a logon in the middle of the night or a session that lasts for days.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4634
      - Engineering Workstations (EWS)
      - Human-Machine Interfaces (HMIs)
      - SCADA Servers
      - Jump Servers/Bastion Hosts
      - Domain Controllers
      - Active Directory Servers
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: FOR each user-asset_pair, CALCULATE baseline (mean/stddev_logon_hour, 95th_percentile_duration) | SEARCH authentication_logs WHERE (logon_hour > 3*stddev_from_mean) OR (session_duration > 95th_percentile) | ALERT
  - question: Has a graph-based machine learning model detected an RDP connection that is highly improbable based on historical user-to-asset connection patterns?
    context: This question uses graph analytics to model relationships within the network. A graph model learns which users typically access which assets. It can then detect anomalous connections, such as a user from the IT department suddenly accessing a sensitive PLC for the first time. This is effective for spotting lateral movement or privilege escalation that deviates from established organizational roles and workflows.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek rdp.log
      - Engineering Workstations (EWS)
      - Human-Machine Interfaces (HMIs)
      - SCADA Servers
      - Jump Servers/Bastion Hosts
      - Domain Controllers
    range: last 90 days
    queries:
      - search_technology: Pseudocode
        query: MODEL user_asset_rdp_connections as a graph | SCORE new_rdp_connections using trained_graph_model | ALERT on connections with high_anomaly_score