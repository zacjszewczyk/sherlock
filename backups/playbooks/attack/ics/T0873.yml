name: T0873: Project File Infection
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary is attempting to achieve persistence by modifying Industrial Control System (ICS) project files. It focuses on detecting anomalous file modifications on engineering workstations or project file servers (e.g., changes by unauthorized users or at unusual times), identifying suspicious network connections to Programmable Logic Controller (PLC) engineering ports (e.g., from non-approved hosts or with unusually large data transfers), and recognizing high-fidelity attack patterns such as a PLC mode change immediately followed by a large data download.
type: technique
related:
  - TA0110: Persistence
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are ICS project files being modified by unauthorized users or outside of scheduled maintenance windows?
    context: This question aims to detect blatant policy violations. Modifying critical ICS project files requires strict change control. Any modification by an account not designated for engineering tasks, or changes occurring outside of a documented maintenance period, is a high-fidelity indicator of potential malicious activity, such as an adversary injecting malicious code into a project file to gain persistence or disrupt operations. Correlating this with the source IP address adds another layer of verification, ensuring the change originates from an approved physical or virtual location.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4656
      - Windows Event ID 5145
      - Sysmon Event ID 11
      - Zeek smb_files.log
      - NAI: ICS Project File Shares and Engineering Workstations (EWS) within the Corporate IT, DMZ, or Process Control Network (PCN).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          search (file_audit_logs OR file_creation_logs)
          where (file_extension IN ['.ACD', '.S7P', '.L5K', '.RSS', '.ap16', '.pro', '.tpzip', '.pcw', '.wsp', '.XEF'])
          and ( (user NOT IN 'Authorized_ICS_Engineers') OR (event_time NOT IN 'Maintenance_Windows') )
          correlate with network_share_logs to check if (source_ip NOT IN 'Approved_EWS_IPs')
          alert if conditions are met
  - question: Is an authorized user accessing an unusually high number or diverse set of project files compared to their normal behavior?
    context: Even authorized users can be compromised. This question focuses on detecting behavioral anomalies. A sudden spike in the number of unique project files accessed by a single user, or access to project directories they don't normally work with (indicated by an increase in path entropy), can indicate their account has been compromised and is being used for reconnaissance or to deploy malicious logic across multiple projects. This statistical approach helps find subtle deviations that might be missed by simple rule-based alerts.
    answer_sources:
      - Sysmon Event ID 11
      - NAI: ICS Project File Shares and Engineering Workstations (EWS).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          for each user in 'Authorized_ICS_Engineers':
            calculate 30-day_baseline(mean, stdev of unique_files_per_hour)
            calculate 4-week_baseline(avg_entropy of parent_folder_paths)
          
          alert if current_hour_unique_file_count > mean + (3 * stdev)
          alert if current_week_folder_entropy is significantly higher than baseline
  - question: Does a file modification event exhibit a statistically rare combination of user, host, process, and time, suggesting it is an outlier from normal activity?
    context: This question leverages machine learning to identify complex and novel anomalies that are difficult to define with static rules. An Isolation Forest or similar model can learn the multi-dimensional profile of "normal" engineering activity. An alert is triggered when a file modification event is flagged as an outlier, meaning its combination of features (e.g., a non-standard process like 'powershell.exe' modifying a project file, or an engineer accessing a file from a non-EWS host late at night) is highly unusual and warrants investigation as a potential threat.
    answer_sources:
      - Sysmon Event ID 11
      - Windows Event ID 4663
      - NAI: ICS Project File Shares and Engineering Workstations (EWS).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          feature_vector = [user, source_host, process_name, parent_process, hour_of_day, day_of_week, file_extension]
          train IsolationForest model on 90+ days of historical log data
          for each new file_modification_event:
            score = model.predict(event_feature_vector)
            alert if score is in top 1% of anomaly scores
  - question: Are network connections to PLC engineering ports originating from unauthorized hosts or being initiated by non-standard engineering applications?
    context: Access to PLCs over engineering protocols should be strictly limited to designated Engineering Workstations (EWS). This question seeks to identify unauthorized network access, a primary vector for attacks. An alert on a connection from a non-EWS host is a critical finding. Furthermore, even on an authorized EWS, the connection should be initiated by approved engineering software (e.g., 'Studio5000.exe'). A connection from a generic utility like 'powershell.exe' or a custom script could indicate a compromised EWS is being used to manipulate the PLC.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 5156
      - NAI: Network segments within the ICS DMZ (Level 3.5) and Process Control Network (Levels 2/1), and the Engineering Workstations that access them.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          search (network_connection_logs)
          where (destination_port IN [102, 502, 1217, 20000, 44818]) AND (destination_asset_type IS 'PLC')
          if (source_ip NOT IN 'Authorized_EWS_Asset_Group'):
            alert (high_severity)
          else:
            get process_name from host_logs using (5-tuple, timestamp)
            if (process_name NOT IN 'Approved_Engineering_Software_List'):
              alert (medium_severity)
  - question: Is a network connection to a PLC from an authorized host exhibiting unusually high data volume or duration, or is it a 'first-time talker'?
    context: This question aims to detect anomalous behavior within otherwise legitimate communication channels. A 'first time talker' (a new EWS-to-PLC communication pair) is inherently suspicious and requires validation. For established pairs, routine interactions like status checks involve small amounts of data. A sudden, massive increase in data transfer volume or connection duration is a strong indicator that a large file, such as a modified project, is being downloaded to the PLC, which is a rare and critical event outside of planned maintenance.
    answer_sources:
      - Zeek conn.log
      - NAI: Network segments within the ICS DMZ and PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          build 30-day_baseline of (source_ip, dest_ip, dest_port) tuples where dest_asset_type is 'PLC'
          alert on any new tuple ('first time talker' anomaly)

          for each existing legitimate tuple:
            calculate 99th_percentile(bytes_sent) from baseline
            calculate 99th_percentile(duration) from baseline
          alert if current_connection.bytes_sent > 99th_percentile OR current_connection.duration > 99th_percentile
  - question: Does a network connection to a PLC fall outside the normal clusters of activity, identifying it as a statistical outlier?
    context: This question uses unsupervised machine learning to find anomalous connections without pre-defined rules. DBSCAN can automatically group the vast majority of "normal" connections (e.g., frequent, short, low-data polling) into dense clusters. Any connection that does not fit into these clusters is labeled as "noise" or an outlier. These outliers are inherently suspicious because they represent rare and unusual events, such as a high-volume data transfer for a project download or a connection at an odd time, making them prime candidates for investigation.
    answer_sources:
      - Zeek conn.log
      - NAI: Network segments within the ICS DMZ and PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          feature_vector = [duration, bytes_sent, bytes_received, service, hour_of_day, day_of_week]
          apply DBSCAN algorithm to historical connection logs for PLC engineering ports
          for each new connection:
            predict cluster
            alert if connection is labeled as 'noise' (outlier)
  - question: Has a PLC mode change command been immediately followed by a large data transfer to that same PLC?
    context: The sequence of changing a PLC's mode from RUN to PROGRAM/STOP and then immediately performing a large file write is the classic signature of a project download. This question looks for this specific, high-fidelity attack pattern. Detecting this sequence in near-real-time provides a strong indication that an adversary is attempting to overwrite the controller's logic. The stateful nature of the rule, which links two separate events over a short time window, is critical for minimizing false positives.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek dnp3.log
      - Zeek modbus.log
      - NAI: Process Control Network (Level 2/1) segments.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          on event (PLC_mode_change to 'PROGRAM' or 'STOP') for PLC_ip from protocol_logs:
            start monitoring network_logs for 5 minutes for connections to PLC_ip
            if (connection_bytes > 500KB OR connection_bytes > 4 * stdev(PLC_baseline_bytes)):
              alert (high_severity) with details (source_host, PLC_ip, mode_change_function, byte_count)
  - question: Is an unusual frequency of 'write' commands to a PLC correlated with an unusually large data transfer to that same PLC?
    context: This question provides another way to detect a project download by correlating two different anomalous metrics. An adversary might issue multiple individual write commands as part of a download process. By alerting only when both the frequency of writes and the total data volume are anomalous compared to the PLC's baseline, we can increase our confidence that a significant and potentially malicious change is occurring, rather than routine parameter adjustments.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek modbus.log
      - NAI: Process Control Network (Level 2/1).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          for each PLC:
            calculate hourly_baseline(mean, stdev of 'write/download' function frequency)
            calculate 95th_percentile(connection_bytes)
          
          if (current_hour_write_count > mean + (3 * stdev)) AND (related_connection_bytes > 95th_percentile_bytes):
            alert (medium_severity)
  - question: Does a sequence of interactions with a PLC have a low probability of occurring based on a model trained on normal operational sequences?
    context: This is an advanced question using a sequence-aware model to understand the 'grammar' of normal PLC interactions. Models like HMMs or LSTMs learn the typical order of events (e.g., a status read is common, a mode change is rare, a mode change followed by a large download is extremely rare). When a new sequence of events is observed that has a very low probability according to the trained model, it signals a significant and potentially malicious deviation from normal operations. This can detect sophisticated, multi-step attacks that other methods might miss.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - NAI: Process Control Network (Level 2/1).
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          abstract network logs into event stream per PLC: (timestamp, event_type, event_value)
          // Event Types: 'PLC_MODE_CHANGE', 'PLC_FUNCTION_CALL', 'CONNECTION_STATS'
          train HMM or LSTM model on historical event streams to learn transition probabilities
          for each new observed sequence of events:
            calculate probability_score using model
            alert if probability_score < low_probability_threshold