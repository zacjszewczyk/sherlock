name: 'T0843: Program Download'
id: 5e6a9f81-2c7b-4d3a-9e0f-1a9b8c7d6e5f
description: This playbook focuses on detecting adversary attempts to modify Industrial Control System (ICS) controller logic via a program download. The investigation covers several angles: identifying program downloads from unauthorized sources or outside of maintenance windows; detecting anomalous sequences of commands like stopping a PLC before a download; correlating network events with suspicious host activity on Engineering Workstations (EWS), such as logons or process creations from unapproved accounts; and using statistical and machine learning methods to spot deviations from normal engineering activity, such as unusual download frequency, modifications to rarely-changed code blocks, or anomalous command sequences.
type: technique
related:
  - 'TA0109: Lateral Movement'
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
  - question: Is a program download or write operation originating from an unauthorized IP address or occurring outside a maintenance window?
    context: This question aims to detect a direct attempt to modify controller logic from an unauthorized source or at an unusual time. A program download from a non-EWS IP is a strong indicator of compromise, as this activity should be restricted to authorized engineering personnel and workstations. Similarly, modifications outside of planned maintenance windows are highly suspicious and could indicate an adversary's attempt to disrupt operations or install malicious logic.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Network choke points such as firewall and switch SPAN ports monitoring traffic between the IT/OT DMZ and the Process Control Network (PCN), Engineering Workstation subnet, and network taps at key aggregation points in the PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Zeek s7.log WHERE function IN ('Download Block', 'Write Var') | JOIN conn.log ON UID | IF source_ip NOT IN allow_list THEN ALERT (High) | IF timestamp NOT IN maintenance_window THEN ALERT (Medium)
  - question: Is there a statistically significant spike in program download activity for a specific PLC outside of a maintenance window?
    context: This question focuses on identifying anomalous volumes of program downloads. Adversaries may perform multiple downloads as they test or refine malicious logic. By establishing a historical baseline of normal activity, a statistical deviation (e.g., more than three standard deviations from the mean) can effectively flag suspicious, high-frequency modification attempts that might otherwise be missed.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Network choke points such as firewall and switch SPAN ports monitoring traffic between the IT/OT DMZ and the Process Control Network (PCN), Engineering Workstation subnet, and network taps at key aggregation points in the PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each PLC | BASELINE hourly download counts over 90 days (non-maintenance) -> mean(μ), stddev(σ) | SEARCH current hour downloads | IF current_count > μ + 3σ THEN ALERT
  - question: Does a program download event show anomalous characteristics when compared to historical engineering activity?
    context: This question uses machine learning to detect subtle anomalies that rule-based methods might miss. An Isolation Forest model can learn the complex patterns of legitimate program downloads, considering features like source/destination IPs, time of day, connection duration, and data volume. An event with a high anomaly score represents a combination of feature values that is rare and unexpected, warranting investigation as a potential threat.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Network choke points such as firewall and switch SPAN ports monitoring traffic between the IT/OT DMZ and the Process Control Network (PCN), Engineering Workstation subnet, and network taps at key aggregation points in the PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN Isolation Forest model on historical s7.log and conn.log features | FOR new download event | CALCULATE anomaly_score | IF score is high THEN ALERT
  - question: Did a remote logon or process creation by an unauthorized user or application on an EWS immediately precede a network connection to a PLC?
    context: This question correlates host-based activity on an EWS with network connections to a PLC to identify suspicious command-and-control sequences. An adversary gaining remote access to an EWS (Logon Type 3 or 10) and then immediately connecting to a PLC is a classic lateral movement pattern. By checking the user and process against an allow-list, this query can quickly pinpoint unauthorized activity originating from a compromised but otherwise trusted EWS.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Zeek conn.log
      - Engineering Workstations (EWS)
      - Active Directory domain controllers
      - centralized SIEM/log aggregation platform
      - network sensors monitoring traffic between the EWS subnet and the PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON PLC connection from EWS | SEARCH for recent (60s) logon (4624) or process creation (4688) on EWS | IF user OR process_name NOT IN allow_list THEN ALERT
  - question: Is a PLC connection being initiated by a user, process, and destination PLC combination that has never been seen before or is historically rare?
    context: This question focuses on detecting novel or infrequent activity patterns on Engineering Workstations. Legitimate engineering tasks typically involve a predictable set of users, software, and target PLCs. A new combination (a "first-ever" tuple) is highly suspicious and could indicate an adversary using a new tool or accessing a PLC they normally wouldn't. Similarly, a very rare combination could represent a seldom-used, potentially malicious tool.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Zeek conn.log
      - Engineering Workstations (EWS)
      - Active Directory domain controllers
      - centralized SIEM/log aggregation platform
      - network sensors monitoring traffic between the EWS subnet and the PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE frequency of (User, Process, Destination_PLC) tuples over 30 days | FOR new PLC connection | IF tuple is new OR frequency < 5th percentile THEN ALERT
  - question: Is a process initiating a PLC connection classified as malicious by a machine learning model?
    context: This question uses a supervised machine learning model (Random Forest) to proactively identify malicious processes on an EWS. By training the model on features from known-good and known-bad processes (e.g., parent process, command-line arguments), it can classify new processes with high accuracy. An alert from this model, especially when the process is seen connecting to a PLC, provides a high-confidence signal that an adversary is using custom or known-malicious tools on the EWS to interact with the control system.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Zeek conn.log
      - Engineering Workstations (EWS)
      - Active Directory domain controllers
      - centralized SIEM/log aggregation platform
      - network sensors monitoring traffic between the EWS subnet and the PCN.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN Random Forest model on EWS process data (4688) | FOR new process initiating PLC connection | CLASSIFY process | IF classification is 'malicious' AND confidence > 0.90 THEN ALERT
  - question: Has a PLC been stopped and then reprogrammed within a short time frame by an unauthorized source or outside a maintenance window?
    context: This question looks for a specific, high-risk sequence of events, stopping a controller and then immediately modifying its logic. This is a standard procedure for legitimate programming but is also a powerful technique for an adversary to deploy malicious code. By correlating the 'Stop' command with a subsequent 'Download', and then checking the source and time against allow-lists, this query can effectively detect unauthorized and potentially disruptive reprogramming attempts.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Process Control Network (PCN) segments monitored by network sensors, specifically traffic to and from critical PLCs, and a centralized log analysis platform capable of stateful sequence detection.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON 'Stop CPU' command | WATCH for 'Download Block' or 'Write Var' from same source to same PLC within 5 mins | IF sequence occurs AND (source_ip NOT IN allow_list OR time NOT IN maintenance_window) THEN ALERT (High)
  - question: Is the time delay between stopping a PLC and downloading new logic abnormally fast or slow compared to historical maintenance activity?
    context: This question seeks to identify deviations in the timing of a standard engineering workflow. Automated attack scripts may perform the stop-and-download sequence much faster than a human engineer, while a cautious, interactive attacker might be much slower. By baselining the normal time delta for this sequence during legitimate maintenance, any significant deviation from this range can indicate non-standard activity that warrants investigation.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Process Control Network (PCN) segments monitored by network sensors, specifically traffic to and from critical PLCs, and a centralized log analysis platform capable of stateful sequence detection.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE time delta (Δt) between 'Stop CPU' and 'Download' during maintenance | CALCULATE 5th and 95th percentiles | FOR new stop->download sequence | IF Δt is outside percentile range THEN ALERT
  - question: Does the sequence of commands being sent to a PLC deviate from the normal operational and maintenance sequences learned by a Hidden Markov Model?
    context: This question uses a sophisticated probabilistic model (HMM) to understand the "grammar" of legitimate PLC interactions. The model learns the likely sequences of states (e.g., Running -> Stopping -> Programming) from known-good data. An attack sequence, even if it uses legitimate commands, may follow a path that is highly improbable according to the model. An alert based on a low probability score indicates that the sequence of interactions is anomalous and potentially malicious.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Process Control Network (PCN) segments monitored by network sensors, specifically traffic to and from critical PLCs, and a centralized log analysis platform capable of stateful sequence detection.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN HMM on S7 command sequences from known-good maintenance periods | FOR live command sequence (e.g., Stop -> Download) | CALCULATE probability score using HMM | IF score is low THEN ALERT
  - question: Is an online program modification being performed from an unauthorized IP address or targeting a critical controller?
    context: This question targets "hot patching" or online editing, a feature that allows logic changes without stopping the controller. While a useful feature, it can be abused by an adversary to make stealthy modifications. This query detects such edits and immediately flags them if the source is not an authorized EWS. The alert's importance is increased if the activity happens at an unscheduled time or targets a safety or critical process controller, indicating a higher potential for impact.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Network sensor taps monitoring traffic between the Engineering Zone and the Process Control Zone, particularly traffic destined for Safety Instrumented Systems (SIS) or critical process controllers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for S7 online edit functions (e.g., 'Insert Block') | IF source_ip NOT IN allow_list THEN ALERT | ESCALATE if time NOT IN maintenance_window OR target is critical_controller
  - question: Is an online edit targeting a logic block that is rarely or never modified during normal operations?
    context: This question aims to detect unusual modifications to stable parts of the PLC code. Certain logic blocks in a controller's program are foundational and rarely change after commissioning. An adversary, unaware of normal operational procedures, might target these stable blocks to implement persistence or cause disruption. By baselining which blocks are commonly modified, an alert on an edit to a rarely-touched block can be a strong indicator of malicious activity.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Network sensor taps monitoring traffic between the Engineering Zone and the Process Control Zone, particularly traffic destined for Safety Instrumented Systems (SIS) or critical process controllers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE frequency of modified block numbers per PLC over 180 days | FOR new online edit | IF block_number modification frequency < 5th percentile THEN ALERT
  - question: Does an online edit event fail to cluster with any known groups of normal historical activity?
    context: This question uses an unsupervised clustering algorithm (DBSCAN) to define "normal" behavior without pre-labeled data. The algorithm groups historical online edit events into clusters based on their features (source, destination, block number, time, etc.). Any new event that doesn't fit into an existing cluster is labeled as "noise" or an outlier. These noise points represent highly anomalous events that do not conform to any established pattern of activity and are strong candidates for malicious behavior.
    answer_sources:
      - Zeek s7.log
      - Zeek conn.log
      - Network sensor taps monitoring traffic between the Engineering Zone and the Process Control Zone, particularly traffic destined for Safety Instrumented Systems (SIS) or critical process controllers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY DBSCAN to historical online edit events | FOR new online edit event | IF event is classified as noise (outlier) THEN ALERT