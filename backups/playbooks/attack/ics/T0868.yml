name: 'T0868: Detect Operating Mode'
id: 'a1b9e02f-5f8a-4c1d-8b3e-7a6f0d9c1b2a'
description: This playbook helps investigate whether an adversary is attempting to determine the operating state of Programmable Logic Controllers (PLCs). This is often done through ICS protocol queries for a device's operating mode, such as Modbus function code 17 or S7COMM 'Read SZL', originating from unauthorized IP addresses. It also covers scenarios where an authorized Engineering Workstation (EWS) exhibits anomalous behavior, such as querying an unusually high number of PLCs, or when PLC queries follow a suspicious remote logon to an EWS (e.g., from a rare geolocation or at an unusual time).
type: technique
related:
  - 'TA0100: Collection'
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
  - question: Has an operating mode query originated from an unauthorized IP address, and if so, was it associated with suspicious process execution on that host?
    context: This question aims to identify unauthorized systems attempting to discover the operating state of PLCs. An operating mode query from an IP not on the authorized EWS watchlist is a strong indicator of reconnaissance. Correlating this with process execution events on the source host helps confirm if the activity was malicious (e.g., initiated by a scanning tool) or a misconfiguration.
    answer_sources:
      - Zeek modbus.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek dnp3.log
      - Zeek conn.log
      - Windows Event ID 4688
      - Network sensors (TAPs/SPANs) at the IT/OT boundary, within the Process Control Network (PCN), and in Cell/Area zones. Log aggregators for Engineering Workstations (EWS), SCADA servers, and data historians.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          // Find unauthorized operating mode queries
          SEARCH Zeek ICS logs (modbus, s7comm, enip) FOR operating_mode_query
          WHERE source_ip NOT IN authorized_ews_watchlist
          RETURN source_ip, destination_ip, timestamp

          // Correlate with suspicious process execution
          SEARCH Windows Event ID 4688
          WHERE source_host_ip IS [source_ip from previous query]
          AND timestamp WITHIN 15 minutes of [timestamp from previous query]
          AND process_name IN ('plcscan.py', 'nmap.exe', etc.)
          RETURN process_name, command_line
  - question: Is an authorized Engineering Workstation (EWS) scanning an unusually high number of PLCs for their operating mode, suggesting a potential compromise?
    context: Even authorized systems can be compromised. This question seeks to detect such a scenario by baselining normal activity. An EWS that suddenly starts querying the operating mode of many more PLCs than it usually does could indicate an adversary using that machine for internal reconnaissance. This statistical approach helps find abuse of legitimate access.
    answer_sources:
      - Zeek modbus.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek dnp3.log
      - Zeek conn.log
      - Windows Event ID 4688
      - Network sensors (TAPs/SPANs) at the IT/OT boundary, within the Process Control Network (PCN), and in Cell/Area zones. Log aggregators for Engineering Workstations (EWS), SCADA servers, and data historians.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          // Detect anomalous scanning from authorized hosts
          SEARCH Zeek ICS logs for operating_mode_queries over the last 90 days
          FOR each 5-minute window:
            CALCULATE count of distinct destination_ips per authorized source_ip
          COMPARE current 5-minute count to the 99th percentile of the past 30-day baseline for that source_ip
          ALERT if current_count > baseline_99th_percentile
  - question: Have there been operating mode queries that deviate from historically normal communication patterns in terms of frequency or timing, as identified by a machine learning model?
    context: This question uses advanced anomaly detection to find subtle deviations that simple thresholding might miss. By modeling the normal rhythm of communication between specific source-destination pairs, a time-series model can flag unusual sequences or timings of queries. This can detect sophisticated adversaries attempting to blend in with normal traffic.
    answer_sources:
      - Zeek modbus.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek dnp3.log
      - Zeek conn.log
      - Windows Event ID 4688
      - Network sensors (TAPs/SPANs) at the IT/OT boundary, within the Process Control Network (PCN), and in Cell/Area zones. Log aggregators for Engineering Workstations (EWS), SCADA servers, and data historians.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          // Apply ML model to detect anomalous queries
          INPUT stream of Zeek ICS operating mode query events
          APPLY pre-trained time-series anomaly detection model (e.g., ARIMA, LSTM)
          MODEL features: frequency, inter-arrival time of queries for each source-destination pair
          ALERT if model output score > defined_threshold
  - question: Has a remote logon from an unauthorized location to an EWS been immediately followed by PLC operating mode queries from that same EWS?
    context: This question aims to link suspicious remote access directly to subsequent reconnaissance activity in the OT network. A logon from an unapproved IP or geographic location is inherently risky. If that session is then used to probe PLCs, it is a strong indicator of an external attacker who has gained a foothold and is now exploring the control environment.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek modbus.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Windows Event ID 4688
      - Log sources on Engineering Workstation (EWS) endpoints, Active Directory Domain Controllers, and remote access infrastructure (VPN concentrators, jump boxes). Network traffic sensors at the IT/OT boundary and monitoring EWS subnets.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          // Correlate suspicious RDP logon with ICS activity
          SEARCH Windows Event ID 4624 WHERE logon_type=10 AND source_ip NOT IN approved_ip_or_geo_list
          JOIN with Zeek ICS logs for operating_mode_query
          WHERE EWS_ip = logon_destination_ip
          AND ICS_query_timestamp is within 30 minutes after logon_timestamp
          ALERT on match
  - question: Has a statistically anomalous remote logon to an EWS been followed by PLC operating mode queries, potentially indicating a compromised user account?
    context: Adversaries may use valid credentials, making access look legitimate at first glance. This question applies user behavior analytics to remote logons to spot anomalies, such as a user logging in from a new country or at an unusual time. By correlating these high-risk logons with subsequent OT reconnaissance, analysts can more effectively detect credential abuse.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek modbus.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Windows Event ID 4688
      - Log sources on Engineering Workstation (EWS) endpoints, Active Directory Domain Controllers, and remote access infrastructure (VPN concentrators, jump boxes). Network traffic sensors at the IT/OT boundary and monitoring EWS subnets.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          // Correlate anomalous user logon with ICS activity
          FOR each new remote logon (Event ID 4624, Type 10):
            CALCULATE anomaly score based on user's historical logon attributes (time, ISP, country)
            IF anomaly_score > 95th_percentile:
              SEARCH Zeek ICS logs for operating mode queries from the EWS IP
              WITHIN 30 minutes after the logon time
              IF match, ESCALATE alert to high priority
  - question: Has an outlier remote logon event, as identified by a UEBA clustering model, been followed by PLC operating mode queries from the associated EWS?
    context: This question uses sophisticated machine learning (clustering) to identify outlier logon events that don't fit into any normal group of activity. These "noise" points are highly suspicious. Correlating them with immediate OT reconnaissance provides a high-fidelity signal that a logon session is likely malicious and part of an attack chain.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek modbus.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Windows Event ID 4688
      - Log sources on Engineering Workstation (EWS) endpoints, Active Directory Domain Controllers, and remote access infrastructure (VPN concentrators, jump boxes). Network traffic sensors at the IT/OT boundary and monitoring EWS subnets.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          // Correlate UEBA outlier logon with ICS activity
          INPUT stream of remote logon events (Event ID 4624, Zeek rdp.log)
          APPLY pre-trained UEBA clustering model (e.g., DBSCAN)
          IF logon is classified as an outlier/noise:
            SEARCH for ICS operating mode queries from the EWS IP
            WITHIN 30 minutes after the logon time
            IF match, GENERATE high-severity alert