name: T0858: Change Operating Mode
id: 55f8b5e0-d4e5-4a64-9842-87c3d1f3e0a1
description: >-
  This playbook helps investigate if an adversary is changing PLC operating modes to evade security controls or execute unauthorized code. This includes detecting mode changes (e.g., to 'PROGRAM', 'REMOTE', or 'STOP') that occur outside of scheduled maintenance windows, originate from unauthorized source IP addresses not on an EWS allowlist, or follow a specific attack sequence (e.g., mode change -> program download -> mode change back to 'RUN'). It also covers scenarios where an unapproved process on an Engineering Workstation (EWS) initiates a network connection to a PLC, immediately followed by a mode change command.
type: technique
related:
  - TA0103: Evasion
  - TA0104: Execution
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a PLC's operating mode been changed outside of a scheduled maintenance window?
    context: >-
      This question aims to identify unauthorized changes to a PLC's operational state (e.g., 'PROGRAM', 'REMOTE', 'STOP'). An adversary might change the mode to halt a process, bypass safety logic, or prepare for uploading malicious code. Correlating mode change commands (S7comm function 0x29 or EtherNet/IP service 0x10) with maintenance schedules helps distinguish legitimate engineering activity from potentially malicious actions. An alert for an out-of-window change is a high-fidelity indicator of a potential compromise.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Maintenance Schedule Data
      - Network monitoring points on Level 1 (Control Network) and Level 2 (Supervisory Network) segments
      - Network monitoring points at the boundary of the Industrial DMZ (IDMZ)
    range: Last 90 days
    queries:
      - "SIEM Pseudocode: PARSE Zeek s7comm.log for function_code == 0x29 OR Zeek enip.log for service_code == 0x10. EXTRACT event_timestamp, src_ip, dest_plc_ip. QUERY maintenance_schedule_db with event_timestamp and dest_plc_ip. IF timestamp NOT IN approved_window THEN ALERT high_severity."
  - question: Is there an abnormal frequency of operating mode changes for a specific PLC?
    context: >-
      This question seeks to detect unusual patterns in PLC mode changes that might indicate automated attacks or reconnaissance. By establishing a baseline of normal activity (e.g., the 99th percentile of hourly mode changes), analysts can identify spikes that deviate from expected behavior, even if the changes occur within a maintenance window. This helps find attackers who might be repeatedly trying to alter a PLC's state.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Maintenance Schedule Data
      - Network monitoring points on Level 1 (Control Network) and Level 2 (Supervisory Network) segments
      - Network monitoring points at the boundary of the Industrial DMZ (IDMZ)
    range: Last 90 days
    queries:
      - "Baseline Pseudocode: FOR each PLC, GROUP mode_change_events by hour, src_ip, dest_ip, day_of_week over 30 days (excluding maintenance). CALCULATE 99th_percentile_threshold. SIEM_Rule: COUNT mode_change_events per hour. IF current_count > 99th_percentile_threshold THEN ALERT."
  - question: Does a recent PLC mode change event have a high anomaly score based on historical patterns?
    context: >-
      This question uses machine learning to identify subtle deviations in PLC mode change activity that might be missed by simple thresholding. A time-series anomaly detection model learns the normal cadence, timing, and context (e.g., source IP subnet, specific mode) of changes for critical PLCs. An event with a high anomaly score suggests that the change is statistically unlikely given past behavior, pointing to a potential novel attack vector or unauthorized activity.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Maintenance Schedule Data
      - Network monitoring points on Level 1 (Control Network) and Level 2 (Supervisory Network) segments
      - Network monitoring points at the boundary of the Industrial DMZ (IDMZ)
    range: Last 90 days
    queries:
      - "ML Model Pseudocode: INPUT features (count_per_hour, mode_type, src_subnet) from new mode_change_event into trained_model (Prophet/LSTM). IF anomaly_score > configured_threshold THEN ALERT."
  - question: Did a PLC mode change command originate from an IP address not on the authorized EWS allowlist?
    context: >-
      This question verifies if the source of a PLC mode change is a trusted, authorized system like an Engineering Workstation (EWS) or jump server. Since changing a PLC's mode is a privileged action, it should only be performed from specific devices. An alert on a mode change from an unknown or unauthorized IP is a strong indicator of a compromised device or an intruder on the network.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Asset Inventory Data
      - Network monitoring on EWS, jump server, and maintenance access point segments
      - Network monitoring on Level 1 (Control Network) and Level 2 (Supervisory Network) segments
      - Industrial firewall logs at the IT/OT boundary
    range: Last 90 days
    queries:
      - "SIEM Pseudocode: ON mode_change_event (s7comm or enip), EXTRACT src_ip. IF src_ip NOT IN authorized_ews_ip_list THEN ALERT."
  - question: Has a PLC mode change been initiated from a source IP address for the very first time?
    context: >-
      This question aims to detect 'first-time' interactions without relying on a static, potentially outdated allowlist. By maintaining a rolling baseline of source IPs that have historically performed mode changes, the system can flag any command originating from a 'new' IP. This is effective for identifying newly compromised devices or an adversary's initial foothold before they are added to any watchlists.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Asset Inventory Data
      - Network monitoring on EWS, jump server, and maintenance access point segments
      - Network monitoring on Level 1 (Control Network) and Level 2 (Supervisory Network) segments
      - Industrial firewall logs at the IT/OT boundary
    range: Last 90 days
    queries:
      - "Baseline Pseudocode: CREATE baseline_set of src_ips from last 30 days of mode_change_events. SIEM_Rule: ON new mode_change_event, EXTRACT current_src_ip. IF current_src_ip NOT IN baseline_set THEN ALERT."
  - question: Was a connection associated with a PLC mode change classified as unauthorized by a machine learning model?
    context: >-
      This question leverages a supervised machine learning model to provide a more nuanced assessment of a connection's legitimacy. The model analyzes a rich set of features (e.g., port, protocol, connection duration, data volume, time of day) beyond just the source IP. This allows it to identify unauthorized activity that might originate from a seemingly legitimate IP (e.g., a compromised EWS) by detecting anomalous network characteristics associated with the connection itself.
    answer_sources:
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Asset Inventory Data
      - Network monitoring on EWS, jump server, and maintenance access point segments
      - Network monitoring on Level 1 (Control Network) and Level 2 (Supervisory Network) segments
      - Industrial firewall logs at the IT/OT boundary
    range: Last 90 days
    queries:
      - "ML Model Pseudocode: ON new connection with mode_change, EXTRACT features (src_port, proto, duration, bytes, etc.). INPUT features into trained_classifier (Random Forest/Gradient Boosting). IF prediction is 'unauthorized' AND confidence > 0.9 THEN ALERT."
  - question: Has the specific attack sequence of 'mode change to program -> program download -> mode change to run' been observed against a PLC?
    context: >-
      This question looks for a high-confidence indicator of a malicious code download. Legitimate program updates may not always follow this exact, rapid sequence. Detecting this specific three-event chain from a single source to a single destination within a short time frame (e.g., 15 minutes) strongly suggests an adversary is attempting to replace the PLC's logic.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Network monitoring points on Level 1 (Control Network) segments
      - Network monitoring points on Level 2 (Supervisory Network) segments
    range: Last 90 days
    queries:
      - "Stateful SIEM Pseudocode: TRACK ICS events by (src_ip, dest_ip). ON event 'mode_change_to_program', START 15_min_timer. IF 'program_download' event seen, CONTINUE. IF 'mode_change_to_run' event seen, TRIGGER_ALERT."
  - question: Was the time between steps in a program download sequence abnormally short or long?
    context: >-
      This question seeks to identify automated attack scripts by analyzing the timing between events in a program download sequence. Legitimate, human-driven engineering tasks typically have a certain cadence. An extremely fast sequence may indicate an automated script, while an unusually long delay could signify manual, interactive tampering. By baselining the normal time deltas, analysts can flag sequences with anomalous durations as suspicious.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Network monitoring points on Level 1 (Control Network) segments
      - Network monitoring points on Level 2 (Supervisory Network) segments
    range: Last 90 days
    queries:
      - "Baseline Pseudocode: FOR authorized download sequences, CALCULATE median and IQR for time_delta_1 (change->download) and time_delta_2 (download->run). SIEM_Rule: ON new sequence, measure T1 and T2. IF T1 or T2 is outside (Q1 - 1.5*IQR, Q3 + 1.5*IQR) THEN ALERT."
  - question: Did a sequence of commands leading to a program download have a low probability of occurring based on historical models?
    context: >-
      This question uses a sequence anomaly detection model (like an HMM or LSTM) to identify unusual progressions of ICS commands. The model learns the normal transition probabilities between different states (e.g., a 'read' is often followed by another 'read', but a 'mode change' followed by a 'download' might be rare). An alert is triggered when an observed sequence of commands is highly improbable according to the model, indicating a potential attack path that deviates from normal operational workflows.
    answer_sources:
      - Zeek s7comm.log
      - Zeek enip.log
      - Zeek conn.log
      - Network monitoring points on Level 1 (Control Network) segments
      - Network monitoring points on Level 2 (Supervisory Network) segments
    range: Last 90 days
    queries:
      - "ML Model Pseudocode: INPUT sequence of ICS commands into trained_sequence_model (HMM/LSTM). IF log_likelihood_score < configured_threshold THEN ALERT."
  - question: Was a PLC mode change initiated by an unapproved process on an Engineering Workstation?
    context: >-
      This question correlates host-based events with network traffic to trace a PLC mode change back to its originating process on an EWS. An adversary might use a non-standard tool or malicious executable to interact with the PLC. This rule provides high-fidelity alerts by confirming that (1) an unapproved process started, (2) it connected to a PLC, and (3) this was immediately followed by a mode change command, all within a very short time window.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Software Allowlist Data
      - Host-based agents (EDR/Sysmon) on EWS and Maintenance Laptops
      - Network monitoring on EWS resident network segments
    range: Last 90 days
    queries:
      - "Correlated SIEM Pseudocode: JOIN (WinEvent 4688 where process NOT IN allowlist), (WinEvent 5156 where ProcessID matches), and (Zeek log with mode_change) by EWS_IP within 60 seconds. IF all three events correlate THEN TRIGGER_CRITICAL_ALERT."
  - question: Did an anomalous parent-child process relationship on an EWS lead to a PLC mode change?
    context: >-
      This question focuses on detecting abnormal process behavior on an EWS. Attackers often execute their tools from unexpected parent processes (e.g., spawning a command shell from a web browser). By baselining normal process chains that lead to PLC communication (e.g., 'explorer.exe' launching 'TIA.exe'), analysts can detect and alert on new or rare parent-child relationships that initiate a mode change, indicating a potential process injection or masquerading technique.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Software Allowlist Data
      - Host-based agents (EDR/Sysmon) on EWS and Maintenance Laptops
      - Network monitoring on EWS resident network segments
    range: Last 90 days
    queries:
      - "Baseline Pseudocode: PROFILE normal parent-child process chains on EWS that communicate with PLCs. SIEM_Rule: ON new process creation leading to PLC communication and mode change, CHECK if parent-child_chain is anomalous (new or infrequent). IF anomalous THEN ALERT."
  - question: Was a process on an EWS that initiated a PLC mode change classified as malicious by a machine learning model?
    context: >-
      This question uses a comprehensive ML model that combines both host and network data to make a holistic judgment. By training on features from the process itself (name, command line, parent) and the resulting network connection (port, protocol, duration), the model can identify malicious activity with greater accuracy. This approach can catch sophisticated attacks where an adversary uses a legitimate-looking process name but the associated network behavior is anomalous.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 5156
      - Zeek conn.log
      - Zeek s7comm.log
      - Zeek enip.log
      - Software Allowlist Data
      - Host-based agents (EDR/Sysmon) on EWS and Maintenance Laptops
      - Network monitoring on EWS resident network segments
    range: Last 90 days
    queries:
      - "ML Model Pseudocode: AGGREGATE host features (process_name, parent_process, cmd_line) and network features (port, proto, duration). INPUT into trained_classifier (XGBoost). IF prediction is 'malicious' with high confidence THEN ALERT."