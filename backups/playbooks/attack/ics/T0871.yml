name: T0871: Execution through API
id: 5972579b-b9f1-4e43-85e7-6a4a1599553f
description: Detects if an adversary is leveraging native ICS APIs for unauthorized execution on control system devices. This is typically observed through network connections to ICS protocol ports from unapproved IP addresses, the use of high-risk or write-capable ICS function codes (especially outside of maintenance windows or from unauthorized sources), or anomalous communication patterns such as unusual volume, timing, or sequencing of API calls, even between supposedly authorized devices.
type: technique
related:
- TA0104: Execution
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are there network connections to control devices from IPs not on the authorized allowlist?
  context: Unauthorized IP addresses connecting to critical control devices are a strong indicator of reconnaissance or an attempted attack. By maintaining an allowlist of approved sources (like specific Engineering Workstations or HMIs) for each device, any deviation can be immediately flagged. Correlating this network activity with host-level process creation logs (Event ID 4688) and firewall logs (Event ID 5156) on the source machine can help pinpoint the exact process responsible for the unauthorized connection attempt.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Network ingress/egress points between the Enterprise Network (Level 4/5) and Process Control Network (Level 3), and network segments within the PCN containing Engineering Workstations (EWs), Human-Machine Interfaces (HMIs), and critical control devices (PLCs, RTUs).
  range: last 90 days
  queries:
  - technology: SIEM
    query: SEARCH Zeek conn.log WHERE (destination_ip, destination_port) IN critical_assets AND source_ip NOT IN allowlist(destination_ip, destination_port). THEN CORRELATE source_ip, timestamp WITH Windows Events 5156, 4688.
- question: Has the number of unique source IPs connecting to a control device exceeded its normal baseline?
  context: In a stable Industrial Control System environment, a control device typically communicates with a small, fixed set of other devices. A sudden spike in the number of unique IP addresses attempting to connect to a device within a short time frame is highly anomalous and may indicate a network scan or a widespread, automated attempt by an adversary to discover and access vulnerable control systems.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Network ingress/egress points between the Enterprise Network (Level 4/5) and Process Control Network (Level 3), and network segments within the PCN containing Engineering Workstations (EWs), Human-Machine Interfaces (HMIs), and critical control devices (PLCs, RTUs).
  range: last 90 days
  queries:
  - technology: SIEM
    query: SEARCH Zeek conn.log | GROUP BY destination_ip, time_window(1h) | COUNT unique(source_ip) AS unique_sources | COMPARE unique_sources > baseline_99th_percentile(destination_ip).
- question: Have any network connections to control devices been flagged as anomalous by our machine learning model?
  context: Rule-based detection is effective but can be brittle. An unsupervised machine learning model, such as an Isolation Forest, can identify subtle deviations from normal network behavior by considering multiple features simultaneously (e.g., connection duration, bytes transferred, protocol). This provides a complementary detection method that can catch novel or evasive techniques that explicit rules might miss, flagging suspicious connections for analyst review.
  answer_sources:
  - Zeek conn.log
  - Windows Event ID 5156
  - Windows Event ID 4688
  - Network ingress/egress points between the Enterprise Network (Level 4/5) and Process Control Network (Level 3), and network segments within the PCN containing Engineering Workstations (EWs), Human-Machine Interfaces (HMIs), and critical control devices (PLCs, RTUs).
  range: last 90 days
  queries:
  - technology: ML Model
    query: FEED Zeek conn.log features (src_ip, dst_ip, dst_port, proto, duration, bytes) INTO IsolationForestModel | RETURN connections WHERE anomaly_score > threshold.
- question: Are critical or write-capable ICS function codes being used, especially outside of maintenance windows?
  context: Certain ICS function codes can directly alter a physical process, such as stopping a PLC, downloading new logic, or changing a critical setpoint. The unauthorized use of these commands is a direct threat to process integrity and safety. Creating high-severity alerts for their use, while filtering for authorized activity by cross-referencing with a maintenance schedule, allows analysts to focus on genuinely high-risk events.
  answer_sources:
  - Zeek modbus.log
  - Zeek dnp3.log
  - Zeek s7comm.log
  - Network taps or SPAN ports deployed at critical choke points within the Process Control Network (Level 2), such as in front of safety PLCs, between HMI/EWS and control devices, and on links to Historian servers.
  range: last 90 days
  queries:
  - technology: SIEM
    query: SEARCH (Zeek modbus.log, s7comm.log, dnp3.log) WHERE function_code IN critical_write_codes AND timestamp NOT IN maintenance_window | ENRICH with asset_data.
- question: Is there an unusual frequency or distribution of ICS function codes being used between specific assets?
  context: Normal operations involve a varied sequence of commands. An automated attack script, however, often repeats the same command or a short sequence of commands. This can be detected statistically. A sharp drop in command variety (low Shannon entropy) or a statistical spike in the frequency of a single high-risk command (high Z-score) can indicate a repetitive, automated attack is underway, distinguishing it from more random, human-driven activity.
  answer_sources:
  - Zeek modbus.log
  - Zeek dnp3.log
  - Zeek s7comm.log
  - Network taps or SPAN ports deployed at critical choke points within the Process Control Network (Level 2), such as in front of safety PLCs, between HMI/EWS and control devices, and on links to Historian servers.
  range: last 90 days
  queries:
  - technology: Analytics Platform
    query: SEARCH Zeek protocol logs | GROUP BY src_dst_pair, time_window(10m) | CALCULATE ShannonEntropy(function_code_distribution) AND ZScore(critical_function_code_count) | ALERT WHERE entropy < baseline_5th_percentile OR z_score > 3.0.
- question: Is a sequence of ICS function codes being observed that has a low probability of being legitimate according to our process model?
  context: Every industrial process has a 'grammar' or a logical sequence of operations. A Hidden Markov Model (HMM) can be trained to learn these legitimate sequences and states (e.g., 'startup', 'running', 'shutdown'). If an observed sequence of commands has a very low probability of occurring under this trained model, it indicates a significant deviation from normal operational logic, suggesting an attacker may be trying to manipulate the process in an unauthorized or malicious way.
  answer_sources:
  - Zeek modbus.log
  - Zeek dnp3.log
  - Zeek s7comm.log
  - Network taps or SPAN ports deployed at critical choke points within the Process Control Network (Level 2), such as in front of safety PLCs, between HMI/EWS and control devices, and on links to Historian servers.
  range: last 90 days
  queries:
  - technology: ML Model
    query: FEED sequence of function_codes INTO trained_HMM | CALCULATE probability of sequence | ALERT WHERE probability < low_probability_threshold.
- question: Have any forbidden or logically inconsistent sequences of ICS commands been detected?
  context: Even if a source is authorized, certain command sequences are inherently dangerous or violate established safety procedures (e.g., downloading a new program to a PLC without first putting it in a 'Stop' state). Defining these 'anti-patterns' based on operator knowledge and creating rules to detect them can act as a crucial safety and security backstop, preventing actions that could lead to equipment damage or an unsafe state, even if initiated from a compromised but otherwise legitimate host.
  answer_sources:
  - Zeek conn.log
  - Zeek modbus.log
  - Zeek dnp3.log
  - Zeek s7comm.log
  - Network segments within the Process Control Network (Level 2) that connect authorized Engineering Workstations (EWs) and Human-Machine Interfaces (HMIs) to their respective control devices (PLCs, RTUs).
  range: last 90 days
  queries:
  - technology: SIEM/CEP
    query: DEFINE anti_patterns (e.g., 'PLC Stop' THEN 'Program Download' within 1min from non-EWS) | SEARCH Zeek protocol logs for anti_patterns | ALERT on match.
- question: Is the time between ICS commands for an authorized communication pair significantly faster than the normal baseline?
  context: A human operator interacts with an HMI at a certain cadence. A malicious script running on a compromised host can issue commands much more rapidly. By baselining the normal inter-arrival time of requests between an authorized source and destination, we can detect when this cadence is violated. A sudden, significant decrease in the time between commands strongly suggests that automation is at play, pointing to a compromised host being used for malicious execution.
  answer_sources:
  - Zeek conn.log
  - Zeek modbus.log
  - Zeek dnp3.log
  - Zeek s7comm.log
  - Network segments within the Process Control Network (Level 2) that connect authorized Engineering Workstations (EWs) and Human-Machine Interfaces (HMIs) to their respective control devices (PLCs, RTUs).
  range: last 90 days
  queries:
  - technology: Analytics Platform
    query: SEARCH Zeek protocol logs | GROUP BY src_dst_pair | CALCULATE inter_arrival_time(requests) | IN 5min_window, COMPARE mean(inter_arrival_time) < baseline_1st_percentile.
- question: Does the communication pattern between authorized assets show a high reconstruction error, indicating anomalous behavior?
  context: An advanced technique for detecting compromise is to model the normal 'rhythm' of communication (e.g., data volume, command frequency) between two trusted devices using a time-series model like an LSTM autoencoder. The model learns to reconstruct this normal pattern. If live traffic deviates significantly, the model will be unable to reconstruct it accurately, resulting in a high 'reconstruction error'. This signals that the communication pattern is anomalous, even if individual commands seem valid, indicating a potential compromise of the source host.
  answer_sources:
  - Zeek conn.log
  - Zeek modbus.log
  - Zeek dnp3.log
  - Zeek s7comm.log
  - Network segments within the Process Control Network (Level 2) that connect authorized Engineering Workstations (EWs) and Human-Machine Interfaces (HMIs) to their respective control devices (PLCs, RTUs).
  range: last 90 days
  queries:
  - technology: ML Model
    query: FEED time-series (bytes/sec, commands/sec) INTO trained_LSTM_autoencoder | CALCULATE reconstruction_error | ALERT WHERE reconstruction_error > dynamic_threshold.