name: "T1003.004: LSA Secrets"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook is designed to help determine if an adversary has illicitly accessed credentials by dumping Local Security Authority (LSA) secrets. Evidence of this activity includes the creation of processes associated with known LSA secret dumping utilities (e.g., mimikatz.exe), the execution of commands or scripts with arguments indicative of LSA dumping (e.g., 'lsadump::secrets'), unauthorized access to the LSA secrets registry key (HKEY_LOCAL_MACHINE\\SECURITY\\Policy\\Secrets), unauthorized processes reading the memory of lsass.exe, or the creation of registry hive backups (SECURITY or SYSTEM) followed by access and potential exfiltration."
type: "technique"
related:
  - "TA0006: Credential Access"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Have any processes been created with names or file hashes matching known LSA secret dumping utilities?"
    context: "This question seeks to identify the direct execution of known malicious tools like Mimikatz, Pypykatz, or Procdump, which are commonly used to dump LSA secrets. An exact match provides a high-confidence indicator of a credential dumping attempt and should be treated as a high-priority alert."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1 (Sysmon)"
      - "Threat Intelligence Feeds"
      - "Domain Controllers, Tier 0 Servers, Privileged Access Workstations (PAWs), Administrator Workstations"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process creation logs FOR process_name IN (known_tool_list) OR file_hash IN (known_hash_list)"
  - question: "Have any statistically rare processes executed with SYSTEM privileges that are not on an established allowlist?"
    context: "This question aims to uncover novel or renamed LSA dumping tools by focusing on anomalous behavior. Adversaries often rename tools to evade simple signature-based detection. Identifying processes that rarely run in the environment, especially with high privileges, helps detect these evasive variants."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1 (Sysmon)"
      - "Domain Controllers, Tier 0 Servers, Privileged Access Workstations (PAWs), Administrator Workstations"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE frequency of all process_names over 90 days. FIND processes where frequency < 1st percentile AND user_context is SYSTEM AND process_name NOT IN (allowlist)."
  - question: "Can a machine learning model identify process creation events that are suspicious and indicative of LSA secret access tools?"
    context: "This question leverages a machine learning classification model to detect subtle characteristics of malicious processes that symbolic or statistical methods might miss. By analyzing features like parent process, user context, and process name entropy, the model can identify sophisticated or unknown tools designed for credential dumping."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1 (Sysmon)"
      - "Domain Controllers, Tier 0 Servers, Privileged Access Workstations (PAWs), Administrator Workstations"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY classification model to process creation events. PREDICT 'benign' or 'suspicious'. FLAG 'suspicious' events for review."
  - question: "Have any commands or PowerShell scripts been executed containing arguments or strings known to be used for LSA secret dumping?"
    context: "This question looks for the specific commands and keywords used by credential dumping tools within command-line arguments or PowerShell script blocks. This is a highly effective way to detect 'fileless' attacks or instances where malicious code is executed in memory without writing a tool to disk."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "Domain Controllers, Critical Application Servers, Endpoint devices of administrators"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH command_line_logs AND powershell_script_block_logs FOR regex_patterns IN (known_dumping_strings)."
  - question: "Have any PowerShell script blocks been executed with unusually high entropy, suggesting obfuscation?"
    context: "This question uses entropy analysis to identify obfuscated PowerShell scripts. Adversaries often use obfuscation to hide malicious commands from simple string-based searches. A script with an abnormally high entropy score is a strong indicator of a packed or encoded payload, which warrants investigation."
    answer_sources:
      - "Windows Event ID 4104"
      - "Domain Controllers, Critical Application Servers, Endpoint devices of administrators"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE Shannon entropy for all PowerShell script blocks. FLAG scripts where entropy > 98th percentile of baseline."
  - question: "Can a Natural Language Processing (NLP) model classify PowerShell script blocks as malicious credential dumping activity?"
    context: "This question applies an NLP model to understand the semantic meaning of PowerShell scripts, allowing it to detect novel or heavily obfuscated credential dumping techniques that evade regex and simple statistical analysis. This approach helps identify the intent behind the code, not just its structure."
    answer_sources:
      - "Windows Event ID 4104"
      - "Domain Controllers, Critical Application Servers, Endpoint devices of administrators"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY NLP model to PowerShell script blocks. PREDICT 'malicious (credential dumping)' or 'benign'. FLAG 'malicious' scripts for review."
  - question: "Has an unauthorized process or user account attempted to access the LSA secrets registry key?"
    context: "This question focuses on direct access attempts to the sensitive registry key where LSA secrets are stored. By monitoring this key and maintaining an allowlist of legitimate system processes, any unauthorized access can be immediately flagged as a high-fidelity indicator of a credential dumping attempt."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 13 (Sysmon)"
      - "Domain Controllers, Tier 0 Servers, Servers with sensitive service accounts"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH registry access logs for key 'HKEY_LOCAL_MACHINE\\SECURITY\\Policy\\Secrets'. ALERT if source_process OR user_account NOT IN (allowlist)."
  - question: "Have there been any statistically unusual access patterns to the LSA secrets registry key by any process?"
    context: "This question seeks to identify anomalous behavior even from potentially legitimate processes. An adversary might compromise a legitimate process to access the registry key. By profiling normal access frequency and timing, any significant deviation (e.g., a process accessing the key for the first time, or at an unusual time) can be detected."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 13 (Sysmon)"
      - "Domain Controllers, Tier 0 Servers, Servers with sensitive service accounts"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "PROFILE historical access to LSA secrets key per process. FLAG access events where frequency is > 3 standard deviations from mean OR time_of_day is outside 95% confidence interval."
  - question: "Can an anomaly detection model identify suspicious access events to the LSA secrets registry key?"
    context: "This question uses an unsupervised machine learning model to detect novel and complex patterns of unauthorized access. By considering multiple features simultaneously (process, parent process, user, time), the model can identify outliers that represent sophisticated attacks without relying on predefined rules or signatures."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 13 (Sysmon)"
      - "Domain Controllers, Tier 0 Servers, Servers with sensitive service accounts"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY Isolation Forest model to registry access events. SCORE each event for anomaly. FLAG high-scoring events."
  - question: "Has an unauthorized process attempted to read the memory of the LSASS process?"
    context: "This question targets a primary method of credential dumping: reading credentials directly from the memory of the Local Security Authority Subsystem Service (LSASS). Access to this process's memory is highly restricted, so any unauthorized process attempting to read it (indicated by access mask 0x10) is a strong sign of malicious activity."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 10 (Sysmon)"
      - "All Windows Endpoints, All Windows Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH process access logs for target_process 'lsass.exe'. ALERT if source_process NOT IN (allowlist) AND access_mask includes 'PROCESS_VM_READ (0x10)'."
  - question: "Has any non-system process accessed LSASS memory on a statistically unusual number of hosts?"
    context: "This question helps to identify the lateral movement phase of an attack where an adversary uses a tool to dump credentials across multiple machines. A process that is not a standard system or security tool accessing LSASS on an unusually high number of hosts is indicative of widespread credential harvesting."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 10 (Sysmon)"
      - "All Windows Endpoints, All Windows Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FOR each non-system process accessing LSASS, COUNT unique hosts over 24 hours. FLAG process if host count is statistically unusual (e.g., > 95th percentile)."
  - question: "Can a time-series model detect anomalous spikes in LSASS memory access events on a host?"
    context: "This question uses time-series analysis to detect a sudden burst of credential dumping activity on a single host. A sharp, unexpected increase in the number of unique processes accessing LSASS memory within a short timeframe is a strong temporal anomaly that could signify a tool being used to rapidly enumerate and dump credentials."
    answer_sources:
      - "Windows Event ID 4656"
      - "Windows Event ID 10 (Sysmon)"
      - "All Windows Endpoints, All Windows Servers, Domain Controllers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY ARIMA model to time-series of LSASS access counts per host. FLAG hosts with sudden spikes that deviate from the forecast."
  - question: "Has a registry hive backup been created and then immediately accessed by a non-standard or scripting process?"
    context: "This question looks for a specific sequence of actions indicating offline credential theft. Adversaries often dump the SECURITY or SYSTEM registry hives to a file and then use a separate tool (like a scripting engine or compression utility) to process or exfiltrate it. Correlating these events in a short time window is a high-fidelity indicator of this technique."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Windows Event ID 11 (Sysmon)"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "Domain Controllers, File Servers hosting backups, Network Egress Points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CORRELATE process creation for 'reg.exe save' or 'vssadmin' with subsequent file access to the created hive by a process NOT IN (admin_tool_list) within 5 minutes."
  - question: "Have any anomalously large files with hive-related extensions been exfiltrated to low-reputation or unusual network destinations?"
    context: "This question focuses on the exfiltration phase of offline hive theft. By analyzing network traffic for outbound files with hive-related extensions (.sav, .hiv) or unusually large sizes, especially when sent to suspicious IP addresses or geographies, it's possible to detect the theft of credential data."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek files.log"
      - "Domain Controllers, File Servers hosting backups, Network Egress Points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SEARCH network file transfer logs for files with extensions '.sav' or '.hiv' OR file_size > 95th percentile. FLAG if destination_ip has low reputation OR destination_country is unusual."
  - question: "Can a sequence analysis model detect the pattern of registry backup followed by file access and network exfiltration?"
    context: "This question uses a sophisticated model, like a Hidden Markov Model, to identify the entire attack chain as a single, anomalous sequence. By learning normal sequences of events, the model can flag the specific [Backup -> Access -> Exfiltration] pattern, even with variations, as a strong indicator of credential hive theft."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Windows Event ID 11 (Sysmon)"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "Domain Controllers, File Servers hosting backups, Network Egress Points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY HMM sequence model to event logs. FLAG sequences matching [Backup Command -> File Access by Scripting Engine -> Outbound Network Connection to Rare IP]."