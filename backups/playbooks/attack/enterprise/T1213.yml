name: "T1213: Data from Information Repositories"
id: "d9a87e70-5b41-4cf8-a9f6-1358c2d1d0b3"
description: "This playbook focuses on detecting adversary attempts to collect data from internal information repositories such as SharePoint, Confluence, network file shares, and databases. It looks for indicators of compromise including unusual access patterns, connections to malicious infrastructure after repository access, anomalous execution of database dump utilities, high-volume file read operations followed by compression, and statistically significant spikes in outbound network traffic. The goal is to identify and investigate potential data staging and exfiltration activities."
type: "technique"
related:
  - "TA0009: Collection"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Has a user accessed a sensitive repository and then connected to a known malicious IP address within 15 minutes?"
    context: "This question aims to detect a classic exfiltration pattern where an adversary accesses valuable data and immediately sends it to their command and control (C2) or dropzone server. Correlating repository access with connections to known-bad infrastructure within a short time window provides a high-confidence indicator of compromise."
    answer_sources:
      - "Windows Event ID 4663, Windows Event ID 5145, Windows Event ID 4624, Zeek conn.log, Zeek dns.log. Contextual data needed: SharePoint sites, Confluence spaces, and network file shares containing sensitive data; ADFS servers; network egress points; DNS resolvers; and high-confidence threat intelligence feeds."
    range: "last 90 days"
    queries:
      - "pseudocode: FIND events FROM (repository_access_logs, network_logs) | JOIN on user, source_ip | WHERE time_diff(network_log.timestamp, repo_access.timestamp) < 15 minutes AND network_log.destination_ip IN (malicious_ip_feed)"
  - question: "Did a user connect to a new or unusual Autonomous System Number (ASN) or country shortly after accessing a sensitive repository?"
    context: "This question focuses on behavioral anomaly detection. Legitimate user activity typically involves connections to a predictable set of network providers (ASNs). An adversary exfiltrating data may use infrastructure in unusual geographic locations or on commodity hosting providers not associated with normal business operations. A connection to a 'first-ever-seen' ASN for a user after they access sensitive data is a strong flag for investigation."
    answer_sources:
      - "Windows Event ID 4663, Windows Event ID 5145, Windows Event ID 4624, Zeek conn.log, Zeek dns.log. Contextual data needed: SharePoint sites, Confluence spaces, and network file shares containing sensitive data; ADFS servers; network egress points and DNS resolvers."
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each_user | GET baseline_asns_countries | FIND network_connections AFTER sensitive_repo_access | WHERE connection.destination_asn NOT IN baseline_asns_countries"
  - question: "Does a session involving repository access and network egress exhibit a high-risk score based on features like data volume, destination reputation, and domain age?"
    context: "This question leverages machine learning to identify suspicious activity that might not trigger simple rules. By combining multiple weak signals—such as the amount of data sent, the reputation of the destination, the age of the domain, and the sensitivity of the data accessed—a model can assign a holistic risk score. This allows analysts to focus on the sessions that are most likely to be malicious."
    answer_sources:
      - "Windows Event ID 4663, Windows Event ID 5145, Windows Event ID 4624, Zeek conn.log, Zeek dns.log. Contextual data needed: SharePoint sites, Confluence spaces, and network file shares containing sensitive data; ADFS servers; network egress points and DNS resolvers."
    range: "last 90 days"
    queries:
      - "pseudocode: EXECUTE risk_model on session_data | FILTER risk_score > threshold | WHERE session_data includes repo_access and network_egress"
  - question: "Has a database utility been executed by an anomalous parent process or with command-line arguments indicating staging in a suspicious directory?"
    context: "This question looks for database dump tools being used in an unconventional manner. Legitimate use typically comes from an interactive shell or management tool. When a web server process spawns a database utility, it could indicate a web shell is being used to dump database contents. Similarly, redirecting output to a public or temporary folder is a common staging technique."
    answer_sources:
      - "Windows Event ID 4688, Windows Event ID 4624. Contextual data needed: Production and development database servers; web servers with database connectivity; endpoints of DBAs, developers, and system administrators."
    range: "last 90 days"
    queries:
      - "pseudocode: FIND process_creation_events | WHERE process_name IN (db_dump_tools) AND parent_process_name NOT IN (legit_parents) OR command_line contains (suspicious_staging_path)"
  - question: "Was a database utility executed with an unusual command-line structure compared to the user's historical usage?"
    context: "This question uses historical data to baseline normal command-line usage for database tools on a per-user basis. An adversary may use different flags or target different tables. By comparing a new command to a user's historical profile (e.g., using Jaccard similarity), we can flag novel and potentially malicious executions."
    answer_sources:
      - "Windows Event ID 4688, Windows Event ID 4624. Contextual data needed: Production and development database servers; web servers with database connectivity; endpoints of DBAs, developers, and system administrators."
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each_db_tool_execution | TOKENIZE command_line | CALCULATE similarity_score against user_historical_commands | ALERT if score < threshold"
  - question: "Is a database utility execution classified as malicious based on its command-line features and execution context?"
    context: "This question applies machine learning to identify malicious command-line activity. The model can learn complex patterns by analyzing features like the command's length and entropy, the presence of IP addresses, the parent process, and the user account, providing a more robust detection method than static rules."
    answer_sources:
      - "Windows Event ID 4688, Windows Event ID 4624. Contextual data needed: Production and development database servers; web servers with database connectivity; endpoints of DBAs, developers, and system administrators."
    range: "last 90 days"
    queries:
      - "pseudocode: EXECUTE command_line_classifier on process_creation_events | WHERE process_name IN (db_dump_tools) AND classification == 'malicious'"
  - question: "Has a user accessed a repository or file share they are not authorized for based on their Active Directory group membership?"
    context: "This question acts as a detective control for access policy violations. Alerting when a user from one department (e.g., Sales) accesses a repository belonging to another (e.g., Engineering) is a strong indicator of either privilege escalation, misconfiguration, or lateral movement."
    answer_sources:
      - "Windows Event ID 4663, Windows Event ID 5145, Zeek http.log, Application-specific audit logs (e.g., SharePoint, Confluence). Contextual data needed: SharePoint Online tenant, Confluence server, network file shares categorized by data sensitivity and departmental ownership."
    range: "last 90 days"
    queries:
      - "pseudocode: FIND file_access_events | GET user_group from AD, resource_owner from matrix | ALERT if user_group NOT IN resource_authorized_groups"
  - question: "Did a user access an anomalously high number of distinct files or pages from a sensitive repository compared to their own baseline?"
    context: "This question seeks to identify 'data hoarding' or reconnaissance behavior. An adversary discovering where valuable information is may access thousands of files, whereas their normal behavior is to access only a few dozen. Comparing a user's activity against their own historical baseline helps to spot these significant deviations."
    answer_sources:
      - "Windows Event ID 4663, Windows Event ID 5145, Zeek http.log, Application-specific audit logs (e.g., SharePoint, Confluence). Contextual data needed: SharePoint Online tenant, Confluence server, network file shares categorized by data sensitivity and departmental ownership."
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each_user | CALCULATE daily_distinct_file_access_count | GET 30day_percentile(98) for user | ALERT if daily_count > 98th_percentile"
  - question: "Is a user's repository access pattern anomalous compared to their peer group?"
    context: "This question detects when a user's behavior deviates from their role-based peers. By clustering users with similar jobs, we can establish a behavioral norm for the group. If one user's activity deviates significantly from their peer group's norm (e.g., an accountant accessing source code), it can indicate a compromised account or insider threat."
    answer_sources:
      - "Windows Event ID 4663, Windows Event ID 5145, Zeek http.log, Application-specific audit logs (e.g., SharePoint, Confluence). Contextual data needed: SharePoint Online tenant, Confluence server, network file shares categorized by data sensitivity and departmental ownership."
    range: "last 90 days"
    queries:
      - "pseudocode: CLUSTER users by repo_access_vectors | FOR each_user | CALCULATE distance from their_cluster_centroid | ALERT if distance > cluster_threshold"
  - question: "Was a mass file read from a sensitive share followed by the execution of a compression utility by the same user on the same host?"
    context: "This question looks for a common data staging sequence: grab a large number of files, then compress them into a single archive for easier exfiltration. A stateful rule that looks for mass reads followed by compression within a short time window can detect this adversary TTP with high fidelity."
    answer_sources:
      - "Windows Event ID 5145, Windows Event ID 4688, Windows Event ID 4663. Contextual data needed: Network file shares containing intellectual property, PII, or financial records; user endpoints."
    range: "last 90 days"
    queries:
      - "pseudocode: FIND stateful_event_sequence | WHERE step1 = (file_read_count > 1000 in 30min from sensitive_share) | AND step2 = (process_creation of compression_tool in next 5min) | GROUP BY user, host"
  - question: "Is there a significant spike in the ratio of file read to write events on a sensitive share, indicating potential data staging?"
    context: "This question identifies anomalous data interaction. Normal activity involves a mix of reading and writing. An adversary preparing data for exfiltration will perform a vast number of read operations with few writes. A sudden spike in the read-to-write ratio, especially when the number of reads is high, is a strong indicator of data collection."
    answer_sources:
      - "Windows Event ID 5145, Windows Event ID 4688, Windows Event ID 4663. Contextual data needed: Network file shares containing intellectual property, PII, or financial records; user endpoints."
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each_user_host_pair in 15min_windows | CALCULATE read_write_ratio = count(read_events) / count(write_events) | GET baseline_ratio | ALERT if current_ratio >> baseline_ratio AND count(read_events) is high"
  - question: "Does a user's sequence of system events indicate a probable transition from mass file reading to data compression?"
    context: "This question applies a Hidden Markov Model (HMM) to understand the 'story' a sequence of events is telling. The model is trained to recognize the probability of transitioning between different states of activity. An alert is triggered when the sequence of events makes a high-probability transition from a 'Mass File Read' state to a 'Data Compression' state."
    answer_sources:
      - "Windows Event ID 5145, Windows Event ID 4688, Windows Event ID 4663. Contextual data needed: Network file shares containing intellectual property, PII, or financial records; user endpoints."
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT sequence_of_user_events into HMM_model | GET state_transition_probabilities | ALERT if P('Mass File Read' -> 'Data Compression') > threshold"
  - question: "Did a host connect to a known malicious domain type (e.g., dynamic DNS, anonymizing proxy) and exfiltrate a large amount of data shortly after accessing a sensitive repository?"
    context: "This question links sensitive data access directly to high-volume data transfer to a suspicious destination. Adversaries often use dynamic DNS or anonymizing services to exfiltrate data. Correlating repository access with a subsequent large data transfer (>100MB) to a domain on a blocklist of such services creates a high-confidence alert."
    answer_sources:
      - "Zeek conn.log, Zeek dns.log, Windows Event ID 5145, Application-specific audit logs. Contextual data needed: Network egress points (firewalls, proxies), DNS resolvers, and the information repositories themselves."
    range: "last 90 days"
    queries:
      - "pseudocode: FIND repo_access from host | THEN FIND within 1 hour, dns_request from host to suspicious_domain_type | AND FIND network_connection to that domain with sent_bytes > 100MB"
  - question: "Did a host exhibit an anomalous spike in outbound data volume (e.g., > 3 standard deviations above its mean) within an hour of accessing a sensitive repository?"
    context: "This question uses statistical anomaly detection on network traffic volume. A large data exfiltration event will likely appear as a significant spike in traffic. By calculating a rolling baseline (mean and standard deviation) for each host, we can automatically flag any hourly traffic volume that is statistically significant. Enriching this alert with recent sensitive data access provides crucial context."
    answer_sources:
      - "Zeek conn.log, Zeek dns.log, Windows Event ID 5145, Application-specific audit logs. Contextual data needed: Network egress points (firewalls, proxies), DNS resolvers, and the information repositories themselves."
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each_host | CALCULATE hourly_egress_baseline (mean, std_dev) | ALERT if current_hourly_egress > (mean + 3*std_dev) | ENRICH with recent_repo_access from host"
  - question: "Does a host's outbound traffic volume show an anomalous spike that cannot be explained by normal daily or weekly patterns, and does it correlate with recent repository access?"
    context: "This question employs advanced time-series analysis to find anomalies in network traffic, accounting for normal periodic fluctuations (e.g., business hours, weekends). This allows the model to identify spikes that are truly anomalous relative to the expected pattern for that specific time, reducing false positives from simpler models."
    answer_sources:
      - "Zeek conn.log, Zeek dns.log, Windows Event ID 5145, Application-specific audit logs. Contextual data needed: Network egress points (firewalls, proxies), DNS resolvers, and the information repositories themselves."
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT host_traffic_timeseries into anomaly_detection_model | ALERT on detected_anomalies | ENRICH with recent_repo_access from host"