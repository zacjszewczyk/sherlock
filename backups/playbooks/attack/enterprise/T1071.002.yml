name: T1071.002: File Transfer Protocols
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps investigate whether an adversary is using file transfer protocols (FTP, SMB, TFTP) for command and control (C2) communications. This involves detecting connections to known malicious servers, identifying anomalous command sequences and data transfer volumes, recognizing periodic C2 beaconing, flagging suspicious processes initiating transfers, and finding disguised malicious files based on content analysis like mismatched file extensions or high entropy.
type: technique
related:
- TA0011: Command and Control
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is an internal host connecting to a known malicious C2 server using FTP, SMB, or TFTP?
  context: This question aims to detect direct communication with known adversary infrastructure. A match against a high-confidence threat intelligence feed provides a strong indicator of compromise. This is the most direct detection method, leveraging community and proprietary knowledge of active threats.
  answer_sources:
  - Zeek conn.log
  - Zeek ftp.log
  - Zeek dns.log
  - Zeek notice.log
  - Internet Gateway Firewalls
  - DNS Resolvers
  - Network Egress Points
  - Cloud Access Security Brokers (CASB)
  - High-confidence C2 threat intelligence feed
  range: Last 90 days
  queries:
  - 'Symbolic: SEARCH Zeek conn.log WHERE (destination_port IN (21, 445, 69) AND destination_ip IS_EXTERNAL AND destination_ip IN C2_Threat_Intel_Feed) | ALERT on match'
- question: Is an internal host connecting to a rare and newly registered domain using FTP, SMB, or TFTP?
  context: Adversaries often use newly created domains for their operations to evade reputation-based blocking. A domain that is both rarely visited by anyone in the organization and was registered recently is highly suspicious. This question helps uncover previously unknown C2 infrastructure.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Internet Gateway Firewalls
  - DNS Resolvers
  - Network Egress Points
  - Cloud Access Security Brokers (CASB)
  range: Last 90 days
  queries:
  - 'Statistical: SEARCH Zeek dns.log AND conn.log | CORRELATE DNS queries with FTP/SMB/TFTP connections | CALCULATE domain prevalence and age | ALERT on connections to domains WHERE (prevalence < 0.1% AND age < 60 days)'
- question: Does a network connection using FTP, SMB, or TFTP exhibit characteristics that a machine learning model identifies as malicious?
  context: This question uses a predictive model to identify malicious connections that may not be caught by simple rules. The model analyzes a combination of factors (IP reputation, ASN, domain age, etc.) to calculate a maliciousness score, enabling the detection of more subtle or novel C2 channels.
  answer_sources:
  - Zeek conn.log
  - Zeek dns.log
  - Internet Gateway Firewalls
  - DNS Resolvers
  - Network Egress Points
  - Cloud Access Security Brokers (CASB)
  range: Last 90 days
  queries:
  - 'Machine Learning: INPUT Zeek conn.log and dns.log features INTO classification model | ALERT on connections WHERE malicious_probability_score > 0.90'
- question: Are we observing a sequence of FTP or SMB commands that matches a known malicious pattern?
  context: Many malware families and C2 frameworks use a specific, scripted sequence of commands to stage tools, exfiltrate data, or execute code. For example, writing a file to an administrative share and then creating a service to run it is a classic lateral movement technique. Detecting these specific sequences provides high-fidelity alerts.
  answer_sources:
  - Zeek ftp.log
  - Zeek smb_files.log
  - Zeek smb_mapping.log
  - Zeek smb_cmds.log
  - Internal File Servers
  - Domain Controllers
  - Endpoint Workstations
  - Network Segments with high-value assets
  range: Last 90 days
  queries:
  - 'Symbolic: SEARCH Zeek SMB/FTP logs for a sequence WHERE (action_1 = SMB_WRITE to ADMIN$/C$ AND action_2 = REMOTE_SERVICE_CREATE within a short time) OR (action_1 = FTP_PUT temp_file AND action_2 = FTP_RNTO to executable_ext within a short time) | ALERT on sequence match'
- question: Is a user's FTP or SMB activity statistically different from their own or their peers' normal behavior?
  context: This question aims to find outliers by baselining normal user activity. A compromised account may suddenly start using FTP/SMB commands in a way that is uncharacteristic for that user (e.g., suddenly using 'PUT' commands frequently) but might not trigger a specific signature-based rule. A significant deviation from the norm warrants investigation.
  answer_sources:
  - Zeek ftp.log
  - Zeek smb_files.log
  - Zeek smb_mapping.log
  - Zeek smb_cmds.log
  - Internal File Servers
  - Domain Controllers
  - Endpoint Workstations
  - Network Segments with high-value assets
  range: Last 90 days
  queries:
  - 'Statistical: COMPARE daily user FTP/SMB command distribution against 30-day historical baseline and peer group baseline using Chi-squared test | ALERT if p-value < 0.01'
- question: Is an observed sequence of FTP or SMB commands considered anomalous by a machine learning model trained on legitimate command sequences?
  context: This question uses an unsupervised learning model (like an autoencoder) to learn what "normal" sequences of file transfer commands look like. When the model encounters a sequence it cannot reconstruct accurately, it signals an anomaly. This can detect novel or unique malicious command patterns that haven't been seen before.
  answer_sources:
  - Zeek ftp.log
  - Zeek smb_files.log
  - Zeek smb_mapping.log
  - Zeek smb_cmds.log
  - Internal File Servers
  - Domain Controllers
  - Endpoint Workstations
  - Network Segments with high-value assets
  range: Last 90 days
  queries:
  - 'Machine Learning: INPUT real-time FTP/SMB command sequences into LSTM autoencoder model | ALERT on sessions with high reconstruction error'
- question: Is a host sending significantly more data than it is receiving over FTP, SMB, or TFTP to a non-approved external destination?
  context: This is a classic indicator of data exfiltration. While some file transfers are legitimate, a large, imbalanced ratio of outbound to inbound data (e.g., 20:1) to a destination that isn't a known cloud backup or file sharing service is highly suspicious and could represent an adversary stealing data.
  answer_sources:
  - Zeek conn.log
  - Zeek ftp.log
  - Internet Gateway
  - Core Network Switches
  - Endpoint Network Interfaces
  - VPN Concentrators
  range: Last 90 days
  queries:
  - 'Symbolic: SEARCH Zeek conn.log WHERE (destination_ip IS_EXTERNAL AND destination_ip NOT_IN Allowlist AND sent_bytes > (received_bytes * 20)) | ALERT on match'
- question: Is a host's daily data transfer volume or send/receive ratio over file transfer protocols a statistical outlier compared to its own history?
  context: This question identifies anomalous data transfer behavior by comparing a host's current activity to its own established baseline. Using a Z-score helps flag significant deviations (e.g., more than 3 standard deviations from the mean) that could indicate a one-off data exfiltration event or the start of C2 activity, even if the absolute volume isn't massive.
  answer_sources:
  - Zeek conn.log
  - Zeek ftp.log
  - Internet Gateway
  - Core Network Switches
  - Endpoint Network Interfaces
  - VPN Concentrators
  range: Last 90 days
  queries:
  - 'Statistical: CALCULATE 30-day rolling baseline (mean, stddev) of daily traffic volume and ratio for each host | CALCULATE Z-score for current day''s traffic | ALERT if Z-score > 3'
- question: Does a host's traffic volume over file transfer protocols deviate from the volume predicted by a time-series forecasting model?
  context: This question uses a more sophisticated forecasting model to predict expected traffic patterns, accounting for seasonality (e.g., daily/weekly cycles like large backups). An alert is triggered when the actual traffic falls outside the model's high-confidence prediction interval, indicating an unexpected and potentially malicious transfer.
  answer_sources:
  - Zeek conn.log
  - Zeek ftp.log
  - Internet Gateway
  - Core Network Switches
  - Endpoint Network Interfaces
  - VPN Concentrators
  range: Last 90 days
  queries:
  - 'Machine Learning: INPUT historical traffic volume into time-series model (Prophet/ARIMA) to forecast expected volume | COMPARE observed volume to forecast | ALERT if observed volume is outside 99% confidence interval'
- question: Is a host making an unusually high number of rapid, short-lived connections to the same external destination using FTP, SMB, or TFTP?
  context: This behavior is a strong indicator of automated C2 beaconing. Malware often "calls home" at regular intervals to check for new commands. A simple rule that counts frequent, short connections within a small time window can be an effective way to detect this type of activity.
  answer_sources:
  - Zeek conn.log
  - Internet Egress Points
  - Firewall and Proxy Servers
  - DNS sinkholes
  range: Last 90 days
  queries:
  - 'Symbolic: SEARCH Zeek conn.log WHERE a single source_ip connects to the same destination_ip on port 21, 69, or 445 > 10 times in 5 minutes AND connection_duration < 10 seconds | ALERT on match'
- question: Are we observing highly periodic (low jitter) connections from an internal host to a rare external destination?
  context: This question refines the detection of beaconing by focusing on its regularity. Automated C2 tools have very little variation (low jitter) in the time between their connections. By calculating the standard deviation of the time between connections, we can identify this machine-like periodicity. Combining this with low destination prevalence helps filter out legitimate, periodic services.
  answer_sources:
  - Zeek conn.log
  - Internet Egress Points
  - Firewall and Proxy Servers
  - DNS sinkholes
  range: Last 90 days
  queries:
  - 'Statistical: CALCULATE time deltas between consecutive connections for each source-destination-port triplet over 24 hours | CALCULATE standard deviation of deltas | ALERT if stddev < 3 seconds AND destination is low-prevalence'
- question: Does a machine learning clustering algorithm group a set of connections into a small, dense cluster indicative of C2 beaconing?
  context: This question uses unsupervised clustering (like DBSCAN) to find groups of similar network connections without pre-defined rules. By clustering on features like destination, duration, and inter-arrival time standard deviation, the algorithm can automatically surface small, tight clusters that represent beaconing activity from one or more infected hosts to a C2 server.
  answer_sources:
  - Zeek conn.log
  - Internet Egress Points
  - Firewall and Proxy Servers
  - DNS sinkholes
  range: Last 90 days
  queries:
  - 'Machine Learning: RUN DBSCAN clustering on connection logs using features (dest_ip, port, duration, data_volume, inter-arrival_time_stddev) | INVESTIGATE small, dense clusters not matching known services'
- question: Is a suspicious process (e.g., PowerShell, script host) or a process from a temporary location initiating an FTP, SMB, or TFTP connection?
  context: File transfers are normally initiated by specific applications (e.g., web browsers, dedicated FTP clients). When a command-line interpreter like powershell.exe or an unsigned executable running from a user's temp folder makes an outbound file transfer connection, it is highly indicative of malicious activity, such as a script-based implant downloading a second stage.
  answer_sources:
  - Sysmon Event ID 3
  - Windows Event ID 4688
  - Zeek conn.log
  - Endpoint Devices (Workstations and Servers)
  - Domain Controllers
  - Application Servers
  range: Last 90 days
  queries:
  - 'Symbolic: CORRELATE Sysmon Event ID 3 (Network) with Event ID 4688 (Process Create) | ALERT if process_name IN (powershell.exe, wscript.exe) OR process is unsigned OR process_path is user-writable (e.g., %APPDATA%) AND destination_port IN (21, 69, 445)'
- question: Is a statistically rare process initiating an outbound FTP, SMB, or TFTP connection?
  context: This question helps uncover abuse of legitimate but unusual processes for C2. By baselining which processes normally make file transfer connections, we can flag any process that does so for the first time or is an extreme outlier in terms of prevalence. This can catch "living off the land" techniques where an adversary uses a pre-existing tool for a malicious purpose.
  answer_sources:
  - Sysmon Event ID 3
  - Windows Event ID 4688
  - Zeek conn.log
  - Endpoint Devices (Workstations and Servers)
  - Domain Controllers
  - Application Servers
  range: Last 90 days
  queries:
  - 'Statistical: BASELINE all processes that initiate outbound FTP/SMB/TFTP connections | CALCULATE prevalence for each process | ALERT on connections from a process that is a statistical outlier (e.g., first time seen, or bottom 1% prevalence)'
- question: Does a machine learning model classify a process-network event as malicious based on its combined characteristics?
  context: This question uses a model to score the overall risk of a process initiating a network connection. It considers a wide range of features (process name, command line, parent, signature, path, network destination) simultaneously to make a more holistic judgment than a single rule, allowing it to catch complex or novel evasive techniques.
  answer_sources:
  - Sysmon Event ID 3
  - Windows Event ID 4688
  - Zeek conn.log
  - Endpoint Devices (Workstations and Servers)
  - Domain Controllers
  - Application Servers
  range: Last 90 days
  queries:
  - 'Machine Learning: INPUT process and network features into classification model | ALERT on events with a high maliciousness score'
- question: Are we observing a file transfer where the actual file type (e.g., executable) does not match its filename extension (e.g., .jpg)?
  context: Adversaries often disguise malicious payloads by giving them benign-looking file extensions to evade simple extension-based filtering. This question uses deep packet inspection (via Zeek) to identify the true file type based on its content (e.g., MIME type) and alerts when there is a mismatch with its name, a common evasion tactic.
  answer_sources:
  - Zeek files.log
  - Zeek pe.log
  - Network TAPs providing data to Zeek sensors
  - File Servers
  - Web Proxies
  range: Last 90 days
  queries:
  - 'Symbolic: SEARCH Zeek files.log WHERE (mime_type is ''application/x-dosexec'' AND filename extension is NOT ''.exe'' or ''.dll'') OR (filename extension IS ''.exe'' or ''.ps1'' AND destination is EXTERNAL) | ALERT on match'
- question: Is a file being transferred that has an abnormally high Shannon entropy value, suggesting it is packed or encrypted?
  context: High entropy is a mathematical measure of randomness. Uncompressed, unencrypted data (like text or many common file formats) has lower entropy, while encrypted or packed data (common for malware) is highly random and has high entropy. Alerting on files with entropy above a certain threshold (e.g., 7.5) or that is anomalous for its claimed file type can reveal obfuscated malicious payloads.
  answer_sources:
  - Zeek files.log
  - Zeek pe.log
  - Network TAPs providing data to Zeek sensors
  - File Servers
  - Web Proxies
  range: Last 90 days
  queries:
  - 'Statistical: CALCULATE Shannon entropy for all files in Zeek files.log | ALERT if entropy > 7.5 OR entropy is in 99th percentile for its stated MIME type'
- question: Does a machine learning model predict a file's true type to be different from its stated file extension?
  context: This question leverages a model trained on file content characteristics (like byte histograms and string statistics) to predict the actual file type. This is a more robust method of identifying file-type mismatches than relying on a single MIME type field, as the model can learn more nuanced patterns to distinguish between file types, even for unknown or custom formats.
  answer_sources:
  - Zeek files.log
  - Zeek pe.log
  - Network TAPs providing data to Zeek sensors
  - File Servers
  - Web Proxies
  range: Last 90 days
  queries:
  - 'Machine Learning: INPUT file content features (byte histogram, etc.) into classification model | ALERT if model''s predicted_type (e.g., ''PE executable'') does not match filename extension (e.g., ''.log'')'