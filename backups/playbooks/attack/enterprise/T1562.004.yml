name: T1562.004: Disable or Modify System Firewall
id: 5e9b8f0a-1b1c-4d8e-8f9a-6c7d8e9f0a1b
description: |
  This playbook helps investigate whether an adversary has attempted to evade defenses by disabling or modifying the system firewall. Evidence for this technique includes the temporal correlation of known malicious processes with subsequent firewall modifications; the use of specific command-line utilities (e.g., `netsh.exe`, `Set-NetFirewallProfile`) to alter firewall rules; direct modification of firewall-related registry keys or services; firewall changes followed by anomalous outbound network connections; or a sudden, sustained increase in a host's listening ports or inbound connections, indicating a firewall has been disabled.
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a known malicious process been executed shortly before the system firewall was modified via command line, registry, or service changes on a host?
  context: |
    This question aims to directly link known malware (identified by its hash) to subsequent defense evasion activities, specifically the modification of the host firewall. A temporal correlation within a short window (e.g., 5 minutes) strongly suggests that the malware is responsible for the firewall change as part of its post-exploitation routine.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Windows Event ID 4657
  - Windows Event ID 7036
  - Windows Event ID 7040
  - User Workstations, Application Servers, Domain Controllers, Virtualization Hosts (Hypervisors)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH process creation events (EID 4688) for hashes in threat_intel_list.
      CORRELATE by host and time (within 5 mins) with firewall modification events (netsh command, EID 4657, EID 7036).
- question: Is a known malicious process being spawned by an unusual parent process before a firewall modification occurs?
  context: |
    This question focuses on identifying anomalous process lineage as an indicator of compromise. Certain parent-child relationships are common, while others are highly suspicious (e.g., `services.exe` spawning a non-system process). Calculating the rarity of this relationship helps prioritize alerts, as a rare pairing involving known malware that precedes a firewall change is a very strong signal of malicious activity.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Windows Event ID 4657
  - Windows Event ID 7036
  - Windows Event ID 7040
  - User Workstations, Application Servers, Domain Controllers, Virtualization Hosts (Hypervisors)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR processes with malicious_hash, GET parent_process.
      CALCULATE frequency of parent-child pair across historical data.
      IF rarity > threshold AND firewall_modification_follows, ALERT.
- question: Can a machine learning model, based on process metadata and subsequent host events, classify a sequence of actions as a likely firewall evasion attempt?
  context: |
    This question explores using a predictive model to automate the detection of complex evasion patterns. The model analyzes features like process hashes, parent processes, and command-line arguments to assign a probability score. A high score indicates the observed events strongly match patterns of firewall evasion, allowing for faster, automated responses like host quarantine.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 4104
  - Windows Event ID 4657
  - Windows Event ID 7036
  - Windows Event ID 7040
  - User Workstations, Application Servers, Domain Controllers, Virtualization Hosts (Hypervisors)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      INPUT process_metadata (hash, parent, cmdline) and subsequent_host_events (registry/service changes) into classification_model.
      IF model_output_probability > threshold, TRIGGER alert/response.
- question: Are there any processes being executed with command-line arguments that explicitly attempt to disable or modify the system firewall?
  context: |
    This is a direct detection approach to find the "smoking gun" by searching for specific commands (e.g., `netsh advfirewall set ... state off`, `Set-NetFirewallProfile -Enabled False`) in process creation and PowerShell logs. Finding these command strings is a high-fidelity indicator of a deliberate attempt to alter firewall rules.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - User Workstations, Application Servers, Domain Controllers, Virtualization Hosts (Hypervisors)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH process command lines (EID 4688) and PowerShell logs (EID 4104) for regex matching known firewall modification commands (e.g., 'netsh advfirewall set', 'Set-NetFirewallProfile -Enabled False').
- question: Has there been a statistically significant increase in the frequency or complexity of firewall modification commands executed by a specific user or on a particular host?
  context: |
    This question uses behavioral analysis to detect deviations from normal administrative behavior. A legitimate administrator might rarely change firewall rules, so a sudden burst of such commands from their account, or on a server that rarely sees such changes, is suspicious. Analyzing command-line argument complexity (entropy) can also reveal obfuscated or unusual commands.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - User Workstations, Application Servers, Domain Controllers, Virtualization Hosts (Hypervisors)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      BASELINE frequency of firewall commands per user/host.
      IF current_frequency > (mean + 3*std_dev), ALERT.
      ALSO, calculate command argument entropy; if spike, ALERT.
- question: Does a user's or host's recent command-line activity, including a firewall modification, represent an anomalous sequence when compared to its historical behavior?
  context: |
    This question applies sequence modeling to learn the typical order and context of commands for each user and host. A model can then identify a sequence of commands as anomalous even if individual commands are not inherently malicious. For example, a data staging command followed by `netsh` and an outbound connection command could be flagged as a low-probability, suspicious sequence.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - User Workstations, Application Servers, Domain Controllers, Virtualization Hosts (Hypervisors)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      INPUT user/host command sequence into trained LSTM model.
      IF model flags sequence containing a firewall command as low_probability, ALERT.
- question: Have any direct modifications been made to Windows Registry keys that control firewall policy, or has the firewall service been stopped or disabled?
  context: |
    This question targets changes to the underlying configuration of the Windows Firewall. Adversaries may bypass command-line tools and modify the registry directly or stop the firewall service (`mpssvc`) to evade detection. Alerting on these specific events, especially when not tied to a legitimate change request, provides a high-fidelity signal of defense tampering.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 7040
  - Windows Event ID 7036
  - Domain Controllers, User Workstations, Critical Application Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH for registry modifications (EID 4657) to 'HKLM\\...\\FirewallPolicy'.
      SEARCH for firewall service stop (EID 7036) or startup type change (EID 7040).
      CORRELATE with change_request_tickets; if no match, ALERT.
- question: Is there an anomalous spike in the number of firewall-related registry modifications or service changes on a specific host?
  context: |
    This question aims to detect brute-force or scripted attempts to alter firewall settings that might generate a high volume of events in a short period. While a single registry change might be missed, a sudden burst of modifications is highly abnormal and can be detected by comparing the event rate to a historical baseline for that host using statistical measures like a Z-score.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 7040
  - Windows Event ID 7036
  - Domain Controllers, User Workstations, Critical Application Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      COUNT firewall registry/service change events per host in 5-min windows.
      CALCULATE Z-score against historical baseline.
      IF Z-score > 3.0, ALERT.
- question: Can an unsupervised machine learning model identify a sequence of host events, including firewall registry or service changes, as a significant outlier compared to normal activity?
  context: |
    This question leverages unsupervised learning to find "unknown unknowns." An anomaly detection model can identify rare combinations of events without prior training on malicious examples. It learns what normal host activity looks like and flags any event sequences that are highly unusual. A sequence involving firewall modifications that is flagged as an outlier is a strong candidate for investigation.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 7040
  - Windows Event ID 7036
  - Domain Controllers, User Workstations, Critical Application Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      VECTORIZE host event sequences (registry changes, service changes, etc.).
      INPUT vectors into trained Isolation Forest model.
      IF model scores a sequence involving firewall changes as a high-anomaly outlier, ALERT.
- question: Following a firewall modification on a host, did that same host initiate an outbound connection to a known malicious or high-risk port?
  context: |
    This question connects defense evasion with its likely purpose: establishing command and control (C2). An adversary may disable the firewall specifically to open a port for communication. Correlating the firewall change with a subsequent connection to a port known for C2 traffic (e.g., 4444, 6667) within a short time frame creates a very high-confidence alert.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Windows Event ID 4657
  - Windows Event ID 7036
  - Windows Event ID 7040
  - Zeek conn.log
  - Network Egress/Ingress Points, Internal Network Segments, Host-based firewalls
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON firewall_modification_event (cmd, registry, service), CORRELATE by host and time (within 5 mins) with outbound network connections (Zeek conn.log).
      IF destination_port is in high_risk_C2_list, ALERT.
- question: After a firewall modification, did the host connect to a destination port that is statistically rare for that specific host?
  context: |
    This question looks for anomalous network behavior post-firewall-modification, even if the destination port isn't on a known-bad list. By baselining the normal outbound ports for each host, any connection to a port outside this established pattern (e.g., beyond the 99th percentile) becomes suspicious. This helps detect novel C2 channels.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Windows Event ID 4657
  - Windows Event ID 7036
  - Windows Event ID 7040
  - Zeek conn.log
  - Network Egress/Ingress Points, Internal Network Segments, Host-based firewalls
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON firewall_modification_event, MONITOR subsequent outbound connections.
      BASELINE common destination ports per host.
      IF connection_port is outside 99th percentile for that host, ALERT.
- question: Is there a statistically significant leading relationship where firewall modifications predict the occurrence of anomalous network connections?
  context: |
    This question seeks to mathematically prove the connection between two types of events over time. A cross-correlation model can analyze streams of firewall modification events and network connection events to determine if one consistently precedes the other. A strong positive correlation can be used to automatically identify this multi-stage attack behavior.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Windows Event ID 4657
  - Windows Event ID 7036
  - Windows Event ID 7040
  - Zeek conn.log
  - Network Egress/Ingress Points, Internal Network Segments, Host-based firewalls
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      APPLY cross-correlation model to time series of (1) firewall_modification_events and (2) anomalous_network_connections.
      IF model finds significant leading correlation from (1) to (2), ALERT.
- question: Is a host accepting inbound connections on a port that has not been explicitly approved for it?
  context: |
    This question focuses on policy enforcement. It presupposes an inventory of allowed services and ports for assets. Any successful inbound connection to a port not on this "allow-list" is an immediate policy violation and a strong indicator that the firewall has been opened, either maliciously or through misconfiguration.
  answer_sources:
  - Zeek conn.log
  - Network Egress/Ingress Points, DMZ Network Segment, Server Farm Network Segment
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      MAINTAIN allow_list of ports per host/segment.
      SEARCH inbound connections (Zeek conn.log, state 'SF').
      IF destination_port NOT IN host_allow_list, ALERT.
- question: Has a host shown a sustained and statistically significant increase in its number of listening ports or inbound connections from unique sources?
  context: |
    This question aims to detect the symptom of a disabled firewall: a sudden increase in network exposure. By tracking metrics like the count of unique listening ports or unique source IPs over time, a statistical model can detect a sharp, sustained deviation from the norm. This is useful for detecting when a firewall has been completely disabled.
  answer_sources:
  - Zeek conn.log
  - Network Egress/Ingress Points, DMZ Network Segment, Server Farm Network Segment
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each host, CALCULATE hourly moving_average and std_dev of unique_listening_ports and unique_inbound_IPs.
      IF current_hour_count > (moving_average + 3*std_dev) for a sustained period, ALERT.
- question: Has a host's overall network behavior profile changed so dramatically that it is now clustered with anomalous devices or flagged as a network outlier?
  context: |
    This question uses unsupervised machine learning to group hosts with similar network characteristics. A host whose firewall is disabled will exhibit a drastic change in its traffic profile. A clustering algorithm can detect this shift, causing the host to move to a different cluster or be labeled as an outlier, signaling a significant state change.
  answer_sources:
  - Zeek conn.log
  - Network Egress/Ingress Points, DMZ Network Segment, Server Farm Network Segment
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CREATE feature vectors for hosts (port entropy, connection counts, etc.).
      APPLY DBSCAN clustering.
      IF a host changes cluster or is identified as a noise point, ALERT.