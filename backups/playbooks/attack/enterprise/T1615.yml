name: T1615: Group Policy Discovery
id: 3c57b77f-178c-4b56-9e66-c92330a84e62
description: This playbook focuses on detecting adversarial discovery of Group Policy settings. An adversary may perform this activity to identify environmental weaknesses, misconfigurations, or sensitive data stored in GPOs. Detection methods include identifying the execution of known discovery tools (like PowerView or BloodHound) by their hash; spotting the use of native utilities (gpresult.exe, PowerShell) with specific enumeration commands; monitoring for unusual volumes of LDAP queries targeting 'groupPolicyContainer' objects; detecting anomalous file access patterns within the SYSVOL 'Policies' directory; and correlating the sequence of an LDAP query for GPOs followed by SMB access to the SYSVOL share.
type: technique
related:
- TA0007: Discovery
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has a process executed with a file hash matching a known Group Policy discovery tool?
  context: This question aims to detect the use of well-known malicious tools like PowerView or BloodHound ingestors by matching their file hashes against a threat intelligence feed. A match is a strong indicator of compromise, as these tools are purpose-built for reconnaissance.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Domain-joined endpoints and member servers where command execution and process creation are logged.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      SEARCH process creation events (EID 4688, Sysmon EID 1)
      WHERE process_hash IN (list_of_known_malicious_GPO_tool_hashes)
      RETURN hostname, username, process_name, process_hash
- question: Has a legitimate GPO discovery tool (e.g., gpresult.exe) been spawned by a statistically rare parent process?
  context: This question looks for anomalous process ancestry. Legitimate tools are often run from specific parent processes (like `cmd.exe`). If a tool like `gpresult.exe` is spawned by an unusual parent, such as `winword.exe` or `outlook.exe`, it could indicate a phishing-based attack or process injection.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Domain-joined endpoints and member servers where command execution and process creation are logged.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR each execution of a GPO discovery tool (e.g., gpresult.exe):
        CALCULATE rarity of parent_process based on historical data
        IF rarity > 99th percentile:
          ALERT on rare parent-child relationship
- question: Does the execution of a GPO-related process exhibit characteristics classified as suspicious by a machine learning model?
  context: This question uses a supervised classification model to identify subtle deviations from normal administrative behavior. The model considers multiple features (process name, parent, command line, user) to make a holistic judgment, allowing it to catch novel or evasive techniques that symbolic or statistical methods might miss.
  answer_sources:
  - Windows Event ID 4688
  - Windows Event ID 1 (Sysmon)
  - Domain-joined endpoints and member servers where command execution and process creation are logged.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR each GPO-related process execution:
        EXTRACT features (process, parent, cmdline, user, hash)
        INPUT features into classification_model
        IF model_prediction == 'suspicious':
          ALERT on suspicious execution
- question: Has a native utility like `gpresult.exe` or PowerShell been executed with command-line arguments or script content indicative of Group Policy enumeration?
  context: This question targets the direct use of built-in Windows tools for GPO discovery. Adversaries use specific commands like `gpresult /z` or PowerShell cmdlets like `Get-GPO -All` to gather detailed policy information. Detecting these specific patterns is a reliable way to spot enumeration activity.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - All domain-joined endpoints and member servers, especially those used by system administrators where PowerShell logging is enabled.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      SEARCH process events (EID 4688) and PowerShell logs (EID 4104)
      WHERE (process_name == 'gpresult.exe' AND command_line CONTAINS '/z')
      OR (script_block CONTAINS 'Get-GPO -All' OR 'Get-NetGPO')
      RETURN hostname, username, command_line, script_block
- question: Has a GPO-related command been executed with unusually high command-line entropy or by a rare user-host combination?
  context: This question aims to detect obfuscated commands or unusual user behavior. High entropy in a command line can indicate encoding or randomization used to evade simple signature-based detections. Similarly, a command being run by a user on a host where they've never run it before can be a sign of compromised credentials or lateral movement.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - All domain-joined endpoints and member servers, especially those used by system administrators where PowerShell logging is enabled.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR each GPO-related command execution:
        CALCULATE command_line_entropy
        ANALYZE frequency of (user, host, command) triplet
        IF entropy > 95th percentile OR triplet_is_rare:
          ALERT on anomalous command
- question: Has a user exhibited a sudden spike in the frequency of GPO discovery commands, as identified by a time-series anomaly detection model?
  context: This question seeks to identify changes in the tempo of administrative activity. A legitimate administrator might perform GPO checks occasionally, but an adversary gathering information might issue many commands in a short period. A time-series model can learn a user's normal rhythm and flag sudden, uncharacteristic bursts of activity.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - All domain-joined endpoints and member servers, especially those used by system administrators where PowerShell logging is enabled.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR each user:
        MONITOR hourly frequency of GPO discovery commands
        INPUT frequency into time_series_model
        IF model_detects_anomaly (spike):
          ALERT on anomalous frequency
- question: Has an LDAP search query been observed specifically filtering for 'groupPolicyContainer' objects?
  context: This question targets a highly specific indicator of GPO discovery. Tools like BloodHound and PowerView use this exact LDAP filter to find all GPOs in a domain. While not malicious on its own, it's a strong reconnaissance signal that warrants correlation with other activity from the source host.
  answer_sources:
  - Zeek ldap.log
  - Windows Event ID 4661
  - Network traffic to and from Domain Controllers, and Directory Service Access audit logs on Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      SEARCH LDAP logs (Zeek ldap.log, EID 4661)
      WHERE ldap_filter CONTAINS '(objectClass=groupPolicyContainer)'
      RETURN source_ip, user, full_query
- question: Has a single host generated a statistically significant volume of LDAP queries for 'groupPolicyContainer' objects compared to its own baseline?
  context: This question moves beyond a single query to look at volume. A single query might be a fluke, but a large number of them from one host in a short time is a strong sign of automated enumeration. By comparing the activity to the host's own history, this method can flag unusual behavior even from hosts that perform occasional legitimate queries.
  answer_sources:
  - Zeek ldap.log
  - Windows Event ID 4661
  - Network traffic to and from Domain Controllers, and Directory Service Access audit logs on Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR each source_host:
        CALCULATE hourly count of 'groupPolicyContainer' queries
        COMPARE to host's historical mean and standard deviation
        IF count > (mean + 3 * std_dev):
          ALERT on query volume spike
- question: Does a host's LDAP query activity fall into an 'anomalous enumeration' cluster as determined by an unsupervised machine learning model?
  context: This question uses clustering to group hosts with similar LDAP behavior. The model can automatically separate normal administrative activity from suspicious enumeration patterns based on features like query frequency, timing, and complexity, without needing pre-labeled data. This is useful for discovering new or unknown enumeration techniques.
  answer_sources:
  - Zeek ldap.log
  - Windows Event ID 4661
  - Network traffic to and from Domain Controllers, and Directory Service Access audit logs on Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR all LDAP query events:
        EXTRACT features (source_ip, frequency, filter_complexity, time_of_day)
        INPUT features into clustering_model (e.g., DBSCAN)
        INVESTIGATE hosts in 'outlier' or 'anomalous' clusters
- question: Has a non-administrative user account accessed an unusual number of files in the SYSVOL 'Policies' directory?
  context: This question focuses on unauthorized or suspicious access to the directory where GPO files are stored. Typically, only administrators should be interacting with these files. Access by a standard user, especially if they are reading multiple policy files, is a major red flag for reconnaissance.
  answer_sources:
  - Zeek smb_files.log
  - Windows Event ID 4663
  - SYSVOL share on all Domain Controllers where file system and SMB access auditing is enabled.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      SEARCH file access logs (Zeek smb_files.log, EID 4663) for path `\\SYSVOL\\*\\Policies\`
      GROUP by user, 10-minute window
      WHERE user NOT IN (admin_groups) AND count(distinct_files) > 5
      ALERT on suspicious access
- question: Has any user session on the SYSVOL share involved reading a statistically anomalous number of policy files compared to the overall baseline?
  context: This question establishes a baseline for how many policy files are typically read during a single user session and flags significant outliers. This can catch not only non-admins but also a potentially compromised administrative account being used to perform an unusually broad enumeration of all GPOs.
  answer_sources:
  - Zeek smb_files.log
  - Windows Event ID 4663
  - SYSVOL share on all Domain Controllers where file system and SMB access auditing is enabled.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR each user session accessing SYSVOL 'Policies' directory:
        COUNT number of unique files read
        COMPARE count to historical distribution across all users
        IF count > 98th percentile:
          ALERT on high-volume file access
- question: Does a SYSVOL file access event fall outside the boundary of 'normal' activity as defined by a one-class SVM model?
  context: This question uses an anomaly detection model that learns what legitimate SYSVOL access looks like. Any activity that doesn't fit this learned profile—considering the user, source host, time of day, and volume of access—is flagged as an anomaly. This is powerful for detecting novel attack patterns that don't match any pre-defined rules.
  answer_sources:
  - Zeek smb_files.log
  - Windows Event ID 4663
  - SYSVOL share on all Domain Controllers where file system and SMB access auditing is enabled.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      FOR each SYSVOL access event:
        EXTRACT features (host, user, file_count, time_of_day)
        INPUT features into one_class_svm_model
        IF model_prediction == 'anomaly':
          ALERT on anomalous access event
- question: Has a host performed an LDAP query for 'groupPolicyContainer' objects and then immediately accessed the SYSVOL 'Policies' share?
  context: This question looks for a specific two-step attack chain that is highly indicative of GPO enumeration. Adversaries first use LDAP to discover GPOs and their locations, then use SMB to access the SYSVOL share to read the actual policy files. Detecting this sequence in a short time window from the same source is a high-confidence indicator of malicious activity.
  answer_sources:
  - Zeek ldap.log
  - Zeek smb_files.log
  - Windows Event ID 4661
  - Windows Event ID 4663
  - Domain Controllers and network segments connecting endpoints to Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      WHEN LDAP query for `(objectClass=groupPolicyContainer)` from source_ip:
        WITHIN 5 minutes:
          IF SMB access to `\\SYSVOL\\*\\Policies\\` from same source_ip:
            GENERATE high-severity alert
- question: Has the sequence of an 'LDAP GPO Query' followed by an 'SMB SYSVOL Access' occurred, where the probability of this transition is historically very low?
  context: This question formalizes the sequential analysis by calculating the actual probability of the attack chain occurring based on historical data. In a normal environment, the probability of this specific sequence is near zero. Flagging events based on this low transition probability provides a statistically rigorous way to detect this behavioral anomaly.
  answer_sources:
  - Zeek ldap.log
  - Zeek smb_files.log
  - Windows Event ID 4661
  - Windows Event ID 4663
  - Domain Controllers and network segments connecting endpoints to Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      CALCULATE transition probability P(SMB_SYSVOL_Access | LDAP_GPO_Query)
      IF observed_sequence_occurs AND P < 0.01:
        ALERT on statistically significant event sequence
- question: Has an observed sequence of user/host actions (LDAP query then SMB access) been assigned a very low likelihood by a sequence analysis model like an HMM?
  context: This question uses a more advanced model to understand entire sequences of actions, not just pairs. A Hidden Markov Model (HMM) can learn the 'grammar' of normal network behavior. The specific, malicious sequence of GPO discovery and file access will appear as an 'ungrammatical' or highly improbable sentence to the model, allowing it to be flagged as a high-confidence anomaly.
  answer_sources:
  - Zeek ldap.log
  - Zeek smb_files.log
  - Windows Event ID 4661
  - Windows Event ID 4663
  - Domain Controllers and network segments connecting endpoints to Domain Controllers.
  range: last 90 days
  queries:
  - technology: Pseudocode
    query: |-
      INPUT sequence of events (LDAP, SMB, etc.) into HMM model
      MODEL calculates likelihood of the observed sequence
      IF likelihood is below a learned threshold:
        ALERT on anomalous sequence of actions