name: T1584.008: Network Devices
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: "This playbook helps determine if an adversary is developing resources by compromising third-party network devices for use in targeting. It focuses on detecting signs of compromise and misuse, such as communication with known malicious infrastructure (botnets, compromised routers, proxies), traffic patterns indicative of malware that infects network devices (specific JA3/S hashes, user-agents, SNIs), long-running or beaconing connections to residential IPs, scanning activity from residential IPs, and traffic funneling or proxying where DNS resolutions do not match connection destinations."
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have we ingested and properly tagged high-confidence threat intelligence feeds related to compromised network devices, botnet C2s, and anonymous proxies?
    context: This is a foundational step. To detect communication with adversary-controlled network infrastructure, we must first have a reliable and up-to-date source of known bad IPs and domains. Properly tagging this intelligence by category (e.g., 'compromised router', 'botnet C2') allows for more specific and context-rich alerting.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          VERIFY threat_intel_feeds ARE active AND tagged
          FOR feed IN threat_intel_feeds
            CHECK last_update_time < 24 hours
            CHECK tags IN ('compromised router', 'botnet C2', 'proxy')
  - question: Are any internal hosts communicating with external IP addresses listed on our threat intelligence feeds for compromised network devices, botnets, or proxies?
    context: This question directly hunts for connections between the internal network and known malicious infrastructure. A match is a strong indicator of compromise or an attempted attack, as it shows direct interaction with an adversary's pre-positioned assets. Including the threat category in the alert provides immediate context for the analyst.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SELECT * FROM network_flows
          WHERE source_ip IS internal AND destination_ip IN compromised_device_intel
             OR destination_ip IS internal AND source_ip IN compromised_device_intel
  - question: For connections to known malicious IPs, are the connection duration or data volume anomalously high compared to the host's normal behavior?
    context: This step helps prioritize alerts. A brief, low-volume connection to a malicious IP might be incidental, but a long-duration or high-volume connection is more likely to be significant, such as a large data transfer or a persistent C2 channel. Comparing against the host's own baseline helps filter out hosts that normally have long or high-volume connections.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_alert FROM previous_query
            CALCULATE percentile_rank(alert.duration) FOR host IN last 30d
            CALCULATE percentile_rank(alert.total_bytes) FOR host IN last 30d
            IF percentile_rank.duration > 95 AND percentile_rank.total_bytes > 95
              ESCALATE alert_priority
  - question: Is there an anomalous spike in the total volume of traffic to or from any category of malicious infrastructure (e.g., 'botnet', 'proxy') across the entire network?
    context: This question moves from single-host detection to a network-wide view. A sudden, unexpected increase in traffic to a specific category of threat infrastructure could indicate a widespread campaign or a new, large-scale infection. Time-series analysis can detect such deviations from the established norm.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Internet Gateway
      - Firewall Logs
      - Network Taps
      - Perimeter DNS Servers
      - Endpoint Network Telemetry
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          AGGREGATE total_bytes per hour BY threat_intel_category
          APPLY time_series_model ON aggregated_data
          ALERT IF current_bytes > model.confidence_interval_99_upper
  - question: Are any outbound connections using TLS fingerprints (JA3/JA3S), SNI values, or HTTP User-Agents known to be associated with malware that infects network devices?
    context: Adversaries often use specific malware to compromise routers and other devices. This malware has identifiable characteristics in its network traffic, such as the cryptographic client it uses (JA3/JA3S) or the headers it sends (User-Agent, SNI). Searching for these specific indicators allows for the detection of known malware families.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Zeek files.log
      - Windows Event ID 4688
      - Internet Gateway
      - DNS Resolvers
      - Endpoint EDR Logs
      - Web Proxies
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SELECT * FROM ssl_logs, http_logs
          WHERE ja3s_hash IN known_malware_ja3s
             OR tls_sni IN known_malware_sni
             OR user_agent IN known_malware_user_agents
  - question: Has any host shown a sudden, anomalous decrease in the variety of its TLS clients (JA3S) or browser identifiers (User-Agents)?
    context: A normal host uses various applications and browsers, creating a diverse set of network indicators (high entropy). Malware, especially a bot, often uses a single, hardcoded client, resulting in very low diversity (low entropy). A sudden drop in entropy for a host can indicate that its traffic is being dominated by a single, repetitive malicious process.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Zeek files.log
      - Windows Event ID 4688
      - Internet Gateway
      - DNS Resolvers
      - Endpoint EDR Logs
      - Web Proxies
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_host
            CALCULATE entropy(ja3s_hashes) in last 24h
            CALCULATE entropy(user_agents) in last 24h
            COMPARE current_entropy to historical_baseline
            ALERT IF current_entropy < 5th_percentile_of_baseline
  - question: Can machine learning models identify outbound connections that are highly likely to be malicious based on a combination of network features?
    context: This question aims to detect unknown or novel threats that don't match specific indicators. By training a model on the characteristics of known good and known bad traffic (like JA3S, SNI, duration, etc.), it can learn to identify suspicious combinations of these features and assign a risk score, uncovering threats that might otherwise be missed.
    answer_sources:
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Zeek files.log
      - Windows Event ID 4688
      - Internet Gateway
      - DNS Resolvers
      - Endpoint EDR Logs
      - Web Proxies
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_connection
            EXTRACT features (ja3s, sni, user_agent, duration, bytes)
            SCORE connection with ML_model
            ALERT IF score > 0.9
  - question: Are any internal hosts maintaining long-duration connections to IP addresses within residential ISP networks on non-standard ports?
    context: Adversaries often use compromised home routers or computers for C2 infrastructure because they are numerous and blend in with normal internet traffic. However, legitimate business traffic to residential networks, especially long-running connections on unusual ports, is rare. Detecting such activity can uncover hidden C2 channels.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - VPN Concentrators
      - Core Switches
      - Egress points of the network
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          ENRICH network_flows with ASN_info
          FILTER flows where destination_asn_type IS 'residential' AND port IS NOT common_web_port
          AGGREGATE total_duration by internal_host, destination_ip over 24h
          ALERT IF total_duration > 1 hour
  - question: Are there any highly regular, machine-like 'beaconing' connections from internal hosts to IPs in residential networks?
    context: Malware C2 communications are often automated, resulting in highly periodic connections (e.g., every 60 seconds) with similarly sized payloads (e.g., a small "heartbeat" packet). This regularity is machine-like and differs from human-generated traffic. A very low standard deviation in both connection timing and data size is a strong indicator of automated beaconing.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - VPN Concentrators
      - Core Switches
      - Egress points of the network
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each pair(internal_host, residential_dest_ip)
            CALCULATE stddev(time_between_connections) in 1h window
            CALCULATE stddev(bytes_sent) in 1h window
            ALERT IF stddev(time) < 2s AND stddev(bytes) < 10
  - question: Does any internal host exhibit anomalous traffic patterns to residential networks that deviate from its own baseline behavior?
    context: This question seeks to find unusual behavior without pre-defined rules. An unsupervised model like Isolation Forest can learn a host's "normal" way of communicating with residential IPs (which might be zero) and flag any activity that falls outside that norm. This is useful for detecting novel beaconing patterns or other suspicious activities that don't fit a simple low-standard-deviation model.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway
      - VPN Concentrators
      - Core Switches
      - Egress points of the network
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_host
            CREATE timeseries of connections to residential_ASNs
            APPLY IsolationForest(frequency, duration, bytes)
            ALERT IF algorithm identifies anomaly
  - question: Are external IPs that are observed scanning our network subsequently attempting to exploit vulnerabilities?
    context: The "scan-then-exploit" pattern is a classic attack sequence. An adversary first scans for open ports or vulnerable services and then follows up with an exploit attempt against what they found. Correlating scan detections with subsequent exploit attempts from the same IP address provides high-confidence evidence of a targeted attack.
    answer_sources:
      - Zeek conn.log
      - Zeek scan.log
      - Zeek http.log
      - Zeek notice.log
      - DMZ
      - Internet-facing Web Servers
      - External Firewall
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_scan_event from scanner_ip
            SEARCH for scanner_ip in other logs (http, etc.) within 15 mins
            IF subsequent traffic matches known_exploit_patterns
              ESCALATE alert
  - question: Is any single external IP address attempting to connect to an anomalously high number of internal hosts or ports in a short time frame?
    context: This is a method for detecting scanning behavior. A legitimate external client typically connects to one or a few internal hosts on specific ports. A scanner, however, will connect to many different hosts (horizontal scan) or many different ports on one host (vertical scan). An external IP connecting to an unusually large number of both hosts and ports is highly suspicious.
    answer_sources:
      - Zeek conn.log
      - Zeek scan.log
      - Zeek http.log
      - Zeek notice.log
      - DMZ
      - Internet-facing Web Servers
      - External Firewall
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_external_ip in 5min_window
            CALCULATE distinct_count(internal_dest_ip)
            CALCULATE distinct_count(dest_port)
            ALERT IF count(dest_ip) > 99.9th_percentile AND count(port) > 99.9th_percentile
  - question: Can clustering algorithms identify dense pockets of activity indicative of a network scan from a single external source?
    context: This is an advanced, machine-learning-based approach to scan detection. Algorithms like DBSCAN can process connection events in real-time and automatically group them into clusters based on their properties. A scan will appear as a dense cluster of points originating from one source IP but spreading to many destinations in a tight time window. This can detect scans without relying on pre-calculated percentile thresholds.
    answer_sources:
      - Zeek conn.log
      - Zeek scan.log
      - Zeek http.log
      - Zeek notice.log
      - DMZ
      - Internet-facing Web Servers
      - External Firewall
      - Intrusion Detection/Prevention Systems (IDS/IPS)
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          STREAM connection_events TO DBSCAN_model
          MODEL features: [src_ip, dest_ip, dest_port, timestamp]
          ALERT IF model finds dense_cluster from single src_ip
  - question: Are internal hosts connecting to a residential IP address that is different from the IP address they received from a DNS query for the requested domain?
    context: This behavior is a strong indicator of traffic proxying or "domain fronting," where an adversary hides their true destination. The host resolves a legitimate domain but the traffic is actually sent to a malicious IP. The mismatch between the DNS answer and the actual connection destination, especially when the destination is a residential IP, is highly suspicious.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek http.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Endpoint Network Logs
      - Core Network Taps
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_connection with domain_name (from SNI/Host)
            LOOKUP preceding DNS_response for domain_name in last 2 mins
            IF connection.dest_ip NOT IN DNS_response.ips
              AND connection.dest_ip IS residential
              ALERT
  - question: Is any internal host resolving many different domain names but sending the traffic to only one or a few IP addresses?
    context: This is a mathematical way to detect traffic funneling. Normally, a host resolving 10 different domains would connect to several different IPs, so the ratio of IPs to FQDNs would be close to 1. If a host resolves 10 domains but all traffic goes to a single IP, the ratio becomes 0.1. A sudden, sharp drop in this ratio for a host indicates its traffic is likely being funneled through a single proxy.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek http.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Endpoint Network Logs
      - Core Network Taps
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each_host in 1h_window
            CALCULATE ratio = distinct(dest_ips) / distinct(resolved_fqdns)
            COMPARE ratio to host's_historical_baseline
            ALERT IF ratio < 5th_percentile_of_baseline
  - question: Can graph analysis identify communities of internal hosts whose traffic is being covertly funneled through a small number of anomalous external 'hub' IPs?
    context: This is a sophisticated, network-wide approach to detecting traffic funneling. By building a graph of `host-connects-to-domain`, we can find groups of machines that behave similarly. We can then analyze the traffic for these groups. If a whole community of hosts is resolving many different domains but all their traffic is landing on one suspicious residential IP, it's a strong sign of a coordinated, adversary-controlled proxy network.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Zeek http.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Endpoint Network Logs
      - Core Network Taps
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          BUILD graph of (internal_hosts, fqdns)
          RUN community_detection on graph
          FOR each_community
            ANALYZE destination_ips for traffic from community
            IF ips are concentrated on a few 'hub' IPs
              AND 'hub' IPs are anomalous (e.g., residential)
              ALERT