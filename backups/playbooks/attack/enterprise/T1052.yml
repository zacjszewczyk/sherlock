name: "T1052: Exfiltration Over Physical Medium"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps investigate whether an adversary is exfiltrating data via a physical medium. This involves detecting file writes to removable media by known malicious processes, identifying suspicious command-line copy operations to external drives, correlating the staging of data into archive files with subsequent writes to removable media, and baselining user activity to detect anomalous volumes, frequencies, or types of data being written to physical devices."
type: "technique"
related:
  - "TA0010: Exfiltration"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Has a known malicious process written files to a removable media device?"
    context: "This question aims to detect straightforward exfiltration attempts where an adversary uses a tool with a known malicious hash (an IOC) to write data to a USB drive or other removable media. A match provides a high-confidence signal of malicious activity."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All endpoints (desktops, laptops), servers with accessible physical ports (e.g., USB), and workstations used by privileged accounts or users with access to sensitive data repositories."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH file_write_events (e.g., WinEvent:4663) where destination is removable_media
          JOIN process_creation_events (e.g., WinEvent:4688, Sysmon:1) on ProcessID
          CALCULATE hash of process_executable
          MATCH hash against malicious_hash_threat_feed
          RETURN matching events
  - question: "Are there any statistically rare or previously unseen processes writing to removable media?"
    context: "This question helps uncover novel or custom malware that isn't on any blocklist. By baselining normal activity, it flags processes that behave unusually, such as a legitimate but rarely used system utility being hijacked for exfiltration, which might otherwise be missed."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All endpoints (desktops, laptops), servers with accessible physical ports (e.g., USB), and workstations used by privileged accounts or users with access to sensitive data repositories."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each process_name writing to removable_media:
            CALCULATE frequency over last 30 days
          IDENTIFY process_names in bottom 5th percentile of frequency
          IDENTIFY process_names with zero historical frequency
          RETURN outlier processes
  - question: "Can a machine learning model classify any file write events to removable media as suspicious based on process characteristics?"
    context: "This question leverages machine learning to identify subtle, complex patterns indicative of malicious behavior that are difficult to define with simple rules or statistics. It analyzes multiple features together (like parent process, integrity level, and file type) to make a more nuanced determination of malicious intent."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All endpoints (desktops, laptops), servers with accessible physical ports (e.g., USB), and workstations used by privileged accounts or users with access to sensitive data repositories."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each removable_media_write_event:
            EXTRACT features (process_name, parent_process, integrity_level, file_extension, is_signed)
            INPUT features into pre-trained classification_model
            RETURN events classified as 'suspicious' with high_confidence_score
  - question: "Have any command-line tools been used to copy files from a sensitive directory to a removable media device?"
    context: "This question looks for explicit commands (like xcopy or Copy-Item) that show clear intent to move data from a known sensitive location (like a finance or HR share) to a removable drive. This is a direct and high-fidelity indicator of data theft."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows PowerShell Event ID 4104"
      - "Sysmon Event ID 1"
      - "All endpoints and servers with command-line auditing enabled, administrative jump boxes, developer workstations, and servers hosting critical data."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH process_creation_logs (e.g., WinEvent:4688, PowerShell:4104, Sysmon:1)
          WHERE process_name is in (xcopy, robocopy, Copy-Item, bitsadmin)
          AND command_line_source_arg matches sensitive_path_pattern
          AND command_line_destination_arg matches removable_media_path_pattern
          RETURN matching command_line events
  - question: "Are there any file copy commands to removable media with unusually complex or long file paths, or that copy an anomalously large number of files?"
    context: "This question helps detect obfuscation techniques. Adversaries may use complex or randomized paths to hide their activity. High entropy can be a sign of this. Similarly, copying an unusually large number of files at once can indicate bulk data collection, which deviates from normal user behavior."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows PowerShell Event ID 4104"
      - "Sysmon Event ID 1"
      - "All endpoints and servers with command-line auditing enabled, administrative jump boxes, developer workstations, and servers hosting critical data."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each file_copy_command to removable_media:
            CALCULATE shannon_entropy of source/destination paths
            CALCULATE number_of_files_copied (if wildcard is used)
          COMPARE path_entropy against 95th percentile baseline
          COMPARE file_count against user's historical average
          RETURN commands exceeding thresholds
  - question: "Does a machine learning model identify any command-line sequences involving removable media as anomalous?"
    context: "This question uses advanced modeling to understand the structure and sequence of 'normal' commands. It can detect malicious activity even when the command uses legitimate tools, by recognizing that the combination and order of arguments are highly unusual and don't match any learned benign patterns."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows PowerShell Event ID 4104"
      - "Sysmon Event ID 1"
      - "All endpoints and servers with command-line auditing enabled, administrative jump boxes, developer workstations, and servers hosting critical data."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each new command_line involving removable_media:
            TOKENIZE the command string
            INPUT token_sequence into pre-trained LSTM_autoencoder_model
            CALCULATE reconstruction_error
          RETURN commands with high reconstruction_error
  - question: "Was an archive file created and then quickly copied to a removable media device on the same host?"
    context: "This question targets the common adversary tactic of 'staging' data. Adversaries often compress and encrypt data into a single archive file (like a .zip or .rar) before exfiltrating it. Detecting this sequence—creation of an archive followed immediately by a copy to USB—is a strong indicator of data collection and exfiltration."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 11"
      - "User workstations, file servers, staging servers, and temporary directories (C:\\Users\\*\\AppData\\Local\\Temp, C:\\Windows\\Temp) on application servers."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH for archive_creation_events (e.g., Sysmon:11, or WinEvent:4688 for 7z.exe)
          CORRELATE with file_write_events (e.g., WinEvent:4663) on the same host and filename
          WHERE time_delta is less than 10 minutes
          AND write_destination is removable_media
          RETURN correlated event pairs
  - question: "Has any 'stage-and-copy' activity involved unusually large archive files or an extremely short time between creation and copying?"
    context: "This question adds statistical context to the 'stage-and-copy' pattern. While some legitimate staging might occur, malicious exfiltration is often characterized by very large archives (bulk data theft) being copied almost immediately after creation (to minimize detection window). Flagging statistical extremes helps prioritize the most suspicious events."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 11"
      - "User workstations, file servers, staging servers, and temporary directories (C:\\Users\\*\\AppData\\Local\\Temp, C:\\Windows\\Temp) on application servers."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each correlated 'stage-and-copy' sequence:
            ANALYZE archive_file_size and time_delta
          IDENTIFY sequences where file_size is in top 2nd percentile
          AND time_delta is in bottom 2nd percentile
          RETURN high-priority sequences
  - question: "Can a time-series model detect the specific temporal pattern of 'archive, then copy to removable media' as an anomaly in a host's event stream?"
    context: "This question applies machine learning to view host activity as a continuous stream of events. A time-series model can learn the normal rhythm and sequence of events. The specific, rare pattern of creating a large archive and immediately writing it to a USB drive will stand out as a significant anomaly against this learned baseline of normal operations."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4663"
      - "Sysmon Event ID 11"
      - "User workstations, file servers, staging servers, and temporary directories (C:\\Users\\*\\AppData\\Local\\Temp, C:\\Windows\\Temp) on application servers."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          MODEL event stream (process_creates, file_creates, file_writes) for each host as a time_series
          INPUT new event sequences into pre-trained time_series_anomaly_model (e.g., Isolation Forest)
          RETURN sequences identified as anomalous, especially those matching the 'archive-then-copy' pattern
  - question: "Has any user written an unusual number of high-risk file types (e.g., .pst, .bak, .sql) to removable media in a short time frame?"
    context: "This question focuses on the type of data being exfiltrated. Files like email archives (.pst), database backups (.bak, .sql), or password databases (.kdbx) are high-value targets. A rule that alerts when a user suddenly starts moving multiple of these sensitive file types to a USB drive can catch targeted data theft."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4656"
      - "All endpoints with object access auditing enabled for removable storage, particularly those used by privileged users, executives, or personnel in sensitive roles (e.g., HR, Finance, R&D)."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each user, within a 1-hour window:
            COUNT file_writes to removable_media
            WHERE file_extension is in (pst, ost, bak, sql, pfx, kdbx, nsf, mdb)
          IF count > 5:
            RETURN alert for that user
  - question: "Has a user's daily removable media activity (volume, file count, etc.) significantly deviated from their own historical baseline across multiple metrics?"
    context: "This question looks for a sudden change in a user's behavior. An employee who rarely uses USB drives and suddenly writes gigabytes of data across hundreds of files is a major red flag. By tracking multiple metrics (volume, count, types) and using Z-scores to measure deviation, this method can reliably spot behavior that is abnormal for that specific user."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4656"
      - "All endpoints with object access auditing enabled for removable storage, particularly those used by privileged users, executives, or personnel in sensitive roles (e.g., HR, Finance, R&D)."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each user's daily removable_media_writes:
            CALCULATE Z-score for total_volume, file_count, unique_extension_count vs user's 30-day baseline
          IF two or more metrics have Z-score > 3:
            RETURN alert for that user's anomalous daily activity
  - question: "Has a user's removable media write behavior caused them to become a statistical outlier compared to their peer group?"
    context: "This question uses peer group analysis to provide context. An action might be normal for one role (e.g., a video editor moving large files) but highly abnormal for another (e.g., an accountant). By clustering users into behavioral groups, this method can identify when a user's activity suddenly deviates not just from their own past, but also from their peers, indicating a potential account compromise or insider threat."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4656"
      - "All endpoints with object access auditing enabled for removable storage, particularly those used by privileged users, executives, or personnel in sensitive roles (e.g., HR, Finance, R&D)."
    range: "Last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          ON a nightly basis, for each user:
            FEATURIZE past 24-hour removable_media_activity (volume, count, file_types, time_of_day)
          RUN clustering_algorithm (e.g., DBSCAN) on all users' feature sets
          RETURN users identified as outliers (noise points) or who moved to a higher-risk cluster