name: T1221: Template Injection
id: f8e9a2b1-c3d4-4e5f-8a9b-0c1d2e3f4a5b
description: This playbook helps investigate if an adversary is leveraging remote document templates to execute malicious code for defense evasion (T1221). This involves detecting Office applications making network connections to download templates from suspicious locations, spawning unusual child processes for payload execution (like powershell.exe or cmd.exe), or using specially crafted RTF files with remote template control words. The investigation also covers anomalous SMB connections for credential theft and correlated sequences of network and process events that indicate a multi-stage attack.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage, Inc.
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
investigative_questions:
  - question: Are Office applications making network connections to download templates from destinations listed in threat intelligence feeds, or are the downloaded templates known malware?
    context: Adversaries often host malicious templates on infrastructure that is quickly identified and added to threat intelligence feeds. This question directly checks for connections to known-bad domains, IPs, or URLs, or for the download of files with known malicious hashes, providing a high-confidence indicator of compromise.
    answer_sources:
      - Sysmon Event ID 3
      - Sysmon Event ID 22
      - Zeek http.log
      - Zeek dns.log
      - Zeek conn.log
      - Zeek files.log
      - Perimeter firewall logs
      - Web proxy logs
      - DNS server logs
      - User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH (network_events OR dns_events) WHERE process_name IN [Office_apps] AND (destination_ip IN threat_intel_ips OR destination_domain IN threat_intel_domains) UNION SEARCH file_events WHERE source_process IN [Office_apps] AND file_hash IN known_malware_hashes
  - question: Have Office applications initiated network connections to statistically rare or newly observed domains within the organization?
    context: Attackers frequently use newly registered or obscure domains to host malicious payloads. Legitimate Office application traffic typically goes to well-known, high-traffic domains. A connection to a domain that is rarely or never visited by anyone in the organization is highly suspicious and warrants investigation for template injection.
    answer_sources:
      - Sysmon Event ID 3
      - Sysmon Event ID 22
      - Zeek http.log
      - Zeek dns.log
      - Zeek conn.log
      - Zeek files.log
      - Perimeter firewall logs
      - Web proxy logs
      - DNS server logs
      - User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ANALYZE network_events AND dns_events FROM last 90 days GROUP BY domain | CALCULATE frequency | SEARCH network_events WHERE process_name IN [Office_apps] AND destination_domain IN (domains with frequency < 5th_percentile)
  - question: Are Office applications requesting URLs with lexical features (e.g., high entropy, unusual length) that are characteristic of malicious command-and-control (C2) or payload delivery sites?
    context: Malicious URLs, especially those generated by domain generation algorithms (DGAs), often have distinct lexical patterns compared to benign URLs. This question uses a machine learning model to analyze the structure of URLs requested by Office applications, allowing for the detection of suspicious links even if they are not yet present in threat intelligence feeds.
    answer_sources:
      - Sysmon Event ID 3
      - Sysmon Event ID 22
      - Zeek http.log
      - Zeek dns.log
      - Zeek conn.log
      - Zeek files.log
      - Perimeter firewall logs
      - Web proxy logs
      - DNS server logs
      - User workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each url in network_events WHERE process_name IN [Office_apps] | SCORE url with classification_model | ALERT if score IS malicious with high_confidence
  - question: Have any Office applications spawned child processes with command-line arguments containing patterns known to download or execute remote code?
    context: A common follow-on action for template injection is to execute a command that downloads and runs a second-stage payload. This question looks for tell-tale strings and patterns (e.g., 'IEX(New-Object Net.WebClient).DownloadString', 'mshta.exe http') in the command lines of child processes, which are strong indicators of malicious execution.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Terminal servers
      - Virtual Desktop Infrastructure (VDI) hosts
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_events WHERE parent_process IN [Office_apps] AND command_line MATCHES regex_list_of_payload_cradles
  - question: Are there child processes spawned by Office applications with unusually high-entropy command lines, suggesting obfuscation?
    context: To evade simple signature-based detections, adversaries often obfuscate or encode commands passed on the command line. This results in a command string with high character randomness, or entropy. This question aims to detect this obfuscation by flagging command lines that are statistically more random than normal, benign commands.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Terminal servers
      - Virtual Desktop Infrastructure (VDI) hosts
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each event in process_creation_events WHERE parent_process IN [Office_apps] | CALCULATE shannon_entropy(command_line) | ALERT if entropy > baseline_98th_percentile
  - question: Are Office applications spawning child processes with command-line arguments that a machine learning model classifies as malicious?
    context: This question leverages a machine learning model trained on a large corpus of known good and bad command lines. This approach can identify novel or complex malicious commands that may not match simple regex patterns or have unusually high entropy, providing a more sophisticated layer of detection.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Terminal servers
      - Virtual Desktop Infrastructure (VDI) hosts
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each event in process_creation_events WHERE parent_process IN [Office_apps] | SCORE command_line with classification_model | ALERT if classification IS malicious
  - question: Are there any RTF files on the network or endpoints that contain a '*\template' control word pointing to a remote HTTP/S or UNC path?
    context: The RTF file format allows embedding a link to a remote template using the '*\template' control word. Adversaries abuse this feature to force an Office application to fetch a malicious template from a remote server. This question directly searches for this specific, high-fidelity indicator within RTF file content.
    answer_sources:
      - Zeek files.log
      - Sysmon Event ID 11
      - Network egress points
      - Email gateway file attachments
      - User workstations' file systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH (file_creation_events OR network_file_transfers) WHERE file_type IS rtf | SCAN file_content FOR regex '(\*\\template http|\*\\template \\\\)' | ALERT on match
  - question: Has there been a statistically significant increase in the number of RTF files containing the '*\template' control word across the environment?
    context: While some legitimate RTF documents may use remote templates, a sudden, widespread increase in their appearance is abnormal and could indicate a phishing campaign or other large-scale attack. This question establishes a baseline of normal activity and alerts on deviations, helping to spot campaigns in their early stages.
    answer_sources:
      - Zeek files.log
      - Sysmon Event ID 11
      - Network egress points
      - Email gateway file attachments
      - User workstations' file systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR count of (RTF files with '*\template' control word) over time | CALCULATE 30-day moving_average and standard_deviation | ALERT if current_count > (moving_average + 3 * std_dev)
  - question: Are new RTF files being introduced into the environment that a machine learning model classifies as malicious based on their structural features?
    context: This question applies a machine learning model to analyze various features of RTF files (e.g., file size, object counts, presence of specific control words) to predict maliciousness. This provides a more holistic assessment than looking for a single indicator and can detect malicious RTFs that use novel or varied techniques.
    answer_sources:
      - Zeek files.log
      - Sysmon Event ID 11
      - Network egress points
      - Email gateway file attachments
      - User workstations' file systems
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new_rtf_file | EXTRACT features (file_size, object_count, etc.) | SCORE features with classification_model | ALERT if classification IS malicious
  - question: Have Office applications spawned any child processes that are not on an established allow-list of normal and expected behavior?
    context: Office applications typically spawn a predictable set of child processes for legitimate functions. Any deviation from this, such as spawning a command shell (cmd.exe), scripting interpreter (powershell.exe), or other LOLBin, is highly indicative of malicious activity. An allow-list provides a strict, high-fidelity method for detecting such anomalies.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Application servers
      - Terminal servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH process_creation_events WHERE parent_process IN [Office_apps] AND child_process NOT IN [allow_list_for_parent] | ALERT on match
  - question: Have any Office applications created a parent-child process relationship that is statistically rare for a specific host or for the entire organization?
    context: This question uses a data-driven approach to define 'normal' behavior instead of a static allow-list. It learns the common parent-child process relationships within your environment and alerts on new or infrequent combinations. This can help detect novel attack techniques or targeted attacks that use legitimate but rare processes.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Application servers
      - Terminal servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ANALYZE process_creation_events from last 30 days GROUP BY parent_process, child_process | CALCULATE probability | SEARCH new_process_creation_events WHERE parent_process IN [Office_apps] AND probability < 0.01
  - question: Have any process creation events originating from an Office application been identified as anomalous outliers by a machine learning model?
    context: This question employs an unsupervised machine learning model to create a comprehensive baseline of normal process activity based on multiple features (parent, child, user, etc.). The model can then identify any new process creation event that deviates significantly from this learned norm, providing a powerful way to detect unknown or unusual attack patterns without prior labeling.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Application servers
      - Terminal servers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each event in process_creation_events WHERE parent_process IN [Office_apps] | SCORE event with anomaly_detection_model | ALERT if score IS outlier
  - question: Have any Office applications initiated an SMB connection (TCP/445) to an external, non-private IP address?
    context: Legitimate SMB traffic is almost exclusively confined to the internal network. An Office application making an outbound SMB connection to the public internet is a major red flag. Adversaries use this technique to trick the client into sending NTLM authentication hashes to a server they control, which they can then crack or relay.
    answer_sources:
      - Zeek conn.log
      - Windows Security Event ID 5156
      - Sysmon Event ID 3
      - Perimeter firewall logs
      - User workstations
      - Internal network segments
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH network_connection_events WHERE process_name IN [Office_apps] AND destination_port IS 445 AND destination_ip IS_not_private | ALERT on match
  - question: Have any Office applications initiated an SMB connection to an internal server that the user does not typically access?
    context: Even within the internal network, a user's SMB activity is often predictable. An adversary who has compromised a user's machine might use a template injection to pivot and access other internal servers. This question establishes a baseline of normal user-to-server SMB access and flags connections to new or unusual destinations, which could indicate lateral movement.
    answer_sources:
      - Zeek conn.log
      - Windows Security Event ID 5156
      - Sysmon Event ID 3
      - Perimeter firewall logs
      - User workstations
      - Internal network segments
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ANALYZE smb_connections from last 30 days to create user_server_baseline | SEARCH new_smb_connections WHERE process_name IN [Office_apps] AND destination_server NOT IN user_server_baseline for that user | ALERT on match
  - question: Has there been an anomalous spike in the overall volume of outbound SMB connections originating from Office applications?
    context: A widespread phishing campaign leveraging template injection for credential theft could cause a sudden, noticeable increase in the total number of outbound SMB attempts across the organization. This question uses a time-series model to learn the normal rhythm of this traffic and alert on significant volume spikes that could indicate a large-scale attack.
    answer_sources:
      - Zeek conn.log
      - Windows Security Event ID 5156
      - Sysmon Event ID 3
      - Perimeter firewall logs
      - User workstations
      - Internal network segments
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR count of (outbound SMB connections from Office_apps) per hour | FORECAST expected volume with time_series_model | ALERT if actual_volume significantly exceeds forecast
  - question: Have we observed a sequence where an Office application connects to a known-bad domain and then immediately spawns a command shell or scripting interpreter?
    context: This question connects two high-confidence indicators into a single, extremely high-fidelity alert. The sequence of 'network connection to malicious site' followed by 'local code execution' from the same process is the classic signature of a successful remote template injection attack. Correlating these events provides definitive evidence of a compromise.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Sysmon Event ID 22
      - Zeek conn.log
      - Zeek dns.log
      - SIEM correlation engine
      - User workstations
      - DNS server logs
      - Web proxy logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CORRELATE network_events and process_creation_events by host and process_id | TRIGGER alert WHEN (network_event.destination IN CTI_blocklist) is followed within 60s by (process_creation_event.child_process IN [powershell.exe, cmd.exe])
  - question: Have any hosts accumulated a high risk score based on a rapid sequence of suspicious activities related to Office applications?
    context: Not all indicators are equal. This question uses a risk-scoring model where different suspicious behaviors (e.g., connection to a rare domain, spawning cmd.exe) are assigned points. By summing the scores of events occurring in a short time window on a single host, we can bubble up hosts that are exhibiting multiple suspicious behaviors, even if no single event is enough to trigger a high-severity alert on its own.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Sysmon Event ID 22
      - Zeek conn.log
      - Zeek dns.log
      - SIEM correlation engine
      - User workstations
      - DNS server logs
      - Web proxy logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host, aggregate risk_scores of events (e.g., spawn_cmd=+15, rare_domain_conn=+25) within a 5-minute window | ALERT if total_risk_score > 35
  - question: Have we observed a sequence of endpoint events (process, network, file) involving an Office application that is anomalous compared to learned normal sequences?
    context: This question uses a sophisticated machine learning model (like an LSTM autoencoder) to learn the 'grammar' of normal event sequences on an endpoint. When a new sequence of events occurs that doesn't fit the learned patterns—for example, Word making a strange network call, then writing a file, then spawning PowerShell—the model flags it as anomalous. This can detect novel attack chains that don't match any predefined rules or signatures.
    answer_sources:
      - Windows Security Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Sysmon Event ID 22
      - Zeek conn.log
      - Zeek dns.log
      - SIEM correlation engine
      - User workstations
      - DNS server logs
      - Web proxy logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host, create sequences of endpoint events | FEED sequences into LSTM_autoencoder_model | ALERT if reconstruction_error for a sequence involving an Office_app > threshold