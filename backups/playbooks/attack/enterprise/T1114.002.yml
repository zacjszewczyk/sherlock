name: 'T1114.002: Remote Email Collection'
id: 'd3a2b1f0-7c8e-4a5d-8f6b-9c1d0e9f8a7b'
description: 'This playbook helps determine if an adversary is collecting sensitive information from email services. It provides investigative questions to detect various indicators of this activity, such as authentications from known malicious IP addresses, the use of specific email collection tools (e.g., MailSniper, Ruler), anomalous login behaviors like impossible travel, unusually high volumes of data egress from mail services, and non-interactive, programmatic access patterns that suggest automated collection.'
type: 'technique'
related:
  - 'TA0009: Collection'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: '1.0'
tags: 'none'
questions:
  - question: 'Has an authentication attempt to a mail service originated from an IP address on a Cyber Threat Intelligence (CTI) feed?'
    context: 'This question seeks to identify login attempts from known malicious infrastructure, such as command and control servers, anonymizing proxies, or TOR exit nodes. Cross-referencing the source IP of an authentication event with a CTI feed provides a high-fidelity signal of a potential compromise or targeted attack.'
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Azure AD SignInLogs'
      - 'O365 Unified Audit Log'
      - 'Authentication servers (e.g., Active Directory Domain Controllers)'
      - 'Cloud Identity Providers (e.g., Azure AD)'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Network Egress Points'
      - 'VPN Concentrators'
    range: 'last 90 days'
    queries:
      - 'SEARCH authentication_logs | JOIN source_ip FROM cti_feed | RETURN user, source_ip, timestamp, cti_match_details'
  - question: 'For an authentication attempt from a CTI-listed IP, is the source ASN and country pair anomalous for the specific user?'
    context: 'This question adds a layer of statistical validation to an alert from a CTI-matched IP. By confirming that the origin Autonomous System Number (ASN) and country are also historically unusual for that specific user, it strengthens the suspicion that the login is illegitimate and helps prioritize the most critical alerts.'
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Azure AD SignInLogs'
      - 'O365 Unified Audit Log'
      - 'Authentication servers (e.g., Active Directory Domain Controllers)'
      - 'Cloud Identity Providers (e.g., Azure AD)'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Network Egress Points'
      - 'VPN Concentrators'
    range: 'last 90 days'
    queries:
      - 'SEARCH authentication_logs WHERE source_ip IN cti_feed | ENRICH source_ip with geo, asn | CALCULATE historical_frequency(user, asn, country) | FILTER frequency < 5th_percentile | RETURN user, source_ip, asn, country, frequency'
  - question: 'Can we use a machine learning model to predict if a new login attempt is malicious, even if its source IP is not on a CTI feed?'
    context: 'This question aims to proactively identify malicious logins before an IP is officially blacklisted. By training a model on features of known-bad logins (e.g., source geolocation, ASN, time of day, user agent), we can identify new logins that share those characteristics, providing an early warning capability against emerging threats.'
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Azure AD SignInLogs'
      - 'O365 Unified Audit Log'
      - 'Authentication servers (e.g., Active Directory Domain Controllers)'
      - 'Cloud Identity Providers (e.g., Azure AD)'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Network Egress Points'
      - 'VPN Concentrators'
    range: 'last 90 days'
    queries:
      - 'PREDICT is_malicious FROM new_login_event USING trained_model(features: [geo, asn, time_of_day, user_agent, mfa_status]) | RETURN user, source_ip, prediction_score'
  - question: 'Is network traffic or an audit log entry showing User-Agent strings or API call sequences associated with known email collection tools?'
    context: 'This question focuses on detecting the specific tools an adversary might use for email collection, such as MailSniper or Ruler. Searching for the unique signatures these tools leave in User-Agent strings or API call logs is a direct method of identifying their use within the environment.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek conn.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Web Application Firewalls (WAFs)'
      - 'Network Egress Points'
      - 'Cloud Application Security Broker (CASB)'
      - 'Cloud Mail Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'SEARCH http_logs, o365_audit_logs | APPLY regex for known tool signatures on user_agent field | ALERT on match'
  - question: 'Has a user''s session shown a sudden drop in User-Agent string entropy or used a very rare User-Agent string?'
    context: 'This question seeks to identify automated tool usage by analyzing User-Agent strings statistically. A human user typically uses one or two browsers, resulting in stable User-Agent entropy. An adversary using a specific script or tool will introduce a new, single User-Agent, causing a sudden drop in entropy. Flagging extremely rare User-Agents also helps find non-standard tools.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek conn.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Web Application Firewalls (WAFs)'
      - 'Network Egress Points'
      - 'Cloud Application Security Broker (CASB)'
      - 'Cloud Mail Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'For each user, CALCULATE shannon_entropy of user_agent over 30d window | ALERT on sudden drop | Also, CALCULATE global_rarity of user_agent | ALERT if rarity < 0.1%'
  - question: 'Does a user''s sequence of actions within a mail session deviate from the normal, learned sequence of operations, suggesting automated tool usage?'
    context: 'This question applies sequence analysis to detect adversary automation. Normal human interaction with email follows predictable patterns (e.g., open mail, reply, send). Automated collection tools exhibit different, often more repetitive or unusual sequences of API calls. By modeling normal behavior, we can detect sessions that deviate significantly, indicating potential tool usage.'
    answer_sources:
      - 'Zeek http.log'
      - 'Zeek conn.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Web Application Firewalls (WAFs)'
      - 'Network Egress Points'
      - 'Cloud Application Security Broker (CASB)'
      - 'Cloud Mail Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'For each user session, EXTRACT sequence of O365 operations | COMPARE sequence against trained model of benign sequences | ALERT on anomalous sequences'
  - question: 'Has a user logged in from two locations in a time-frame that would require physically impossible travel?'
    context: 'This question is designed to detect "impossible travel" scenarios, a strong indicator of account compromise. If two successful logins for the same user occur from geographically distant locations within a short period, it is impossible for the legitimate user to have made both. This check requires geocoding source IPs and comparing sequential login timestamps and locations.'
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Azure AD SignInLogs'
      - 'Authentication servers (e.g., Active Directory Domain Controllers)'
      - 'Cloud Identity Provider (e.g., Azure AD)'
      - 'VPN Concentrators'
      - 'Network Egress Points'
    range: 'last 90 days'
    queries:
      - 'For each user, GET last_login_location, last_login_time | COMPARE with current_login_location, current_login_time | CALCULATE travel_speed | ALERT if speed > impossible_threshold'
  - question: 'Does a successful user login deviate significantly from their established baseline of source country, ASN, and time of day?'
    context: 'This question aims to detect anomalous logins by building a historical profile of normal behavior for each user. By establishing a baseline of common source locations and login times, any new login that deviates significantly from this pattern (e.g., from a new country and at an unusual hour) can be flagged for investigation, even if it does not meet the "impossible travel" criteria.'
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Azure AD SignInLogs'
      - 'Authentication servers (e.g., Active Directory Domain Controllers)'
      - 'Cloud Identity Provider (e.g., Azure AD)'
      - 'VPN Concentrators'
      - 'Network Egress Points'
    range: 'last 90 days'
    queries:
      - 'For each user, BUILD profile of common countries, ASNs, login_hours | SCORE new login based on deviation from profile | ALERT if score > threshold'
  - question: 'Does a user''s login event fall outside their normal clusters of login behavior based on location and time?'
    context: 'This question uses unsupervised machine learning to define "normal" for a user. By applying a clustering algorithm like DBSCAN to a user''s historical logins (based on geolocation and time), we can automatically group their typical activity. Any new login that does not fall into an existing cluster is considered an outlier or anomaly, warranting further scrutiny.'
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Azure AD SignInLogs'
      - 'Authentication servers (e.g., Active Directory Domain Controllers)'
      - 'Cloud Identity Provider (e.g., Azure AD)'
      - 'VPN Concentrators'
      - 'Network Egress Points'
    range: 'last 90 days'
    queries:
      - 'For each user, APPLY DBSCAN to historical login data (features: lat/lon, time_of_day) | For new login, CHECK if it is assigned to a cluster | ALERT if login is flagged as noise/outlier'
  - question: 'Has a user''s mail session exceeded a static threshold for data download volume or number of items accessed?'
    context: 'This question provides a simple, rule-based approach to detecting bulk data exfiltration from email. By setting a generous but firm static threshold for data volume (e.g., 1 GB) or number of items accessed (e.g., 500 in 10 minutes), any session that breaches this limit is immediately flagged as a potential incident of mass data collection.'
    answer_sources:
      - 'Zeek conn.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Network Egress Points'
      - 'Cloud Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'SEARCH mail_sessions | ALERT if resp_bytes > 1GB OR count(MailItemsAccessed) > 500 in 10min'
  - question: 'Has a user''s mail session exceeded their own dynamically calculated 95th percentile baseline for data download volume or items accessed?'
    context: 'This question refines the volumetric detection by creating a dynamic, per-user baseline. Instead of a single static threshold for everyone, it calculates what is normal for each individual user (e.g., the 95th percentile of their session data volume over the last 30 days). An alert is triggered only when a user significantly exceeds their own typical behavior, reducing false positives for users who legitimately handle large amounts of email.'
    answer_sources:
      - 'Zeek conn.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Network Egress Points'
      - 'Cloud Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'For each user, CALCULATE 95th_percentile of session_volume over 30d | For new session, ALERT if session_volume > 95th_percentile_threshold'
  - question: 'Did the user''s daily data download volume from mail services significantly exceed the forecasted volume predicted by a time-series model?'
    context: 'This question uses predictive modeling to identify volumetric anomalies. By treating a user''s daily download volume as a time series, a forecasting model (like SARIMA or Prophet) can predict the expected volume for the next day, complete with a prediction interval. If the actual observed volume exceeds the upper bound of this interval, it indicates a statistically significant anomaly that is unlikely to be normal variation.'
    answer_sources:
      - 'Zeek conn.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Network Egress Points'
      - 'Cloud Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'For each user, TRAIN time-series model on daily_download_volume | FORECAST next_day_volume with 95% prediction interval | ALERT if actual_volume > upper_bound_of_interval'
  - question: 'Did a user session exhibit a very high request rate or use of sensitive administrative cmdlets like `Search-Mailbox` or `New-MailboxExportRequest`?'
    context: 'This question looks for clear signs of automated or administrative-level email collection. A very high request rate (e.g., >200 requests in 10 minutes) is indicative of a script, not a human. Furthermore, the use of powerful cmdlets like Search-Mailbox or New-MailboxExportRequest by non-administrators is highly suspicious and a direct indicator of targeted collection.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Web Application Firewalls (WAFs)'
      - 'Cloud Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'SEARCH o365_audit_logs | ALERT if operation is "Search-Mailbox" or "New-MailboxExportRequest" AND user is not administrator'
  - question: 'Does a user''s mail session show an abnormally low variance in the time between requests, suggesting non-human, scripted interaction?'
    context: 'This question attempts to identify automation by analyzing the rhythm of a session. Human interactions are variable, with pauses for reading and thinking, leading to a high variance in inter-request timing. A script or bot, however, often executes commands with consistent, machine-timed precision, resulting in an unnaturally low variance. Detecting this low variance can unmask automated activity.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Web Application Firewalls (WAFs)'
      - 'Cloud Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'For each session, CALCULATE time_deltas between requests | CALCULATE stddev of time_deltas | ALERT if stddev is in lowest 1st percentile of all sessions'
  - question: 'Is a user''s mail session classified as ''bot'' activity by a machine learning model based on its session-level features?'
    context: 'This question leverages a supervised machine learning model to make a holistic judgment on whether a session is human- or bot-driven. By engineering a rich set of session-level features (total requests, duration, timing variance, URL entropy, etc.), a model can be trained to distinguish between the two classes. This provides a powerful, comprehensive method for detecting automated collection activity.'
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek http.log'
      - 'O365 Unified Audit Log'
      - 'Mail Servers (e.g., on-prem Exchange)'
      - 'Web Application Firewalls (WAFs)'
      - 'Cloud Tenant (e.g., O365, Google Workspace)'
    range: 'last 90 days'
    queries:
      - 'For each session, ENGINEER features (request_count, duration, timing_stddev, etc.) | PREDICT class (human/bot) using trained model | ALERT if class is "bot" with high confidence'