name: T1566.002: Spearphishing Link
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps determine if an adversary has gained initial access to the network by tricking a user into clicking a malicious link in a spearphishing email. It provides investigative questions to detect this activity by analyzing various data sources for indicators such as outbound connections to known malicious destinations, submission of credentials to suspicious forms, downloads of high-risk files, anomalous process creation by browsers, correlations between email and web traffic, and DNS queries for algorithmically generated or look-alike domains.
type: technique
related:
  - TA0001: Initial Access
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are internal hosts making outbound network connections to destinations matching high-confidence threat intelligence feeds?
    context: This question aims to detect direct evidence of a spearphishing link click, where a user's machine connects to a known malicious IP or domain. A match against a high-confidence threat intelligence feed provides a strong signal of a successful phishing attempt and requires immediate investigation to contain the potential breach.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek ssl.log
      - Network egress points (e.g., firewalls, proxies)
      - DNS resolvers
      - Cloud Access Security Brokers (CASB)
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH outbound network logs (proxy, DNS, firewall)
          WHERE destination_ip OR destination_domain IN high_confidence_threat_feed
          ALERT on any match
  - question: For any connection to a known malicious indicator, is the connection rare or targeted, as indicated by a low number of other internal hosts also connecting to it?
    context: This question helps differentiate between widespread, opportunistic attacks and highly targeted spearphishing. If very few hosts in the organization have ever connected to a malicious domain, it suggests the link was sent to a specific, small group of individuals, increasing the likelihood of a sophisticated, targeted attack that warrants a higher-priority investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek ssl.log
      - Network egress points (e.g., firewalls, proxies)
      - DNS resolvers
      - Cloud Access Security Brokers (CASB)
    range: last 30 days
    queries:
      - pseudocode: |
          GIVEN a threat_intel_match
          COUNT distinct source_hosts connecting to malicious_destination over 30 days
          IF count < 5th_percentile_of_all_external_destinations
          INCREASE risk_score
  - question: Can machine learning models, using lexical and host-based features, confirm the maliciousness of a URL that also matches a threat intelligence feed?
    context: This question adds a layer of machine-learning validation to threat intelligence hits. By analyzing URL characteristics (length, randomness), domain properties (age, reputation), and historical context, a model can provide a secondary, independent confirmation that a URL is malicious, reducing false positives and increasing confidence in alerts.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Zeek ssl.log
      - Network egress points (e.g., firewalls, proxies)
      - DNS resolvers
      - Cloud Access Security Brokers (CASB)
    range: last 90 days
    queries:
      - pseudocode: |
          GIVEN a threat_intel_match for a URL
          SCORE URL with ML model (lexical, host-based, historical features)
          IF score > 0.9
          ESCALATE event
  - question: Are users submitting data via HTTP POST requests to external, non-whitelisted domains that contain common credential field names like 'username' or 'password'?
    context: This question seeks to identify classic credential harvesting pages where a user is tricked into entering sensitive information. Detecting field names associated with logins or personal data in unencrypted traffic to untrusted sites is a strong indicator of a phishing attack in progress.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxy servers
      - Network taps at internet gateways
      - User workstations and servers
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH unencrypted HTTP POST requests
          WHERE destination_domain is external AND not whitelisted
          AND POST_body OR URI contains regex ('user', 'pass', 'login', 'ssn')
          ALERT on match
  - question: For alerts involving potential credential harvesting, does the destination URI appear unusually random, and has it received POST requests from very few internal hosts?
    context: This question refines credential harvesting alerts by looking for signs of attacker infrastructure. High-entropy URIs are often used to create unique landing pages for each victim, while a low number of distinct hosts submitting data to a domain suggests it is not a legitimate, widely-used service. The combination is highly suspicious.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxy servers
      - Network taps at internet gateways
      - User workstations and servers
    range: last 30 days
    queries:
      - pseudocode: |
          GIVEN a credential_harvesting_alert
          CALCULATE shannon_entropy of full URI
          COUNT distinct source_hosts POSTing to destination_domain in last 30 days
          IF uri_entropy > 95th_percentile AND host_count < 3
          INCREASE risk_score
  - question: Has any user exhibited an anomalous spike in the volume of HTTP POST requests to external domains compared to their established baseline behavior?
    context: This question aims to detect unusual user behavior that might indicate interaction with a phishing site. A sudden, unexpected increase in the number of POST requests from a user could signify that they are interacting with a malicious site that is exfiltrating data in the background.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Zeek ssl.log
      - Web proxy servers
      - Network taps at internet gateways
      - User workstations and servers
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each user
          MODEL baseline of external HTTP POST volume over time
          FLAG any observation where POST_volume exceeds model's upper confidence interval
  - question: Are users downloading high-risk file types (like HTA, ISO, LNK, VBS) from newly registered external domains?
    context: This question targets a common payload delivery method where users are tricked into downloading malicious files. High-risk file types are often used to execute code, and when they are sourced from newly created domains (a common tactic for attackers), the likelihood of malicious intent is very high.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network egress points
      - Host endpoints
      - DNS resolvers
      - Email gateway sandboxes
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH file download logs (Zeek files.log)
          WHERE (mime_type OR file_extension IN high_risk_list)
          AND source_domain_age < 90 days
          ALERT on match
  - question: Are there any file downloads that are statistically rare for the organization, based on the combination of file type, source network (ASN), and file extension?
    context: This question uses environmental context to find outliers. A file download might not seem suspicious on its own, but if the combination of its characteristics has almost never been seen before in the organization, it warrants investigation. This helps uncover novel attack vectors that might not match predefined rules.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network egress points
      - Host endpoints
      - DNS resolvers
      - Email gateway sandboxes
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each file_download
          CALCULATE rarity_score based on historical frequency of (MIME_type, source_ASN, file_extension) tuple
          IF rarity_score > 99th_percentile
          FLAG for review
  - question: Can a machine learning model, analyzing features like domain reputation, file type, and filename entropy, identify downloaded files with a high probability of being malicious?
    context: This question leverages a predictive model to proactively score the risk of every downloaded file. By combining multiple weak signals into a single, strong probabilistic score, this approach can detect sophisticated threats that might evade simpler rule-based detections. An alert from this model indicates a high-confidence threat.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Zeek dns.log
      - Windows Event ID 4688
      - Network egress points
      - Host endpoints
      - DNS resolvers
      - Email gateway sandboxes
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each file_download
          SCORE file with ML model (domain_rep, domain_age, ASN, MIME, extension, filename_entropy)
          IF malicious_probability > 0.85
          ALERT event
  - question: Is a web browser process (like chrome.exe or msedge.exe) spawning suspicious child processes such as cmd.exe, powershell.exe, or wscript.exe?
    context: This question looks for direct evidence of code execution stemming from a web browser, a common pattern after a user clicks a malicious link. The execution of command-line interpreters or scripting engines by a browser is highly anomalous and a strong indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Zeek http.log
      - Zeek conn.log
      - User workstations
      - VDI instances
      - Application servers
      - Network web proxies
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH process creation logs (Event ID 4688)
          WHERE parent_process_name IN (chrome.exe, msedge.exe, firefox.exe)
          AND child_process_name IN (cmd.exe, powershell.exe, wscript.exe, mshta.exe)
          ALERT on match
  - question: For suspicious browser-child process events, is the specific parent-child relationship rare across the enterprise, or does the child process have an unusually complex/random command line?
    context: This question adds statistical context to process creation events. A process relationship seen on only one or two machines is more suspicious than one seen on thousands. Similarly, highly entropic command lines often indicate obfuscated or encoded commands used by malware.
    answer_sources:
      - Windows Event ID 4688
      - Zeek http.log
      - Zeek conn.log
      - User workstations
      - VDI instances
      - Application servers
      - Network web proxies
    range: last 90 days
    queries:
      - pseudocode: |
          GIVEN a browser_spawns_child_alert
          CALCULATE prevalence of parent-child_pair across all endpoints
          CALCULATE shannon_entropy of child_process_command_line
          IF prevalence < 1% OR command_line_entropy > 98th_percentile
          INCREASE risk_score
  - question: Are there any anomalous sequences of process executions originating from a web browser, as identified by a machine learning model trained on normal activity?
    context: This question seeks to identify novel or complex execution chains that deviate from established benign patterns. Attackers often use a series of processes to achieve their goals (e.g., browser -> cmd -> powershell). An anomaly detection model can flag these unusual sequences even if the individual processes are legitimate.
    answer_sources:
      - Windows Event ID 4688
      - Zeek http.log
      - Zeek conn.log
      - User workstations
      - VDI instances
      - Application servers
      - Network web proxies
    range: last 90 days
    queries:
      - pseudocode: |
          MODEL benign process execution chains (e.g., n-grams, LSTM)
          FOR each new chain originating from a browser
          IF model flags chain as low-probability (anomalous)
          ALERT for review
  - question: Can we correlate an inbound email containing a URL with a subsequent web connection by the recipient to that URL's domain, where the domain has a poor reputation?
    context: This question directly links a potential phishing email to the user's action of clicking the link. By correlating email logs with network traffic within a short time window, we can confirm the initial access vector and immediately focus the investigation on the specific email and the clicked destination.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Zeek http.log
      - Email Gateway Logs
      - Email gateway
      - DNS resolvers
      - Network egress points
      - User workstations
    range: 15-minute time window
    queries:
      - pseudocode: |
          PARSE URLs from inbound email logs
          CORRELATE email_recipient with source_user in web_traffic_logs
          WHERE time_difference < 15 minutes AND domains match
          AND destination_domain_reputation is poor
          ALERT on correlation
  - question: Are there any URLs sent via email that have an extremely low click-through rate (e.g., only one user clicked), suggesting a highly targeted phishing attempt?
    context: This question helps to identify spearphishing attacks by focusing on rarity. A link sent to thousands but clicked by no one is likely spam. A link sent to a few and clicked by only one person is a potential targeted attack. Investigating these 'single-click' events can uncover sophisticated, low-volume campaigns.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Zeek http.log
      - Email Gateway Logs
      - Email gateway
      - DNS resolvers
      - Network egress points
      - User workstations
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each URL in email logs
          CALCULATE click_through_rate (CTR) = (unique_clickers / unique_recipients)
          IF CTR < 1st_percentile (e.g., only 1 click)
          FLAG for investigation
  - question: Has a user clicked an email link in a manner that is anomalous compared to their own historical link-clicking behavior profile?
    context: This question focuses on user-specific behavioral anomalies. A user who normally only clicks links during business hours on weekdays suddenly clicking a link at 3 AM on a Sunday is an anomaly. This can indicate a compromised account or a user being successfully tricked outside of their normal state of mind.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Zeek http.log
      - Email Gateway Logs
      - Email gateway
      - DNS resolvers
      - Network egress points
      - User workstations
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each user
          CLUSTER historical link clicks based on features (time_of_day, day_of_week, time_to_click)
          FOR each new click
          IF click is flagged as a noise point (outlier) by clustering model
          FLAG as anomalous
  - question: Are internal hosts making DNS queries for domains that appear to be homoglyphs or typosquats of our company's domains or other high-value brands?
    context: This question aims to detect attempts to deceive users by using domains that visually resemble legitimate ones. Attackers register domains like 'micros0ft.com' or 'goggle.com' to trick users. Detecting these look-alike domains in DNS traffic is a proactive way to find phishing infrastructure.
    answer_sources:
      - Zeek dns.log
      - Internal and external DNS resolvers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each new domain in DNS logs
          CHECK if domain is a homoglyph OR typosquat of a high-value_domain_list
          ALERT on match
  - question: Are we observing DNS queries for domains that are both lexically random (high entropy) and queried by very few internal hosts?
    context: This question seeks to identify domains generated by algorithms (DGAs), a common technique for malware command and control. These domains look like random gibberish. When such a domain is also queried by only one or two hosts in the network, it is highly indicative of a malware infection beaconing out.
    answer_sources:
      - Zeek dns.log
      - Internal and external DNS resolvers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each new domain in DNS logs
          CALCULATE shannon_entropy and n_gram_frequency
          COUNT unique hosts querying the domain
          IF entropy > 95th_percentile AND host_count < 3
          ALERT for review
  - question: Can a machine learning model, using lexical features, identify newly observed domains that have a high probability of being malicious?
    context: This question uses a predictive model to score the likelihood that a domain is malicious based purely on its name. This can proactively identify DGA, typosquatting, and other suspicious domain structures before they are even added to threat intelligence feeds, providing an early warning system for new threats.
    answer_sources:
      - Zeek dns.log
      - Internal and external DNS resolvers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: |
          FOR each new domain in DNS logs
          SCORE domain with lexical ML model (length, entropy, n-grams, TLD)
          IF malicious_probability > 0.9
          ALERT for triage