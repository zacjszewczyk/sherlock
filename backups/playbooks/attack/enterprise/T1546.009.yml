name: T1546.009: AppCert DLLs
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook focuses on detecting adversaries using AppCert DLLs for persistence and privilege escalation. Adversaries achieve this by modifying the 'HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\AppCertDLLs' registry key, which causes a specified malicious DLL to be loaded into every user process. The investigation looks for direct modifications to this key, particularly when the new DLL is known-malicious, has an obfuscated path, or is written by an unusual process. It also correlates these registry changes with subsequent suspicious activities such as the creation of DLLs in world-writable directories, anomalous outbound network connections, spawning of command-line interpreters from system processes, and privilege escalation events like adding users to privileged groups.
type: technique
related:
- TA0003: Persistence
- TA0004: Privilege Escalation
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Has the AppCertDLLs registry key been modified to point to a DLL with a known malicious name or hash?
  context: This question aims to detect the most direct evidence of AppCert DLL abuse. Adversaries modify the `HKLM\System\CurrentControlSet\Control\Session Manager\AppCertDLLs` registry key to load a malicious DLL into every process that uses the CreateProcess API. By comparing the newly added DLL's path, name, and hash against threat intelligence feeds, we can quickly identify if a known malicious tool or malware variant is being used for persistence.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 13
  - Relevant Assets: Domain Controllers, Tier 0 Servers, Executive Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH for registry modification events (Win Event ID 4657, Sysmon Event ID 13) for the AppCertDLLs key.
      FOR each event:
        EXTRACT the new DLL path.
        HASH the file at the path.
        CHECK the file name and hash against a threat intelligence database.
        ALERT on match.
- question: Has a new DLL added to the AppCertDLLs registry key been given a randomized or obfuscated file path to evade detection?
  context: Adversaries often use randomized file paths to avoid static, signature-based detections. A high string entropy in the DLL path can indicate this type of evasion. This question helps identify potentially malicious AppCert DLLs that are not yet known to threat intelligence by focusing on the characteristics of the path itself, rather than the file's hash.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 13
  - Relevant Assets: Domain Controllers, Tier 0 Servers, Executive Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR each AppCertDLLs registry modification event:
        CALCULATE Shannon entropy of the new DLL file path string.
        COMPARE the score against a pre-computed baseline of legitimate path entropies.
        ALERT if score exceeds the 95th percentile of the baseline.
- question: Does a machine learning model classify a recent AppCertDLLs modification as malicious based on process and path features?
  context: This question leverages a machine learning model to provide a more nuanced detection than simple rules. By analyzing features like the parent process of the writing process, path characteristics (length, entropy), and historical data, the model can identify subtle anomalies that may indicate a malicious modification, even in the absence of known indicators.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 13
  - Relevant Assets: Domain Controllers, Tier 0 Servers, Executive Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON AppCertDLLs modification event:
        EXTRACT features: parent process name, path length, path entropy, historical frequency of writing process.
        INPUT features into a pre-trained classification model (e.g., Random Forest).
        ALERT if the model's prediction is 'malicious' with high confidence.
- question: Has a DLL recently created in a world-writable directory been registered as an AppCert DLL?
  context: Adversaries may drop their malicious DLL into a world-writable directory (e.g., C:\Users\Public, %TEMP%) to ensure they have the necessary permissions to write the file, before modifying the registry to point to it. This question creates a correlation rule to detect this specific sequence of events, which is highly indicative of malicious activity.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 11
  - Relevant Assets: Standard User Workstations, Multi-user Servers (e.g., Citrix, RDS)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH for DLL file creation events (Sysmon EID 11, Win EID 4663) in world-writable directories.
      CORRELATE on hostname to find a subsequent AppCertDLLs registry modification (Win EID 4657) within 5 minutes.
      ENSURE the registry modification value contains the path of the newly created DLL.
      ALERT on successful correlation.
- question: Is a rare or unusual process responsible for writing a DLL to a public directory and then modifying the AppCertDLLs key?
  context: Legitimate software installers might perform this sequence of actions, but it is typically done by a predictable set of processes. This question focuses on identifying when a process that does not normally perform this action does so. By baselining normal behavior, we can alert on statistical outliers, indicating a process may have been compromised or is inherently malicious.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 11
  - Relevant Assets: Standard User Workstations, Multi-user Servers (e.g., Citrix, RDS)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      BASELINE the frequency of each process performing the sequence: (DLL write to public dir) -> (AppCertDLLs mod).
      ON a new occurrence of this sequence:
        RETRIEVE the parent process name (from Win EID 4688).
        CALCULATE the rarity of this process performing this action.
        ALERT if the frequency falls below the 5th percentile.
- question: Did an anomalous sequence of events occur, specifically a DLL write to a world-writable directory followed by an AppCertDLLs registry modification?
  context: This question uses a more advanced sequence analysis model to understand the common chains of events on an endpoint. Any deviation from the learned 'normal' sequences, such as the low-probability transition from a DLL write in a public folder to an AppCertDLLs modification, can be flagged as anomalous and potentially malicious.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Sysmon Event ID 11
  - Relevant Assets: Standard User Workstations, Multi-user Servers (e.g., Citrix, RDS)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      INPUT endpoint event stream into a trained sequence analysis model (e.g., Hidden Markov Model).
      DEFINE 'DLL write to world-writable dir' and 'AppCertDLLs mod' as states.
      ALERT if the model flags the transition between these states as having a very low probability.
- question: Following an AppCertDLLs modification, did a critical system process spawn a command-line interpreter or other unexpected child process?
  context: Once a malicious AppCert DLL is loaded into a process, it may be used to execute commands. It is highly suspicious for a critical system process like 'lsass.exe' or 'wininit.exe' to spawn any child process. Similarly, 'explorer.exe' or 'svchost.exe' spawning a command-line tool is also anomalous and suggests that a loaded DLL is executing malicious commands.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Zeek notice.log
  - Relevant Assets: All Endpoints and Servers, Internet Gateway, DNS Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON alert for AppCertDLLs modification (Event ID 4657):
        MONITOR subsequent process creation events (Event ID 4688) on the same host for 1 hour.
        ALERT if a system-critical process (lsass.exe, wininit.exe) spawns any child.
        ALERT if a common process (explorer.exe, svchost.exe) spawns cmd.exe, powershell.exe, or rundll32.exe and it's not on an allow list.
- question: After an AppCertDLLs modification, did the host initiate an outbound TLS connection using a rare or non-standard client fingerprint (JA3/JA3S)?
  context: Malware often uses custom TLS libraries that differ from standard operating system or browser libraries. This results in a unique JA3/JA3S fingerprint for the TLS handshake. This question seeks to identify these non-standard connections originating from a host shortly after a potential AppCertDLL compromise, which could indicate C2 communication.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Zeek notice.log
  - Relevant Assets: All Endpoints and Servers, Internet Gateway, DNS Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      BASELINE common JA3/JA3S hash pairs in the environment.
      ON host with recent AppCertDLLs modification:
        MONITOR outbound TLS connections (Zeek conn.log).
        FOR each connection, calculate JA3/JA3S hash pair.
        ALERT if the hash pair rarity is in the bottom 5th percentile.
- question: Did a host exhibit anomalous outbound network behavior (e.g., unusual byte count, connection patterns) after an AppCertDLLs registry modification?
  context: A compromised host may begin C2 communications, data exfiltration, or other malicious network activity. This question uses a time-series model to detect deviations from the host's normal network behavior. A significant anomaly flagged by the model after an AppCertDLLs modification strongly suggests the persistence mechanism was successful and is now being used.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Zeek notice.log
  - Relevant Assets: All Endpoints and Servers, Internet Gateway, DNS Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON AppCertDLLs modification event on a host:
        FEED subsequent network metrics (bytes out, connection count) from that host into a time-series anomaly detection model (e.g., LSTM).
        ALERT if the model flags a significant deviation from the forecasted behavior.
- question: Was a user added to a high-privilege group shortly after an AppCertDLLs registry modification on the same host?
  context: Adversaries may use the code execution provided by an AppCert DLL to escalate privileges, such as by adding a user account to the local Administrators or a domain-level administrative group. This question detects this specific chain of events, which is a strong indicator of a successful privilege escalation attack.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4720
  - Windows Event ID 4732
  - Windows Event ID 4728
  - Relevant Assets: Domain Controllers, Identity and Access Management Systems, Critical Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH for AppCertDLLs modification (Event ID 4657).
      CORRELATE on hostname to find a subsequent privileged group add event (Event IDs 4732, 4728) within 10 minutes.
      CHECK if the target group is 'Administrators', 'Domain Admins', etc.
      ALERT on successful correlation.
- question: Following an AppCertDLLs modification, was a privileged group change performed by a user or process that rarely or never performs such an action?
  context: Changes to privileged groups are typically performed by a small, authorized set of administrators or specific system processes. This question establishes a baseline of who performs these actions and alerts when a user or process that is not on that baseline makes a change, especially after a suspicious AppCertDLLs event.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4720
  - Windows Event ID 4732
  - Windows Event ID 4728
  - Relevant Assets: Domain Controllers, Identity and Access Management Systems, Critical Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      BASELINE which users/processes perform privileged group modifications.
      FOLLOWING an AppCertDLLs modification:
        IF a subsequent group change is made by a user/process with a frequency below the 1st percentile for this action, ALERT.
- question: Does a machine learning model classify the sequence of an AppCertDLLs modification followed by a privileged group change as a malicious event?
  context: This question uses a classification model to assess the likelihood that a privilege escalation event is malicious. By considering features like the process that modified the key, the user context, and the time delta to the group change, the model can make a more informed decision than a simple time-based correlation rule.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4720
  - Windows Event ID 4732
  - Windows Event ID 4728
  - Relevant Assets: Domain Controllers, Identity and Access Management Systems, Critical Servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON a privileged group change event:
        LOOK for a preceding AppCertDLLs modification.
        EXTRACT features: modifying process, user context, time delta between events, rarity of user making group change.
        INPUT features to a pre-trained classification model (e.g., Logistic Regression).
        ALERT if model predicts 'malicious' with > 0.9 confidence.
- question: Did a high-integrity system process spawn a command-line interpreter within minutes of an AppCertDLLs modification on the same host?
  context: The AppCert DLL, once loaded into a high-integrity process (e.g., services.exe), runs with SYSTEM privileges. An adversary can leverage this to spawn a command shell (cmd.exe, powershell.exe) with those same elevated privileges. This activity is highly anomalous and a strong indicator of successful privilege escalation.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Relevant Assets: Domain Controllers, All Windows Servers, Privileged Access Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON AppCertDLLs modification (Event ID 4657):
        MONITOR for process creation events (Event ID 4688) on the same host within 5 minutes.
        ALERT if ParentProcessName is a high-integrity process (services.exe, lsass.exe) and NewProcessName is cmd.exe or powershell.exe.
- question: Following an AppCertDLLs modification, was a rare parent-child process relationship observed, suggesting code injection and execution?
  context: Every process creation event establishes a parent-child relationship. Over time, a baseline of normal relationships can be built. A malicious AppCert DLL loaded into a legitimate process might cause that process to spawn a child it has never spawned before. This question seeks to detect these rare relationships as an indicator of compromise.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Relevant Assets: Domain Controllers, All Windows Servers, Privileged Access Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      MAINTAIN a probability table for all parent-child process relationships P(Child|Parent).
      AFTER an AppCertDLLs modification:
        FOR each new process creation event:
          CHECK the probability P(NewProcessName|ParentProcessName).
          IF P < 0.01, flag as a rare and suspicious process chain and ALERT.
- question: Did a graph-based analysis detect an anomalous process creation lineage, such as a new connection between previously unrelated process trees, after an AppCertDLLs modification?
  context: This question models process activity as a graph, where processes are nodes and parent-child relationships are edges. A malicious DLL can act as a bridge, causing a process in one lineage (e.g., a service) to spawn a process typically associated with another (e.g., a user tool). Detecting these new, connecting edges in the process graph can reveal this type of code injection.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Relevant Assets: Domain Controllers, All Windows Servers, Privileged Access Workstations
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      REPRESENT process lineage as a graph.
      AFTER an AppCertDLLs modification:
        ANALYZE the subgraph of newly created processes.
        FLAG any new edge that connects previously disconnected components of the process graph.
        ALERT on such anomalous connections.
- question: Was the AppCertDLLs registry key modified by a process whose parent is a common user application like a web browser or office software?
  context: A modification to the AppCertDLLs key, which requires administrative privileges, should not originate from a standard user application. If a process like WINWORD.EXE or CHROME.EXE is the parent of the process that modifies this key, it strongly suggests a successful exploit chain, where a vulnerability in the user application was used to gain code execution and escalate privileges.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Relevant Assets: All User Endpoints, Virtual Desktop Infrastructure (VDI)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH for AppCertDLLs modification events (Event ID 4657).
      FOR each event, get the ProcessName and find its parent process (via Event ID 4688).
      ALERT if the parent process is on a watchlist of common user applications (outlook.exe, winword.exe, chrome.exe, etc.).
- question: Was the AppCertDLLs registry key modified by a process running with an unusually low integrity level (e.g., Medium or Low)?
  context: Modifying the HKLM registry hive requires elevated privileges, meaning the writing process should be running at a High or SYSTEM integrity level. If a process at a Medium or Low integrity level performs this write, it indicates a privilege escalation vulnerability was exploited to bypass this security control. This is a significant deviation from normal behavior.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Relevant Assets: All User Endpoints, Virtual Desktop Infrastructure (VDI)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      BASELINE the integrity levels of processes that normally modify the AppCertDLLs key (typically High or SYSTEM).
      FOR each new AppCertDLLs modification event:
        EXTRACT the integrity level of the writing process from the event data.
        ALERT if the integrity level is Medium or Low.
- question: Does a decision tree classifier, trained on process lineage, identify an AppCertDLLs registry write as suspicious due to its origin from a user application process tree?
  context: This question uses a simple but effective machine learning model to formalize the logic of tracking process lineage. The decision tree can be trained to recognize that if a process's parent or grandparent is a browser or Office application, a subsequent write to a sensitive registry key like AppCertDLLs is highly suspicious and should be flagged.
  answer_sources:
  - Windows Event ID 4657
  - Windows Event ID 4688
  - Relevant Assets: All User Endpoints, Virtual Desktop Infrastructure (VDI)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ON AppCertDLLs modification event:
        EXTRACT features: process name, parent name, grandparent name, and their integrity levels.
        INPUT features into a pre-trained decision tree classifier.
        ALERT if the model classifies the event as 'suspicious'.