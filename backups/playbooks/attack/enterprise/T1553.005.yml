name: T1553.005: Mark-of-the-Web Bypass
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps determine if an adversary has bypassed Mark-of-the-Web (MOTW) protections to execute malicious code. It focuses on detecting the download of container files (like ISO, VHD, ZIP, RAR), the subsequent mounting or extraction of these files by suspicious parent processes, and the final execution of an unsigned or anomalous payload from the container. The investigation follows the chain of events from network download to host execution, using a combination of threat intelligence matching, statistical analysis, and machine learning models to identify suspicious activity.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a downloaded container file (ZIP, RAR, ISO, etc.) known to be malicious based on its hash or source?
    context: This question aims to identify threats by matching evidence from network logs against known indicators of compromise (IOCs). Checking if a downloaded container file's hash, or the IP address or domain it was downloaded from, appears in a threat intelligence feed is a high-fidelity method for detecting known malicious activity early in the attack chain.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - Internet gateway
      - Network egress points
      - DNS servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - SEARCH Zeek logs (files.log, http.log) FOR mime_type IN ['application/zip', 'application/x-rar-compressed', 'application/x-iso9660-image', 'application/octet-stream'] OR file_extension IN ['.iso', '.img', '.vhd', '.zip', '.rar']. JOIN results with threat_intelligence_feed ON file_hash, source_ip, or server_name.
  - question: Is a downloaded container file statistically anomalous based on its prevalence, source domain age, or reputation?
    context: This question seeks to uncover new or targeted threats that are not yet present in threat intelligence feeds. By analyzing the rarity of a file hash and the reputation of its source domain, analysts can identify outliers that suggest a potential threat. Files that are very rare and come from new or untrustworthy domains are highly suspicious.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - Internet gateway
      - Network egress points
      - DNS servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - FOR each downloaded container file, CALCULATE prevalence of file_hash and source_domain over last 30 days. FLAG if hash_prevalence < 5th percentile AND (domain_age < 30 days OR domain_reputation is low).
  - question: Does a downloaded container file have a high risk score based on a machine learning model?
    context: This question leverages a supervised machine learning model to provide a holistic risk assessment for each downloaded container file. By combining multiple features—such as file size, source ASN, domain age, file name entropy, and historical prevalence—the model can identify complex patterns of maliciousness that simple rules might miss, allowing for more nuanced and proactive threat detection.
    answer_sources:
      - Zeek files.log
      - Zeek http.log
      - Zeek conn.log
      - Internet gateway
      - Network egress points
      - DNS servers
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - INPUT container file download features (file_size, source_ASN, domain_age, file_name_entropy, etc.) INTO supervised classification model. TRIGGER investigation if risk_score > threshold.
  - question: Is a web browser or Office application spawning a process to mount a disk image or extract an archive?
    context: This question focuses on identifying suspicious parent-child process relationships. It is highly unusual for a user's web browser or an Office application to directly spawn command-line utilities to mount disk images or extract archives. This behavior is a strong indicator of a malicious script or macro executing automatically after a file is opened.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Virtual Desktop Infrastructure (VDI) instances
      - Application servers
    range: last 90 days
    queries:
      - SEARCH process creation logs WHERE ParentProcessName IN ('chrome.exe', 'msedge.exe', 'firefox.exe', 'winword.exe', 'excel.exe', 'powerpnt.exe', 'outlook.exe') AND ProcessName IN ('powershell.exe', 'explorer.exe', '7z.exe', 'winrar.exe', 'tar.exe') AND CommandLine CONTAINS ('Mount-DiskImage', 'hdiutil attach', '.iso', '.vhd', '.img', ' x ', ' e ').
  - question: Has a statistically rare parent-child process relationship, indicative of mounting or extraction, been observed?
    context: This question aims to detect anomalies by baselining normal process behavior. Instead of relying on a fixed list of suspicious process pairs, this approach identifies any parent-child relationship that is statistically rare in the environment. For example, if `outlook.exe` spawning `7z.exe` has never or rarely been seen, it would be flagged as a potential threat, providing a dynamic way to spot novel attacker techniques.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Virtual Desktop Infrastructure (VDI) instances
      - Application servers
    range: last 90 days
    queries:
      - BASELINE frequency of all parent-child process pairs over a 30-day period. ALERT if an observed pair's frequency is below the 1st percentile of all observed relationships.
  - question: Has there been an anomalous spike in disk image mounting activity for a specific user or host?
    context: This question applies time-series analysis to detect unusual changes in user or host behavior. An adversary attempting to deliver payloads via disk images may cause a sudden increase in mounting events. A significant deviation from an established baseline of activity for a particular entity can be a strong indicator of compromise, even if the individual actions seem benign.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - User workstations
      - Virtual Desktop Infrastructure (VDI) instances
      - Application servers
    range: last 90 days
    queries:
      - MODEL time-series of disk image mounting events per host and per user. ALERT if the current rate deviates from the established baseline by more than 3 standard deviations.
  - question: Has a process execution been observed from a newly mounted or extracted file within minutes of the initial download?
    context: This question correlates network and endpoint data to reconstruct the full attack sequence. By linking a network download of a container file to a subsequent mount/extraction action and then to a process execution from that container, analysts can confirm a MOTW bypass. A short timeframe between these events strongly suggests automated, malicious activity.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - SIEM/Data analytics platform
      - User workstations
      - Network sensors at egress points
    range: last 90 days
    queries:
      - In a SIEM, CORRELATE a network download of a container file with a subsequent process creation for a mount/extract utility on the same host within 10 minutes, followed by another process creation from a new drive letter or temp path within 2 minutes of the mount/extract.
  - question: Is the 'Time-To-Execution' from container download to first process execution unusually short?
    context: This question quantifies the speed of the attack chain to differentiate between user and automated activity. A very short 'Time-To-Execution' (TTE) — the time between the file download and the first process execution from within it — indicates that a script or exploit is likely responsible, as a human user would typically take longer to perform these actions manually.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - SIEM/Data analytics platform
      - User workstations
      - Network sensors at egress points
    range: last 90 days
    queries:
      - CALCULATE Time-To-Execution (TTE) as the delta between container file network write time and the first process execution from within the container. FLAG sequences where TTE falls into the lowest 10th percentile (e.g., <15 seconds).
  - question: Does a graph-based analysis of host activity reveal a pattern matching the MOTW bypass sequence (download -> mount -> execute)?
    context: This question uses advanced analytics to model host activity as a graph of interconnected events. This approach allows for the detection of the entire malicious MOTW bypass pattern—from network connection to file writes to process executions—as a single anomalous subgraph. This can be more resilient and context-aware than simple, linear correlation rules.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - SIEM/Data analytics platform
      - User workstations
      - Network sensors at egress points
    range: last 90 days
    queries:
      - MODEL host-level activity as a graph (nodes = files, processes, IPs). APPLY graph anomaly detection to identify and score subgraphs matching the pattern: [External IP] -> [File Write: container] -> [Process: mount/extract] -> [File Write: payload] -> [Process: payload].
  - question: Has an unsigned or known-malicious executable been run from a temporary directory or a newly mounted drive?
    context: This question focuses on the characteristics of the final payload execution. Legitimate software is typically digitally signed and installed in standard directories. An executable that is unsigned, has an invalid signature, or is running from a non-standard location like a temporary folder or a newly mounted drive is a very strong indicator of malware.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 7
      - User workstations
      - Servers
      - Domain Controllers
      - Code signing certificate authorities
    range: last 90 days
    queries:
      - SEARCH process creation logs (Sysmon EID 1) WHERE the executable `Image` path is on a non-C: drive or within `\Users\*\AppData\Local\Temp\*` AND (`SignatureStatus` is 'Unsigned' or 'Invalid') OR the `Image` path matches a known IOC.
  - question: Is an executable running from a path with unusually high entropy, suggesting obfuscation?
    context: This question aims to detect adversaries who use randomized or algorithmically generated file paths to evade signature-based detections. Calculating the Shannon entropy of a process's file path can identify such obfuscated paths. A path with an entropy score significantly higher than the environmental baseline is suspicious, especially if the parent process is a browser or archive utility.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 7
      - User workstations
      - Servers
      - Domain Controllers
      - Code signing certificate authorities
    range: last 90 days
    queries:
      - FOR each process creation event, CALCULATE the Shannon entropy of the file path in the `Image` field. FLAG any execution where the path entropy exceeds the 98th percentile for the environment.
  - question: Does an unsupervised machine learning model flag a process creation event as anomalous based on its characteristics (path, signature, parent process)?
    context: This question uses an unsupervised model, like an Isolation Forest, to find "unknown unknowns" in process activity. The model learns the characteristics of normal process executions and assigns an anomaly score to each new event. Events that are highly anomalous across multiple features (e.g., path entropy, unsigned, rare parent) are flagged for investigation, enabling detection of novel threats without pre-existing rules.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 7
      - User workstations
      - Servers
      - Domain Controllers
      - Code signing certificate authorities
    range: last 90 days
    queries:
      - TRAIN an unsupervised anomaly detection model on process creation features (file path entropy, parent process, is_unsigned, path location). The model will assign an anomaly score to each event; high scores indicate a deviation from normal behavior.