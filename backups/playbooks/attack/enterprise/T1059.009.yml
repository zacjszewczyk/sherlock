name: "T1059.009: Cloud API"
id: "0a8b1c2d-3e4f-4a5b-6c7d-8e9f0a1b2c3d"
description: "This playbook helps investigate whether an adversary has executed commands using cloud APIs. This can involve the execution of cloud CLI tools (e.g., aws.exe, az.exe) with parameters containing malicious indicators, or a specific sequence of API calls indicative of a known attack pattern (e.g., reconnaissance, credential access, defense evasion). It also looks for anomalous execution context, such as a cloud CLI being run by a non-administrator user or spawned from an unusual parent process like Microsoft Word. Further, it monitors for statistically significant increases in the volume of cloud CLI executions or outbound network connections to cloud API endpoints from a single host. Finally, it checks for a 'download-execute-API call' pattern, which suggests the staging and execution of a malicious script."
type: "technique"
related:
  - "TA0002: Execution"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are cloud CLI tools being executed with command-line arguments that contain known malicious indicators from threat intelligence feeds?"
    context: "This question aims to detect the direct use of cloud command-line tools for malicious purposes by correlating execution events with known bad indicators. An alert for this activity is a high-fidelity signal that an adversary is interacting with the cloud environment using compromised assets or known malicious infrastructure."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "AWS CloudTrail"
      - "Azure Activity Logs"
      - "Google Cloud Audit Logs"
      - "Developer workstations, administrator jump boxes, CI/CD servers, cloud control plane."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH process_creation_events OR cloud_audit_logs
          WHERE (process_name IN ('aws.exe', 'az.exe', 'gcloud.exe')
                 AND command_line_arguments CONTAINS any_indicator_from (threat_intelligence_feed))
          OR (api_call_parameters CONTAINS any_indicator_from (threat_intelligence_feed))
          TRIGGER alert

  - question: "Are there any cloud CLI executions using statistically rare or previously unseen command-line arguments?"
    context: "This question focuses on identifying anomalous cloud CLI usage by flagging commands with arguments that are uncommon across the enterprise. Adversaries often use unique parameters or resource names that deviate from normal administrative or developer activity. Detecting this rarity can surface novel or targeted attack techniques."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "AWS CloudTrail"
      - "Azure Activity Logs"
      - "Google Cloud Audit Logs"
      - "Developer workstations, administrator jump boxes, CI/CD servers, cloud control plane."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each cloud_cli_execution_event:
            EXTRACT command_line_arguments
            CALCULATE frequency_of_each_argument over last 30 days
            IF any_argument_frequency < 5th_percentile:
              TRIGGER alert

  - question: "Can we detect malicious cloud CLI commands based on their intrinsic properties using a machine learning model?"
    context: "This question proposes a more advanced, proactive detection method using machine learning. By training a model to recognize the characteristics of malicious commands (e.g., length, character patterns, sensitive keywords), security teams can identify suspicious activity that might not be caught by signature-based or simple statistical rules. This helps in detecting obfuscated or novel attack commands."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "AWS CloudTrail"
      - "Azure Activity Logs"
      - "Google Cloud Audit Logs"
      - "Developer workstations, administrator jump boxes, CI/CD servers, cloud control plane."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each cloud_cli_command_string:
            ENGINEER_FEATURES (length, entropy, special_chars, keywords)
            APPLY classification_model(features)
            GET probability_score
            IF probability_score > confidence_threshold:
              TRIGGER alert

  - question: "Is any user identity executing a sequence of API calls that matches known attack patterns, such as reconnaissance followed by credential access and defense evasion?"
    context: "This question aims to identify adversary behavior by looking for a logical chain of actions rather than a single event. Attackers often follow a predictable lifecycle (e.g., look around, steal secrets, cover tracks). Detecting this specific sequence of API calls in a short timeframe is a strong indicator of a multi-stage attack in progress."
    answer_sources:
      - "Windows Event ID 4688"
      - "AWS CloudTrail"
      - "Azure Activity Logs"
      - "Google Cloud Audit Logs"
      - "Cloud provider control plane (e.g., AWS Management Console, Azure Portal), CI/CD pipeline runners, administrator workstations."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          CORRELATE cloud_audit_logs by user_identity over 15_minute_window
          IF sequence_of_events matches (recon_call THEN credential_access_call THEN defense_evasion_call):
            TRIGGER alert

  - question: "Has any user's pattern of API call usage (e.g., mix of Read, Write, List calls) significantly deviated from their established historical baseline?"
    context: "This question focuses on user behavior analytics to spot anomalies. A compromised account will likely be used to perform actions that are uncharacteristic for the legitimate user. By baselining normal activity and alerting on significant deviations, this method can detect account takeovers or insider threats."
    answer_sources:
      - "Windows Event ID 4688"
      - "AWS CloudTrail"
      - "Azure Activity Logs"
      - "Google Cloud Audit Logs"
      - "Cloud provider control plane (e.g., AWS Management Console, Azure Portal), CI/CD pipeline runners, administrator workstations."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each user_identity:
            BUILD 30-day baseline_profile of API call categories ('Read', 'Write', 'List')
            CALCULATE current_1-hour_distribution of API call categories
            PERFORM Chi-Squared_test(current_distribution, baseline_profile)
            IF test_result is statistically_significant:
              TRIGGER alert

  - question: "Are there any user API call sequences that are flagged as anomalous by a sequence-based machine learning model (e.g., RNN, Markov model)?"
    context: "This question leverages advanced sequence modeling to understand the 'grammar' of normal user API interactions. The model learns common transitions between API calls. An alert signifies a sequence that breaks the learned pattern, suggesting an unusual or potentially malicious workflow that rule-based systems might miss."
    answer_sources:
      - "Windows Event ID 4688"
      - "AWS CloudTrail"
      - "Azure Activity Logs"
      - "Google Cloud Audit Logs"
      - "Cloud provider control plane (e.g., AWS Management Console, Azure Portal), CI/CD pipeline runners, administrator workstations."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each user_session (sequence of API calls):
            APPLY sequence_anomaly_model(session)
            GET probability_of_sequence
            IF probability_of_sequence is low:
              TRIGGER alert

  - question: "Are cloud CLI tools being executed by unauthorized users or spawned from unusual parent processes like Microsoft Word?"
    context: "This question seeks to identify abuse of cloud CLI tools by examining the execution context. Legitimate use typically comes from specific users (administrators, developers) and processes (terminals, IDEs). Execution by an unauthorized user or from an office application parent process is a strong indicator of a compromised endpoint."
    answer_sources:
      - "Windows Event ID 4688"
      - "Active Directory security logs"
      - "All corporate endpoints, application servers, developer workstations, Domain Controllers."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          SEARCH process_creation_events
          WHERE process_name IN ('aws.exe', 'az.exe', 'gcloud.exe')
          AND (executing_user NOT IN 'Cloud Admins' group
               OR parent_process_name NOT IN ('powershell.exe', 'cmd.exe', 'explorer.exe'))
          TRIGGER alert

  - question: "Have any cloud CLI tools been launched from a parent process that is rare or has never been observed in the environment before?"
    context: "This question uses statistical rarity to find suspicious process lineage. Adversaries may use novel techniques to launch tools, creating parent-child relationships that deviate from the established norm. By baselining these relationships, security teams can spot new or unusual execution chains that could signal malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Active Directory security logs"
      - "All corporate endpoints, application servers, developer workstations, Domain Controllers."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          BUILD frequency_table of all parent-child_process relationships over 90 days
          FOR each new cloud_cli_execution:
            GET parent_process_name
            IF parent-child_relationship is new OR frequency < 5th_percentile:
              TRIGGER alert

  - question: "Are there any cloud CLI executions that are classified as anomalous based on a machine learning model trained on normal execution context features (user groups, parent process, file path)?"
    context: "This question proposes using an anomaly detection model to create a holistic profile of what 'normal' cloud CLI execution looks like. This allows it to detect subtle anomalies where no single feature is suspicious on its own, but the combination is highly irregular, pointing to sophisticated evasion attempts."
    answer_sources:
      - "Windows Event ID 4688"
      - "Active Directory security logs"
      - "All corporate endpoints, application servers, developer workstations, Domain Controllers."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each cloud_cli_execution_event:
            ENGINEER_FEATURES (user_groups, parent_process, file_path, cmd_length)
            APPLY One-Class_SVM_model(features)
            IF model_classifies as outlier:
              TRIGGER alert

  - question: "Is any single host exhibiting a sudden, high-volume burst of cloud CLI executions or network connections to cloud API endpoints?"
    context: "This question aims to detect brute-force or high-volume automated activity by setting simple, high-threshold alerts. A sudden spike in CLI executions or network traffic to API endpoints from a single host can indicate a script or an adversary rapidly enumerating, exfiltrating, or destroying resources."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Network egress points, VPN concentrators, individual host network interfaces, and host-level process monitoring."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          AGGREGATE events by host over 10_minute_window
          IF (count(cloud_cli_processes) > 50)
             OR (count(outbound_connections_to_cloud_apis) > 1000):
            TRIGGER alert

  - question: "Has the volume of API calls from a specific host significantly exceeded its own historical, time-of-day baseline?"
    context: "This question uses statistical baselining to identify abnormal traffic volume from a host. Unlike a fixed threshold, this method adapts to the host's normal behavior. An alert indicates that the host is unusually active compared to its own past behavior, which could signal a compromise or misuse."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Network egress points, VPN concentrators, individual host network interfaces, and host-level process monitoring."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each host:
            BUILD 30-day baseline of hourly API call volume (mean, std_dev) by time_slot
            GET current_hourly_volume
            GET baseline_mean, baseline_std_dev for current_time_slot
            IF current_hourly_volume > (baseline_mean + 3 * baseline_std_dev):
              TRIGGER alert

  - question: "For high-value assets, has the observed API call volume exceeded the predicted volume generated by a time-series forecasting model?"
    context: "This question applies advanced time-series analysis for more precise anomaly detection on critical assets. By forecasting expected activity levels and alerting when reality deviates, this method can detect subtle increases in activity that might be missed by simpler checks, providing an earlier warning of potential compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Network egress points, VPN concentrators, individual host network interfaces, and host-level process monitoring."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each high_value_host:
            USE time_series_model to predict_expected_volume for next 15_minutes with confidence_band
            GET actual_observed_volume
            IF actual_observed_volume > upper_bound of confidence_band:
              TRIGGER alert

  - question: "Has any host exhibited a 'download-execute-API call' event sequence within a short time window?"
    context: "This question looks for a classic attack chain: an adversary downloads a tool, runs it, and then uses it to interact with the cloud. Correlating these three distinct event types from the same host in a tight timeframe provides strong evidence of a malicious payload being staged and activated."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "User workstations, public-facing web servers, CI/CD servers, network file transfer analysis points."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          CORRELATE events by host_ip over 5_minute_window
          IF sequence matches (file_download THEN script_engine_execution THEN cloud_cli_execution):
            TRIGGER alert

  - question: "Has the variety of unique processes running on a host spiked suddenly, as measured by Shannon entropy?"
    context: "This question uses information theory to detect unusual host activity. A stable system runs a predictable set of processes. A sudden increase in the variety of processes (high entropy) can indicate that a malicious script is executing a wide range of discovery commands or tools."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "User workstations, public-facing web servers, CI/CD servers, network file transfer analysis points."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each host:
            CALCULATE baseline_entropy of process_names
            GET unique process_names in last 5_minutes
            CALCULATE current_entropy
            IF current_entropy > 95th_percentile_of_baseline:
              TRIGGER alert

  - question: "Has a host generated a sequence of events (e.g., file download, powershell execution) that is considered anomalous by a sequence-based machine learning model?"
    context: "This question proposes modeling the sequence of different types of events on a host. A model like an LSTM autoencoder learns what normal sequences of activities look like. When a novel sequence occurs, the model fails to 'reconstruct' it well, flagging it as a high-probability anomaly."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek files.log"
      - "User workstations, public-facing web servers, CI/CD servers, network file transfer analysis points."
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: |
          FOR each host:
            CREATE sequence of event_types (e.g., 'file_download', 'ps_exec', 'aws_exec')
            FEED sequence into LSTM_autoencoder_model
            GET reconstruction_error
            IF reconstruction_error is high:
              TRIGGER alert