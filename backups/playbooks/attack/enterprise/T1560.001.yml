name: "T1560.001: Archive via Utility"
id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
description: "This playbook helps determine if an adversary has collected and prepared data for exfiltration using archiving utilities. It provides investigative steps to detect the use of known malicious archiving tools, the anomalous execution of legitimate utilities for data staging, the creation of suspicious archive files in non-standard locations, the exfiltration of archives over the network, and the correlation of event sequences that indicate a full discovery-to-staging attack chain."
type: "technique"
related:
  - "TA0009: Collection"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are known malicious archiving tools or command-line strings being executed in the environment?"
    context: "This question aims to identify the simplest and most direct evidence of malicious activity: the use of tools or commands that are definitively linked to threat actors through Cyber Threat Intelligence (CTI). By matching process hashes (MD5, SHA256) or full command-line strings against a list of known Indicators of Compromise (IOCs), analysts can quickly detect the presence of adversary-provided archiving utilities, which is a strong signal of data collection for exfiltration."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All enterprise endpoints and servers, particularly those hosting sensitive data or belonging to high-privilege users such as Domain Controllers, code repositories, and file servers."
    range: "last 90 days"
    queries:
      - "SEARCH process_creation_events WHERE (process_hash IN (cti_hash_list) OR command_line IN (cti_command_list))"
  - question: "Are rare or non-standard archiving utilities being executed across the enterprise?"
    context: "Adversaries often bring their own tools, which will not be part of the standard software suite deployed across the organization. This question focuses on identifying these non-standard tools by calculating the prevalence of each executed file hash. An archiving utility (e.g., 7z.exe, rar.exe) that runs on only a very small number of hosts (e.g., less than 1%) is suspicious and warrants investigation as it may be a custom or adversary-introduced tool rather than a corporately managed application."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All enterprise endpoints and servers, particularly those hosting sensitive data or belonging to high-privilege users such as Domain Controllers, code repositories, and file servers."
    range: "last 90 days"
    queries:
      - "CALCULATE prevalence of process_hash for all process_creation_events. SEARCH process_creation_events WHERE process_name MATCHES ('7z.exe', 'rar.exe', ...) AND process_hash_prevalence < 1%"
  - question: "Can we predictively identify malicious archiving utility executions based on their behavioral features?"
    context: "This question moves beyond simple IOCs or rarity to a more sophisticated, predictive approach. By training a machine learning model on a variety of features from process creation events (e.g., parent process, command-line characteristics, hash prevalence, binary signature), we can learn the subtle patterns that distinguish malicious executions from benign ones. This helps detect novel threats that don't match known IOCs and provides a scored, risk-based assessment for analysts."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "All enterprise endpoints and servers, particularly those hosting sensitive data or belonging to high-privilege users such as Domain Controllers, code repositories, and file servers."
    range: "last 90 days"
    queries:
      - "APPLY ML_model to process_creation_events with features (parent_process, cmd_length, arg_count, hash_prevalence, signature_info). ALERT on high_probability_malicious_prediction."
  - question: "Are legitimate archiving utilities being used to target sensitive data or being launched by unusual parent processes?"
    context: "Adversaries frequently use legitimate, 'living-off-the-land' binaries (LOLBins) to avoid detection. This question focuses on detecting the malicious use of these legitimate tools. The query looks for specific indicators in the command line, such as targeting sensitive user directories ('C:\\Users'), using password protection, or employing specific staging commands. It also checks for anomalous parent-child relationships, like an Office application or web server spawning an archiving tool, which is highly irregular and suggests process injection or remote command execution."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "User workstations, developer workstations, administrative jump boxes, and web servers where command-line tools are common but staging large archives, especially by automated processes, is not."
    range: "last 90 days"
    queries:
      - "SEARCH process_creation_events WHERE process_name IN ('7z.exe', 'tar.exe', ...) AND (command_line CONTAINS ('C:\\Users', '-p', '-hp', 'certutil -encode') OR parent_process_name IN ('winword.exe', 'w3wp.exe', ...))"
  - question: "Are there statistical anomalies in the command-line arguments or parent processes of legitimate archiving utilities?"
    context: "This question aims to find outliers in how legitimate archiving tools are used. Malicious commands are often generated by scripts and can have higher complexity or randomness than commands typed by a human. Calculating the Shannon entropy of command-line arguments can detect this randomness. Similarly, by baselining normal parent-child process relationships, we can flag any pairing that is statistically rare, indicating a deviation from normal user or system behavior."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "User workstations, developer workstations, administrative jump boxes, and web servers where command-line tools are common but staging large archives, especially by automated processes, is not."
    range: "last 90 days"
    queries:
      - "CALCULATE baseline of parent-child pairs and command-line entropy for archiving utilities. ALERT on executions where parent-child_pair_rarity < 1% OR command_line_entropy > threshold."
  - question: "Can we use an anomaly detection model to identify unusual executions of legitimate archiving utilities based on a combination of features?"
    context: "This question leverages machine learning to build a holistic profile of 'normal' activity for legitimate archiving tools. An unsupervised anomaly detection model (like an Isolation Forest) can analyze multiple features simultaneously—such as argument count, target file path depth, presence of password flags, parent process rarity, and time of day—to identify executions that are outliers from the established norm. This approach can catch sophisticated adversaries who might evade simpler, single-indicator rules."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "User workstations, developer workstations, administrative jump boxes, and web servers where command-line tools are common but staging large archives, especially by automated processes, is not."
    range: "last 90 days"
    queries:
      - "APPLY anomaly_detection_model to process_creation_events with features (arg_count, path_depth, password_flag, parent_rarity, time_of_day). ALERT on outlier_prediction."
  - question: "Are archive files being created in suspicious or non-standard locations?"
    context: "Adversaries often stage data for exfiltration in temporary or publicly writable directories to avoid immediate detection and permission issues. This question looks for the creation of archive files (e.g., .zip, .rar) in unusual locations like 'C:\\Windows\\Temp', '%APPDATA%', or 'C:\\Users\\Public'. It also adds context by checking if the process creating the file is something other than a user-driven process like 'explorer.exe' or a known backup utility, which increases the likelihood of malicious intent."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4688"
      - "Windows Event ID 4656"
      - "Windows Event ID 4663"
      - "File servers, document management systems (e.g., SharePoint servers), critical application servers, and user profile directories on workstations where large data sets reside or are commonly staged."
    range: "last 90 days"
    queries:
      - "SEARCH file_creation_events WHERE file_extension IN ('.zip', '.rar', ...) AND file_path IN ('C:\\Windows\\Temp\\*', '%APPDATA%\\*', ...) AND creating_process_name NOT IN ('explorer.exe', 'backup.exe', ...)"
  - question: "Are hosts exhibiting an anomalous volume, frequency, or naming pattern of archive file creation?"
    context: "This question seeks to identify data staging activity by looking for statistical deviations from normal behavior on a per-host basis. A sudden spike in the number or total size of archive files created on a machine can indicate that an adversary is consolidating large amounts of data. Additionally, malware often uses randomized filenames to avoid static signatures; calculating the entropy of filenames created within a short window can detect this automated, non-human naming convention."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4688"
      - "Windows Event ID 4656"
      - "Windows Event ID 4663"
      - "File servers, document management systems (e.g., SharePoint servers), critical application servers, and user profile directories on workstations where large data sets reside or are commonly staged."
    range: "last 90 days"
    queries:
      - "CALCULATE baseline of hourly archive count/size per host. ALERT if current_hour_count > 99th_percentile_baseline. CALCULATE entropy of archive filenames in 5-min window. ALERT if entropy > threshold."
  - question: "Can a time-series model predict and detect anomalous spikes in the volume of created archive data, correlated with prior sensitive file access?"
    context: "This is a more advanced statistical method that uses a forecasting model (like ARIMA) to predict the expected volume of archive data creation for a host or user. An alert is generated when the actual volume significantly exceeds the model's prediction. To increase confidence and reduce false positives, this alert is then correlated with preceding file access events (Event ID 4656/4663) from the same process, confirming that the process was first accessing sensitive data before creating the archive."
    answer_sources:
      - "Sysmon Event ID 11"
      - "Windows Event ID 4688"
      - "Windows Event ID 4656"
      - "Windows Event ID 4663"
      - "File servers, document management systems (e.g., SharePoint servers), critical application servers, and user profile directories on workstations where large data sets reside or are commonly staged."
    range: "last 90 days"
    queries:
      - "APPLY time_series_model to archive_creation_volume per host. IF observed_volume > predicted_confidence_interval, THEN CHECK for preceding sensitive_file_access by same process_id. ALERT if correlated."
  - question: "Are archive files being exfiltrated over the network to untrusted external destinations or using non-standard protocols?"
    context: "This question targets the exfiltration phase directly by monitoring network traffic. The query identifies when a file identified as an archive (by its MIME type) is transferred to an external IP address that is not on a pre-approved allowlist of trusted destinations (e.g., corporate cloud services). It also checks for protocol-mismatch, a common evasion technique where data is sent over a port that does not match the protocol, such as sending a ZIP file over port 53 (DNS)."
    answer_sources:
      - "Zeek files.log"
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Zeek dns.log"
      - "Network egress points, VPN gateways, traffic to cloud storage provider IP ranges, and internal network segments separating critical servers from the general user network."
    range: "last 90 days"
    queries:
      - "JOIN files_log and conn_log on UID. ALERT WHERE files_log.mime_type = 'application/zip' AND conn_log.destination_ip is_external AND conn_log.destination_ip NOT IN (allowlist) OR conn_log.destination_port = 53."
  - question: "Are any hosts transferring a statistically anomalous volume of archive data to external destinations, or to new/rare Autonomous System Numbers (ASNs)?"
    context: "This question uses statistical baselining to detect abnormal exfiltration patterns. By tracking the normal daily volume of outbound archive data for each host, a Z-score can identify significant spikes in activity (e.g., a host suddenly sending gigabytes of ZIP files). Additionally, organizations typically communicate with a relatively stable set of external networks (ASNs). A transfer to a new or rarely seen ASN for the organization is suspicious and could indicate communication with an adversary-controlled server."
    answer_sources:
      - "Zeek files.log"
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Zeek dns.log"
      - "Network egress points, VPN gateways, traffic to cloud storage provider IP ranges, and internal network segments separating critical servers from the general user network."
    range: "last 90 days"
    queries:
      - "CALCULATE daily baseline of outbound archive volume per host. ALERT if current_day_volume_Z-score > 3. CALCULATE baseline of destination ASNs. ALERT on transfers to new or rare ASNs."
  - question: "Can a machine learning model identify anomalous archive file transfers based on a multi-featured profile of normal network activity?"
    context: "This question leverages an unsupervised machine learning model to create a rich, multi-dimensional profile of what constitutes a 'normal' outbound archive transfer. The model considers features like file size, destination port, time of day, destination ASN, and even TLS encryption parameters (JA3 hash, SNI). Any transfer that significantly deviates from this learned profile is flagged as an anomaly, allowing for the detection of novel or sophisticated exfiltration techniques that might evade simpler rules."
    answer_sources:
      - "Zeek files.log"
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Zeek dns.log"
      - "Network egress points, VPN gateways, traffic to cloud storage provider IP ranges, and internal network segments separating critical servers from the general user network."
    range: "last 90 days"
    queries:
      - "APPLY one-class_SVM_model to network_logs with features (file_size, port, time, ASN, JA3, SNI). ALERT on outlier_prediction."
  - question: "Are we observing the classic 'discovery, compression, staging' attack chain on a single host within a short time frame?"
    context: "This question aims to detect a high-confidence attack pattern by correlating a sequence of events. Adversaries typically don't know the layout of a network, so they first run discovery commands (like 'dir /s') to find valuable data. They then compress this data using an archiving utility and create an archive file. A SIEM rule that triggers on this specific sequence—discovery, then compression, then archive creation—on the same host within a short window (e.g., 30 minutes) is a very strong indicator of active data collection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Domain Controllers, database servers, and workstations of executives, system administrators, or developers with access to sensitive intellectual property."
    range: "last 90 days"
    queries:
      - "CORRELATE events on a single host within 30 mins: TRIGGER if (event1 = discovery_command) FOLLOWED BY (event2 = archive_utility_execution) FOLLOWED BY (event3 = archive_file_creation)."
  - question: "Can we assign risk scores to individual events to identify high-risk user sessions indicative of data staging?"
    context: "Instead of a rigid sequence, this question uses a flexible risk-scoring model. Different suspicious actions are assigned points (e.g., running a discovery command: +2, archiving a user profile directory: +5). These scores are summed over a rolling time window for each user/host session. Sessions that accumulate a total risk score exceeding a high percentile (e.g., the 98th percentile of all session scores) are flagged for review. This approach is more robust than a fixed correlation rule and can catch variations of the attack chain."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Domain Controllers, database servers, and workstations of executives, system administrators, or developers with access to sensitive intellectual property."
    range: "last 90 days"
    queries:
      - "FOR each user session: SUM risk scores of events (e.g., discovery=+2, archiving_sensitive_dir=+5, creating_archive_in_temp=+3). ALERT if session_total_score > 98th_percentile_of_all_sessions."
  - question: "Can a sequence analysis model learn normal user behavior and identify the 'discovery -> compression -> stage' sequence as a low-probability, high-risk anomaly?"
    context: "This question applies advanced machine learning to model the sequence of user and system actions. Models like HMMs or RNNs are trained on vast amounts of benign event data to learn the normal transition probabilities between different states (e.g., the high probability of transitioning from 'opening Outlook' to 'opening a Word document'). The malicious sequence of 'run discovery command' -> 'run compression tool' -> 'create archive file' would be an extremely low-probability transition in a properly trained model, allowing it to be flagged as a high-risk anomaly, even if the individual events themselves are not overtly malicious."
    answer_sources:
      - "Windows Event ID 4688"
      - "Sysmon Event ID 1"
      - "Sysmon Event ID 11"
      - "Domain Controllers, database servers, and workstations of executives, system administrators, or developers with access to sensitive intellectual property."
    range: "last 90 days"
    queries:
      - "APPLY sequence_analysis_model (HMM/RNN) to host event streams. ALERT if a sequence with a low probability score is detected, especially if it matches the discovery->compression->stage pattern."