name: T1584.001: Domains
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps determine if an adversary has registered, hijacked, or otherwise acquired a domain to mimic an organization's identity for use in future operations. This involves detecting connections to known malicious domains from threat intelligence, identifying look-alike domains (typosquats, homographs), spotting suspicious subdomains on legitimate company assets (domain shadowing), recognizing when a company domain resolves to an unauthorized IP (hijacking), and flagging domains that exhibit a combination of suspicious technical attributes like low TTLs and very new SSL certificates.
type: technique
related:
- TA0042: Resource Development
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is an internal host connecting to a domain on a known threat intelligence feed (hijacked, C2, or NRD)?
  context: This is a fundamental detection strategy that relies on high-quality, up-to-date threat intelligence. By comparing outbound DNS queries and network connections against a curated list of known malicious domains, an analyst can quickly identify direct communication with adversary infrastructure. A match is often a high-fidelity indicator of compromise.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Windows Event ID 5156
  - Enterprise DNS resolvers
  - Outbound web proxies and firewalls
  - Endpoint devices
  range: last 90 days
  queries:
  - pseudocode: |
      JOIN (dns_logs.query, connection_logs.server_name) WITH threat_intel_blocklist.domain
      WHERE match IS NOT NULL
      ALERT HIGH
- question: If a connection to a Newly Registered Domain (NRD) is observed, are an anomalous number of internal hosts connecting to it shortly after its registration?
  context: Adversaries often register new domains and immediately use them in campaigns. While a single user visiting a new, benign site is common, many distinct internal hosts connecting to the same NRD within its first day of life is highly unusual. This behavior can indicate a coordinated malware outbreak or a phishing campaign where multiple victims are calling back to the same C2 domain.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Windows Event ID 5156
  - Enterprise DNS resolvers
  - Outbound web proxies and firewalls
  - Endpoint devices
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH domain IN nrd_threat_feed
      COUNT unique_source_ips in connection_logs
      WHERE connection_time < domain.registration_date + 24_hours
      IF count > 95th_percentile_baseline
      FLAG as coordinated_activity
- question: Can machine learning be used to score and prioritize alerts from threat intelligence matches based on connection characteristics?
  context: Not all threat intelligence hits carry the same risk. A sophisticated alert can be enriched with additional context. By training a machine learning model on features like domain age, the source of the threat feed, the number of internal hosts connecting, and the volume of data transferred, an organization can generate a 'maliciousness probability' score. This allows security analysts to focus their limited time on the highest-risk alerts, rather than treating every match as equal.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Windows Event ID 5156
  - Enterprise DNS resolvers
  - Outbound web proxies and firewalls
  - Endpoint devices
  range: last 90 days
  queries:
  - pseudocode: |
      ON new_threat_intel_match
      EXTRACT features (domain_age, connection_count, bytes_transferred, etc.)
      APPLY pre-trained_random_forest_model(features)
      GENERATE maliciousness_probability_score
      PRIORITIZE alerts based on score
- question: Is a host querying a domain that is not on our approved list and matches patterns for combosquatting (e.g., 'yourcompany-login')?
  context: Combosquatting is an attack where adversaries register domains by combining a legitimate brand name with keywords like 'login', 'support', 'portal', or 'hr'. By maintaining an allow-list of known good domains and scanning all other DNS queries with regular expressions that look for these keyword patterns, an analyst can effectively detect potential phishing or credential harvesting sites.
  answer_sources:
  - Zeek dns.log
  - Certificate Transparency Logs
  - Enterprise DNS resolvers
  - Certificate Transparency log aggregators
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH dns_query.domain
      IF dns_query.domain NOT IN org_allow_list
      AND dns_query.domain MATCHES combosquat_regex_patterns
      ALERT MEDIUM
- question: Is a host querying a non-allow-listed domain that is either a likely typosquat (very similar spelling) or a homograph (uses look-alike characters)?
  context: Typosquatting relies on users making small spelling errors, while homograph attacks use visually similar characters from different alphabets (e.g., Cyrillic 'Ð°' vs. Latin 'a'). These can be detected programmatically. By calculating the string edit distance (e.g., Damerau-Levenshtein) to known good domains, we can spot typosquats. By analyzing character sets and checking for Punycode ('xn--'), we can identify potential homographs.
  answer_sources:
  - Zeek dns.log
  - Certificate Transparency Logs
  - Enterprise DNS resolvers
  - Certificate Transparency log aggregators
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH dns_query.domain NOT IN org_allow_list
      CALCULATE levenshtein_distance to nearest_allow_list_domain
      CALCULATE shannon_entropy
      IF levenshtein_distance <= 2 OR (entropy is high AND contains 'xn--')
      FLAG as potential_typosquat_or_homograph
- question: Can a machine learning model predict whether a newly observed, non-allow-listed domain is likely a typosquat or otherwise malicious?
  context: Rather than relying on a single metric like string distance, a machine learning model can be trained to look at a combination of features to make a more accurate prediction. By feeding it features like character-level n-grams, vowel-to-consonant ratios, string distance, and the presence of keywords, a supervised model can learn the subtle differences between legitimate and malicious look-alike domains and score new domains in real-time.
  answer_sources:
  - Zeek dns.log
  - Certificate Transparency Logs
  - Enterprise DNS resolvers
  - Certificate Transparency log aggregators
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH new_domain NOT IN org_allow_list
      FEATURIZE domain (n-grams, char_ratios, levenshtein_dist, etc.)
      APPLY pre-trained_logistic_regression_model(features)
      IF prediction_probability > threshold
      ALERT HIGH
- question: Is a host querying a subdomain of a legitimate company domain that is not on the authoritative inventory of known subdomains?
  context: This question targets 'domain shadowing,' an attack where an adversary compromises an organization's DNS registrar account to create malicious subdomains on a legitimate, trusted parent domain. The first step in detection is to maintain an inventory of all valid subdomains. Any DNS query for a subdomain not on this list is immediately suspicious and could indicate an attacker is using the company's own domain for malicious purposes.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 22
  - Public-facing DNS records
  - Internal DNS resolvers
  - Endpoint devices
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH dns_query for company_domain
      EXTRACT subdomain
      IF subdomain NOT IN known_subdomain_inventory
      ALERT MEDIUM
- question: Does a newly observed, non-inventoried subdomain of a company domain have a high degree of randomness, suggesting it was generated by an algorithm (DGA)?
  context: When attackers use domain shadowing, they often employ Domain Generation Algorithms (DGAs) to create a large number of unpredictable subdomain names for C2 channels (e.g., 'k4f9z1.yourcompany.com'). These algorithmically generated names have high entropy (randomness). By calculating the Shannon entropy of any new, non-inventoried subdomain and comparing it to the normal entropy of legitimate subdomains, we can flag highly random names as likely DGA-based C2.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 22
  - Public-facing DNS records
  - Internal DNS resolvers
  - Endpoint devices
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH new_unknown_subdomain
      CALCULATE shannon_entropy of subdomain_label
      IF entropy > 98th_percentile_of_legit_subdomain_entropy
      ALERT HIGH
- question: Is there an anomalous spike in the rate of discovery of new, previously unseen subdomains for our company domains?
  context: Legitimate new subdomains are typically created at a slow, predictable rate. An adversary activating a domain shadowing campaign may generate dozens or hundreds of malicious subdomains at once. A time-series forecasting model can learn the normal rate of new subdomain creation. If the number of newly observed subdomains in a short period dramatically exceeds the model's prediction, it signals an anomaly that could be the start of an attack.
  answer_sources:
  - Zeek dns.log
  - Windows Event ID 22
  - Public-facing DNS records
  - Internal DNS resolvers
  - Endpoint devices
  range: last 90 days
  queries:
  - pseudocode: |
      MODEL rate of new_subdomain_discovery per hour with SARIMA
      OBSERVE current_hour_new_subdomain_count
      IF current_hour_count > model.99_percent_prediction_interval
      FLAG as anomalous_subdomain_burst
- question: Did a DNS query for one of our company-owned domains resolve to an IP address outside of our organization's approved IP space?
  context: This is a critical check for DNS hijacking. An organization knows which IP addresses (CIDR blocks) its websites and services should resolve to. By maintaining an allow-list of these IPs and monitoring all DNS responses for company domains, any resolution to an IP outside this list is a red flag. It indicates that an attacker has likely compromised the DNS records to redirect users to malicious infrastructure.
  answer_sources:
  - Zeek dns.log
  - External DNS Monitoring Service Logs
  - Internal DNS resolvers
  - External DNS monitoring services (e.g., distributed probes)
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH dns_response for company_domain
      EXTRACT resolved_ip from answers
      IF resolved_ip NOT IN company_ip_allow_list
      ALERT CRITICAL
- question: Has a critical company domain started resolving to an IP in an Autonomous System (ASN) or country that has never been associated with it before?
  context: Beyond just the IP address, the hosting provider (identified by its ASN) and geographic location are stable characteristics of a domain's infrastructure. If a critical domain that has always resolved to IPs within a specific set of ASNs and countries suddenly resolves to a new, unexpected ASN or country, it suggests a fundamental and unauthorized change in its routing, which is a strong indicator of a hijack.
  answer_sources:
  - Zeek dns.log
  - External DNS Monitoring Service Logs
  - Internal DNS resolvers
  - External DNS monitoring services (e.g., distributed probes)
  range: last 90 days
  queries:
  - pseudocode: |
      BASELINE historical_asn_and_country for critical_domains
      FOR EACH new_dns_resolution
      GET new_ip_asn, new_ip_country
      IF new_ip_asn NOT IN historical_asn OR new_ip_country NOT IN historical_country
      FLAG as suspicious_infrastructure_change
- question: Can an anomaly detection model identify DNS resolutions for our critical domains that are statistically unusual based on historical patterns?
  context: A sophisticated DNS hijack might use an IP address that is not on a blocklist and is in a plausible ASN or country. An unsupervised anomaly detection model (like an Isolation Forest) can learn the normal, multi-dimensional profile of a domain's resolutions (IP, ASN, country, TTL, etc.). It can then flag any new resolution that deviates significantly from this learned norm, even if no single attribute is obviously malicious, catching novel attack patterns.
  answer_sources:
  - Zeek dns.log
  - External DNS Monitoring Service Logs
  - Internal DNS resolvers
  - External DNS monitoring services (e.g., distributed probes)
  range: last 90 days
  queries:
  - pseudocode: |
      TRAIN isolation_forest_model on historical_dns_data (IP, ASN, country, TTL)
      FOR EACH new_dns_resolution
      CALCULATE anomaly_score with model
      IF anomaly_score > tuned_threshold
      FLAG as anomalous_resolution
- question: Is a host connecting to a domain that is newly observed in our environment, has a very recent SSL certificate, and uses a low DNS Time-To-Live (TTL) value?
  context: This combination of attributes is a classic signature for adversary C2 infrastructure. Attackers set up domains 'just-in-time' for a campaign, so they are new to the environment and have recently issued certificates. They use low TTLs so they can quickly change the underlying IP address to evade blocking. A correlation rule that flags traffic exhibiting all three of these characteristics is a powerful tool for detecting fresh C2 activity.
  answer_sources:
  - Zeek dns.log
  - Zeek ssl.log
  - Zeek conn.log
  - Zeek x509.log
  - Outbound web proxies and firewalls
  - Certificate Transparency logs
  - Enterprise DNS resolvers
  range: last 90 days
  queries:
  - pseudocode: |
      JOIN connection, dns, and ssl logs
      WHERE domain_is_new_in_last_30_days
      AND ssl_cert_age < 72_hours
      AND dns_ttl < 300
      ALERT HIGH
- question: Can we calculate a composite risk score for new external connections to identify those that exhibit multiple suspicious characteristics simultaneously?
  context: Instead of a rigid, multi-condition rule, a weighted scoring system provides more flexibility. Weak signals of maliciousness (e.g., domain seen for the first time, issued by a free certificate authority, has a low TTL, has a high-entropy name) can be assigned points. The points for a given connection are summed into a total risk score. By alerting on connections that exceed a statistically determined threshold, analysts can catch a wider variety of suspicious activity that might not trigger a more specific rule.
  answer_sources:
  - Zeek dns.log
  - Zeek ssl.log
  - Zeek conn.log
  - Zeek x509.log
  - Outbound web proxies and firewalls
  - Certificate Transparency logs
  - Enterprise DNS resolvers
  range: last 90 days
  queries:
  - pseudocode: |
      FOR EACH new_connection
      CALCULATE risk_score = (weight1 * is_new_domain) + (weight2 * is_cert_age_low) + ...
      IF risk_score > 99th_percentile_of_historical_scores
      ALERT MEDIUM
- question: Can newly observed domains be automatically grouped (clustered) with previously identified malicious domains based on shared technical attributes?
  context: Adversaries often reuse infrastructure or follow a consistent pattern when setting up new domains. Unsupervised clustering algorithms (like DBSCAN) can analyze technical features (TTL, certificate issuer, domain name structure, etc.) of all newly observed domains. This allows the system to automatically group new, unknown domains with previously investigated clusters. If a new domain falls into a cluster that has been labeled 'malicious,' it can be flagged for immediate investigation.
  answer_sources:
  - Zeek dns.log
  - Zeek ssl.log
  - Zeek conn.log
  - Zeek x509.log
  - Outbound web proxies and firewalls
  - Certificate Transparency logs
  - Enterprise DNS resolvers
  range: last 90 days
  queries:
  - pseudocode: |
      FEATURIZE all new domains (TTL, cert_issuer, entropy, etc.)
      APPLY DBSCAN clustering algorithm
      FOR EACH new_domain
      IF new_domain assigned to a 'suspicious' cluster
      ALERT MEDIUM