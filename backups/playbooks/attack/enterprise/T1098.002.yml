name: T1098.002: Additional Email Delegate Permissions
id: 5e9b8f7c-1a2d-4b3e-8f6a-9c7d0e1f2a3b
description: This playbook focuses on detecting malicious use of additional email delegate permissions, a technique adversaries use for both persistence (TA0003) and privilege escalation (TA0004). It provides investigative questions to identify suspicious permission changes, such as those involving watchlisted accounts, newly created accounts, or granting of 'FullAccess' rights. It also covers detecting anomalous behavior following a delegation event, including unusual login patterns and abnormal outbound email activity, to uncover compromised mailboxes.
type: technique
related:
  - TA0003: Persistence
  - TA0004: Privilege Escalation
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a mailbox permission change been performed by or on an account that is on a watchlist of compromised or high-risk accounts?
    context: Adversaries often use compromised accounts to pivot and grant themselves access to other mailboxes. Cross-referencing permission change events with a maintained watchlist of suspicious or high-value accounts is a direct way to detect this specific activity. An alert on this condition provides a high-fidelity signal of potential malicious persistence.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH (M365 UAL OR WinEvent:4104) for mailbox permission changes.
          CHECK if actor OR target account is in high-risk_watchlist.
          ALERT if true.
  - question: Is any user account granting mailbox permissions at an anomalously high rate compared to their own history or their peers?
    context: Most non-administrative users rarely, if ever, change mailbox permissions. A sudden spike in this activity for a specific user, or activity that is unusual for their peer group, can indicate that their account has been compromised and is being used to set up persistence across multiple mailboxes. This is a behavioral approach to finding outliers.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CALCULATE baseline frequency of permission changes per user over 90 days.
          SEARCH for new permission changes.
          ALERT if user's rate > 95th percentile of their baseline or peer group baseline.
  - question: Can we identify high-risk mailbox permission changes by combining multiple factors into a machine learning model?
    context: A single indicator may not be enough to confirm malicious activity. By using a machine learning model, we can combine multiple weak signals (e.g., actor's role, time of day, IP reputation, watchlist status) into a single, high-confidence risk score. This allows for more nuanced detection than simple rule-based alerts and helps prioritize events for analysts.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR EACH permission change event, EXTRACT features (actor role, target role, time, IP reputation, watchlist_flag).
          SCORE with ML model.
          ALERT if score > high_risk_threshold.
  - question: Has 'FullAccess' permission been granted, or have permissions been granted to a newly created or service account?
    context: Granting 'FullAccess' is a powerful permission that adversaries seek for complete control. Additionally, granting permissions to very new accounts or service accounts is highly irregular. New accounts might have been created by the adversary for this purpose, and service accounts should typically not be granted delegated mailbox permissions.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH permission change logs.
          ALERT if permission='FullAccess' OR target_account_age < 30d OR target_account_type='Service'.
  - question: Is any administrator granting permissions with an unusually low level of variety, such as repeatedly granting only 'FullAccess'?
    context: Legitimate administrative activity often involves granting a variety of permissions. Automated or scripted attacks may repeatedly grant the same high-privilege permission (like 'FullAccess') across many accounts. A sharp decrease in the entropy (variety) of permissions granted by an admin can signal this type of automated, and likely malicious, behavior.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CALCULATE 30-day baseline of permission type entropy per admin.
          MONITOR new permission grants.
          ALERT if admin's entropy drops > 2 standard deviations below their baseline.
  - question: Is there a cluster of permission changes that deviates from the organization's normal daily or weekly patterns?
    context: Organizations often have a predictable rhythm of administrative activities. A sudden burst of permission changes, especially powerful ones like 'FullAccess', happening at an odd time or in quick succession, can indicate a coordinated attack rather than routine administration. Time-series anomaly detection can automatically learn the normal pattern and flag significant deviations.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MODEL normal volume and type of permission changes using a time-series model (e.g., ARIMA).
          FEED live permission change events into the model.
          ALERT if a cluster of events significantly deviates from the forecast.
  - question: After a new delegate was granted permission, did they log in from an IP address or with a User-Agent never before seen by the original mailbox owner?
    context: Adversaries, upon gaining delegate access, will log in to the mailbox from their own infrastructure. This login will likely originate from an IP or involve a User-Agent that is not associated with the legitimate, original owner's historical activity. Correlating the delegation event with a subsequent anomalous login is a strong indicator of account misuse.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4624
      - Zeek conn.log
      - Microsoft 365 Unified Audit Log
      - Azure AD Sign-in Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - VPN Concentrators
      - Network Firewalls/Gateways
      - Endpoint devices
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          ON permission change, get original_owner's 90-day baseline of IPs and User-Agents.
          MONITOR for login by new_delegate within 60 minutes.
          ALERT if delegate's source IP or User-Agent is NOT IN baseline.
  - question: Following a delegation event, did the new delegate's first login exhibit rare characteristics compared to the original owner's typical access patterns?
    context: This question moves beyond a simple "seen/unseen" check to a statistical rarity score. A delegate logging in from a country the original user has never accessed from is more suspicious than one logging in from a new IP in the same city. By profiling the original user's access and scoring the delegate's access for rarity (location, ASN, device), we can better identify high-risk logins.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4624
      - Zeek conn.log
      - Microsoft 365 Unified Audit Log
      - Azure AD Sign-in Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - VPN Concentrators
      - Network Firewalls/Gateways
      - Endpoint devices
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MAINTAIN access profiles (location, ASN, device) for each user.
          ON new delegate access, SCORE the rarity of the delegate's access features against the original owner's profile.
          ALERT if combined rarity score > 95th percentile.
  - question: After a new delegate was added, did a subsequent login to the mailbox fall outside the established "normal" behavior clusters for that mailbox?
    context: Using unsupervised machine learning, we can group all historical access events for a mailbox into clusters representing "normal" behavior (e.g., 'office access', 'mobile access', 'home access'). When a new delegate accesses the mailbox, their activity can be checked against these clusters. If it doesn't fit any normal cluster, it is an anomaly and could signify malicious access.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4624
      - Zeek conn.log
      - Microsoft 365 Unified Audit Log
      - Azure AD Sign-in Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - VPN Concentrators
      - Network Firewalls/Gateways
      - Endpoint devices
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CLUSTER historical mailbox access events (by IP geo, user agent, time) into 'normal' groups.
          ON new delegate access, check if the event fits an existing cluster.
          ALERT if the access is an outlier and does not fit any 'normal' cluster.
  - question: Following a delegation event, did the mailbox begin sending a high volume of internal emails to new recipients?
    context: Once an adversary controls a mailbox, they may use it for internal phishing or data exfiltration by emailing other employees. This analytic looks for a specific pattern: a high volume of emails sent to colleagues who have not been in recent contact with the original mailbox owner. This is a strong sign of the mailbox being used for lateral movement or reconnaissance.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Email Gateway
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Network Egress Points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          AFTER delegation, monitor outbound email from the mailbox.
          ALERT if > 100 internal emails are sent in 1 hour to recipients not seen in the last 90 days by the original owner.
  - question: After a mailbox was delegated, did its outbound email patterns (volume or recipients) change significantly from its historical baseline?
    context: Every user has a typical email sending pattern. An adversary taking over an account will likely have a different pattern. This analytic establishes a baseline for each mailbox's outbound email volume and the diversity of recipient domains. A significant deviation from this baseline after a delegation event suggests a different entity is now controlling the account.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Email Gateway
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Network Egress Points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MAINTAIN 30-day rolling baseline of outbound email volume and recipient domains per mailbox.
          AFTER delegation, ALERT if volume > 3 std dev from mean OR if Jaccard similarity of new domains vs baseline < 0.2.
  - question: Following a delegation event, does the actual outbound email activity from the mailbox deviate significantly from what a time-series model would predict?
    context: This is a more sophisticated version of baseline analysis. By using a forecasting model like Prophet, we can predict the expected email volume and flow for a mailbox, accounting for seasonality (time of day, day of week). If the actual activity after delegation consistently and significantly deviates from the model's forecast, it provides a strong, statistically-backed signal of anomalous behavior.
    answer_sources:
      - Zeek smtp.log
      - Zeek conn.log
      - Microsoft 365 Message Trace Logs
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Email Gateway
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Network Egress Points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          USE time-series model to forecast expected email volume/flow for a mailbox.
          AFTER delegation, compare actual activity to the forecast.
          ALERT if residual error (actual vs. predicted) shows significant and sustained deviation.
  - question: Has a user from a 'Suspicious Accounts' watchlist granted permissions on a mailbox belonging to a member of a 'High-Value Target' group?
    context: This is a high-severity event that directly combines two critical risk factors: a known suspicious actor and a high-value target. An adversary who has compromised a standard user account may use it to grant themselves access to a privileged or executive account to escalate their privileges. This specific intersection of factors should be treated as a priority alert.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          ON permission change, CHECK if target_user in 'High-Value Target' group AND actor_user in 'Suspicious Accounts' watchlist.
          TRIGGER high-severity alert if both are true.
  - question: Has a mailbox permission change event occurred with a risk score indicating a suspicious actor is targeting a privileged account?
    context: This question uses a weighted scoring model to quantify the risk of a permission change. It assigns higher weights to more suspicious attributes, such as an actor being on a watchlist or the permission being 'FullAccess'. By alerting on events that surpass a risk threshold, analysts can focus on the most critical changes instead of investigating every single event.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR EACH permission change, CALCULATE RiskScore based on weighted factors (target privilege, actor watchlist status, permission type).
          ALERT if RiskScore > 99th percentile of historical scores.
  - question: Has a new, improbable permission been created in the identity graph between a low-privilege user and a high-privilege user?
    context: Visualizing identities and permissions as a graph allows for powerful analysis. A low-privilege user (a node with few connections) suddenly gaining permission on a high-privilege, central user node (like a CEO or Domain Admin) creates an edge that is highly improbable under normal circumstances. Graph-based anomaly detection can automatically flag such structural changes as likely privilege escalation.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Identity and Access Management (IAM) systems
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MODEL users and permissions as a graph.
          DETECT creation of new 'has-permission-on' edge from a low-centrality node to a high-centrality node.
          ALERT on detection of improbable new edges.
  - question: Has a user granted themselves permissions on another user's mailbox, especially a privileged user's mailbox?
    context: A common attack pattern is for a user who has compromised one account (the 'actor') to grant permissions to their own account (the 'delegate') on a different, more valuable mailbox (the 'target'). This analytic specifically looks for events where the actor and the new delegate are the same person, which is a highly suspicious action and a direct indicator of privilege escalation attempts.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH permission change logs.
          ALERT where actor_identity == delegate_identity AND actor_identity != target_owner_identity.
          INCREASE severity if target is in a privileged group.
  - question: Is a user granting permissions to themselves on other mailboxes at a rate that deviates from their historical baseline?
    context: While some administrative roles may occasionally grant permissions to themselves for legitimate reasons, this is rare for most users. This analytic establishes a baseline for this specific "self-granting" behavior. A sudden spike in this ratio for any user is a strong behavioral indicator that their account may be compromised and used for privilege escalation.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each user, CALCULATE baseline ratio of (self-grants on other mailboxes) / (total grants).
          ALERT if a user's self-grant ratio spikes > 3 standard deviations from their baseline.
  - question: Can we distinguish between legitimate and illegitimate "self-granting" of mailbox permissions using a machine learning classifier?
    context: Not all instances of an actor granting permissions to themselves are malicious. By training a classifier with features like IP address, time of day, and the roles of the actor and target, a model can learn the subtle patterns that differentiate legitimate administrative tasks from malicious privilege escalation attempts, reducing false positives.
    answer_sources:
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          TRAIN classifier on 'self-grant' events with features (IP, time, actor role, target role).
          CLASSIFY new self-grant events.
          ALERT if event is classified as 'illegitimate' with high confidence.
  - question: Has a mailbox permission change been executed by a non-administrative user, or by an administrator from an unauthorized location?
    context: This analytic enforces policy. First, it verifies that the user making the change is part of an authorized administrative group. Second, for legitimate admins, it verifies that the action is performed from an approved location (e.g., a corporate subnet or VPN). A violation of either condition is a significant security event, suggesting either a compromised non-admin account or a compromised admin account being used from an attacker's machine.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - Zeek conn.log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - SIEM/Log Management Platform
      - VPN Concentrators
      - Management Workstation Subnets
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MAINTAIN list of authorized admin groups and IP ranges.
          ON permission change, ALERT if actor is NOT in admin group.
          IF actor is admin, ALERT if source IP is NOT in authorized ranges.
  - question: Is an authorized administrator changing mailbox permissions outside of their normal working hours?
    context: Adversaries with compromised administrator credentials often act at times when the legitimate user is offline to avoid detection. By establishing a baseline of normal activity hours for each administrator, we can flag permission changes that occur at unusual times (e.g., 3 AM) as potential signs of account compromise.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - Zeek conn.log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - SIEM/Log Management Platform
      - VPN Concentrators
      - Management Workstation Subnets
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each admin, create a baseline histogram of activity by hour-of-day.
          ON permission change, ALERT if the event occurs in a time window within the lowest 10th percentile of their activity.
  - question: Can we detect anomalous administrative actions, like suspicious permission changes, using an Isolation Forest algorithm?
    context: An Isolation Forest is an efficient algorithm for anomaly detection, as it works by 'isolating' outliers. By training a model on a large dataset of normal administrative actions (including features like source IP, target user, etc.), it can quickly identify a malicious permission change because its unique combination of attributes will make it easier to isolate from the bulk of normal events.
    answer_sources:
      - Windows Event ID 4104
      - Windows Event ID 4688
      - Microsoft 365 Unified Audit Log
      - Active Directory Replication Logs
      - Zeek conn.log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - SIEM/Log Management Platform
      - VPN Concentrators
      - Management Workstation Subnets
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          TRAIN Isolation Forest model on features from legitimate permission changes.
          SCORE new events with the model.
          ALERT on events that are easily isolated (low score), as they are anomalous.
  - question: Is there a sequence of a new delegate on a high-value mailbox, followed by their login, and then subsequent suspicious lateral movement attempts from their IP?
    context: This analytic connects the dots of a multi-stage attack. It looks for a specific chain of events: 1) delegation on a key mailbox, 2) access by the new delegate, and 3) immediate follow-on attacks (like RDP attempts or authentication failures) from the same source IP. Detecting this full sequence provides extremely high-confidence evidence of an active adversary attempting to move laterally from a newly compromised mailbox.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Critical Application Servers
      - Network Core
      - Network Egress Points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          DETECT permission change on high-value mailbox.
          CORRELATE with delegate login within 24h.
          MONITOR delegate's IP for 1h after login.
          ALERT if IP generates auth failures (4625) or RDP/RPC connections to other critical servers.
  - question: After a delegate accesses a high-value mailbox, does their source IP address begin to exfiltrate an unusually large amount of data?
    context: Once an adversary has access to a valuable mailbox, their next step may be to exfiltrate data. This analytic monitors the network traffic originating from the delegate's IP address immediately after they access the mailbox. A sudden, massive spike in outbound data transfer, far exceeding the user's normal baseline, is a strong indicator of data exfiltration in progress.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Critical Application Servers
      - Network Core
      - Network Egress Points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          AFTER delegate accesses high-value mailbox, monitor bytes_out from their source IP.
          COMPARE to the user's 30-day historical baseline for hourly traffic.
          ALERT if traffic in any 1-hour window exceeds the 99th percentile of their baseline.
  - question: Has an anomalous sequence of user actions occurred, such as granting permission to a VIP, logging in as the delegate, and then attempting to access a domain controller?
    context: This analytic uses sequence analysis models (like a Hidden Markov Model) to understand the probability of entire chains of events. A normal sequence might be 'login -> read email'. An attack sequence like 'grant permission -> delegate login -> RDP attempt' would be recognized by the model as having a very low probability of being legitimate, thus flagging it as a sophisticated, multi-step attack chain.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek dce_rpc.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4104
      - Microsoft 365 Unified Audit Log
      - On-premises Exchange Servers
      - Microsoft 365 Tenancy
      - Domain Controllers
      - Critical Application Servers
      - Network Core
      - Network Egress Points
    range: Last 90 days
    queries:
      - technology: Pseudocode
        query: |
          TRAIN a sequence model (e.g., HMM) on normal user action sequences.
          FEED new event sequences into the model.
          ALERT if a sequence (e.g., 'grant -> delegate login -> RDP attempt') has a very low probability under the model.