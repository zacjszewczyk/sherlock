name: T1583.008: Malvertising
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: Helps answer the question What evidence indicates adversaries are leveraging malvertising infrastructure against our environment or users? This is achieved by searching for direct connections to known malvertising indicators, analyzing suspicious HTTP redirect chains, identifying low-prevalence files downloaded from ad referers, detecting non-browser processes spawned by browsers after visiting risky sites, and monitoring for sharp increases in DNS queries to newly registered domains originating from ad networks.
type: technique
related:
  - TA0042: Resource Development
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are any internal hosts communicating with known malvertising indicators (IPs, domains, URLs)?
    context: This question aims to identify direct connections from our network to infrastructure confirmed to be involved in malvertising campaigns. A match against a high-confidence threat intelligence feed is a strong indicator of potential compromise or exposure to a malicious advertisement.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Zeek http.log
      - User Workstations
      - Internet Gateway
      - Internal DNS Resolvers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: JOIN Zeek logs (conn, dns, http) with threat_intel_list WHERE indicator_type = 'malvertising'. ALERT on match.
  - question: For any matched malvertising indicator, is there an unusual number of unique internal hosts making contact within a short time frame?
    context: This question seeks to differentiate between isolated incidents and a potential widespread campaign. A sudden spike in the number of unique hosts contacting the same malicious indicator can signify a successful, large-scale malvertising attack and should be prioritized for investigation.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Zeek http.log
      - User Workstations
      - Internet Gateway
      - Internal DNS Resolvers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: For each malvertising IOC match, COUNT unique hosts per hour. ALERT if count > 95th_percentile_baseline.
  - question: Is the overall volume of connections to malvertising indicators per hour significantly higher than forecasted levels?
    context: This question uses time series forecasting to detect anomalies in the overall trend of malvertising activity. An observed volume that dramatically exceeds the predicted range suggests a new or escalating campaign that might not be caught by simple frequency analysis of a single indicator.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Zeek http.log
      - User Workstations
      - Internet Gateway
      - Internal DNS Resolvers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: FORECAST hourly malvertising IOC match volume. ALERT if actual_volume > 99%_confidence_interval_of_forecast.
  - question: Are there any sessions originating from ad networks that involve multiple redirects and land on a newly registered or low-reputation domain?
    context: This question looks for a classic malvertising pattern a chain of redirects designed to obscure the final malicious destination. By tracking sessions from ad networks and flagging those that end up on suspicious domains (newly registered or poorly reputed), we can proactively identify potential drive-by-download or phishing attempts.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Web Proxies
      - Internet Gateway
      - User Workstations
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: TRACK http sessions from ad_network_referers. ALERT if session has >= 3 redirects AND final_destination is on NRD_list OR has reputation < 20.
  - question: For a flagged redirect chain, does the final destination URL have an unusually complex or random-looking query string?
    context: This question adds a layer of statistical analysis to identified redirect chains. Malicious payloads and commands are often encoded or obfuscated within URL query strings, leading to high entropy (randomness). A high entropy score for the final URL in a redirect chain increases the likelihood that it is malicious.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Web Proxies
      - Internet Gateway
      - User Workstations
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: For flagged redirect chains, CALCULATE Shannon_entropy of final URL query string. INCREASE risk_score if entropy > 95th_percentile_baseline.
  - question: Can we use machine learning to predict whether an observed HTTP redirect chain is malicious?
    context: This question leverages a machine learning model to score the risk of any redirect chain, even those not meeting rigid symbolic rules. By training a classifier on features like redirect count, duration, domain age, and URL entropy, we can identify novel or complex malvertising patterns that might otherwise be missed.
    answer_sources:
      - Zeek http.log
      - Zeek dns.log
      - Web Proxies
      - Internet Gateway
      - User Workstations
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: For all redirect chains, PREDICT maliciousness using trained_classifier_model. ALERT if probability_score > 0.8.
  - question: Has any known malicious file been downloaded to an endpoint from a session that originated from an ad network?
    context: This question seeks to find the 'smoking gun' of a successful malvertising attack the delivery of a malicious payload. It correlates network download events from ad referers with endpoint file creation events and checks the file's hash against a list of known malware signatures.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Windows Event ID 11 (Sysmon)
      - User Workstations
      - Internet Gateway
      - Download Servers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: CORRELATE http_log (ad referer) with files_log and endpoint_logs (file create). ALERT if file_hash matches known_malicious_signature.
  - question: Has a rare or unique file with high entropy been downloaded from a session originating from an ad network?
    context: This question helps identify potentially unknown malware. Adversaries often use unique or packed payloads for each victim to evade signature-based detection. A file that is rare (low prevalence) within the enterprise and has high entropy (suggesting packing or encryption) is highly suspicious, especially when delivered via an ad network.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Windows Event ID 11 (Sysmon)
      - User Workstations
      - Internet Gateway
      - Download Servers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: For files downloaded from ad referers, CALCULATE enterprise-wide prevalence and Shannon_entropy. FLAG as suspicious if prevalence < 10 AND entropy > 7.0.
  - question: Is there an anomalous spike in the rate of executable file downloads where the referer is an ad network?
    context: This question monitors for large-scale payload distribution campaigns. A sudden, anomalous increase in the rate of executable downloads originating from ad networks across the enterprise strongly indicates a widespread malvertising attack is in progress.
    answer_sources:
      - Zeek http.log
      - Zeek files.log
      - Windows Event ID 4688
      - Windows Event ID 11 (Sysmon)
      - User Workstations
      - Internet Gateway
      - Download Servers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: MODEL hourly rate of executable downloads from ad referers. ALERT if observed_rate > 99th_percentile_of_baseline.
  - question: Has a browser process spawned a scripting engine or shell shortly after visiting a known malvertising site?
    context: This question looks for evidence of code execution following a visit to a malicious site, a common outcome of browser exploitation. Correlating the creation of a child process like 'powershell.exe' by a browser with recent network traffic to a malvertising IOC provides a high-confidence indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Zeek http.log
      - Zeek conn.log
      - User Workstations
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: ON browser_spawns_child_process event, QUERY network logs for host's traffic in prior 60s. ALERT if host connected to malvertising_IOC.
  - question: For any process spawned by a browser, does its command line appear unusually complex or random?
    context: This question attempts to identify malicious activity by analyzing the command-line arguments of processes spawned by browsers. Attackers often use obfuscated or encoded commands to hide their actions, which results in high-entropy command lines. Flagging statistically anomalous command lines can help detect this type of activity.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Zeek http.log
      - Zeek conn.log
      - User Workstations
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: For browser-spawned processes, CALCULATE command-line entropy. ALERT if entropy > 98th_percentile_of_baseline for that parent-child pair.
  - question: Can we use machine learning to predict if a process spawned by a browser is malicious?
    context: This question applies a machine learning model to score the risk of any process created by a browser. By analyzing a combination of features like the process names, command-line characteristics, and recent network activity, a classifier can identify malicious behavior that might not trigger simpler rules, thus improving detection of novel threats.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Zeek http.log
      - Zeek conn.log
      - User Workstations
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: For browser-spawned processes, PREDICT maliciousness using trained_classifier_model. ALERT if probability_score is high.
  - question: Are hosts querying for newly registered domains immediately after visiting known ad-serving platforms?
    context: This question aims to link traffic from ad networks directly to lookups for newly registered domains, which are frequently used in malicious campaigns. A close temporal correlation between visiting an ad platform and then resolving an NRD is a strong indicator of a malvertising redirect chain in action.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Web Proxies
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: CORRELATE DNS queries for NRDs with preceding (<= 5s) HTTP requests from the same IP where referer is an ad_platform. ALERT on match.
  - question: Is there a statistically significant increase in the number of unique hosts querying for newly registered domains?
    context: This question provides a broad, enterprise-wide view to detect large-scale malvertising campaigns. A sudden spike in the number of distinct hosts looking up NRDs, exceeding historical norms by a significant margin (e.g., three standard deviations), suggests a widespread event that requires immediate investigation.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Web Proxies
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: TRACK hourly count of unique IPs querying NRDs. ALERT if current_count > (historical_mean + 3 * std_dev) for that hour.
  - question: Can unsupervised machine learning detect anomalous patterns in DNS activity related to newly registered domains?
    context: This question uses an unsupervised model like Isolation Forest to find unusual periods of DNS activity without relying on predefined thresholds. By considering multiple features simultaneously (e.g., NRD count, ratio of NRDs, domain entropy), the model can identify subtle, complex anomalies that may indicate a sophisticated malvertising campaign.
    answer_sources:
      - Zeek dns.log
      - Zeek http.log
      - Zeek conn.log
      - Internal DNS Resolvers
      - Internet Gateway
      - Web Proxies
    range: last 90 days
    queries:
      - query_type: pseudocode
        query: ANALYZE 5-minute windows of DNS activity using an Isolation Forest model. FLAG anomalous windows for investigation.