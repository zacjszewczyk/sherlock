name: T1548.004: Elevated Execution with Prompt
id: a3b1c9d8-7e6f-4a5b-8c9d-1e2f3a4b5c6d
description: This playbook helps identify if an adversary has successfully escalated privileges on a macOS host using an execution prompt (T1548.004) and subsequently engaged in defense evasion or lateral movement. It focuses on detecting the initial privilege escalation via the 'security_authtrampoline' mechanism and subsequent malicious activities. This includes spotting suspicious parent processes, correlating with network traffic to known malicious infrastructure, identifying C2 communication patterns, tracking potential lateral movement to Windows systems, detecting data exfiltration, and observing defense evasion techniques such as clearing logs, disabling security tools, or creating persistence on compromised Windows machines.
type: technique
related:
  - TA0004: Privilege Escalation
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is the '/usr/libexec/security_authtrampoline' process being executed by an unusual or suspicious parent process?
    context: This question aims to identify malicious use of the AuthorizationExecuteWithPrivileges API, which is a common method for privilege escalation on macOS. The underlying mechanism is '/usr/libexec/security_authtrampoline'. A legitimate parent process is typically signed by Apple and located in a standard system directory. An adversary might use an unsigned, low-reputation, or misplaced process (e.g., in /tmp/ or a user directory) to trigger the elevation prompt, tricking the user into granting root privileges to malware.
    answer_sources:
      - macOS Process Execution Logs
      - macOS Unified Logs
      - macOS Endpoints (laptops, desktops, servers)
    range: last 90 days
    queries:
      - query: SEARCH macOS process logs WHERE process_path = '/usr/libexec/security_authtrampoline' | CHECK parent_process_signature, parent_process_reputation, parent_process_path | ALERT if parent is unsigned OR reputation is low OR path is in user-writable/temporary directory.
  - question: Is the parent process of a 'security_authtrampoline' execution statistically rare across the environment?
    context: This question focuses on identifying anomalous behavior by baselining normal parent processes for 'security_authtrampoline'. Adversaries often use custom or newly introduced tools to escalate privileges, which will appear as statistically rare compared to common system processes. Flagging parents with low historical prevalence helps surface novel or targeted attack tools that might otherwise be missed.
    answer_sources:
      - macOS Process Execution Logs
      - macOS Unified Logs
      - macOS Endpoints (laptops, desktops, servers)
    range: last 90 days
    queries:
      - query: SEARCH macOS process logs for 'security_authtrampoline' | GROUP BY parent_process_name, parent_process_hash | CALCULATE prevalence across all endpoints over 90 days | ALERT if prevalence is in bottom 5th percentile or is a new process.
  - question: Does the parent process of a 'security_authtrampoline' execution exhibit characteristics of known malicious software?
    context: This question applies machine learning to automate the detection of malicious privilege escalation attempts. By training a model on various features of the parent process (such as its signature status, path complexity, name, and behavior), we can move beyond simple rules and identify sophisticated threats that mimic benign behavior but have subtle malicious indicators. An alert from the classifier suggests a high probability of a malicious elevation attempt.
    answer_sources:
      - macOS Process Execution Logs
      - macOS Unified Logs
      - macOS Endpoints (laptops, desktops, servers)
    range: last 90 days
    queries:
      - query: FOR each 'security_authtrampoline' event | EXTRACT features from parent process (is_signed, path_entropy, etc.) | APPLY pre-trained decision tree model | ALERT if classification is 'malicious'.
  - question: Did a macOS host communicate with a known malicious domain or IP address shortly after a privilege escalation event?
    context: After escalating privileges, an adversary's implant will often 'call home' to a command and control (C2) server. This question seeks to detect that communication by correlating network logs with threat intelligence. A match provides a strong indication that the privilege escalation was successful and is now part of an active intrusion.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - macOS Process Execution Logs
      - Network Security Monitoring Sensors
    range: last 90 days
    queries:
      - query: SEARCH Zeek logs (conn, dns) for traffic from macOS hosts | JOIN with threat intelligence feed on destination_ip or destination_domain | ALERT on any match.
  - question: Did a macOS host query a domain name that appears to be algorithmically generated (DGA)?
    context: Adversaries use Domain Generation Algorithms (DGAs) to create a large number of random-looking domain names for C2, making them difficult to block. These domains often have high entropy (randomness). This question aims to detect DGA activity by calculating the entropy of DNS requests and flagging unusually random domains, which are a hallmark of malware C2 communications.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - macOS Process Execution Logs
      - Network Security Monitoring Sensors
    range: last 90 days
    queries:
      - query: SEARCH Zeek dns.log for queries from macOS hosts | CALCULATE Shannon entropy for each domain name | ALERT if entropy score exceeds 95th percentile of daily baseline.
  - question: Is a macOS host exhibiting an anomalous spike in outbound data transfer to a new or rare destination?
    context: A sudden, unusually large data transfer from a host, especially to a destination it has never communicated with before, can be an indicator of data exfiltration or a large malware payload download. This question uses time-series analysis to establish a baseline of normal network behavior for each host and alerts on significant deviations, which could signal a compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - macOS Process Execution Logs
      - Network Security Monitoring Sensors
    range: last 90 days
    queries:
      - query: FOR each macOS host | MODEL normal outbound data volume using time-series analysis (ARIMA) | ALERT if observed volume to a new/rare destination exceeds forecast by > 3 standard deviations.
  - question: Is network traffic from a macOS host matching the known signatures of C2 frameworks like Shlayer, Sliver, or Mythic?
    context: Many malware and C2 frameworks use hardcoded or specific artifacts in their network communications, such as unique User-Agent strings in HTTP headers or specific TLS client fingerprints (JA3/JA3S hashes). This question searches for these known bad signatures in network traffic, providing a high-confidence way to identify infections by specific malware families.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - Zeek x509.log
      - Network Taps providing traffic to Zeek sensors
    range: last 90 days
    queries:
      - query: SEARCH Zeek logs (http, ssl) for traffic from macOS hosts | MATCH against a list of known malicious User-Agents, URI patterns, and JA3/JA3S hashes | ALERT on match.
  - question: Is a macOS host initiating a TLS session with a rare or previously unseen JA3/JA3S fingerprint?
    context: A JA3/JA3S hash is a fingerprint of how a client or server communicates over TLS. Common applications (like Chrome, Firefox, Safari) have well-known, prevalent fingerprints. Malware often uses custom TLS libraries, resulting in rare or unique JA3/JA3S hashes. This question identifies these outliers, which are strong indicators of non-standard, potentially malicious software running on the host.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - Zeek x509.log
      - Network Taps providing traffic to Zeek sensors
    range: last 90 days
    queries:
      - query: SEARCH Zeek ssl.log for all JA3/JA3S hashes | CALCULATE enterprise-wide prevalence | ALERT if a hash from a macOS host is rare (e.g., < 1% prevalence) or new.
  - question: Does a TLS session from a macOS host have characteristics that a machine learning model identifies as likely malicious C2 traffic?
    context: This question leverages machine learning to detect malicious TLS traffic that may not match a known signature. By training a model on features like certificate details, SNI, and cipher suites, it can learn the subtle patterns that differentiate legitimate traffic from encrypted C2 channels. A high score from the model indicates a connection is highly suspicious.
    answer_sources:
      - Zeek http.log
      - Zeek ssl.log
      - Zeek x509.log
      - Network Taps providing traffic to Zeek sensors
    range: last 90 days
    queries:
      - query: FOR each TLS session from a macOS host | EXTRACT features (cert validity, issuer, JA3S, etc.) | APPLY pre-trained logistic regression model | ALERT if malicious score is high.
  - question: Has a remote logon to a Windows server occurred from a macOS host for the first time?
    context: Adversaries often move laterally from a compromised macOS device to higher-value Windows servers. This question detects this lateral movement by looking for the first instance of a remote logon (like RDP or network share access) from a specific Mac to a specific Windows server. Such 'first-time' access is highly anomalous and a strong indicator of an attacker exploring the network.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Domain Controllers
    range: last 90 days
    queries:
      - query: SEARCH Windows Event 4624 (Logon Type 3 or 10) | CHECK if Source IP is a macOS device | LOOKUP historical logon pairs (macOS device -> Windows server) | ALERT if the pair is new.
  - question: Did a user who normally logs in from Windows machines suddenly initiate a remote logon from a macOS host?
    context: This question establishes a behavioral baseline for each user's remote access patterns. If a user, such as a Windows administrator, has only ever logged into servers from Windows workstations, a sudden logon from a macOS device is a significant and suspicious deviation from their normal behavior. This could indicate that their credentials have been stolen and are being used from a compromised Mac.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Domain Controllers
    range: last 90 days
    queries:
      - query: FOR each user | PROFILE historical source OS for remote logons | ON new logon, check source OS | ALERT if logon is from macOS and historical profile is exclusively Windows.
  - question: Did a remote logon from a macOS host cause a user's access patterns to become anomalous compared to their peers?
    context: This question uses graph analysis to understand communities of users with similar access behaviors (e.g., 'IT Admins', 'Finance Dept'). If a user's logon from a Mac to a Windows server makes them an outlier in their established peer group, it suggests their activity is abnormal. This is a sophisticated way to detect lateral movement that deviates not just from an individual's history, but from the expected behavior of their role.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Domain Controllers
    range: last 90 days
    queries:
      - query: BUILD a graph of users and servers | CLUSTER users based on access patterns | ON new logon from macOS to Windows, RE-EVALUATE user's cluster | ALERT if user moves to a new cluster or becomes an anomaly.
  - question: Is a macOS host exfiltrating a large archive file (zip, rar, 7z) to an external destination?
    context: Before exfiltrating large amounts of data, adversaries often compress it into a single archive file. This question looks for the transfer of large, common archive file types to external IP addresses. While not always malicious, it's a common data staging technique that warrants investigation, especially if the transfer is to an unknown or untrusted destination.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Network Egress Points
    range: last 90 days
    queries:
      - query: SEARCH Zeek files.log for transfers from macOS hosts to external IPs | FILTER for MIME types like zip, rar, 7z | ALERT if file size > 50MB.
  - question: Has the total daily outbound data volume from a macOS host significantly exceeded its normal baseline?
    context: This question aims to detect bulk data exfiltration by monitoring the total amount of data a host sends out each day. By establishing a dynamic baseline for each host's typical traffic volume, it can flag days where the data transfer is anomalously high. This method can catch exfiltration even if the data is not sent in a single large file.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Network Egress Points
    range: last 90 days
    queries:
      - query: FOR each macOS host | BASELINE daily outbound data volume over 30 days | ALERT if current daily volume > 99th percentile of baseline.
  - question: Is a macOS host exhibiting a spike in outbound data transfer that is anomalous for its typical hourly and daily patterns?
    context: This is a more sophisticated approach to detecting data exfiltration. A time-series model can learn the normal 'rhythm' of a host's network activity, including daily and weekly patterns (e.g., higher traffic during work hours, lower on weekends). It can then alert on spikes in data transfer that are abnormal for that specific time of day or day of the week, reducing false positives from legitimate high-traffic events.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Network Egress Points
    range: last 90 days
    queries:
      - query: FOR each macOS host | MODEL hourly outbound byte count using a seasonal time-series model | ALERT on spikes that are statistically significant anomalies given the time of day/week.
  - question: Is a compromised macOS host attempting to hide its C2 traffic by using anonymization services or dynamic DNS?
    context: After compromising a host, adversaries may try to obscure their command and control (C2) communications by routing them through VPNs, Tor, proxies, or dynamic DNS providers. This question checks DNS requests against lists of domains associated with these services. A match indicates a likely attempt to evade network-based detection.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Servers
    range: last 90 days
    queries:
      - query: SEARCH Zeek dns.log for queries from macOS hosts | MATCH against threat intel lists for Anonymization, Dynamic DNS, Hacking categories | ALERT on match.
  - question: Is a macOS host resolving a domain name that is rare or has never been seen before in the environment?
    context: Adversary C2 infrastructure is often unique to a specific campaign or target. As a result, the C2 domains they use will be rare or completely new to the enterprise. This question identifies these DNS outliers by calculating the prevalence of every domain queried. A query for a very rare domain is suspicious and could indicate a connection to a C2 server.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Servers
    range: last 90 days
    queries:
      - query: SEARCH all DNS logs | CALCULATE prevalence for each FQDN | ALERT if a macOS host queries a domain seen by < 5 hosts or never seen before.
  - question: Is a macOS host attempting to resolve a domain name that appears to be algorithmically generated by a DGA?
    context: This question uses a machine learning model specifically designed to recognize the patterns of Domain Generation Algorithms (DGAs). These algorithms produce pseudo-random domain names that malware uses for C2. By classifying domains in real-time, this approach can proactively identify DGA-based C2 channels, even for new or unknown malware families.
    answer_sources:
      - Zeek dns.log
      - Corporate DNS Servers
    range: last 90 days
    queries:
      - query: FOR each DNS query from a macOS host | APPLY DGA detection model to the domain name | ALERT if classification is 'DGA'.
  - question: After a remote logon from a macOS host, were commands executed on the Windows target to disable security tools or clear logs?
    context: A common post-exploitation step is to disable defenses and cover tracks. This question looks for this specific sequence: a remote logon from a Mac to a Windows machine, immediately followed by commands to clear event logs, modify the firewall, or stop security services. This chained behavior is a very strong signal of an active, hands-on-keyboard adversary.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1102
      - Windows Event ID 4719
      - Windows Event ID 4624
      - Critical Windows Servers
    range: last 90 days
    queries:
      - query: CORRELATE Windows Event 4624 (from macOS IP) with subsequent events (within 5 mins) like Event 4688 (with commands like 'wevtutil cl', 'netsh') or Event 1102 | ALERT on correlation.
  - question: Did a security policy change or log clearing event on a Windows server originate from a session initiated by a macOS host?
    context: In most corporate environments, administrative actions like changing audit policies or clearing security logs on a Windows server should not originate from a macOS machine. This question treats such an occurrence as a 'zero-frequency' or highly improbable event. Detecting this is a simple but powerful way to identify illegitimate administrative activity stemming from a compromised Mac.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1102
      - Windows Event ID 4719
      - Windows Event ID 4624
      - Critical Windows Servers
    range: last 90 days
    queries:
      - query: SEARCH for security policy changes (Event 4719) or log clearing (Event 1102) | TRACE the Logon ID back to the originating logon event (Event 4624) | ALERT if originating IP belongs to a macOS host.
  - question: Did a sequence of events on a Windows server, initiated from a macOS host, deviate from normal learned administrative behavior?
    context: This question uses sequence analysis to model the 'grammar' of normal administrative activity on a server. The model learns common sequences of events. An alert is triggered when a sequence occurs that is highly improbable according to the model, such as a logon from a macOS host followed by security tool tampering. This detects unusual combinations of actions that simple correlation rules might miss.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1102
      - Windows Event ID 4719
      - Windows Event ID 4624
      - Critical Windows Servers
    range: last 90 days
    queries:
      - query: MODEL normal event sequences on high-value servers using HMM | MONITOR new event sequences in real-time | ALERT if a sequence involving a logon from macOS followed by defense evasion is observed as a low-probability transition.
  - question: Is a macOS host initiating a suspicious TLS session, such as one using a self-signed certificate or a non-standard port?
    context: Adversaries often use custom TLS setups for C2 that deviate from standard web traffic. This question looks for a combination of red flags: using a port other than 443 for TLS, using a self-signed certificate (which is common for malware C2 but rare for legitimate public websites), or having a TLS fingerprint (JA3) that matches a known threat. A combination of these factors is a strong indicator of a malicious connection.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
    range: last 90 days
    queries:
      - query: SEARCH Zeek ssl.log for traffic from macOS hosts | ALERT if (destination_port != 443 AND certificate is self-signed) OR (JA3 hash is on a blocklist).
  - question: Does a TLS session from a macOS host have a high cumulative risk score based on multiple anomalous characteristics?
    context: Instead of alerting on a single indicator, this question combines multiple weak signals into a stronger one. It assigns risk points to various suspicious attributes of a TLS session (e.g., rare JA3, non-standard port, self-signed cert, short validity). A session that accumulates a high total score is far more likely to be malicious than a session with only one anomaly. This helps prioritize alerts and reduce false positives.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
    range: last 90 days
    queries:
      - query: FOR each TLS session from macOS | CALCULATE risk_score (rare_JA3=2, non-443_port=1, self-signed_cert=2, short_validity=1) | ALERT if total_score > 3.
  - question: Does a TLS session from a macOS host fall outside the boundary of 'normal' traffic as defined by a machine learning model?
    context: This question uses one-class classification, a type of anomaly detection where a model is trained only on 'normal' data. The model learns the characteristics of legitimate TLS traffic in the environment and creates a boundary around it. Any new connection that falls outside this boundary is flagged as an anomaly, making this an effective method for detecting novel or unknown C2 techniques.
    answer_sources:
      - Zeek conn.log
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
    range: last 90 days
    queries:
      - query: TRAIN a one-class SVM on features of legitimate TLS traffic | FOR each new TLS session from a macOS host | APPLY the model | ALERT if the session is classified as an outlier.
  - question: Was a new service or scheduled task created on a Windows server by a user who recently logged in remotely from a macOS host?
    context: Creating a new service or scheduled task is a classic persistence technique. This question aims to detect an adversary establishing a foothold on a Windows server after gaining access from a compromised Mac. By correlating the persistence event (service/task creation) with the originating logon session, it directly links the suspicious activity back to the initial lateral movement.
    answer_sources:
      - Windows Event ID 7045
      - Windows Event ID 4698
      - Windows Event ID 4624
      - Windows Servers
    range: last 90 days
    queries:
      - query: SEARCH for service creation (Event 7045) or scheduled task creation (Event 4698) | TRACE Logon ID back to originating logon (Event 4624) | ALERT if logon was remote and source IP is a macOS device.
  - question: Has persistence been established on a Windows server from a session originating from a macOS host, which is a statistically rare event?
    context: This question applies frequency analysis to detect persistence. Legitimate service or task creation on a Windows server is typically performed by administrators from other Windows machines or automated systems. An instance where the originating session traces back to a macOS host is almost always anomalous. Flagging this 'zero-frequency' event provides a high-confidence alert for malicious persistence.
    answer_sources:
      - Windows Event ID 7045
      - Windows Event ID 4698
      - Windows Event ID 4624
      - Windows Servers
    range: last 90 days
    queries:
      - query: FOR each persistence event (service/task creation) | IDENTIFY source OS of the session | ALERT if source OS is macOS, as this is a zero-frequency event.
  - question: Does a graph model of host interactions show an anomalous structural pattern, such as a macOS host creating persistence on a Windows server?
    context: This question models the entire environment as a graph, where hosts are nodes and interactions (like logons or service creation) are edges. In this graph, an edge representing 'create service' connecting a 'macOS' node to a 'Windows Server' node is a structurally rare and suspicious pattern. This graph-based approach can surface complex, multi-hop attack paths that might otherwise be missed.
    answer_sources:
      - Windows Event ID 7045
      - Windows Event ID 4698
      - Windows Event ID 4624
      - Windows Servers
    range: last 90 days
    queries:
      - query: BUILD a graph of hosts and actions | DEFINE an anomalous edge as 'service creation' from a macOS node to a Windows Server node | ALERT when this anomalous edge pattern is detected.