name: "T1039: Data from Network Shared Drive"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook is designed to detect adversarial activity related to the collection of data from network shared drives (MITRE ATT&CK T1039). It helps answer the primary investigative question: 'Has the adversary collected data from network shared drives?'. The playbook focuses on identifying several key indicators: the execution of known malicious data collection tools; the use of suspicious command-line combinations (e.g., robocopy with UNC paths); anomalous volumes of data or files being read from shares; unusual access patterns, such as a user accessing shares outside their normal role; and 'fan-in' data staging, where data from multiple shares is consolidated onto a single host before exfiltration."
type: "technique"
related: 
  - "TA0009: Collection"
contributors:
  - "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are there any process executions that match known malicious file hashes or process names associated with data collection tools?"
    context: "This question aims to identify the use of known malicious tools for data collection. Adversaries often use publicly available or custom tools for enumerating and stealing data. Matching process names or file hashes against a threat intelligence feed provides a high-fidelity signal that a known malicious tool is running in the environment."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1"
      - "All enterprise endpoints and servers, Domain Controllers, File Servers"
    range: "last 90 days"
    queries:
      - "SEARCH process_creation_logs WHERE (process_hash IN (watchlist_hashes) OR process_name IN (watchlist_names))"
  - question: "Have any historically rare command-line executions been observed on a host, immediately followed by access to a network share from that same host?"
    context: "This question seeks to uncover novel or unusual command-line activity that is correlated with data collection. Adversaries may use legitimate tools in unusual ways to avoid detection. By identifying commands that are statistically rare for a specific user and host and linking them temporally to network share access, we can flag suspicious staging or collection behavior that doesn't rely on known bad signatures."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1"
      - "Windows Event ID 5145"
      - "All enterprise endpoints and servers, Domain Controllers, File Servers"
    range: "last 90 days"
    queries:
      - "FIND rare_command_lines (frequency < 1%) AND CORRELATE with network_share_access FROM same_host WITHIN 5_minutes"
  - question: "Has a machine learning model identified any process creation events as likely malicious, which are also temporally correlated with network share access?"
    context: "This question leverages machine learning to detect suspicious process behavior that might indicate data collection. By training a model on features like process lineage, command-line structure, and user context, it can learn to identify subtle characteristics of malicious activity. Correlating a high-probability malicious process with subsequent network share access strengthens the signal and points to potential data staging or collection."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 1"
      - "Windows Event ID 5145"
      - "All enterprise endpoints and servers, Domain Controllers, File Servers"
    range: "last 90 days"
    queries:
      - "FIND process_creation_events WHERE (ml_model_score > threshold) AND CORRELATE with network_share_access FROM same_host"
  - question: "Have any command-lines or PowerShell scripts been executed that combine file copy/enumeration commands with UNC paths to network shares?"
    context: "This question looks for direct evidence of an adversary using built-in command-line tools to access and copy data from network shares. Commands like xcopy, robocopy, and Copy-Item paired with a UNC path (\\\\server\\share) are a common and straightforward method for data collection. Detecting this pattern directly is a strong indicator of malicious activity."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "All enterprise endpoints and servers, File servers hosting network shares"
    range: "last 90 days"
    queries:
      - "SEARCH command_line_logs, powershell_script_logs WHERE (command MATCHES regex('copy|dir|xcopy|robocopy') AND command MATCHES regex('\\\\...\\...'))"
  - question: "Have any commands using common file transfer utilities exhibited unusually high complexity or randomness, especially when a UNC path is involved?"
    context: "This question aims to detect obfuscated commands. Adversaries may attempt to hide their actions by encoding or randomizing parts of a command line. High Shannon entropy can indicate this type of obfuscation. By baselining the normal complexity for utilities like xcopy or robocopy and flagging outliers, we can potentially uncover malicious commands that would otherwise appear legitimate."
    answer_sources:
      - "Windows Event ID 4688"
      - "Windows Event ID 4104"
      - "All enterprise endpoints and servers, File servers hosting network shares"
    range: "last 90 days"
    queries:
      - "CALCULATE entropy for command_lines with file_transfer_utilities. ALERT if entropy > baseline_98th_percentile AND command_line CONTAINS UNC_path"
  - question: "Has a Natural Language Processing (NLP) model identified any PowerShell scripts with a high probability of having data collection or staging intent?"
    context: "This question uses advanced NLP to understand the *intent* of a PowerShell script, rather than just matching keywords. Adversaries can write complex scripts to perform collection. A fine-tuned transformer model can analyze the code's structure, commands, and logic to classify its purpose, flagging scripts that are likely designed for data collection, even if they use novel techniques."
    answer_sources:
      - "Windows Event ID 4104"
      - "All enterprise endpoints and servers, File servers hosting network shares"
    range: "last 90 days"
    queries:
      - "FEED powershell_script_blocks to NLP_model. ALERT if classification_probability for 'data_collection' > threshold AND script CONTAINS UNC_path"
  - question: "Has any single host read an unusually large number of files or volume of data from network shares within a short time frame?"
    context: "This question is designed to catch 'smash and grab' data collection attempts using hard thresholds. An adversary attempting to exfiltrate a large amount of data quickly will likely trigger these volumetric limits. While simple, this rule is effective at detecting bulk data transfers that are far outside the norm for typical user activity."
    answer_sources:
      - "Windows Event ID 5145"
      - "Zeek smb.log"
      - "Zeek files.log"
      - "File servers hosting network shares, Network backbone switches (for traffic monitoring), Domain Controllers"
    range: "last 90 days"
    queries:
      - "AGGREGATE share_access_logs by host over 1_hour_window. ALERT if unique_file_count > 5000 OR data_transferred > 2GB"
  - question: "Has any user-host pair exhibited a statistically significant deviation from its normal baseline of data volume or file count accessed from network shares?"
    context: "This question uses statistical baselining to detect anomalous behavior tailored to each user and host. Unlike a hard threshold, this approach adapts to different user roles. A Z-score greater than 3.0 indicates that the current activity is more than three standard deviations away from the historical average, which is a strong statistical indicator of an anomaly that could represent data collection."
    answer_sources:
      - "Windows Event ID 5145"
      - "Zeek smb.log"
      - "Zeek files.log"
      - "File servers hosting network shares, Network backbone switches (for traffic monitoring), Domain Controllers"
    range: "last 90 days"
    queries:
      - "FOR each user-host, CALCULATE rolling_baseline (30 days) of share_access_metrics. ALERT if current_zscore > 3.0"
  - question: "Have any high-value network shares experienced data access volumes that deviate significantly from their normal, time-series predicted patterns?"
    context: "This question focuses on protecting critical assets by modeling their specific access patterns over time. A time-series model can learn the normal 'rhythm' of a share, including daily and weekly cycles (e.g., backup windows). An alert is triggered when current activity breaks this learned pattern, which is a powerful way to detect unexpected access to sensitive data, such as an adversary accessing source code repositories in the middle of the workday."
    answer_sources:
      - "Windows Event ID 5145"
      - "Zeek smb.log"
      - "Zeek files.log"
      - "File servers hosting network shares, Network backbone switches (for traffic monitoring), Domain Controllers"
    range: "last 90 days"
    queries:
      - "FOR each high-value_share, FEED access_volume to time_series_model. ALERT if observed_volume DEVIATES from predicted_range"
  - question: "Has any user account accessed a network share they are not authorized to access based on their role or group membership?"
    context: "This question seeks to identify clear policy violations that may indicate a compromised account is being used for reconnaissance or collection. By comparing actual access events against an authoritative map of user group permissions and data classifications, we can generate high-fidelity alerts when a user from one department (e.g., Marketing) accesses a sensitive share belonging to another (e.g., Engineering), which is a strong sign of lateral movement and collection."
    answer_sources:
      - "Windows Event ID 5145"
      - "Zeek smb.log"
      - "File servers hosting network shares, Active Directory servers, Data classification repositories"
    range: "last 90 days"
    queries:
      - "JOIN share_access_events with user_group_permissions. ALERT if user_group NOT IN authorized_groups for accessed_share"
  - question: "Has any user accessed an unusually high number of different network shares or an abnormally diverse set of file types compared to their historical behavior?"
    context: "This question looks for two types of exploratory behavior. Accessing an abnormally high number of unique shares suggests an adversary is 'island hopping' to see what data is available. A sudden increase in the variety of file extensions accessed (e.g., a user who normally only touches .docx files suddenly accessing .dll, .config, and .bak files) suggests they are collecting different kinds of data, possibly looking for code, configurations, or credentials."
    answer_sources:
      - "Windows Event ID 5145"
      - "Zeek smb.log"
      - "File servers hosting network shares, Active Directory servers, Data classification repositories"
    range: "last 90 days"
    queries:
      - "FOR each user, CALCULATE daily_unique_share_count AND daily_file_extension_entropy. ALERT if count > baseline_99th_percentile OR entropy_change is anomalous"
  - question: "Has any user started accessing network shares that belong to a completely different user community or functional group?"
    context: "This question uses graph analysis to model and detect deviations in access behavior. In most organizations, users access shares in clusters related to their job function (e.g., Finance users access finance shares). By identifying these 'communities' algorithmically, we can detect when a user (a node in the graph) begins accessing shares far outside their normal community, which is a strong indicator of a compromised account being used for internal reconnaissance and collection."
    answer_sources:
      - "Windows Event ID 5145"
      - "Zeek smb.log"
      - "File servers hosting network shares, Active Directory servers, Data classification repositories"
    range: "last 90 days"
    queries:
      - "MODEL user-share_access as a graph. DETECT communities. ALERT if user creates new connections to shares outside their primary_community"
  - question: "Has any host been observed reading data from multiple different network shares and then writing a large number of files to a single local folder in a short period?"
    context: "This question looks for a classic 'fan-in' data staging pattern. Adversaries often collect data from various network locations and consolidate it on a single compromised host before compression and exfiltration. This rule explicitly searches for that sequence: reading from multiple shares, followed by writing many files locally. Detecting this pattern is a very strong indicator of active data collection and staging."
    answer_sources:
      - "Windows Event ID 5145"
      - "Windows Event ID 11"
      - "Zeek smb.log"
      - "All enterprise endpoints and servers, File servers hosting network shares"
    range: "last 90 days"
    queries:
      - "CORRELATE events by host within 30_minutes: (READ from share_A, READ from share_B, READ from share_C) FOLLOWED BY (many WRITE events to local_folder_X)"
  - question: "Has the ratio of data read from the network to data written to the local disk on any host spiked significantly beyond its normal baseline?"
    context: "This question seeks to identify data staging by monitoring the flow of data on an endpoint. During a data collection phase, a compromised host will exhibit an unusual pattern where it reads a large amount of data from the network (the shares) and writes a corresponding amount of data to its local disk (the staging directory). A sudden, sharp increase in this network-read-to-local-write ratio is a strong signal of this staging activity."
    answer_sources:
      - "Windows Event ID 5145"
      - "Windows Event ID 11"
      - "Zeek smb.log"
      - "All enterprise endpoints and servers, File servers hosting network shares"
    range: "last 90 days"
    queries:
      - "FOR each host, CALCULATE ratio of network_read_bytes / local_disk_write_bytes over 5_min_window. ALERT if ratio_z_score > 3"
  - question: "Has a sequence analysis model detected a series of events on a host that strongly matches the known pattern of malicious data staging?"
    context: "This question uses a sophisticated machine learning model to detect the specific *sequence* of actions an adversary takes to stage data. An RNN or HMM can be trained to recognize the chronological chain of events (e.g., list share contents, read a file, list another share, read another file, create a local folder, write a file). This is a powerful technique because it focuses on the adversary's TTP as a whole, making it more resilient to minor variations in tools or commands."
    answer_sources:
      - "Windows Event ID 5145"
      - "Windows Event ID 11"
      - "Zeek smb.log"
      - "All enterprise endpoints and servers, File servers hosting network shares"
    range: "last 90 days"
    queries:
      - "FEED real-time event_sequences to RNN_model. ALERT if sequence_probability matches 'malicious_staging_pattern' > threshold"