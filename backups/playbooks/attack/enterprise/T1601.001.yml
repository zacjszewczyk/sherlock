name: T1601.001: Patch System Image
id: 7f5b8e9a-3b1c-4d8e-8f9a-1b2c3d4e5f6a
description: This playbook focuses on detecting if an adversary has modified network device operating system images or memory to evade defenses. This involves identifying unauthorized changes to firmware by checking for known-bad signatures and hashes, comparing running images against vendor-provided golden hashes, detecting anomalous file transfers (based on size, protocol, source, or timing), identifying suspicious sequences of CLI commands (like file copies followed by boot changes), monitoring for the use of high-privilege memory-modifying commands, and flagging unauthorized changes to a device's boot configuration.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are any network device OS images matching known-bad hashes or YARA signatures for firmware malware?
    context: This proactive check aims to identify known malicious firmware implants, such as SYNful Knock, that adversaries may use to compromise network infrastructure. By periodically retrieving and analyzing OS images against threat intelligence and specialized YARA rules, security teams can detect compromised devices with high confidence.
    answer_sources:
      - Network device OS image files
      - Threat Intelligence Hash Feeds
      - Firmware Malware YARA Rules
      - Zeek files.log
      - Zeek tftp.log
      - Configuration management servers
      - Core network switches and routers
      - Perimeter firewalls
      - TFTP/FTP servers
      - Centralized file analysis sandbox
    range: last 90 days
    queries:
      - query: FOR each retrieved device_image: CALCULATE sha256_hash. SEARCH threat_intel_feed FOR sha256_hash. SCAN device_image WITH yara_rules. ALERT on match.
  - question: Have there been any anomalous firmware file transfers based on file size or source IP address?
    context: Adversaries may transfer modified firmware images that are unusually large (due to added malicious code) or from unauthorized sources. This question helps detect such suspicious transfers by baselining normal firmware file sizes and transfer sources, then alerting on significant deviations, which could indicate an attempted device compromise.
    answer_sources:
      - Network device OS image files
      - Threat Intelligence Hash Feeds
      - Firmware Malware YARA Rules
      - Zeek files.log
      - Zeek tftp.log
      - Configuration management servers
      - Core network switches and routers
      - Perimeter firewalls
      - TFTP/FTP servers
      - Centralized file analysis sandbox
    range: last 90 days
    queries:
      - query: SEARCH Zeek files.log FOR mime_type='application/octet-stream' OR filename ENDS WITH '.bin' OR '.img'. BASELINE file sizes and source IPs per device_type. ALERT if file_size > 99th_percentile OR source_ip is new for firmware transfers.
  - question: Has an unusual spike in firmware image transfer activity occurred outside of expected maintenance windows?
    context: Legitimate firmware updates typically happen during scheduled maintenance windows. An adversary attempting to deploy malicious firmware across multiple devices might cause a sudden, unexpected increase in transfer activity. This question uses a time-series model to learn normal patterns and detect statistically significant anomalies that could represent a coordinated attack.
    answer_sources:
      - Network device OS image files
      - Threat Intelligence Hash Feeds
      - Firmware Malware YARA Rules
      - Zeek files.log
      - Zeek tftp.log
      - Configuration management servers
      - Core network switches and routers
      - Perimeter firewalls
      - TFTP/FTP servers
      - Centralized file analysis sandbox
    range: last 90 days
    queries:
      - query: MODEL hourly count of firmware transfers FROM Zeek files.log using time-series analysis (SARIMA). ALERT if current activity is a statistical anomaly outside of learned seasonal patterns (maintenance windows).
  - question: Does the hash of any running network device OS image fail to match its corresponding vendor-provided 'golden hash'?
    context: This question aims to detect unauthorized modifications to firmware by comparing the hash of a device's running image against a trusted repository of vendor-approved hashes. A mismatch is a strong indicator that the image has been tampered with, either maliciously or through an unapproved change, and requires immediate investigation.
    answer_sources:
      - Network device OS image files
      - Vendor Firmware Hash Repository
      - Cisco Syslog Message ID %PLATFORM-1-IMAGE_INTEGRITY_FAIL
      - TACACS+ command accounting logs
      - Configuration Management Database (CMDB)
      - Golden Image Repository server
      - Critical network infrastructure (core routers, edge firewalls)
      - Automated configuration management platforms
    range: last 90 days
    queries:
      - query: FOR each critical device: RETRIEVE running_image. CALCULATE current_hash. LOOKUP golden_hash in repository for device_model and version. ALERT if current_hash != golden_hash.
  - question: Have any image integrity failure alerts been generated, or has there been anomalous 'show version' command usage?
    context: Certain network devices can self-detect image integrity issues and generate specific high-severity syslog alerts. Since these are extremely rare, any occurrence is critical. Additionally, an adversary might repeatedly check a device's version after a compromise, so baselining and alerting on unusual 'show version' command frequency can be a secondary indicator.
    answer_sources:
      - Network device OS image files
      - Vendor Firmware Hash Repository
      - Cisco Syslog Message ID %PLATFORM-1-IMAGE_INTEGRITY_FAIL
      - TACACS+ command accounting logs
      - Configuration Management Database (CMDB)
      - Golden Image Repository server
      - Critical network infrastructure (core routers, edge firewalls)
      - Automated configuration management platforms
    range: last 90 days
    queries:
      - query: ALERT on syslog message_id '%PLATFORM-1-IMAGE_INTEGRITY_FAIL'. Separately, BASELINE 'show version' command frequency per user/device from TACACS+ logs. ALERT if frequency > 3 standard deviations above baseline.
  - question: Has a machine learning model flagged a configuration change as high-risk for unauthorized image modification?
    context: This question uses a predictive model to proactively assess the risk of a configuration change event. By analyzing features like the user's role, time of day, and proximity to firmware transfers, the model can identify changes that warrant an immediate, on-demand hash verification, allowing for faster detection of a potential compromise.
    answer_sources:
      - Network device OS image files
      - Vendor Firmware Hash Repository
      - Cisco Syslog Message ID %PLATFORM-1-IMAGE_INTEGRITY_FAIL
      - TACACS+ command accounting logs
      - Configuration Management Database (CMDB)
      - Golden Image Repository server
      - Critical network infrastructure (core routers, edge firewalls)
      - Automated configuration management platforms
    range: last 90 days
    queries:
      - query: ON configuration_change event: GATHER features (user, time, boot_var_change, recent_file_transfer). PREDICT risk_level with classification model. IF risk_level is 'high', TRIGGER on-demand hash verification.
  - question: Has a known attack sequence for firmware modification been observed in network device audit logs?
    context: Adversaries often follow a predictable pattern when modifying firmware, such as copying a new image, changing the boot variable to use it, and then clearing logs to hide their tracks. This question seeks to identify this specific sequence of commands occurring in a short timeframe, providing a high-confidence alert for a likely compromise in progress.
    answer_sources:
      - Network device syslog
      - TACACS+ command accounting logs
      - RADIUS accounting logs
      - Zeek conn.log
      - Centralized syslog server
      - Authentication, Authorization, and Accounting (AAA) servers
      - Network management jump hosts
      - SIEM platform
    range: last 90 days
    queries:
      - query: CORRELATE logs for a single user executing 'copy tftp:', 'boot system flash', and 'clear logging' within a 15-minute window. ALERT on sequence detection.
  - question: Has any administrative user session on a network device shown unusually high or low command entropy?
    context: This question attempts to identify compromised administrative accounts by analyzing the complexity and randomness of their command usage. An unusually high entropy might indicate an interactive attacker exploring the system, while unusually low entropy could suggest repetitive, scripted malicious activity. Both deviate from a user's normal behavior.
    answer_sources:
      - Network device syslog
      - TACACS+ command accounting logs
      - RADIUS accounting logs
      - Zeek conn.log
      - Centralized syslog server
      - Authentication, Authorization, and Accounting (AAA) servers
      - Network management jump hosts
      - SIEM platform
    range: last 90 days
    queries:
      - query: FOR each admin session: CALCULATE Shannon entropy of commands based on user's historical command frequency. ALERT if session entropy is in top 2% or bottom 2% for that user.
  - question: Has a sequence-based anomaly detection model detected a command sequence that deviates from normal administrative behavior?
    context: This question uses a more advanced modeling technique (like a Hidden Markov Model) to learn the typical command-to-command transitions for administrative tasks. It can detect novel or improbable sequences of commands that do not fit learned patterns, indicating a potential attacker who is not behaving like a legitimate administrator.
    answer_sources:
      - Network device syslog
      - TACACS+ command accounting logs
      - RADIUS accounting logs
      - Zeek conn.log
      - Centralized syslog server
      - Authentication, Authorization, and Accounting (AAA) servers
      - Network management jump hosts
      - SIEM platform
    range: last 90 days
    queries:
      - query: TRAIN a Hidden Markov Model on command sequences from AAA logs. FOR each new command sequence, CALCULATE probability score. ALERT if probability is below a learned threshold.
  - question: Has a network device OS image been transferred using an insecure protocol or from an unauthorized IP address?
    context: Secure network management practices dictate that firmware updates should come from trusted servers using secure protocols. This question aims to detect violations of this policy, such as an image transfer using TFTP instead of SCP, or a transfer originating from an IP not on the management allow-list, which are strong indicators of unauthorized and potentially malicious activity.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network device syslog for file transfers
      - Windows Event ID 4688 with command line logging
      - Network Taps/SPAN ports feeding Zeek sensors
      - Management network segments
      - File transfer servers (TFTP, FTP, SCP)
      - Windows management workstations
    range: last 90 days
    queries:
      - query: MONITOR Zeek files.log for firmware files. ALERT if protocol is in ('tftp', 'ftp') OR if source_ip is NOT in 'authorized_management_ips' allow-list.
  - question: Has there been an anomalous volume of firmware transfers or a transfer involving a new source-destination pair?
    context: This question seeks to identify unusual transfer patterns. A sudden spike in the volume of firmware transfers outside of a maintenance window can indicate a widespread compromise attempt. Similarly, a firmware file being transferred between a pair of devices (source and destination) that have never communicated in this way before is highly suspicious.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network device syslog for file transfers
      - Windows Event ID 4688 with command line logging
      - Network Taps/SPAN ports feeding Zeek sensors
      - Management network segments
      - File transfer servers (TFTP, FTP, SCP)
      - Windows management workstations
    range: last 90 days
    queries:
      - query: BASELINE hourly firmware transfer volume AND historical source/destination IP pairs. ALERT if volume > 99th percentile of baseline OR if a new source/destination pair is observed.
  - question: Has a statistical model identified a firmware transfer that is anomalous even after accounting for scheduled maintenance?
    context: Legitimate firmware transfers often follow a predictable schedule (e.g., during maintenance windows). This question uses a more sophisticated time-series model to filter out this normal, seasonal activity and then applies an anomaly detection model to the remaining 'residual' data. This helps find transfers that are truly unusual and not just part of a regular update cycle.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network device syslog for file transfers
      - Windows Event ID 4688 with command line logging
      - Network Taps/SPAN ports feeding Zeek sensors
      - Management network segments
      - File transfer servers (TFTP, FTP, SCP)
      - Windows management workstations
    range: last 90 days
    queries:
      - query: APPLY time-series decomposition to firmware transfer data. TRAIN an anomaly detection model (e.g., Isolation Forest) on the residual component. ALERT on transfers flagged as anomalous by the model.
  - question: Have any unauthorized or unapproved high-privilege, memory-modifying commands been executed on a network device?
    context: Commands that can directly manipulate a device's memory are extremely powerful and dangerous. Their use should be tightly controlled. This question seeks to detect any execution of these commands by users not on a strict 'super-admin' list or any execution that is not tied to a formal, approved change request, as this could be an attempt to inject malicious code into memory.
    answer_sources:
      - TACACS+ command authorization logs
      - Network device syslog
      - IT Service Management (ITSM) change records
      - Centralized syslog server
      - AAA servers (TACACS+/RADIUS)
      - ITSM platform (e.g., ServiceNow)
      - Privileged Access Management (PAM) systems
    range: last 90 days
    queries:
      - query: MONITOR TACACS+ logs for commands in 'high_privilege_list'. ALERT if user is NOT in 'super_admin_list' OR if event does not correlate with an approved ITSM change ticket.
  - question: Has an authorized administrator shown an anomalous frequency of high-privilege command usage?
    context: Even authorized administrators have typical patterns of behavior. A compromised administrative account might be used to execute an unusual number of high-privilege commands. This question establishes a personal baseline for each admin and alerts if their usage spikes significantly, which could indicate their account is being used by an adversary.
    answer_sources:
      - TACACS+ command authorization logs
      - Network device syslog
      - IT Service Management (ITSM) change records
      - Centralized syslog server
      - AAA servers (TACACS+/RADIUS)
      - ITSM platform (e.g., ServiceNow)
      - Privileged Access Management (PAM) systems
    range: last 90 days
    queries:
      - query: FOR each admin, BASELINE daily usage of high-privilege commands from TACACS+ logs. ALERT if usage in 24 hours > 3 standard deviations above their personal average.
  - question: Has a machine learning model detected a high-privilege command execution that falls outside the boundary of normal, authorized activity?
    context: This question uses a model to learn the multi-dimensional profile of legitimate privileged command usage, considering factors like the user, source IP, time of day, and associated change ticket. It can detect anomalies that a single-variable baseline might miss, providing a higher-fidelity signal for an unauthorized or malicious action.
    answer_sources:
      - TACACS+ command authorization logs
      - Network device syslog
      - IT Service Management (ITSM) change records
      - Centralized syslog server
      - AAA servers (TACACS+/RADIUS)
      - ITSM platform (e.g., ServiceNow)
      - Privileged Access Management (PAM) systems
    range: last 90 days
    queries:
      - query: TRAIN a One-Class SVM model on features of authorized privileged command executions. FLAG any new execution that the model classifies as an outlier.
  - question: Has a device's boot configuration been modified without an approved change ticket?
    context: An adversary's primary goal after placing a malicious image on a device is to make the device actually use it. This is done by modifying the boot configuration. This question directly targets that action by alerting on any boot variable change that is not correlated with an approved change request, catching a critical step in the attack chain.
    answer_sources:
      - Network device configuration files
      - Network device syslog (e.g., Cisco %SYS-5-CONFIG_I)
      - ITSM change records
      - Git commit history for configs
      - Network configuration management servers (e.g., SolarWinds NCM)
      - Centralized syslog server
      - ITSM platform
      - Git repositories for version-controlled configurations
    range: last 90 days
    queries:
      - query: ALERT on syslog messages containing 'boot system' commands. SUPPRESS alert only if a corresponding approved change ticket exists in the ITSM for that device and time.
  - question: Has an automated 'diff' of a device's boot configuration shown a significant and anomalous drift from its last known-good state?
    context: This question provides a way to detect unauthorized configuration changes, even if logging fails. By regularly comparing the live boot configuration to a trusted backup, it can score the amount of 'drift'. A high drift score outside of a maintenance window indicates a potentially unauthorized and significant change to how the device boots.
    answer_sources:
      - Network device configuration files
      - Network device syslog (e.g., Cisco %SYS-5-CONFIG_I)
      - ITSM change records
      - Git commit history for configs
      - Network configuration management servers (e.g., SolarWinds NCM)
      - Centralized syslog server
      - ITSM platform
      - Git repositories for version-controlled configurations
    range: last 90 days
    queries:
      - query: DAILY, perform a 'diff' between current boot config and last known-good backup. CALCULATE a weighted 'drift score'. ALERT if score > 95th percentile of historical maintenance scores.
  - question: When a boot configuration change was detected, was the associated change ticket for a purpose other than a firmware upgrade?
    context: This question adds a layer of semantic validation. If a device's boot variables are changed, the reason should logically be a firmware upgrade or related maintenance. This uses an NLP model to classify the purpose of the associated change ticket. If a boot change occurs under a ticket for an unrelated task (e.g., 'ACL Change'), it's a high-risk anomaly.
    answer_sources:
      - Network device configuration files
      - Network device syslog (e.g., Cisco %SYS-5-CONFIG_I)
      - ITSM change records
      - Git commit history for configs
      - Network configuration management servers (e.g., SolarWinds NCM)
      - Centralized syslog server
      - ITSM platform
      - Git repositories for version-controlled configurations
    range: last 90 days
    queries:
      - query: ON boot config change: RETRIEVE associated change ticket. CLASSIFY ticket's purpose using NLP model. ALERT if classification is NOT 'Firmware Upgrade' or 'Scheduled Maintenance'.