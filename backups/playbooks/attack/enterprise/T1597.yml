name: 'T1597: Search Closed Sources'
id: 'f47ac10b-58cc-4372-a567-0e02b2c3d479'
description: |
  This playbook helps determine if an adversary has leveraged information from closed sources, such as third-party data breaches, to conduct reconnaissance or prepare for initial access. It focuses on identifying various forms of credential-based attacks and network scanning. Key indicators include login attempts using known breached credentials, password spraying attacks from a single source against multiple accounts, successful logins to long-dormant accounts, unauthorized connection attempts to non-public network assets, and successful logins that exhibit multiple behavioral anomalies (e.g., new geographic location, unusual time of day).
type: 'technique'
related:
  - 'TA0043: Reconnaissance'
contributors:
  - 'Zachary Szewczyk'
  - 'Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Are there any successful or failed login attempts from external IP addresses using usernames known to be exposed in data breaches?'
    context: |
      This question aims to directly identify credential stuffing attacks where adversaries use lists of previously compromised usernames and passwords. A match indicates a high probability that an attacker is attempting to leverage stolen credentials to gain initial access. Correlating authentication logs with threat intelligence on breached accounts is a critical step in detecting these targeted attacks.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services (e.g., VPN, OWA, M365)'
      - 'Domain Controllers'
      - 'Cloud IAM services'
    range: 'last 90 days'
    queries:
      - 'SEARCH authentication_logs (EventID 4624 OR 4625) WHERE source_ip_is_external AND username IN breached_account_list'
  - question: 'Has there been a statistically significant increase in failed login attempts from external sources for accounts known to be on breached credential lists?'
    context: |
      This question uses statistical analysis to detect anomalies in login failure patterns for high-risk accounts. Instead of looking for a single event, it identifies a sustained or burst increase in brute-force or credential stuffing activity against specific compromised accounts, which might otherwise be missed by simple threshold rules. A high z-score signals a deviation from normal background noise.
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services (e.g., VPN, OWA, M365)'
      - 'Domain Controllers'
      - 'Cloud IAM services'
    range: 'last 90 days'
    queries:
      - 'FOR each_user IN breached_account_list: CALCULATE baseline_failed_logins_external (last 30 days); CALCULATE current_failed_logins_external (last 24 hours); COMPUTE z_score; ALERT if z_score > 3'
  - question: 'Can we use a machine learning model to predict and identify malicious login attempts based on features like breach list status, source IP details, and time of day?'
    context: |
      This question explores a proactive, predictive approach using machine learning. By training a model on historical data, the system can learn the complex characteristics of both legitimate and malicious logins. This allows it to score new, unseen login events in real-time and flag those with a high probability of being malicious, even if they do not trigger a specific, hardcoded rule.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services (e.g., VPN, OWA, M365)'
      - 'Domain Controllers'
      - 'Cloud IAM services'
    range: 'last 90 days'
    queries:
      - 'INPUT login_event_features (is_on_breach_list, is_external_ip, time_of_day, source_ASN_rarity, etc.) INTO trained_classification_model; ALERT if model_output_score > high_probability_threshold'
  - question: 'Is a single external IP address attempting to log in to a large number of different user accounts in a short period, indicating a password spraying attack?'
    context: |
      This question targets a common attack pattern known as password spraying, where an adversary uses one or a few common passwords against many different usernames. By setting a threshold for unique failed logins from a single source IP, this query can effectively detect the "one-to-many" nature of this attack technique.
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services'
      - 'Perimeter firewalls and network gateways'
    range: 'last 90 days'
    queries:
      - 'SEARCH failed_logins (EventID 4625) GROUP BY source_ip; COUNT unique_usernames in 10_minute_window; ALERT if unique_username_count > 20'
  - question: 'Is the randomness of usernames being targeted by a single external IP for failed logins anomalously high, suggesting a password spray attack?'
    context: |
      This question applies information theory to detect password spraying. A legitimate user or system typically targets a very small, predictable set of accounts (low entropy). In contrast, a password spray attack targets a wide and varied set of usernames, resulting in high entropy. Comparing the entropy of a source IP''s activity to a historical baseline can uncover this subtle pattern.
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services'
      - 'Perimeter firewalls and network gateways'
    range: 'last 90 days'
    queries:
      - 'FOR each_external_ip: CALCULATE Shannon_entropy of target_usernames from failed_logins (1-hour window); ALERT if entropy > 99th_percentile_of_historical_entropy'
  - question: 'Can we use unsupervised machine learning (clustering) to automatically identify groups of authentication events that represent password spraying activity?'
    context: |
      This question leverages unsupervised machine learning to find "islands" of anomalous activity within a sea of login data. A DBSCAN algorithm can group together login events that are "close" to each other based on features like source IP and outcome. Password spraying attacks will naturally form a dense cluster characterized by a single IP, many unique usernames, and a high failure rate, allowing the algorithm to discover them without pre-defined rules.
    answer_sources:
      - 'Windows Event ID 4625'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services'
      - 'Perimeter firewalls and network gateways'
    range: 'last 90 days'
    queries:
      - 'APPLY DBSCAN clustering on authentication_events_features (source_ip, outcome, username_hash) over 5-minute_windows; ALERT on clusters with single_source_ip, high_unique_username_count, and high_failure_rate'
  - question: 'Has a user account that has been inactive for an extended period (e.g., more than 90 days) suddenly had a successful login, especially from an external source?'
    context: |
      This question focuses on the misuse of dormant accounts. These accounts are prime targets for adversaries because their legitimate owners are unlikely to notice suspicious activity. A successful login after a long period of inactivity, particularly from an unfamiliar IP address, is a strong indicator of compromise, possibly using old credentials obtained from a breach.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Active Directory User Object Attributes (e.g., lastLogonTimestamp)'
      - 'Zeek conn.log'
      - 'Domain Controllers'
      - 'Active Directory servers'
      - 'Externally-facing authentication services'
    range: 'last 90 days'
    queries:
      - 'CREATE watchlist of dormant_accounts (lastLogonTimestamp > 90 days); SEARCH successful_logins (EventID 4624) WHERE username IN dormant_accounts_watchlist AND source_ip_is_external; ALERT on match'
  - question: 'Has a user logged in successfully after a period of inactivity that is statistically unusual for their personal login habits?'
    context: |
      This question moves beyond a static dormancy threshold (e.g., 90 days) to a more personalized, behavioral approach. It establishes a baseline of normal login frequency for each individual user. A login that occurs after a gap that is a significant statistical outlier for that specific user is flagged as a temporal anomaly, indicating a possible account compromise.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Active Directory User Object Attributes (e.g., lastLogonTimestamp)'
      - 'Zeek conn.log'
      - 'Domain Controllers'
      - 'Active Directory servers'
      - 'Externally-facing authentication services'
    range: 'last 90 days'
    queries:
      - 'FOR each_user: CALCULATE mean and stddev of time_between_logins (last year); ON new_login: CALCULATE time_since_last_login; ALERT if time_since_last_login > (mean + 3*stddev)'
  - question: 'Does a successful login event deviate significantly from a time-series model''s forecast of a user''s expected login behavior?'
    context: |
      This question employs advanced time-series analysis to predict when a user is expected to be active or inactive. By modeling patterns like seasonality (e.g., work hours, weekdays vs. weekends), an algorithm can forecast future behavior. A login that occurs during a period the model predicts should be quiet is flagged as a strong anomaly, suggesting the activity is not from the legitimate user.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Active Directory User Object Attributes (e.g., lastLogonTimestamp)'
      - 'Zeek conn.log'
      - 'Domain Controllers'
      - 'Active Directory servers'
      - 'Externally-facing authentication services'
    range: 'last 90 days'
    queries:
      - 'FOR each_user: APPLY time_series_anomaly_detection (e.g., ARIMA) to login_history; ON new_login: ALERT if login is flagged as a significant anomaly by the model'
  - question: 'Are external IP addresses attempting to connect to internal or non-public assets that should not be exposed to the internet?'
    context: |
      This question aims to detect reconnaissance or exploit attempts against the internal network. By defining a clear list of assets that should never receive traffic from the public internet, any attempt to connect to them from an external source is, by definition, suspicious and warrants a high-severity alert. This is a simple but highly effective detection for network boundary violations.
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek notice.log'
      - 'Network DMZ'
      - 'Internal server subnets'
      - 'Cloud environment subnets hosting non-public services'
      - 'Perimeter firewalls'
    range: 'last 90 days'
    queries:
      - 'CREATE reference_set of non_public_assets (IPs, subnets, ports); SEARCH connection_logs WHERE source_ip_is_external AND destination_ip IN non_public_assets; ALERT on match'
  - question: 'Is a single external IP address generating an unusual number of connection attempts to our non-public assets, suggesting a scanning or enumeration effort?'
    context: |
      This question looks for scanning activity directed at sensitive internal infrastructure. While a single stray packet might be noise, a series of connection attempts from the same source to known non-public assets is a strong indicator of deliberate reconnaissance. Since the baseline for such activity should be zero, even a very low threshold (e.g., >5 attempts) is significant.
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek notice.log'
      - 'Network DMZ'
      - 'Internal server subnets'
      - 'Cloud environment subnets hosting non-public services'
      - 'Perimeter firewalls'
    range: 'last 90 days'
    queries:
      - 'SEARCH connection_logs WHERE source_ip_is_external AND destination_ip IN non_public_assets; GROUP BY source_ip; COUNT connection_attempts in 1-hour_window; ALERT if count > 5'
  - question: 'Can we use a machine learning model, trained only on legitimate traffic patterns, to identify anomalous and potentially malicious connection attempts from external sources targeting non-public assets?'
    context: |
      This question proposes using a one-class classification model, which is ideal for anomaly detection when you have a lot of "normal" data (legitimate traffic) but very few examples of "abnormal" data (attacks). The model learns the boundary of normal network behavior. Any incoming connection that falls outside this learned boundary, especially one targeting a sensitive asset, is flagged as a potential threat.
    answer_sources:
      - 'Zeek conn.log'
      - 'Zeek notice.log'
      - 'Network DMZ'
      - 'Internal server subnets'
      - 'Cloud environment subnets hosting non-public services'
      - 'Perimeter firewalls'
    range: 'last 90 days'
    queries:
      - 'INPUT new_connection_features (dest_ip, dest_port, protocol) INTO trained_OneClassSVM_model; ALERT if model classifies connection as anomaly AND dest_ip IN non_public_assets'
  - question: 'Has a user successfully logged in from a geographic location (country) or network (ASN) from which they have never logged in before?'
    context: |
      This question establishes a behavioral baseline based on a user''s typical network origins. A login from a completely new country or Autonomous System Number (ASN) is a classic indicator of a compromised account, especially for users who do not travel frequently. This ''impossible travel'' or ''new location'' scenario is a high-fidelity signal of adversary activity.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services'
      - 'VPN concentrators'
      - 'Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'FOR each_user: MAINTAIN safelist of known_countries and known_ASNs (last 30-60 days); ON new_login: ALERT if source_country NOT IN known_countries OR source_ASN NOT IN known_ASNs'
  - question: 'Does a successful login exhibit multiple simultaneous deviations from the user''s normal behavior, such as a new location, a new network, and an unusual time?'
    context: |
      This question aggregates multiple weak signals of anomalous behavior into a single, stronger risk score. A single anomaly (like a login at an odd time) might be benign, but when combined with a new location and a new network, the likelihood of malicious activity increases dramatically. A risk-scoring system allows for more nuanced detection than a single binary rule.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services'
      - 'VPN concentrators'
      - 'Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'ON new_login: CALCULATE risk_score = 0; IF new_country, risk_score+=1; IF new_ASN, risk_score+=1; IF login_hour_zscore > 2, risk_score+=1; ALERT if risk_score > 2'
  - question: 'Using an unsupervised machine learning model, does a recent successful login register as a significant anomaly when compared to the user''s holistic behavioral profile?'
    context: |
      This question uses a comprehensive, unsupervised ML approach to detect anomalous logins. Unlike rule-based systems, an Isolation Forest or autoencoder can learn the complex, high-dimensional patterns of a user''s normal behavior across many features simultaneously. It can then identify logins that are "different" in ways a human analyst might not think to codify in a rule, providing a powerful safety net for detecting sophisticated account takeovers.
    answer_sources:
      - 'Windows Event ID 4624'
      - 'Zeek conn.log'
      - 'Externally-facing authentication services'
      - 'VPN concentrators'
      - 'Domain Controllers'
    range: 'last 90 days'
    queries:
      - 'FOR each_user: INPUT login_features (hour, day, ASN_hash, country_rarity) INTO trained_IsolationForest_model; ALERT if model returns high_anomaly_score'