name: T1114: Email Collection
id: f4b1b1f0-5a1e-4b9a-8f0c-1e2d3c4d5e6f
description: This playbook helps investigate whether an adversary is collecting sensitive information from user email accounts. It focuses on detecting several key malicious activities: the creation or modification of inbox rules to automatically forward emails to external domains; the use of PowerShell cmdlets like Search-Mailbox or New-MailboxExportRequest on non-administrative hosts to search and export mailbox data; the creation of email archive files (such as .pst or .zip) in unusual locations followed by network exfiltration; successful but anomalous authentications to email services characterized by rare user-agents, new geographic locations, or unusual TLS fingerprints; unauthorized processes reading local email data files like .pst or .ost and subsequently making outbound network connections; and connections to mail servers from processes that are not approved email clients.
type: technique
related:
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any new or modified inbox rules been created to automatically forward emails to an unapproved external domain?
    context: Adversaries often create inbox rules to surreptitiously exfiltrate data by forwarding copies of incoming or outgoing emails to an external account they control. This question focuses on identifying the creation of such rules by monitoring for specific audit log events (`New-InboxRule`, `Set-InboxRule`) and correlating them with network traffic that shows evidence of auto-forwarding to domains not on an organization's approved allow-list.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Zeek smtp.log
      - Zeek http.log
      - Mail Gateway (e.g., Exchange Online, On-prem Exchange)
      - Network Egress Points
      - Webmail Application Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH M365 logs for 'New-InboxRule' or 'Set-InboxRule' events. FILTER where ForwardTo or ForwardingSmtpAddress contains a domain NOT IN allow_list. CORRELATE with Zeek smtp.log for matching timestamps and recipient domains where X-MS-Exchange-Organization-AutoForwarded header is true.
  - question: Has any user exhibited a statistically significant increase in the volume of auto-forwarded emails or started forwarding to a new external domain?
    context: Beyond just rule creation, a sudden change in the volume of auto-forwarded emails can indicate that a previously dormant malicious rule has been activated or that a legitimate rule has been hijacked. This question aims to detect anomalies in forwarding behavior by baselining each user's normal forwarding activity and alerting on significant deviations or any forwarding to a previously unseen destination.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Zeek smtp.log
      - Zeek http.log
      - Mail Gateway (e.g., Exchange Online, On-prem Exchange)
      - Network Egress Points
      - Webmail Application Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each user, CREATE 30-day baseline of daily auto-forwarded email count from Zeek smtp.log. ALERT if daily count > 95th percentile of baseline. ALSO, ALERT if forwarded-to domain is new for that user.
  - question: Can we predictively identify suspicious inbox rule creation events based on their contextual features?
    context: Sophisticated attackers may attempt to camouflage malicious rule creation to look like legitimate user activity. This question uses a machine learning model to score the risk of a new rule by analyzing a combination of features, such as the time of day, the user's role, the reputation of the target domain, and the source IP's origin. A high-risk score suggests a potentially malicious rule that requires investigation.
    answer_sources:
      - Microsoft 365 Unified Audit Log
      - Zeek smtp.log
      - Zeek http.log
      - Mail Gateway (e.g., Exchange Online, On-prem Exchange)
      - Network Egress Points
      - Webmail Application Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: TRAIN a classifier with features from M365 rule creation events (time, user role, domain TLD/age, IP source). PREDICT probability of malice for new rule creation events. ALERT on high probability scores.
  - question: Have any sensitive PowerShell mailbox cmdlets been executed on non-administrative hosts or by non-administrative users?
    context: Adversaries may gain access to a standard user endpoint and then use PowerShell to search and export mailbox data. Cmdlets like `Search-Mailbox` and `New-MailboxExportRequest` are powerful tools that should typically only be used by administrators on designated servers. This question seeks to detect the misuse of these cmdlets by looking for their execution in unexpected contexts.
    answer_sources:
      - Windows Event ID 4688
      - Windows PowerShell Log Event ID 4104
      - Exchange Servers
      - Administrator Workstations
      - Domain Controllers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH process creation (4688) or script block (4104) logs for command lines containing 'Search-Mailbox', 'New-MailboxExportRequest', or '.Ews.ExchangeService'. FILTER where hostname IS NOT IN admin_host_list OR username IS NOT IN admin_user_list.
  - question: Has any user executed a rare and high-risk PowerShell cmdlet for the first time?
    context: Users typically have a predictable pattern of PowerShell usage. An adversary, however, might use a specific, powerful cmdlet for the first time on a compromised account to achieve their objective. This question identifies such anomalies by calculating the rarity of cmdlets across the organization and flagging when a user executes a high-risk, rarely-used cmdlet (like `New-MailboxExportRequest`) for the first time.
    answer_sources:
      - Windows Event ID 4688
      - Windows PowerShell Log Event ID 4104
      - Exchange Servers
      - Administrator Workstations
      - Domain Controllers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: PROFILE historical cmdlet usage per user from PowerShell logs (4104). CALCULATE rarity score for each cmdlet. ALERT if a user executes a high-rarity, high-risk cmdlet for the first time.
  - question: Are there any anomalous PowerShell execution events that suggest malicious mailbox access?
    context: Malicious PowerShell scripts often have different characteristics than benign administrative scripts. This question applies an anomaly detection model to identify suspicious executions based on a combination of features like script length and entropy, the user context, and the host. The model can uncover novel or obfuscated attempts to access mailbox data that might evade simpler signature-based rules.
    answer_sources:
      - Windows Event ID 4688
      - Windows PowerShell Log Event ID 4104
      - Exchange Servers
      - Administrator Workstations
      - Domain Controllers
      - User Endpoints
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: TRAIN anomaly detection model (e.g., Isolation Forest) on features from PowerShell logs (4104): script length, entropy, user, host, keywords. ALERT on events flagged as anomalous.
  - question: Has an email archive file been created in an unusual location and then accessed by a process that made an outbound network connection?
    context: A common adversary tactic is to export a user's mailbox to an archive file (like a .pst or .zip), place it in a temporary directory, and then exfiltrate it. This question looks for this specific chain of events: (1) creation of a mail archive file in a non-standard folder, (2) access to that file by a process that isn't an email client, and (3) a subsequent outbound network connection from the host with a data transfer size similar to the archive file's size.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek files.log
      - Zeek conn.log
      - User Endpoints
      - File Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: "CORRELATE: (1) File create event (4663) for '*.pst' or '*.zip' in non-standard path. (2) Process access event (4688) for that file by non-email-client process. (3) Outbound network connection (Zeek conn.log) from same host with orig_bytes similar to file size within 5 minutes."
  - question: Has there been an anomalous spike in the creation of email archive files on a host, followed by an unusually large data exfiltration?
    context: This question aims to detect bulk email exfiltration by looking for statistical deviations from normal behavior. It establishes a baseline for how often and how many email archive files are created on a host. An alert is triggered if the number or total size of these files exceeds a high percentile, especially if it's followed by an outbound data transfer that is also anomalously large for that specific host.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek files.log
      - Zeek conn.log
      - User Endpoints
      - File Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: BASELINE daily count/size of '*.pst'/'*.zip' files created outside standard mail directories per host. ALERT if count > 99th percentile. CORRELATE with subsequent outbound traffic from Zeek conn.log that exceeds the host's 99th percentile for daily outbound data.
  - question: Can we detect data exfiltration by identifying network traffic anomalies that are correlated with email archive creation events?
    context: This question uses a time-series forecasting model to predict a host's expected outbound network traffic. The model is then fed information about when email archive files are created. If the actual network traffic significantly and unexpectedly exceeds the model's prediction right after a `.pst` file is created, it strongly suggests that the file was exfiltrated.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Zeek files.log
      - Zeek conn.log
      - User Endpoints
      - File Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: TRAIN time-series model (e.g., ARIMA) on host's outbound network traffic. USE file creation events for '*.pst' as an input. ALERT if actual traffic significantly exceeds predicted traffic after a file creation event.
  - question: Has a successful login to an email service occurred from a known malicious IP or as part of an 'impossible travel' scenario?
    context: This question focuses on clear-cut indicators of a compromised account. It seeks to identify successful authentications that originate from IP addresses found on threat intelligence blocklists or logins that are geographically impossible (e.g., a user logging in from North America and Asia within an hour), which are strong signals of unauthorized access.
    answer_sources:
      - Windows Event ID 4624
      - Microsoft 365 Unified Audit Log
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Authentication Servers (Active Directory)
      - Cloud Identity Provider (Azure AD)
      - VPN Concentrators
      - Webmail Application Servers
      - Mail Gateway
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: SEARCH for successful email login events (M365 UserLoggedIn, Windows 4624). ALERT if source IP is in threat_intel_list OR if the login triggers an 'impossible travel' condition based on user's last login location and time.
  - question: Has a successful email login occurred with a combination of attributes that are rare or new for that specific user?
    context: Adversaries often use different tools, networks, and locations than the legitimate user. This question aims to detect these subtle deviations by creating a historical profile of each user's typical login attributes (country, ISP, user-agent, TLS fingerprint). A new login is scored based on how many of its attributes are new or statistically rare for that user, with a high score indicating a high-risk, potentially unauthorized login.
    answer_sources:
      - Windows Event ID 4624
      - Microsoft 365 Unified Audit Log
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Authentication Servers (Active Directory)
      - Cloud Identity Provider (Azure AD)
      - VPN Concentrators
      - Webmail Application Servers
      - Mail Gateway
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each user, BASELINE historical login attributes (country, ASN, user-agent, JA3). SCORE new logins based on number of new/rare attributes. ALERT if score exceeds 98th percentile.
  - question: Can we use a machine learning model to identify login behaviors that fall outside a user's normal multi-dimensional profile?
    context: While statistical analysis looks at attributes individually, a machine learning model can understand the complex relationships between them. This question uses an unsupervised anomaly detection model to learn a user's 'normal' login behavior across many dimensions simultaneously. It can then flag logins that are anomalous as a whole, even if each individual attribute isn't necessarily suspicious on its own.
    answer_sources:
      - Windows Event ID 4624
      - Microsoft 365 Unified Audit Log
      - Zeek conn.log
      - Zeek http.log
      - Zeek ssl.log
      - Authentication Servers (Active Directory)
      - Cloud Identity Provider (Azure AD)
      - VPN Concentrators
      - Webmail Application Servers
      - Mail Gateway
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: TRAIN an unsupervised anomaly detection model (e.g., One-Class SVM) on user login vectors (user, country, ASN, time of day, etc.). ALERT on logins flagged as anomalous by the model.
  - question: Has a process not on the approved email client list read a local email data file and then made an outbound connection?
    context: Legitimate access to local email archives (`.pst`, `.ost`) is typically handled by a small set of approved applications like Outlook. This question seeks to detect when an unauthorized process (e.g., `powershell.exe`) reads these files, which is highly suspicious, especially when it is immediately followed by an outbound network connection from the same host to an external, potentially malicious, IP address.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - User Endpoints
      - Network Egress Points
      - DNS Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: "TRIGGER on file read event (4663) for '*.pst' or '*.ost' where process name IS NOT IN email_client_allow_list. CORRELATE with subsequent outbound connection (Zeek conn.log) from the same host within 5 minutes to an IP NOT IN known_good_range."
  - question: Has a process accessed local email files for the first time on a given host, followed by an anomalous amount of outbound data transfer?
    context: This question establishes a baseline of which processes normally interact with email files on each host. An alert is generated for any 'first-seen' access, meaning a process that has never touched a `.pst` or `.ost` file before suddenly does. This is further strengthened by correlating the access with an outbound data transfer that is statistically significant for that host, indicating potential exfiltration.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - User Endpoints
      - Network Egress Points
      - DNS Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: BASELINE processes that access '*.pst'/'*.ost' per host. ALERT on 'first-seen' access by a new process. CORRELATE with subsequent outbound data transfer > 99th percentile for that host.
  - question: Can we detect malicious activity sequences involving process execution, email file access, and network connections?
    context: Adversary actions often form a logical, sequential chain of events. This question uses a sequence-based machine learning model (like an HMM) to learn the normal sequences of user and system activity. The model can then identify and alert on low-probability sequences that match a malicious pattern, such as PowerShell starting, reading a `.pst` file, and then connecting to a new external IP address.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - User Endpoints
      - Network Egress Points
      - DNS Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: "TRAIN a sequence model (e.g., HMM) on event logs (process, file, network). ALERT on observed low-probability sequences, e.g., '[powershell.exe starts] -> [reads user.pst] -> [connects to new external IP]'."
  - question: Has a process not on the approved application allow-list initiated a connection to a mail server on a standard mail port?
    context: Only specific, approved applications (like email clients) should be communicating with mail servers. This question uses a strict allow-list approach to identify any unauthorized process attempting to connect to a mail server on ports like IMAP(S), POP3(S), or SMTP(S). Such a connection is a strong indicator of a custom exfiltration tool or a living-off-the-land binary being used to access email.
    answer_sources:
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - Mail Gateway
      - User Endpoints
      - Application Servers
      - Internal Network Segments
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: MONITOR network connection events (WFP 5156 or EDR). ALERT if process name IS NOT IN mail_client_allow_list AND destination port IS IN mail_port_list AND destination IP IS IN mail_server_list.
  - question: Has a 'first-time' connection from a specific process to a mail port been observed on any given host?
    context: Instead of a global allow-list, this question builds a historical baseline for each host, tracking which processes normally connect to which ports. It then alerts on any 'first-seen' combination where a process connects to a mail port for the first time on that host. This can detect legitimate but compromised applications being used for malicious purposes in a way that is anomalous for that specific machine.
    answer_sources:
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - Mail Gateway
      - User Endpoints
      - Application Servers
      - Internal Network Segments
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: FOR each host, BASELINE (process_name, destination_port) pairs over 30 days. ALERT on any new pair where destination_port is a mail port and process_name is not a known mail client.
  - question: Can a graph-based model detect anomalous network connections between hosts with different roles, such as a web server connecting to a mail server?
    context: This question models the entire network as a graph, where nodes are hosts with assigned roles (e.g., 'web-server', 'workstation') and edges represent connections. A machine learning model trained on this graph learns the normal communication patterns between different types of hosts. It can then flag highly anomalous connections, such as a web server suddenly initiating an IMAPS connection to a mail server, as a high-risk event indicative of lateral movement or data collection.
    answer_sources:
      - Windows Event ID 5156
      - Windows Event ID 4688
      - Zeek conn.log
      - EDR process and network event logs
      - Mail Gateway
      - User Endpoints
      - Application Servers
      - Internal Network Segments
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: MODEL network as a graph with nodes (hosts with roles) and edges (connections). TRAIN a GNN to learn normal communication patterns. ALERT on new or rare edges flagged as anomalous, e.g., ('web-server' -> 'mail-server' on port 993).