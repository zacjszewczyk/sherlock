name: T1003.003: NTDS
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary has attempted to access or exfiltrate a copy of the Active Directory NTDS database for credential theft. This involves detecting large network transfers from Domain Controllers, the use of dumping utilities like ntdsutil or vssadmin, direct unauthorized access to the ntds.dit file, suspicious creation of Volume Shadow Copies, or the use of DCSync replication requests from non-domain controllers.
type: technique
related:
  - TA0006: Credential Access
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags:
  - none
questions:
  - question: Has a Domain Controller transferred a large file (>500MB) to an external destination, with file characteristics matching the NTDS.dit database?
    context: This question aims to detect the direct exfiltration of the NTDS.dit database file. Adversaries may copy the database and transfer it off-network for offline credential extraction. A large, single-file transfer from a Domain Controller is highly anomalous. Correlating network transfer data with file transfer logs helps confirm if the transferred file is indeed the NTDS database, even if it has been renamed to evade simple detection.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek ssl.log
      - Network Egress Points
      - Internet Gateway
      - Domain Controller network interfaces
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH Zeek conn.log
          WHERE source_ip is in DC_list AND destination_ip is external AND bytes_out > 500MB
          CORRELATE with Zeek files.log
          WHERE source_ip matches AND (filename matches 'ntds.dit' OR filename matches '*.dit' OR filename matches GUID_pattern)
  - question: Has a Domain Controller initiated an outbound connection with a data volume significantly larger than its normal behavior, or to a new destination?
    context: This question focuses on detecting anomalous data transfers without relying on a fixed size threshold. By establishing a baseline of normal network traffic volume for each Domain Controller, we can identify outliers that may represent exfiltration. Scrutinizing connections to new or rare Autonomous Systems (ASNs) or countries adds another layer of risk, as attackers often use infrastructure not typically contacted by the organization.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek ssl.log
      - Network Egress Points
      - Internet Gateway
      - Domain Controller network interfaces
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH Zeek conn.log
          WHERE source_ip is in DC_list
          ALERT IF bytes_out > 99th_percentile_baseline(source_ip)
          ENRICH with ASN and GeoIP data; flag if destination ASN or country is new or rare.
  - question: Does a machine learning model classify an outbound connection from a Domain Controller as likely malicious based on its network characteristics?
    context: This question leverages a machine learning model to perform a more sophisticated, multi-faceted analysis of network connections. Instead of relying on single indicators like data volume, the model considers a combination of features (port, protocol, duration, reputation, etc.) to assess the probability of malicious activity. This can detect more subtle exfiltration attempts that might not trigger simpler threshold-based rules.
    answer_sources:
      - Zeek conn.log
      - Zeek files.log
      - Zeek ssl.log
      - Network Egress Points
      - Internet Gateway
      - Domain Controller network interfaces
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          APPLY Random Forest model ON Zeek network logs from DCs
          FEATURES = [bytes_out, dest_port, protocol, duration, dest_ip_reputation, dest_asn, ja3_hash, is_internal]
          ALERT if probability_score > high_threshold
  - question: Has a known NTDS dumping utility or suspicious script been executed on a Domain Controller?
    context: This question looks for the direct execution of tools and commands commonly used by adversaries to dump the NTDS database. Monitoring for specific process names (ntdsutil.exe, vssadmin.exe) and command-line arguments ('ifm', 'create shadow', 'secretsdump.py') provides high-fidelity alerts for known T1003.003 techniques. Including PowerShell script block logging (Event ID 4104) helps detect fileless or script-based attacks.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH process creation logs (4688, Sysmon 1) OR script logs (4104) on all Domain Controllers
          WHERE (ProcessName IN ['ntdsutil.exe', 'vssadmin.exe', 'powershell.exe'])
          AND (CommandLine CONTAINS ['ifm', 'create shadow', 'secretsdump.py', 'Invoke-NinjaCopy', 'Invoke-DCSync', 'Copy-VSS'])
  - question: Has a command line with unusually high complexity or obfuscation been executed on a Domain Controller?
    context: Adversaries often obfuscate their commands to evade simple keyword-based detection. This question seeks to identify such commands by measuring their complexity using Shannon entropy. A command line with abnormally high entropy, especially from a common process like 'powershell.exe' on a Domain Controller, is suspicious and warrants investigation, particularly if it contains fragments related to the NTDS database.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each command line on DCs from generic processes ('powershell.exe', 'cmd.exe')
          CALCULATE Shannon entropy of CommandLine arguments
          ALERT if entropy > 95th_percentile_baseline
          AND CommandLine CONTAINS ['NTDS', 'SystemRoot', 'dit']
  - question: Has an anomalous parent-child process relationship, such as a web server spawning a credential dumping tool, occurred on a Domain Controller?
    context: This question aims to detect attacks by analyzing the sequence of process creations. Normal operations on a Domain Controller follow predictable patterns. An adversary compromising a service (like a web server) and using it to launch system utilities like 'ntdsutil.exe' or 'vssadmin.exe' would create a highly anomalous parent-child process chain, which a sequence analysis model can effectively detect.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          APPLY LSTM sequence model to parent-child process chains on DCs
          ALERT on anomalous sequences, e.g., ParentProcessName='w3wp.exe' AND ProcessName IN ['ntdsutil.exe', 'vssadmin.exe']
  - question: Has an unapproved process accessed the ntds.dit file on a Domain Controller?
    context: The ntds.dit file should only be accessed by a small, predictable set of system processes and approved backup solutions. This question focuses on detecting any process accessing this critical file that is not on a pre-defined allowlist. This provides a high-fidelity method for detecting unauthorized access attempts, as any deviation from the norm is highly suspicious.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Domain Controller file systems, specifically the %SystemRoot%\NTDS\ directory
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH file access logs (4663, Sysmon 11) on DCs
          WHERE ObjectName ENDS WITH '\NTDS\ntds.dit'
          AND ProcessName NOT IN ['lsass.exe', 'System', 'dfm.exe', 'vmms.exe', 'veeam.exe']
          OR (EventID=11 and FileName ENDS WITH '.dit' AND TargetFilename NOT IN '%SystemRoot%\NTDS\')
  - question: Has a new user or process, not seen in the baseline, attempted to access the ntds.dit file, especially outside of normal backup hours?
    context: This question uses behavioral analysis to detect anomalous access. By baselining which user accounts and processes normally access the ntds.dit file, we can alert on any new or previously unseen combination. Adding a time-based context, such as flagging access that occurs outside of established backup windows, further reduces false positives and helps pinpoint suspicious activity that an adversary might attempt to hide during off-hours.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Domain Controller file systems, specifically the %SystemRoot%\NTDS\ directory
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH file access logs (4663) for 'ntds.dit'
          CREATE tuple (ProcessName, SubjectUserName)
          ALERT if tuple is not in 30-day baseline
          INCREASE severity if access time is outside of backup window (e.g., not between 1 AM - 4 AM)
  - question: Does a machine learning model classify access to the ntds.dit file as anomalous based on the access pattern?
    context: This question applies unsupervised machine learning to detect outlier access events that may not be caught by static rules or baselines. An isolation forest model can learn the complex, multi-dimensional profile of legitimate access (including process, user, logon type, and access rights) and flag any event that deviates significantly from this learned norm, indicating a potential threat.
    answer_sources:
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Domain Controller file systems, specifically the %SystemRoot%\NTDS\ directory
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          APPLY isolation forest model to file access logs (4663) for 'ntds.dit'
          FEATURES = [ProcessName, SubjectUserName, LogonID, AccessMask]
          ALERT if model classifies event as an outlier/anomaly
  - question: Has a Volume Shadow Copy been created on a Domain Controller by a user account not authorized for backup or administrative tasks?
    context: Adversaries frequently use Volume Shadow Copies (VSS) to create a snapshot of the system, allowing them to copy locked files like ntds.dit. This question aims to detect this activity by alerting when a VSS creation event is initiated by an interactive user or a service account not on an explicit allowlist of backup and administrative accounts.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7036
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH process (4688) or script (4104) logs on DCs
          WHERE (CommandLine CONTAINS 'vssadmin create shadow' OR ScriptBlock CONTAINS 'New-VSSShadowCopy')
          AND SubjectUserName NOT IN (allowlist of backup/admin service accounts)
  - question: Has a Volume Shadow Copy been created on a Domain Controller at a time that deviates from the established backup schedule?
    context: Legitimate VSS creation for backups typically occurs on a predictable schedule. This question uses time-series analysis to model this regular pattern. By detecting VSS creation events that are statistical outliers with respect to the daily and weekly schedule, we can identify VSS usage that is likely not part of a normal backup operation and may be malicious.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7036
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MODEL time series of VSS start events (7036) and vssadmin commands (4688)
          DECOMPOSE into daily/weekly patterns
          ALERT on any VSS creation event that is a statistical outlier to the established schedule
  - question: Is a Volume Shadow Copy creation event on a Domain Controller likely malicious based on its context, such as the initiating user and subsequent activity?
    context: This question uses a decision tree model to make a higher-confidence determination of malicious intent. The model considers not just the VSS creation itself, but a broader context including who initiated it, their privileges, the time of day, and whether it was immediately followed by other suspicious actions, such as accessing ntds.dit or a large network transfer. This correlation provides a more robust signal than looking at VSS creation in isolation.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7036
      - Windows Event ID 4104
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          APPLY decision tree model to VSS creation events
          FEATURES = [ProcessName, SubjectUserName, UserGroupMemberships, TimeOfDay, FollowedByNtdsAccess, FollowedByLargeEgress]
          ALERT if model classifies event as malicious
  - question: Has a non-Domain Controller attempted to perform a DCSync replication request?
    context: The DCSync attack allows an adversary to impersonate a Domain Controller and request password hashes from other DCs. This is accomplished using the 'DsGetNcChanges' replication call. This question seeks to detect this attack by alerting any time a 'DsGetNcChanges' request originates from a host that is not on a pre-defined allowlist of Domain Controllers. This is a high-fidelity indicator of a credential access attempt.
    answer_sources:
      - Zeek dce_rpc.log
      - Windows Event ID 4662
      - Network segments connecting to Domain Controllers
      - Authentication Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH network RPC logs (Zeek dce_rpc) OR AD audit logs (4662)
          WHERE (operation = 'DsGetNcChanges' AND source_ip NOT IN DC_allowlist)
          OR (EventID=4662 AND ReplicationGUID='1131f6aa-9c07-11d1-f79f-00c04fc2dcd2' AND SubjectSID is not a DC)
  - question: Has there been an anomalous spike in the number of unique hosts attempting to perform replication activity?
    context: While a single DCSync attempt is a strong indicator, an adversary might use multiple compromised hosts to perform replication requests. This question aims to detect such a scenario by baselining the normal number of hosts performing replication. A sudden spike in the count of distinct source hosts making 'DsGetNcChanges' requests would deviate significantly from this baseline and could indicate a widespread attack.
    answer_sources:
      - Zeek dce_rpc.log
      - Windows Event ID 4662
      - Network segments connecting to Domain Controllers
      - Authentication Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CALCULATE hourly count of distinct source hosts making 'DsGetNcChanges' requests
          ALERT if count > (7-day_rolling_average + 3 * standard_deviation)
  - question: Has a new, anomalous replication relationship appeared in the network graph of Domain Controllers?
    context: This question models the Active Directory replication topology as a network graph, where nodes are hosts and edges represent replication requests. In a stable environment, this graph is very consistent. A DCSync attack from a non-DC host would manifest as the sudden appearance of a new edge from an unexpected node (e.g., a workstation) to a Domain Controller node. This structural anomaly is a strong indicator of an attack.
    answer_sources:
      - Zeek dce_rpc.log
      - Windows Event ID 4662
      - Network segments connecting to Domain Controllers
      - Authentication Servers
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MODEL DC replication as a graph (Nodes=Hosts, Edges='DsGetNcChanges' requests)
          ALERT on the creation of a new edge where source_node is not classified as a DC and destination_node is a DC
  - question: Has a host-based NTDS dumping event been immediately followed by a large or anomalous network transfer from the same host?
    context: This question establishes a crucial link between the act of dumping credentials and the act of exfiltrating them. An alert for a suspicious host-based activity (like 'vssadmin' usage) is significant, but becomes critical when correlated with a subsequent large network transfer from that same host within a short time window (e.g., 5 minutes). This correlation provides strong evidence of a successful dump and exfiltration chain.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Sysmon Event ID 3
      - Domain Controllers
      - Network Egress Points
      - Internet Gateway
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          CORRELATE host alerts (e.g., vssadmin usage, ntds.dit access) with network logs (Zeek, Sysmon 3)
          TRIGGER when host alert on DC is followed within 5 minutes by a network connection from the same DC
          WHERE outbound_bytes > 99th_percentile_of_DC_baseline
  - question: Following a potential NTDS dumping event on a Domain Controller, did the host's outbound data volume show a statistically significant deviation from its normal behavior?
    context: Rather than looking for a single large transfer, this question uses an Exponentially Weighted Moving Average (EWMA) to detect a sustained change in outbound traffic volume. This can be more effective at catching exfiltration that is split into multiple smaller chunks. If a host-based trigger occurs, monitoring the EWMA for a significant upward deviation provides a statistical basis for declaring an anomalous transfer event.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Sysmon Event ID 3
      - Domain Controllers
      - Network Egress Points
      - Internet Gateway
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MAINTAIN EWMA on outbound data volume for each DC.
          IF host-based trigger occurs (e.g., 'ntdsutil' execution):
          MONITOR EWMA for next 15 minutes.
          ALERT if observed volume causes a statistically significant deviation in EWMA.
  - question: Does a sequence of events on a Domain Controller, including host-based actions and network transfers, indicate a high probability of credential exfiltration according to a machine learning model?
    context: This question uses a sophisticated Hidden Markov Model (HMM) to understand the sequence of attacker actions. The model is trained on sequences of events and learns the probability of transitioning between states (e.g., from a 'Benign' state to an 'Exfiltrating' state). An alert is generated when the model determines that the most likely sequence of hidden states, given the observed events (like 'vssadmin' followed by a 'large_network_tx'), is 'Exfiltrating'.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4688
      - Windows Event ID 4663
      - Sysmon Event ID 3
      - Domain Controllers
      - Network Egress Points
      - Internet Gateway
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          INPUT sequence of events from a DC into a trained Hidden Markov Model.
          EVENTS = ['vssadmin_create', 'ntdsutil_ifm', 'large_network_tx', etc.]
          ALERT if the most likely hidden state sequence is 'Exfiltrating' with a high probability.