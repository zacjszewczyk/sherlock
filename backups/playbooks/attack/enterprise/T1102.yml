name: "T1102: Web Service"
id: "b4e8a5c2-1f4d-4a1b-8c7e-9d0f1a2b3c4d"
description: "This playbook helps determine if an adversary is using legitimate web services for command and control. It provides investigative steps to detect C2 activity by looking for network connections to known malicious indicators, matching HTTP requests against C2 framework signatures, identifying automated beaconing patterns through low jitter and consistent byte counts, spotting anomalous data exfiltration via unusual upload-to-download ratios, and finding network connections initiated by suspicious processes, unusual file paths, or abnormal parent-child process chains."
type: "technique"
related:
- "TA0011: Command and Control"
contributors:
- "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
- question: "Is a host communicating with a known command and control indicator (IP, domain, or TLS fingerprint)?"
  context: "This question aims to identify direct communication with known malicious infrastructure. By joining network connection, DNS, and TLS logs and comparing them against a real-time threat intelligence feed, analysts can detect initial C2 callbacks or ongoing communication with high confidence. A match is a strong signal of a compromised host."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Zeek ssl.log"
  - "Network Egress Points (e.g., Firewalls, Proxies), DNS Resolvers"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH Zeek logs (conn, dns, ssl) JOINED by UID WHERE destination_ip OR destination_hostname OR tls_ja3_hash OR tls_cert_hash IN threat_intel_feed"
- question: "Is any host exhibiting an unusually high frequency of contact with known C2 indicators compared to its peers?"
  context: "This question helps to surface hosts that may be persistently communicating with C2 infrastructure, even if the individual connections are missed. By baselining the normal rate of IoC hits across the environment and flagging statistical outliers (e.g., hosts above the 95th percentile), analysts can prioritize investigations on the most active or potentially compromised systems."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Zeek ssl.log"
  - "Network Egress Points (e.g., Firewalls, Proxies), DNS Resolvers"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH IoC_alerts GROUP BY hostname | COUNT distinct IoC_hits over 24h | COMPARE count to 95th_percentile of all hosts"
- question: "Can we predict if a new, unseen network connection is likely C2 traffic based on its characteristics?"
  context: "This question focuses on proactively identifying C2 activity that may not match known IoCs. By training a machine learning model on features from historical network connections (both benign and known malicious), analysts can score new connections for their likelihood of being C2. This helps detect novel or obfuscated C2 channels based on their behavioral properties like connection duration, data volume, and protocol specifics."
  answer_sources:
  - "Zeek conn.log"
  - "Zeek dns.log"
  - "Zeek ssl.log"
  - "Network Egress Points (e.g., Firewalls, Proxies), DNS Resolvers"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "APPLY classification_model ON new_network_connections | FEATURES: duration, byte_counts, protocol, tls_version, tls_cipher | OUTPUT: probability_is_c2"
- question: "Is there any HTTP traffic that matches the static signatures (URI, User-Agent, headers) of known C2 frameworks?"
  context: "This question aims to detect C2 frameworks like Cobalt Strike or Empire that use predictable patterns in their HTTP communications. By applying regular expressions or other signature-based rules to HTTP logs, analysts can find tell-tale signs of these tools, even if the destination IP or domain is not on a threat intelligence list."
  answer_sources:
  - "Zeek http.log"
  - "Application-Layer Proxies with TLS Inspection, Network Taps with Decryption Capabilities"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH Zeek http.log WHERE uri OR user_agent OR host MATCHES C2_regex_patterns"
- question: "Does any HTTP traffic to common web services show unusually random or simplistic URI paths or User-Agent strings?"
  context: "This question seeks to identify C2 communications hiding within legitimate web service traffic. Adversaries may use overly simplistic User-Agents or highly random URIs (for encoded data). By calculating the entropy of these fields and comparing them to a baseline for a given service, analysts can detect statistical anomalies that may indicate C2 activity."
  answer_sources:
  - "Zeek http.log"
  - "Application-Layer Proxies with TLS Inspection, Network Taps with Decryption Capabilities"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH Zeek http.log | CALCULATE shannon_entropy(uri), shannon_entropy(user_agent) | ALERT if entropy is outside of established baseline for the destination_service"
- question: "Has there been an unexpected spike in the volume of requests matching a specific C2 signature?"
  context: "This question helps to detect the start of a new campaign or a widespread outbreak using a known C2 pattern. By forecasting the expected volume of requests matching a signature (e.g., to pastebin.com/raw/) and alerting when the actual volume significantly exceeds the prediction, analysts can identify a sudden change in activity that warrants investigation."
  answer_sources:
  - "Zeek http.log"
  - "Application-Layer Proxies with TLS Inspection, Network Taps with Decryption Capabilities"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "FORECAST count of requests matching C2_pattern over time | ALERT if actual_count > upper_confidence_bound"
- question: "Is any internal host making an unusually high number of connections to a single external destination, especially on a non-standard port?"
  context: "This question aims to find repetitive C2 beaconing masked as web traffic. A high volume of connections from one source to one destination within a short period is abnormal for user-driven browsing. This simple count-based threshold can be an effective first-pass filter for identifying potentially automated communication."
  answer_sources:
  - "Zeek conn.log"
  - "Windows Event ID 5156"
  - "Network Egress Points (e.g., Firewalls, Proxies), Endpoint Detection and Response (EDR) agents on workstations and servers"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH network_connections GROUP BY src_ip, dest_ip, dest_port | COUNT connections over 1_hour | ALERT if count > 60"
- question: "Is any host exhibiting robotic, periodic network beaconing to an external service?"
  context: "This question focuses on the timing of C2 communications. Automated malware beacons often check in at regular intervals, resulting in very low 'jitter' (standard deviation of time between connections). By calculating this jitter for source-destination pairs, analysts can distinguish automated traffic from irregular, human-driven browsing."
  answer_sources:
  - "Zeek conn.log"
  - "Windows Event ID 5156"
  - "Network Egress Points (e.g., Firewalls, Proxies), Endpoint Detection and Response (EDR) agents on workstations and servers"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH network_connections GROUP BY src_ip, dest_ip, dest_port | CALCULATE time_diff between connections | COMPUTE std_dev of time_diffs over 1_hour | ALERT if std_dev < 2_seconds"
- question: "Are there groups of internal hosts all beaconing to the same external service with similar characteristics?"
  context: "This question helps to identify a group of compromised hosts that are part of the same botnet or C2 infrastructure. By using a clustering algorithm like DBSCAN on connection features, analysts can find small, dense clusters of activity. These clusters represent multiple hosts acting in unison, which is a strong indicator of a coordinated C2 campaign."
  answer_sources:
  - "Zeek conn.log"
  - "Windows Event ID 5156"
  - "Network Egress Points (e.g., Firewalls, Proxies), Endpoint Detection and Response (EDR) agents on workstations and servers"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "APPLY DBSCAN_clustering ON network_connections | FEATURES: src_ip, dest_ip, dest_port, byte_counts, inter_arrival_std_dev | INVESTIGATE small, dense clusters"
- question: "Has any single connection to a file sharing or paste site resulted in a large data upload (e.g., >10MB) with a disproportionately high upload-to-download ratio?"
  context: "This question provides a simple, high-confidence method for detecting bulk data exfiltration. Legitimate use of file sharing sites typically involves more balanced data transfer or smaller uploads. A large, one-way upload is highly suspicious and can indicate an adversary stealing a significant volume of data."
  answer_sources:
  - "Zeek conn.log"
  - "Network Egress Points (e.g., Firewalls, Proxies), Data Loss Prevention (DLP) Systems"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH Zeek conn.log WHERE destination is file_sharing_site AND uploaded_bytes > 10MB AND (uploaded_bytes / downloaded_bytes) > 10"
- question: "Is any connection to a web service showing a statistically anomalous upload-to-download byte ratio compared to the historical baseline for that specific service?"
  context: "This question moves beyond simple thresholds to a more robust statistical approach for detecting data exfiltration. Different web services have different typical traffic patterns. By creating a baseline for each service and using a Z-score to find outliers, analysts can detect subtle exfiltration that might be missed by a single, generic rule."
  answer_sources:
  - "Zeek conn.log"
  - "Network Egress Points (e.g., Firewalls, Proxies), Data Loss Prevention (DLP) Systems"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "FOR each connection, CALCULATE ratio = uploaded_bytes / downloaded_bytes | CALCULATE Z-score of ratio against historical_baseline for that service | ALERT if Z-score > 3"
- question: "Can we use a machine learning model to identify network connections that are anomalous across multiple features, and do these anomalies correlate with high upload ratios?"
  context: "This question uses unsupervised machine learning to find 'unknown unknowns' in network traffic. An Isolation Forest or similar model can identify connections that are outliers based on a combination of features (bytes, duration, protocol, etc.). By prioritizing the highest-scoring anomalies that also have high upload-to-download ratios, analysts can efficiently surface the most suspicious exfiltration-like activity."
  answer_sources:
  - "Zeek conn.log"
  - "Network Egress Points (e.g., Firewalls, Proxies), Data Loss Prevention (DLP) Systems"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "APPLY IsolationForest_model ON network_connections | FEATURES: byte_counts, duration, proto, dest_port | INVESTIGATE highest anomaly scores, prioritizing high upload_ratio"
- question: "Is a sensitive system process (e.g., lsass.exe, winlogon.exe) making a direct outbound network connection?"
  context: "This question aims to detect process injection or other techniques where an adversary uses a trusted system process to conduct C2. Core Windows processes like lsass.exe should not be making outbound connections to the internet. An alert on such an event is a high-fidelity indicator of compromise."
  answer_sources:
  - "Windows Event ID 4688"
  - "Windows Event ID 5156"
  - "Sysmon Event ID 1"
  - "Sysmon Event ID 3"
  - "User Workstations, Critical Servers (especially Domain Controllers and Application Servers), Endpoint Detection and Response (EDR) agents"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "JOIN process_logs with network_logs | ALERT if process_name IN (lsass.exe, winlogon.exe, csrss.exe) AND destination_ip is non-local"
- question: "Is a legitimate process (e.g., powershell.exe, svchost.exe) being executed from an unusual file path or with an uncommon parent process?"
  context: "This question helps detect masquerading or 'living off the land' techniques where adversaries place legitimate tools in non-standard locations or launch them from atypical parent processes to evade detection. By baselining normal process behavior and alerting on rare combinations, analysts can spot these suspicious executions."
  answer_sources:
  - "Windows Event ID 4688"
  - "Windows Event ID 5156"
  - "Sysmon Event ID 1"
  - "Sysmon Event ID 3"
  - "User Workstations, Critical Servers (especially Domain Controllers and Application Servers), Endpoint Detection and Response (EDR) agents"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "SEARCH process_logs | ALERT if process_path OR parent_process for a given process_name is rare based on historical frequency"
- question: "Can we use a machine learning model to classify process execution chains as suspicious and correlate them with network C2 activity?"
  context: "This is a sophisticated approach to identify malicious activity based on its entire execution context. A model trained on process lineage can learn complex malicious patterns (e.g., Word spawning PowerShell which then makes a network connection). By flagging suspicious chains and correlating them with network connections to web services, analysts can generate very high-fidelity alerts that link process behavior directly to potential C2."
  answer_sources:
  - "Windows Event ID 4688"
  - "Windows Event ID 5156"
  - "Sysmon Event ID 1"
  - "Sysmon Event ID 3"
  - "User Workstations, Critical Servers (especially Domain Controllers and Application Servers), Endpoint Detection and Response (EDR) agents"
  range: "last 90 days"
  queries:
  - technology: "pseudocode"
    query: "APPLY classification_model ON process_creation_events | FEATURES: parent_process, child_process, cmd_line_entropy | CORRELATE 'suspicious' classifications with subsequent network_connections"