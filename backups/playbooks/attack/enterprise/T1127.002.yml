name: "T1127.002: ClickOnce"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps investigate potential adversary use of ClickOnce applications for defense evasion. It focuses on identifying malicious ClickOnce activity by analyzing network logs for suspicious downloads of .application or .appref-ms files from sources matching threat intelligence or exhibiting risky characteristics. It also examines process execution events for high-fidelity indicators, such as the specific command line 'rundll32.exe dfshim.dll ShOpenVerbApplication', and anomalous child processes spawned by the trusted ClickOnce service 'dfsvc.exe'. Additionally, the playbook correlates network downloads with subsequent process executions and checks for persistence mechanisms, like the placement of .appref-ms files in user Startup folders, to provide a comprehensive view of this evasion technique."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Have any ClickOnce application files (.application, .appref-ms) been downloaded from a domain, IP address, or with a file hash that matches known threat intelligence?"
    context: "This question aims to detect the initial download of a malicious ClickOnce application. By correlating network traffic (HTTP, DNS) and file transfer logs with threat intelligence feeds, analysts can identify when a user's system downloads a ClickOnce file from a known malicious source. A match is a strong indicator of an attempted compromise."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek files.log"
      - "User Workstations"
      - "Internet Gateway/Proxy Servers"
      - "DNS Resolvers"
      - "SIEM/Threat Intelligence Platform"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH network_logs AND file_logs WHERE file_extension IN ['.application', '.appref-ms'] | JOIN on client_ip, timestamp | LOOKUP domain, server_ip, file_hash in threat_intel_feed | RETURN matches"
  - question: "Have any ClickOnce application files been downloaded from domains that are new, unpopular, or rarely seen within the organization?"
    context: "Adversaries often use newly registered or obscure domains to host malicious payloads. This question helps identify downloads from such high-risk domains that might not yet be on a threat intelligence blocklist. By risk-scoring domains based on age, popularity, and internal request frequency, analysts can proactively flag suspicious ClickOnce downloads that deviate from normal software distribution patterns."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek files.log"
      - "User Workstations"
      - "Internet Gateway/Proxy Servers"
      - "DNS Resolvers"
      - "SIEM/Threat Intelligence Platform"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH network_logs WHERE file_extension IN ['.application', '.appref-ms'] | EXTRACT domain | ENRICH domain with age, popularity, internal_frequency | CALCULATE risk_score | RETURN downloads from domains with risk_score > threshold"
  - question: "Can machine learning models identify ClickOnce downloads that exhibit malicious characteristics based on URL and domain features?"
    context: "This question explores using a supervised machine learning model to detect malicious ClickOnce downloads. By training a model on features like URL length, entropy, domain age, and popularity, it's possible to identify downloads that share characteristics with known malicious files, even if the specific indicators are new. This provides a predictive capability to catch novel threats."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Zeek files.log"
      - "User Workstations"
      - "Internet Gateway/Proxy Servers"
      - "DNS Resolvers"
      - "SIEM/Threat Intelligence Platform"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each ClickOnce_download_event | EXTRACT features (url_length, url_entropy, domain_age, etc.) | APPLY trained_ML_model | RETURN events classified as malicious with confidence > threshold"
  - question: "Has 'rundll32.exe' been executed with command line arguments containing both 'dfshim.dll' and 'ShOpenVerbApplication'?"
    context: "This command line is a specific and reliable indicator that a ClickOnce application is being launched. While not always malicious, its presence is a critical event to investigate, as it is a common method used by adversaries to execute their ClickOnce payloads. Any occurrence warrants immediate attention to determine the context and legitimacy of the execution."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Terminal Servers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH process_creation_events WHERE process_name == 'rundll32.exe' AND command_line CONTAINS 'dfshim.dll' AND command_line CONTAINS 'ShOpenVerbApplication' | RETURN matching_events"
  - question: "Has a ClickOnce application been launched by a statistically rare or unusual parent process?"
    context: "Legitimate ClickOnce applications are typically launched by common user processes like 'explorer.exe' or a web browser. Adversaries may launch them from other processes, such as a malicious macro in a Word document ('winword.exe') or a script ('powershell.exe'). This question helps identify anomalous execution chains by flagging ClickOnce launches from parent processes that are not commonly observed in the environment, suggesting a potentially malicious origin."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Terminal Servers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH process_creation_events FOR ClickOnce_launches | GROUP by parent_process | IDENTIFY parent_processes with frequency < 5th_percentile | RETURN events with rare_parent_process"
  - question: "Does the process execution chain leading to a ClickOnce launch deviate from established normal patterns?"
    context: "This question uses process lineage analysis to spot malicious activity. Normal software execution follows predictable paths (e.g., user clicks icon in Explorer, which launches the app). Malicious execution might originate from a phishing email attachment opened in Outlook, which then runs a script that in turn launches the ClickOnce application. By modeling normal process chains and flagging outliers, analysts can uncover these abnormal and potentially malicious execution paths."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Terminal Servers"
      - "Application Servers"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each ClickOnce_launch_event | TRACE parent_process_lineage | COMPARE lineage to baseline_clusters_of_normal_lineage | RETURN events with anomalous_lineage"
  - question: "Has the ClickOnce service process ('dfsvc.exe') spawned a child process that is not on the organizational allowlist?"
    context: "The 'dfsvc.exe' process is part of the .NET Framework and manages ClickOnce applications. It typically spawns a predictable set of child processes. An adversary might exploit this trust to have 'dfsvc.exe' launch a malicious payload, such as a command shell or scripting engine. This question helps detect such abuse by building a baseline of normal child processes and alerting when a new, unapproved process is launched by 'dfsvc.exe'."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Servers with .NET applications"
      - "Virtual Desktop Infrastructure (VDI) environments"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH process_creation_events WHERE parent_process_name == 'dfsvc.exe' | COMPARE process_name against established_allowlist | RETURN events where process_name is NOT in allowlist"
  - question: "Has an allowlisted child process of 'dfsvc.exe' been executed with an unusually long or complex command line?"
    context: "Even if a child process spawned by 'dfsvc.exe' is on the allowlist, adversaries can abuse it by passing malicious arguments. For example, using 'powershell.exe' to run a long, obfuscated command. This question focuses on detecting this by baselining the normal command-line length and entropy for each child process. An alert is triggered if a new execution has command-line parameters that are statistical outliers, indicating potential obfuscation or abuse."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Servers with .NET applications"
      - "Virtual Desktop Infrastructure (VDI) environments"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH process_creation_events WHERE parent_process_name == 'dfsvc.exe' AND process_name IN allowlist | CALCULATE command_line_length, command_line_entropy | COMPARE to baseline | RETURN events where metrics > 98th_percentile"
  - question: "Can an unsupervised machine learning model detect anomalous child process executions spawned by 'dfsvc.exe'?"
    context: "This question leverages unsupervised anomaly detection to identify suspicious child processes of 'dfsvc.exe' without relying on pre-defined rules or allowlists. By training a model on features like command-line length and character counts, the system can learn what 'normal' activity looks like and automatically flag any executions that deviate significantly. This is effective for catching novel or sophisticated attacks that might otherwise be missed."
    answer_sources:
      - "Windows Event ID 4688"
      - "User Workstations"
      - "Servers with .NET applications"
      - "Virtual Desktop Infrastructure (VDI) environments"
    range: "last 90 days"
    queries:
      - "pseudocode: FOR each dfsvc.exe_child_process_event | EXTRACT features (cmd_length, special_chars, etc.) | APPLY trained_anomaly_detection_model | RETURN events with high anomaly_score"
  - question: "Has a ClickOnce application file been downloaded from a non-allowlisted domain and then executed on a host within a short time window?"
    context: "This question provides high-fidelity alerts by correlating two distinct events: the download of a ClickOnce application from an untrusted source and its subsequent execution. A download alone might be benign, but when followed closely by the execution of a ClickOnce handler process ('dfsvc.exe' or 'rundll32.exe'), it strongly suggests the downloaded file was launched. If the source domain is not on an approved list, this sequence of events is highly suspicious."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet Gateway/Proxy Servers"
      - "User Workstations"
      - "DNS Resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH network_logs FOR ClickOnce_downloads from non-allowlisted_domains | CORRELATE with process_events for dfsvc.exe or rundll32.exe on same host within 2 minutes | RETURN correlated_events"
  - question: "Have any ClickOnce files been downloaded from a server that has only been accessed by a very small number of internal clients (long-tail distribution)?"
    context: "Legitimate software distribution points are typically accessed by many clients across an organization. In contrast, a malicious server set up for a targeted attack may only be accessed by one or a few victims. This question helps identify these 'long-tail' servers by analyzing the distribution of client connections. A download from a server that serves very few clients is an anomaly and could indicate a targeted attack."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet Gateway/Proxy Servers"
      - "User Workstations"
      - "DNS Resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH network_logs FOR ClickOnce_downloads | GROUP by server_ip | COUNT distinct client_ips | IDENTIFY server_ips with client_count < 5th_percentile | RETURN downloads from those servers"
  - question: "Has there been an anomalous spike in the overall volume of ClickOnce file downloads across the organization?"
    context: "A widespread phishing campaign or automated attack could result in a sudden, significant increase in the number of ClickOnce file downloads across the enterprise. This question uses time-series analysis to model the expected download volume and detect unusual spikes. An alert on a volume anomaly can provide an early warning of a large-scale, coordinated attack."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Internet Gateway/Proxy Servers"
      - "User Workstations"
      - "DNS Resolvers"
    range: "last 90 days"
    queries:
      - "pseudocode: AGGREGATE hourly count of ClickOnce_downloads | APPLY time-series_forecasting_model | RETURN hours where actual_count > predicted_upper_bound"
  - question: "Has a ClickOnce application reference file (.appref-ms) been written to a user's Startup folder?"
    context: "Placing a file in the Windows Startup folder is a classic persistence technique. When an adversary places a '.appref-ms' file there, the malicious ClickOnce application will automatically launch every time the user logs in. This question uses file system auditing to detect this specific action, which is a high-fidelity indicator of an attempt to establish persistence."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "User Startup Folders on Endpoints"
      - "File System Audit Logs"
      - "Domain Controllers (for GPO-based monitoring)"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH file_audit_events WHERE event_id == 4663 AND object_path CONTAINS '\\Start Menu\\Programs\\Startup' AND object_name ENDS WITH '.appref-ms' | RETURN matching_events"
  - question: "Are there any rare or non-standard ClickOnce application reference files (.appref-ms) present in user Startup folders across the enterprise?"
    context: "Legitimate software deployed to run at startup is typically installed on many machines. A malicious '.appref-ms' file used for persistence in a targeted attack may only exist on one or a few compromised systems. This question aims to find these outliers by inventorying all startup '.appref-ms' files and flagging those with very low prevalence, which are not part of a known, widespread software deployment."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "User Startup Folders on Endpoints"
      - "File System Audit Logs"
      - "Domain Controllers (for GPO-based monitoring)"
    range: "last 90 days"
    queries:
      - "pseudocode: INVENTORY all '.appref-ms' files in Startup folders | GROUP by file_hash | CALCULATE prevalence (count of endpoints) | RETURN files with prevalence < threshold AND not in known_good_list"
  - question: "Can an unsupervised machine learning model identify anomalous '.appref-ms' files in Startup folders based on their properties?"
    context: "This question uses unsupervised clustering to identify malicious startup files without prior knowledge. By analyzing features like file name entropy, size, and digital signature status, a model can group legitimate files together. Malicious '.appref-ms' files, which may have randomized names or lack a valid signature, will likely not fit into these clusters and will be flagged as outliers or 'noise' points, highlighting them for investigation."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4688"
      - "User Startup Folders on Endpoints"
      - "File System Audit Logs"
      - "Domain Controllers (for GPO-based monitoring)"
    range: "last 90 days"
    queries:
      - "pseudocode: INVENTORY all files in Startup folders | EXTRACT features (extension, name_entropy, size, signed_status) | APPLY clustering_model | RETURN '.appref-ms' files classified as outliers"