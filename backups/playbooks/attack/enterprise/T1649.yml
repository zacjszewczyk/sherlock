name: T1649: Steal or Forge Authentication Certificates
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps investigate whether an adversary has accessed credentials
  by stealing or forging authentication certificates. This involves detecting the
  use of known certificate theft tools, anomalous execution of legitimate utilities,
  suspicious command-line arguments, policy-violating certificate requests, unauthorized
  access to cryptographic keys, anomalous certificate-based logons, and the exfiltration
  of certificate files from the network.
type: technique
related:
- TA0006: Credential Access
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are known certificate theft or manipulation tools being executed in the
    environment?
  context: This question aims to identify the direct use of malicious tools like
    Certipy, Mimikatz, or Rubeus. Detecting their execution via file hash is a high-confidence
    indicator of compromise. This is a primary, signature-based detection method
    for this technique.
  answer_sources:
  - Windows Event ID 4688
  - Zeek x509.log
  - Domain Controllers, Certificate Authority Servers, All Endpoints, Network Egress
    Points
  range: last 90 days
  queries:
  - technology: SIEM
    query: JOIN (process_events WHERE event_id=4688) WITH (watchlist_hashes) ON process_hash.
      GENERATE alert.
  - technology: SIEM
    query: JOIN (network_events WHERE event_source='zeek_x509') WITH (watchlist_cert_thumbs)
      ON certificate_thumbprint. GENERATE alert.
- question: Is there an anomalous execution frequency of legitimate certificate management
    tools?
  context: Adversaries often abuse legitimate tools (`certutil.exe`, `certlm.msc`)
    to avoid signature-based detection. This question helps uncover such 'living-off-the-land'
    behavior by baselining normal execution frequency and flagging significant deviations,
    which could indicate malicious enumeration or manipulation.
  answer_sources:
  - Windows Event ID 4688
  - Zeek x509.log
  - Domain Controllers, Certificate Authority Servers, All Endpoints, Network Egress
    Points
  range: last 90 days
  queries:
  - technology: SIEM/UBA
    query: BASELINE execution_count_per_hour for certutil.exe, certlm.msc by host_role.
      ALERT when count > 99th_percentile.
- question: Can a machine learning model identify suspicious process executions related
    to certificate management?
  context: This question focuses on detecting novel or unknown threats that evade
    signature and simple anomaly detection. By training a model on features like
    parent-child process relationships, command-line entropy, and user context, it's
    possible to assign a risk score to any process execution, flagging high-risk
    events that may represent previously unseen certificate theft tools or techniques.
  answer_sources:
  - Windows Event ID 4688
  - Zeek x509.log
  - Domain Controllers, Certificate Authority Servers, All Endpoints, Network Egress
    Points
  range: last 90 days
  queries:
  - technology: ML Platform
    query: TRAIN classifier on enriched_process_events. PREDICT risk_score for new_process_events.
      FLAG high_risk_scores.
- question: Are command-line arguments indicative of certificate abuse present in
    process or script logs?
  context: Adversaries using tools like Certipy, Mimikatz, or Rubeus often leave
    traces in command-line arguments. This question uses specific, high-fidelity
    regular expressions to search for known malicious command patterns, providing
    a strong signal of active certificate compromise attempts.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Domain Controllers, Certificate Authority Servers, All Endpoints with PowerShell/CMD
    access
  range: last 90 days
  queries:
  - technology: SIEM
    query: SCAN command_lines from event_id IN (4688, 4104) with regex_patterns for
      ('certipy find', 'mimikatz crypto::'). ALERT on match.
- question: Are there command-line arguments with unusually high entropy, suggesting
    obfuscation?
  context: To evade simple keyword-based detection, attackers often obfuscate or
    encode their commands. This results in command-line arguments with higher-than-normal
    character randomness (entropy). This question aims to detect such obfuscation
    by baselining command-line entropy for common processes and flagging significant
    deviations.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Domain Controllers, Certificate Authority Servers, All Endpoints with PowerShell/CMD
    access
  range: last 90 days
  queries:
  - technology: SIEM/UBA
    query: BASELINE cmd_line_entropy for powershell.exe, cmd.exe, certutil.exe by
      user/host. ALERT when entropy > 3 * std_dev.
- question: Can a Natural Language Processing (NLP) model detect novel or obfuscated
    command-line attacks related to certificates?
  context: This question proposes a more advanced method to overcome the limitations
    of regex and simple entropy analysis. A fine-tuned NLP model can understand the
    semantic structure of a command, allowing it to identify malicious intent even
    in novel or heavily obfuscated command lines that other methods would miss.
  answer_sources:
  - Windows Event ID 4688
  - Windows PowerShell Event ID 4104
  - Domain Controllers, Certificate Authority Servers, All Endpoints with PowerShell/CMD
    access
  range: last 90 days
  queries:
  - technology: ML Platform
    query: TRAIN NLP_classifier on labeled_command_lines. CLASSIFY new command_lines
      as (benign, suspicious, malicious).
- question: Are there certificate enrollment requests that violate established security
    policies?
  context: Attackers may exploit misconfigurations in Active Directory Certificate
    Services (AD CS) to request certificates that grant them elevated privileges (e.g.,
    ESC1). This question focuses on enforcing a strict security policy by creating
    rules that alert on any request that falls outside of a predefined allow-list
    of user/group and template pairings, or on requests for highly sensitive templates
    from unauthorized machines.
  answer_sources:
  - Windows Event ID 4886
  - Windows Event ID 4898
  - Windows Event ID 4887
  - Active Directory Certificate Authority (CA) Servers
  range: last 90 days
  queries:
  - technology: SIEM
    query: ON event_id=4886, ALERT if (user, template) not in allow_list OR if SAN
      is specified on vulnerable template.
- question: Are there statistically rare certificate requests or an unusual spike
    in failed requests?
  context: Before successfully exploiting a misconfiguration, an attacker may probe
    the Certificate Authority. This can manifest as a user requesting a certificate
    template they've never requested before, or a sudden spike in failed requests
    as they try different parameters. This question aims to detect this precursor
    activity by identifying statistically rare requests and anomalous failure rates.
  answer_sources:
  - Windows Event ID 4886
  - Windows Event ID 4898
  - Windows Event ID 4887
  - Active Directory Certificate Authority (CA) Servers
  range: last 90 days
  queries:
  - technology: SIEM/UBA
    query: CALCULATE rarity_score for each (requester, template) pair from event_id=4886.
      ALERT on high_rarity. BASELINE failed_request_rate (event_id=4887) per user.
      ALERT on spike > 3 * std_dev.
- question: Does a time-series model detect anomalous patterns in certificate request
    volumes?
  context: Automated tools used by attackers can cause sudden, significant changes
    in the volume of certificate requests, both successful and failed. This question
    proposes using a time-series model to learn the normal rhythm of CA activity
    and automatically flag anomalous spikes in request volumes for specific templates,
    which could indicate a large-scale abuse attempt.
  answer_sources:
  - Windows Event ID 4886
  - Windows Event ID 4898
  - Windows Event ID 4887
  - Active Directory Certificate Authority (CA) Servers
  range: last 90 days
  queries:
  - technology: ML Platform
    query: TRAIN time-series_model on request_volume (event_id=4898, 4887) per template.
      DETECT and ALERT on anomalous spikes.
- question: Is an unauthorized process exporting a cryptographic key?
  context: The private keys associated with certificates are highly sensitive. Their
    export should be a rare and tightly controlled event. This question creates a
    high-confidence alert by monitoring for key export events and checking if the
    process performing the export is on a strict allow-list of approved applications.
  answer_sources:
  - Windows Event ID 5058
  - Windows Event ID 5059
  - Windows Event ID 4663
  - Windows Event ID 4688
  - All Endpoints and Servers, especially Domain Controllers and Certificate Authority
    Servers
  range: last 90 days
  queries:
  - technology: SIEM
    query: ON event_id=5058 where operation='Export', get process_name from event_id=4688
      via process_id. ALERT if process_name not in allow_list.
- question: Is a user performing a key export for the first time or a process excessively
    accessing key storage directories?
  context: This question provides two behavioral-based methods to detect key theft.
    First, it flags the first time a user ever exports a key, as this is a potentially
    suspicious action. Second, it detects brute-force or enumeration attempts against
    the key store by alerting when a single process accesses an unusually high number
    of files in the protected crypto directories within a short time frame.
  answer_sources:
  - Windows Event ID 5058
  - Windows Event ID 5059
  - Windows Event ID 4663
  - Windows Event ID 4688
  - All Endpoints and Servers, especially Domain Controllers and Certificate Authority
    Servers
  range: last 90 days
  queries:
  - technology: SIEM/UBA
    query: BASELINE users who perform key_export (event_id=5058). ALERT on first-time
      export. BASELINE file_access_count (event_id=4663) to crypto_dirs per process.
      ALERT if count > 98th_percentile in 1min.
- question: Can an unsupervised model detect anomalous access patterns to cryptographic
    keys or their storage locations?
  context: Attackers may use novel techniques to access private keys that evade rule-based
    detections. This question suggests using an unsupervised machine learning model
    to learn the complex patterns of normal key access (user, process, key, time
    of day). The model can then identify rare and suspicious combinations of these
    features that represent a deviation from normal behavior.
  answer_sources:
  - Windows Event ID 5058
  - Windows Event ID 5059
  - Windows Event ID 4663
  - Windows Event ID 4688
  - All Endpoints and Servers, especially Domain Controllers and Certificate Authority
    Servers
  range: last 90 days
  queries:
  - technology: ML Platform
    query: TRAIN isolation_forest_model on features from key_access_events (5058,
      5059, 4663). IDENTIFY and ALERT on outliers.
- question: Is a privileged account, not expected to use certificate-based logon,
    authenticating with a certificate?
  context: Certain accounts, especially highly privileged service accounts or administrative
    accounts, may not be expected to perform interactive logons using certificates.
    This question establishes a rule to monitor for such unexpected behavior, which
    could indicate that an attacker has stolen a certificate and is using it for
    privilege escalation or lateral movement.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Zeek x509.log
  - Domain Controllers, Authentication Servers (RADIUS/NPS), VPN Concentrators, Network
    Gateways
  range: last 90 days
  queries:
  - technology: SIEM
    query: ON event_id=4624 with logon_type in ('Network', 'RemoteInteractive') and
      auth_package in ('Kerberos', 'Schannel') with cert_usage, ALERT if user in privileged_watchlist.
- question: Has an 'impossible travel' scenario or a logon from an unknown network
    occurred with a certificate?
  context: A hallmark of credential theft is when the credential is used from a location
    inconsistent with the legitimate user's behavior. This question aims to detect
    this by identifying certificate-based logons that are geographically impossible
    given the user's previous logon location, or that originate from an Autonomous
    System (network) never before seen for that user.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Zeek x509.log
  - Domain Controllers, Authentication Servers (RADIUS/NPS), VPN Concentrators, Network
    Gateways
  range: last 90 days
  queries:
  - technology: SIEM/UBA
    query: ON cert_logon, get source_ip_location. CALCULATE travel_speed from previous_logon.
      ALERT on 'impossible_travel'. BASELINE known_ASN_per_user. ALERT on new_ASN.
- question: Is a user's certificate authentication behavior deviating significantly
    from their peer group's norm?
  context: Users in similar roles (e.g., all accountants) tend to exhibit similar
    authentication behavior. This question leverages this by grouping users into
    peer groups and modeling their collective behavior. An alert is generated when
    an individual's certificate authentication patterns—such as logging into unusual
    systems—deviate significantly from their peers, which may indicate account compromise.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - Zeek x509.log
  - Domain Controllers, Authentication Servers (RADIUS/NPS), VPN Concentrators, Network
    Gateways
  range: last 90 days
  queries:
  - technology: ML Platform
    query: CLUSTER users into peer_groups based on roles. DEFINE normal_auth_behavior_centroid
      for each group. ALERT when a user's auth_behavior deviates from their group_centroid.
- question: Is an unauthorized process writing certificate files to a sensitive or
    unusual directory?
  context: Attackers often stage stolen data, such as exported certificates (.pfx,
    .p12 files), in temporary or public directories before exfiltration. This question
    involves setting up file system auditing to monitor for the creation of certificate
    files in these locations and alerting if the process creating the file is not
    an approved application (like a web browser or enrollment client).
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek files.log
  - User Workstations, File Servers, Web Servers, Network Egress Points
  range: last 90 days
  queries:
  - technology: SIEM
    query: ON event_id=4663 with file_extension in (.pfx, .p12, .pem) in sensitive_dirs,
      ALERT if process_name not in allow_list.
- question: Is there an anomalous volume of certificate files being exfiltrated over
    the network?
  context: The exfiltration of certificate files can be detected by monitoring network
    traffic. This question uses network monitoring data (like Zeek logs) to baseline
    the normal volume of certificate files being transferred out of the network and
    alerts when this volume significantly exceeds the established norm, potentially
    indicating data theft.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek files.log
  - User Workstations, File Servers, Web Servers, Network Egress Points
  range: last 90 days
  queries:
  - technology: SIEM/UBA
    query: FROM zeek_files_log, BASELINE hourly_volume of outbound files with MIME_type='application/x-pkcs12'.
      ALERT when volume > 95th_percentile.
- question: Has the specific sequence of a certificate file write followed by a network
    exfiltration by the same process occurred?
  context: This question seeks to identify a high-confidence chain of events that
    strongly indicates theft and exfiltration. By correlating events, it looks for
    a single process that first writes a certificate file to disk and then, within
    a short time window, initiates an outbound network connection over which that
    file is transferred. This sequence is highly indicative of malicious activity.
  answer_sources:
  - Windows Event ID 4663
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek files.log
  - User Workstations, File Servers, Web Servers, Network Egress Points
  range: last 90 days
  queries:
  - technology: SIEM
    query: CORRELATE events by process_guid within 2min. ALERT if sequence [file_write
      (event_id=4663, ext=.pfx), network_connection (zeek_conn), file_transfer (zeek_files)]
      occurs.