name: 'T1505.004: IIS Components'
id: f5d2b1a0-3e8c-4b9a-8f6d-7c1e0a9b3d4f
description: |
  This playbook helps investigate whether an adversary is maintaining persistence on web servers by using malicious IIS components. This can manifest in several ways, including the IIS worker process (w3wp.exe) making outbound network connections to malicious destinations, the execution of commands like AppCmd.exe or PowerShell cmdlets to install or modify IIS modules, the creation of new DLLs in sensitive IIS directories or modifications to the main applicationhost.config file, the w3wp.exe process spawning unusual child processes like command shells, w3wp.exe network traffic exhibiting anomalous characteristics (e.g., unusual ports, data volumes, or beaconing behavior), and the loading of unsigned, rare, or recently created DLLs into the w3wp.exe process.
type: technique
related:
  - 'TA0003: Persistence'
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is the IIS worker process (w3wp.exe) making outbound network connections to known malicious command and control (C2) servers or domains?
    context: |
      This question seeks to identify direct communication from a web server's core process to known malicious infrastructure. A match provides a high-confidence indicator of compromise, as w3wp.exe should typically only communicate with backend databases, APIs, or legitimate update services, not with known C2 servers.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5156
      - Windows Event ID 3 (Sysmon)
      - IIS Web Servers
      - DMZ Network Segment
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: Correlate w3wp.exe process network events with network flow data. Check destination IP/domain against threat intelligence feeds.
  - question: Is the IIS worker process (w3wp.exe) exhibiting signs of Domain Generation Algorithm (DGA) activity by making an unusually high number of unique DNS requests?
    context: |
      DGAs are used by malware to periodically generate a large number of domain names that can be used for C2 communication. A sharp increase in the entropy of DNS queries originating from w3wp.exe can indicate that a malicious IIS component is attempting to 'phone home' using DGA.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5156
      - Windows Event ID 3 (Sysmon)
      - IIS Web Servers
      - DMZ Network Segment
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: For w3wp.exe network traffic, calculate the entropy of requested FQDNs over a 1-hour window. Alert if entropy exceeds the 99th percentile of the historical baseline.
  - question: Is the IIS worker process (w3wp.exe) generating an anomalous volume of outbound network connections that deviates from its established baseline?
    context: |
      This question aims to detect unusual spikes in network activity from w3wp.exe. A time-series model learns the normal rhythm of connections. A significant deviation from this predicted rhythm can indicate a new malicious module initiating communication for data exfiltration or C2.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5156
      - Windows Event ID 3 (Sysmon)
      - IIS Web Servers
      - DMZ Network Segment
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - pseudocode: Using a time-series model (e.g., Prophet, ARIMA) on w3wp.exe outbound connection volume, alert when observed count significantly exceeds the predicted upper confidence interval.
  - question: Has an administrator or process used AppCmd.exe or specific PowerShell cmdlets to install, register, or modify an IIS module, handler, or filter?
    context: |
      Adversaries may use built-in IIS administration tools to install malicious components for persistence. This question looks for the specific command-line arguments and PowerShell cmdlets (e.g., 'install module', 'New-IISModule') that indicate such activity, which should be rare outside of planned maintenance.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Windows PowerShell Event ID 4104
      - Windows PowerShell Event ID 800
      - IIS Web Servers
      - Administrator Workstations
      - Jump Servers
    range: last 90 days
    queries:
      - pseudocode: Search command-line logs for AppCmd.exe with suspicious arguments ('install module', 'add module') or PowerShell logs for cmdlets like 'New-IISModule' or 'Set-WebConfigurationProperty'.
  - question: Is a user account executing IIS administration commands (AppCmd.exe, IIS PowerShell cmdlets) at a frequency that is statistically unusual for that user or their peers?
    context: |
      While legitimate administrators use these tools, their usage patterns are typically predictable. This question identifies outliers by flagging users who execute these commands far more frequently than their baseline, especially at odd hours, suggesting potential account compromise or malicious insider activity.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Windows PowerShell Event ID 4104
      - Windows PowerShell Event ID 800
      - IIS Web Servers
      - Administrator Workstations
      - Jump Servers
    range: last 90 days
    queries:
      - pseudocode: Baseline the frequency of IIS command execution per user. Alert if a user's execution count in a 24-hour period exceeds 3 standard deviations from their baseline.
  - question: Is there evidence of malicious IIS-related command-line executions based on a machine learning classification model?
    context: |
      This question leverages a model trained to recognize the patterns and characteristics of malicious commands. By scoring every IIS-related command line, it can uncover novel or obfuscated attack variations that might be missed by simple keyword-based rules.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Windows PowerShell Event ID 4104
      - Windows PowerShell Event ID 800
      - IIS Web Servers
      - Administrator Workstations
      - Jump Servers
    range: last 90 days
    queries:
      - pseudocode: Score the maliciousness of IIS-related command-line arguments using a trained classification model. Alert on high scores.
  - question: Has a new DLL been created in a sensitive IIS directory by an unauthorized process, or has the applicationhost.config file been modified outside of a change window?
    context: |
      This question targets the direct evidence of a malicious module being dropped or registered. Unauthorized processes (e.g., anything other than a trusted installer) writing DLLs to key IIS folders or any modification to the core IIS config file outside of planned maintenance are strong indicators of compromise.
    answer_sources:
      - Windows Event ID 11 (Sysmon)
      - Windows Event ID 1 (Sysmon)
      - Windows Event ID 4663
      - File Integrity Monitoring (FIM) Logs
      - File systems of IIS Web Servers, specifically the directories '%windir%\System32\inetsrv\', '%windir%\assembly\', application-specific 'bin' folders, and the '%windir%\System32\inetsrv\config\' directory.
    range: last 90 days
    queries:
      - pseudocode: Alert on DLL file creation in IIS directories by non-allowlisted processes. Use FIM to alert on changes to applicationhost.config outside of change windows.
  - question: Is a statistically rare process writing files, particularly DLLs, to sensitive IIS-related directories?
    context: |
      Legitimate file writes in IIS directories are typically performed by a small, predictable set of processes. This question establishes a baseline of normal activity and alerts when an unusual process, like the web server worker process itself (w3wp.exe) or a command shell, writes a file, which could indicate a web shell or other exploit is being used to drop a persistence mechanism.
    answer_sources:
      - Windows Event ID 11 (Sysmon)
      - Windows Event ID 1 (Sysmon)
      - Windows Event ID 4663
      - File Integrity Monitoring (FIM) Logs
      - File systems of IIS Web Servers, specifically the directories '%windir%\System32\inetsrv\', '%windir%\assembly\', application-specific 'bin' folders, and the '%windir%\System32\inetsrv\config\' directory.
    range: last 90 days
    queries:
      - pseudocode: Profile processes that write to IIS directories. Alert when a rare process (e.g., w3wp.exe, cmd.exe) writes a DLL file.
  - question: Are there anomalous clusters of file modification events in IIS directories that deviate from normal administrative activity?
    context: |
      This question uses unsupervised machine learning to find "the unknown unknowns." By clustering all file modification events based on features like the process, user, and time, it can automatically identify small, distinct groups of activity that don't match the large, dense clusters of routine operations, pointing analysts toward potentially malicious behavior.
    answer_sources:
      - Windows Event ID 11 (Sysmon)
      - Windows Event ID 1 (Sysmon)
      - Windows Event ID 4663
      - File Integrity Monitoring (FIM) Logs
      - File systems of IIS Web Servers, specifically the directories '%windir%\System32\inetsrv\', '%windir%\assembly\', application-specific 'bin' folders, and the '%windir%\System32\inetsrv\config\' directory.
    range: last 90 days
    queries:
      - pseudocode: Use a clustering algorithm (e.g., DBSCAN) on file modification events in IIS directories. Flag clusters distant from normal activity clusters.
  - question: Has the IIS worker process (w3wp.exe) spawned a suspicious child process, such as a command shell or reconnaissance tool?
    context: |
      The w3wp.exe process should not typically spawn child processes, especially not interactive shells (cmd.exe, powershell.exe) or system utilities. Such an event is a very strong indicator that a malicious IIS module has been loaded and is executing commands on the system.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Process execution environment on all IIS Web Servers.
    range: last 90 days
    queries:
      - pseudocode: Alert when w3wp.exe is the parent process for suspicious child processes like cmd.exe, powershell.exe, cscript.exe, net.exe, or whoami.exe.
  - question: Has the IIS worker process (w3wp.exe) spawned a child process that is rare or has never been seen before in the environment?
    context: |
      This question aims to detect anomalous child processes without relying on a predefined blocklist. By baselining all child processes of w3wp.exe across the server fleet, any process that is statistically rare or entirely new can be flagged for investigation, providing a way to catch novel tools or techniques.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Process execution environment on all IIS Web Servers.
    range: last 90 days
    queries:
      - pseudocode: Baseline all child processes of w3wp.exe. Alert when a spawned child process is new or in the bottom 5th percentile of frequency.
  - question: Does the sequence of process executions originating from w3wp.exe deviate from learned normal patterns?
    context: |
      Malicious activity often involves a specific chain of command executions (e.g., w3wp.exe -> cmd.exe -> whoami.exe). This question uses a sequence analysis model to learn the normal, legitimate process chains and flags any sequence that deviates significantly, indicating a potential intrusion.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 1 (Sysmon)
      - Process execution environment on all IIS Web Servers.
    range: last 90 days
    queries:
      - pseudocode: Use a sequence analysis model (e.g., HMM, LSTM) to learn normal process execution sequences following w3wp.exe. Flag significant deviations.
  - question: Is the IIS worker process (w3wp.exe) making outbound network connections to non-standard ports or to raw IP addresses without a recent DNS query?
    context: |
      Legitimate web server traffic is typically directed to standard ports like 80, 443, or specific database ports. Connections to unusual ports or to IP addresses directly (to evade DNS monitoring) are hallmarks of C2 channels or data exfiltration and warrant immediate investigation.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Windows Event ID 3 (Sysmon)
      - DMZ Network Segment
      - Network Egress Points
      - IIS Web Servers
    range: last 90 days
    queries:
      - pseudocode: Alert when w3wp.exe connects to a non-approved port or to a raw IP with no preceding DNS query.
  - question: Is the IIS worker process (w3wp.exe) exhibiting outlier network behavior in terms of data volume or connection timing (beaconing)?
    context: |
      This question seeks to identify C2 activity through its statistical properties. An unusually large data transfer could be data exfiltration. Highly periodic connections with low variance in their timing (e.g., a connection every 60 seconds) are a classic sign of malware beaconing.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Windows Event ID 3 (Sysmon)
      - DMZ Network Segment
      - Network Egress Points
      - IIS Web Servers
    range: last 90 days
    queries:
      - pseudocode: Use IQR to find outlier data transfer volumes. Monitor inter-arrival times for connections to the same destination to detect low variance (beaconing).
  - question: Are there anomalous clusters of network connections from w3wp.exe that suggest a new command and control channel?
    context: |
      This question uses unsupervised machine learning to group network connections by their characteristics (port, protocol, size, destination, etc.). A small, new cluster with unusual properties, like long-lived connections to a residential ISP, can represent a previously unknown C2 channel that differs from all established, legitimate traffic patterns.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Windows Event ID 3 (Sysmon)
      - DMZ Network Segment
      - Network Egress Points
      - IIS Web Servers
    range: last 90 days
    queries:
      - pseudocode: Use a clustering algorithm (e.g., K-Means) on w3wp.exe network connection features. Investigate new, small clusters with unusual characteristics.
  - question: Is the IIS worker process (w3wp.exe) loading an unsigned DLL or a DLL from an unusual file path?
    context: |
      Most legitimate DLLs, especially those loaded by a core system process like w3wp.exe, are digitally signed by a trusted publisher. The loading of an unsigned module is highly suspicious. Similarly, legitimate IIS modules are loaded from specific system directories; a DLL being loaded from a temporary or user-writable folder is a red flag for a malicious implant.
    answer_sources:
      - Windows Event ID 7 (Sysmon)
      - Windows Event ID 11 (Sysmon)
      - Process memory space and file system of all IIS Web Servers.
    range: last 90 days
    queries:
      - pseudocode: Alert on w3wp.exe image load events where the DLL is unsigned or the path is an unusual location (e.g., C:\Temp\).
  - question: Is the IIS worker process (w3wp.exe) loading a DLL that is statistically rare across the environment, especially if it was recently created?
    context: |
      Adversaries often use custom or uncommon tools. This question identifies loaded modules that have a very low prevalence across all servers, making them suspicious. The suspicion is greatly increased if the rare DLL was also created on the system very recently (e.g., within the last 24 hours), suggesting it was just dropped by an attacker.
    answer_sources:
      - Windows Event ID 7 (Sysmon)
      - Windows Event ID 11 (Sysmon)
      - Process memory space and file system of all IIS Web Servers.
    range: last 90 days
    queries:
      - pseudocode: Maintain a prevalence-ranked list of all DLLs loaded by w3wp.exe. Alert on loads of low-prevalence DLLs, especially if the file was created recently.
  - question: Does a DLL loaded by w3wp.exe have a high probability of being malicious based on a machine learning classification model?
    context: |
      This question uses a model trained on a variety of features (e.g., signature status, file path, import hash, prevalence) to provide a holistic assessment of a loaded DLL. This approach can identify sophisticated malicious modules that might evade simpler checks by, for example, using a stolen but valid certificate.
    answer_sources:
      - Windows Event ID 7 (Sysmon)
      - Windows Event ID 11 (Sysmon)
      - Process memory space and file system of all IIS Web Servers.
    range: last 90 days
    queries:
      - pseudocode: Use a classification model on DLL load event features (IsSigned, Signer, path entropy, prevalence, Imphash) to score the probability of maliciousness.