name: T1021: Remote Services
id: c8a9b1d3-6e4f-4a7b-9c8d-1e2f3a4b5c6d
description: This playbook focuses on detecting adversarial lateral movement accomplished through the use of legitimate remote services like RDP, SSH, and WinRM. It provides investigative questions to identify this activity by monitoring for connections from suspicious internal hosts, analyzing post-login process execution for malicious tools, flagging statistically rare or first-time connections, identifying "fan-out" pivot behavior, and detecting the use of non-standard ports for these services.
type: technique
related:
  - TA0008: Lateral Movement
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there any successful remote service connections originating from hosts on our internal watchlist of suspicious or compromised systems?
    context: This question aims to detect lateral movement attempts from an already identified foothold. By maintaining a watchlist of suspicious internal hosts, we can prioritize alerts for remote access activity that originates from a known-bad source, indicating an adversary is actively moving through the network.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs on Domain Controllers
      - Network traffic logs from core switches and perimeter firewalls
      - Security event logs on Tier 0/1 servers and Privileged Access Workstations (PAWs)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH remote_logins (EventID 4624, LogonType 10) OR remote_connections (Zeek conn.log on ports {3389, 22, 5985, 5986}) WHERE source_ip IN watchlist OR source_hostname IN watchlist
  - question: Has a host on the suspicious watchlist exhibited a statistically significant increase in outbound remote service connections?
    context: This question seeks to identify anomalous lateral movement behavior from a compromised host using statistical methods. A sudden spike in the number of outbound connections compared to its historical baseline can indicate automated scripting or active 'fan-out' by an adversary, even if the individual destinations aren't suspicious on their own.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs on Domain Controllers
      - Network traffic logs from core switches and perimeter firewalls
      - Security event logs on Tier 0/1 servers and Privileged Access Workstations (PAWs)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host IN watchlist; CALCULATE baseline (mean, stddev) of hourly outbound remote connections over 30 days. ALERT IF current_hour_connection_count > (mean + 3 * stddev)
  - question: Can machine learning classify a new remote connection from a watchlist host as malicious based on historical patterns?
    context: This question leverages a supervised machine learning model to provide a more nuanced risk score for remote connections. By training on features from known-good and known-bad historical connections, the model can identify subtle combinations of factors (like user privileges, time of day, and subnets) that indicate a high probability of malicious intent.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs on Domain Controllers
      - Network traffic logs from core switches and perimeter firewalls
      - Security event logs on Tier 0/1 servers and Privileged Access Workstations (PAWs)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new remote connection from watchlist_host; EXTRACT features (source/dest subnet, user privilege, time, protocol). SCORE event with trained_ML_model. ALERT IF score > high_confidence_threshold
  - question: Was a known lateral movement tool or suspicious command executed on a host shortly after a remote login?
    context: This question aims to find evidence of an adversary's post-exploitation actions immediately following a successful remote login. Correlating the login with subsequent process creation events within a short time window helps directly link the remote access to the execution of malicious tools or commands.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Process and command-line logs on Domain Controllers, Member Servers, Application Servers, and Privileged Access Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN (EventID 4624 AND LogonType IN {3, 10}) with (EventID 4688) on hostname where process_creation_time is within 5 minutes of login_time. FILTER where process_name or command_line MATCHES regex_list ('psexec.exe', 'wmic.exe', 'powershell.exe -enc').
  - question: Did a command with unusually high entropy execute on a host shortly after a remote login?
    context: This question attempts to detect obfuscated or encoded commands that adversaries use to hide their actions. High Shannon entropy in a command line is a strong indicator of obfuscation (e.g., PowerShell Base64 encoding). Checking for this after a remote login can reveal malicious payloads being delivered or executed.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Process and command-line logs on Domain Controllers, Member Servers, Application Servers, and Privileged Access Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each command executed within 5 mins of a remote login; CALCULATE shannon_entropy of command_line. ALERT IF entropy_score > 95th_percentile_of_baseline.
  - question: Was an anomalous sequence of processes executed on a host following a remote login?
    context: This question uses sequence analysis to detect deviations from normal administrative behavior. Adversaries often run a predictable series of discovery commands (whoami, ipconfig, net user) after gaining access. A model trained on normal user behavior can flag these unusual sequences, even if the individual commands are legitimate.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4688
      - Process and command-line logs on Domain Controllers, Member Servers, Application Servers, and Privileged Access Workstations
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each sequence of processes post-login; FEED sequence into anomaly_detection_model. ALERT IF model flags sequence as a significant deviation from learned normal behavior.
  - question: Has a remote connection occurred between a user and host (or source/destination pair) for the first time?
    context: This question is designed to detect novel lateral movement pathways. Adversaries establishing new access routes will create connections that have never been seen before. By tracking all historical remote access tuples, we can easily identify and flag these 'first-time' events for review, as they represent a change from established network behavior.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs from Domain Controllers and member servers
      - VPN concentrator logs
      - Cloud IaaS access logs
      - Network flow data from all internal network segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new remote login; CREATE tuple (user, source, destination, protocol). IF tuple NOT IN historical_access_table; ALERT for 'first-time access'. ADD tuple to table.
  - question: Was a remote connection statistically rare compared to all other connections in the environment?
    context: This question helps prioritize investigations by focusing on the most infrequent and therefore most suspicious connections. By modeling the network as a graph and weighting connections by frequency, we can assign a rarity score to every new login. Highly rare connections are more likely to be adversarial than common, everyday administrative access.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs from Domain Controllers and member servers
      - VPN concentrator logs
      - Cloud IaaS access logs
      - Network flow data from all internal network segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new remote login; CALCULATE rarity_score based on inverse frequency from historical connection graph. ALERT IF rarity_score > 98th_percentile.
  - question: Does a user's remote access behavior deviate significantly from their established cluster of activity?
    context: This question uses unsupervised machine learning to detect when a user's account behaves anomalously, which could indicate a compromise. By clustering users based on their typical access patterns (e.g., hosts they connect to, times of day), we can identify a new login that falls outside their normal cluster, flagging it as a potential compromise.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - Authentication logs from Domain Controllers and member servers
      - VPN concentrator logs
      - Cloud IaaS access logs
      - Network flow data from all internal network segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new remote login; UPDATE user's feature vector. RUN clustering algorithm (DBSCAN). ALERT IF user is classified as a 'noise' point, indicating behavioral deviation.
  - question: Has a host received a remote connection and then initiated numerous outbound connections to other internal hosts?
    context: This question seeks to identify an adversary using a compromised host as a pivot point to "fan-out" to other systems in the network. A simple rule that detects one inbound connection followed by more than a set threshold of outbound connections within an hour can be an effective heuristic for this "smash and grab" lateral movement tactic.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network traffic sensors capturing East-West traffic
      - Network flow logs
      - Endpoint security logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON inbound remote connection to host; COUNT unique outbound remote service connections from host over next 60 mins. IF count > 5; ALERT for potential 'fan-out' activity.
  - question: Is a host initiating an abnormally high number of outbound remote connections compared to its own history?
    context: This question provides a more tailored approach to detecting 'fan-out' activity by comparing a host's behavior to its own historical baseline. This method is more robust than a static threshold, as it can detect anomalous activity from a normally "chatty" server or a normally quiet workstation without generating excessive false positives.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network traffic sensors capturing East-West traffic
      - Network flow logs
      - Endpoint security logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host; PROFILE historical distribution of unique outbound destinations per 60-min window. ALERT IF current window's count > 99th percentile of its baseline.
  - question: Is a host initiating significantly more outbound remote connections than predicted by a time-series model?
    context: This question uses a forecasting model to predict the expected level of lateral connection activity for each host. When the observed activity significantly exceeds the model's prediction, it suggests a non-random event, such as an adversary-driven 'fan-out', has occurred. This is a sophisticated method for detecting anomalous bursts of activity.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 4624
      - Network traffic sensors capturing East-West traffic
      - Network flow logs
      - Endpoint security logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each host; PREDICT expected outbound connections per hour using ARIMA model. IF observed_count significantly exceeds prediction's confidence_interval; ALERT for anomalous fan-out.
  - question: Are remote service protocols being used on non-standard or unapproved ports?
    context: This question aims to detect adversaries attempting to evade network defenses by running services like RDP or SSH on non-standard ports. By using protocol analyzers and maintaining an explicit allow-list of approved (protocol, port) combinations, any deviation can be immediately flagged as suspicious activity.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek ssh.log
      - Zeek dce_rpc.log
      - Network Security Monitoring sensors
      - VPC flow logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: USE protocol analyzers (Zeek) to identify traffic protocol. IF (protocol is RDP/SSH but port is NOT 3389/22) OR (port is WinRM_port and NOT in allow-list); ALERT.
  - question: Is there internal traffic on a statistically rare remote service port?
    context: This question helps uncover the use of uncommon or unauthorized remote access tools by focusing on the rarity of the destination port. If a port associated with a remote service is used very infrequently across the entire enterprise, it warrants investigation as it may indicate an adversary's custom toolset or a non-standard configuration.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek ssh.log
      - Zeek dce_rpc.log
      - Network Security Monitoring sensors
      - VPC flow logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CALCULATE frequency of all destination ports in internal traffic over 30 days. IF port is a remote_service_port AND usage_count < 10; ALERT for investigation.
  - question: Has a network connection been flagged as anomalous by an autoencoder model due to unusual port or protocol characteristics?
    context: This question leverages an autoencoder, a type of neural network, to build a deep understanding of what 'normal' network traffic looks like. When a new connection cannot be accurately reconstructed by the model, it signals a high degree of anomaly. This can effectively detect various evasive techniques, including non-standard port usage or protocol tunneling, that might bypass simpler methods.
    answer_sources:
      - Zeek conn.log
      - Zeek rdp.log
      - Zeek ssh.log
      - Zeek dce_rpc.log
      - Network Security Monitoring sensors
      - VPC flow logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each new network connection; FEED feature_vector into trained_autoencoder_model. CALCULATE reconstruction_error. IF reconstruction_error is high; ALERT for anomalous connection.