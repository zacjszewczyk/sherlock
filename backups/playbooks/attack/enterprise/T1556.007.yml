name: T1556.007: Hybrid Identity
id: e4f5a6b7-1c2d-4e3f-8a9b-0c1d2e3f4a5b
description: This playbook helps identify adversary activity related to MITRE ATT&CK Technique T1556.007: Hybrid Identity. An adversary may manipulate hybrid identity components like Active Directory Federation Services (AD FS) or Pass-through Authentication (PTA) to establish persistence, evade defenses, or access credentials. The investigations focus on detecting the loading of malicious or unusual DLLs by AD FS/PTA services, unauthorized modifications to their configuration files or registry keys, the creation of suspicious services or tasks for persistence, evidence of MFA bypass, anomalous authentication patterns, command-line activity associated with defense evasion, and signs of credential dumping or data exfiltration from these critical identity servers.
type: technique
related:
  - TA0003: Persistence
  - TA0005: Defense Evasion
  - TA0006: Credential Access
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are known malicious DLLs, such as authentication backdoors like MagicWeb, being loaded by AD FS or PTA service processes?
    context: This action aims to detect the loading of known malicious modules by critical identity services like AD FS and PTA. Adversaries may inject malicious DLLs to intercept credentials or bypass authentication logic. By comparing the file hashes of all loaded DLLs against a threat intelligence feed, we can quickly identify known threats like the MagicWeb backdoor.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 7
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
      - SIEM Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Sysmon Event ID 7 WHERE (ProcessName == 'Microsoft.IdentityServer.Servicehost.exe' OR ProcessName == 'AzureADConnectAuthenticationAgentService.exe') | JOIN ImageLoaded.Hash with ThreatIntelFeed ON Hash | ALERT if match_found.
  - question: Are AD FS or PTA services loading rare or previously unseen DLLs?
    context: This question focuses on detecting novelty and rarity as an indicator of compromise. Legitimate operations typically involve a stable, predictable set of DLLs. An adversary introducing a custom backdoor will likely result in a DLL being loaded that has either never been seen before or is extremely rare across the environment. Alerting on such statistical outliers helps uncover unknown threats.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 7
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
      - SIEM Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Sysmon Event ID 7 WHERE (ProcessName == 'Microsoft.IdentityServer.Servicehost.exe' OR ProcessName == 'AzureADConnectAuthenticationAgentService.exe') | BASELINE ImageLoaded over 30 days | CALCULATE frequency of each ImageLoaded | ALERT if ImageLoaded is new OR frequency < 1st percentile.
  - question: Can machine learning models identify suspicious characteristics in DLLs loaded by AD FS or PTA services?
    context: This question leverages machine learning to move beyond simple signatures. By training a model on various features of a DLL—such as its entropy, digital signature validity, and import functions (imphash)—we can build a classifier to predict the probability of a DLL being malicious. This provides a more robust and proactive detection capability.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 7
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
      - SIEM Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON Sysmon Event ID 7 for AD FS/PTA processes | EXTRACT features (entropy, signature_status, imphash, path) from ImageLoaded | SCORE with pre-trained ML model | ALERT if score > high_malicious_threshold.
  - question: Are AD FS or PTA services loading DLLs that are unsigned, have invalid signatures, or are located in non-standard directories?
    context: Legitimate modules are almost always digitally signed and located in predictable system directories. This question helps identify adversary activity where a malicious DLL is dropped into an unusual location (like C:\ProgramData) or lacks a valid digital signature. Monitoring for these properties is a highly effective way to flag suspicious module loads.
    answer_sources:
      - Sysmon Event ID 7
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH Sysmon Event ID 7 WHERE (ProcessName == 'Microsoft.IdentityServer.Servicehost.exe' OR ProcessName == 'AzureADConnectAuthenticationAgentService.exe') AND (Signed == false OR SignatureStatus != 'Valid' OR ImageLoaded.Path NOT IN (whitelisted_paths)) | ALERT.
  - question: Is the file path entropy of DLLs loaded by AD FS/PTA services anomalously high?
    context: Adversaries may use long, randomized, or obfuscated file paths to hide malicious DLLs. Calculating the Shannon entropy of the parent directory path can quantify this randomness. A path with unusually high entropy compared to a baseline of normal system paths suggests an attempt at evasion and warrants investigation.
    answer_sources:
      - Sysmon Event ID 7
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each Sysmon Event ID 7 for AD FS/PTA | CALCULATE entropy of ImageLoaded.Path | BASELINE path entropy | ALERT if entropy > 98th percentile.
  - question: Are DLLs being loaded by AD FS/PTA services that are outliers compared to normal module loading behavior?
    context: This question uses clustering algorithms to define "normal" for module loading based on features like file path, signer name, and parent process. Any DLL that does not fit into a well-defined cluster of normal behavior is flagged as an outlier or noise point. This can uncover novel malicious techniques that don't match any known pattern but deviate from established norms.
    answer_sources:
      - Sysmon Event ID 7
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FROM Sysmon Event ID 7 for AD FS/PTA | CLUSTER loaded DLLs using features (path, signer, parent) with DBSCAN | ALERT on any DLL classified as a noise point/outlier.
  - question: Are unauthorized users or processes modifying critical AD FS/PTA configuration files or registry keys?
    context: Modifications to critical configuration files or registry keys can allow an adversary to install a backdoor or alter authentication logic. This question focuses on enforcing access control by monitoring for any write or modification events on these assets that do not originate from a whitelisted administrative account or a standard maintenance process.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4657
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR file/registry writes (WEF 4663, 4657; Sysmon 11, 13) on critical AD FS/PTA assets | ALERT if SubjectUserName NOT IN (admin_whitelist) AND occurs outside maintenance_window.
  - question: Is there an anomalous frequency of modification events on AD FS/PTA configuration files or registry keys?
    context: While some modifications are normal, a sudden burst of changes can indicate malicious activity, such as an adversary attempting to alter configurations. By baselining the normal frequency of these events, we can detect statistically significant spikes that exceed a normal threshold (e.g., 3 standard deviations), especially if they occur outside of planned change windows.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4657
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE hourly count of modification events on AD FS/PTA assets | ALERT if current_hour_count > (baseline_mean + 3 * baseline_std_dev).
  - question: Does the volume of AD FS/PTA configuration change events deviate from forecasted predictions?
    context: This question applies time-series forecasting to model the expected volume of configuration changes. An alert is generated when the actual number of observed events significantly deviates from the model's prediction and its confidence interval. This method can detect subtle but sustained increases in modification activity that might not trigger a simple threshold-based alert.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4657
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FORECAST volume of config change events using ARIMA/Prophet | ALERT if observed_volume is outside the forecasted confidence_interval.
  - question: Has a new service or scheduled task been created on an AD FS/PTA server that executes from a suspicious location or with encoded commands?
    context: Adversaries frequently use new services or scheduled tasks to establish persistence. This question looks for common indicators of malicious tasks, such as executables running from user-writable directories (e.g., C:\Temp), or the use of PowerShell with encoded commands, which is a technique to obfuscate malicious scripts.
    answer_sources:
      - Windows Event ID 4698
      - Windows Event ID 7045
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for new service/task creation (WEF 7045, 4698) | ALERT if command_path IN (suspicious_dirs) OR command_line contains 'powershell -enc'.
  - question: Has a new service or scheduled task with a high-entropy (randomized) name been created on an AD FS/PTA server?
    context: To evade detection based on known names, adversaries often use machine-generated or randomized names for their malicious services and tasks. By calculating the character entropy of a new service or task name and comparing it to a baseline of normal names, we can identify those that are suspiciously random and likely malicious.
    answer_sources:
      - Windows Event ID 4698
      - Windows Event ID 7045
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON new service/task creation | CALCULATE entropy of service/task name | BASELINE entropy of existing names | ALERT if new_name_entropy > 99th percentile.
  - question: Can a machine learning model identify newly created services or scheduled tasks as malicious?
    context: This question involves training a classification model to distinguish between legitimate and malicious services/tasks. By using features like the executable path, command-line arguments, and user account context, the model can learn to identify suspicious combinations that indicate a persistence attempt, providing a more intelligent and automated detection mechanism.
    answer_sources:
      - Windows Event ID 4698
      - Windows Event ID 7045
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON new service/task creation | EXTRACT features (path, args, user_context) | SCORE with pre-trained classification model | ALERT if classified as malicious.
  - question: Are there command-line executions on AD FS/PTA servers associated with defense evasion?
    context: Before or after compromising a system, adversaries often try to disable security tools, clear logs, or manipulate firewalls to cover their tracks and prevent detection. This question looks for the command-line execution of specific tools and commands known to be used for defense evasion, such as 'wevtutil.exe cl' (clear log) or 'netsh advfirewall'.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH command lines (WEF 4688, Sysmon 1) for regex matching ('wevtutil cl', 'auditpol /clear', 'Set-MpPreference -Disable') | ALERT on match.
  - question: Are administrative users on AD FS/PTA servers executing commands that are rare for their specific usage history?
    context: Every administrator has a typical set of commands they use for their duties. This question establishes a personalized baseline of command-line activity for each user. An alert is triggered when a user executes a command that is statistically rare for them, even if the command itself is legitimate. This can indicate an account takeover or an administrator performing unusual, potentially malicious actions.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each admin user | BASELINE command execution frequency | ON new command execution | ALERT if command_rarity < 5th percentile for that user.
  - question: Are command sequences on AD FS/PTA servers indicative of an adversary's attempt to evade defenses?
    context: Adversaries may execute a series of commands in a specific order to achieve their objective, a pattern that might differ from normal administrative workflows. This question involves using a sequence analysis model (like a Hidden Markov Model) to learn the probability of legitimate command sequences. Any observed sequence with a very low probability is flagged as anomalous.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRAIN HMM on normal admin command sequences | ON new command sequence | CALCULATE probability of sequence | ALERT if probability is below a learned threshold.
  - question: Is there evidence of a successful AD FS token issuance for an MFA-enabled user without a corresponding MFA success event?
    context: This is a direct check for an MFA bypass. If an AD FS server issues a security token to a user who is required to use MFA, there must be a record of a successful MFA authentication for that user's session. The absence of this MFA success event within a short time window is a high-confidence indicator of a compromised authentication process.
    answer_sources:
      - AD FS Event ID 1200
      - AD FS Event ID 501
      - AD FS Servers
      - Security Information and Event Management (SIEM) Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON AD FS Event 501 (Token Issued) for MFA-enabled user | SEARCH for AD FS Event 1200 (MFA Succeeded) for same user in last 5 mins | ALERT if no MFA event is found.
  - question: Is the ratio of successful logins to successful MFA events for a user dropping significantly?
    context: For any user required to use MFA, the ratio of their successful logins to their successful MFA completions should be very close to 1.0 over time. This question monitors this ratio and alerts if it drops significantly, which would imply that successful logins are occurring without the expected number of MFA challenges, suggesting a potential bypass mechanism is in use.
    answer_sources:
      - AD FS Event ID 1200
      - AD FS Event ID 501
      - AD FS Servers
      - Security Information and Event Management (SIEM) Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR each user, BASELINE ratio of (Event 501 / Event 1200) over 30 days | CALCULATE hourly ratio | ALERT if hourly_ratio is >50% below baseline.
  - question: Are there successful authentications from geographically rare locations or anonymous proxies?
    context: This question uses GeoIP enrichment and threat intelligence to contextualize the source of authentication requests. A successful login from a country where the company has no employees or from an IP address known to be an anonymizing proxy is highly suspicious and could indicate a compromised account or a bypass of location-based access policies.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - AD FS Event ID 501
      - AD FS Servers
      - Network Gateway
      - SIEM Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON successful login (WEF 4624, AD FS 501) | ENRICH source IP with GeoIP and proxy intelligence | ALERT if SourceCountry in 'never-travel' list OR SourceIP is known anonymous proxy.
  - question: Is there a statistically significant spike in successful authentications from a single country?
    context: A sudden, anomalous increase in successful logins from a specific country can be an indicator of a targeted password spray attack or the result of a credential breach. By baselining the normal volume of authentications per country, we can use standard deviation to detect unusual spikes that warrant investigation for a large-scale compromise.
    answer_sources:
      - Windows Event ID 4624
      - Zeek conn.log
      - AD FS Event ID 501
      - AD FS Servers
      - Network Gateway
      - SIEM Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BASELINE hourly successful logins per country | ALERT if logins from any country in 1 hour > (baseline_mean + 4 * baseline_std_dev).
  - question: Are AD FS or PTA servers making outbound network connections to known malicious destinations or newly registered domains?
    context: Critical identity servers like AD FS and PTA should have very predictable network traffic patterns. An outbound connection from one of these servers to a known command-and-control (C2) server or a domain that was just recently registered is a strong indicator of compromise, suggesting malware is attempting to communicate out or exfiltrate data.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
      - Network Egress Points
      - DNS Resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR outbound DNS/connections from AD FS/PTA servers | ALERT if destination is in C2 threat feed OR domain was registered in last 7 days.
  - question: Are AD FS or PTA service processes spawning unexpected child processes, especially those related to credential dumping?
    context: The core AD FS and PTA service processes should not be spawning child processes during normal operation. The creation of any child process is highly anomalous. It is especially critical if that child process is a known credential dumping tool like 'procdump.exe' or involves suspicious command-line strings like 'mimikatz', indicating a direct attempt to steal credentials.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SEARCH for process creation where ParentProcessName is 'Microsoft.IdentityServer.Servicehost.exe' or 'AzureADConnectAuthenticationAgentService.exe' | ALERT on any match, especially if child process is a known credential dumper.
  - question: Is an unauthorized process attempting to read the memory of the AD FS or PTA service process?
    context: Adversaries may attempt to read the memory of the AD FS or PTA processes to extract sensitive data, such as private keys or cached credentials. This question focuses on detecting this activity by monitoring for process access events (Sysmon Event ID 10) and alerting when any process not on a strict whitelist attempts to read the memory of these critical services.
    answer_sources:
      - Sysmon Event ID 10
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: MONITOR Sysmon Event ID 10 where TargetImage is AD FS/PTA process and GrantedAccess includes VM_READ | ALERT if SourceImage is not in whitelist of approved tools.
  - question: Is there a temporal correlation between a burst of authentications and a large outbound data transfer from an AD FS/PTA server?
    context: This question seeks to link two suspicious events: a high volume of authentications and a large data exfiltration. If an attacker compromises an identity server to harvest credentials, they may then attempt to exfiltrate them. A correlation rule that triggers when a large data transfer closely follows a burst of login activity can detect this specific attack chain.
    answer_sources:
      - Zeek conn.log
      - AD FS Event ID 501
      - Windows Event ID 4624
      - AD FS Servers
      - Azure AD Connect Servers (PTA)
      - Network Egress Points
      - SIEM Platform
    range: last 90 days
    queries:
      - technology: pseudocode
        query: CORRELATE successful logins with outbound network traffic from same server | ALERT if >20 logins are followed within 5 minutes by an outbound connection > 5MB.