name: "T1568: Dynamic Resolution"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps to answer the question: Is the adversary using dynamic resolution for Command and Control? It focuses on detecting dynamic resolution techniques for C2 by identifying connections to known DGA or fast-flux C2 indicators from threat intelligence, analyzing DNS responses for high answer counts or low TTLs characteristic of fast-flux, detecting C2 beaconing over DNS-over-HTTPS (DoH), identifying statistically anomalous domain names (e.g., high entropy), spotting client-side fast-flux where a host resolves a domain to many IPs, finding C2 IPs derived from content on legitimate sites (DNS Calculation), and observing spikes in queries for newly registered or low-prevalence domains."
type: "technique"
related:
  - "TA0011: Command and Control"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Are internal hosts connecting to or querying domains/IPs known to be associated with DGA or fast-flux C2 infrastructure?"
    context: "This question aims to identify direct communication with known malicious infrastructure by cross-referencing outbound DNS queries and network connections against a high-confidence threat intelligence feed. A match is a strong indicator of a compromise."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Egress network gateways, internal DNS resolvers, and integrated Threat Intelligence Platforms"
    range: "last 90 days"
    queries:
      - "SEARCH dns_logs AND network_connections FOR destination IN (threat_intel_feed_dga_fastflux)"
  - question: "Has there been a statistically significant increase in the number of internal hosts querying known DGA domains, suggesting a widespread campaign?"
    context: "This question looks for a sudden, anomalous spike in the number of unique internal systems attempting to contact known DGA domains. A sharp increase can indicate the activation of a widespread, coordinated malware campaign across the network."
    answer_sources:
      - "Zeek dns.log"
      - "Egress network gateways, internal DNS resolvers, and integrated Threat Intelligence Platforms"
    range: "last 90 days"
    queries:
      - "COUNT unique_hosts by day WHERE dns_query IN (dga_threat_feed) | COMPARE count to 90-day_moving_average + 3 * stdev"
  - question: "Are internal hosts querying domains that have characteristics of DGA, even if they are not yet on a threat feed?"
    context: "This question seeks to proactively identify previously unknown DGA domains by using a machine learning model. The model is trained to recognize features of algorithmically generated domains (e.g., character distribution, length) to find potential C2 channels before they are publicly identified."
    answer_sources:
      - "Zeek dns.log"
      - "Egress network gateways, internal DNS resolvers, and integrated Threat Intelligence Platforms"
    range: "last 90 days"
    queries:
      - "SCORE all_new_domains with dga_classification_model | FILTER for high_dga_score"
  - question: "Are there any DNS responses on the network exhibiting characteristics of fast-flux, such as an unusually low TTL and a high number of associated IP addresses?"
    context: "This question looks for the technical fingerprints of fast-flux DNS, where a single domain rapidly cycles through a large number of IP addresses to evade blacklisting. A low Time-To-Live (TTL) value combined with many IP addresses in a single DNS response is a key indicator of this technique."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Recursive DNS servers, Egress network gateways"
    range: "last 90 days"
    queries:
      - "SEARCH dns_logs WHERE ttl < 300 AND count(answers) > 5"
  - question: "Are any domains showing statistically anomalous behavior in their DNS response TTLs or answer counts compared to their own historical baseline?"
    context: "This question aims to detect fast-flux activity by identifying when a domain's DNS response behavior deviates significantly from its established norm. A sudden drop in TTL or a spike in the number of resolved IPs for a specific domain can indicate it has been co-opted for a fast-flux network."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Recursive DNS servers, Egress network gateways"
    range: "last 90 days"
    queries:
      - "CALCULATE stats for TTL and answer_count per domain | ALERT if current_value deviates from 30-day_mean by > 3 * stdev"
  - question: "Are the IP addresses resolved for any single domain abnormally diverse in terms of ASN and geographic location, suggesting a sophisticated fast-flux network?"
    context: "This question seeks to identify advanced fast-flux networks by analyzing the diversity of the IP infrastructure behind a single domain. Legitimate services typically use a consistent set of networks and locations, whereas sophisticated fast-flux C2 will use a widely distributed and disparate set of compromised hosts, which can be identified through clustering analysis of their ASNs and geolocations."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Recursive DNS servers, Egress network gateways"
    range: "last 90 days"
    queries:
      - "CLUSTER resolved_ips for each domain by ASN and geolocation | IDENTIFY domains with abnormally high cluster diversity"
  - question: "Are internal hosts making connections to known DNS-over-HTTPS (DoH) resolvers, potentially to bypass local DNS monitoring and security controls?"
    context: "This question identifies the use of encrypted DNS (DoH), which adversaries can use to hide their C2 DNS queries from network-based security tools. Flagging connections to known DoH resolvers is the first step in identifying this evasion technique, especially if DoH usage is against corporate policy."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Windows Event ID 4688"
      - "Windows Event ID 5156"
      - "Egress network gateways/firewalls, Endpoint devices, Web proxies"
    range: "last 90 days"
    queries:
      - "SEARCH tls_logs for server_name IN (known_doh_resolvers) OR conn_logs for destination_ip IN (known_doh_ips)"
  - question: "Following a connection to a DoH resolver, does a host exhibit periodic, low-volume outbound connections characteristic of C2 beaconing?"
    context: "After identifying a host using DoH, this question looks for the subsequent C2 activity that the encrypted DNS was meant to hide. C2 beaconing often manifests as highly regular, 'heartbeat' connections with small data payloads. Identifying this statistical pattern after DoH usage strongly indicates a C2 channel."
    answer_sources:
      - "Zeek conn.log"
      - "Egress network gateways/firewalls, Endpoint devices, Web proxies"
    range: "last 90 days"
    queries:
      - "FOR hosts using DoH | ANALYZE subsequent outbound connections | FLAG connections with low stdev of inter-arrival_time and small data_volume"
  - question: "Can the timing and size of a host's future outbound connections be accurately predicted following a DoH session, indicating a strong beaconing signal?"
    context: "This question applies advanced time-series analysis to confirm C2 beaconing. If a forecasting model can predict the timing and size of a host's next outbound connection with high accuracy, it provides strong mathematical evidence of a non-random, automated process like C2 communication, rather than human-driven activity."
    answer_sources:
      - "Zeek conn.log"
      - "Egress network gateways/firewalls, Endpoint devices, Web proxies"
    range: "last 90 days"
    queries:
      - "FOR hosts using DoH | MODEL outbound connection sequence with time-series_forecasting (e.g., ARIMA) | FLAG if next connection is predicted with high confidence"
  - question: "Is any single host generating an abnormally high number of NXDOMAIN (non-existent domain) DNS responses, suggesting a DGA is searching for its active C2 server?"
    context: "This question identifies a common behavior of Domain Generation Algorithms (DGAs), where malware rapidly queries a long list of potential domains until it finds one that is registered and active. This process generates a large volume of failed lookups (NXDOMAIN responses) from a single host in a short period."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Egress network gateways/firewalls"
    range: "last 90 days"
    queries:
      - "COUNT NXDOMAIN responses by source_host over 5_minutes | ALERT if count > 100"
  - question: "Are internal hosts querying domains that have high Shannon entropy, indicating they are likely algorithmically generated and not human-readable?"
    context: "This question uses a statistical measure, Shannon entropy, to quantify the randomness of characters in a domain name. DGA domains are often random-looking strings with high entropy, unlike legitimate, human-created domains. Flagging domains with unusually high entropy is an effective way to spot potential DGA activity."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Egress network gateways/firewalls"
    range: "last 90 days"
    queries:
      - "CALCULATE shannon_entropy for each domain_query | ALERT if entropy_score > 99th_percentile_of_baseline"
  - question: "Can newly observed domains be classified as DGA-based using a machine learning model trained on multiple linguistic and statistical features?"
    context: "This question leverages a more sophisticated, multi-faceted approach to detecting DGAs. By training a machine learning model on various features (length, entropy, character ratios, n-gram frequencies), it's possible to create a robust classifier that can identify DGA domains with higher accuracy and fewer false positives than single-feature methods like entropy alone."
    answer_sources:
      - "Zeek dns.log"
      - "Internal DNS resolvers, Egress network gateways/firewalls"
    range: "last 90 days"
    queries:
      - "SCORE new_domains with ml_classifier (Random Forest) based on domain_features | ALERT on domains classified as DGA"
  - question: "Is any single host resolving the same domain name to a large number of different IP addresses in a short time, indicating client-side fast-flux?"
    context: "This question looks for client-side fast-flux, where the infected client itself rapidly queries a domain to cycle through a list of C2 IP addresses. This behavior is distinct from server-side fast-flux and manifests as one host receiving many different IPs for one domain in a short time frame."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Endpoint devices, Internal DNS resolvers"
    range: "last 90 days"
    queries:
      - "COUNT unique resolved_ips for a single_host and single_domain over 5_minutes | ALERT if count > 10"
  - question: "Are there host-domain pairs exhibiting high entropy in the set of resolved IP addresses, indicating high IP churn consistent with fast-flux?"
    context: "This question applies an information theory concept (entropy) to measure the randomness or diversity of IP addresses associated with a host-domain pair. A high entropy score indicates that a host is resolving a domain to a wide and unpredictable set of IPs, which is a strong statistical marker for fast-flux activity."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Endpoint devices, Internal DNS resolvers"
    range: "last 90 days"
    queries:
      - "GROUP dns_logs by host, domain over 1_hour | CALCULATE entropy of resolved_ip_set | ALERT if entropy is in top 1%"
  - question: "Using graph analysis, can we identify hosts that are acting as hubs connecting to an unusually large and diverse set of IPs for a single domain?"
    context: "This question models network activity as a graph to find structural anomalies. In this graph, a host acting as a 'hub' that connects a single domain to a vast and diverse community of IP addresses represents a significant deviation from normal behavior and is a powerful indicator of fast-flux C2."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Endpoint devices, Internal DNS resolvers"
    range: "last 90 days"
    queries:
      - "CREATE tripartite_graph of (host, domain, IP) | APPLY centrality_algorithms to find hosts acting as hubs for a single domain"
  - question: "Is an internal host making a suspicious outbound connection to an unusual IP immediately after visiting a legitimate web service known to be abused for DNS Calculation (e.g., GitHub, Pastebin)?"
    context: "This question targets the DNS Calculation technique, where malware retrieves its C2 IP address from information hidden within a legitimate, high-reputation website. The indicator is a tight temporal link: a visit to an abused service followed almost instantly by a connection to an unrelated IP address."
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Egress network gateways/firewalls, Web proxies, Endpoint devices"
    range: "last 90 days"
    queries:
      - "SEARCH for visit to abused_service (e.g., GitHub) followed within 5 seconds by connection to IP not associated with that service"
  - question: "Are there hosts exhibiting a consistent, periodic pattern of visiting a legitimate service and then making a non-HTTP/S connection, suggesting a scripted C2 mechanism?"
    context: "This question looks for the automation inherent in C2 communications that use DNS Calculation. By measuring the time between visiting the legitimate service and the subsequent outbound connection, a consistent, short, and periodic delay suggests a scripted process rather than random user activity."
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Egress network gateways/firewalls, Web proxies, Endpoint devices"
    range: "last 90 days"
    queries:
      - "CALCULATE time_delta between visit_to_abused_service and subsequent non-HTTP_connection | FLAG hosts with consistently low and periodic deltas"
  - question: "Does a user's session contain the rare event sequence of visiting a known abused service followed immediately by a non-standard outbound connection?"
    context: "This question frames the DNS Calculation technique as a rare sequence of events within a user's overall activity. By modeling normal browsing patterns, the specific sequence of [Visit Abused Service -> Initiate non-standard outbound connection] can be identified as a significant and suspicious anomaly."
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Zeek conn.log"
      - "Windows Event ID 4688"
      - "Egress network gateways/firewalls, Web proxies, Endpoint devices"
    range: "last 90 days"
    queries:
      - "MODEL user browsing patterns with sequence_analysis | FLAG sessions containing the rare sequence [Visit Abused Service -> Non-standard outbound connection]"
  - question: "Are internal hosts querying domains that were registered very recently (e.g., within the last 7 days)?"
    context: "This question targets the adversary tactic of using newly registered domains (NRDs) for ephemeral C2 infrastructure. Since these domains have no history or reputation, they are often used for short-term malicious campaigns. Identifying queries to NRDs is a proactive way to uncover potential C2 activity."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS resolvers, Egress network gateways, Threat Intelligence Platforms, Passive DNS databases"
    range: "last 90 days"
    queries:
      - "ENRICH dns_logs with WHOIS data | ALERT on any query for a domain with registration_date < 7 days ago"
  - question: "Has there been a statistically anomalous spike in the overall volume of queries for newly registered domains across the network?"
    context: "This question looks for network-wide trends related to NRDs. A sudden, significant increase in the total number of queries to NRDs can indicate the start of a new, large-scale attack campaign that relies on this type of infrastructure."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS resolvers, Egress network gateways, Threat Intelligence Platforms, Passive DNS databases"
    range: "last 90 days"
    queries:
      - "CALCULATE hourly query_count for NRDs | ALERT if count exceeds 30-day_mean by > 3 * stdev"
  - question: "Are hosts connecting to domains that have a low reputation score based on factors like age, query prevalence, and ASN reputation?"
    context: "This question proposes a holistic approach to risk-scoring domains. By combining multiple weak signals—such as recent registration, low global query volume, and association with a non-reputable ASN—a more confident determination can be made about a domain's maliciousness, allowing for the investigation of associated network connections."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "Internal DNS resolvers, Egress network gateways, Threat Intelligence Platforms, Passive DNS databases"
    range: "last 90 days"
    queries:
      - "DEVELOP domain_reputation_model using features (age, prevalence, ASN) | SCORE all domains | INVESTIGATE connections to low-reputation domains"