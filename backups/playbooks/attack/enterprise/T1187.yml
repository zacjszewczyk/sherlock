name: T1187: Forced Authentication
id: 5b9c0f9a-1f1e-4b9b-8c7c-1f5d6a3e2b1d
description: This playbook helps investigate whether an adversary is attempting to gather credentials using forced authentication (T1187). This technique coerces a user or system to authenticate to an attacker-controlled system, allowing the attacker to capture and potentially crack the credentials. The playbook focuses on detecting several key indicators: outbound SMB or WebDAV connections to malicious or rare external IP addresses; the creation of malicious shortcut files (.lnk, .scf, .url) on endpoints that point to external UNC paths; the presence of embedded links to external SMB shares within Office or HTML documents; an anomalous number of unique external SMB/WebDAV destinations from a single host; and unusual internal workstation-to-workstation SMB scanning activity, which could indicate lateral movement following a successful credential capture.
type: technique
related:
  - TA0006: Credential Access
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is there any outbound SMB or WebDAV traffic from internal hosts to external IP addresses known to be malicious?
    context: This question aims to detect direct connections to known-bad infrastructure associated with credential theft campaigns. By correlating network connection logs with a threat intelligence feed, analysts can quickly identify high-confidence indicators of a forced authentication attempt where an attacker is trying to lure a client into connecting to a malicious server to capture credentials.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Internet gateways
      - DNS resolvers
      - Perimeter firewalls
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH Zeek conn.log
          JOIN with threat_intelligence_feed ON conn.id.resp_h = feed.ip
          WHERE conn.id.orig_h is an internal IP
          AND ( (conn.id.resp_p IN (445, 139)) OR
                (conn.id.resp_p IN (80, 443) AND http.log shows PROPFIND or OPTIONS method for connection) )
          ALERT on matching connections
  - question: Are there any outbound SMB or WebDAV connections to geographically or organizationally rare destinations?
    context: This question helps identify forced authentication attempts directed at unusual or novel infrastructure, which may not yet be on threat intelligence feeds. By baselining normal connection patterns, analysts can spot outliers that represent a statistical anomaly. A connection to a country or Autonomous System Number (ASN) that the organization rarely communicates with could indicate a newly stood-up malicious server.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Internet gateways
      - DNS resolvers
      - Perimeter firewalls
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE outbound connections on ports (139, 445, 80, 443) over 30 days
          CALCULATE frequency of destination countries and ASNs
          SEARCH new outbound connections on specified ports
          ENRICH with GeoIP and ASN data
          ALERT if destination country or ASN is in the bottom 5% of the frequency baseline
  - question: Can a machine learning model identify high-probability malicious outbound SMB or WebDAV connections based on a combination of features?
    context: This question leverages machine learning to move beyond simple rule-based detection. By training a model on various contextual features (IP reputation, ASN, geolocation, domain age, etc.), analysts can create a more nuanced and robust detection mechanism. This approach can identify sophisticated attacks that might evade static rules by combining multiple weak signals into a strong indicator of malicious activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek http.log
      - Internet gateways
      - DNS resolvers
      - Perimeter firewalls
      - Web proxies
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN a classification model on historical connection data with features like dest_ip_reputation, ASN, country, duration, service, and domain_age
          DEPLOY model to score new outbound connections in real-time
          ALERT on connections with a high malicious probability score
  - question: Have any shortcut files (.lnk, .scf, .url) been created that point to an external, non-whitelisted UNC path?
    context: This question focuses on detecting the creation of weaponized shortcut files on endpoints. Attackers use these files to trick users into initiating a connection to a malicious server. By monitoring file creation events and inspecting the target path within these files, analysts can catch the staging of a forced authentication attack before a user even interacts with the file.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 1
      - User workstations
      - Shared network drives
      - Publicly accessible file shares
      - Terminal servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH for Sysmon Event ID 11 (FileCreate)
          WHERE TargetFilename ends with .lnk, .scf, or .url
          PARSE file to extract target path
          ALERT if path starts with `\\` and server is a non-RFC1918 IP or a non-allowlisted domain
  - question: Are any newly created shortcut files pointing to statistically rare server destinations?
    context: This question provides a behavioral approach to detecting malicious shortcut files. Instead of relying solely on allowlists, it baselines the typical servers referenced in shortcut files across the environment. A file pointing to a server that is rarely or never seen before is a strong statistical outlier and warrants investigation as a potential forced authentication lure.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 1
      - User workstations
      - Shared network drives
      - Publicly accessible file shares
      - Terminal servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE server names from target paths of .lnk, .scf, .url files over 90 days
          CALCULATE frequency of server names
          SEARCH for new file creation events for these types
          PARSE server name from target path
          ALERT if server name is not in the top 99% of the frequency baseline
  - question: Can a machine learning model classify the target paths of shortcut files as benign or malicious?
    context: This question applies advanced text analysis to identify malicious link files. A machine learning model can learn the subtle characteristics of malicious UNC paths, such as high entropy, the presence of IP addresses instead of hostnames, or unusual top-level domains. This allows for the detection of novel attack patterns that might not match simple rules or statistical frequency analysis.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - Sysmon Event ID 1
      - User workstations
      - Shared network drives
      - Publicly accessible file shares
      - Terminal servers
      - Domain Controllers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN a text classification model on benign/malicious link file paths using features like path length, entropy, IP address presence, TLD
          SCAN target paths of newly created .lnk, .scf, .url files
          ALERT on paths classified as malicious by the model
  - question: Are any Office documents or HTML files being transferred that contain embedded links to external SMB shares?
    context: This question targets the delivery mechanism of forced authentication. Attackers often embed hidden images or resources in documents that point to an external SMB server. When the user opens the document, the application (e.g., Word, Outlook) automatically attempts to connect to the server, leaking the user's credentials. This query inspects file content at the network level to find these malicious references.
    answer_sources:
      - Zeek files.log
      - Sysmon Event ID 1
      - Windows Event ID 4688
      - Email gateways
      - Web proxies
      - Endpoint download directories
      - Network file shares
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CONFIGURE Zeek to extract file content from files.log
          SEARCH file content for regex `(file:|\\\\)\\\\\\\\[^\\\\]+`
          IF match is found
          CORRELATE with endpoint logs to find the parent process (e.g., OUTLOOK.EXE)
          ALERT on detection
  - question: Are documents being received that contain `file://` URIs pointing to statistically rare destinations?
    context: Similar to baselining connection destinations, this question baselines the domains and IPs found within `file://` links inside documents. This helps identify attacks using novel infrastructure. A document trying to retrieve a resource from a server the organization has never seen before is highly suspicious and could be an attempt to force authentication.
    answer_sources:
      - Zeek files.log
      - Sysmon Event ID 1
      - Windows Event ID 4688
      - Email gateways
      - Web proxies
      - Endpoint download directories
      - Network file shares
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BASELINE all domains/IPs from `file://` URIs in documents over 30 days
          CALCULATE frequency distribution of these destinations
          SEARCH new documents for `file://` URIs
          ALERT if a URI destination is statistically rare (e.g., bottom 1%) and not an internal resource
  - question: Can a machine learning model predict a malice score for documents based on features indicative of forced authentication?
    context: This question proposes a holistic approach to document analysis. Instead of just looking for one indicator, a model can weigh multiple features together—such as the count of `file://` links, whether the link is to an external IP, if the link is hidden, and the presence of macros—to generate a comprehensive risk score for a document, improving detection accuracy and reducing false positives.
    answer_sources:
      - Zeek files.log
      - Sysmon Event ID 1
      - Windows Event ID 4688
      - Email gateways
      - Web proxies
      - Endpoint download directories
      - Network file shares
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN a gradient boosting model on documents with features like file:// link count, external IP target, hidden links, macro presence, and file source
          DEPLOY model to score new documents from external sources
          ALERT on documents with a high malice score
  - question: Has any single internal host connected to an abnormally high number of unique external SMB/WebDAV destinations?
    context: This question seeks to identify hosts that may be compromised and are being used to probe or connect to multiple attacker-controlled servers. A sudden spike in the number of unique external destinations for SMB or WebDAV traffic from a single host is anomalous and could indicate an automated process attempting to exfiltrate credentials.
    answer_sources:
      - Zeek conn.log
      - Zeek smb.log
      - Zeek http.log
      - Network egress points
      - Internet gateways
      - Firewall logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH for outbound SMB/WebDAV connections
          COUNT unique external destinations per internal host within a 60-minute window
          ALERT if count for any host exceeds a tuned threshold (e.g., 10)
  - question: Is any host's daily count of unique external SMB/WebDAV destinations exceeding its historical baseline?
    context: This question uses statistical analysis to detect deviations from normal behavior for each host. By establishing a rolling baseline of activity, analysts can identify when a host's behavior changes significantly. A host whose daily count of unique destinations exceeds 3 standard deviations above its average is a strong statistical anomaly requiring investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek smb.log
      - Zeek http.log
      - Network egress points
      - Internet gateways
      - Firewall logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each internal host, establish a 30-day rolling baseline of daily unique external SMB/WebDAV destinations
          CALCULATE mean and standard deviation for each host
          MONITOR current daily count for each host
          ALERT if current count > (mean + 3 * std_dev) or exceeds 98th percentile
  - question: Is a time-series anomaly detection model flagging any hosts for unusual patterns in outbound SMB/WebDAV connections?
    context: This is an advanced analytical method that can account for seasonality and complex patterns in a host's behavior. A time-series model (like Seasonal-Hybrid ESD) can learn the normal "rhythm" of a host's network traffic and alert on any disruption to that pattern, making it effective at catching subtle or slow-moving attacks that might be missed by simple thresholding.
    answer_sources:
      - Zeek conn.log
      - Zeek smb.log
      - Zeek http.log
      - Network egress points
      - Internet gateways
      - Firewall logs
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each host, train a time-series anomaly detection model on the hourly count of unique outbound SMB/WebDAV destinations using at least 30 days of data
          APPLY model to new hourly data points
          ALERT when a data point is flagged as an anomaly
  - question: Is any user workstation initiating SMB connections to a large number of other workstations?
    context: This question helps detect lateral movement attempts following a potential credential compromise. Normal user workstations typically do not initiate widespread SMB connections to their peers. An attacker who has gained credentials may use them to scan the network for accessible shares. This rule, using asset inventory to differentiate workstations from servers, detects this anomalous fan-out behavior.
    answer_sources:
      - Zeek conn.log
      - Zeek smb.log
      - Windows Event ID 4624
      - Internal network segments
      - VLANs for user workstations
      - Domain Controller security logs
      - Core network switches
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          USE asset inventory to identify workstation subnets
          SEARCH for SMB connections where source and destination IPs are in workstation subnets
          COUNT unique destination IPs per source IP within a 1-hour window
          ALERT if count > 50, excluding known admin systems
  - question: Does the internal SMB communication graph show any workstation nodes with an anomalously high out-degree?
    context: This question uses graph analysis to model internal network communications. By representing hosts as nodes and connections as edges, analysts can calculate network-based metrics. A workstation's "out-degree" (number of outgoing connections) should be low. A workstation with an out-degree in the 99th percentile for all workstations is behaving very differently from its peers and is highly suspect.
    answer_sources:
      - Zeek conn.log
      - Zeek smb.log
      - Windows Event ID 4624
      - Internal network segments
      - VLANs for user workstations
      - Domain Controller security logs
      - Core network switches
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CONSTRUCT a daily communication graph of internal SMB traffic
          IDENTIFY nodes that are workstations
          CALCULATE the out-degree for each workstation node
          BASELINE the out-degree distribution for all workstations
          ALERT if any workstation's out-degree exceeds the 99th percentile
  - question: Can a clustering algorithm identify workstations exhibiting anomalous peer-to-peer SMB behavior?
    context: This question applies unsupervised machine learning to find outliers without pre-defined rules. By clustering workstations based on their SMB communication features (e.g., connection counts, failed connection counts), most hosts will group into a large "normal" cluster. Hosts that do not fit into any cluster (i.e., are identified as noise by an algorithm like DBSCAN) are, by definition, anomalous and should be investigated.
    answer_sources:
      - Zeek conn.log
      - Zeek smb.log
      - Windows Event ID 4624
      - Internal network segments
      - VLANs for user workstations
      - Domain Controller security logs
      - Core network switches
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each workstation, create a feature vector (e.g., outbound_smb_count, failed_smb_count, dest_ip_entropy)
          APPLY a density-based clustering algorithm (e.g., DBSCAN) to all workstation vectors
          INVESTIGATE any hosts that are classified as noise/outliers by the algorithm