name: T1071.003: Mail Protocols
id: a6e8f4b0-5e1c-4d7a-8b3c-9f0e1d2a3b4c
description: This playbook helps investigate whether an adversary is using mail protocols (SMTP, POP3, IMAP) for command and control (C2) communication. This involves detecting connections to known malicious infrastructure, identifying anomalous patterns in email content and metadata such as high-entropy subject lines, recognizing non-human beaconing behavior through periodic connections, flagging unusual data transfer volumes indicative of exfiltration, and identifying mail traffic originating from non-standard processes on endpoints.
type: technique
related:
  - TA0011: Command and Control
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are there mail protocol connections to IP addresses or domains known to be malicious C2 infrastructure?
    context: This question helps detect direct connections to known adversary command and control servers using mail protocols. Matching against a threat intelligence feed is a high-fidelity method for identifying confirmed malicious activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: SELECT * FROM (zeek_conn, zeek_smtp) WHERE dest_port IN (25, 110, 143, 465, 587, 993, 995) AND (dest_ip IN cti_feed OR helo_domain IN cti_feed)
  - question: Are there mail protocol connections to unusually rare or new mail server domains?
    context: Adversaries often use newly registered or obscure domains for C2 that are not yet in threat intelligence feeds. Identifying domains with very low frequency (long-tail analysis) can uncover this type of infrastructure before it is widely known.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: CALCULATE frequency of eTLD+1 for mail domains over 30 days. IDENTIFY domains in lowest 5th percentile.
  - question: Can machine learning models identify mail server domains likely to be malicious based on their characteristics?
    context: This proactive approach uses machine learning to predict if a domain is malicious, even without prior intelligence. By analyzing features like domain age, lexical structure, and DNS query patterns, it is possible to score and flag suspicious domains that might be part of a C2 infrastructure.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek smtp.log
      - WHOIS data
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: EXTRACT features (domain age, entropy, etc.) for new domains. APPLY pre-trained Random Forest model. ALERT on scores > 0.9.
  - question: Do any emails contain headers, subjects, or other fields that match signatures of known C2 tools?
    context: C2 malware often uses specific, predictable patterns in email fields for communication. This question aims to find these artifacts (e.g., Base64-encoded strings, GUIDs, unusual User-Agents) using regular expressions to detect the presence of specific C2 tools.
    answer_sources:
      - Zeek smtp.log
      - Zeek pop3.log
      - Zeek imap.log
      - Internal Mail Relays
    range: last 90 days
    queries:
      - search: Pseudocode
        query: APPLY regex ruleset for C2 signatures (Base64, GUIDs) against smtp logs (subject, from, user_agent). ALERT on match.
  - question: Are there outbound emails with an unusually high ratio of non-alphanumeric characters in the subject line?
    context: Legitimate subject lines are typically prose. A high ratio of non-alphanumeric characters can indicate a structured, machine-generated message used for C2, where information is encoded rather than written for human reading. This is a statistical method to find anomalous subject lines.
    answer_sources:
      - Zeek smtp.log
      - Zeek pop3.log
      - Zeek imap.log
      - Internal Mail Relays
    range: last 90 days
    queries:
      - search: Pseudocode
        query: CALCULATE non-alphanumeric ratio for subject lines. ESTABLISH 30-day baseline. ALERT on ratio > 99th percentile.
  - question: Does topic modeling on email subject lines reveal clusters of semantically meaningless or random-looking text?
    context: This question uses unsupervised machine learning (LDA) to group emails by topic based on their subject lines. Topics that are not human-readable (e.g., random strings) may represent a covert C2 channel where the subject line is used to pass data.
    answer_sources:
      - Zeek smtp.log
      - Zeek pop3.log
      - Zeek imap.log
      - Internal Mail Relays
    range: last 90 days
    queries:
      - search: Pseudocode
        query: APPLY LDA model to 7-day corpus of email subjects. MANUALLY review topics. FLAG meaningless/random topics for investigation.
  - question: Are there mail protocol connections between a specific source and destination that occur at highly regular, constant intervals?
    context: Automated C2 implants often "beacon" back to their server at fixed intervals (e.g., every 60 seconds). This question looks for this precise, machine-like periodicity in connection timing, which is a strong indicator of non-human, automated C2 activity.
    answer_sources:
      - Zeek conn.log
      - Endpoint Devices and Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: FOR each src-dst pair, CALCULATE time delta between consecutive connections. FLAG if delta is constant (+/- tolerance) for >10 connections.
  - question: Are there hosts making mail protocol connections with an unusually low variation in timing between connections?
    context: This is another way to detect beaconing. While the previous question looks for a constant delta, this question uses the standard deviation of inter-arrival times. A very low standard deviation indicates highly regular, periodic traffic, which is characteristic of C2 beaconing.
    answer_sources:
      - Zeek conn.log
      - Endpoint Devices and Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: FOR each src IP, GROUP by dest IP. CALCULATE stddev of inter-arrival times over 24h. FLAG if stddev is low and connection count > 10.
  - question: Can time-series analysis reveal strong, periodic signals in a host's mail connection activity that are not related to normal business patterns?
    context: This advanced technique models a host's connection history as a time series and decomposes it into trend, seasonal, and residual components. By isolating the periodic component, it can uncover hidden beaconing behavior that might be obscured by other network traffic.
    answer_sources:
      - Zeek conn.log
      - Endpoint Devices and Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: CREATE time series of mail connection counts for each host. APPLY STL decomposition. ALERT on strong periodic signals.
  - question: Has any single mail protocol connection involved an unusually large amount of data being sent from a client?
    context: A sudden, large upload over a mail protocol could signify data exfiltration, where an adversary is sending stolen data out of the network disguised as email traffic. This question uses a simple threshold to catch egregious examples of this behavior.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: SELECT * FROM zeek_conn WHERE service IN ('smtp', 'pop3', 'imap') AND orig_bytes > [environment_threshold].
  - question: Are there mail connections where the amount of data sent, or the ratio of sent-to-received data, is anomalous for that specific host?
    context: This question refines the previous one by creating a dynamic, per-host baseline. What is normal for a mail server is not normal for a user workstation. By comparing connection volumes to a host's own history, this method can detect deviations that indicate C2 or exfiltration with higher accuracy.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: FOR each host, ESTABLISH 30-day baseline for orig_bytes and orig/resp ratio. ALERT on new connections exceeding 98th percentile.
  - question: Can an anomaly detection model identify mail protocol sessions that are statistical outliers based on multiple network features?
    context: This question employs an unsupervised machine learning model (Isolation Forest) to find outliers. By considering multiple features at once (like duration, bytes sent/received, packet counts), it can identify anomalous connections that might not be caught by single-metric thresholds, providing a more holistic detection capability.
    answer_sources:
      - Zeek conn.log
      - Internet Gateway/Egress Points
    range: last 90 days
    queries:
      - search: Pseudocode
        query: APPLY pre-trained Isolation Forest model on Zeek conn.log features (duration, bytes, packets). ALERT on connections flagged as anomalous.
  - question: Are mail protocol connections being initiated by processes that are not approved mail clients?
    context: Legitimate email traffic should originate from standard mail clients (e.g., Outlook). If a command-line tool like powershell.exe is making SMTP connections, it is highly suspicious and could be a malware implant using mail for C2. This question checks for this by correlating network and process data.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Endpoint Devices
    range: last 90 days
    queries:
      - search: Pseudocode
        query: JOIN network logs (Zeek) with process logs (Sysmon). ALERT if process_name making mail connection is NOT IN allowlist.
  - question: Has a process initiated a mail connection on a host where it has rarely or never done so before?
    context: This is a behavioral approach to the previous question. Instead of a static allowlist, it builds a baseline of normal process activity for each host. An alert is triggered when a process starts making mail connections for the first time or very infrequently, which could indicate a newly dropped implant or a legitimate process being hijacked.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Endpoint Devices
    range: last 90 days
    queries:
      - search: Pseudocode
        query: FOR each host, BASELINE processes making mail connections. ALERT on new or rare process-connection pairs.
  - question: Can a machine learning model predictively identify suspicious processes that are initiating mail connections?
    context: This question leverages a supervised ML model to score the "suspiciousness" of a process initiating a mail connection. By training on features like the parent process, command-line arguments, and integrity level, the model can learn to distinguish legitimate from malicious behavior and proactively flag potential threats.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Endpoint Devices
    range: last 90 days
    queries:
      - search: Pseudocode
        query: EXTRACT features from process events (parent, cmdline). APPLY pre-trained Gradient Boosting model. ALERT on high suspicious scores.
  - question: Are there email subject lines that appear to be Base64-encoded strings?
    context: Adversaries may encode C2 data using Base64 and place it in the email subject line. This question uses a specific regular expression to look for long strings composed only of Base64 characters, which are highly indicative of this C2 technique.
    answer_sources:
      - Zeek smtp.log
      - Internal Mail Relays
    range: last 90 days
    queries:
      - search: Pseudocode
        query: APPLY regex for long, no-space, Base64 character strings to email subjects. ALERT on match.
  - question: Do any emails have subject or HELO fields with abnormally high entropy?
    context: High Shannon entropy indicates randomness, which is a characteristic of encrypted or compressed data. Legitimate text has low entropy. By calculating the entropy of email fields and flagging statistical outliers, this question aims to find C2 communications hidden as high-entropy data blobs.
    answer_sources:
      - Zeek smtp.log
      - Internal Mail Relays
    range: last 90 days
    queries:
      - search: Pseudocode
        query: CALCULATE Shannon entropy for subject/helo fields. ESTABLISH 30-day baseline (mean, stddev). ALERT on score > mean + 3*stddev.
  - question: Can a machine learning classifier distinguish between normal text and encoded data within email subject lines?
    context: This question uses a supervised learning model to explicitly classify subject lines as "encoded" or "normal". By training on features like entropy, length, and n-gram frequency, the model can provide a more robust and accurate method for detecting encoded C2 data compared to simple entropy thresholds alone.
    answer_sources:
      - Zeek smtp.log
      - Internal Mail Relays
    range: last 90 days
    queries:
      - search: Pseudocode
        query: APPLY pre-trained Logistic Regression model on subject fields. ALERT on subjects classified as 'encoded' with high probability.