name: T1219.003: Remote Access Hardware
id: 5a8a1b9c-6b3e-4f8d-9a6b-9c8d7e6f5a4b
description: >-
  This playbook helps investigate whether an adversary is establishing command and control using remote access hardware. It focuses on detecting indicators such as network connections to known C2 infrastructure, the connection of new physical devices matching hardware profiles (e.g., specific DHCP hostnames or MAC OUIs), sequences of new device connections followed by immediate external network activity without an interactive user logon, non-interactive processes spawning shells like cmd.exe or powershell.exe, and the presence of persistent, low-volume, periodic network connections (heartbeats) to external destinations over non-standard ports.
type: technique
related:
  - TA0011: Command And Control
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are any hosts communicating with known IP addresses or domains associated with remote access hardware C2 infrastructure?
    context: >-
      This question aims to identify direct communication with known malicious infrastructure. By comparing network connection and DNS query logs against a threat intelligence feed of indicators (IPs, domains) specific to remote access hardware like PiKVM or TinyPilot, analysts can quickly spot confirmed malicious activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network egress points, internal DNS resolvers, and internet gateways.
    range: last 90 days
    queries:
      - pseudocode: >-
          SEARCH network_connection_logs AND dns_logs. JOIN with threat_intel_feed on (destination_ip OR domain). FILTER where threat_intel_feed.category = 'remote_access_hardware'. ALERT on match.
  - question: Are there any domains being requested by only a single host in the enterprise, and how rare are those domains globally?
    context: >-
      This question helps uncover potential C2 channels that are not yet on threat intelligence feeds. Legitimate services are typically accessed by many hosts, whereas a dedicated C2 channel may only be used by a single compromised machine. Identifying domains requested by only one host and then checking their global rarity helps prioritize the most suspicious ones for investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network egress points, internal DNS resolvers, and internet gateways.
    range: last 90 days
    queries:
      - pseudocode: >-
          SEARCH dns_logs. GROUP BY domain. COUNT unique hosts. FILTER host_count = 1. ENRICH domain with global_prevalence_data. SORT by global_prevalence ascending. RETURN suspicious_domains.
  - question: Have any newly observed domains been classified as malicious by a machine learning model based on their lexical features?
    context: >-
      This question uses a machine learning approach to proactively identify potentially malicious domains, including those generated by Domain Generation Algorithms (DGAs). By analyzing features like character randomness, length, and structure, the model can flag suspicious domains that don't look like typical, human-readable names, even if they've never been seen before.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek ssl.log
      - Network egress points, internal DNS resolvers, and internet gateways.
    range: last 90 days
    queries:
      - pseudocode: >-
          FOR each new_domain in dns_logs. EXTRACT lexical_features (entropy, length, etc.). APPLY classification_model to features. IF model_score > confidence_threshold AND classification = 'malicious'. ALERT on domain.
  - question: Has a new external device been connected to a server, and does its DHCP hostname match known remote access hardware?
    context: >-
      This question looks for the physical introduction of unauthorized hardware to critical systems. It correlates a new device detection event on a server with DHCP logs to check if the device identifies itself with a default hostname associated with malicious or unauthorized remote access tools.
    answer_sources:
      - Windows Event ID 6416
      - Zeek dhcp.log
      - Physical access points to servers (data centers), network closets, and workstations handling sensitive data.
    range: last 90 days
    queries:
      - pseudocode: >-
          SEARCH for Windows_Event_ID_6416 on server_assets. EXTRACT device_info. CORRELATE with dhcp_logs on host. IF dhcp_hostname IN (remote_access_hardware_watchlist). ALERT.
  - question: Are there any new devices on the network whose MAC address OUI or DHCP hostname is statistically rare for the enterprise?
    context: >-
      This question helps detect unknown or unusual devices by baselining what's 'normal' for the network. By tracking the frequency of device manufacturer identifiers (OUIs) and hostnames, the system can automatically flag a device that is statistically an outlier, suggesting it's not a standard corporate asset and requires investigation.
    answer_sources:
      - Windows Event ID 6416
      - Zeek dhcp.log
      - Physical access points to servers (data centers), network closets, and workstations handling sensitive data.
    range: last 90 days
    queries:
      - pseudocode: >-
          SEARCH dhcp_logs. CALCULATE historical frequency of (MAC_OUI, hostname). FOR each new_dhcp_request. IF frequency(new_device.OUI) < 1st_percentile OR frequency(new_device.hostname) < 1st_percentile. ALERT.
  - question: Has a machine learning model classified any new devices as suspicious based on their DHCP request properties?
    context: >-
      This question employs a predictive model to distinguish between legitimate corporate devices and potentially unauthorized ones. The model learns the typical characteristics of standard assets from their DHCP requests and flags any new device that deviates significantly from this learned profile, providing a more nuanced detection than simple frequency analysis.
    answer_sources:
      - Windows Event ID 6416
      - Zeek dhcp.log
      - Physical access points to servers (data centers), network closets, and workstations handling sensitive data.
    range: last 90 days
    queries:
      - pseudocode: >-
          FOR each new_device in dhcp_logs. EXTRACT features (hostname_length, entropy, OUI, etc.). APPLY device_classification_model. IF model_classification = 'suspicious'. ALERT.
  - question: Did a host connect a new device and then immediately make an external network connection without an interactive user logged on?
    context: >-
      This question seeks to identify a highly suspicious chain of events: a new device is plugged in, and it immediately 'phones home'. The absence of an interactive user (like an administrator physically logged in) makes this behavior extremely anomalous and strongly indicative of automated, malicious hardware activity.
    answer_sources:
      - Windows Event ID 6416
      - Zeek conn.log
      - Windows Event ID 4624
      - Domain Controllers, database servers, and other Tier 0/Tier 1 assets.
    range: last 90 days
    queries:
      - pseudocode: >-
          SEARCH for Windows_Event_ID_6416. WITHIN 3 minutes, LOOK FOR new_external_connection from same_host. CHECK for active_interactive_logon (Event_ID_4624, Type 2/10) for that host. IF no_interactive_logon. HIGH_PRIORITY_ALERT.
  - question: Has any host exhibited a statistically significant increase in the rate of 'new device connection followed by external network connection' events?
    context: >-
      This question establishes a behavioral baseline for each host to detect unusual spikes in activity. While a single instance of a device connection followed by network traffic might be normal (e.g., a user plugging in a USB network adapter), a sudden flurry of these events is abnormal and could indicate an adversary testing or deploying multiple devices. A Poisson model helps quantify 'what is a significant deviation' from the norm for that host.
    answer_sources:
      - Windows Event ID 6416
      - Zeek conn.log
      - Windows Event ID 4624
      - Domain Controllers, database servers, and other Tier 0/Tier 1 assets.
    range: last 90 days
    queries:
      - pseudocode: >-
          FOR each host, CALCULATE baseline_rate of (new_device_event -> external_connection_event). MONITOR count of this event_pair in 1-hour windows. IF observed_count > poisson_threshold(baseline_rate). ALERT.
  - question: Has a sequence analysis model detected an improbable or novel chain of events involving a new hardware connection followed by an external network connection?
    context: >-
      This question uses advanced machine learning to understand the 'story' of events on an endpoint. The model learns the normal sequences of operations. A sequence where a hardware connection is immediately followed by a network connection might be flagged as highly improbable (and therefore suspicious) if it has never been observed in that context before, providing a powerful way to detect novel attack patterns.
    answer_sources:
      - Windows Event ID 6416
      - Zeek conn.log
      - Windows Event ID 4624
      - Domain Controllers, database servers, and other Tier 0/Tier 1 assets.
    range: last 90 days
    queries:
      - pseudocode: >-
          STREAM host_events into sequence_analysis_model (HMM/LSTM). IF model identifies a sequence containing [New_Hardware_Detected -> New_External_Connection] with a low_probability_score. ALERT.
  - question: Is an interactive process (like cmd.exe or powershell.exe) being run by a user account on a critical asset when that user is not actively logged in?
    context: >-
      This question looks for 'ghost in the machine' activity, where actions are being taken under a user's context without them being legitimately logged on. This is a strong indicator of a compromised session or the use of stolen credentials by an attacker or remote access tool. Excluding service accounts and known scheduled tasks helps reduce false positives.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Windows Event ID 4634
      - Critical servers, administrative workstations, and systems with access to sensitive intellectual property.
    range: last 90 days
    queries:
      - pseudocode: >-
          SEARCH process_creation (Event_ID_4688) on critical_assets. FILTER process is interactive (cmd, powershell) AND user is not a service_account. CHECK for active logon_session (Type 2, 3, 10) for that user at that time. IF no_active_session AND not a known_scheduled_task. HIGH_SEVERITY_ALERT.
  - question: Has there been a statistical anomaly in which parent processes are launching interactive shells, such as a rare parent process or a sudden increase in the variety of parent processes?
    context: >-
      This question detects unusual execution flows. Normally, shells are spawned by a predictable set of parent processes (like explorer.exe). If a rare process (e.g., a web server's worker process) suddenly spawns cmd.exe, or if many different processes start spawning shells (high entropy), it's a strong statistical sign that an attacker is moving laterally or executing commands through an exploit.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Windows Event ID 4634
      - Critical servers, administrative workstations, and systems with access to sensitive intellectual property.
    range: last 90 days
    queries:
      - pseudocode: >-
          PROFILE parent-child process relationships for each host. FOR processes like cmd.exe/powershell.exe, CALCULATE entropy of parent_process_names over time. ALERT on sudden entropy_spike. ADDITIONALLY, ALERT if a statistically rare parent_process spawns a shell.
  - question: Has an anomaly detection model flagged any process creation events that occur without an active user logon as deviating from normal background activity?
    context: >-
      This question uses machine learning to establish a sophisticated baseline of all legitimate non-interactive activity (like system tasks, updates, services). The model can then identify any new process that doesn't fit this learned pattern, based on a combination of factors like the user, parent process, command line, and time of day. This is effective at catching novel or evasive techniques.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Windows Event ID 4634
      - Critical servers, administrative workstations, and systems with access to sensitive intellectual property.
    range: last 90 days
    queries:
      - pseudocode: >-
          TRAIN anomaly_detection_model on features of historical process_creation_events where no_active_logon. APPLY model to new non-interactive process events. IF model_flags_event as anomaly. ALERT.
  - question: Are any servers maintaining long-lived, low-data-volume connections to external IPs over non-standard ports?
    context: >-
      This question targets a classic C2 pattern: the 'low and slow' connection. Malicious implants often maintain a persistent connection to an attacker's server, sending only small amounts of data (heartbeats) to stay alive. This rule looks for these specific characteristics—long duration, low traffic, unusual port—on critical servers, which typically have more predictable network behavior.
    answer_sources:
      - Zeek conn.log
      - Network egress points and firewalls monitoring traffic from critical server subnets and user VLANs.
    range: last 90 days
    queries:
      - pseudocode: >-
          SEARCH network_logs (conn.log). FILTER source is server_asset AND destination is external_ip. WHERE port is non-standard AND duration > 12_hours AND total_bytes < 50_KB. EXCLUDE approved_services. ALERT.
  - question: Are there any new network connections that are statistical outliers in terms of having an unusually long duration and unusually low data volume for that specific host?
    context: >-
      This question creates a dynamic, host-specific baseline of normal network behavior. Instead of using fixed thresholds, it identifies what 'long duration' and 'low volume' mean for each individual host. A connection that is an outlier on both metrics simultaneously is a strong statistical indicator of a C2 channel that is trying to blend in.
    answer_sources:
      - Zeek conn.log
      - Network egress points and firewalls monitoring traffic from critical server subnets and user VLANs.
    range: last 90 days
    queries:
      - pseudocode: >-
          FOR each host, BASELINE distribution of (connection_duration, total_bytes). FOR each new_connection. IF new_connection.duration > 98th_percentile AND new_connection.total_bytes < 5th_percentile. ALERT.
  - question: Is there a strong, periodic signal (beaconing) in the network connection patterns between any internal host and an external destination?
    context: >-
      This question uses time series analysis to detect the rhythmic 'heartbeat' of C2 beaconing. Malware often communicates at very regular intervals (e.g., every 5 minutes). By analyzing the timing between connections to the same destination, this technique can uncover this automated, machine-like periodicity, which is very different from the more random patterns of human-generated traffic.
    answer_sources:
      - Zeek conn.log
      - Network egress points and firewalls monitoring traffic from critical server subnets and user VLANs.
    range: last 90 days
    queries:
      - pseudocode: >-
          GROUP network_logs by (source_host, destination_ip). CREATE time_series from connection_timestamps. APPLY fourier_transform or autocorrelation. IF strong_periodicity_detected. ALERT.