name: T1090.003: Multi-hop Proxy
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps investigate whether an adversary is using multi-hop proxy chains for command and control. It focuses on identifying several key indicators, including outbound connections to known malicious infrastructure like Tor exit nodes or C2 servers; anomalous TLS handshakes identified by JA3/JA3S hashes or suspicious X.509 certificate properties (e.g., self-signed, short validity, high entropy); traffic patterns indicative of pivoting, such as low fan-in from external sources and high fan-out to internal destinations; beaconing behavior characterized by low jitter and consistent data volumes; and protocol tunneling through methods like oversized ICMP packets or high-entropy DNS queries.
type: technique
related:
  - TA0011: Command and Control
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are internal assets connecting to external IP addresses or domains known to be associated with Tor, public proxies, or C2 servers?
    context: This question aims to detect direct communication with known malicious or anonymizing infrastructure. By correlating outbound network traffic with threat intelligence feeds, analysts can identify compromised assets that are being used for command and control or data exfiltration through proxy networks. A match provides a high-confidence indicator of malicious activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5156
      - Network Egress Points
      - Centralized DNS Resolvers
      - Endpoint Devices
      - Threat Intelligence Feeds
    range: last 90 days
    queries:
      - "Pseudocode: JOIN conn_logs with dns_logs on IP. JOIN results with threat_intel_feed on IP/domain. ALERT on match."
  - question: Are outbound connections being made to statistically rare Autonomous System Numbers (ASNs) or countries with no business nexus?
    context: This question seeks to identify connections to unusual network providers or geographic locations that deviate from the organization's normal traffic patterns. Adversaries often use newly registered or obscure hosting providers for their proxy infrastructure. Flagging connections to destinations that are statistically rare for the organization can uncover C2 channels that are not yet present in threat intelligence feeds.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5156
      - Network Egress Points
      - Centralized DNS Resolvers
      - Endpoint Devices
    range: last 90 days
    queries:
      - "Pseudocode: For each outbound connection, CALCULATE historical frequency of destination ASN/country. ALERT if frequency is in bottom 5th percentile."
  - question: Can we classify new outbound network connections as benign, suspicious-proxy, or malicious-proxy using a machine learning model?
    context: This question leverages a machine learning model to proactively identify and score potentially malicious proxy traffic in real-time. By training a classifier on features like destination port, data volume, connection duration, and threat intelligence hits, the model can learn the subtle characteristics of proxy usage and flag suspicious connections that might be missed by rule-based methods.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Windows Event ID 5156
      - Network Egress Points
      - Centralized DNS Resolvers
      - Endpoint Devices
    range: last 90 days
    queries:
      - "Pseudocode: EXTRACT features (port, bytes, duration, ASN rarity) from new network flows. INPUT features into trained classification model. ALERT if classification is 'suspicious-proxy' or 'malicious-proxy'."
  - question: Are there any observed TLS handshakes with JA3/JA3S hashes matching known C2 tools, or with self-signed or short-lived X.509 certificates?
    context: This question focuses on identifying malicious TLS traffic by its fingerprint. C2 frameworks and proxy tools often have unique JA3/JA3S signatures. Additionally, adversaries frequently use self-signed or certificates with abnormally short validity periods to encrypt their traffic. Detecting these characteristics can reveal C2 channels masquerading as legitimate encrypted traffic.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Internal Server Segments
      - DMZ
    range: last 90 days
    queries:
      - "Pseudocode: SCAN ssl.log for JA3/JA3S hashes in C2_fingerprint_watchlist. SCAN x509.log for self-signed or short-validity certificates. ALERT on match."
  - question: Are there X.509 certificates with high-entropy subject or issuer names, suggesting they were algorithmically generated?
    context: This question tries to find C2 infrastructure by looking for signs of automation in certificate creation. Many C2 frameworks algorithmically generate random-looking domain names and corresponding certificate fields. Calculating the Shannon entropy of these fields can effectively identify such non-human-generated names, pointing to potential C2 servers.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Internal Server Segments
      - DMZ
    range: last 90 days
    queries:
      - "Pseudocode: For each certificate in x509.log, CALCULATE Shannon entropy of subject/issuer fields. ALERT if entropy > 3.5."
  - question: Are there anomalous TLS handshakes that deviate from the established baseline of legitimate sessions?
    context: This question uses anomaly detection to find malicious TLS traffic without relying on known signatures. By training a model on the features of legitimate TLS sessions within the environment, it can identify outliers that exhibit unusual characteristics in their JA3 hash, cipher suites, or certificate details. These anomalies may represent new or unknown C2 or proxy tools.
    answer_sources:
      - Zeek ssl.log
      - Zeek x509.log
      - Network Egress Points
      - Internal Server Segments
      - DMZ
    range: last 90 days
    queries:
      - "Pseudocode: TRAIN one-class SVM/autoencoder on legitimate TLS features. For new TLS sessions, CALCULATE anomaly score. ALERT on high scores."
  - question: Is any internal host exhibiting a pivoting traffic pattern, with a low number of external sources connecting to it and a high number of subsequent connections from it to internal destinations?
    context: This question aims to identify compromised hosts that are being used as internal proxies or pivot points. An adversary who gains a foothold on one machine (e.g., in the DMZ) will use it to scan and move laterally to other internal systems. This behavior creates a distinct 'fan-out' traffic pattern (low fan-in, high fan-out) that can be detected by counting unique source and destination IPs over a time window.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Demilitarized Zone (DMZ)
      - User Workstation Subnets
      - Critical Server VLANs
    range: last 90 days
    queries:
      - "Pseudocode: For each host over 1-hour window, COUNT distinct external sources and distinct internal destinations. ALERT if sources < 3 AND destinations > 10."
  - question: Are any hosts exhibiting an anomalously high 'pivot score', indicating a disproportionate ratio of outbound destinations to inbound sources?
    context: This question provides a statistical method for identifying the pivoting behavior described previously. By calculating a 'pivot score' for each host, we can quantify the degree of fan-out. By comparing this score against a baseline distribution for all assets, we can flag hosts whose behavior is a statistical outlier, suggesting they are acting as an internal relay for an attacker.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Demilitarized Zone (DMZ)
      - User Workstation Subnets
      - Critical Server VLANs
    range: last 90 days
    queries:
      - "Pseudocode: For each host, CALCULATE pivot_score = (1 + outbound_dests) / (1 + inbound_srcs). ALERT if pivot_score > 99th percentile of population."
  - question: Can we identify hosts acting as anomalous bridges between traffic communities using graph analysis?
    context: This question applies graph theory to network traffic to find pivot points. By modeling hosts as nodes and connections as edges, we can identify normal 'communities' of hosts that frequently communicate. A compromised host used for pivoting will often act as an unnatural bridge between these communities. Graph metrics like 'betweenness centrality' can quantify this 'bridging' role, and anomaly detection can flag hosts with unusually high scores.
    answer_sources:
      - Zeek conn.log
      - Windows Event ID 5156
      - Demilitarized Zone (DMZ)
      - User Workstation Subnets
      - Critical Server VLANs
    range: last 90 days
    queries:
      - "Pseudocode: BUILD network graph from conn.log. IDENTIFY communities (Louvain). RUN anomaly detection (Isolation Forest) on graph metrics (centrality, degree). ALERT on anomalous hosts."
  - question: Are any hosts making a high frequency of connections to non-categorized or newly observed domains on common C2 ports?
    context: This question is a simple rule-based check for common beaconing behavior. C2 implants often connect back to their server on a regular basis. If a host makes a large number of connections to a single, unknown destination over a short period (e.g., one hour), it is a strong indicator of automated C2 communication, especially if the destination is a newly observed domain.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - User Workstation Subnets
      - Server Subnets
      - Network Egress Points
    range: last 90 days
    queries:
      - "Pseudocode: IDENTIFY connections to new/uncategorized domains on ports 80, 443, 53. COUNT connections per source-destination pair in 1 hour. ALERT if count > 50."
  - question: Are there any source-destination communication pairs exhibiting machine-like beaconing characteristics, such as low jitter and low data volume variance?
    context: This question looks for the statistical hallmarks of automated C2 beaconing. Unlike human-generated traffic, automated beacons are highly regular. This regularity appears as very low variation (standard deviation) in the time between connections (jitter) and in the amount of data sent in each connection. Identifying pairs with these characteristics can uncover C2 channels designed to be stealthy.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - User Workstation Subnets
      - Server Subnets
      - Network Egress Points
    range: last 90 days
    queries:
      - "Pseudocode: For each source-dest pair over 24 hours, CALCULATE std_dev of time between connections and variance of bytes transferred. ALERT if time_std_dev < 2s and byte_variance is low."
  - question: Can we detect highly periodic signals in connection time series data, indicative of C2 beaconing, using a Fast Fourier Transform (FFT)?
    context: This question applies signal processing techniques to find C2 beaconing. A time series of connection events for a beaconing implant will be highly periodic. Applying an FFT to this time series transforms it into the frequency domain, where a periodic signal will appear as a sharp spike. The magnitude of this spike can be used as a feature to reliably detect beaconing activity, even if the timing is slightly irregular.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - User Workstation Subnets
      - Server Subnets
      - Network Egress Points
    range: last 90 days
    queries:
      - "Pseudocode: For each source-dest pair, create time series of connection counts. APPLY FFT to time series. ALERT if a strong peak is detected in the frequency spectrum."
  - question: Is there evidence of protocol tunneling, such as ICMP packets with large payloads, very long DNS queries, or encrypted traffic to unauthorized network devices?
    context: This question looks for blatant misuse of common protocols to tunnel C2 traffic. Adversaries abuse protocols like ICMP and DNS because they are often permitted through firewalls. Telltale signs include ICMP packets carrying data payloads (size > 64 bytes), DNS queries being used to exfiltrate data (long query strings), or attempts to establish encrypted channels (SSH, TLS) with network infrastructure not intended for such communication.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek icmp.log
      - Zeek weird.log
      - Network Infrastructure Segments (Routers, Switches)
      - DNS Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - "Pseudocode: ALERT on ICMP payload > 64 bytes, DNS query length > 250 chars, or SSH/TLS to non-approved network devices."
  - question: Is there DNS traffic with high-entropy query names or an unusually high ratio of TXT to A queries, suggesting DNS abuse for C2?
    context: This question identifies statistical indicators of DNS tunneling. Adversaries using Domain Generation Algorithms (DGAs) create random-looking subdomains for C2, which have high entropy. They may also use DNS TXT records to carry C2 commands or exfiltrate data, leading to a client making an abnormally high number of TXT queries compared to standard A record lookups. Monitoring for these statistical deviations can uncover DNS-based C2 channels.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek icmp.log
      - Zeek weird.log
      - Network Infrastructure Segments (Routers, Switches)
      - DNS Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - "Pseudocode: For DNS queries, CALCULATE entropy of query name; ALERT if > 4.0. For each client, CALCULATE TXT/A query ratio; ALERT if ratio > 98th percentile."
  - question: Can we detect anomalous protocol traffic that deviates from learned normal patterns using a machine learning autoencoder?
    context: This question uses an unsupervised machine learning approach to find novel or unknown tunneling techniques. An autoencoder is trained to 'reconstruct' feature vectors from legitimate protocol traffic (e.g., DNS query type/length, ICMP type/code). When presented with malicious or tunneled traffic that deviates from this learned norm, the model will have a high 'reconstruction error,' flagging the traffic as anomalous and worthy of investigation.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Zeek icmp.log
      - Zeek weird.log
      - Network Infrastructure Segments (Routers, Switches)
      - DNS Servers
      - Network Egress Points
    range: last 90 days
    queries:
      - "Pseudocode: TRAIN autoencoder on legitimate protocol feature vectors. For new traffic, CALCULATE reconstruction error. ALERT on high error."