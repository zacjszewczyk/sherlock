name: "T1095: Non-Application Layer Protocol"
id: "9d8c7b6a-5e4f-4d3c-2b1a-0987654321fe"
description: "This playbook helps to determine if an adversary has established command and control (C2) using a non-application layer protocol such as ICMP, or raw TCP/UDP. It focuses on detecting abnormal network traffic patterns that deviate from standard protocol usage. This includes identifying connections to known malicious infrastructure, analyzing traffic for signs of tunneling (e.g., unusual payload sizes, high entropy, skewed request-to-reply ratios), detecting periodic beaconing behavior, and correlating network activity with suspicious host-level processes that are not typical network diagnostic tools."
type: "technique"
related:
  - "TA0011: Command and Control"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Has an internal host initiated outbound ICMP, UDP, or raw TCP communication to a known command and control IP address?"
    context: "This question aims to detect direct communication to malicious infrastructure identified by threat intelligence. A match provides a high-confidence indicator that an internal host is compromised and communicating with an adversary's C2 server using a non-standard protocol."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points (e.g., Internet Gateway, VPN Concentrators)"
      - "Threat Intelligence Feed"
    range: "Last 90 days"
    queries:
      - "pseudocode": "SEARCH Zeek logs (conn, icmp) WHERE protocol IN ('icmp', 'udp', 'tcp') AND is_outbound. JOIN destination_ip WITH threat_intel_feed. RETURN match."
  - question: "Is any internal host contacting an anomalously high number of unique external destinations via ICMP compared to its own baseline?"
    context: "This question detects behavioral anomalies. A sudden spike in the number of unique ICMP destinations for a specific host could indicate activities like network reconnaissance (ping sweeps) or a C2 mechanism that cycles through different destination IPs. It helps find unknown C2 infrastructure not present in threat feeds."
    answer_sources:
      - "Zeek icmp.log"
      - "Network Egress Points (e.g., Internet Gateway, VPN Concentrators)"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each source_ip: CALCULATE daily_unique_destination_count (ICMP). COMPARE to 30-day rolling baseline. ALERT IF daily_count > (baseline + 3 * std_dev)."
  - question: "Are there any outbound connections to external IPs that are predicted to be C2 servers by a machine learning model?"
    context: "This question leverages machine learning to proactively identify potential C2 servers based on a combination of network traffic features and IP metadata. It can uncover previously unknown or unlisted C2 infrastructure by identifying characteristics common to malicious servers."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points (e.g., Internet Gateway, VPN Concentrators)"
      - "IP Enrichment Data (ASN, GeoIP)"
      - "Threat Intelligence Scores"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each outbound_connection: EXTRACT features (duration, bytes, protocol, ASN, geo, etc.). PREDICT is_c2 using classification_model. ALERT IF prediction_confidence > threshold."
  - question: "Does any ICMP traffic contain payload signatures matching known ICMP tunneling tools?"
    context: "This question seeks to identify the use of specific, known C2 tools that abuse the ICMP protocol for tunneling data. A signature match provides strong evidence of a particular tool (e.g., icmpsh, Loki) being used, which can inform subsequent incident response actions."
    answer_sources:
      - "Zeek icmp.log"
      - "Internal Network Segments and Core Switches"
    range: "Last 90 days"
    queries:
      - "pseudocode": "SCAN ICMP packet payloads FOR signatures of known C2 tools (e.g., icmpsh, Loki). ALERT on match."
  - question: "Are there any ICMP communication flows exhibiting a highly imbalanced ratio of echo-requests to echo-replies?"
    context: "Normal 'ping' activity results in a near 1:1 ratio of requests to replies. A heavily skewed ratio suggests that the ICMP protocol is not being used for simple reachability checks, but rather for unidirectional data transfer, a common characteristic of C2 communication or data exfiltration via ICMP tunneling."
    answer_sources:
      - "Zeek icmp.log"
      - "Internal Network Segments and Core Switches"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each src_ip, dst_ip pair (ICMP): CALCULATE ratio of echo_requests to echo_replies over 1hr. ALERT IF ratio is highly skewed (e.g., >10 or <0.1)."
  - question: "Are there any sequences of ICMP packets that are anomalous compared to a model of normal ICMP behavior?"
    context: "This question uses advanced anomaly detection to identify subtle, complex patterns in ICMP traffic that deviate from normal behavior. An RNN/LSTM model can learn the typical sequences of packet sizes, timings, and types, and flag new sequences that do not fit, potentially uncovering novel or sophisticated ICMP tunneling techniques."
    answer_sources:
      - "Zeek icmp.log"
      - "Internal Network Segments and Core Switches"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each ICMP flow: CREATE feature sequence (payload_length, inter-arrival_time, type/code). CALCULATE reconstruction_error using RNN/LSTM model. ALERT IF error > threshold."
  - question: "Has any outbound ICMP, UDP, or TCP traffic on a non-standard port shown an unusually large payload size?"
    context: "Legitimate ICMP packets typically have small or no payloads. An unusually large payload can be an indicator of data exfiltration or C2 commands being tunneled within these protocols. This question aims to catch this blunt but effective technique."
    answer_sources:
      - "Zeek icmp.log"
      - "Zeek conn.log"
      - "Network Egress Points"
    range: "Last 90 days"
    queries:
      - "pseudocode": "SEARCH Zeek logs (conn, icmp) WHERE is_outbound. ALERT IF (protocol='icmp' AND payload_size > 1024) OR (protocol IN ('udp','tcp') AND port is non-standard AND avg_packet_size > 1024)."
  - question: "Is there any outbound network traffic using ICMP or raw UDP/TCP with unusually high payload entropy?"
    context: "High Shannon entropy suggests that data is random, which is a characteristic of encrypted or compressed data. Since non-application layer protocols do not typically carry encrypted payloads, high entropy is a strong indicator of an adversary hiding C2 communications or exfiltrating data."
    answer_sources:
      - "Zeek icmp.log"
      - "Zeek conn.log"
      - "Network Egress Points"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each outbound flow (ICMP, UDP, TCP): CALCULATE payload_entropy. COMPARE to historical baseline for that protocol. ALERT IF entropy > 99th percentile."
  - question: "Can any network flows be grouped into anomalous clusters based on their traffic characteristics?"
    context: "This question applies unsupervised machine learning to find 'needles in a haystack.' By clustering all network flows, normal traffic will form large, dense clusters. C2 traffic using non-standard protocols will likely form small, distinct clusters or be identified as outliers, allowing analysts to focus their investigation on these statistical anomalies."
    answer_sources:
      - "Zeek icmp.log"
      - "Zeek conn.log"
      - "Network Egress Points"
    range: "Last 90 days"
    queries:
      - "pseudocode": "CLUSTER all network flows using features (protocol, port, bytes, avg_size, entropy). IDENTIFY and investigate outlier clusters."
  - question: "Is a process not on the approved allowlist (e.g., not ping.exe) initiating outbound ICMP connections?"
    context: "On a host, only a small, predictable set of utilities should be making ICMP requests. If an unexpected process (like powershell.exe or a custom malware executable) is observed making ICMP connections, it is a very strong indicator of malicious activity. Correlating with process creation events provides crucial context."
    answer_sources:
      - "Windows Event ID 5156"
      - "Windows Event ID 4688"
      - "User Workstations and Critical Servers"
    range: "Last 90 days"
    queries:
      - "pseudocode": "SEARCH for EventID 5156 with Protocol=1 (ICMP). EXTRACT ApplicationName. ALERT IF ApplicationName is not in allowlist. ENRICH with parent process and command line from related EventID 4688."
  - question: "Are there any rare or unique processes making ICMP connections across the entire enterprise?"
    context: "This question uses stack-ranking to find outliers. By ranking all processes that make ICMP connections by frequency, common benign processes will be at the top, while rare and potentially malicious processes will be at the bottom. This is a powerful hunting technique for finding disguised or novel malware."
    answer_sources:
      - "Windows Event ID 5156"
      - "User Workstations and Critical Servers"
    range: "Last 90 days"
    queries:
      - "pseudocode": "AGGREGATE all processes making ICMP connections (from EventID 5156) across all hosts. RANK processes by frequency. ALERT on rarest processes (e.g., bottom 1%)."
  - question: "Does a machine learning model classify any process initiating a network connection as malicious based on its combined host and network behavior?"
    context: "This question uses a holistic machine learning approach, combining host-based process metadata with network connection details. By training a model to recognize the multifaceted characteristics of malicious activity, it can detect sophisticated threats that might evade simpler, single-indicator rules."
    answer_sources:
      - "Windows Event ID 5156"
      - "Windows Event ID 4688"
      - "User Workstations and Critical Servers"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each network connection event (EID 5156): GATHER features (process name, parent, path, protocol, port). PREDICT is_malicious using classification_model. ALERT IF prediction_confidence > threshold."
  - question: "Has Zeek detected any weird or anomalous network behavior related to non-standard protocols?"
    context: "Zeek's weird.log is designed to flag protocol violations. Events like 'active_connection_without_SYN' are highly anomalous and can be a strong indicator of a custom C2 channel that doesn't adhere to standard RFCs, providing a pre-built anomaly detection mechanism."
    answer_sources:
      - "Zeek weird.log"
      - "Network Egress Points and Internal Network Segments"
    range: "Last 90 days"
    queries:
      - "pseudocode": "SEARCH Zeek weird.log FOR notices like 'active_connection_without_SYN' or 'data_before_established'. ALERT on any such notice related to UDP or ICMP."
  - question: "Is any outbound ICMP or UDP traffic exhibiting highly regular, periodic beaconing behavior?"
    context: "C2 implants often 'phone home' on a fixed schedule, resulting in traffic with extremely consistent time intervals. By calculating the standard deviation of these intervals, we can mathematically identify this machine-like regularity, a classic sign of C2 beaconing."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points and Internal Network Segments"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each src_ip, dst_ip pair (ICMP, UDP): CALCULATE time_delta between connections over 24hrs. CALCULATE standard_deviation of time_deltas. ALERT IF std_dev is very low (e.g., < 1s)."
  - question: "Does a frequency analysis of connection events reveal a strong, periodic signal indicative of C2 beaconing?"
    context: "This is an advanced method for detecting beaconing. A Fast Fourier Transform (FFT) converts a time-based signal into a frequency-based signal. A strong peak in the frequency domain indicates a dominant, repeating cycle, even with jitter, which can detect more sophisticated beaconing."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek icmp.log"
      - "Network Egress Points and Internal Network Segments"
    range: "Last 90 days"
    queries:
      - "pseudocode": "FOR each src_ip, dst_ip flow: APPLY FFT to connection timestamps. IDENTIFY dominant frequencies. ALERT IF a strong, non-benign periodic signal is detected."