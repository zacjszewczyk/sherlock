name: T1087.002: Domain Account
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: This playbook helps to determine if an adversary is actively enumerating domain accounts or groups. This involves detecting the use of known Active Directory enumeration tools (e.g., SharpHound, AdRecon), native utilities (e.g., net.exe, dsquery.exe, PowerShell), and specific PowerShell script blocks containing enumeration cmdlets (e.g., Get-ADUser). It also focuses on identifying anomalous network traffic, such as unusual volumes of LDAP or SAMR queries, and Kerberos TGS requests that indicate Kerberoasting attempts. The playbook aims to uncover these activities by analyzing process creation events, command-line arguments, script block contents, network logs, and correlating sequences of discovery commands to provide comprehensive investigative context.
type: technique
related:
  - TA0007: Discovery
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a known Active Directory enumeration tool being executed?
    context: This question aims to identify the direct execution of malicious tools like SharpHound or AdRecon. Detecting these tools by name or unique command-line parameters is a high-fidelity indicator of targeted reconnaissance activity against Active Directory.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers, Member Servers, Privileged User Workstations
    range: Last 90 days
    queries:
      - pseudocode: SEARCH process_creation_events (event_id=4688) WHERE process_name IN ('sharphound.exe', 'adrecon.exe', 'bloodhound-python') OR command_line CONTAINS unique tool arguments
  - question: Is a process exhibiting unusually high command-line entropy, potentially indicating an obfuscated enumeration script?
    context: Adversaries often obfuscate their scripts to evade signature-based detections. High command-line entropy can be a sign of packed or encoded commands, especially when originating from unexpected parent processes like web servers or PowerShell. This helps detect unknown or modified tools.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers, Member Servers, Privileged User Workstations
    range: Last 90 days
    queries:
      - pseudocode: SEARCH process_creation_events | CALCULATE entropy(command_line) | WHERE entropy > baseline_threshold AND parent_process_name IN ('w3wp.exe', 'powershell.exe')
  - question: Does a machine learning model classify a process creation event as a high-probability malicious enumeration activity?
    context: This question leverages machine learning to move beyond simple signatures. By training a model on features like parent process, user context, and command-line characteristics, we can identify subtle patterns of malicious enumeration that might otherwise be missed by traditional rules.
    answer_sources:
      - Windows Event ID 4688
      - Domain Controllers, Member Servers, Privileged User Workstations
    range: Last 90 days
    queries:
      - pseudocode: STREAM process_creation_events | APPLY ML_model_AD_enumeration | WHERE prediction_score > 0.9
  - question: Are native Windows utilities like 'net.exe' or 'dsquery.exe' being used for domain enumeration?
    context: Adversaries use "living-off-the-land" binaries (LOLBins) like net.exe to perform discovery without dropping new tools on disk. This question looks for specific command-line arguments associated with domain user, group, or trust enumeration, especially from non-interactive or suspicious parent processes.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, All Endpoint Devices
    range: Last 90 days
    queries:
      - pseudocode: SEARCH process_creation_events (event_id=4688) WHERE process_name IN ('net.exe', 'dsquery.exe', 'nltest.exe') AND command_line CONTAINS ('/domain', '\"Domain Admins\"', 'dsquery user', '/dclist')
  - question: Has a host shown a statistically significant increase in the execution frequency of discovery-related native utilities?
    context: While occasional use of these utilities can be normal for administrators, a sudden spike in their usage on a single host can indicate an automated script or an adversary manually exploring the domain. This question uses baselining to detect anomalous frequency.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, All Endpoint Devices
    range: Last 90 days
    queries:
      - pseudocode: SEARCH process_creation_events (process_name IN ('net.exe', 'dsquery.exe')) | TIME_AGGREGATE count by host | WHERE count > 95th_percentile_baseline
  - question: Are there clusters of process executions that deviate from normal administrative behavior?
    context: This question uses unsupervised machine learning to find groups of related, suspicious activities. By clustering executions based on user, host, parent process, and time, we can identify coordinated discovery campaigns that might appear as isolated, low-priority events when viewed individually.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, All Endpoint Devices
    range: Last 90 days
    queries:
      - pseudocode: SEARCH process_creation_events | EXTRACT features (user, host, parent_process) | APPLY clustering_algorithm | IDENTIFY anomalous_clusters
  - question: Does a decoded PowerShell script block contain cmdlets or functions associated with Active Directory enumeration?
    context: PowerShell is a powerful tool for both administration and attacks. This question inspects the content of executed PowerShell scripts (via Event ID 4104) for specific enumeration cmdlets (e.g., Get-ADUser), functions from popular hacking frameworks like PowerView, or broad queries that suggest reconnaissance.
    answer_sources:
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, Privileged User Workstations, Exchange Servers
    range: Last 90 days
    queries:
      - pseudocode: SEARCH powershell_script_block_logs (event_id=4104) WHERE script_text MATCHES_REGEX ('Get-ADUser', 'Get-ADGroupMember', 'Get-NetUser', '-Filter *')
  - question: Is a PowerShell script block exhibiting high entropy or an unusual character ratio, suggesting obfuscation?
    context: To bypass keyword-based detections, adversaries often obfuscate PowerShell code. This question analyzes the statistical properties of the script text itself. High entropy or a skewed ratio of letters to special characters can reveal attempts to hide malicious enumeration commands.
    answer_sources:
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, Privileged User Workstations, Exchange Servers
    range: Last 90 days
    queries:
      - pseudocode: SEARCH powershell_script_block_logs (event_id=4104) | CALCULATE entropy(script_text), char_ratio(script_text) | WHERE entropy > baseline_entropy OR char_ratio > baseline_ratio
  - question: Has a user generated a volume of PowerShell enumeration events that significantly exceeds their predicted normal behavior?
    context: This question applies time-series analysis to model a user's normal rate of PowerShell enumeration activity. An alert is triggered when the actual activity level spikes far above the forecasted amount, indicating a potential burst of automated or manual discovery.
    answer_sources:
      - Windows Event ID 4104
      - Domain Controllers, Member Servers, Privileged User Workstations, Exchange Servers
    range: Last 90 days
    queries:
      - pseudocode: SEARCH powershell_enumeration_events | FORECAST volume by user | WHERE actual_volume > predicted_volume_upper_bound
  - question: Has a non-administrative account attempted to read the membership of a sensitive Active Directory group?
    context: This is a high-fidelity detection method. By placing a specific audit entry (SACL) on critical groups like 'Domain Admins', we can generate an alert (Event ID 4662) whenever any account, particularly a standard user account, tries to enumerate its members. This is a common step in privilege escalation discovery.
    answer_sources:
      - Zeek conn.log
      - Zeek dce_rpc.log
      - Zeek ldap.log
      - Windows Event ID 4662
      - Domain Controllers, Core Network Switches monitoring traffic to/from DCs
    range: Last 90 days
    queries:
      - pseudocode: SEARCH directory_service_access_logs (event_id=4662) WHERE object_name = 'Domain Admins' AND user_account NOT IN (admin_list)
  - question: Is a single source IP generating an anomalous volume of LDAP or SAMR traffic towards a Domain Controller?
    context: Tools like BloodHound generate a large amount of LDAP traffic to map out the domain. This question analyzes network traffic metadata (from sources like Zeek) to find statistical outliers. A host making an unusually high number of queries or transferring an unusually large amount of data is a strong indicator of automated enumeration.
    answer_sources:
      - Zeek conn.log
      - Zeek dce_rpc.log
      - Zeek ldap.log
      - Windows Event ID 4662
      - Domain Controllers, Core Network Switches monitoring traffic to/from DCs
    range: Last 90 days
    queries:
      - pseudocode: SEARCH zeek_ldap_logs | AGGREGATE unique_queries, total_bytes by source_ip | WHERE unique_queries > 99th_percentile OR total_bytes > 99th_percentile
  - question: Does an unsupervised machine learning model flag a network connection to a Domain Controller as a significant outlier?
    context: This question uses an ML model (like Isolation Forest) to find anomalous connections based on multiple features (duration, bytes, operation type). This approach can detect novel or stealthy enumeration techniques that don't trigger simple threshold-based alerts.
    answer_sources:
      - Zeek conn.log
      - Zeek dce_rpc.log
      - Zeek ldap.log
      - Windows Event ID 4662
      - Domain Controllers, Core Network Switches monitoring traffic to/from DCs
    range: Last 90 days
    queries:
      - pseudocode: STREAM zeek_conn_logs to DC | APPLY ML_model_LDAP_anomaly | WHERE prediction = 'outlier'
  - question: Is there evidence of a Kerberoasting attempt via a Kerberos TGS request?
    context: Kerberoasting is a technique to harvest credentials by requesting service tickets for user accounts (which should not have SPNs). This question looks for the specific signature of this attack, a TGS request (Event ID 4769) for a user account SPN using a weak, crackable encryption type (RC4-HMAC).
    answer_sources:
      - Windows Event ID 4769
      - Domain Controllers
    range: Last 90 days
    queries:
      - pseudocode: SEARCH kerberos_tgs_req_logs (event_id=4769) WHERE encryption_type = '0x17' AND service_name NOT LIKE '%$'
  - question: Is a single client requesting Kerberos tickets for an anomalously high number of distinct services?
    context: An adversary may scan for injectable SPNs by requesting tickets for many different services in a short period. This question establishes a baseline for how many distinct services a typical client requests and alerts when a client far exceeds that baseline, indicating a potential reconnaissance scan.
    answer_sources:
      - Windows Event ID 4769
      - Domain Controllers
    range: Last 90 days
    queries:
      - pseudocode: SEARCH kerberos_tgs_req_logs (event_id=4769) | AGGREGATE distinct_count(service_name) by client_address | WHERE distinct_count > 98th_percentile
  - question: Does a machine learning model classify a Kerberos TGS request as abnormal?
    context: This question uses a one-class SVM model, which is trained only on 'normal' data, to identify any TGS request that deviates from established patterns. It considers features like client location, time, and the type of service requested to spot outliers that could be part of an attack.
    answer_sources:
      - Windows Event ID 4769
      - Domain Controllers
    range: Last 90 days
    queries:
      - pseudocode: STREAM kerberos_tgs_req_logs | APPLY one_class_svm_model | WHERE prediction = 'anomaly'
  - question: Is there a correlated sequence of events indicating a logical progression of domain discovery?
    context: Individual discovery commands can be noisy, but a sequence of commands is a much stronger signal. This question looks for a logical chain of events, such as enumerating a privileged group and then immediately enumerating the members of that group, from the same source, within a short time window.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - SIEM / Log Aggregator Platform, Domain Controllers, Member Servers
    range: Last 90 days
    queries:
      - pseudocode: CORRELATE (process_event WHERE command CONTAINS 'group \"Domain Admins\"') FOLLOWED BY (powershell_event WHERE script CONTAINS 'Get-ADGroupMember -Identity \"Domain Admins\"') WITHIN 15m BY user, host
  - question: Has a user's 'Discovery Activity Score' spiked anomalously?
    context: This question moves beyond simple alerts by creating a risk score for users. Different discovery actions are assigned points, and a user's score accumulates over time. An alert is triggered when the score rapidly increases, indicating a concentrated burst of discovery activity that is abnormal for that user.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - SIEM / Log Aggregator Platform, Domain Controllers, Member Servers
    range: Last 90 days
    queries:
      - pseudocode: SEARCH discovery_events | APPLY weighted_score | AGGREGATE sum(score) by user over 1h | DETECT spike in user_score
  - question: Has a statistically rare sequence of discovery commands been observed?
    context: This question uses advanced analytics to find command sequences that are uncommon across the entire organization but are known to be part of an adversary's playbook. This helps surface sophisticated, multi-step discovery TTPs that would not be caught by rules looking for single commands or simple pairs.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - SIEM / Log Aggregator Platform, Domain Controllers, Member Servers
    range: Last 90 days
    queries:
      - pseudocode: SEARCH command_logs | APPLY sequence_mining_algorithm | IDENTIFY sequences that are globally rare but match known TTPs