name: T1542.004: ROMMONkit
id: d3a7b8e1-5f6c-4a9b-8d7e-2c1f0a9b3c4d
description: This playbook helps investigate whether an adversary is maintaining persistence or evading defenses by modifying network device firmware, a technique known as a ROMMONkit. Adversaries may replace a device's legitimate firmware image with a malicious one, such as Cisco's Synful Knock, which can provide backdoor access, manipulate traffic, and hide its own presence [1]. Key investigative activities include detecting the transfer of known malicious firmware images, identifying connections to command and control (C2) infrastructure, analyzing CLI command sequences for unauthorized modification patterns, monitoring for anomalous file transfers (e.g., from unauthorized sources or with unusual sizes), and identifying unexpected device reboots followed by abnormal network activity [2]. The playbook also addresses defense evasion by looking for evidence of targeted traffic filtering (e.g., blocking security scanners), low-level traffic manipulation (e.g., anomalous TTL values or DNS queries), significant deviations in overall traffic flow metrics, and the cessation of expected management traffic like syslog or SNMP.
type: technique
related:
  - TA0003: Persistence
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Have any files transferred to network devices matched known malicious firmware hashes, or have any devices connected to known ROMMONkit C2 infrastructure?
    context: This question aims to detect the primary indicators of a known firmware implant. Malicious images are often delivered via standard file transfer protocols (TFTP, FTP, SCP), and compromised devices will attempt to contact C2 servers for instructions. Matching file hashes against threat intelligence or observing connections to known malicious destinations provides high-confidence evidence of a compromise.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek dns.log
      - Core routers, edge firewalls, TFTP/SCP/FTP management servers, and DNS resolvers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH Zeek files.log FOR files transferred to network devices, calculate hash.
          JOIN file_hash against threat_intelligence_feed of malicious firmware.
          ALERT on match.
          SEARCH Zeek conn.log and dns.log for connections FROM network_device_ips.
          JOIN destination against C2_threat_intelligence_feed.
          ALERT on match.
  - question: Are network devices making DNS queries for domain names with unusually high entropy, potentially indicating DGA-based C2 communication?
    context: Some advanced implants use Domain Generation Algorithms (DGAs) to dynamically create C2 domain names, making blocklist-based detection difficult. High-entropy (highly random) domain names are a common characteristic of DGA. By baselining normal DNS query entropy for each device, we can spot outliers that suggest algorithmic C2 activity.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek dns.log
      - Core routers, edge firewalls, TFTP/SCP/FTP management servers, and DNS resolvers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each DNS query in Zeek dns.log FROM network_device_ips:
            CALCULATE shannon_entropy of query_name.
            RETRIEVE historical entropy_baseline for the source_device.
            IF shannon_entropy > 99th_percentile of entropy_baseline:
              ALERT.
  - question: Have any network devices exhibited a sudden, anomalous increase in outbound connection volume that deviates from their historical baseline?
    context: A newly activated or beaconing firmware implant will generate new network connections. By modeling the expected connection volume for each device and protocol over time, we can detect statistically significant spikes that are not explained by normal behavior. A surge in connections, especially to non-standard ports, is a strong indicator of a potential implant.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek dns.log
      - Core routers, edge firewalls, TFTP/SCP/FTP management servers, and DNS resolvers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MODEL expected outbound connection volume by protocol for each network device using a time-series forecast (e.g., ARIMA).
          FOR each new connection from Zeek conn.log:
            IF observed_connection_volume > forecast_confidence_interval:
              ALERT, noting protocol and port.
  - question: Has a sequence of CLI commands indicative of a firmware modification been executed on any network device?
    context: Adversaries often follow a predictable pattern of commands to install malicious firmware: copy the image, change the boot parameters to point to the new image, and then reload the device. Detecting this specific sequence within a short time window is a strong indicator of an unauthorized modification attempt. The risk is higher if the activity is outside a maintenance window or from a non-standard user/IP.
    answer_sources:
      - Network Device CLI Logs
      - Zeek tftp.log
      - Zeek snmp.log
      - Network device configuration management systems (e.g., TACACS+/RADIUS servers), central syslog aggregators, and core network switches and routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          DEFINE sequence = [`copy tftp flash:`, `config-register`, `boot system flash`, `reload`].
          SEARCH Network Device CLI Logs for the defined sequence per device within a 15-minute window.
          IF sequence detected:
            ENRICH with user, source_ip, and maintenance_window_status.
            ALERT.
  - question: Has any user session on a network device shown an anomalously high number of privileged commands?
    context: Even if an attacker's command sequence doesn't perfectly match a known pattern, their overall activity may be suspicious. By baselining the typical number of privileged commands (like `copy` or `reload`) for each user or role, we can detect sessions where a user performs an unusually high number of administrative actions, which could indicate a compromise or internal misuse.
    answer_sources:
      - Network Device CLI Logs
      - Zeek tftp.log
      - Zeek snmp.log
      - Network device configuration management systems (e.g., TACACS+/RADIUS servers), central syslog aggregators, and core network switches and routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each user and device in Network Device CLI Logs:
            CALCULATE baseline_privileged_command_count_per_session.
          FOR each new session:
            COUNT privileged_commands.
            IF count > (baseline_mean + 3 * baseline_std_dev):
              ALERT.
  - question: Have any network device CLI sessions been classified as malicious by a sequence-based machine learning model?
    context: This question moves beyond simple rules to holistic pattern recognition. A machine learning model (like an RNN or HMM) trained on labeled data can learn the subtle, complex sequences of commands that differentiate a malicious session from a benign one, allowing for the detection of novel or varied attack patterns that rigid rules might miss.
    answer_sources:
      - Network Device CLI Logs
      - Zeek tftp.log
      - Zeek snmp.log
      - Network device configuration management systems (e.g., TACACS+/RADIUS servers), central syslog aggregators, and core network switches and routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          INPUT live stream of Network Device CLI Logs into a trained sequence-classification model (RNN/HMM).
          IF model output class is 'malicious' with high confidence:
            ALERT with session details.
  - question: Have any firmware file transfers to network devices originated from unauthorized IP addresses?
    context: A fundamental security control is to restrict administrative actions, like firmware updates, to a small set of authorized management servers or jump hosts. Monitoring for transfer protocols like TFTP, FTP, or SCP from any IP not on an explicit allow-list is a simple but highly effective way to detect unauthorized and potentially malicious firmware transfer attempts.
    answer_sources:
      - Zeek tftp.log
      - Zeek conn.log
      - Zeek files.log
      - Windows Event ID 4624
      - Management VLANs, administrator workstations, jump servers, and TFTP/SCP/FTP servers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          MAINTAIN allow_list of authorized_firmware_source_ips.
          SEARCH Zeek conn.log for connections on ports 69/udp, 21/tcp, 22/tcp to network_device_ips.
          IF source_ip NOT IN allow_list:
            ALERT.
  - question: Have any firmware files transferred to network devices had a statistically anomalous file size?
    context: Malicious firmware images may be smaller than legitimate ones if they lack full functionality, or larger if they contain extra code or are padded. By establishing a normal range of file sizes for legitimate firmware updates for each device model, we can flag transfers of outlier-sized files, which warrant investigation as potentially malicious.
    answer_sources:
      - Zeek tftp.log
      - Zeek conn.log
      - Zeek files.log
      - Windows Event ID 4624
      - Management VLANs, administrator workstations, jump servers, and TFTP/SCP/FTP servers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each device_model:
            PROFILE historical firmware file sizes from Zeek files.log.
            CALCULATE normal_size_range using IQR method (Q1 - 1.5*IQR, Q3 + 1.5*IQR).
          FOR each new file transfer:
            IF file_size is outside normal_size_range:
              ALERT.
  - question: Have any file transfers to network devices been classified as malicious by a machine learning model?
    context: This approach combines multiple weak signals into a stronger predictor. A model can evaluate features like the source IP's reputation, the time of day, and file size simultaneously. A transfer from a low-reputation IP, at 3 AM, with an unusual file size is more suspicious than any single factor alone, allowing for more nuanced detection.
    answer_sources:
      - Zeek tftp.log
      - Zeek conn.log
      - Zeek files.log
      - Windows Event ID 4624
      - Management VLANs, administrator workstations, jump servers, and TFTP/SCP/FTP servers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          INPUT file transfer events into a trained classification model (e.g., Random Forest).
          FEATURES = [source_ip_rep, time_of_day, day_of_week, file_size, etc.].
          IF model prediction is 'malicious' with high confidence:
            ALERT and correlate with source host login events (e.g., Windows Event ID 4624).
  - question: Did a network device reboot unexpectedly and then connect to a suspicious external destination?
    context: A common step after installing a malicious firmware image is to reboot the device to load it. If this reboot is unscheduled, it's suspicious. If it is immediately followed by the device connecting to a known-bad or unusual external IP address, it strongly suggests the new firmware contains a C2 implant that is "calling home."
    answer_sources:
      - Network Device CLI Logs
      - SNMP Trap Logs
      - Zeek conn.log
      - Zeek dns.log
      - Central syslog aggregators, core and edge network devices, and DNS resolvers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          ON 'reboot' event from syslog/SNMP for a device_ip:
            MONITOR Zeek conn.log for 5 minutes for connections FROM device_ip.
            IF connection is to external_ip on non-standard_port:
              ENRICH external_ip with threat intelligence.
              IF reputation is 'malicious' or 'suspicious':
                ALERT.
  - question: After rebooting, did a network device's network activity deviate from its normal post-reboot baseline?
    context: Healthy network devices exhibit predictable behavior after a reboot, often contacting NTP servers, syslog servers, or other management systems. A compromised device may contact new or different destinations. By baselining the normal set of connections made after a reboot, we can detect anomalies where the device contacts a set of destinations that is significantly different from its established pattern.
    answer_sources:
      - Network Device CLI Logs
      - SNMP Trap Logs
      - Zeek conn.log
      - Zeek dns.log
      - Central syslog aggregators, core and edge network devices, and DNS resolvers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each device, create baseline_connection_set (unique destinations, ports, protocols) from the first 15 mins after legitimate reboots.
          ON new 'reboot' event for a device:
            COLLECT new_connection_set for 15 minutes.
            CALCULATE Jaccard similarity between new_connection_set and baseline_connection_set.
            IF similarity is below threshold OR count of new destinations is high:
              ALERT.
  - question: After an unscheduled reboot, did a network device exhibit network connections flagged as anomalous by an unsupervised model?
    context: This question seeks to find unknown-unknowns in post-reboot traffic. An unsupervised anomaly detection model (like an Isolation Forest) can learn the multi-dimensional characteristics of normal post-reboot connections. It can then flag any new connection that is a statistical outlier across various features (destination, port, bytes, duration) without prior knowledge of what "bad" looks like.
    answer_sources:
      - Network Device CLI Logs
      - SNMP Trap Logs
      - Zeek conn.log
      - Zeek dns.log
      - Central syslog aggregators, core and edge network devices, and DNS resolvers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          TRAIN an unsupervised anomaly detection model (e.g., Isolation Forest) on connection features from legitimate reboot events.
          ON 'unscheduled reboot' event:
            FEED subsequent connection data into the model.
            IF model flags a connection as an anomaly:
              ESCALATE for review.
  - question: Is a network device disproportionately dropping or rejecting connections from known security infrastructure?
    context: A sophisticated firmware implant may try to evade detection by blocking or dropping traffic from security tools like vulnerability scanners or SIEM forwarders. This question looks for evidence of such filtering by checking if the rate of failed connections from a list of trusted security IPs is significantly higher than the failure rate for all other traffic.
    answer_sources:
      - Zeek conn.log
      - Zeek weird.log
      - Security tool subnets, central log collectors, suspect network devices, and network taps monitoring traffic to/from these devices.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          DEFINE security_ips = IP set of all security tools.
          CALCULATE failure_rate_security = (REJ + RST connections) / (total connections) FROM security_ips.
          CALCULATE failure_rate_general = (REJ + RST connections) / (total connections) FROM all other IPs.
          IF failure_rate_security >> failure_rate_general:
            ALERT.
  - question: Has the connection success rate for traffic from security subnets dropped significantly for a specific network device?
    context: This is another way to detect targeted blocking of security tools. Instead of comparing security traffic to general traffic, this method compares a device's current performance to its own history. A sudden, sustained drop in the success rate of connections from security tools, especially when compared to peer devices, suggests a new, localized issue like a malicious filtering rule.
    answer_sources:
      - Zeek conn.log
      - Zeek weird.log
      - Security tool subnets, central log collectors, suspect network devices, and network taps monitoring traffic to/from these devices.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each network device:
            CALCULATE moving average and std_dev of connection success rate ('SF' state) for traffic FROM security_ips.
          IF current success rate drops > 3 std_devs below the moving average:
            ALERT.
  - question: Has there been a sudden spike in connection failures (resets/rejects) for traffic sourced from security subnets?
    context: This question uses time-series anomaly detection to find sudden changes in behavior. A compromised device turning on a new filtering rule would cause an abrupt spike in connection failures from targeted security tools. A time-series model can detect this spike as an anomaly against the historical baseline of normal, low-level connection failures.
    answer_sources:
      - Zeek conn.log
      - Zeek weird.log
      - Security tool subnets, central log collectors, suspect network devices, and network taps monitoring traffic to/from these devices.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          APPLY time-series anomaly detection (e.g., Seasonal Hybrid ESD) to the count of 'REJ' and 'RST' connection states in Zeek conn.log for traffic sourced from security_ips.
          IF a statistically significant spike is detected:
            ALERT.
  - question: Are network devices involved in DNS traffic using non-standard opcodes or unusual record types?
    context: Adversaries may abuse the DNS protocol for C2 communication by hiding data in non-standard fields. A firmware implant could use custom DNS opcodes or request TXT records to exfiltrate data or receive commands. Monitoring for these protocol anomalies, especially from network infrastructure devices, can uncover covert C2 channels.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network TAPs at key aggregation points (e.g., data center core, internet edge), DNS resolvers, and suspect network devices.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          SEARCH Zeek dns.log for traffic from network_device_ips.
          ALERT if query uses non-standard opcode OR requests unusual record types (e.g., TXT) OR has an unusually large response size for its type.
  - question: Are there network traffic flows with anomalous Time-to-Live (TTL) values for their source subnet?
    context: The initial TTL value of an IP packet is typically set to a standard power of 2 (e.g., 64, 128) by the source operating system. A compromised router that injects or modifies packets might use a non-standard or inconsistent TTL. By profiling the expected TTLs for each subnet, we can spot connections with outlier TTLs, which may indicate traffic manipulation by a device-in-the-middle.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network TAPs at key aggregation points (e.g., data center core, internet edge), DNS resolvers, and suspect network devices.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each source subnet, profile the normal distribution of initial TTL values.
          FOR each new connection in Zeek conn.log:
            INFER initial TTL.
            IF initial TTL is a statistical outlier for its source subnet (e.g., in 99.9th percentile):
              ALERT.
  - question: Have any network traffic flows been classified as malicious by a model trained to detect implant-based manipulation?
    context: This question leverages machine learning to detect subtle traffic manipulation. A model can be trained on features from legitimate traffic and traffic known to be manipulated by firmware implants. By analyzing features like TTL, IP flags, and packet timing statistics, the deployed model can classify live traffic flows and identify those that bear the faint fingerprints of a malicious implant.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network TAPs at key aggregation points (e.g., data center core, internet edge), DNS resolvers, and suspect network devices.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          INPUT live traffic flow features from Zeek logs into a trained supervised classification model.
          FEATURES = [initial_ttl, ip_flags, packet_size_std_dev, inter_arrival_time_mean, etc.].
          IF model classifies a flow as 'malicious':
            ALERT.
  - question: Is traffic from a critical internal asset, like a database server, being routed directly to the internet in violation of policy?
    context: A compromised router can override established routing policies. This question sets up a high-confidence "never event" rule. If traffic from a critical asset, which should only communicate through specific internal paths or proxies, is observed going directly to an external IP, it's a clear sign that a routing device on the path has been compromised and is redirecting traffic.
    answer_sources:
      - Zeek conn.log
      - Zeek conn_summary.log
      - Key network choke points, such as internet gateways, data center core switches, and inter-site VPN routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          DEFINE critical_asset_ips = IP set of production databases.
          SEARCH Zeek conn.log for connections FROM critical_asset_ips TO external_ips.
          IF any such connection is found:
            ALERT as a 'never event' policy violation.
  - question: Has the protocol distribution on a key network path suddenly become less diverse?
    context: Normal network traffic is a mix of many protocols. A compromised device might be configured to hijack or prioritize a specific type of traffic for C2 or data exfiltration, causing the overall protocol mix to become less diverse. A sudden drop in the Shannon entropy of the protocol distribution can be an indicator of this manipulation.
    answer_sources:
      - Zeek conn.log
      - Zeek conn_summary.log
      - Key network choke points, such as internet gateways, data center core switches, and inter-site VPN routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each major network path:
            ESTABLISH a baseline of hourly protocol distribution entropy from Zeek conn.log.
          IF observed hourly entropy drops significantly and suddenly from the baseline:
            ALERT.
  - question: Do traffic patterns on a key network device show a significant deviation from a multivariate forecast?
    context: This advanced technique models the relationships between different traffic types (e.g., how an increase in web traffic might relate to an increase in DNS traffic). A Vector Autoregression (VAR) model can forecast this entire system of variables. When the actual observed traffic deviates significantly from this multivariate forecast, it suggests a new, unobserved factor—like a firmware implant—is influencing traffic patterns in a coordinated way.
    answer_sources:
      - Zeek conn.log
      - Zeek conn_summary.log
      - Key network choke points, such as internet gateways, data center core switches, and inter-site VPN routers.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          USE a multivariate time-series model (e.g., VAR) to forecast expected traffic volumes for multiple protocols simultaneously on a key device.
          IF the residual error between observed traffic and the forecast is statistically significant:
            ALERT.
  - question: Has a critical network device stopped sending syslog messages while still being reachable?
    context: This "dead man's switch" detects when a device's logging has been disabled, a common tactic for defense evasion. If a central log server stops receiving messages from a device for an unusual amount of time, but the device is still responding to pings (or other traffic), it strongly implies that the logging service on the device has been intentionally or unintentionally stopped.
    answer_sources:
      - Zeek conn.log
      - Zeek snmp.log
      - Zeek ntp.log
      - Network Device CLI Logs
      - Central Syslog Server Logs
      - Central syslog/SNMP trap servers, NTP servers, and network device management interfaces.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each critical device:
            IF no syslog messages received at Central Syslog Server for > 60 minutes:
              CHECK Zeek conn.log for recent ICMP or other traffic to the device's IP.
              IF device is reachable:
                ALERT for potential log suppression.
  - question: Has the rate of syslog messages from a network device dropped to a statistically anomalous low?
    context: Rather than a complete cessation, an adversary might simply reduce log verbosity to hide specific actions. This question establishes a baseline for the normal rate of syslog message generation for each device. An alert is triggered if the observed rate drops significantly below this baseline for a sustained period, indicating an abnormal reduction in logging.
    answer_sources:
      - Zeek conn.log
      - Zeek snmp.log
      - Zeek ntp.log
      - Network Device CLI Logs
      - Central Syslog Server Logs
      - Central syslog/SNMP trap servers, NTP servers, and network device management interfaces.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          FOR each device, model the expected rate of syslog messages per hour (mean, std_dev).
          IF observed rate < (mean - 3 * std_dev) for a sustained period:
            ALERT.
  - question: Does the volume of management traffic from a network device deviate significantly from its seasonal forecast?
    context: Management traffic (syslog, SNMP, NTP) often has predictable daily and weekly patterns (e.g., less traffic on weekends). A time-series model like Prophet can learn these seasonal patterns and provide a more accurate forecast of expected traffic volume. If a device's actual traffic deviates significantly from this nuanced forecast, it is a strong signal of an anomaly that could be related to a compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek snmp.log
      - Zeek ntp.log
      - Network Device CLI Logs
      - Central Syslog Server Logs
      - Central syslog/SNMP trap servers, NTP servers, and network device management interfaces.
    range: last 90 days
    queries:
      - technology: Pseudocode
        query: |
          USE a seasonal time-series model (e.g., Prophet) to forecast expected management traffic volume (e.g., syslog bytes/hour) for each device.
          IF actual traffic volume significantly deviates from the model's forecast confidence interval:
            ALERT.