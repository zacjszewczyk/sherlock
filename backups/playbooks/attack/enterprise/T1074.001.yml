name: T1074.001: Local Data Staging
id: c4a4b4f8-4a9b-4e8e-9f0a-1b2c3d4e5f6a
description: This playbook helps determine if an adversary is collecting and staging data on local systems before exfiltration. It focuses on detecting the use of known staging tools, the creation of suspicious archive files, command-line and PowerShell patterns used for finding and compressing data, anomalous file system activity where a process reads numerous files before writing a large one, and bursts of network file access from multiple shares to a single host that then creates a local archive.
type: technique
related:
  - TA0009: Collection
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are known malicious staging tools or archive files being created on the system?
    context: This question aims to detect the presence of known malicious tools used for data staging by comparing process and file hashes against a threat intelligence feed. A match, especially in common temporary directories, is a strong indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - User workstations, application servers, and domain controllers, focusing on common staging directories (e.g., C:\Windows\Temp, C:\Perflogs, C:\Users\Public, %APPDATA%\Temp, and user Recycle Bins).
    range: last 90 days
    queries:
      - technology: SIEM
        query: SEARCH process_creation_events (EID 4688) OR file_creation_events (EID 4663) WHERE hash IN (threat_intel_watchlist) AND file_path IN (common_staging_dirs) | ALERT
  - question: Are unusually large archive files being created on a host, potentially by a non-standard process?
    context: This question seeks to identify anomalous data aggregation by baselining the size of archive files created on each host. An archive significantly larger than the norm, especially if created by an unusual process like svchost.exe, suggests data is being collected for exfiltration.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4663
      - User workstations, application servers, and domain controllers, focusing on common staging directories (e.g., C:\Windows\Temp, C:\Perflogs, C:\Users\Public, %APPDATA%\Temp, and user Recycle Bins).
    range: last 90 days
    queries:
      - technology: SIEM/Analytics Platform
        query: SEARCH file_creation_events (EID 4663) WHERE file_extension IN (.zip, .rar, .7z) | BASELINE file_size by host | ALERT if file_size > 95th_percentile_baseline | ENRICH with parent_process (EID 4688) | HIGHLIGHT if parent_process is non-standard
  - question: Can machine learning models identify previously unknown staging tools based on their execution behavior?
    context: This question leverages a machine learning model to proactively detect new or unknown staging tools. By analyzing features like parent process, command-line arguments, and user context, the model can score the probability of a process being malicious, even without a hash match.
    answer_sources:
      - Windows Event ID 4688
      - User workstations, application servers, and domain controllers, focusing on common staging directories (e.g., C:\Windows\Temp, C:\Perflogs, C:\Users\Public, %APPDATA%\Temp, and user Recycle Bins).
    range: last 90 days
    queries:
      - technology: ML Model
        query: INPUT process_creation_events (EID 4688) | EXTRACT_FEATURES (parent_process, user, cmd_length, etc.) | PREDICT with staging_tool_classifier_model | ALERT if probability > 0.90
  - question: Are command-line or PowerShell commands being used to discover, copy, and archive files?
    context: This question looks for the specific syntax and co-occurrence of commands used to systematically find and compress data. Using regular expressions can detect complex command chains that are characteristic of manual data staging.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Command-line and PowerShell execution logs from all endpoints and servers, with heightened monitoring on systems hosting sensitive data (e.g., file servers, developer workstations) or belonging to privileged users.
    range: last 90 days
    queries:
      - technology: SIEM
        query: SEARCH process_creation_events (EID 4688) OR powershell_script_block_logs (EID 4104) WHERE command_line MATCHES REGEX "(dir /s|Get-ChildItem -Recurse).*(copy|robocopy).*(7z|rar|tar|Compress-Archive)" | ALERT
  - question: Is there an unusually complex or obfuscated PowerShell script executing that also contains archiving commands?
    context: This question uses Shannon entropy to detect obfuscation in PowerShell scripts. A high entropy score, combined with the presence of archiving cmdlets, suggests an attacker is trying to hide their data staging activities within a complex script.
    answer_sources:
      - Windows Event ID 4104
      - Command-line and PowerShell execution logs from all endpoints and servers, with heightened monitoring on systems hosting sensitive data (e.g., file servers, developer workstations) or belonging to privileged users.
    range: last 90 days
    queries:
      - technology: SIEM/Analytics Platform
        query: SEARCH powershell_script_block_logs (EID 4104) | CALCULATE shannon_entropy(script_content) | BASELINE entropy by host/user | ALERT if entropy > 3_std_dev_from_mean AND script_content CONTAINS "Compress-Archive"
  - question: Can an NLP model distinguish between malicious staging commands and benign administrative scripts?
    context: This question applies a sophisticated NLP model to understand the semantic intent of command-line and PowerShell activity. This goes beyond simple keyword matching to identify novel or cleverly disguised staging commands based on patterns learned from known TTPs.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4104
      - Command-line and PowerShell execution logs from all endpoints and servers, with heightened monitoring on systems hosting sensitive data (e.g., file servers, developer workstations) or belonging to privileged users.
    range: last 90 days
    queries:
      - technology: ML Model (NLP)
        query: INPUT command_lines (EID 4688) and powershell_scripts (EID 4104) | PREDICT with NLP_staging_classifier_model | ALERT if classification is 'malicious_staging'
  - question: Has a single process read a high volume of files from many different directories and then created a large archive file?
    context: This question identifies the classic "smash and grab" pattern of data collection. A stateful rule correlates a burst of file read activity across diverse locations with the subsequent creation of an archive file, a strong indicator of staging.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - File system audit logs (Object Access) on high-value assets such as file servers, database servers, and endpoints of privileged users. Focus monitoring on directories containing intellectual property, PII, financial data, user profiles, and system configuration files.
    range: last 90 days
    queries:
      - technology: SIEM (Stateful Correlation)
        query: CORRELATE file_read_events (EID 4663) by ProcessID over 5min | IF unique_directory_count > 10 THEN CHECK for subsequent file_write_event (EID 4663) by same ProcessID WHERE file_extension IN (.zip, .rar, .7z) AND file_path IN (staging_locations) | ALERT
  - question: Is a process accessing files from an unusually diverse and random set of directory paths?
    context: This question uses path entropy to detect abnormal file access patterns. A legitimate process typically accesses files in predictable locations. A high path entropy suggests the process is "wandering" the file system to collect disparate data, which is characteristic of staging.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - File system audit logs (Object Access) on high-value assets such as file servers, database servers, and endpoints of privileged users. Focus monitoring on directories containing intellectual property, PII, financial data, user profiles, and system configuration files.
    range: last 90 days
    queries:
      - technology: SIEM/Analytics Platform
        query: SEARCH file_read_events (EID 4663) over 10min window | GROUP by ProcessID | CALCULATE shannon_entropy(directory_paths) | BASELINE path_entropy by process_name | ALERT if path_entropy > 99th_percentile_baseline
  - question: Does a process exhibit a time-series anomaly characterized by a spike in file reads followed by a large file write?
    context: This question uses a time-series model to learn the normal rhythm of file I/O operations for each process. An anomaly consisting of a large burst of reads followed by a single large write deviates from this normal rhythm and is a strong signal of data collection and staging.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - File system audit logs (Object Access) on high-value assets such as file servers, database servers, and endpoints of privileged users. Focus monitoring on directories containing intellectual property, PII, financial data, user profiles, and system configuration files.
    range: last 90 days
    queries:
      - technology: ML Model (Time-Series)
        query: INPUT time_series of file_read/write_counts per process | PREDICT with LSTM_autoencoder_model | ALERT on high reconstruction_error | ANALYZE anomaly shape (spike in reads, then single large write)
  - question: Has a host accessed an unusually high number of network shares and then created a large local archive file?
    context: This question identifies staging of data from network locations. It correlates network activity (reading from many shares) with local file system activity (creating a large archive) to detect when a single host is being used as a collection point for data residing elsewhere on the network.
    answer_sources:
      - Windows Event ID 4663
      - Zeek smb_files.log
      - Zeek conn.log
      - Network traffic logs (Zeek) at key network chokepoints (e.g., data center ingress/egress, core switches) and local file system logs (Windows Event Log) on endpoints and file servers that access network shares.
    range: last 90 days
    queries:
      - technology: SIEM (Cross-Source Correlation)
        query: CORRELATE zeek_smb_logs and windows_file_creation_logs (EID 4663) over 15min | IF unique_share_count > 5 for a source_IP THEN CHECK for local_archive_creation > 100MB on host matching source_IP | ALERT
  - question: Has a host anomalously exceeded its baseline for SMB read volume and number of unique shares accessed?
    context: This question uses historical baselines to detect abnormal network data collection behavior. An alert is triggered when a host's SMB traffic volume and the diversity of shares it accesses both spike significantly, indicating a deviation from normal activity that could be data staging.
    answer_sources:
      - Zeek smb_files.log
      - Zeek conn.log
      - Network traffic logs (Zeek) at key network chokepoints (e.g., data center ingress/egress, core switches) and local file system logs (Windows Event Log) on endpoints and file servers that access network shares.
    range: last 90 days
    queries:
      - technology: SIEM/Analytics Platform
        query: SEARCH zeek_logs over 1hr | BASELINE smb_read_bytes and unique_share_count by host | ALERT if smb_read_bytes > 95th_percentile_baseline AND unique_share_count > mean + 3_std_dev
  - question: Does a network graph analysis show a single host suddenly becoming a central point for data reads from multiple file shares?
    context: This question applies graph theory to network traffic to visualize and detect staging. Hosts and shares are nodes, and SMB reads are edges. A sudden increase in the 'fan-in' of connections to a single host node from many share nodes is a powerful visual and mathematical indicator of centralized data collection.
    answer_sources:
      - Windows Event ID 4663
      - Zeek smb_files.log
      - Zeek conn.log
      - Network traffic logs (Zeek) at key network chokepoints (e.g., data center ingress/egress, core switches) and local file system logs (Windows Event Log) on endpoints and file servers that access network shares.
    range: last 90 days
    queries:
      - technology: Graph Analytics Platform
        query: MODEL network_traffic as graph (nodes=hosts/shares, edges=smb_reads) | DETECT anomaly where fan-in_degree to a host_node spikes | CORRELATE timestamp with local_file_creation_events (EID 4663) on that host | ALERT