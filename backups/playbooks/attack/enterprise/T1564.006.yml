name: "T1564.006: Run Virtual Instance"
id: "b4c2b9c0-9a3b-4f8e-8a21-7d1c6e3f4b5a"
description: "Identifies adversary activity involving the deployment or execution of a virtual instance to evade host or network-based defenses. This playbook focuses on detecting unauthorized virtual machines by identifying network traffic from unregistered MAC addresses associated with virtualization vendors, spotting the execution of virtualization utilities with evasive command-line arguments, finding virtual disk files created in suspicious locations or by unusual processes, and correlating these activities to uncover stealthy adversary operations."
type: "technique"
related: "TA0005: Defense Evasion"
contributors: "Zachary Szewczyk"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Is there network traffic from a MAC address with a virtualization vendor OUI that is not registered in our asset inventory?"
    context: "This question aims to identify unauthorized virtual machines on the network. It checks if a device's hardware address (MAC) belongs to a known VM provider (like VMware or VirtualBox) but is not listed as a recognized corporate asset. A match could indicate a rogue VM set up by an adversary to hide their activities from security monitoring that relies on asset inventories."
    answer_sources: "Zeek conn.log, Zeek dhcp.log, Internet gateway/firewall, Core network switches, DHCP servers"
    range: "last 90 days"
    queries: "SEARCH network_flow_logs AND dhcp_logs JOIN asset_inventory WHERE mac_oui IN (virtualization_oui_watchlist) AND mac_address NOT IN (asset_inventory_macs)"
  - question: "Are newly observed devices with virtualization MAC addresses exhibiting anomalous network traffic patterns, such as an unusually high number of destination ports or IPs?"
    context: "This question focuses on the behavior of new, potential VMs. A legitimate new VM might have predictable traffic, but an adversary's VM might perform network scans or connect to many external C2 servers. By analyzing traffic patterns of a new device with a VM-associated MAC, we can spot anomalies like high port/IP entropy, which suggests malicious reconnaissance or communication."
    answer_sources: "Zeek conn.log, Zeek dhcp.log, Internet gateway/firewall, Core network switches, DHCP servers"
    range: "last 90 days"
    queries: "SEARCH dhcp_logs FOR new_mac_with_vm_oui | ANALYZE network_flows for that IP over 24h | CALCULATE destination_port_entropy, distinct_destination_ip_count | ALERT if value > 95th_percentile"
  - question: "Does a newly detected, un-inventoried device with a virtualization MAC address show network behavior that significantly deviates from the established baseline of known assets?"
    context: "This question applies machine learning to detect rogue VMs. We establish a baseline of 'normal' network behavior for all known devices. When a new device with a VM-like MAC appears, its traffic is compared against this model. A significant deviation (a high reconstruction error from an autoencoder) suggests its behavior is unlike anything seen before, pointing to a potentially malicious, unmanaged virtual instance."
    answer_sources: "Zeek conn.log, Zeek dhcp.log, Internet gateway/firewall, Core network switches, DHCP servers"
    range: "last 90 days"
    queries: "WHEN new_uninventoried_vm_mac_detected | INPUT network_metrics to time_series_model | ALERT if reconstruction_error > threshold"
  - question: "Has a virtualization command-line utility been executed with arguments indicating silent, headless, or non-interactive operation?"
    context: "Adversaries often run VMs in the background to avoid user detection. This question looks for the specific command-line flags (like '--type headless', '-nogui', '-silent') used to achieve this. Finding these flags in process execution logs is a strong indicator that a VM is being run for stealthy or automated purposes, rather than for legitimate interactive use by a system administrator."
    answer_sources: "Windows Event ID 4688, Sysmon Event ID 1, Standard user endpoints, Developer workstations, Server infrastructure"
    range: "last 90 days"
    queries: "SEARCH process_creation_logs WHERE process_name IN (virtualization_utilities) AND command_line CONTAINS (evasive_flags)"
  - question: "Has a virtualization utility been executed with command-line arguments that are statistically rare across the enterprise?"
    context: "This question uses statistical analysis to find suspicious activity. Most legitimate use of virtualization tools follows common patterns. By identifying command-line combinations that are rarely or never seen in the environment, we can uncover novel or unusual invocations that may be part of an adversary's unique toolchain or a custom evasion technique."
    answer_sources: "Windows Event ID 4688, Sysmon Event ID 1, Standard user endpoints, Developer workstations, Server infrastructure"
    range: "last 90 days"
    queries: "SEARCH process_creation_logs for virtualization_utility | CALCULATE rarity_score for command_line_arguments based on historical frequency | ALERT if score > threshold"
  - question: "Can we classify the execution of a virtualization utility as malicious based on its command-line arguments using a machine learning model?"
    context: "This question proposes a proactive, ML-based approach. By training a model on known benign and malicious command lines, the system can automatically flag new, unseen commands that fit the pattern of malicious activity. This moves beyond simple keyword matching to understanding the characteristics and intent of a malicious command."
    answer_sources: "Windows Event ID 4688, Sysmon Event ID 1, Standard user endpoints, Developer workstations, Server infrastructure"
    range: "last 90 days"
    queries: "INPUT virtualization_process_command_line to classification_model | ALERT if classification is 'malicious' with high_confidence"
  - question: "Has a virtual disk file (e.g., .vmdk, .vhd) been created in a non-standard or high-risk location, such as a user's temporary folder or a web directory?"
    context: "Legitimate virtual disks are typically stored in designated, well-known folders. Adversaries, however, may drop these files in temporary or world-writable locations to evade detection and for easier access. This question searches for virtual disk files created outside of approved directories, which is highly suspicious and could indicate staging for a malicious VM."
    answer_sources: "Sysmon Event ID 11, File servers, Standard user endpoints, Web servers"
    range: "last 90 days"
    queries: "SEARCH file_creation_logs WHERE filename MATCHES (virtual_disk_extensions) AND file_path NOT IN (approved_locations) AND file_path IN (high_risk_locations)"
  - question: "Was a virtual disk file created by a process not typically associated with virtualization, such as a web browser, Office application, or script interpreter?"
    context: "Virtual disk files should be created by virtualization software. If a process like PowerShell, Word, or Chrome is observed creating a .vhd or .vmdk file, it strongly suggests that an exploit or malicious script is staging a virtual environment for further operations. This question aims to detect this anomalous process behavior, which is a strong indicator of compromise."
    answer_sources: "Sysmon Event ID 11, File servers, Standard user endpoints, Web servers"
    range: "last 90 days"
    queries: "SEARCH file_creation_logs WHERE filename MATCHES (virtual_disk_extensions) | ANALYZE creating_process | ALERT if creating_process NOT IN (known_virtualization_software)"
  - question: "Are there file creation events for virtual disks that are outliers when compared to normal activity, based on features like the creating process, file path, and size?"
    context: "This question uses machine learning to find the 'odd one out.' By clustering all virtual disk creation events based on their properties (process, path, size), we can identify normal patterns (dense clusters). Events that don't fit into any cluster (noise points) are anomalies. This can detect novel or sophisticated adversary techniques that don't match pre-defined rules."
    answer_sources: "Sysmon Event ID 11, File servers, Standard user endpoints, Web servers"
    range: "last 90 days"
    queries: "CLUSTER virtual_disk_creation_events on features (process, path, size) | ALERT on events classified as noise/outliers"
  - question: "Has a virtualization management process been launched by a parent process that is not on the approved allowlist of typical administrative tools?"
    context: "Virtualization tools are normally launched by an administrator directly via the command line or explorer.exe. If a parent process like Microsoft Word (winword.exe) or Outlook (outlook.exe) spawns a VM management tool, it is a very strong indicator of a malicious payload executing, likely from a phishing email or a weaponized document."
    answer_sources: "Windows Event ID 4688, Sysmon Event ID 1, Domain Controllers, Standard user endpoints, Application servers"
    range: "last 90 days"
    queries: "SEARCH process_creation_logs WHERE child_process IN (virtualization_binaries) AND parent_process NOT IN (parent_process_allowlist)"
  - question: "Has a virtualization process been spawned by a parent process that forms a statistically rare parent-child relationship across the organization?"
    context: "This question moves from a static allowlist to dynamic, statistical analysis. It learns what normal parent-child process relationships look like across the entire environment. A virtualization tool being launched by a parent process it has rarely or never been seen with before is flagged as a statistical anomaly worthy of investigation, even if the parent itself is not inherently malicious."
    answer_sources: "Windows EventID 4688, Sysmon Event ID 1, Domain Controllers, Standard user endpoints, Application servers"
    range: "last 90 days"
    queries: "SEARCH process_creation_logs WHERE child_process IN (virtualization_binaries) | CALCULATE historical_frequency of parent_child_pair | ALERT if frequency < threshold"
  - question: "Has a sequence of process executions leading to the launch of a virtualization tool been identified as a highly anomalous path in a process-tree graph?"
    context: "This question models the entire chain of execution, not just a single parent-child link. By representing all process activity as a graph, we can use algorithms to find improbable sequences. An adversary's kill chain, like a user opening an email in Outlook which launches PowerShell to download and then run a VM, would appear as a very low-probability path in the graph, making it stand out from normal activity."
    answer_sources: "Windows Event ID 4688, Sysmon Event ID 1, Domain Controllers, Standard user endpoints, Application servers"
    range: "last 90 days"
    queries: "MODEL process history as weighted directed graph | ANALYZE new execution chains for anomalous paths | ALERT if path probability is below threshold (e.g., outlook -> powershell -> vboxmanage)"
  - question: "Has a correlated sequence of events occurred on a single host within a short time frame: evasive VM process execution, followed by virtual disk creation, and then network traffic from a new, rogue VM?"
    context: "This question seeks to tie multiple weak signals into one strong indicator of compromise. Individually, these events might be low-fidelity, but occurring together in a logical sequence on one machine (run a headless VM, create its disk, see traffic from it) provides high-confidence evidence of an adversary setting up a stealthy virtual environment."
    answer_sources: "Sysmon Event ID 1, Sysmon Event ID 11, Zeek conn.log, Internet gateway/firewall, Standard user endpoints, Server infrastructure"
    range: "last 90 days"
    queries: "CORRELATE events on a single host within 15 minutes: (1. process_creation with evasive_flags) AND (2. file_creation of virtual_disk) AND (3. network_flow from new_vm_mac)"
  - question: "Does any single host accumulate a high enough threat score based on a combination of VM-related suspicious activities over a rolling time window?"
    context: "This question uses a risk-scoring model. Instead of a rigid correlation rule, it assigns points to various suspicious activities related to virtualization. This is more flexible and can catch variations in adversary TTPs. A host that rapidly accumulates points for things like rare command lines, suspicious file creation, and anomalous network traffic is flagged for investigation."
    answer_sources: "Sysmon Event ID 1, Sysmon Event ID 11, Zeek conn.log, Internet gateway/firewall, Standard user endpoints, Server infrastructure"
    range: "last 90 days"
    queries: "FOR each host, CALCULATE rolling_threat_score based on weighted VM-related events (rare cmdline, odd file creation, new VM MAC) | ALERT if score > threshold or standard_deviation_from_baseline"
  - question: "Does the sequence of events observed on a host have a high probability of matching a pre-defined malicious attack path involving evasive virtualization, according to a Hidden Markov Model?"
    context: "This question employs a sophisticated probabilistic model (HMM) to understand the adversary's state transitions. The model is trained to recognize the sequence of states an attacker moves through (e.g., from 'Execution' to 'Artifact Drop' to 'C2'). It can then calculate the probability that a live stream of events from a host matches a known malicious sequence, providing a powerful detection capability for complex, multi-stage attacks."
    answer_sources: "Sysmon Event ID 1, Sysmon Event ID 11, Zeek conn.log, Internet gateway/firewall, Standard user endpoints, Server infrastructure"
    range: "last 90 days"
    queries: "INPUT live event stream per host into HMM | CALCULATE probability of transitioning through malicious states (e.g., Evasive Process -> Artifact Drop -> New Channel) | ALERT if probability is high"