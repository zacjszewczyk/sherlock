name: 'T1560.002: Archive via Library'
id: 'f47ac10b-58cc-4372-a567-0e02b2c3d479'
description: 'This playbook focuses on detecting adversaries staging data for exfiltration by compressing or encrypting it using a third-party library. It identifies malicious activity by monitoring for the use of known malicious archiving tools, suspicious command-line execution of scripting libraries for compression, non-interactive or system processes creating archive files, processes rapidly reading numerous files before creating an archive, and the creation of an archive followed by suspicious outbound network connections.'
type: 'technique'
related:
  - 'TA0009: Collection'
contributors:
  - 'Zachary Szewczyk'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: 'none'
questions:
  - question: 'Has a known malicious archiving tool been executed on the endpoint?'
    context: 'This question aims to identify the use of an archiving tool whose file hash is already known to be malicious. A match on a threat intelligence list provides a high-confidence signal of adversary activity, as it indicates a tool specifically associated with threat actors has been deployed.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Threat Intelligence Feed of File Hashes'
      - 'Relevant Assets: Domain Controllers, File Servers, Critical Application Servers, Developer Workstations, Executive Laptops'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'SEARCH process_creation_events (e.g., WinEvent:4688) | JOIN file_hash against threat_intel_feed | WHERE match_found'
  - question: 'Has a rare or uncommon archiving tool been executed?'
    context: 'Adversaries may use legitimate but uncommon archiving tools to avoid detection by hash-based lookups. This question identifies such tools by searching for low-prevalence processes with names related to archiving (e.g., zip, rar), which could indicate a tool brought into the environment by an attacker rather than a standard-issue application.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Relevant Assets: Domain Controllers, File Servers, Critical Application Servers, Developer Workstations, Executive Laptops'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'SEARCH process_creation_events | CALCULATE prevalence of each process_hash | FILTER process_name CONTAINS (''zip'', ''rar'', ''archive'', ''compress'', ''7z'') AND prevalence < 0.5%'
  - question: 'Does the execution of an archiving tool exhibit characteristics of known malicious behavior?'
    context: 'This question uses a machine learning model to move beyond simple indicators. By analyzing multiple features of a process execution event (e.g., process name length, parent process, command-line argument count, hash prevalence), the model can predict the likelihood of malicious intent even for previously unseen tools, based on patterns learned from historical data.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Relevant Assets: Domain Controllers, File Servers, Critical Application Servers, Developer Workstations, Executive Laptops'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'INPUT process_creation_events into ML_model | EXTRACT features (process_name_length, parent_process, arg_count, hash_prevalence) | PREDICT if malicious'
  - question: 'Is a scripting interpreter being used to programmatically create archives, especially of sensitive directories?'
    context: 'Adversaries often use built-in scripting languages like Python or PowerShell to perform archiving. This is a "living-off-the-land" technique that avoids introducing new executables. This question looks for command-line evidence of these scripting engines calling compression libraries, especially when targeting sensitive directories.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Relevant Assets: User Workstations, Web Servers, Application Servers, CI/CD Build Servers, Code Repositories'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'SEARCH process_creation_events | FILTER process_name IN (''python.exe'', ''pwsh.exe'') AND command_line CONTAINS (''zipfile'', ''Compress-Archive'') AND command_line targets sensitive_directories'
  - question: 'Are there signs of obfuscation or unusual frequency in command-line archiving activity for a specific user?'
    context: 'To hide their actions, attackers may obfuscate commands, leading to high entropy (randomness) in the command-line string. Additionally, a user suddenly running many more archiving commands than their personal baseline is suspicious. This question seeks to find these statistical anomalies in command-line activity.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Relevant Assets: User Workstations, Web Servers, Application Servers, CI/CD Build Servers, Code Repositories'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'SEARCH command_lines with archive_keywords | CALCULATE Shannon_entropy and command_frequency_per_user | ALERT on entropy > 95th_percentile OR frequency > 3_std_dev_from_baseline'
  - question: 'Are there any novel or outlier command-line patterns related to archiving that deviate from established normal behavior?'
    context: 'This question uses unsupervised machine learning to find "unknown unknowns." By clustering all command-line arguments used for archiving, the system can identify normal patterns of use. Any commands that do not fit into these normal clusters are flagged as outliers, potentially representing a new or unique adversary technique.'
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Relevant Assets: User Workstations, Web Servers, Application Servers, CI/CD Build Servers, Code Repositories'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'INPUT tokenized_command_lines into clustering_algorithm (DBSCAN) | IDENTIFY outlier clusters | INVESTIGATE commands in outlier clusters'
  - question: 'Is a non-interactive or system-critical process creating an archive file?'
    context: 'System services and web server processes (like svchost.exe or w3wp.exe) typically do not create archive files (.zip, .rar) as part of their normal operation. This question looks for this highly anomalous behavior, which could indicate a compromised service is being abused to stage data for exfiltration.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Relevant Assets: Web Application Servers (DMZ), Database Servers, Internal File Shares, System Temporary Directories (e.g., C:\Windows\Temp)'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'SEARCH file_creation_events for archives (.zip, .rar) | JOIN with process_creation_events | ALERT if creating_process is on (''w3wp.exe'', ''sqlservr.exe'', ''svchost.exe'')'
  - question: 'Has a process created an archive file type that it has never or rarely created before?'
    context: 'This question establishes a behavioral baseline for every process, tracking the types of files it normally creates. An alert is triggered when a process, for example, suddenly creates a .7z file, as this is a statistically improbable event and a strong deviation from its normal, profiled behavior.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Relevant Assets: Web Application Servers (DMZ), Database Servers, Internal File Shares, System Temporary Directories (e.g., C:\Windows\Temp)'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'PROFILE file extensions created per process_name | CALCULATE P(archive_extension | process_name) | ALERT if probability is zero or < 0.01'
  - question: 'Does a file creation event for an archive represent a significant anomaly when considering the process, parent process, and file path context?'
    context: 'This question uses an anomaly detection model to evaluate the entire context of a file creation event. Instead of just looking at the process and extension, it also considers the parent process and the location where the file was created. This allows it to spot sophisticated attacks, such as a legitimate process being hijacked to write an archive to an unusual directory.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Relevant Assets: Web Application Servers (DMZ), Database Servers, Internal File Shares, System Temporary Directories (e.g., C:\Windows\Temp)'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'TRAIN anomaly_detection_model on normal file_creation_events (process, parent, path, extension) | INPUT new events into model | ALERT on events flagged as outliers'
  - question: 'Did a process rapidly read a large number of files just before creating an archive?'
    context: 'A common pattern for data staging is for a single process to quickly access many different files and then consolidate them into one archive. This question looks for this specific sequence of events: a burst of file read activity followed immediately by the creation of an archive file by the same process.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Relevant Assets: User Profile Directories (Documents, Desktop), Network-mapped Drives, SharePoint Sites, Source Code Repositories'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'MONITOR file_read_events per ProcessID in a 60s window | IF read_count > 200 AND followed by file_write for archive (.zip, .rar) by same ProcessID, THEN ALERT'
  - question: 'Did a process access an unusually diverse set of directories before creating an archive file?'
    context: 'Adversaries often gather data from many different locations. This question detects this by monitoring the number of unique directories a process touches. A sudden spike in this "directory traversal," especially one that deviates from that process''s normal behavior and is followed by archive creation, is a strong indicator of data collection.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Relevant Assets: User Profile Directories (Documents, Desktop), Network-mapped Drives, SharePoint Sites, Source Code Repositories'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'CALCULATE unique_directories_accessed per process in 5min window | IF unique_dir_count > 95th_percentile_baseline AND followed by archive_creation, THEN ALERT'
  - question: 'Was there an anomalous, unpredicted spike in overall file read activity on a host that correlates with the creation of an archive file?'
    context: 'This question models the normal "heartbeat" of file system activity for each host, accounting for regular patterns. It then looks for sudden, large spikes in file reads that the model did not predict, which could signify a data gathering operation, especially if an archive file is created at the same time.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Relevant Assets: User Profile Directories (Documents, Desktop), Network-mapped Drives, SharePoint Sites, Source Code Repositories'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'MODEL time-series of file_read_ops per host | DETECT unpredicted spikes | IF spike correlates with archive_creation, THEN ALERT'
  - question: 'Was an archive file created shortly before data was sent from the same host to a known-bad external IP address?'
    context: 'This is a classic "stage and exfiltrate" pattern. This question links two key events: the creation of a compressed archive (staging) and a subsequent network connection to a destination flagged by threat intelligence (exfiltration). The close timing between these events provides strong evidence of a data theft attempt.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Zeek conn.log'
      - 'Relevant Assets: Network Egress Points (Firewalls, Proxies), DNS Servers, Endpoint Devices, Critical Servers'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'WHEN archive_creation_event on Host A, LOOK for outbound_connection from Host A to threat_intel_IP within 5 mins'
  - question: 'After creating an archive file, did the host make an unusual outbound network connection (e.g., to a rare destination or with an abnormally large data transfer)?'
    context: 'Even if a destination IP is not on a threat list, the connection might still be suspicious. This question establishes a baseline of normal network behavior for each host. It then flags connections that occur after archive creation if they go to an uncharacteristic destination or involve an unusually large amount of data.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Zeek conn.log'
      - 'Relevant Assets: Network Egress Points (Firewalls, Proxies), DNS Servers, Endpoint Devices, Critical Servers'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'WHEN archive_creation_event, MONITOR outbound connections | ALERT if destination_ASN is rare (<1% historical) OR bytes_sent > 98th_percentile for that host'
  - question: 'Can graph analysis reveal a high-risk data exfiltration path originating from a host where an archive was recently created?'
    context: 'This question models the environment as a network graph to uncover complex relationships. When an archive is created on a host (node), its risk score is temporarily raised. The system then uses graph algorithms to see if this "at-risk" host connects to other suspicious nodes, such as IPs belonging to a known bad neighborhood, thereby identifying a likely exfiltration path.'
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Zeek conn.log'
      - 'Relevant Assets: Network Egress Points (Firewalls, Proxies), DNS Servers, Endpoint Devices, Critical Servers'
    range: 'last 90 days'
    queries:
      - technology: 'Pseudocode'
        query: 'WHEN archive_creation_event on host_node, increase risk_score | USE graph_pathfinding to find connection to low-reputation_community_node | ALERT on high-risk_path'