name: T1562.007: Disable or Modify Cloud Firewall
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook focuses on detecting attempts by an adversary to evade defenses by modifying cloud firewall rules. This includes activities such as adding rules to allow traffic from malicious IP addresses, using tool-specific signatures in rule metadata, creating overly permissive rules that expose sensitive ports to the internet, performing modifications with anomalous or unauthorized user identities, and correlating firewall changes with subsequent malicious host-based activity like failed logins or data transfer spikes.
type: technique
related:
  - TA0005: Defense Evasion
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags:
  - none
questions:
  - question: Has a cloud firewall rule been modified to allow traffic from an IP address listed on a high-confidence threat intelligence feed?
    context: This question aims to detect a common attack pattern where an adversary, having gained some level of access, modifies firewall rules to allow inbound connections from their own infrastructure for command and control, data exfiltration, or further lateral movement. Matching the source IP against a threat intelligence feed provides a high-fidelity signal that the change is malicious.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)
      - Threat Intelligence Platform Logs
      - Zeek conn.log
      - Cloud IAM and Network Management APIs
      - Organizational Threat Intelligence Platform
      - Network Gateway/Egress Points
    range: last 90 days
    queries:
      - pseudocode: SEARCH cloud_firewall_modification_events | EXTRACT source_ip | JOIN threat_intelligence_feed ON source_ip | ALERT if match_found
  - question: Following a firewall rule change from a known malicious IP, is there an anomalous amount of data being transferred, potentially indicating data staging or exfiltration?
    context: This question provides a secondary confirmation of malicious activity. After a malicious IP is allowed through the firewall, a significant spike in outbound data transfer compared to the historical baseline for that host can strongly indicate that the adversary is exfiltrating data or staging large tools.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)
      - Threat Intelligence Platform Logs
      - Zeek conn.log
      - Cloud IAM and Network Management APIs
      - Organizational Threat Intelligence Platform
      - Network Gateway/Egress Points
    range: last 90 days
    queries:
      - pseudocode: ON alert_for_malicious_ip_rule_change | SEARCH network_traffic_logs FOR source_ip FROM alert IN last 60m | CALCULATE data_out_percentile_for_host (last 30d) | ALERT IF data_out > 95th_percentile
  - question: Can a machine learning model predict whether a firewall change is malicious based on contextual features like user role, time of day, and IP reputation?
    context: This question seeks to proactively identify malicious firewall modifications by using a classification model. Unlike simple rule-based detection, a machine learning model can learn complex patterns from multiple features simultaneously, allowing it to detect novel or more subtle attempts to bypass defenses that might not trigger a specific symbolic rule.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)
      - Threat Intelligence Platform Logs
      - Zeek conn.log
      - Cloud IAM and Network Management APIs
      - Organizational Threat Intelligence Platform
      - Network Gateway/Egress Points
    range: last 90 days
    queries:
      - pseudocode: INPUT firewall_change_event | EXTRACT features (is_from_threat_feed, user_role, time_of_day, etc.) | PREDICT with logistic_regression_model | ALERT IF probability > 0.85
  - question: Does a cloud firewall rule modification event contain user-agent strings, rule names, or descriptions associated with known offensive security tools or malicious terms?
    context: This question looks for explicit indicators of compromise within the metadata of a firewall change. Attackers often use automated tools (like 'pacu' or 'Prowler') which leave identifiable signatures in user-agent strings, or they may use common malicious terms (like 'pwn' or 'backdoor') in rule names/descriptions. Detecting these provides a direct link to malicious intent.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `userAgent` field, Azure Activity Logs `httpRequest` field, GCP Audit Logs `requestMetadata.callerSuppliedUserAgent`)
      - Cloud IAM and Network Management APIs
      - Cloud Service Provider API Endpoints
    range: last 90 days
    queries:
      - pseudocode: SEARCH cloud_firewall_modification_events | SCAN user_agent, rule_name, description FIELDS FOR regex_list_of_malicious_terms | ALERT on match
  - question: Do newly created firewall rules have names or descriptions with unusually high or low string entropy, suggesting automated tool generation or simplistic, repeated names?
    context: This question uses statistical analysis of string complexity to find suspicious rule names. Automated tools may generate randomized names with high entropy, while a lazy attacker might use simple, repeated names like 'test' with very low entropy. Both can be anomalous compared to the established baseline of descriptive, human-created rule names, flagging them for review.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `userAgent` field, Azure Activity Logs `httpRequest` field, GCP Audit Logs `requestMetadata.callerSuppliedUserAgent`)
      - Cloud IAM and Network Management APIs
      - Cloud Service Provider API Endpoints
    range: last 90 days
    queries:
      - pseudocode: ON new_firewall_rule | CALCULATE shannon_entropy(rule_name, description) | CALCULATE baseline_mean_and_stddev_for_all_rules | ALERT IF entropy > (mean + 3*stddev) OR entropy < (mean - 3*stddev)
  - question: Can a natural language processing (NLP) model classify the intent of a firewall rule as malicious based on its name and description?
    context: This question applies NLP to understand the semantics of rule names and descriptions, moving beyond simple keyword matching. By training a model on labeled examples of benign and malicious rule text, it can learn to classify new, unseen rules in real-time, catching variations in naming conventions that a static regex list might miss.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `userAgent` field, Azure Activity Logs `httpRequest` field, GCP Audit Logs `requestMetadata.callerSuppliedUserAgent`)
      - Cloud IAM and Network Management APIs
      - Cloud Service Provider API Endpoints
    range: last 90 days
    queries:
      - pseudocode: ON new_firewall_rule | INPUT rule_name, description | PREDICT with text_classification_nlp_model | ALERT IF classification is 'malicious' AND confidence > 0.90
  - question: Has a firewall rule been created that violates a strict policy by allowing ingress from all IP addresses ('0.0.0.0/0') to a high-risk management port?
    context: This question enforces a critical security best practice. Exposing sensitive management ports like SSH (22) or RDP (3389) to the entire internet ('0.0.0.0/0') is a high-risk action that dramatically increases the attack surface. This query provides an immediate, high-severity alert for such a policy violation, as it is a common misconfiguration exploited by attackers.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `ipPermissions.ipRanges`, Azure Activity Logs `properties.sourceAddressPrefix`)
      - Zeek conn.log
      - Cloud Security Group and Firewall Rule Configurations
      - Virtual Private Cloud (VPC) Firewall Rules
      - Network Gateway/Egress Points
    range: last 90 days
    queries:
      - pseudocode: SEARCH cloud_firewall_modification_events | WHERE source_cidr IN ('0.0.0.0/0', '::/0') AND destination_port IN (22, 135, 445, 1433, 3306, 3389, 5985, 5986) | ALERT on match
  - question: Has a firewall modification exposed a port to the internet that has rarely or never been exposed before?
    context: This question identifies anomalous rule changes by focusing on the rarity of the action. While exposing a web port (443) to the internet is common, exposing a database port (3306) might be extremely rare or unprecedented in an environment. By alerting on the exposure of historically 'internal-only' ports, this method can catch risky changes that might not violate a static policy.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `ipPermissions.ipRanges`, Azure Activity Logs `properties.sourceAddressPrefix`)
      - Zeek conn.log
      - Cloud Security Group and Firewall Rule Configurations
      - Virtual Private Cloud (VPC) Firewall Rules
      - Network Gateway/Egress Points
    range: last 90 days
    queries:
      - pseudocode: ON firewall_rule_change_to_internet | CALCULATE historical_exposure_frequency_for(port) | ALERT IF frequency_percentile < 5
  - question: Can an anomaly detection model identify a new firewall rule as a significant outlier compared to the established baseline of all existing, approved rules?
    context: This question uses an unsupervised learning approach to find 'abnormal' rules without pre-defined labels. An Isolation Forest model, for example, can learn the characteristics of a normal firewall configuration (combinations of ports, protocols, and sources). It can then flag any new rule that doesn't fit this learned pattern as an anomaly, requiring human review.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `ipPermissions.ipRanges`, Azure Activity Logs `properties.sourceAddressPrefix`)
      - Zeek conn.log
      - Cloud Security Group and Firewall Rule Configurations
      - Virtual Private Cloud (VPC) Firewall Rules
      - Network Gateway/Egress Points
    range: last 90 days
    queries:
      - pseudocode: ON new_firewall_rule | EXTRACT features (Port, Protocol, Source_is_Any) | PREDICT with isolation_forest_model | ALERT IF anomaly_score is below_threshold
  - question: Was a firewall modification performed by a user or service principal not on the explicit allow-list of authorized accounts?
    context: This question enforces the principle of least privilege. Firewall changes should only be made by a small, well-defined group of administrators. Any modification made by an identity outside this group is an immediate security concern, potentially indicating a compromised account or an insider threat. This is a simple but highly effective control.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `userIdentity`, `sourceIPAddress`, `eventTime`)
      - Windows Event ID 4624
      - Zeek conn.log
      - Cloud IAM and Network Management APIs
      - VPN/Zero Trust Network Access (ZTNA) Concentrators
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: SEARCH cloud_firewall_modification_events | EXTRACT user_identity | IF user_identity NOT IN authorized_users_allow_list THEN ALERT
  - question: Did a firewall modification by an authorized user exhibit anomalous characteristics, such as being performed from a new location, at an unusual time, or after a long period of inactivity?
    context: This question aims to detect account compromise even when the user is technically authorized. By building a baseline of normal behavior for each administrator (time, location, frequency), a statistical model can assign a risk score to each new action. A change from a new country at 3 AM by a user who normally works 9-5 and hasn't made a change in 6 months would generate a high risk score, triggering an alert.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `userIdentity`, `sourceIPAddress`, `eventTime`)
      - Windows Event ID 4624
      - Zeek conn.log
      - Cloud IAM and Network Management APIs
      - VPN/Zero Trust Network Access (ZTNA) Concentrators
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: ON firewall_change_event | CALCULATE risk_score based on deviations from user_baseline (source_asn, time_of_day, frequency) | ALERT IF cumulative_risk_score > 98th_percentile
  - question: Does a user and entity behavior analytics (UEBA) model flag a firewall modification event as a high-confidence anomaly based on a user's overall pattern of life?
    context: This question leverages a sophisticated UEBA system to provide a holistic view of user behavior. Instead of looking at single variables in isolation, a UEBA model considers multiple factors simultaneously (user identity, geolocation, endpoint, type of action, etc.) to detect significant deviations from an established pattern. This can detect complex attacks where an adversary tries to blend in by mimicking some, but not all, aspects of a legitimate user's behavior.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail `userIdentity`, `sourceIPAddress`, `eventTime`)
      - Windows Event ID 4624
      - Zeek conn.log
      - Cloud IAM and Network Management APIs
      - VPN/Zero Trust Network Access (ZTNA) Concentrators
      - Active Directory Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: INPUT firewall_change_event_with_context | PREDICT with UEBA_model | ALERT IF anomaly_confidence is high
  - question: Following a firewall rule change, was a network connection from the newly allowed IP immediately followed by a failed login attempt on the destination host?
    context: This question correlates multiple events across different data sources to build a high-confidence attack narrative. The sequence of 'firewall rule opened -> connection from new IP -> failed login from that same IP' is a classic indicator of an attacker opening access and then immediately attempting to brute force or use stolen credentials. This correlation turns low-severity individual events into a single high-severity alert.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)
      - Zeek conn.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Cloud Network Gateways
      - Targeted Virtual Machines or Container Hosts
      - Authentication Log Aggregators
    range: last 90 days
    queries:
      - pseudocode: ON firewall_rule_change | WITHIN 15m, LOOK FOR network_connection matching rule | IF found, WITHIN 5m, LOOK FOR failed_login (EventID 4625) from same source_ip | ALERT on full sequence match
  - question: In the hour following a firewall rule change that opens a new port, did the rate of failed logins on the destination host significantly exceed its historical baseline?
    context: This question looks for evidence of a brute-force attack that follows a firewall modification. A sudden, statistically significant spike in failed authentications (e.g., exceeding the 99th percentile of the normal hourly rate) on the host that was just exposed is a strong indicator that the new rule is being abused.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)
      - Zeek conn.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Cloud Network Gateways
      - Targeted Virtual Machines or Container Hosts
      - Authentication Log Aggregators
    range: last 90 days
    queries:
      - pseudocode: ON firewall_rule_change | MONITOR failed_logins (EventID 4625) on destination_host for 1 hour | CALCULATE historical_hourly_baseline | ALERT IF failed_login_rate > 99th_percentile_of_baseline
  - question: Using time series forecasting, did the observed network traffic and login attempts on a host significantly deviate from the predicted values after a firewall rule change?
    context: This question uses time series analysis to detect anomalies in host activity post-firewall change. A model like ARIMA can forecast the expected 'normal' volume of traffic and logins for a given host. If the actual observed activity after a rule change dramatically and persistently exceeds the model's prediction (i.e., goes outside the 99% confidence interval), it signals a statistically significant anomaly worthy of investigation.
    answer_sources:
      - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)
      - Zeek conn.log
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Cloud Network Gateways
      - Targeted Virtual Machines or Container Hosts
      - Authentication Log Aggregators
    range: last 90 days
    queries:
      - pseudocode: ON firewall_rule_change | FORECAST expected_traffic_and_logins for destination_host using ARIMA model | COMPARE actual_observed_values to forecast | ALERT IF observed persistently exceeds 99% confidence_interval