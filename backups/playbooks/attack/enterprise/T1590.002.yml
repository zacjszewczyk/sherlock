name: T1590.002: DNS
id: 9a8b7c6d-5e4f-4a3b-2c1d-0e9f8a7b6c5d
description: "This playbook helps investigate if an adversary is performing DNS reconnaissance against an organization's network infrastructure. This involves detecting DNS queries originating from known malicious IPs, identifying illicit zone transfer attempts (AXFR/IXFR), spotting high volumes of NXDOMAIN responses or the use of 'ANY' queries indicative of enumeration, detecting systematic subdomain scanning through high query volumes or entropy, and flagging unusual interest in sensitive record types like MX, TXT, and SRV."
type: technique
related:
  - TA0043: Reconnaissance
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a known malicious IP from a threat intelligence feed queried our organizational domain?
    context: This involves joining DNS logs with CTI feeds to detect queries from IPs flagged for 'reconnaissance' or 'malicious' activity that are targeting internal domains. A match is a high-fidelity indicator of targeted reconnaissance.
    answer_sources:
      - Zeek dns.log
      - Threat Intelligence Platform Data
      - External-facing DNS servers
      - Network perimeter firewalls
      - Cloud provider DNS logs
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - "SEARCH DNS logs WHERE source_ip IN (threat_intel_feed_recon_or_malicious) AND query_domain IN (organizational_domains) | JOIN with threat_intel_feed ON source_ip"
  - question: Is a known malicious IP disproportionately querying our organizational domain compared to other external IPs?
    context: This question aims to identify CTI-matched IPs that show an unusual focus on the organization's domains. By comparing the percentage of queries for the organizational domain from a malicious IP against the baseline behavior of all external IPs, we can detect targeted reconnaissance that might otherwise be lost in noise. An alert is triggered if the IP's focus is statistically significant (e.g., above the 95th percentile) and query volume is non-trivial.
    answer_sources:
      - Zeek dns.log
      - Threat Intelligence Platform Data
      - External-facing DNS servers
      - Network perimeter firewalls
      - Cloud provider DNS logs
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - "SEARCH DNS logs | GROUP BY source_ip over 1h | CALCULATE percentage_of_org_domain_queries | FILTER source_ip IN (threat_intel_feed) | COMPARE percentage to 95th_percentile_of_all_external_ips | ALERT if percentage > threshold AND query_count > 20"
  - question: Can a machine learning model classify DNS queries from external sources as potential reconnaissance activity?
    context: This approach uses a supervised classification model to proactively identify DNS reconnaissance. The model is trained on historical data with known good and bad queries, using features like query length, entropy, source IP reputation, and ASN. This allows for the detection of novel or subtle reconnaissance patterns that may not be caught by simple rules or statistical thresholds. A high probability score from the model indicates a strong likelihood of malicious intent.
    answer_sources:
      - Zeek dns.log
      - Threat Intelligence Platform Data
      - External-facing DNS servers
      - Network perimeter firewalls
      - Cloud provider DNS logs
      - Threat Intelligence Platform
    range: last 90 days
    queries:
      - "INPUT DNS query features (length, entropy, type, IP_rep, ASN, geo) into trained Random Forest model | ALERT if model_output_probability > 0.9"
  - question: Has an unauthorized IP address attempted a DNS zone transfer (AXFR/IXFR)?
    context: DNS zone transfers (AXFR/IXFR) are used to replicate DNS databases between servers. An attempt from an IP not on the authorized allow-list of secondary DNS servers is a clear indicator of an adversary trying to map out the entire network infrastructure by exfiltrating all DNS records for a domain. This is a high-severity event.
    answer_sources:
      - Zeek dns.log
      - Windows Event ID 5504
      - Authoritative DNS servers
      - Secondary DNS servers
      - Domain Controllers with DNS role
    range: last 90 days
    queries:
      - "SEARCH DNS logs OR Windows Event logs WHERE (query_type IS 'AXFR' OR 'IXFR') OR (event_id IS 5504) AND source_ip NOT IN (zone_transfer_allow_list)"
  - question: Is there an anomalous rate of 'REFUSED' DNS responses from our authoritative servers to a single external IP?
    context: A spike in 'REFUSED' DNS responses from an authoritative server to a specific external IP can indicate a series of failed reconnaissance attempts, such as blocked zone transfers or other probing activities. By establishing a baseline for the normal rate of refused queries and alerting on significant deviations (e.g., 3 standard deviations above the mean), we can detect persistent but unsuccessful probing.
    answer_sources:
      - Zeek dns.log
      - Windows Event ID 5504
      - Authoritative DNS servers
      - Secondary DNS servers
      - Domain Controllers with DNS role
    range: last 90 days
    queries:
      - "SEARCH DNS logs WHERE response_code IS 'REFUSED' | CALCULATE hourly_rate per source_ip | COMPARE rate to baseline_mean + 3 * baseline_std_dev | ALERT if rate > threshold"
  - question: Can an unsupervised anomaly detection model identify DNS sessions indicative of illicit zone transfer attempts?
    context: This question uses an unsupervised model like Isolation Forest to find anomalous DNS sessions from external IPs without prior labeling. The model analyzes features like the mix of query types, query volume, and the ratio of refused responses within a session. A session flagged as an anomaly that also contains any AXFR or IXFR queries is a very strong signal of a targeted zone transfer attempt.
    answer_sources:
      - Zeek dns.log
      - Windows Event ID 5504
      - Authoritative DNS servers
      - Secondary DNS servers
      - Domain Controllers with DNS role
    range: last 90 days
    queries:
      - "INPUT DNS session features (query_type_dist, volume, refused_ratio) into trained Isolation Forest model | ALERT if session is anomalous AND contains AXFR/IXFR queries"
  - question: Has an external IP used the deprecated 'ANY' query type against our domain?
    context: The 'ANY' query type (qtype 255) requests all available DNS records for a given name. While it has legitimate uses, it is often used in the initial stages of reconnaissance to gather as much information as possible about a target. An alert on its use from an external source for an organizational domain can be an early warning of an adversary's interest.
    answer_sources:
      - Zeek dns.log
      - External-facing DNS servers
      - Internal DNS resolvers
      - Cloud DNS service logs (e.g., AWS Route 53, Azure DNS)
    range: last 90 days
    queries:
      - "SEARCH DNS logs WHERE query_type IS 'ANY' AND source_ip IS external AND query_domain IN (organizational_domains)"
  - question: Is an external IP generating an unusually high ratio of NXDOMAIN (Non-Existent Domain) responses?
    context: A high ratio of NXDOMAIN responses from a single source IP often indicates a DNS enumeration or brute-force attack, where an adversary is guessing subdomain names. By calculating the ratio of NXDOMAIN responses to total queries for each IP and comparing it to a high percentile (e.g., 98th) of all external IPs, we can identify sources engaged in this type of reconnaissance, especially when the total query volume is significant.
    answer_sources:
      - Zeek dns.log
      - External-facing DNS servers
      - Internal DNS resolvers
      - Cloud DNS service logs (e.g., AWS Route 53, Azure DNS)
    range: last 90 days
    queries:
      - "SEARCH DNS logs over 5m window | GROUP BY source_ip | CALCULATE nxdomain_ratio = (count where response_code IS 'NXDOMAIN') / total_count | ALERT if total_count > 50 AND nxdomain_ratio > 98th_percentile_of_all_external_ips"
  - question: Can a clustering algorithm identify external IPs exhibiting anomalous DNS query behavior, such as high NXDOMAIN rates?
    context: This approach uses unsupervised clustering (like DBSCAN) to group external IPs based on their DNS query behavior over a time window. Features include NXDOMAIN rate, query count, and the mix of query types. IPs that do not fit into large, common clusters (i.e., they are flagged as noise or form small, sparse clusters) represent behavioral outliers that warrant investigation for reconnaissance activity.
    answer_sources:
      - Zeek dns.log
      - External-facing DNS servers
      - Internal DNS resolvers
      - Cloud DNS service logs (e.g., AWS Route 53, Azure DNS)
    range: last 90 days
    queries:
      - "AGGREGATE DNS query features (NXDOMAIN_rate, query_count, query_type_dist) per source_ip over 15m | APPLY DBSCAN clustering | INVESTIGATE IPs flagged as noise or in small clusters"
  - question: Has any single external IP generated a very high volume of DNS queries for our subdomains in a short time?
    context: A simple but effective way to detect brute-force subdomain enumeration is to set a high-volume threshold. An alert triggered when a single external IP exceeds a large number of queries (e.g., 500) for an organization's subdomains within a short window (e.g., 5 minutes) is a strong indicator of an automated scanning tool at work.
    answer_sources:
      - Zeek dns.log
      - External-facing DNS servers
      - Network perimeter firewalls
      - Cloud DNS provider logs
    range: last 90 days
    queries:
      - "SEARCH DNS logs over 5m window | COUNT queries per source_ip for organizational_domain | ALERT if count > 500"
  - question: Is an external IP querying for subdomains with unusually high entropy?
    context: Adversaries often use tools that generate random or pseudo-random strings to discover valid subdomains. This results in subdomain labels with high Shannon entropy compared to human-readable, legitimate subdomains. By calculating the entropy of queried subdomains for each source IP and alerting when it exceeds a baseline (e.g., 99th percentile), we can detect this specific enumeration technique.
    answer_sources:
      - Zeek dns.log
      - External-facing DNS servers
      - Network perimeter firewalls
      - Cloud DNS provider logs
    range: last 90 days
    queries:
      - "SEARCH DNS logs over 10m window | For each source_ip, collect unique subdomains | CALCULATE Shannon entropy of subdomain labels | ALERT if entropy > 99th_percentile_of_baseline"
  - question: Can a time-series anomaly detection model detect sudden bursts in DNS query volume from an external IP?
    context: This method uses a model like an LSTM autoencoder to learn the normal rhythm and volume of DNS queries from various sources over time. When a brute-force enumeration attack begins, it typically manifests as a sudden, sharp spike in query volume from a single IP. The model, trained on normal patterns, will fail to accurately 'reconstruct' this anomalous spike, resulting in a high reconstruction error that triggers an alert.
    answer_sources:
      - Zeek dns.log
      - External-facing DNS servers
      - Network perimeter firewalls
      - Cloud DNS provider logs
    range: last 90 days
    queries:
      - "INPUT time-series of per-minute query volume per source_ip into trained LSTM autoencoder model | CALCULATE reconstruction_error | ALERT if reconstruction_error is significantly higher than baseline"
  - question: Has an external IP, not on a partner allow-list, queried for an excessive number of sensitive record types like SRV or TXT?
    context: Certain DNS record types, such as SRV (service records), MX (mail exchange), and TXT (verification records), can reveal critical infrastructure details. While legitimate partners may query these, an unknown external IP making numerous queries for them is suspicious. This rule alerts when an un-allowlisted IP exceeds a set threshold for these sensitive queries within an hour.
    answer_sources:
      - Zeek dns.log
      - Authoritative DNS servers
      - Mail gateway DNS records
      - Cloud service provider DNS records
      - VoIP infrastructure DNS records
    range: last 90 days
    queries:
      - "SEARCH DNS logs WHERE source_ip NOT IN (partner_allow_list) AND query_type IN ('SRV', 'TXT') | COUNT distinct queries per source_ip over 1h | ALERT if SRV_count > 5 OR TXT_count > 10"
  - question: Is an external IP querying for sensitive record types (MX, TXT, SRV) at a rate that is statistically anomalous?
    context: This question aims to find attackers by looking at their rate of querying for sensitive information. By establishing a historical distribution for the number of sensitive queries (MX, TXT, SPF, SRV) made by external IPs over an hour, we can alert when a new IP's query count exceeds a high percentile (e.g., 95th) of that distribution. This flags IPs showing an unusual interest in infrastructure-related records.
    answer_sources:
      - Zeek dns.log
      - Authoritative DNS servers
      - Mail gateway DNS records
      - Cloud service provider DNS records
      - VoIP infrastructure DNS records
    range: last 90 days
    queries:
      - "SEARCH DNS logs over 1h window | COUNT queries per source_ip where query_type IN ('MX', 'TXT', 'SPF', 'SRV') | ALERT if count > 95th_percentile_of_historical_dist AND count > 10"
  - question: Can a Hidden Markov Model (HMM) classify a sequence of DNS queries from an IP as a 'Reconnaissance' session?
    context: This advanced technique models a DNS session as a sequence of states (e.g., 'Normal Browsing', 'Reconnaissance'). A Hidden Markov Model is trained on labeled sequences of query types to learn the transition probabilities between states. When applied to live traffic, the model can infer the most likely sequence of hidden states. If the sequence for a session is decoded to include the 'Reconnaissance' state, it provides a high-confidence alert that the user's intent is malicious.
    answer_sources:
      - Zeek dns.log
      - Authoritative DNS servers
      - Mail gateway DNS records
      - Cloud service provider DNS records
      - VoIP infrastructure DNS records
    range: last 90 days
    queries:
      - "INPUT sequence of DNS query types from a source_ip session into trained HMM | DECODE most likely state sequence | ALERT if 'Reconnaissance' state is present in sequence"