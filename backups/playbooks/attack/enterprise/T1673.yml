name: T1673: Virtual Machine Discovery
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: |
  This playbook helps determine if an adversary is attempting to discover virtual machines within the enterprise environment. Adversaries may try to enumerate virtual machines to understand the environment's layout, identify high-value targets, or prepare for lateral movement. This involves detecting suspicious network connections to hypervisor management interfaces from watchlisted or anomalous IPs, identifying the execution of known VM discovery utilities and commands (e.g., `esxcli`, `Get-VM`, `virsh`), monitoring for network sweeps within hypervisor segments, tracking the use of legitimate management tools by unauthorized users or from unapproved hosts, and correlating sequences of failed logins, successful logins, and subsequent discovery commands that indicate a successful brute-force attack.
type: technique
related:
  - TA0007: Discovery
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a known malicious IP address connected to a hypervisor management interface?
    context: |
      This question seeks to identify direct communication from IP addresses on threat intelligence watchlists to critical virtualization infrastructure ports (e.g., 443, 902, 5988, 5989). A match is a strong indicator of targeted reconnaissance or an attempted exploit against hypervisor management services.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - Core network switches
      - Virtual infrastructure management servers (e.g., vCenter, SCVMM)
      - Internet gateways
    range: last 90 days
    queries:
      - pseudocode: |
          JOIN threat_intel_watchlist ON ip = conn.log.id.orig_h 
          WHERE conn.log.id.resp_h IN hypervisor_ips 
          AND conn.log.id.resp_p IN management_ports
  - question: Has an IP address established an unusually rare connection to a hypervisor management interface?
    context: |
      This question aims to detect anomalous connections that deviate from established communication patterns. By calculating the historical frequency of source-destination pairs, it can flag new or unauthorized systems attempting to communicate with hypervisors, which could be an early sign of discovery activity.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - Core network switches
      - Virtual infrastructure management servers (e.g., vCenter, SCVMM)
      - Internet gateways
    range: last 90 days
    queries:
      - pseudocode: |
          CALCULATE rarity of (source_ip, destination_ip) pair over last 30 days. 
          ALERT if rarity < 5th percentile.
  - question: Did a machine learning model classify any network connections to hypervisor management interfaces as anomalous?
    context: |
      This question applies a machine learning approach (e.g., a one-class SVM) to detect subtle anomalies in connection metadata (e.g., source subnet, time, byte counts) that rule-based methods might miss. This provides a more sophisticated layer of detection for novel or stealthy discovery techniques.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - Core network switches
      - Virtual infrastructure management servers (e.g., vCenter, SCVMM)
      - Internet gateways
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY SVM model to new connection logs. 
          ALERT if connection is classified as 'anomalous'.
  - question: Was a process executed with command-line arguments matching known virtual machine discovery tools or patterns?
    context: |
      This question provides a high-fidelity signal of discovery by directly looking for the execution of common commands used by adversaries and administrators to enumerate virtual machines (e.g., `esxcli`, `vim-cmd`, `Get-VM`, `virsh list`). A match strongly suggests active reconnaissance.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Hypervisor hosts (ESXi, Hyper-V)
      - Virtualization management servers
      - Domain Controllers
      - Administrator workstations
      - Jump boxes
    range: last 90 days
    queries:
      - pseudocode: |
          SEARCH process creation logs (EID 4688, Sysmon EID 1) 
          FOR command_line MATCHES regex_list_of_vm_tools.
  - question: Did a user execute a command with an abnormally low historical probability or an unusually high argument entropy?
    context: |
      This question aims to detect when a user, even an administrator, runs a command that is unusual for them or uses it with abnormally complex arguments. This can indicate a compromised account being used for discovery or an attempt to obfuscate commands.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Hypervisor hosts (ESXi, Hyper-V)
      - Virtualization management servers
      - Domain Controllers
      - Administrator workstations
      - Jump boxes
    range: last 90 days
    queries:
      - pseudocode: |
          CALCULATE historical probability and argument entropy for each command execution per user. 
          ALERT if probability < 1st percentile OR entropy spikes.
  - question: Did a machine learning model classify any executed command lines as likely malicious VM discovery activity?
    context: |
      This question leverages a trained classification model to analyze the linguistic characteristics of command lines. This enables the detection of suspicious discovery commands that may not match simple keyword rules, catching novel or obfuscated variations.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Hypervisor hosts (ESXi, Hyper-V)
      - Virtualization management servers
      - Domain Controllers
      - Administrator workstations
      - Jump boxes
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY classification model to new command lines. 
          ALERT if score indicates high probability of malicious discovery.
  - question: Did a single source IP connect to an unusually high number of distinct hosts within a hypervisor network segment in a short time?
    context: |
      This question detects network sweeps. A rapid succession of connections to many different hosts from a single source is a classic indicator that an adversary is scanning the network to identify live systems and services within the virtualization environment.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - DMZ
      - Core network switches
      - VLANs containing virtual infrastructure
    range: last 90 days
    queries:
      - pseudocode: |
          COUNT distinct destination_ips per source_ip in hypervisor_vlan within 60-second window. 
          ALERT if count > 20.
  - question: Did a source IP's rate of connecting to distinct destination IPs or ports within the hypervisor segment exceed its historical baseline?
    context: |
      This question refines sweep detection by comparing current activity against a learned baseline for each source IP. This helps reduce false positives from legitimate systems that may have bursty but normal connection patterns, focusing instead on truly anomalous scanning behavior.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - DMZ
      - Core network switches
      - VLANs containing virtual infrastructure
    range: last 90 days
    queries:
      - pseudocode: |
          COMPARE distinct destination_ip/port count in 5-min window to 30-day baseline. 
          ALERT if count > 99th percentile.
  - question: Did a time-series model detect an anomalous rate of new connections from a host to the hypervisor subnets?
    context: |
      This question uses a more advanced statistical method to model the normal rhythm (e.g., daily/weekly cycles) of network traffic. It can detect scanning activity that might not be a simple burst but is still a significant deviation from the expected pattern over time.
    answer_sources:
      - Zeek conn.log
      - Hypervisor management network segments
      - DMZ
      - Core network switches
      - VLANs containing virtual infrastructure
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY time-series model (e.g., ARIMA, LSTM) to connection rates. 
          ALERT if observed rate significantly deviates from prediction.
  - question: Was a hypervisor management tool executed by an unauthorized user or from an unapproved host?
    context: |
      This question applies a high-confidence, zero-trust approach. By maintaining an allow-list of who can run privileged commands and from where, any execution outside of these defined parameters is immediately suspicious and warrants investigation for potential compromise or insider threat.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Zeek http.log
      - ESXi /var/log/hostd.log
      - ESXi /var/log/vobd.log
      - Virtualization management servers (vCenter, SCVMM)
      - Administrator workstations
      - Jump boxes/bastion hosts
      - Hypervisor hosts
    range: last 90 days
    queries:
      - pseudocode: |
          CHECK process creation events for hypervisor tools. 
          IF user or source_host NOT IN allow_list, ALERT.
  - question: Did an authorized administrator execute hypervisor management commands with a frequency that significantly deviates from their normal behavior?
    context: |
      This question addresses the risk of compromised administrative accounts. By baselining the normal command frequency for each admin, it can detect when an authorized account is used in an abnormal way, such as an unusual burst of activity that could signify an attacker has taken over the account.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Zeek http.log
      - ESXi /var/log/hostd.log
      - ESXi /var/log/vobd.log
      - Virtualization management servers (vCenter, SCVMM)
      - Administrator workstations
      - Jump boxes/bastion hosts
      - Hypervisor hosts
    range: last 90 days
    queries:
      - pseudocode: |
          FOR authorized users, calculate command frequency in 1-hour window. 
          ALERT if frequency > (moving_average + 3 * std_dev).
  - question: Did an administrator's hypervisor management activity deviate significantly from the behavior of their peers?
    context: |
      This question uses peer group analysis to identify outliers. If one administrator, who belongs to a group of users with a similar role, starts performing actions that are unusual compared to their colleagues, it could indicate a compromised account or an insider threat.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 4624
      - Zeek http.log
      - ESXi /var/log/hostd.log
      - ESXi /var/log/vobd.log
      - Virtualization management servers (vCenter, SCVMM)
      - Administrator workstations
      - Jump boxes/bastion hosts
      - Hypervisor hosts
    range: last 90 days
    queries:
      - pseudocode: |
          CLUSTER users into peer groups. 
          COMPARE user activity to their group's profile. 
          ALERT if user is a statistical outlier.
  - question: Was a successful login to a hypervisor, preceded by numerous failed logins from the same IP, immediately followed by the execution of a VM discovery command?
    context: |
      This question looks for a classic brute-force and reconnaissance attack chain. Correlating a high volume of failed logins, a subsequent successful login, and immediate discovery commands provides a very strong, high-confidence indicator of a successful intrusion.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Hypervisor management servers
      - Domain Controllers
      - RADIUS/TACACS+ servers
      - Identity and access management systems
    range: last 90 days
    queries:
      - pseudocode: |
          IF (count(EID 4625) > 10 from source_ip) 
          THEN (EID 4624 from source_ip) 
          THEN (EID 4688 with discovery_command within 10 mins), ALERT.
  - question: Was a high-risk login session to a hypervisor followed by the execution of a VM discovery command?
    context: |
      This question uses a risk-based approach to qualify logins, scoring them based on factors like IP geolocation rarity, time-of-day anomalies, and recent login failures. It escalates to a high-severity alert only when a high-risk login is followed by suspicious discovery activity, focusing analyst attention.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Hypervisor management servers
      - Domain Controllers
      - RADIUS/TACACS+ servers
      - Identity and access management systems
    range: last 90 days
    queries:
      - pseudocode: |
          CALCULATE risk_score for logins based on IP rarity, time anomaly, failure ratio. 
          IF risk_score > 98th percentile AND followed by discovery_command, ALERT.
  - question: Did an observed sequence of login and command execution events match a probabilistic model of an attack?
    context: |
      This question uses a sophisticated state-based model (Hidden Markov Model) to calculate the probability that an observed sequence of events (e.g., failed logins -> success -> discovery) matches a known malicious attack path. This can detect attack patterns even when they don't perfectly match rigid, predefined rules.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Hypervisor management servers
      - Domain Controllers
      - RADIUS/TACACS+ servers
      - Identity and access management systems
    range: last 90 days
    queries:
      - pseudocode: |
          APPLY HMM to event stream (4625, 4624, 4688). 
          IF probability of malicious state sequence is high, ALERT.