name: T1216.001: PubPrn
id: a8d2e9f0-c1b2-4d5e-8f6a-7b8c9d0e1f2a
description: This playbook helps investigate whether an adversary is using the signed Windows script PubPrn.vbs to execute remote code and evade defenses. This technique involves calling the script with a 'script:' moniker that points to a malicious remote location using protocols like HTTP/HTTPS, instead of the legitimate LDAP protocol. Detections focus on identifying these malicious command lines, analyzing the invoked URLs for suspicious characteristics (threat intelligence hits, new domains, high entropy), observing anomalous child processes (e.g., powershell.exe, cmd.exe) spawned by the script, correlating executions with suspicious outbound network connections, and identifying executions in anomalous contexts (e.g., by non-admin users or on non-print-servers).
type: technique
related:
- TA0005: Defense Evasion
contributors:
- Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Is cscript.exe or wscript.exe executing pubprn.vbs with a URL that matches known malicious indicators from threat intelligence?
  context: This question aims to identify the most direct evidence of PubPrn abuse. Adversaries use this technique to download and execute malicious scripts from remote servers. By parsing command lines for pubprn.vbs executions and checking the embedded URL against threat intelligence feeds, analysts can quickly spot known malicious activity.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Endpoint devices (workstations and servers)
  - Enterprise DNS resolvers
  - Network egress points (e.g., firewalls, proxies)
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_creation_events (e.g., WinEventID 4688) WHERE (process_name == 'cscript.exe' OR process_name == 'wscript.exe') AND command_line CONTAINS 'pubprn.vbs' AND command_line CONTAINS 'script:'. EXTRACT url. FOR EACH url, CHECK domain/IP against threat_intelligence_feed. ALERT on match.
- question: Is pubprn.vbs being used to execute a script from a newly registered or high-entropy domain?
  context: Attackers often use newly registered domains (NRDs) or algorithmically generated domains (DGAs) to host malicious payloads, as these are less likely to be on static blocklists. This question helps uncover these suspicious domains by checking their registration date and calculating the randomness (entropy) of the domain name, which are common indicators of malicious infrastructure.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Endpoint devices (workstations and servers)
  - Enterprise DNS resolvers
  - Network egress points (e.g., firewalls, proxies)
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_creation_events (e.g., WinEventID 4688) WHERE command_line CONTAINS 'pubprn.vbs'. EXTRACT domain from url. FOR EACH domain, QUERY WHOIS data for creation_date and CALCULATE shannon_entropy. ALERT if creation_date < 60 days OR entropy > baseline_95th_percentile.
- question: Can a machine learning model classify a URL used in a pubprn.vbs execution as malicious based on its lexical features?
  context: This question leverages machine learning to detect previously unseen malicious URLs that may not be caught by signature-based or statistical methods. By analyzing features like domain length, character distribution, and n-grams, a classification model can identify patterns characteristic of malicious URLs, providing a more sophisticated and proactive detection capability.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek dns.log
  - Endpoint devices (workstations and servers)
  - Enterprise DNS resolvers
  - Network egress points (e.g., firewalls, proxies)
  range: last 90 days
  queries:
  - pseudocode: FROM pubprn.vbs execution logs, EXTRACT url. FOR EACH url, EXTRACT lexical_features (length, TLD, n-grams, etc.). INPUT features into pre-trained_classifier_model. ALERT if model_score > threshold (e.g., 0.90).
- question: Is pubprn.vbs being executed with an HTTP or HTTPS protocol handler in the command line?
  context: The legitimate use of pubprn.vbs with the 'script:' moniker is to interact with printer objects in Active Directory via the 'ldap:' protocol. The use of 'http:' or 'https:' is a high-fidelity indicator of abuse, as it signifies the script is being used to fetch a remote payload from a web server, which is not its intended function. This is a simple but powerful detection.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers, particularly legacy systems (Windows < 10) where this technique is viable.
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_creation_events (e.g., WinEventID 4688) WHERE (process_name == 'cscript.exe' OR process_name == 'wscript.exe') AND command_line CONTAINS 'pubprn.vbs' AND (command_line CONTAINS 'script:http' OR command_line CONTAINS 'script:https'). ALERT on any match.
- question: Are there any statistically anomalous protocol handlers being used with pubprn.vbs executions?
  context: This question aims to identify deviations from the norm by analyzing the frequency of protocol handlers used with pubprn.vbs. Since the only expected handler is 'ldap:', any other handler (like 'http:', 'https:', 'ftp:') is a zero-frequency event and a 100% deviation from the baseline. This statistical approach automatically flags any non-standard usage as highly suspicious.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers, particularly legacy systems (Windows < 10) where this technique is viable.
  range: last 30 days
  queries:
  - pseudocode: AGGREGATE pubprn.vbs command lines over 30 days. EXTRACT protocol_handler after 'script:'. GENERATE frequency_distribution. ALERT on any protocol_handler != 'ldap:'.
- question: Can a machine learning model be trained to classify pubprn.vbs command lines as malicious based on the presence of specific keywords?
  context: This question explores using a simple classifier to automate the detection of malicious command lines. By training a model on features like the presence or absence of keywords ('pubprn.vbs', 'script:', 'http:', 'ldap:'), the system can learn to distinguish between legitimate and malicious usage patterns and flag suspicious executions in real-time.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers, particularly legacy systems (Windows < 10) where this technique is viable.
  range: last 90 days
  queries:
  - pseudocode: TRAIN classifier on labeled command lines using keywords as binary features. DEPLOY model to classify new pubprn.vbs executions. ALERT if classification is 'malicious'.
- question: Did a cscript.exe process running pubprn.vbs spawn a suspicious child process like powershell.exe or cmd.exe?
  context: After using pubprn.vbs to download a script, an adversary's next step is often to execute it. This frequently involves spawning another process, such as a command shell (cmd.exe), a scripting engine (powershell.exe), or another LOLBin (rundll32.exe). This question looks for these suspicious parent-child process relationships, which are strong indicators that the initial pubprn.vbs execution was malicious.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers with process relationship logging enabled.
  range: last 90 days
  queries:
  - pseudocode: SEARCH process_creation_events (e.g., WinEventID 4688). IDENTIFY parent_process cscript.exe with 'pubprn.vbs' in command line. CHECK if child_process is in watchlist (powershell.exe, cmd.exe, rundll32.exe, etc.). ALERT on match.
- question: Has a statistically rare parent-child process relationship involving cscript.exe (running pubprn.vbs) occurred?
  context: This question uses statistical rarity to identify anomalous process behavior. Legitimate software behavior typically results in common, predictable process chains. By establishing a baseline of normal parent-child relationships, we can flag any rare or never-before-seen combination involving cscript.exe and pubprn.vbs as a potential threat, even if the child process itself isn't on a predefined watchlist.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers with process relationship logging enabled.
  range: last 90 days
  queries:
  - pseudocode: BUILD baseline of parent-child process pairs over 90 days. FOR new cscript.exe('pubprn.vbs') -> child_process event, CALCULATE rarity. ALERT if frequency is below rarity_threshold (e.g., bottom 1st percentile).
- question: Does a process execution chain initiated by cscript.exe (running pubprn.vbs) have a low probability score, indicating an anomaly?
  context: This question applies n-gram analysis, a technique from natural language processing, to model normal sequences of process executions. By treating process names as 'words', the model learns which sequences are common and which are not. A low probability for a sequence starting with cscript.exe (running pubprn.vbs) suggests an anomalous and potentially malicious chain of events.
  answer_sources:
  - Windows Event ID 4688
  - All enterprise workstations and servers with process relationship logging enabled.
  range: last 90 days
  queries:
  - pseudocode: MODEL process chains using n-gram analysis. CALCULATE probability of new sequence starting with cscript.exe('pubprn.vbs'). ALERT if probability is below a learned threshold.
- question: Did cscript.exe make a network connection to a known malicious IP or domain shortly after executing pubprn.vbs?
  context: This question correlates process execution with network activity to find direct evidence of command-and-control (C2) communication or payload download. By linking a cscript.exe/pubprn.vbs event with a subsequent network connection to an address on a threat intelligence list, an analyst can confirm malicious activity.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek http.log
  - Zeek files.log
  - Endpoint devices (workstations and servers)
  - Network egress points (e.g., firewalls, proxies)
  - Network TAPs/SPANs generating Zeek data.
  range: last 90 days
  queries:
  - pseudocode: CORRELATE cscript.exe('pubprn.vbs') process events with network logs (e.g., Zeek conn.log) by source_ip within a 2-minute window. CHECK destination_ip/domain against threat_intelligence_feed. ALERT on match.
- question: Following a pubprn.vbs execution, did cscript.exe make a network connection to a rare port or destination, or transfer an unusually large amount of data?
  context: This question aims to detect anomalous network behavior that may indicate malicious activity, even without a known-bad destination. Adversaries might use non-standard ports to evade firewalls or exfiltrate large amounts of data. By baselining normal network activity for cscript.exe on a per-host basis, we can flag unusual ports, destination countries, or data volumes as suspicious.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek http.log
  - Zeek files.log
  - Endpoint devices (workstations and servers)
  - Network egress points (e.g., firewalls, proxies)
  - Network TAPs/SPANs generating Zeek data.
  range: last 90 days
  queries:
  - pseudocode: BASELINE cscript.exe network connections (ports, countries) per host. AFTER pubprn.vbs execution, ALERT if connection is to a rare port/country. MONITOR file size in associated connection and ALERT if size > 99th percentile.
- question: Was there an anomalous spike in a host's outbound network traffic shortly after a pubprn.vbs execution?
  context: This question uses time-series anomaly detection to identify significant changes in network traffic patterns that coincide with a pubprn.vbs execution. A sudden, unexpected spike in outbound data volume following the event is a strong indicator of data exfiltration or the download of a large second-stage payload, providing a high-priority alert for analysts.
  answer_sources:
  - Windows Event ID 4688
  - Zeek conn.log
  - Zeek http.log
  - Zeek files.log
  - Endpoint devices (workstations and servers)
  - Network egress points (e.g., firewalls, proxies)
  - Network TAPs/SPANs generating Zeek data.
  range: last 90 days
  queries:
  - pseudocode: APPLY time-series anomaly detection model to host's outbound traffic volume. CORRELATE pubprn.vbs execution events with time series. ALERT if an anomalous spike occurs within 2 minutes after the event.
- question: Was pubprn.vbs executed by a user who is not a printer administrator or on a host that is not a designated print server?
  context: This question focuses on the context of the execution to determine if it is legitimate. The pubprn.vbs script is intended for printer administration. Therefore, its execution by a standard user or on a regular workstation (not a print server) is highly irregular and a strong indicator of misuse. This requires an accurate asset inventory and user role definition.
  answer_sources:
  - Windows Event ID 4688
  - Active Directory security logs
  - All enterprise workstations and servers
  - Domain Controllers
  - Identity and Access Management (IAM) systems
  - Asset Inventory Database.
  range: last 90 days
  queries:
  - pseudocode: GET user and host from pubprn.vbs execution event. CHECK if user is in 'Printer Administrators' group AND if host is in 'Print Servers' asset list. ALERT if either is false.
- question: Has pubprn.vbs been executed with a frequency that is anomalous for a specific user or host?
  context: This question seeks to identify unusual execution frequency. A legitimate administrator might run the script occasionally. A sudden burst of executions by a user, or any execution on a host where it has never been seen before, deviates from normal behavior. By baselining execution counts, we can flag these statistical outliers as potential signs of compromise or malicious activity.
  answer_sources:
  - Windows Event ID 4688
  - Active Directory security logs
  - All enterprise workstations and servers
  - Domain Controllers
  - Identity and Access Management (IAM) systems
  - Asset Inventory Database.
  range: last 90 days
  queries:
  - pseudocode: BASELINE pubprn.vbs execution counts per user/host over 90 days. ALERT if hourly count > 3 standard deviations from mean. ALERT if execution occurs on user/host with zero historical count.
- question: Does a pubprn.vbs execution event fall outside the cluster of normal administrative activity?
  context: This question uses unsupervised machine learning to automatically define 'normal' behavior without pre-defined rules. By clustering execution events based on features like user role, host type, and time of day, the model will group legitimate administrative activities together. Any pubprn.vbs execution that the model flags as an outlier or 'noise' is, by definition, anomalous and requires investigation.
  answer_sources:
  - Windows Event ID 4688
  - Active Directory security logs
  - All enterprise workstations and servers
  - Domain Controllers
  - Identity and Access Management (IAM) systems
  - Asset Inventory Database.
  range: last 90 days
  queries:
  - pseudocode: CLUSTER process execution events using features like user_role, host_role, time_of_day. DEPLOY model to classify new pubprn.vbs events. ALERT if event is classified as an outlier/noise.