name: T1505.006: vSphere Installation Bundles
id: f47ac10b-58cc-4372-a567-0e02b2c3d479
description: Is an adversary maintaining persistence on ESXi hypervisors using malicious vSphere Installation Bundles (VIBs)? This can be detected by identifying network transfers of VIBs with hashes matching known malicious files, observing command-line executions that bypass security controls (`--force`, `--no-sig-check`), monitoring for suspicious outbound network activity from an ESXi host shortly after a VIB installation, flagging VIB transfers from unauthorized source IPs not on an established allowlist, and detecting installations performed by unauthorized users or outside of standard maintenance windows.
type: technique
related:
  - TA0003: Persistence
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Is a known malicious VIB file being transferred to an ESXi host?
    context: Adversaries may use custom or compromised vSphere Installation Bundles (VIBs) to install persistent malware on ESXi hosts. This question aims to detect the network transfer of these files by comparing their SHA256 hashes against a threat intelligence feed of known malicious file hashes. A match is a high-fidelity indicator of a compromise attempt.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network traffic sensors monitoring traffic to and from the ESXi management network (vmk0 interfaces) and vCenter servers.
      - Threat intelligence feed of malicious file hashes.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each file in files.log WHERE filename ENDS WITH '.vib' OR '.vgz'
            GET file_hash = sha256
            GET conn_id = file.conn_id
            FROM conn.log WHERE id == conn_id
              GET dest_ip = conn.dest_ip
              IF dest_ip IS_IN esxi_host_list
                IF file_hash IS_IN malicious_hash_feed
                  ALERT 'Known malicious VIB transferred to ESXi host'
  - question: Is a VIB file being transferred to an ESXi host from an unusually rare source IP address?
    context: Legitimate VIB transfers typically originate from a predictable set of sources, such as vCenter servers or official update repositories. An adversary might transfer a malicious VIB from a novel or infrequent source. This question identifies statistically rare source IPs for VIB transfers, which can indicate an unauthorized or suspicious origin.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network traffic sensors monitoring traffic to and from the ESXi management network (vmk0 interfaces) and vCenter servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BUILD baseline of VIB transfer source IPs and their frequencies over 90 days.
          FOR each new VIB transfer
            GET source_ip
            CALCULATE frequency percentile of source_ip
            IF frequency percentile < 5
              ALERT 'VIB transferred from statistically rare source IP'
  - question: Does a VIB file transfer event exhibit characteristics of malicious activity based on a trained classification model?
    context: This question uses a machine learning model to distinguish between benign and malicious VIB transfers. The model is trained on various network features (e.g., file size, source/destination, protocol, time) from historical data. This approach can detect novel threats that do not match known signatures or simple statistical outliers by learning the complex patterns of normal administrative behavior.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network traffic sensors monitoring traffic to and from the ESXi management network (vmk0 interfaces) and vCenter servers.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each new VIB transfer event
            EXTRACT features (file size, source subnet, dest subnet, protocol, mime_type, time_of_day)
            INPUT features into trained classification model (e.g., Random Forest)
            IF model_prediction == 'malicious'
              ALERT 'ML model classified VIB transfer as malicious'
  - question: Is an administrator using `esxcli` commands to bypass VIB security controls?
    context: Adversaries may use specific `esxcli` command flags to force the installation of unsigned or untrusted VIBs. This question looks for the explicit use of flags like `--force`, `--no-sig-check`, or setting the acceptance level to `CommunitySupported`, which are strong indicators of an attempt to bypass standard security measures for VIB installation.
    answer_sources:
      - Windows Event ID 4688
      - Linux auditd logs
      - Command line logging on vCenter Server Appliances (VCSA), Windows-based vCenter servers, and administrative jump boxes.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process creation logs (Win 4688, auditd)
          FOR command_line CONTAINS 'esxcli'
            IF command_line CONTAINS '--force' OR '--no-sig-check' OR 'acceptance set --level=CommunitySupported'
              ALERT 'esxcli command with security bypass flag detected'
  - question: Is an administrator executing a VIB-related `esxcli` command with a statistically rare combination of arguments?
    context: While an administrator might use various `esxcli` commands, the specific combinations of arguments for VIB installation are often standardized. This question establishes a baseline of normal argument usage for each user and flags executions that use a highly unusual or rare combination, which could indicate misuse or malicious intent.
    answer_sources:
      - Windows Event ID 4688
      - Linux auditd logs
      - Command line logging on vCenter Server Appliances (VCSA), Windows-based vCenter servers, and administrative jump boxes.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BUILD baseline of esxcli argument combinations per user over 90 days.
          FOR each new 'esxcli software vib install' or 'esxcli software acceptance set' command
            GET user and argument_combination
            CALCULATE rarity of argument_combination for that user
            IF rarity < 1%
              ALERT 'Statistically rare esxcli argument combination used for VIB management'
  - question: Does a sequence of `esxcli` commands indicate a malicious attempt to install a VIB, such as disabling a firewall before installation?
    context: Adversaries often perform a series of actions to achieve their objective, such as disabling security controls before installing malware and re-enabling them afterward to hide their tracks. This question uses a sequence analysis model (like an HMM) to identify highly improbable and suspicious sequences of `esxcli` commands that deviate from normal administrative workflows.
    answer_sources:
      - Windows Event ID 4688
      - Linux auditd logs
      - Command line logging on vCenter Server Appliances (VCSA), Windows-based vCenter servers, and administrative jump boxes.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL normal sequences of esxcli commands using a sequence analysis model (e.g., HMM).
          FOR each new sequence of esxcli commands
            CALCULATE the probability of the sequence under the model
            IF probability is below a learned threshold
              ALERT 'Anomalous sequence of esxcli commands detected'
  - question: Did an ESXi host connect to a known malicious domain or IP address shortly after a VIB installation or reboot?
    context: A malicious VIB may initiate command and control (C2) communication immediately after installation or upon the next system reboot. This question correlates VIB installation/reboot events with subsequent network traffic to identify connections to destinations listed on threat intelligence feeds, providing a strong signal of a successful compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - VMware vCenter event logs
      - ESXi host management interfaces (vmk0)
      - Network perimeter firewalls
      - DNS server logs
      - C2 threat intelligence feeds.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON vCenter event (VIB install or host reboot) for host_ip
            MONITOR network logs (DNS, conn) for 60 minutes
            IF host_ip queries for domain ON DNS_blocklist
              ALERT 'ESXi host queried malicious domain post-install/reboot'
            IF host_ip connects to dest_ip ON C2_feed
              ALERT 'ESXi host connected to C2 IP post-install/reboot'
  - question: Did an ESXi host initiate an outbound connection on a statistically rare port after a VIB installation or reboot?
    context: ESXi management interfaces typically communicate over a predictable set of ports for management and operations. A malicious VIB might initiate C2 traffic over an uncommon port to evade detection. This question baselines normal port usage for each host and flags connections to new or highly infrequent ports that occur after a VIB installation or reboot.
    answer_sources:
      - Zeek conn.log
      - VMware vCenter event logs
      - ESXi host management interfaces (vmk0)
      - Network perimeter firewalls.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BUILD baseline of destination ports used by each ESXi host.
          ON vCenter event (VIB install or host reboot) for host_ip
            MONITOR conn.log for 60 minutes for outbound connections from host_ip
            GET destination_port
            IF destination_port is NOT in the top 99.9th percentile of historical ports for host_ip
              ALERT 'ESXi host connected to a statistically rare port post-install/reboot'
  - question: Did an ESXi host exhibit an anomalous volume of outbound data transfer shortly after a VIB installation or reboot?
    context: The installation of a malicious VIB could be followed by data exfiltration or the download of additional malicious payloads, resulting in an unusual spike in network traffic. This question uses time series analysis to model the expected outbound traffic volume for each host and detects significant deviations from this forecast, which, when correlated with a recent VIB installation, can indicate malicious activity.
    answer_sources:
      - Zeek conn.log
      - VMware vCenter event logs
      - ESXi host management interfaces (vmk0)
      - Network perimeter firewalls.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL expected outbound data volume (orig_bytes) per host using time series model (e.g., SARIMA).
          ON vCenter event (VIB install or host reboot) for host_ip
            MONITOR actual outbound data volume for 60 minutes
            IF observed volume significantly deviates from forecast (high anomaly score)
              ALERT 'Anomalous outbound traffic volume from ESXi host post-install/reboot'
  - question: Was a VIB file transferred to an ESXi host from an IP address not on the authorized source allowlist?
    context: In a well-managed environment, VIBs should only be transferred from a limited set of trusted sources, such as vCenter servers and official VMware update repositories. This question checks if the source of a VIB transfer is on a pre-defined allowlist. A transfer from any other source is a clear policy violation and highly suspicious.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek http.log
      - Network taps monitoring traffic between administrative subnets and the ESXi management network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MAINTAIN allowlist of authorized_source_ips.
          FOR each file transfer WHERE filename ENDS WITH '.vib' or '.vgz'
            GET source_ip
            IF source_ip IS NOT IN authorized_source_ips
              ALERT 'VIB transferred from unauthorized source IP'
  - question: Was a VIB file downloaded using a rare or suspicious User-Agent string?
    context: Legitimate VIB downloads are typically performed by VMware software, which uses predictable User-Agent strings in HTTP requests. Adversaries might use common command-line tools like `curl` or `wget`, or custom scripts, which have different User-Agent strings. This question identifies VIB downloads associated with statistically rare or script-like user agents, indicating a potential manual or unauthorized download.
    answer_sources:
      - Zeek http.log
      - Network taps monitoring traffic between administrative subnets and the ESXi management network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          BUILD baseline of User-Agent frequencies for VIB file downloads.
          FOR each HTTP request for a VIB file
            GET user_agent
            CALCULATE frequency of user_agent
            IF frequency < 1% OR user_agent matches known scripting tools ('curl', 'wget', 'python-requests')
              ALERT 'VIB downloaded with rare or suspicious User-Agent'
  - question: Does a VIB file transfer appear as a network outlier when clustered with other transfers?
    context: This question uses unsupervised machine learning (clustering) to find anomalous VIB transfers. Benign transfers, often automated from a central vCenter, will share similar network characteristics and form a dense cluster. A malicious transfer, coming from a different source or using a different method, will likely not fit this pattern and will be flagged as a noise point or outlier by the algorithm.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Zeek http.log
      - Network taps monitoring traffic between administrative subnets and the ESXi management network.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CLUSTER all VIB transfer events using a density-based algorithm (e.g., DBSCAN) on network features (source IP, port, protocol, file size, JA3).
          FOR each new VIB transfer
            CLASSIFY as 'core', 'border', or 'noise' point.
            IF classification is 'noise'
              ALERT 'ML clustering identified VIB transfer as a network outlier'
  - question: Was a VIB installed by a user not in an authorized admin group or outside of a defined maintenance window?
    context: To enforce least privilege and change control, VIB installations should only be performed by specific administrative accounts during scheduled maintenance windows. This question verifies both the user's group membership in Active Directory and the time of the installation against approved schedules. A violation of either policy is a significant security event.
    answer_sources:
      - Windows Event ID 4688
      - Linux auditd logs
      - Active Directory security logs
      - Change management databases.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON 'esxcli software vib install' command
            GET executing_user and event_timestamp
            QUERY Active Directory for user's groups
            IF user_group IS NOT 'ESXi Admins'
              ALERT 'VIB installed by non-authorized user'
            CHECK event_timestamp against maintenance_windows
            IF event_timestamp IS NOT IN maintenance_windows
              ALERT 'VIB installed outside of maintenance window'
  - question: Did an authorized administrator install a VIB at a time that is statistically unusual for that specific user?
    context: Even authorized administrators have typical working patterns. An adversary who has compromised an admin account may perform actions at unusual times, such as late at night or on a weekend. This question establishes a baseline of activity hours for each admin and flags VIB installations that occur at a time that is a significant statistical deviation from that user's norm.
    answer_sources:
      - Windows Event ID 4688
      - Linux auditd logs
      - Active Directory security logs.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL typical activity hours for each administrator.
          ON 'esxcli software vib install' command
            GET executing_user and event_timestamp
            CALCULATE Z-score of event_timestamp based on user's activity model
            IF Z-score > 3
              ALERT 'Admin installed VIB at a statistically unusual time'
  - question: Does a VIB installation event appear unauthorized based on a machine learning model that considers user role, time, and login context?
    context: This question uses a comprehensive machine learning model to assess the legitimacy of a VIB installation. By incorporating a wide range of features—such as user role, time of day, source workstation, and correlation with preceding anomalous logins (like impossible travel)—the model can make a more nuanced determination of whether an activity is authorized, catching sophisticated attacks that might bypass simpler rules.
    answer_sources:
      - Windows Event ID 4688
      - Linux auditd logs
      - Active Directory security logs
      - Change management databases.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each 'esxcli software vib install' event
            EXTRACT features (user role, source host, time, day, preceding anomalous login flag)
            INPUT features into trained classification model (e.g., GBM)
            IF model_prediction == 'unauthorized'
              ALERT 'ML model classified VIB installation as unauthorized'