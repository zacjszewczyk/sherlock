name: "T1423: Network Service Scanning"
id: "a6b7c8d9-e0f1-4a2b-3c4d-5e6f7a8b9c0d"
description: "This playbook helps investigate whether a compromised mobile device is being used for network service discovery on the internal network. It focuses on identifying anomalous connection patterns, such as a single mobile device connecting to a large number of unique IPs or ports in a short time (horizontal/vertical scanning), a high ratio of failed or rejected connections compared to successful ones, and the presence of traffic artifacts specific to known scanning tools like Nmap or masscan, or direct triggers from security tools like Zeek."
type: "technique"
related: "TA0032: Discovery"
contributors: "Zachary Szewczyk, Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: 1.0
tags: "none"
questions:
  - question: "Has any mobile device attempted to connect to a known network canary?"
    context: "This question aims to detect blatant scanning or probing activity. Network canaries (or honeypots/honeyports) are assets with no legitimate production purpose. Any connection attempt to them is highly suspicious and can be a strong indicator of a compromised device performing reconnaissance on the network."
    answer_sources:
      - "Zeek conn.log"
      - "DHCP Server Logs"
      - "VPN Server Logs"
      - "Internal network segments accessible by mobile devices (e.g., corporate Wi-Fi, VPN address pools)"
      - "Core network switches"
      - "VPN concentrators"
      - "DHCP servers"
    range: "last 90 days"
    queries:
      - "SEARCH connection_logs WHERE source_ip IN mobile_subnets AND destination_ip IN canary_ips OR destination_port IN canary_ports"
  - question: "Is any mobile device connecting to an anomalously high number of unique hosts or ports compared to its own baseline and its peers?"
    context: "This question seeks to identify horizontal (many hosts) or vertical (many ports on one host) scanning behavior. By comparing a device's activity to its own history and to other similar devices, we can spot statistical outliers that suggest automated scanning rather than normal user behavior. Exceeding 3 standard deviations and being in the 99th percentile are strong indicators of abnormality."
    answer_sources:
      - "Zeek conn.log"
      - "DHCP Server Logs"
      - "VPN Server Logs"
      - "Internal network segments accessible by mobile devices (e.g., corporate Wi-Fi, VPN address pools)"
      - "Core network switches"
      - "VPN concentrators"
      - "DHCP servers"
    range: "last 90 days"
    queries:
      - "FOR each mobile_source_ip, CALCULATE unique_dest_ip_count AND unique_dest_port_count. COMPARE counts to 30-day baseline AND 99th percentile of peer group. ALERT if anomalous."
  - question: "Does any mobile device exhibit network traffic patterns that cause it to be an outlier in a machine learning clustering model?"
    context: "This question uses an unsupervised machine learning approach (DBSCAN) to find anomalous devices. By creating a feature vector for each device (e.g., unique IPs/ports contacted, connection success ratio, port entropy), we can group devices with similar behavior. Devices that don't fit into any normal cluster are flagged as outliers, potentially indicating scanning or other malicious activity that is structurally different from normal traffic."
    answer_sources:
      - "Zeek conn.log"
      - "DHCP Server Logs"
      - "VPN Server Logs"
      - "Internal network segments accessible by mobile devices (e.g., corporate Wi-Fi, VPN address pools)"
      - "Core network switches"
      - "VPN concentrators"
      - "DHCP servers"
    range: "last 90 days"
    queries:
      - "GENERATE feature_vector for each mobile_device. APPLY DBSCAN clustering. IDENTIFY outlier devices."
  - question: "Has any mobile device generated a high volume of rejected connections to a single host in a short time frame?"
    context: "This question looks for signs of a scanner encountering a firewalled host. A high number of rejected ('REJ') or reset ('RSTO') connections in a very short period (e.g., 20+ in one minute) to one destination is not normal behavior. It strongly suggests an automated tool is probing a host and being actively blocked by a host-based firewall."
    answer_sources:
      - "Zeek conn.log"
      - "Internal network segments accessible by mobile devices (e.g., corporate Wi-Fi, VPN address pools)"
      - "Core network switches"
      - "Network firewalls"
    range: "last 90 days"
    queries:
      - "SEARCH connection_logs FOR source_ip IN mobile_subnets WHERE connection_state IN ('REJ', 'RSTO'). COUNT events by source_ip, destination_ip over 1_minute_window. ALERT if count > 20."
  - question: "Does any mobile device have an abnormally high ratio of failed-to-successful network connections?"
    context: "This question tries to identify scanners by their inefficiency. Scanners often try to connect to many ports that are not open, resulting in a high number of failed or rejected connections. A normal device should have a very low failure rate. A ratio exceeding 80% or being in the top 98th percentile of all mobile devices is a strong signal of scanning activity."
    answer_sources:
      - "Zeek conn.log"
      - "Internal network segments accessible by mobile devices (e.g., corporate Wi-Fi, VPN address pools)"
      - "Core network switches"
      - "Network firewalls"
    range: "last 90 days"
    queries:
      - "CALCULATE ratio of (failed_connections / successful_connections) per mobile_device. ALERT if ratio > 0.8 OR ratio > 98th_percentile_of_peers."
  - question: "Has a time series anomaly detection model identified a statistically significant spike in failed connections from any mobile device?"
    context: "This question uses a time series model (like Prophet or ESD) to establish a baseline of normal 'background noise' of failed connections for each specific device. The model learns the device's typical patterns, including daily or weekly cycles. It then alerts only on spikes that are statistically significant and deviate from this learned forecast, providing a more sophisticated and device-specific detection method than simple thresholds."
    answer_sources:
      - "Zeek conn.log"
      - "Internal network segments accessible by mobile devices (e.g., corporate Wi-Fi, VPN address pools)"
      - "Core network switches"
      - "Network firewalls"
    range: "last 90 days"
    queries:
      - "INGEST per-minute_failed_connection_counts into time_series_model. TRAIN model on 30-day history. ALERT on anomalous spikes."
  - question: "Has any security tool (like Zeek) generated a specific scan alert, or has any traffic matched signatures of known scanning tools?"
    context: "This question focuses on high-fidelity, explicit indicators of scanning. It checks for direct alerts from network monitoring tools like Zeek that are specifically designed to detect scans ('Scan::Port_Scan'). It also looks for tell-tale signs in application-layer data, such as User-Agent strings in HTTP traffic (e.g., 'Nmap Scripting Engine') or other patterns that are unique to common scanning utilities."
    answer_sources:
      - "Zeek notice.log"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek signatures.log"
      - "Network tap or span port monitoring the ingress/egress of mobile device network segments (Wi-Fi, VPN)."
    range: "last 90 days"
    queries:
      - "SEARCH notice_logs for 'Scan::Port_Scan' or 'Scan::Address_Scan' from mobile_ips. AND/OR SEARCH http_logs, signature_logs for known scanner_tool_signatures."
  - question: "Is any mobile device sending traffic with unusually high payload entropy, suggesting obfuscated or non-standard protocols?"
    context: "This question attempts to find scanning activity that tries to evade simple signature-based detection. When Zeek cannot identify a protocol ('OTH'), it may be a custom or non-standard protocol. By calculating the Shannon entropy (a measure of randomness) of the traffic's payload, we can identify data that is highly random, which could be indicative of encrypted, compressed, or intentionally obfuscated payloads used by advanced scanning tools to probe services."
    answer_sources:
      - "Zeek notice.log"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek signatures.log"
      - "Network tap or span port monitoring the ingress/egress of mobile device network segments (Wi-Fi, VPN)."
    range: "last 90 days"
    queries:
      - "FOR TCP sessions from mobile_ips with protocol 'OTH', CALCULATE shannon_entropy of payload. ALERT if entropy > 98th_percentile_of_peers."
  - question: "Has a supervised machine learning model classified any network flow from a mobile device as likely scanning activity?"
    context: "This question uses a supervised machine learning model (like Random Forest) that has been pre-trained on labeled data containing both normal and malicious scanning traffic. By feeding it features from new network flows (e.g., duration, protocol, bytes transferred, connection state), the model can predict, based on its training, whether the new flow is likely part of a scan. This provides a predictive capability to detect scanning in near-real-time."
    answer_sources:
      - "Zeek notice.log"
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek signatures.log"
      - "Network tap or span port monitoring the ingress/egress of mobile device network segments (Wi-Fi, VPN)."
    range: "last 90 days"
    queries:
      - "EXTRACT features from new network_flows. APPLY trained_classification_model. ALERT if flow is classified as 'scanning'."