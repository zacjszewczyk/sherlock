name: "T1608: Stage Capabilities"
id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
description: "This playbook helps determine if an adversary is staging or utilizing pre-positioned capabilities to support operations. This involves detecting outbound network connections to known malicious infrastructure (C2, malware hosts), identifying connections that use suspicious artifacts (rare User-Agents, JA3/JA3S hashes), flagging connections with high-risk characteristics (non-standard ports, self-signed or short-lived certificates, dynamic DNS), identifying connections to domains with malicious properties (newly registered, high entropy/DGA, typosquatted), and correlating file downloads from sharing sites with immediate process execution on the endpoint."
type: "technique"
related:
  - "TA0042: Resource Development"
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Are internal hosts making outbound network connections to destinations that match high-confidence threat intelligence feeds?"
    context: "This is a primary detection method for identifying communication with known adversary infrastructure. A direct match between an internal host's outbound connection and a high-confidence list of Command and Control (C2) servers, malware distribution points, or phishing sites is a strong indicator of compromise."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "DNS resolvers"
      - "Internal network segments"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SELECT * FROM (outbound_network_logs) WHERE destination_ip IN (cti_ip_list) OR destination_domain IN (cti_domain_list)"
  - question: "Are internal hosts connecting to rare external destinations that also appear on any threat intelligence feed, including lower-confidence ones?"
    context: "Adversaries often use new or unique infrastructure for targeted attacks. This infrastructure might not yet be on high-confidence blocklists. By identifying destinations that are rarely visited by the organization (low prevalence) and are also mentioned on any threat feed (even low-confidence 'grey lists'), analysts can uncover newly staged adversary infrastructure."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "DNS resolvers"
      - "Internal network segments"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE prevalence of all external destinations over 30 days. IDENTIFY destinations in bottom 5th percentile. JOIN results with all CTI feeds. ALERT on matches."
  - question: "Can machine learning models identify suspicious outbound connections indicative of C2 or malware downloads that do not match known indicators?"
    context: "Signature-based detections can be evaded by adversaries using novel infrastructure. A supervised machine learning model can be trained on the behavioral characteristics of network flows (e.g., port, protocol, bytes transferred, connection duration) to identify suspicious activity that deviates from normal patterns, thus detecting potential C2 or malware downloads without relying on known IOCs."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek http.log"
      - "Zeek dns.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "DNS resolvers"
      - "Internal network segments"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY trained classification model to all new outbound network flows. SCORE each flow for maliciousness. ALERT on flows with a high score."
  - question: "Are there any outbound HTTP or TLS connections using User-Agents, URIs, or JA3/JA3S hashes known to be associated with adversary tools?"
    context: "Malware and adversary tooling often have unique, hardcoded identifiers in their network traffic, such as specific User-Agent strings or TLS client fingerprints (JA3/JA3S). Searching for these known-bad signatures is a high-fidelity method to detect the presence of specific malicious tools on the network."
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "Encrypted traffic inspection points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "SCAN http.log and ssl.log for User-Agents, URIs, and JA3/JA3S hashes that match a known-malicious signature list. ALERT on any match."
  - question: "Are any hosts using extremely rare User-Agents or JA3/JA3S hashes, suggesting the use of non-standard or custom tooling?"
    context: "Most legitimate applications are widely used, resulting in common User-Agents and TLS fingerprints. An artifact (like a JA3 hash) that is extremely rare across the organization (e.g., seen on only one host) is a strong anomaly. This could indicate a custom adversary tool, a niche legitimate application that warrants review, or a misconfigured client."
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "Encrypted traffic inspection points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE prevalence of all User-Agents and JA3/JA3S hashes over 30 days. FLAG any connection using an artifact in the bottom 1st percentile for investigation."
  - question: "Can we identify previously unknown C2 channels by clustering HTTP and TLS connections based on their characteristics?"
    context: "Unsupervised machine learning can group similar network connections without prior knowledge of what is malicious. By clustering connections based on features like JA3, JA3S, and User-Agent, analysts can discover small, distinct groups of traffic that do not correspond to known applications. These clusters may represent covert C2 channels that share underlying implementation artifacts."
    answer_sources:
      - "Zeek http.log"
      - "Zeek ssl.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "Encrypted traffic inspection points"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CLUSTER connection feature vectors (JA3, JA3S, User-Agent) using DBSCAN. ANALYZE small, anomalous clusters for potential C2 activity."
  - question: "Are there outbound connections exhibiting high-risk characteristics such as services on non-standard ports, self-signed certificates, or connections to dynamic DNS providers?"
    context: "Adversaries use these techniques to evade detection and maintain resilient infrastructure. Running a service like HTTP on a non-standard port can bypass simple firewalls. Self-signed certificates are common on quickly deployed malicious servers. Dynamic DNS allows an adversary's IP address to change frequently. Detecting these characteristics provides strong signals of suspicious activity."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek ssl.log"
      - "Zeek dns.log"
      - "Zeek x509.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "DNS resolvers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CREATE rules to ALERT on: 1) services on non-standard ports, 2) x509 certs where issuer equals subject, 3) DNS queries for known dynamic DNS providers."
  - question: "Are there connections using TLS certificates with unusually short validity periods or connections to statistically rare ports for a given service?"
    context: "Adversaries often use free, automated certificate authorities (like Let's Encrypt) that issue certificates with short, 90-day validity periods. A connection using a certificate with a validity period in the bottom percentile of all observed certificates is suspicious. Likewise, a legitimate service (like HTTPS) connecting to a destination port that is a statistical outlier for that service can indicate tunneling or evasion."
    answer_sources:
      - "Zeek conn.log"
      - "Zeek x509.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "DNS resolvers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE distribution of certificate validity periods; ALERT on bottom 5th percentile. BASELINE destination ports per service; ALERT on statistical outliers."
  - question: "Is there a sudden, anomalous spike in the number of new, never-before-seen certificate issuers or subjects on the network?"
    context: "A widespread campaign or an adversary setting up significant new infrastructure can cause a sudden increase in the number of new certificate issuers or subjects observed by the organization. Monitoring this metric with a time-series anomaly detection model can provide an early warning of such activity before specific IOCs are known."
    answer_sources:
      - "Zeek x509.log"
      - "Egress points (e.g., Firewalls, Web Proxies)"
      - "DNS resolvers"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "MODEL daily count of new certificate issuers/subjects with time-series analysis. ALERT on statistically significant spikes above the forecast."
  - question: "Are hosts connecting to domains that were registered very recently or are potential typosquats of legitimate domains?"
    context: "Adversaries frequently register new domains for their campaigns to evade reputation-based blocking (a practice known as 'domain aging'). Connections to domains created within the last 60 days are highly suspect. Similarly, typosquatted domains are designed to trick users into visiting malicious sites that look like legitimate ones. Both are strong indicators of malicious intent."
    answer_sources:
      - "Zeek dns.log"
      - "Zeek conn.log"
      - "DNS resolvers"
      - "Egress points (e.g., Firewalls, Web Proxies)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "ENRICH domains with WHOIS data; ALERT on connections to domains registered < 60 days ago. CALCULATE Levenshtein distance against critical domains; ALERT if distance <= 2."
  - question: "Are there DNS queries for domains with high character entropy, suggesting they were generated by a Domain Generation Algorithm (DGA)?"
    context: "Domain Generation Algorithms (DGAs) are used by malware to periodically create a large number of domain names that can serve as C2 rendezvous points. These algorithmically generated names (e.g., 'a83jf93jfu.com') often appear random and have high character entropy compared to human-readable domains. Detecting high-entropy domains is a key method for finding DGA-based C2 channels."
    answer_sources:
      - "Zeek dns.log"
      - "DNS resolvers"
      - "Egress points (e.g., Firewalls, Web Proxies)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CALCULATE Shannon entropy for all resolved domains. COMPARE scores to a known-good baseline. FLAG domains in the top 5th percentile of entropy for investigation."
  - question: "Can a machine learning model proactively identify DGA domains that may not be flagged by simpler entropy-based methods?"
    context: "More advanced DGAs can generate domains that appear more natural and may evade simple entropy checks. A deep learning model, such as a Long Short-Term Memory (LSTM) network, can be trained on the sequence of characters in a domain to learn the complex patterns that differentiate legitimate domains from DGA-generated ones, providing a more robust detection method."
    answer_sources:
      - "Zeek dns.log"
      - "DNS resolvers"
      - "Egress points (e.g., Firewalls, Web Proxies)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "FEED all newly observed domains into a trained LSTM classifier. INVESTIGATE domains classified as DGA with high confidence (> 0.90)."
  - question: "Has a user downloaded a file from a known file-sharing or code repository site and then immediately executed it?"
    context: "This sequence of events is a classic pattern for 'Ingress Tool Transfer,' where an adversary or malicious insider brings external tools onto a compromised host. By creating a stateful rule that correlates a network download from a high-risk site (like Pastebin or GitHub) with a process creation event for that same file on the same host within minutes, analysts can generate high-fidelity alerts for this behavior."
    answer_sources:
      - "Zeek http.log"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "Endpoint devices"
      - "Egress points (e.g., Web Proxies)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "CORRELATE file download from watchlist_site with process_creation_event on same host within 5 minutes where process_name matches filename. ALERT on match."
  - question: "Are any users or hosts downloading file types or from source domains that are anomalous compared to their established baseline behavior?"
    context: "Users and systems typically exhibit predictable behavior. Profiling this behavior allows for the detection of anomalies. For example, if a user from the HR department, who normally only downloads documents, suddenly downloads a PowerShell script from a code repository, this is a significant deviation from their baseline and could indicate a compromised account or malicious activity."
    answer_sources:
      - "Zeek http.log"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "Endpoint devices"
      - "Egress points (e.g., Web Proxies)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "PROFILE file types and source domains per user. IDENTIFY and ALERT on downloads that are statistical anomalies compared to the user's established profile."
  - question: "Can we detect anomalous sequences of endpoint events following a file download that indicate malicious activity?"
    context: "The actions taken after a file is downloaded are critical for determining intent. A normal sequence might be a browser downloading a DOCX file which is then opened by Microsoft Word. An anomalous sequence, such as a browser downloading a ZIP file, which is then unarchived, followed by the execution of an enclosed EXE, is highly indicative of tool deployment. Sequence analysis models can learn these patterns and alert on malicious chains of events."
    answer_sources:
      - "Zeek http.log"
      - "Zeek files.log"
      - "Windows Event ID 4688"
      - "Endpoint devices"
      - "Egress points (e.g., Web Proxies)"
    range: "last 90 days"
    queries:
      - technology: "pseudocode"
        query: "APPLY sequence analysis model to chains of endpoint events following a file download. ALERT on sequences that deviate from the normal, learned patterns."