name: T1020.001: Traffic Duplication
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: >-
  This playbook helps answer the question: Is the adversary exfiltrating data using traffic duplication? It provides investigative steps to detect this technique by looking for several key indicators. These include: outbound network flows to known malicious C2 or exfiltration domains; process creation events on network management hosts that configure traffic mirroring or spanning; statistically significant spikes in outbound data volume that deviate from historical baselines; network connections that exhibit anomalous protocol behavior or are associated with high-entropy DNS queries indicative of DGAs; and sequences of events where an anomalous login to a critical device is immediately followed by a large data transfer.
type: technique
related:
  - TA0010: Exfiltration
contributors:
  - Zachary Szewczyk
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are internal hosts connecting to known malicious infrastructure for potential data exfiltration?
    context: This question seeks to identify active command and control (C2) or exfiltration channels by cross-referencing outbound network connections with high-confidence threat intelligence. A match indicates a potential compromise where an adversary is using a known bad IP or domain to exfiltrate data. The query continuously monitors network logs to detect these connections in near real-time, allowing for rapid incident response.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network egress points
      - DNS resolvers
      - Cloud virtual network gateways
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN Zeek conn.log and dns.log ON connection_uid; FOREACH connection CHECK IF destination_ip OR resolved_domain IN threat_intel_feed; IF match, ALERT.
  - question: Is there evidence of one-way data transfer to newly observed external IP addresses?
    context: This question aims to detect covert data exfiltration by analyzing the ratio of sent to received data. A significantly high ratio (e.g., 100:1) for a connection to a new, unfamiliar IP address suggests that data is being pushed out without a corresponding return flow, a common pattern for data theft. This is particularly suspicious when the total volume of data sent is unusually high.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network egress points
      - DNS resolvers
      - Cloud virtual network gateways
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOREACH connection to new_IP (not seen in 30 days) CALCULATE sent_bytes / received_bytes ratio; IF ratio > 100 AND sent_bytes > 95th_percentile_for_new_IP_connections, ALERT.
  - question: Are internal systems attempting to resolve domains generated by a Domain Generation Algorithm (DGA)?
    context: This question focuses on identifying malware C2 communications that use DGAs to evade static blocklists. By applying a DGA classifier to DNS queries, we can proactively detect potential C2 domains that are not yet part of any threat intelligence feed. A high confidence score from the model indicates a strong likelihood of malicious activity.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network egress points
      - DNS resolvers
      - Cloud virtual network gateways
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOREACH DNS_query in Zeek dns.log, APPLY DGA_classifier_model; IF score > 0.9, ESCALATE for review.
  - question: Is an adversary configuring traffic mirroring on network management hosts?
    context: This question looks for direct evidence of an adversary setting up traffic duplication. By monitoring for specific command-line keywords associated with traffic mirroring (like 'monitor session', 'span', 'erspan') on critical network management devices, we can detect attempts to illicitly copy and redirect network traffic for exfiltration or reconnaissance.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Network management servers
      - Core switches/routers
      - Virtual network control planes (Cloud)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: ON 'Network Management' hosts, MONITOR process creation events (Win 4688); IF command_line CONTAINS ('monitor session', 'port-mirroring', 'span', 'erspan', 'gre', 'vTap', 'create-traffic-mirror'), ALERT.
  - question: Is encapsulated traffic (e.g., GRE) being sent to unauthorized external destinations?
    context: This question aims to find hidden exfiltration channels using tunneling protocols like GRE. By comparing the destination IPs of GRE flows against a pre-approved allowlist of monitoring partners, we can identify unauthorized tunnels being used to exfiltrate data to adversary-controlled infrastructure.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Network management servers
      - Core switches/routers
      - Virtual network control planes (Cloud)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOREACH GRE_traffic_flow (protocol 47) in Zeek conn.log, CHECK IF destination_ip NOT IN approved_allowlist; IF true, ALERT, especially if duration/volume > 95th_percentile.
  - question: Are network administrators executing anomalous command sequences that could indicate illicit traffic mirroring configuration?
    context: This question uses behavioral analytics to detect abuse of legitimate administrator credentials. An anomaly detection model can flag sessions that deviate from normal administrative workflows, potentially uncovering a compromised account being used to set up traffic duplication in a way that might not trigger single-keyword alerts.
    answer_sources:
      - Windows Event ID 4688
      - Zeek conn.log
      - Network management servers
      - Core switches/routers
      - Virtual network control planes (Cloud)
    range: last 90 days
    queries:
      - technology: pseudocode
        query: INGEST admin command history from Win 4688 logs; APPLY anomaly detection model to command sequences; IF session anomaly_score is high, FLAG for review.
  - question: Has any single network connection from a user workstation exfiltrated an egregious amount of data?
    context: This question acts as a simple but effective tripwire for large-scale data theft. By setting a high, static threshold (e.g., 1 GB) for outbound connections from standard user subnets, we can catch blatant exfiltration events that might be missed by more nuanced statistical methods.
    answer_sources:
      - Zeek conn.log
      - Network egress points
      - Server subnets
      - User workstation subnets
      - Database server segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOREACH connection FROM 'user workstation subnet' to external_ip, IF sent_bytes > 1GB, ALERT.
  - question: Is any internal host exhibiting a statistically significant increase in its daily outbound data volume?
    context: This question uses historical data to baseline normal behavior for each individual host. By calculating a rolling average and standard deviation of daily outbound traffic for each IP, we can detect when a host suddenly starts sending out much more data than usual, which is a strong indicator of compromise.
    answer_sources:
      - Zeek conn.log
      - Network egress points
      - Server subnets
      - User workstation subnets
      - Database server segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR EACH internal_ip, CALCULATE 30-day mean and std_dev of daily_outbound_volume; IF today's_volume > (mean + 3 * std_dev), ALERT.
  - question: Is the aggregate outbound traffic from critical network segments deviating from forecasted volumes?
    context: This question applies time-series forecasting to monitor entire network segments, like a database server subnet. By predicting the expected traffic volume, we can detect significant, unexpected spikes that could represent a large-scale exfiltration event involving multiple hosts within that segment.
    answer_sources:
      - Zeek conn.log
      - Network egress points
      - Server subnets
      - User workstation subnets
      - Database server segments
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOR critical_network_segments, APPLY ARIMA model to aggregate outbound traffic; IF observed_volume deviates significantly from forecasted_confidence_interval, ALERT.
  - question: Are large outbound data transfers associated with anomalous network protocol behavior?
    context: This question correlates high-volume data transfers with protocol-level anomalies. Events like 'inappropriate_FIN' in Zeek's weird.log suggest a non-standard connection. When this occurs during a large data transfer, it strongly indicates an adversary may be using a custom protocol to exfiltrate data.
    answer_sources:
      - Zeek conn.log
      - Zeek weird.log
      - Zeek dns.log
      - Network egress points
      - Application servers
      - DNS resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: JOIN Zeek weird.log and conn.log on connection_uid; IF conn.log sent_bytes > 100MB AND weird.log notice IN ('inappropriate_FIN', 'possible_split_routing', 'data_before_established'), ALERT.
  - question: Are DNS queries associated with high-volume traffic exhibiting high entropy, suggesting algorithmic generation?
    context: This question combines two indicators: high data volume and suspicious DNS queries. High Shannon entropy in a domain name indicates randomness, a hallmark of DGAs used by malware for C2. Flagging domains that are both random and associated with large data transfers can pinpoint C2 channels used for exfiltration.
    answer_sources:
      - Zeek conn.log
      - Zeek weird.log
      - Zeek dns.log
      - Network egress points
      - Application servers
      - DNS resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: FOREACH DNS_query, CALCULATE Shannon entropy of domain; IF entropy > 98th_percentile, FLAG for review.
  - question: Can we distinguish between legitimate encrypted traffic and obfuscated or tunneled data exfiltration?
    context: This question addresses finding malicious traffic hidden within encrypted channels. By training a machine learning model on network flow characteristics (packet sizes, timing, etc.), we can create a classifier to detect advanced exfiltration techniques that might otherwise blend in with legitimate traffic.
    answer_sources:
      - Zeek conn.log
      - Zeek weird.log
      - Zeek dns.log
      - Network egress points
      - Application servers
      - DNS resolvers
    range: last 90 days
    queries:
      - technology: pseudocode
        query: APPLY trained classification model to all outbound traffic flows using features from Zeek conn.log; IF classification is 'obfuscated' with high confidence, ALERT.
  - question: Is a suspicious login to a network device followed by the execution of a traffic mirroring command?
    context: This question chains together several suspicious events to build a high-confidence alert. It looks for a brute-force attempt (failed login followed by a success) on a critical device, which is then followed by a command to set up port mirroring. This sequence strongly suggests an attacker has gained access and is moving to exfiltrate data.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Authentication servers (Active Directory)
      - Network management servers
      - VPN concentrators
      - Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: TRIGGER on successful login (4624) IF preceded by failed login (4625) from same IP within 5 min; IF followed by process (4688) with mirroring keywords within 15 min, ALERT.
  - question: Is an anomalous administrative login followed by an unusual outbound data transfer from the managed network segment?
    context: This question correlates anomalous user behavior with anomalous network behavior. It first identifies a high-risk administrative login based on deviations from the user's normal profile. It then monitors for subsequent large data transfers from the network segments this administrator controls.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Authentication servers (Active Directory)
      - Network management servers
      - VPN concentrators
      - Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: SCORE risk of admin logins based on behavioral profile; IF login_risk_score > threshold, MONITOR for subsequent outlier outbound connections from related network segments.
  - question: Can we detect unusual pathways in a graph of user, host, and network interactions that indicate data exfiltration?
    context: This question uses graph analytics to discover complex attack paths. By modeling relationships between users, hosts, and external destinations, we can identify highly unusual patterns, such as a user logging into a device for the first time, followed immediately by that device initiating a large data transfer to a new external IP.
    answer_sources:
      - Windows Event ID 4624
      - Windows Event ID 4625
      - Windows Event ID 4688
      - Zeek conn.log
      - Authentication servers (Active Directory)
      - Network management servers
      - VPN concentrators
      - Network egress points
    range: last 90 days
    queries:
      - technology: pseudocode
        query: BUILD graph of (user)-[logs_into]->(host)-[sends_traffic_to]->(external_ip); USE graph anomaly detection to find unusual paths.