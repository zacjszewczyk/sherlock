name: T1037.001: Logon Script (Windows)
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: |
  This playbook is designed to help analysts detect if an adversary is maintaining persistence or escalating privileges using Windows logon scripts. It provides investigative questions and queries to identify malicious activity related to logon scripts, including the creation of malicious script files in common directories (e.g., SYSVOL), unauthorized modification of the HKCU\Environment\UserInitMprLogonScript registry value, suspicious network connections originating from script processes, and the use of scripts to execute privilege escalation tools or from improperly secured file locations. The playbook covers symbolic (IOC-based), statistical, and machine learning-based detection strategies.
type: technique
related:
  - TA0003: Persistence
  - TA0004: Privilege Escalation
contributors:
  - Zachary Szewczyk
  - Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Are known malicious script files being created or modified in Windows logon script directories?
    context: |
      This question aims to detect persistence attempts where an adversary places a script with a known malicious hash into a standard logon script location, like a user's profile or the domain's SYSVOL share. Matching the hash against a threat intelligence feed provides a high-confidence indicator of compromise.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - User profile directories on endpoints
      - SYSVOL shares on Domain Controllers
      - File servers hosting scripts
    range: last 90 days
    queries:
      - pseudocode: Search for file creation events in logon script paths. For each, hash the file and query a threat intelligence feed. Alert on match.
  - question: Is a new or modified logon script using an unusually rare file name, path, or extension compared to the established baseline?
    context: |
      Adversaries may use non-standard naming conventions or file types for their logon scripts to evade detection. This question helps identify such outliers by comparing new script attributes (name, path, extension) against historical data. A script that is statistically rare is suspicious and warrants investigation.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - User profile directories on endpoints
      - SYSVOL shares on Domain Controllers
      - File servers hosting scripts
    range: last 90 days
    queries:
      - pseudocode: Establish baseline of script names, paths, extensions. Search for new scripts and calculate rarity score. Alert on low rarity score (e.g., <5th percentile).
  - question: Does the content of a new or modified logon script exhibit features commonly associated with malicious code?
    context: |
      This question uses a machine learning model to analyze the content of logon scripts for indicators of maliciousness. By extracting features like character entropy, API call frequency, and suspicious keywords (e.g., 'Invoke-Expression'), the model can classify scripts as benign or malicious, identifying threats that signature-based methods might miss.
    answer_sources:
      - Windows Event ID 4663
      - Windows Event ID 4688
      - Sysmon Event ID 11
      - User profile directories on endpoints
      - SYSVOL shares on Domain Controllers
      - File servers hosting scripts
    range: last 90 days
    queries:
      - pseudocode: On file creation/modification in logon script paths, extract content features. Score script with ML classification model. Alert on high malicious confidence score.
  - question: Has the UserInitMprLogonScript registry key been modified by an unauthorized user or process?
    context: |
      The 'UserInitMprLogonScript' registry key is a known persistence mechanism. This question focuses on detecting modifications to this key made by any process or user not on a pre-approved allowlist. This helps catch unauthorized changes made by malware or attackers, distinguishing them from legitimate administrative actions.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - User endpoint and server registry hives, specifically HKCU\Environment for all user profiles.
    range: last 90 days
    queries:
      - pseudocode: Monitor modifications to HKCU\Environment\UserInitMprLogonScript. Check if the modifying process or user is on the approved watchlist. Alert if not on watchlist.
  - question: Is there an anomalous frequency of modifications to the UserInitMprLogonScript registry key for a specific user or host?
    context: |
      While occasional changes to this key may be normal, a sudden spike in modification activity can indicate an automated process or an adversary repeatedly trying to establish persistence. This question uses time-series analysis to detect deviations from the normal modification frequency for each entity (user/host), flagging unusual behavior.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - User endpoint and server registry hives, specifically HKCU\Environment for all user profiles.
    range: last 90 days
    queries:
      - pseudocode: Baseline modification frequency for UserInitMprLogonScript per host/user. Search for modification counts exceeding N standard deviations from the mean in a 24-hour period. Alert on anomaly.
  - question: Does a modification to the UserInitMprLogonScript registry key exhibit characteristics of an outlier compared to normal administrative activity?
    context: |
      This question leverages an anomaly detection model to identify suspicious registry modifications. The model learns the normal patterns of who (user), what (process), and when (time) changes are made. It can then flag outliers, such as a script being set by an unusual process like 'winword.exe', which could indicate a compromised process is being used to establish persistence.
    answer_sources:
      - Windows Event ID 4657
      - Sysmon Event ID 13
      - User endpoint and server registry hives, specifically HKCU\Environment for all user profiles.
    range: last 90 days
    queries:
      - pseudocode: Train anomaly detection model on registry modification event features (user, parent process, image, time). Score new modifications. Alert on significant outliers.
  - question: Is a process spawned by a logon script connecting to a known malicious IP address or domain?
    context: |
      A common objective for a malicious logon script is to establish a command and control (C2) channel. This question aims to detect this by correlating process events with network connections. If a child process of a script interpreter connects to a destination on a threat intelligence list, it is a strong indicator of compromise.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - User endpoints and servers
      - Network egress points
      - DNS servers
    range: last 90 days
    queries:
      - pseudocode: Correlate process creation (parent is script interpreter) with network connections. Enrich destination IP/domain with threat intelligence. Alert on match to known malicious destination.
  - question: Is a process spawned by a logon script connecting to a statistically rare domain for the enterprise?
    context: |
      Adversaries often use newly registered or obscure domains for their C2 infrastructure. This question helps identify such connections by calculating the rarity of every domain requested by a logon script's child process. A connection to a domain that is very uncommon across the enterprise is suspicious and warrants further investigation.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - User endpoints and servers
      - Network egress points
      - DNS servers
    range: last 90 days
    queries:
      - pseudocode: Build frequency table of all domains from DNS logs. For connections from logon script child processes, calculate domain rarity. Alert on connections to domains in the bottom percentile of prevalence.
  - question: Is the volume or frequency of network traffic from a logon script's child process anomalous compared to its historical baseline?
    context: |
      This question uses a time-series model to learn the normal network behavior (data volume, connection frequency) for processes spawned by logon scripts on a per-user basis. It aims to detect deviations that could indicate malicious activity, such as the periodic, low-volume "heartbeat" of a C2 channel or a sudden burst of data exfiltration.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - Sysmon Event ID 3
      - Zeek conn.log
      - Zeek dns.log
      - User endpoints and servers
      - Network egress points
      - DNS servers
    range: last 90 days
    queries:
      - pseudocode: Model expected outbound data volume and connection frequency per user for script-spawned processes. Alert when observed activity significantly deviates from the predicted baseline.
  - question: Has a logon script been modified to point to a file whose hash matches a known privilege escalation tool?
    context: |
      Adversaries may replace a benign logon script with a malicious one designed for privilege escalation, such as a component of PowerSploit or Mimikatz. This question detects this by monitoring changes to logon script configurations, hashing the new script file, and checking it against a database of known offensive security tools.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - Domain Controller SYSVOL Shares
      - User Endpoint Registry Hives (HKCU\Environment)
      - File systems on endpoints and servers
    range: last 90 days
    queries:
      - pseudocode: Monitor changes to logon script pointers. On change, hash the new script file. Query hash against a threat intel database of privilege escalation tools. Alert on match.
  - question: Are the command-line arguments used by a logon script process statistically anomalous?
    context: |
      Attackers often modify script execution by adding unusual command-line arguments, for example, to load a malicious DLL or execute an encoded payload. This question establishes a baseline of normal command-line argument patterns (n-grams) and alerts when a script is executed with arguments that are statistically rare, indicating potential tampering or malicious intent.
    answer_sources:
      - Sysmon Event ID 1
      - Windows Event ID 4657
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - Domain Controller SYSVOL Shares
      - User Endpoint Registry Hives (HKCU\Environment)
      - File systems on endpoints and servers
    range: last 90 days
    queries:
      - pseudocode: Profile frequency of command-line argument n-grams from logon script processes. Alert when a process is launched with statistically rare arguments or n-grams.
  - question: Does the content of a logon script contain features indicative of a privilege escalation tool?
    context: |
      This question uses a machine learning classifier to inspect the content of new or modified logon scripts. By looking for features like obfuscation, suspicious API calls related to token manipulation (e.g., 'CreateProcessAsUser'), or keywords from known tools (e.g., 'mimikatz'), the model can proactively identify scripts designed for privilege escalation, even if their hash is unknown.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4663
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - Domain Controller SYSVOL Shares
      - User Endpoint Registry Hives (HKCU\Environment)
      - File systems on endpoints and servers
    range: last 90 days
    queries:
      - pseudocode: On script modification, extract content features (obfuscation, API calls, keywords). Score script with a classifier trained on privilege escalation tools. Alert on high malicious score.
  - question: Has a privileged account modified a logon script for a standard user account outside of a documented change process?
    context: |
      A compromised administrative account might be used to set up persistence or lateral movement by modifying the logon script of a non-administrative user. This question detects such actions by correlating registry modification events with Active Directory group memberships, alerting when a privileged user modifies a standard user's script without a corresponding change management ticket.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4663
      - Sysmon Event ID 13
      - Active Directory Logs
      - User Endpoint Registry Hives (HKCU\Environment)
      - Active Directory user/group objects
      - Domain Controller SYSVOL Shares
    range: last 90 days
    queries:
      - pseudocode: On script modification, check if modifying user is privileged and target user is not. Correlate with change management system. Alert if privileged modification lacks a corresponding ticket.
  - question: Has a logon script modification occurred that violates established administrative boundaries within the organization?
    context: |
      In many organizations, administrative duties are segregated (e.g., by department or region). This question builds a model of these normal administrative boundaries by analyzing historical data of "who modifies whom." It then alerts on any modification that crosses these lines, such as an IT admin for one department modifying a script for a user in another, which could indicate misuse of a compromised account.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4663
      - Sysmon Event ID 13
      - Active Directory Logs
      - User Endpoint Registry Hives (HKCU\Environment)
      - Active Directory user/group objects
      - Domain Controller SYSVOL Shares
    range: last 90 days
    queries:
      - pseudocode: Build a graph of normal logon script modifications between users/OUs. Alert when a new modification crosses established administrative boundaries, indicating a statistically rare event.
  - question: Does a cross-user logon script modification exhibit anomalous characteristics compared to legitimate administrative actions?
    context: |
      This question uses an anomaly detection model to distinguish legitimate administrative script changes from malicious ones. The model learns the typical profile of a valid change, considering features like the privilege levels of the source and target users, their organizational units, and the time of day. It flags modifications that deviate from this profile, which could signal a compromised admin account being used for malicious purposes.
    answer_sources:
      - Windows Event ID 4657
      - Windows Event ID 4663
      - Sysmon Event ID 13
      - Active Directory Logs
      - User Endpoint Registry Hives (HKCU\Environment)
      - Active Directory user/group objects
      - Domain Controller SYSVOL Shares
    range: last 90 days
    queries:
      - pseudocode: Train an anomaly detection model on features from legitimate cross-user script modifications. Score new modifications. Alert on events flagged as significant anomalies.
  - question: Is a logon script executing from a path where permissions allow modification by non-administrative users?
    context: |
      An adversary can gain persistence or escalate privileges by modifying a script file. This is made easier if the file has weak permissions. This question checks the Access Control List (ACL) of logon script files and their directories, alerting if low-privilege groups like 'Everyone' or 'Authenticated Users' have write access, as this represents a significant security misconfiguration.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - File/Folder ACLs via PowerShell or API
      - File systems of Endpoints and Servers
    range: last 90 days
    queries:
      - pseudocode: On new logon script path detection, query the file and directory ACL. Alert if the ACL grants write/modify permissions to non-administrative groups (e.g., 'Everyone', 'Authenticated Users').
  - question: Does a logon script have a permission risk score that is statistically high for the environment?
    context: |
      Not all permission misconfigurations are equally critical. This question quantifies the risk by assigning weights to different insecure Access Control Entries (ACEs). By periodically scanning all logon scripts and calculating a risk score, it's possible to baseline what is "normal" and alert when a script's permissions are in the highest percentile of risk, indicating a dangerous and unusual configuration.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - File/Folder ACLs via PowerShell or API
      - File systems of Endpoints and Servers
    range: last 90 days
    queries:
      - pseudocode: Periodically scan logon script ACLs. Calculate a weighted 'permissions risk score' for each. Alert when a script's score exceeds the 99th percentile of all scores.
  - question: Is a logon script located in a path that a model predicts is vulnerable to tampering based on its ACL and path characteristics?
    context: |
      This question uses a machine learning model to proactively identify vulnerable script locations. The model is trained to recognize patterns of misconfiguration, considering features like the ACL, the directory depth, and whether the path is in a standard system location versus a user-writable area. This allows for the proactive identification of risky configurations before they can be exploited.
    answer_sources:
      - Windows Event ID 4688
      - Sysmon Event ID 1
      - File/Folder ACLs via PowerShell or API
      - File systems of Endpoints and Servers
    range: last 90 days
    queries:
      - pseudocode: Train a classification model on ACL and path features to predict vulnerability. Proactively run the model against all logon script paths. Alert on paths predicted as vulnerable.
  - question: Has a child process of a logon script performed a high-risk action like creating a service, modifying a scheduled task, or accessing LSASS memory?
    context: |
      A logon script may be used as a launchpad for more significant privilege escalation actions. This question uses event correlation to detect when a process spawned by a logon script immediately performs a highly suspicious follow-on action, such as creating a new service for persistence, creating a privileged scheduled task, or attempting to dump credentials from LSASS.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7045
      - Windows Event ID 4698
      - Windows Event ID 4656
      - Sysmon Event ID 1
      - Sysmon Event ID 10
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User endpoints and servers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: Correlate logon script child processes (Sysmon EID 1) with subsequent high-risk events (e.g., Service Creation EID 7045, LSASS access EID 10) from the same ProcessGUID. Alert on correlation.
  - question: Did a logon script execution trigger a statistically rare sequence of subsequent system events?
    context: |
      Benign logon scripts typically perform a predictable sequence of operations. This question profiles these normal event chains (e.g., process creation followed by a file read). It then alerts when a new execution exhibits a sequence that is historically very improbable, suggesting that the script's behavior has changed and may now be malicious.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7045
      - Windows Event ID 4698
      - Windows Event ID 4656
      - Sysmon Event ID 1
      - Sysmon Event ID 10
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User endpoints and servers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: Profile common sequences of events following logon script execution. Alert when a new execution exhibits a low-probability event chain based on historical data.
  - question: Does the sequence of operations following a logon script execution appear anomalous according to a sequence-based machine learning model?
    context: |
      This question uses a sophisticated sequence-based model (like an LSTM autoencoder) to learn what constitutes a "normal" series of events after a logon script runs. The model can detect subtle but significant deviations from this norm. A high reconstruction error for a new sequence suggests an anomalous chain of events (e.g., a script that never touches the registry suddenly modifies a run key), signaling a likely privilege escalation attempt.
    answer_sources:
      - Windows Event ID 4688
      - Windows Event ID 7045
      - Windows Event ID 4698
      - Windows Event ID 4656
      - Sysmon Event ID 1
      - Sysmon Event ID 10
      - Sysmon Event ID 11
      - Sysmon Event ID 13
      - User endpoints and servers
      - Domain Controllers
    range: last 90 days
    queries:
      - pseudocode: Train a sequence-based anomaly detection model (e.g., LSTM autoencoder) on event sequences following script execution. Alert when a new sequence has a high reconstruction error.