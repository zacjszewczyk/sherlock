name: "T1070.009: Clear Persistence"
id: "c5a5e3f4-0b1a-4d9e-8c7f-6a9b2d3e4f5a"
description: "This playbook focuses on detecting attempts by adversaries to evade defenses by clearing their persistence artifacts. It provides investigative questions to identify the deletion of known malicious persistence mechanisms, anomalous deletion patterns (e.g., high frequency, use of specific system utilities), the coordinated removal of multiple persistence types in a short time, and the cleanup of short-lived persistence artifacts that were associated with suspicious activity during their brief existence."
type: "technique"
related:
  - "TA0005: Defense Evasion"
contributors:
  - "Zachary Szewczyk"
  - "Ask Sage"
created: "2025-10-01"
modified: "2025-10-01"
version: "1.0"
tags: "none"
questions:
  - question: "Is a known malicious persistence artifact being deleted?"
    context: "This question aims to identify if an adversary is cleaning up a known malicious persistence mechanism. A match against a threat intelligence feed provides high-confidence evidence of an adversary attempting to cover their tracks after establishing persistence."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4657"
      - "Windows Event ID 4726"
      - "Threat Intelligence Feed"
      - "Domain Controllers, Critical Application Servers, Endpoints of privileged users, User Workstations"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH deletion_events (EventID 4663, 4657, 4726) | JOIN threat_intel_feed ON (deletion_events.object_name = threat_intel_feed.indicator) | WHERE match_found"
  - question: "Is a user deleting an unusually high number of files or registry keys from common persistence locations?"
    context: "This question looks for anomalous behavior by establishing a baseline of normal deletion activity for each user in sensitive persistence locations. A significant spike (e.g., >3 standard deviations) could indicate an automated script or a manual cleanup effort by an adversary trying to remove their footprint."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4657"
      - "Domain Controllers, Critical Application Servers, Endpoints of privileged users, User Workstations"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH deletion_events (EventID 4663, 4657) WHERE object_path IN common_persistence_locations | STATS count by user, 24h_window | COMPARE count to user_baseline_30d_avg, user_baseline_30d_stddev | WHERE count > (user_baseline_30d_avg + 3 * user_baseline_30d_stddev)"
  - question: "Does a specific deletion event have a high risk score based on its contextual features?"
    context: "This question uses a machine learning model to score the risk of a deletion event. By considering multiple features like the process performing the deletion, user context, and time of day, it can identify suspicious deletions that might not trigger simpler rules but fit a broader pattern of malicious activity."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4657"
      - "Windows Event ID 4726"
      - "Domain Controllers, Critical Application Servers, Endpoints of privileged users, User Workstations"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT deletion_events (EventID 4663, 4657, 4726) | EXTRACT features (process, parent_process, user_privilege, object_entropy, time_of_day) | APPLY ML_model_risk_scorer | WHERE risk_score > threshold"
  - question: "Is a standard system utility being used to delete a scheduled task, service, or registry key?"
    context: "This question focuses on detecting the use of legitimate system tools (`schtasks.exe`, `sc.exe`, `reg.exe`) for malicious purposes. Adversaries often use these 'living-off-the-land' binaries (LOLBins) to remove persistence, as their usage can blend in with normal administrative activity. The query escalates if the context (parent process, user) is unusual."
    answer_sources:
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Domain Controllers, Tier 0/1 Servers, Endpoint devices of privileged users, DNS Servers, Internet Gateway"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH process_creation (EventID 4688) WHERE process_name IN ('schtasks.exe', 'sc.exe', 'reg.exe') AND command_line CONTAINS 'delete' | IF parent_process NOT IN (admin_tools) OR user NOT IN (admin_groups) THEN ALERT"
  - question: "Is there an anomalous frequency or command-line entropy for deletion commands using system utilities on a specific host?"
    context: "This question seeks to identify unusual patterns in the use of system utilities for deletion. A sudden spike in the frequency of these commands on a single host, or a command line with unusually high or low complexity (entropy), can differentiate malicious cleanup scripts from routine administrative tasks."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers, Tier 0/1 Servers, Endpoint devices of privileged users, DNS Servers, Internet Gateway"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH process_creation (EventID 4688) WHERE process_name IN ('schtasks.exe', 'sc.exe', 'reg.exe') AND command_line CONTAINS 'delete' | STATS frequency by host | COMPARE frequency to host_baseline | WHERE frequency > 95th_percentile OR command_line_entropy is anomalous"
  - question: "Does a sequence of command-line activity involving a persistence deletion command deviate from normal user behavior?"
    context: "This question uses an advanced machine learning model to understand the normal sequence of commands a user or system executes. When a sequence that includes a persistence deletion command doesn't fit the learned benign patterns (high reconstruction error), it suggests an illegitimate or unexpected action that warrants investigation."
    answer_sources:
      - "Windows Event ID 4688"
      - "Domain Controllers, Tier 0/1 Servers, Endpoint devices of privileged users, DNS Servers, Internet Gateway"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT command_sequences by user_session (EventID 4688) | APPLY autoencoder_model | WHERE reconstruction_error > threshold AND sequence CONTAINS persistence_deletion"
  - question: "Is a single user session associated with the deletion of multiple, distinct types of persistence mechanisms within a short time frame?"
    context: "This question looks for a coordinated cleanup effort. It's uncommon for a legitimate user to delete a scheduled task, a service, and a registry run key all within a few minutes. Such activity, correlated by a single logon session, is a strong indicator of an adversary systematically removing their traces."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4701"
      - "Windows Event ID 4657"
      - "Windows Event ID 4726"
      - "Windows Event ID 4697"
      - "All Windows Endpoints and Servers, Active Directory Domain Controllers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH deletion_events (4701, 4697, 4657, 4726) | GROUP by LogonID over 5_min_window | COUNT distinct persistence_types | WHERE distinct_count >= 2"
  - question: "Has a single process deleted multiple categories of persistence mechanisms on a host, exceeding the established enterprise baseline?"
    context: "Similar to the previous question, this focuses on a single process as the actor. If one process (e.g., a malicious script) is responsible for deleting different types of persistence, it suggests a centralized cleanup script. Comparing this activity against an enterprise-wide baseline helps identify statistically significant outliers."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4701"
      - "Windows Event ID 4657"
      - "Windows Event ID 4726"
      - "Windows Event ID 4697"
      - "All Windows Endpoints and Servers, Active Directory Domain Controllers"
    range: "last 90 days"
    queries:
      - "pseudocode: SEARCH deletion_events | AGGREGATE by ProcessID, host over 5_min_interval | COUNT distinct persistence_categories | WHERE count > 99th_percentile_of_enterprise_baseline"
  - question: "Are there clusters of persistence deletion events that show a high diversity of mechanism types but are concentrated on a small number of users or hosts?"
    context: "This question uses unsupervised machine learning (clustering) to find 'hotspots' of suspicious activity without pre-defined rules. A dense cluster of deletion events that involves many different persistence types but is tied to only one or two users/hosts is highly anomalous and points to a targeted cleanup operation rather than random administrative actions."
    answer_sources:
      - "Windows Event ID 4663"
      - "Windows Event ID 4701"
      - "Windows Event ID 4657"
      - "Windows Event ID 4726"
      - "Windows Event ID 4697"
      - "All Windows Endpoints and Servers, Active Directory Domain Controllers"
    range: "last 90 days"
    queries:
      - "pseudocode: INPUT all_persistence_deletions with features (timestamp, host_id, user_id, mechanism_type) | APPLY DBSCAN clustering | ANALYZE clusters | ALERT on clusters with high mechanism_diversity AND low user/host_diversity"
  - question: "Was a short-lived persistence mechanism, which was associated with suspicious activity, recently deleted?"
    context: "This question aims to detect 'smash and grab' persistence. Adversaries may create a temporary persistence mechanism (e.g., a user account), use it for malicious actions (like C2 communication), and then quickly delete it. This query links the creation, suspicious use, and rapid deletion of an artifact to uncover this pattern."
    answer_sources:
      - "Windows Event ID 4720"
      - "Windows Event ID 4726"
      - "Windows Event ID 4698"
      - "Windows Event ID 4701"
      - "Windows Event ID 4697"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Authentication Servers (Domain Controllers), Internet Gateway, DNS Servers, Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: ON persistence_creation (4720, 4698) -> TRACK associated_activity (4688, zeek_logs) | IF associated_activity matches IOC -> TAG artifact as high-risk | ON persistence_deletion (4726, 4701) within 72h -> IF artifact is high-risk THEN ALERT"
  - question: "Was a persistence artifact deleted significantly faster than is typical for the enterprise?"
    context: "This question uses statistical analysis to find outliers in the lifespan of persistence artifacts. Legitimate user accounts or services usually exist for long periods. An artifact that is created and then deleted in a time frame that falls in the bottom 5th percentile of all artifact lifespans is suspicious and could indicate temporary, malicious use."
    answer_sources:
      - "Windows Event ID 4720"
      - "Windows Event ID 4726"
      - "Windows Event ID 4698"
      - "Windows Event ID 4701"
      - "Windows Event ID 4697"
      - "Authentication Servers (Domain Controllers), Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: CALCULATE Time-To-Deletion (TTD) for all persistence artifacts | COMPARE TTD to enterprise_wide_ECDF | ALERT if TTD is < 5th_percentile"
  - question: "Does the entire lifecycle of a persistence artifact, from creation through deletion, match a learned graph pattern of malicious behavior?"
    context: "This question employs advanced graph-based machine learning to model the complex relationships between entities (users, processes, hosts) over time. By learning what benign and malicious lifecycles of persistence mechanisms look like as graphs, a GNN can identify novel or complex attack patterns involving rapid creation, anomalous use, and deletion that might evade other detection methods."
    answer_sources:
      - "Windows Event ID 4720"
      - "Windows Event ID 4726"
      - "Windows Event ID 4698"
      - "Windows Event ID 4701"
      - "Windows Event ID 4697"
      - "Windows Event ID 4688"
      - "Zeek conn.log"
      - "Zeek dns.log"
      - "Authentication Servers (Domain Controllers), Internet Gateway, DNS Servers, Endpoint devices"
    range: "last 90 days"
    queries:
      - "pseudocode: CONSTRUCT entity_interaction_graph | APPLY GNN model to subgraphs representing persistence lifecycles | ALERT if subgraph embedding matches malicious pattern ('create' -> 'anomalous_activity' -> 'rapid_delete')"