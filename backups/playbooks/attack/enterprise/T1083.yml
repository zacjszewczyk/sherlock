name: 'T1083: File and Directory Discovery'
id: '75239b0a-3d90-48e0-94d0-559d24249a5b'
description: "This playbook helps answer the question: Is an adversary performing file and directory discovery on enterprise systems? It focuses on detecting the use of known malicious discovery tools, native command-line utilities for enumeration, statistically significant spikes in file system activity, access to sensitive directories, anomalous SMB connection patterns, and correlated sequences of discovery and staging events."
type: 'technique'
related:
  - 'TA0007: Discovery'
contributors: 'Zachary Szewczyk, Ask Sage'
created: '2025-10-01'
modified: '2025-10-01'
version: 1.0
tags: none
questions:
  - question: "Have any known malicious discovery tools, such as Seatbelt or SharpHound, been executed?"
    context: "This question aims to identify the most direct evidence of malicious file and directory discovery. Adversaries often use well-known, publicly available tools for reconnaissance. Detecting their execution by name or hash is a high-confidence indicator of compromise. This approach provides a quick win by matching against a curated list of known malicious indicators."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Log aggregation platform (SIEM) containing process execution logs from all enterprise endpoints and servers, with a focus on high-value assets like Domain Controllers, file servers, and developer workstations.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH process_creation_logs WHERE process_name IN (watchlist_tools) OR process_hash IN (watchlist_hashes)'
  - question: "Has any rare process been executed from an interactive shell like powershell.exe or cmd.exe?"
    context: "This question seeks to uncover unknown or custom discovery tools by focusing on rarity. Legitimate software is typically widespread, whereas malicious or ad-hoc tools are often found on very few machines. By identifying processes with low prevalence, especially those launched from a command shell, analysts can uncover suspicious activity that signature-based methods would miss."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Log aggregation platform (SIEM) containing process execution logs from all enterprise endpoints and servers, with a focus on high-value assets like Domain Controllers, file servers, and developer workstations.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH process_creation_logs | CALCULATE prevalence(process_hash) | FILTER prevalence < 5 AND parent_process IN (''powershell.exe'', ''cmd.exe'')'
  - question: "Has a machine learning model identified any process executions as highly likely to be malicious discovery activity?"
    context: "This question leverages machine learning to detect nuanced patterns of malicious behavior that are difficult to define with simple rules. By analyzing features like process name entropy, parent process, and command-line length, the model can score the likelihood of a process being a malicious discovery tool, providing a more sophisticated and adaptable detection method."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Log aggregation platform (SIEM) containing process execution logs from all enterprise endpoints and servers, with a focus on high-value assets like Domain Controllers, file servers, and developer workstations.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH process_creation_events | APPLY ML_model(features: [process_name_entropy, parent_process, cmd_line_length, hash_prevalence]) | FILTER model_confidence > 0.9'
  - question: "Have native utilities like 'dir' or 'find' been used with command-line arguments indicative of broad or sensitive file searches?"
    context: "Adversaries often 'live off the land' by using built-in system tools to avoid detection. This question focuses on how these tools are used. By inspecting command-line arguments for patterns like recursive searching combined with output redirection or searches for sensitive file extensions, analysts can distinguish malicious reconnaissance from benign administrative activity."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Log aggregation platform (SIEM) containing process execution logs from all endpoints and servers, particularly those where interactive command-line use is rare or should be highly scrutinized (e.g., web servers, database servers, application servers).'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH process_creation_logs WHERE process_name IN (''dir.exe'', ''tree.com'', ''find.exe'') AND command_line MATCHES REGEX (''/s'', ''>'') OR command_line MATCHES REGEX (''.pem'', ''.kdbx'')'
  - question: "Is any user or host using command-line arguments for discovery utilities in a way that is statistically unusual for them?"
    context: "This question establishes a behavioral baseline for how users and hosts typically use discovery commands. By flagging executions with arguments that deviate significantly from an entity's own history, analysts can spot anomalous behavior. For example, an administrator who normally uses 'dir' for simple listings but suddenly uses it to recursively search all drives is a strong anomaly."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Log aggregation platform (SIEM) containing process execution logs from all endpoints and servers, particularly those where interactive command-line use is rare or should be highly scrutinized (e.g., web servers, database servers, application servers).'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR each_execution | CALCULATE Jaccard_distance(new_args, historical_args_for_user_host) | FILTER distance > 98th_percentile'
  - question: "Has a sequence of commands executed by a user been identified as anomalous, particularly if it includes discovery commands?"
    context: "This question looks beyond individual commands to the entire sequence of actions within a user session. Malicious activity often follows a logical progression (e.g., discovery, staging, exfiltration) that differs from normal user workflows. By modeling command sequences, analysts can detect sessions that are statistically unlikely, indicating a potential intrusion, even if each individual command appears benign."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 1'
      - 'Log aggregation platform (SIEM) containing process execution logs from all endpoints and servers, particularly those where interactive command-line use is rare or should be highly scrutinized (e.g., web servers, database servers, application servers).'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR each_user_session | ANALYZE command_sequence_with_LSTM | FILTER sequence_probability is_low AND sequence CONTAINS (''dir'', ''find'', ''tree'')'
  - question: "Has any user or process generated a high volume of file access events or discovery commands in a short time frame?"
    context: "This question uses simple volume-based thresholding to detect brute-force discovery activity. While prone to false positives, it is effective at catching unsophisticated or rapid enumeration attempts where an adversary quickly scans large parts of a file system. A sudden burst of over 1000 file accesses or 100 discovery commands from one source is highly abnormal and warrants investigation."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4663'
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 11'
      - 'Log aggregation platform (SIEM) containing process creation and file audit logs from critical assets like file servers, SharePoint servers, source code repositories, and Domain Controllers.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH file_access_logs OR process_creation_logs | COUNT events by user, process over 5min_window | FILTER (file_access_count > 1000) OR (discovery_command_count > 100)'
  - question: "Has any user or host exhibited a statistically significant spike in file access or discovery command activity compared to their own baseline?"
    context: "This question refines volume-based detection by comparing activity against the entity's own historical behavior. Instead of a fixed, global threshold, it uses a dynamic one based on standard deviations. This makes the detection more robust, as it can identify a meaningful spike for a normally quiet user that might not cross a high static threshold, while ignoring benign high activity from a backup process."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4663'
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 11'
      - 'Log aggregation platform (SIEM) containing process creation and file audit logs from critical assets like file servers, SharePoint servers, source code repositories, and Domain Controllers.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR each_user_host | CALCULATE hourly_baseline(activity_count, 30_days) | COMPARE current_hour_count to baseline | FILTER current_count > (mean + 3 * std_dev)'
  - question: "Has time-series analysis detected an anomalous spike in file access events for any user or process, accounting for seasonality?"
    context: "This question employs sophisticated time-series modeling to provide the most accurate form of anomaly detection. By accounting for predictable patterns like daily or weekly cycles (e.g., increased activity during business hours or weekly backup jobs), models like SARIMA or Prophet can create a highly accurate forecast of expected behavior. Any actual activity that significantly exceeds the model's predicted range is a high-confidence anomaly."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4663'
      - 'Sysmon Event ID 1'
      - 'Sysmon Event ID 11'
      - 'Log aggregation platform (SIEM) containing process creation and file audit logs from critical assets like file servers, SharePoint servers, source code repositories, and Domain Controllers.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR each_user_process | MODEL file_access_timeseries with SARIMA/Prophet | PREDICT expected_count_range | FILTER actual_count > predicted_upper_bound'
  - question: "Has any single process or user accessed multiple distinct, sensitive directories from a predefined watchlist in a short time?"
    context: "This question focuses on protecting 'crown jewels' by monitoring access to specific, high-value locations. While access to one sensitive file might be legitimate, accessing several unrelated sensitive directories (e.g., HR, Finance, and IT secrets) in quick succession is highly suspicious. This 'tripwire' approach provides a targeted, high-fidelity alert for potential data gathering."
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 11'
      - 'File audit logs (Event ID 4663) from servers hosting sensitive departmental data (Finance, HR, Legal), Domain Controllers (SYSVOL, NTDS.dit location), and source code repositories.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH file_access_logs WHERE path IN (sensitive_path_watchlist) | COUNT distinct_paths by process over 1min_window | FILTER distinct_path_count > 3'
  - question: "Has any process exhibited unusually broad or random directory traversal, as measured by the entropy of accessed paths?"
    context: "This question seeks to quantify the randomness of file system access. Normal processes tend to access a predictable, limited set of directories. In contrast, a discovery script scanning a file system will access a wide and varied set of paths, resulting in high Shannon entropy. By flagging processes with unusually high path entropy compared to their peers, analysts can find tools performing broad reconnaissance."
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 11'
      - 'File audit logs (Event ID 4663) from servers hosting sensitive departmental data (Finance, HR, Legal), Domain Controllers (SYSVOL, NTDS.dit location), and source code repositories.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR each_process | CALCULATE Shannon_entropy(accessed_paths) over 10min_window | COMPARE to process_name_baseline | FILTER entropy > 99th_percentile'
  - question: "Has machine learning identified any user accounts as outliers based on their file and directory access patterns?"
    context: "This question uses clustering to define 'normal' user behavior without pre-defined rules. By grouping users with similar access patterns (e.g., all accountants access similar finance folders), the algorithm can automatically identify users who do not fit into any group. These outliers, whose behavior is unique, warrant investigation, especially if their anomalous activity involves sensitive directories."
    answer_sources:
      - 'Windows Event ID 4663'
      - 'Windows Event ID 4688'
      - 'Sysmon Event ID 11'
      - 'File audit logs (Event ID 4663) from servers hosting sensitive departmental data (Finance, HR, Legal), Domain Controllers (SYSVOL, NTDS.dit location), and source code repositories.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR all_users | VECTORIZE directory_access_patterns | CLUSTER with DBSCAN | IDENTIFY outlier_users | PRIORITIZE outliers accessing sensitive_directories'
  - question: "Has any host attempted to connect to an unusually high number of unique network shares, especially administrative shares (C$, ADMIN$)?"
    context: "This question targets lateral movement and network discovery. After compromising a host, an adversary will often scan the network for open shares to find more data. A single host connecting to many different shares across multiple servers in a short period is a classic indicator of this reconnaissance. The alert severity is increased if administrative shares are targeted, as this is a common attacker technique."
    answer_sources:
      - 'Zeek smb_files.log'
      - 'Zeek conn.log'
      - 'Zeek smb_mapping.log'
      - 'Windows Event ID 5145'
      - 'Network traffic data from network taps monitoring East-West traffic between subnets. Zeek sensors deployed at key network chokepoints (e.g., data center core, user access layer). Windows Security logs from all file servers and domain controllers.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH smb_mapping_logs OR network_share_access_logs | COUNT unique(host, share) by source_ip over 5min_window | FILTER unique_count > 10'
  - question: "Has any host exhibited an abnormally high 'fan-out' of SMB (port 445) connections compared to its peers?"
    context: "This question identifies network scanning behavior by measuring the 'fan-out' of SMB connections. A typical workstation might connect to a few file servers, but a compromised machine scanning the network will connect to dozens or hundreds of other hosts on port 445. By comparing a host's fan-out to its peers (e.g., other workstations), analysts can spot this anomalous behavior."
    answer_sources:
      - 'Zeek smb_files.log'
      - 'Zeek conn.log'
      - 'Zeek smb_mapping.log'
      - 'Windows Event ID 5145'
      - 'Network traffic data from network taps monitoring East-West traffic between subnets. Zeek sensors deployed at key network chokepoints (e.g., data center core, user access layer). Windows Security logs from all file servers and domain controllers.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'SEARCH conn_logs WHERE dest_port = 445 | CALCULATE unique_dest_ip_count by source_ip over 1hr_window | COMPARE to peer_group_baseline | FILTER fan_out > 95th_percentile'
  - question: "Has graph analysis revealed any hosts making unusual SMB connections that bridge otherwise separate network communities or show a sudden increase in centrality?"
    context: "This question applies graph theory to network traffic to find sophisticated lateral movement. Networks naturally form clusters or communities (e.g., the engineering department talks amongst itself). A compromised host that suddenly starts 'bridging' these communities—for example, a workstation from marketing connecting to a server in the R&D lab—is a powerful indicator of an intrusion that traditional methods might miss."
    answer_sources:
      - 'Zeek smb_files.log'
      - 'Zeek conn.log'
      - 'Zeek smb_mapping.log'
      - 'Windows Event ID 5145'
      - 'Network traffic data from network taps monitoring East-West traffic between subnets. Zeek sensors deployed at key network chokepoints (e.g., data center core, user access layer). Windows Security logs from all file servers and domain controllers.'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'CONSTRUCT graph from smb_conn_logs | RUN community_detection_algorithm | IDENTIFY hosts making cross-community_connections OR hosts with sharp_increase_in_centrality'
  - question: "Has any host exhibited a correlated sequence of local discovery, followed by network discovery, and culminating in data compression?"
    context: "This question connects individual suspicious events into a narrative that strongly aligns with the attacker lifecycle: reconnaissance, collection, and staging. While each event in isolation might be low-fidelity, their occurrence in this specific sequence from a single host within a short time window is a very high-confidence indicator of an active intrusion. This is a classic 'kill chain' detection."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4663'
      - 'Sysmon Event ID 11'
      - 'Zeek smb_mapping.log'
      - 'Zeek conn.log'
      - 'Centralized log management platform (e.g., SIEM, data lake) capable of correlating events from disparate sources, including endpoint process logs (Windows, Sysmon) and network traffic logs (Zeek).'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'CORRELATE events by host over 1hr_window | TRIGGER on sequence: (recursive_dir_command) FOLLOWED BY (smb_enumeration) FOLLOWED BY (archive_creation)'
  - question: "Has any host accumulated a high risk score over a short period by performing multiple, varied suspicious activities?"
    context: "This question implements a risk-based alerting (RBA) approach. Instead of generating an alert for every minor suspicious event, it assigns points to different activities and only alerts when a host's cumulative risk score crosses a threshold. This reduces alert fatigue by focusing analyst attention on entities that are demonstrating a pattern of multiple suspicious behaviors, rather than a single, isolated anomaly."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4663'
      - 'Sysmon Event ID 11'
      - 'Zeek smb_mapping.log'
      - 'Zeek conn.log'
      - 'Centralized log management platform (e.g., SIEM, data lake) capable of correlating events from disparate sources, including endpoint process logs (Windows, Sysmon) and network traffic logs (Zeek).'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR each_event | ASSIGN risk_score | SUM scores by host over 30min_window | ALERT if total_score > threshold'
  - question: "Has a machine learning model (HMM) determined that a host has transitioned into a 'Reconnaissance' or 'Staging' attack state based on its sequence of activities?"
    context: "This question uses a sophisticated state-machine model to infer an attacker's intent. The Hidden Markov Model is trained to understand the probable sequences of events that correspond to different hidden 'states' of an attack (e.g., Reconnaissance). By feeding a host's live event stream to the model, it can probabilistically determine if the host's behavior is consistent with an attack state, providing a powerful, context-aware detection."
    answer_sources:
      - 'Windows Event ID 4688'
      - 'Windows Event ID 4663'
      - 'Sysmon Event ID 11'
      - 'Zeek smb_mapping.log'
      - 'Zeek conn.log'
      - 'Centralized log management platform (e.g., SIEM, data lake) capable of correlating events from disparate sources, including endpoint process logs (Windows, Sysmon) and network traffic logs (Zeek).'
    range: 'last 90 days'
    queries:
      - technology: 'pseudocode'
        query: 'FOR each_host | FEED event_stream to HMM | ALERT if model_state transitions to ''Reconnaissance'' or ''Staging'' with high_probability'