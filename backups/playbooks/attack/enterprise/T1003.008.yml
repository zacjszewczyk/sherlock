name: T1003.008: /etc/passwd and /etc/shadow
id: 59a11a2f-e8d1-4a4b-8d07-73d8a956d498
description: This playbook investigates whether an adversary has attempted to acquire credentials from Linux hosts by accessing, copying, or exfiltrating the /etc/passwd or /etc/shadow files. It looks for indicators such as suspicious outbound network connections to rare or malicious destinations, direct command-line manipulation of the credential files, exfiltration of content matching the files' structure, anomalous file access patterns, and correlations between file access and subsequent network activity.
type: technique
related:
  - TA0006: Credential Access
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
investigative_questions:
  - question: Have any Linux servers established outbound network connections to destinations known to be malicious?
    context: This question aims to detect exfiltration or C2 communication by checking if any outbound connections from Linux servers are directed towards IPs, domains, or ASNs listed in threat intelligence feeds as malicious, command-and-control servers, or TOR exit nodes. A match indicates a high-probability compromise.
    answer_sources:
      - Zeek conn.log
      - Zeek dns.log
      - Network egress points, DNS resolvers, and border routers monitoring traffic originating from Linux server subnets.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          JOIN conn_logs and dns_logs by source_ip
          WHERE destination_ip or resolved_ip in threat_intelligence_feed('malicious', 'C2', 'TOR')
          ALERT on match
  - question: Have any Linux servers established outbound network connections to statistically rare destinations?
    context: This question seeks to identify anomalous exfiltration channels by baselining normal outbound traffic patterns for each server. By flagging connections to Autonomous System Numbers (ASNs) or countries that are rarely contacted, it can uncover potential data staging or C2 infrastructure that isn't yet on a threat intelligence list.
    answer_sources:
      - Zeek conn.log
      - Network egress points, DNS resolvers, and border routers monitoring traffic originating from Linux server subnets.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR each server:
            BASELINE historical destination ASNs and countries over 30 days
          FOR each new connection:
            CALCULATE frequency of destination ASN and country in baseline
            IF frequency < 5th percentile:
              ALERT
  - question: Are there any outbound network connections from Linux servers that are anomalous based on their protocol, port, size, and duration?
    context: This question uses machine learning to build a profile of what constitutes a 'normal' outbound connection from Linux servers. It analyzes multiple features of a connection simultaneously (protocol, port, bytes transferred, duration, destination ASN). Any connection that deviates significantly from this learned profile is flagged as an anomaly, potentially indicating a novel C2 channel or exfiltration method.
    answer_sources:
      - Zeek conn.log
      - Network egress points, DNS resolvers, and border routers monitoring traffic originating from Linux server subnets.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN anomaly detection model (e.g., Isolation Forest) on historical connection logs (features: proto, port, bytes, duration, ASN)
          FOR each new connection:
            PREDICT if connection is an anomaly using the model
            IF anomaly == true:
              ALERT
  - question: Have any commands been executed on Linux hosts that explicitly attempt to read, copy, or manipulate /etc/passwd or /etc/shadow?
    context: This question looks for direct, unambiguous attempts to access credential files using common Linux utilities. By searching for specific command patterns (e.g., `cat /etc/shadow`, `scp /etc/shadow`, `unshadow`), it provides high-fidelity alerts for blatant credential harvesting activities.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 1
      - The local file systems and process tables of critical Linux servers, including domain controllers, database servers, and servers in a DMZ.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          SEARCH process execution logs
          WHERE command_line MATCHES REGEX for ('cat|cp|less|more|head|tail|grep|awk|sed|cut' and '/etc/shadow') or ('unshadow' and '/etc/passwd' and '/etc/shadow') or ('scp' and '/etc/shadow')
          ALERT on match
  - question: Have there been any obfuscated commands or unusual process chains used to access /etc/passwd or /etc/shadow?
    context: This question aims to detect more sophisticated attempts to access credential files that might evade simple keyword matching. It looks for two indicators of evasion: 1) unusually complex or random-looking command lines (high entropy), suggesting obfuscation, and 2) processes accessing these files that were spawned by an unexpected parent process, indicating an abnormal execution chain.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 1
      - The local file systems and process tables of critical Linux servers, including domain controllers, database servers, and servers in a DMZ.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          FOR process events where command_line contains '/etc/passwd' or '/etc/shadow':
            CALCULATE command line Shannon entropy
            IF entropy > 95th percentile of baseline:
              ALERT
            CHECK parent-child process relationship
            IF relationship is new or rare for this file access:
              ALERT
  - question: Has a user or host executed an anomalous sequence of commands leading up to the access of /etc/passwd or /etc/shadow?
    context: This question uses machine learning to understand the typical command sequences executed by users and systems. By training a model on historical command-line activity, it can identify when a sequence of actions involving credential files deviates from established behavior. A high reconstruction error suggests the command sequence is novel and suspicious, even if individual commands seem benign.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 1
      - The local file systems and process tables of critical Linux servers, including domain controllers, database servers, and servers in a DMZ.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN sequence autoencoder model on historical command sequences per user/host
          FOR new command sequences involving credential files:
            CALCULATE reconstruction error using the model
            IF error > threshold:
              ALERT
  - question: Has any outbound network traffic contained content matching the format of /etc/passwd or /etc/shadow files?
    context: This question seeks to directly detect the exfiltration of credential files by inspecting the content of network traffic. Using Deep Packet Inspection (DPI) with regular expressions tailored to the specific structure of /etc/passwd and /etc/shadow entries, it can identify the data even if it's sent over a non-standard port or protocol.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network egress points instrumented with Deep Packet Inspection (DPI) or content-aware Network Data Loss Prevention (NDLP) systems.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          APPLY IDS rules to network traffic
          WHERE TCP stream or reassembled file content MATCHES REGEX for /etc/passwd format or /etc/shadow format
          ALERT on match
  - question: Have any anomalous plain text files been transferred from Linux servers?
    context: This question looks for suspicious file transfers that could represent credential exfiltration. It establishes a baseline of normal file transfers and alerts on files that are anomalous in their combination of MIME type (plain text), size (consistent with credential files), and filename (not a typical log or text file), which together are statistically rare.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network egress points instrumented with Deep Packet Inspection (DPI) or content-aware Network Data Loss Prevention (NDLP) systems.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ANALYZE outbound file transfer logs from Linux servers
          WHERE mime_type is 'text/plain'
            AND file_size is between 1KB and 100KB
            AND filename does not match common patterns (e.g., .log, .txt, .csv)
          ALERT if this combination is statistically rare
  - question: Has the content of any outbound plain text file been classified as a credential file?
    context: This question uses a trained machine learning model to classify the content of outbound text files. The model is trained to recognize the unique characteristics of /etc/passwd and /etc/shadow files, such as character patterns and the frequency of special characters. This allows it to detect exfiltrated credential data even if the filename is changed or the data is embedded in another file.
    answer_sources:
      - Zeek files.log
      - Zeek conn.log
      - Network egress points instrumented with Deep Packet Inspection (DPI) or content-aware Network Data Loss Prevention (NDLP) systems.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          TRAIN text classification model on legitimate text files vs. credential files
          FOR each new outbound plain text file:
            CLASSIFY content using the model
            IF classification is '/etc/passwd' or '/etc/shadow' with high confidence:
              ALERT
  - question: Has the /etc/shadow file been read by an unauthorized process or user?
    context: This question implements a high-fidelity check for unauthorized access to the most sensitive credential file, /etc/shadow. It relies on a strict allowlist of legitimate processes (like `login`, `sshd`, `passwd`) and user contexts (root or privileged accounts). Any read access outside this pre-defined list is a strong indicator of malicious activity.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 11
      - File system audit logs from all production Linux servers, particularly those hosting sensitive applications or data.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MONITOR file access logs
          WHERE file_path is '/etc/shadow' AND access_type is 'read'
            AND process_name is NOT in allowlist (e.g., login, sshd, passwd)
            OR user_context is NOT privileged
          ALERT on match
  - question: Has there been a statistically significant spike in access to /etc/passwd or /etc/shadow?
    context: This question aims to detect credential harvesting activity by monitoring the frequency of access to credential files. It establishes a historical, time-sensitive baseline (e.g., access per hour) and alerts when the number of access events dramatically exceeds the norm, which could indicate an automated script or adversary attempting to read the files.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 11
      - File system audit logs from all production Linux servers, particularly those hosting sensitive applications or data.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          INGEST file access logs into time-series database
          FOR '/etc/passwd' and '/etc/shadow':
            BASELINE access counts per hour over 30 days
            FOR each hour:
              IF current access count > 99th percentile of baseline for that hour:
                ALERT
  - question: Have there been any anomalous groupings of access events for /etc/passwd or /etc/shadow?
    context: This question uses clustering to identify file access events that do not fit into any known, legitimate pattern. By grouping historical access events based on features like the process name, user, and time of day, it can define what 'normal' access looks like (e.g., a 'user login' cluster, a 'cron job' cluster). Any new access event that is an outlier to all known clusters is considered suspicious.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 11
      - File system audit logs from all production Linux servers, particularly those hosting sensitive applications or data.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          CLUSTER historical file access events using features (process, user, time)
          DEFINE normal clusters (e.g., 'user login', 'backup script')
          FOR each new file access event:
            IF event does not belong to a known legitimate cluster:
              ALERT as outlier
  - question: Has an anomalous read of /etc/shadow been immediately followed by an outbound connection to a suspicious destination?
    context: This question correlates host and network events to detect a common attack pattern: grab credentials, then exfiltrate them. It triggers when an alert for anomalous /etc/shadow access occurs, and then specifically looks for a subsequent network connection from the same host to a destination that is either on a blocklist or uses a non-standard port.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 11
      - Zeek conn.log
      - Zeek files.log
      - A centralized security data lake or SIEM platform where host-based audit logs (AuditD, Sysmon) and network flow logs (Zeek) are aggregated and can be correlated by timestamp and host identifier.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON alert for anomalous '/etc/shadow' access:
            SEARCH network logs for connections from same source_ip within next 5 minutes
            WHERE destination_ip is on CTI blocklist
              OR destination_port is not on server's allowlisted port list
            ALERT on match
  - question: Following an anomalous read of /etc/shadow, has the host made a high-risk outbound connection?
    context: This question automates risk assessment following a suspicious file access event. When an anomalous read of /etc/shadow is detected, it analyzes all subsequent outbound connections from that host and calculates a composite risk score based on the rarity of the destination ASN, country, and port, as well as the amount of data sent. A high score suggests a likely exfiltration attempt.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 11
      - Zeek conn.log
      - Zeek files.log
      - A centralized security data lake or SIEM platform where host-based audit logs (AuditD, Sysmon) and network flow logs (Zeek) are aggregated and can be correlated by timestamp and host identifier.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          ON alert for anomalous '/etc/shadow' access:
            QUERY all outbound connections from host in next 10 minutes
            FOR each connection:
              CALCULATE risk_score based on rarity of dest_asn, dest_country, dest_port, and data_size
              IF risk_score > threshold:
                ESCALATE alert
  - question: Has a graph of system activity revealed a suspicious sequence involving /etc/shadow access followed by network exfiltration?
    context: This question uses a graph-based approach to model system behavior and detect attack paths. By representing hosts, processes, files, and IPs as nodes in a graph, it can learn what normal interaction patterns (subgraphs) look like. It then alerts when a new, structurally different subgraph appears that shows a clear link from an anomalous process accessing /etc/shadow to an external IP address.
    answer_sources:
      - AuditD logs
      - Sysmon for Linux Event ID 11
      - Zeek conn.log
      - Zeek files.log
      - A centralized security data lake or SIEM platform where host-based audit logs (AuditD, Sysmon) and network flow logs (Zeek) are aggregated and can be correlated by timestamp and host identifier.
    range: last 90 days
    queries:
      - technology: pseudocode
        query: |
          MODEL system activity as a graph (nodes: hosts, processes, files, IPs)
          LEARN common benign subgraphs
          ALERT when a new subgraph appears matching the pattern: ('/etc/shadow' -> 'anomalous process' -> 'external IP') AND is structurally different from known benign subgraphs