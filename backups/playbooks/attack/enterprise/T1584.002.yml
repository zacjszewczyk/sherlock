name: T1584.002: DNS Server
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: Is the adversary developing resources by compromising DNS servers for use in operations? This involves monitoring for DNS queries resolving to malicious IPs, unauthorized zone transfers, anomalous child processes spawned by DNS services, geographically unusual administrative logins, hijacking of critical domains, and queries to algorithmically generated or newly registered domains.
type: technique
related:
- TA0042: Resource Development
contributors:
- Zachary Szewczyk
- Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
- question: Are DNS queries resolving to or are administrative connections originating from known malicious IPs?
  context: This question seeks to identify direct interaction with known-bad infrastructure. A DNS query resolving to a malicious IP indicates a potential C2 callback or connection to a malicious site. An administrative connection (e.g., SSH, RDP) from a malicious IP to a DNS server is a strong indicator of compromise.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Windows Event ID 4624
  - Windows Event ID 4625
  - Internal recursive DNS servers
  - External-facing authoritative DNS servers
  - Network egress points
  - DNS server management consoles
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH dns.logs WHERE answer IN threat_intel_feed
      SEARCH conn.logs WHERE dest_port IN [22, 3389, 5985, 5986] AND source_ip IN threat_intel_feed
- question: Are internal clients communicating with domains resolving to new or statistically rare Autonomous Systems?
  context: Adversaries often use newly provisioned or obscure infrastructure. By baselining the normal Autonomous System Numbers (ASNs) that domains resolve to, we can detect when a domain suddenly resolves to an IP in a rare or new ASN for that specific domain. This can indicate a DNS hijack or use of compromised infrastructure.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Windows Event ID 4624
  - Windows Event ID 4625
  - Internal recursive DNS servers
  - External-facing authoritative DNS servers
  - Network egress points
  - DNS server management consoles
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CALCULATE frequency of domain-to-ASN resolutions
      IDENTIFY resolutions where ASN frequency for a given domain is < 1st percentile
      AGGREGATE risk by client IP
- question: Has there been a statistically significant spike in DNS resolutions to IPs flagged as suspicious?
  context: A sudden, widespread increase in queries resolving to IPs with a poor reputation can signal a coordinated campaign, such as a mass phishing attack or malware distribution. Using a time-series model helps distinguish a real attack from normal daily or weekly fluctuations in traffic.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Windows Event ID 4624
  - Windows Event ID 4625
  - Internal recursive DNS servers
  - External-facing authoritative DNS servers
  - Network egress points
  - DNS server management consoles
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      MODEL volume of DNS resolutions to suspicious IPs with ARIMA
      ALERT if current volume significantly deviates from forecast
- question: Are DNS zone transfer requests (AXFR/IXFR) originating from unauthorized IP addresses?
  context: Zone transfers are used to replicate DNS records between servers. An adversary can use a zone transfer request to map an organization's entire network infrastructure. This question checks if these powerful requests are coming from any IP not on a pre-approved list of secondary DNS servers or admin workstations.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Internal recursive DNS servers
  - External-facing authoritative DNS servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      DEFINE allowlist of authorized IPs for zone transfers
      SEARCH dns.logs WHERE query_type IN ['AXFR', 'IXFR'] AND source_ip NOT IN allowlist
- question: Are there anomalous zone transfer requests from either new or historically authorized IP addresses?
  context: This question adds a layer of behavioral analysis. A request from a completely new IP is an immediate flag. Additionally, an authorized server that suddenly starts requesting transfers at a much higher frequency (e.g., 100 times an hour instead of once) could indicate that the authorized machine itself has been compromised and is being misused.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Internal recursive DNS servers
  - External-facing authoritative DNS servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      BASELINE hourly AXFR/IXFR request frequency per source IP
      ALERT if request comes from a new IP OR if request count from known IP > 99.5th percentile
- question: Can machine learning models identify unauthorized DNS zone transfer attempts in real-time?
  context: For more sophisticated detection, a supervised machine learning model can be trained to recognize the subtle patterns of unauthorized zone transfer attempts. By learning from features like the source IP's reputation, time of day, and target server, the model can classify new requests as 'unauthorized' even if they don't trigger simple rules.
  answer_sources:
  - Zeek dns.log
  - Zeek conn.log
  - Internal recursive DNS servers
  - External-facing authoritative DNS servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      TRAIN a classifier (e.g., Random Forest) on labeled (authorized/unauthorized) historical zone transfer data
      DEPLOY model to classify new requests in near real-time
- question: Is the primary DNS service process spawning suspicious child processes like command shells or script interpreters?
  context: The Windows DNS Server service ('dns.exe') should not normally be spawning processes like 'cmd.exe' or 'powershell.exe'. Such an event is a very strong indicator that the DNS server has been compromised and an attacker is executing commands, likely for persistence or lateral movement.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - DNS Server infrastructure (both authoritative and recursive)
  - Domain Controller servers (if running DNS role)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      SEARCH process_creation_events WHERE parent_process = 'dns.exe' AND child_process IN ['cmd.exe', 'powershell.exe', 'pwsh.exe', 'cscript.exe']
- question: Are there new, never-before-seen parent-child process relationships originating from the DNS service process?
  context: Beyond looking for known-bad child processes, this question aims to find any anomalous process relationship. By creating a baseline of all normal child processes for 'dns.exe' over a period, any new relationship that appears is, by definition, an anomaly and warrants investigation. This can catch attackers using renamed or custom tools.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - DNS Server infrastructure (both authoritative and recursive)
  - Domain Controller servers (if running DNS role)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      BASELINE all child processes of 'dns.exe' over 30 days
      ALERT if a new process creation event involves a parent-child relationship not in the baseline
- question: Can an unsupervised machine learning model detect anomalous process creation events on DNS servers?
  context: This question proposes using an unsupervised model like an Isolation Forest to automatically learn what 'normal' process activity looks like on a DNS server. The model can analyze many features (process name, command line, user) simultaneously and flag any activity that it considers an outlier, without needing pre-defined rules.
  answer_sources:
  - Windows Event ID 4688
  - Sysmon Event ID 1
  - DNS Server infrastructure (both authoritative and recursive)
  - Domain Controller servers (if running DNS role)
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      TRAIN an Isolation Forest model on baseline process event data from DNS servers
      USE model to score new process events and ALERT on outliers
- question: Are administrative logins to DNS servers occurring from geographically forbidden locations?
  context: Many organizations have policies that forbid administrative access from certain countries. This is a straightforward but effective control. This question verifies that successful administrative logins (e.g., RDP or WinRM) are not originating from IPs that geolocate to a country on this deny-list.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - DNS Server infrastructure
  - Domain Controllers
  - VPN concentrators
  - Network egress points
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      DEFINE deny-list of countries for admin access
      SEARCH successful admin logins (Logon Type 3 or 10) on DNS servers
      ENRICH source IP with geolocation data
      ALERT if source country IN deny-list
- question: Is a user logging into a DNS server from a source IP, ASN, or country that is historically rare for that specific user?
  context: This is a form of User and Entity Behavior Analytics (UEBA). Instead of a global deny-list, we baseline what is normal for each individual administrator. A successful login by 'Admin_A' from a country or ASN they have never used before is suspicious, even if that location is acceptable for other admins.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - DNS Server infrastructure
  - Domain Controllers
  - VPN concentrators
  - Network egress points
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR EACH admin user, baseline source IPs, ASNs, and countries from past logins
      ON new login, check if source country is new (last 90d) OR if ASN is rare (<5th percentile) for that user
- question: Does a user's login behavior to a DNS server deviate from their established normal activity cluster?
  context: This advances the UEBA concept by using clustering algorithms like DBSCAN. The model groups a user's past logins into clusters representing 'normal' behavior (e.g., 'weekday-office-IPs', 'weekend-VPN-IPs'). A new login that doesn't fit into any existing cluster is flagged as a behavioral anomaly, indicating a potential account compromise.
  answer_sources:
  - Windows Event ID 4624
  - Zeek conn.log
  - DNS Server infrastructure
  - Domain Controllers
  - VPN concentrators
  - Network egress points
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR EACH user, CLUSTER historical login events using features like time, source IP/ASN/country
      ALERT if a new login event is flagged as an outlier (does not belong to any cluster)
- question: Are critical external domains resolving to IP addresses or ASNs outside of their known-good, allowlisted ranges?
  context: This question aims to detect hijacking of critical services your organization relies on (e.g., cloud providers, SSO). By maintaining a list of the legitimate IP ranges and ASNs for these services, you can immediately detect if a DNS response points to an unauthorized IP, which could be part of a man-in-the-middle attack.
  answer_sources:
  - Zeek dns.log
  - Network egress points
  - Internal recursive DNS servers
  - Endpoint devices
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      DEFINE allowlist of IPs/ASNs for critical domains (e.g., office365.com)
      SEARCH dns.logs WHERE query IN critical_domains AND answer NOT IN allowlist
- question: Is there a sudden drop in the diversity (entropy) of resolved IPs for a critical domain, suggesting a hijack?
  context: Large services like Office 365 resolve to many different IP addresses for load balancing. If a DNS hijack occurs, all users might suddenly be directed to a single malicious IP. This would cause the diversity (Shannon entropy) of the resolved IPs to drop suddenly. Monitoring for a sharp drop in entropy can detect this type of hijack.
  answer_sources:
  - Zeek dns.log
  - Network egress points
  - Internal recursive DNS servers
  - Endpoint devices
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      FOR EACH critical domain, calculate rolling 5-min entropy of resolved IPs
      BASELINE historical entropy values
      ALERT if entropy drops > 3 standard deviations below the mean
- question: Does the daily count of unique resolved IPs for a critical domain significantly deviate from its forecasted range?
  context: This is another method to detect hijacking by analyzing the number of unique IPs a domain resolves to. A time-series model can predict the normal range for this count. A sudden, massive drop (hijack to one IP) or a massive increase (a different type of anomaly) that falls outside the model's prediction would be flagged.
  answer_sources:
  - Zeek dns.log
  - Network egress points
  - Internal recursive DNS servers
  - Endpoint devices
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      MODEL daily count of unique IPs per critical domain using Prophet
      ALERT if actual count falls outside the model's prediction interval
- question: Are internal clients querying newly registered or algorithmically generated domains that resolve to malicious IPs?
  context: This is a classic indicator of malware. Attackers often use newly registered domains (NRDs) or Domain Generation Algorithms (DGAs) for command and control. This question combines three indicators: the domain is new or looks random (DGA), and it resolves to an IP that is already known to be malicious. The combination is a high-confidence signal.
  answer_sources:
  - Zeek dns.log
  - Network egress points
  - Endpoint devices
  - Internal recursive DNS servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      ENRICH dns.logs with WHOIS data and IP reputation
      SEARCH dns.logs WHERE (domain_age < 30 days OR is_dga) AND ip_reputation = 'malicious'
- question: Are clients querying domains with high character entropy (potential DGA) that also resolve to IPs in unusual ASNs?
  context: This question looks for DGA-like activity without relying on a pre-defined DGA flag. It first identifies domains that have high randomness (entropy) in their names (e.g., 'x7k2p9qjfs.com'). It then adds context by checking if that random-looking domain resolves to an IP in an ASN that the organization has never communicated with before, making it more suspicious.
  answer_sources:
  - Zeek dns.log
  - Network egress points
  - Endpoint devices
  - Internal recursive DNS servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CALCULATE entropy for all queried domain names
      FLAG domains with entropy > 99.7th percentile
      FOR flagged domains, check if resolved IP's ASN is new to the organization
- question: Can a deep learning model identify DGA domains that also resolve to IPs associated with other DGAs?
  context: This is a highly advanced technique. First, a deep learning model (like an LSTM) is trained to recognize the character patterns of DGA domains. Then, when the model flags a domain as a DGA, we perform a secondary check: does the IP it resolves to also host a high number of other domains that our model has classified as DGAs? This linkage provides very strong evidence of a C2 infrastructure.
  answer_sources:
  - Zeek dns.log
  - Network egress points
  - Endpoint devices
  - Internal recursive DNS servers
  range: last 90 days
  queries:
  - technology: pseudocode
    query: |
      CLASSIFY all queried domains as benign/DGA using an LSTM model
      CLUSTER IPs by the number of DGA domains they resolve to
      ALERT on queries for DGA-classified domains that resolve to an IP in a high-DGA cluster