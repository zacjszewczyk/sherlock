name: T1604: Proxy Through Victim
id: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
description: This playbook helps investigate if an adversary is using a managed mobile device as a proxy to hide C2 communications or other malicious activities. Indicators of this technique include an anomalously large volume of outbound data, an unusually high number of unique destination domains or IP addresses, connections to ports commonly associated with proxy services, and network behavior characteristic of a relay, such as a high number of concurrent or long-duration connections.
type: technique
related:
  - TA0030: Defense Evasion
contributors: Zachary Szewczyk, Ask Sage
created: 2025-10-01
modified: 2025-10-01
version: 1.0
tags: none
questions:
  - question: Has a mobile device exceeded a static threshold for outbound data volume in a given time window?
    context: This question seeks to identify mobile devices transmitting an unusually large volume of data, which could indicate their use as a proxy. A static threshold (e.g., 5 GB in 1 hour) provides a simple, initial filter for potential abuse. Legitimate high-volume traffic, such as to corporate backup servers or OS update CDNs, should be excluded to minimize false positives and focus on suspicious activity.
    answer_sources:
      - Zeek conn.log
      - Corporate Wi-Fi network segments, VPN gateways, and network egress points monitoring traffic from mobile device subnets.
    range: last 90 days
    queries:
      - search: Zeek conn.log | filter event_type = connection | group by source_ip | where sum(outbound_bytes) > 5GB in 1 hour AND destination_ip NOT IN (known_good_ips)
  - question: Is a mobile device's outbound data volume statistically anomalous compared to its own historical baseline or its peer group?
    context: This question uses a more sophisticated, dynamic approach to detect anomalous data volumes. By comparing a device's activity against its own history (using standard deviations) and its peers (using percentiles), it can identify deviations that might be missed by a static threshold. This helps to account for varying usage patterns between different users and roles, making it a more robust detection method for proxying activity.
    answer_sources:
      - Zeek conn.log
      - Corporate Wi-Fi network segments, VPN gateways, and network egress points monitoring traffic from mobile device subnets.
    range: last 90 days
    queries:
      - search: Zeek conn.log | calculate hourly outbound bytes per device | compare to 30-day moving average and standard deviation | alert if current_volume > (mean + 3 * std_dev) OR current_volume > 99th_percentile_of_peer_group
  - question: Does a mobile device's outbound data volume significantly deviate from a time-series model's prediction?
    context: This question employs advanced machine learning to identify proxy activity. A time-series model (like SARIMA or Prophet) learns the normal, cyclical patterns of a device's data usage over time. Alerts are generated when current activity deviates significantly from what the model predicts, allowing for the detection of subtle or complex anomalies that statistical baselining might miss. Regular retraining ensures the model adapts to legitimate changes in user behavior.
    answer_sources:
      - Zeek conn.log
      - Corporate Wi-Fi network segments, VPN gateways, and network egress points monitoring traffic from mobile device subnets.
    range: last 90 days
    queries:
      - search: Zeek conn.log | build time-series model on 90-day history of outbound bytes per device | score live data against model forecast | alert if observed_volume is outside confidence_interval
  - question: Has a mobile device queried an unusually high number of unique domains within a short time frame?
    context: This question aims to detect automated or scripted network activity, which is a hallmark of proxying. A user-driven device typically contacts a limited number of domains. A sudden spike in unique DNS queries, especially to domains not on an allowlist, suggests the device may be resolving addresses on behalf of another system.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Internal DNS servers, network firewalls, and web proxies that log DNS queries and outbound connections from mobile devices.
    range: last 90 days
    queries:
      - search: Zeek dns.log | filter source_ip is mobile_device | count unique domains in 5-min window | alert if count > 100 AND domain NOT IN (allowlist)
  - question: Is a mobile device exhibiting statistically anomalous behavior in both the number of unique domains queried and the randomness (entropy) of those domains?
    context: This question combines two powerful indicators. A high count of unique domains suggests automated activity, while high Shannon entropy suggests the domain names are random and not human-generated, a common trait of domain generation algorithms (DGAs) used by malware. Alerting on both conditions provides a high-confidence signal that the device is being used for malicious proxying or C2 communications.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Internal DNS servers, network firewalls, and web proxies that log DNS queries and outbound connections from mobile devices.
    range: last 90 days
    queries:
      - search: Zeek dns.log | calculate unique SLD count and Shannon entropy per device per hour | compare to peer group percentile and device baseline | alert if unique_count > 98th_percentile AND entropy > (mean + 2 * std_dev)
  - question: Is a mobile device identified as a strong outlier by an anomaly detection model based on its DNS and connection patterns?
    context: This question uses an unsupervised machine learning model, Isolation Forest, to find 'rare' or 'different' devices. The model considers multiple features at once (unique IPs, unique DNS queries, entropy, failed connections) to build a holistic view of normal behavior. Devices that the model easily 'isolates' are considered outliers and warrant investigation, as they may be acting as proxies.
    answer_sources:
      - Zeek dns.log
      - Zeek conn.log
      - Internal DNS servers, network firewalls, and web proxies that log DNS queries and outbound connections from mobile devices.
    range: last 90 days
    queries:
      - search: Zeek dns.log, Zeek conn.log | aggregate features (unique IPs, unique DNS, entropy, failed connections) per device per hour | train Isolation Forest model | alert on devices flagged as strong outliers
  - question: Is a mobile device connecting to destination ports commonly associated with proxy services?
    context: This question looks for a straightforward indicator of proxying: connections to well-known proxy ports like 1080 (SOCKS), 3128, 8080, and 8888. While these ports can have legitimate uses, an unexpected connection from a mobile device to one of these ports on an external system is highly suspicious and should be investigated immediately.
    answer_sources:
      - Zeek conn.log
      - MDM/EMM Application Inventory
      - Firewall Logs
      - Network flow collectors at egress points, firewall logs, and MDM/EMM management platforms.
    range: last 90 days
    queries:
      - search: Zeek conn.log, Firewall Logs | filter source_ip is mobile_device AND destination_port IN (1080, 3128, 8080, 8888) | correlate with MDM inventory | alert on unauthorized connections
  - question: Is a mobile device connecting to an unusually high ratio of 'rare' ports compared to its peer group?
    context: This question identifies deviations from normal application behavior. Every device has a typical set of destination ports it uses for its applications. A sudden increase in connections to 'rare' ports (those not in its baseline) suggests a new, potentially unauthorized application is running, which could be a proxy tool. Comparing this ratio to its peer group helps contextualize what is truly unusual.
    answer_sources:
      - Zeek conn.log
      - MDM/EMM Application Inventory
      - Firewall Logs
      - Network flow collectors at egress points, firewall logs, and MDM/EMM management platforms.
    range: last 90 days
    queries:
      - search: Zeek conn.log | build 30-day baseline of normal destination ports per device | calculate ratio of rare_port_connections to common_port_connections in 1-hour window | alert if ratio > 95th_percentile_of_peer_group
  - question: Is a mobile device making network connections that are classified as anomalous by a machine learning model?
    context: This question uses a one-class SVM, a machine learning algorithm designed to learn a boundary around 'normal' data. By training it on historical connection features (port, protocol, duration), it can identify any new connection that falls outside this normal profile. This is effective for detecting novel proxying techniques that may not use known ports or obvious patterns.
    answer_sources:
      - Zeek conn.log
      - MDM/EMM Application Inventory
      - Firewall Logs
      - Network flow collectors at egress points, firewall logs, and MDM/EMM management platforms.
    range: last 90 days
    queries:
      - search: Zeek conn.log | train one-class SVM model on historical connection features (port, protocol, duration) per device | classify live connections | alert on connections flagged as anomalous
  - question: Has a mobile device maintained an unusually long-duration connection to an external system?
    context: This question aims to identify persistent tunnels, which are a key characteristic of a C2 relay or proxy. Normal mobile applications typically use short-lived connections. A connection lasting for an exceptionally long time (e.g., over 24 hours) is highly abnormal and suggests a persistent backdoor or tunnel is being maintained for proxying traffic.
    answer_sources:
      - Zeek conn.log
      - Network flow collectors (e.g., Zeek sensors) at key chokepoints like the Wi-Fi access controller or VPN concentrator.
    range: last 90 days
    queries:
      - search: Zeek conn.log | filter source_ip is mobile_device AND connection_duration > 24 hours AND state = 'SF' | alert if destination_ip NOT IN (allowlist)
  - question: Is a mobile device exhibiting anomalous behavior in both its number of concurrent connections and the average duration of those connections?
    context: This question uses a multivariate approach to find devices acting as relays. A proxy often needs to handle many connections at once, and these connections may be longer than usual. By looking for devices that are outliers in both metrics at the same time using an algorithm like Mahalanobis distance, we can more reliably identify suspicious relaying behavior.
    answer_sources:
      - Zeek conn.log
      - Network flow collectors (e.g., Zeek sensors) at key chokepoints like the Wi-Fi access controller or VPN concentrator.
    range: last 90 days
    queries:
      - search: Zeek conn.log | calculate active_connections_count and avg_connection_duration per device in 5-min intervals | use Mahalanobis distance to find outliers across both metrics | alert on outliers
  - question: Is a mobile device identified as a behavioral outlier ('noise') by a clustering algorithm when compared to the entire device population?
    context: This question uses clustering (DBSCAN) to find devices that don't fit into any normal peer group. The algorithm groups devices with similar network behaviors (concurrent connections, duration, data volume). Any device that doesn't belong to a cluster is labeled as 'noise' and is, by definition, a significant outlier. These 'lone wolf' devices are prime candidates for investigation as potential proxies.
    answer_sources:
      - Zeek conn.log
      - Network flow collectors (e.g., Zeek sensors) at key chokepoints like the Wi-Fi access controller or VPN concentrator.
    range: last 90 days
    queries:
      - search: Zeek conn.log | calculate features (avg_concurrent_connections, 95th_percentile_duration, total_outbound_bytes) per device over 24 hours | apply DBSCAN algorithm to device population | alert on devices classified as noise