[
  {
    "information_requirement": "Has the adversary modified trust relationships for privilege escalation? (PIR)",
    "tactic_id": "TA0004",
    "tactic_name": "Privilege Escalation",
    "indicators": [
      {
        "technique_id": "T1484.002",
        "name": "Trust Modification",
        "evidence": [
          {
            "description": "A new AD FS signing certificate is added where the certificate's thumbprint matches a known-bad list, or its properties (e.g., subject/issuer entropy, validity period) deviate significantly from an established baseline of legitimate certificates.",
            "data_sources": [
              "Windows Event ID 259",
              "Windows Event ID 4104"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Active Directory Federation Services (AD FS) servers",
            "action": [
              "Symbolic: Upon detection of Windows Event ID 259 (AD FS Added Signing Certificate), extract the certificate thumbprint. Compare the thumbprint against a threat intelligence feed of known-malicious indicators. Generate a high-priority alert on any match.",
              "Statistical: For each new certificate detected, calculate the Shannon entropy of its subject and issuer fields. Establish a baseline for these entropy values from all legitimate certificates in the environment over the past 180 days. Flag any new certificate whose entropy score exceeds the 95th percentile of the baseline. Additionally, track the frequency of certificate additions by user account and alert if a non-administrative user performs this action.",
              "Machine Learning: Develop a classification model (e.g., Random Forest) trained on certificate features including validity period, key size, issuer string, subject entropy, and self-signed status. Ingest all new certificates and use the model to score the likelihood of a certificate being malicious. Alert when the maliciousness score surpasses a predefined threshold determined by ROC curve analysis."
            ]
          },
          {
            "description": "An AD FS claim issuance policy is modified (Windows Event ID 501) to include rules that grant high-privilege access (e.g., adding Administrator SID 'S-1-5-32-544') or bypass MFA controls (e.g., adding an 'insidecorpenetwork' claim from an external source).",
            "data_sources": [
              "Windows Event ID 501",
              "Windows Event ID 4104"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Active Directory Federation Services (AD FS) servers",
            "action": [
              "Symbolic: Continuously monitor for Windows Event ID 501. Upon detection, use regular expression matching on the event data to search for the addition of high-privilege SIDs (e.g., 'S-1-5-32-544'), rules containing 'http://schemas.microsoft.com/claims/authnmethodsreferences' with a value of 'http://schemas.microsoft.com/claims/multipleauthn', or logic that creates a new 'insidecorpenetwork' claim. Alert on any matches.",
              "Statistical: For all claim issuance policies, establish a baseline for rule length and complexity (e.g., character entropy). Monitor for modifications (Event ID 501) and alert on changes that cause a statistically significant increase in rule length or entropy (e.g., >3 standard deviations from the mean). Also, baseline which accounts perform these modifications and alert if an account performs this action for the first time.",
              "Machine Learning: Use a supervised learning model (e.g., logistic regression) trained on historical rule changes, labeled via change management records as 'authorized' or 'unauthorized'. The model should use features such as the user performing the change, time of day, and the textual content of the change. Classify new modifications in real-time and alert on any classified as 'unauthorized'."
            ]
          },
          {
            "description": "A domain trust modification event (Windows Event ID 4703) is followed within a short time window by a statistically significant increase in cross-domain authentication activity (Windows Event ID 4624, Logon Type 3) from the newly trusted domain.",
            "data_sources": [
              "Windows Event ID 4703",
              "Windows Event ID 4624",
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, Network traffic flow points between domain security boundaries",
            "action": [
              "Symbolic: Create a correlation rule that triggers if a trust modification event (Windows Event ID 4703) is followed within 60 minutes by a successful network logon (Windows Event ID 4624, Logon Type 3) to a high-value asset (e.g., Domain Controller, primary database server) from an account in the newly trusted domain. Enrich with Zeek conn.log to confirm the source/destination IPs align with the domains in question.",
              "Statistical: Upon a new or modified trust (Event ID 4703), baseline the hourly volume of cross-domain authentications (Event ID 4624, Type 3) from the source domain over the subsequent 24 hours. Compare this to the average baseline volume for previously established legitimate trusts. An authentication volume exceeding the 99th percentile of the historical baseline indicates potential abuse and should generate an alert.",
              "Machine Learning: Implement a time-series anomaly detection model (e.g., ARIMA or Prophet) on the volume of cross-domain authentication events (Type 3 logons). Use the occurrence of Event ID 4703 as an exogenous variable. Alert on anomalous spikes in authentications that are temporally linked to the trust modification, indicating a deviation from the forecasted authentication volume."
            ]
          },
          {
            "description": "A domain's authentication method is changed from 'Managed' to 'Federated' by an unauthorized account, from an unusual source system, or outside of a scheduled change window.",
            "data_sources": [
              "Windows Event ID 307",
              "Windows Event ID 510",
              "Windows Event ID 4688",
              "Windows Event ID 4104"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, AD FS Servers, Administrator Workstations",
            "action": [
              "Symbolic: Maintain an explicit allow-list of administrative accounts authorized to perform federation changes. Alert on any execution of 'Set-MsolDomainFederationSettings' or 'Update-MSOLFederatedDomain' (detected via Event ID 4688/4104) or generation of Event IDs 307/510 by any account not on this list. Correlate with change management tickets to reduce false positives.",
              "Statistical: Analyze the timestamps of all historical federation setting changes to establish a baseline of normal activity (e.g., 9 AM-5 PM on weekdays). Use percentile analysis to identify changes occurring at anomalous times (e.g., outside the 5th-95th percentile of historical change times). Alert on any such outlier activity.",
              "Machine Learning: Deploy a UEBA model that creates a behavioral profile for each privileged administrator. If an administrator who normally manages Exchange servers suddenly modifies federation settings from a workstation they have never used before, the model should flag this deviation as a high-risk anomaly, even if the account holds the necessary permissions."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk",
      "Ask Sage"
    ]
  },
  {
    "information_requirement": "Is the adversary modifying trust relationships for defense evasion? (PIR)",
    "tactic_id": "TA0005",
    "tactic_name": "Defense Evasion",
    "indicators": [
      {
        "technique_id": "T1484.002",
        "name": "Trust Modification",
        "evidence": [
          {
            "description": "AD FS or Azure AD federation settings are modified to add a trusted realm URI where the domain is newly registered, has high character entropy, or matches a known-malicious indicator.",
            "data_sources": [
              "Windows Event ID 307",
              "Windows Event ID 510",
              "Windows Event ID 4104",
              "Zeek dns.log",
              "Zeek intel.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "AD FS Servers, Domain Controllers, DNS Servers, Network Gateways",
            "action": [
              "Symbolic: Extract any URI added as a trusted realm from PowerShell logs (Event ID 4104) or AD FS configuration logs (Event ID 307/510). Compare the domain against a threat intelligence feed of known-malicious domains using a SIEM integration or by checking Zeek intel.log hits. Alert on any match.",
              "Statistical: For each new issuer URI, query passive DNS or WHOIS data to check the domain's registration age. A domain registered within the last 30 days is statistically suspicious for use as a federation endpoint and should be alerted on. Additionally, calculate the character entropy of the hostname and flag any value that exceeds the 95th percentile of known-good issuer URIs in your environment.",
              "Machine learning: Utilize a pre-trained machine learning model, such as a DGA (Domain Generation Algorithm) detector, that classifies domains as benign or malicious based on lexical features (length, character distribution, n-grams). Score every new issuer URI and alert if the maliciousness probability is high."
            ]
          },
          {
            "description": "Execution of PowerShell cmdlets like 'Update-MSOLFederatedDomain' or 'Set-MsolDomainFederationSettings' occurs with parameter values that specify a foreign or non-standard token-signing certificate or issuer URI.",
            "data_sources": [
              "Windows Event ID 4688",
              "Windows Event ID 4104"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "AD FS Servers, Domain Controllers, Administrator Workstations",
            "action": [
              "Symbolic: Use regular expressions on PowerShell Script Block logs (Event ID 4104) to detect 'Update-MSOLFederatedDomain' or 'Set-MsolDomainFederationSettings'. Flag any invocation where the '-IssuerUri' parameter contains a domain not on an allow-list of corporate and partner domains, or where the '-SigningCertificate' parameter is used to inject a certificate not issued by the internal PKI.",
              "Statistical: Create a frequency distribution of all parameter combinations used with these cmdlets based on 90 days of historical data. An execution using a statistically rare parameter (e.g., a parameter seen in <1% of invocations) or a rare combination of parameters should be flagged for manual review.",
              "Machine Learning: Train an anomaly detection model (e.g., Isolation Forest) on the feature set of command executions, including command name, parameters used, user, and source host. This can identify novel or unusual invocations that deviate from established administrative patterns and may represent malicious activity."
            ]
          },
          {
            "description": "A privileged account modifies a domain trust from a geographically anomalous location or at an unusual time, and this action is not correlated with any authorized change request in the organization's ticketing system.",
            "data_sources": [
              "Windows Event ID 4703",
              "Windows Event ID 307",
              "Windows Event ID 4624",
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, AD FS Servers, VPN Concentrators, Cloud Access Security Broker (CASB)",
            "action": [
              "Symbolic: Geofence all privileged access. If a logon event (Windows Event ID 4624) immediately preceding a trust modification (e.g., Event ID 4703, 307) originates from an IP address which geo-locates to a country outside of an approved list, generate a high-priority alert. Enrich the IP with Zeek conn.log data to confirm it is an external IP.",
              "Statistical: For each privileged user, build a baseline of normal login times and source IP subnets/countries using at least 30 days of Zeek conn.log and Windows Event ID 4624 data. Use a scoring system: add risk points if a trust modification is preceded by a login that is >2 standard deviations from the user's mean login time or originates from a country they have not logged in from in the last 90 days. Alert if the total risk score exceeds a defined threshold.",
              "Machine Learning: Employ a UEBA platform or a custom-built anomaly detection model (e.g., One-Class SVM) to model each privileged user's session behavior. The model should ingest features like login time, source IP/ASN, commands run, and resources accessed. A trust modification action occurring within a session flagged as anomalous by the model warrants immediate investigation."
            ]
          },
          {
            "description": "An anomalous pattern of network connections, such as an unusually high connection count or data volume, from an AD FS server to external identity provider IP addresses occurs within minutes of a trust modification event.",
            "data_sources": [
              "Zeek conn.log",
              "Zeek ssl.log",
              "Windows Event ID 307",
              "Windows Event ID 501"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "AD FS Servers, Network Perimeter Firewalls, DNS Servers",
            "action": [
              "Symbolic: Create a rule that alerts if a trust modification event (e.g., Event ID 307, 501) on an AD FS server is followed within 5 minutes by an outgoing SSL/TLS connection (from Zeek ssl.log) from that server to a destination IP whose associated SNI is not on a pre-approved list of known IdP endpoints.",
              "Statistical: Baseline the hourly volume of data transferred (sum of 'orig_bytes' and 'resp_bytes' from Zeek conn.log) from AD FS servers to external IdP endpoints. Alert if a data transfer spike >3 standard deviations above the baseline occurs within 30 minutes following a trust modification event.",
              "Machine Learning: Implement a time-series forecasting model (e.g., Prophet) on the count of new connections per minute from AD FS servers to external IdPs. If the actual connection count significantly exceeds the model's forecast (i.e., falls outside the 99% prediction interval) within a short window after a trust modification event is logged, flag it as a correlated anomaly indicative of an adversary testing or exploiting the new trust."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk",
      "Ask Sage"
    ]
  }
]