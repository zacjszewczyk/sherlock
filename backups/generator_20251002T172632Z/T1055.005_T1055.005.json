[
  {
    "information_requirement": "Is the adversary attempting privilege escalation using thread local storage callbacks?",
    "tactic_id": "TA0004",
    "tactic_name": "Privilege Escalation",
    "indicators": [
      {
        "technique_id": "T1055.005",
        "name": "Thread Local Storage",
        "evidence": [
          {
            "description": "A process with a known malicious SHA256 hash, as identified by threat intelligence, requests a handle with write or execute permissions (e.g., PROCESS_VM_WRITE, PROCESS_VM_OPERATION, PROCESS_CREATE_THREAD) to a critical system process such as lsass.exe, services.exe, or csrss.exe.",
            "data_sources": [
              "Windows Event ID 4656",
              "Windows Event ID 4688",
              "Sysmon Event ID 10",
              "Sysmon Event ID 1"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, Critical Application Servers, Privileged User Workstations",
            "action": [
              "Symbolic: Query for handle requests (Windows Event ID 4656 or Sysmon Event ID 10) where the target process is a privileged system process (lsass.exe, services.exe, wininit.exe) and the 'Accesses' or 'GrantedAccess' field contains flags for memory writing or thread creation (e.g., PROCESS_VM_WRITE (0x0020), PROCESS_VM_OPERATION (0x0008), PROCESS_CREATE_THREAD (0x0002)). Join the source 'Process ID' with process creation events (Windows Event ID 4688 or Sysmon Event ID 1) to retrieve the source executable's hash. Alert if this hash matches a known-bad indicator from threat intelligence feeds.",
              "Statistical: For all handle requests to privileged processes (Event ID 4656/Sysmon 10), calculate the Shannon entropy of the source process path string. Establish a baseline of normal entropy values by profiling legitimate system interactions over 30 days. Flag any source process path with an entropy score in the top 98th percentile as suspicious, indicating potential randomization or obfuscation used to evade path-based detections.",
              "Machine Learning: Develop a logistic regression model trained on labeled historical data (Sysmon Events 1, 10). Features should include: source process path entropy, source process command-line length and entropy, a boolean for whether the source process is signed, a one-hot encoded vector for requested access rights, a boolean for if the target process is privileged, and parent process name of the source process. Use the model to classify each handle request event with a probability score of being malicious. Alert on events with a score greater than $$ P(malicious) > 0.9 $$."
            ]
          },
          {
            "description": "An unsigned process or a process not signed by a trusted publisher requests a handle with write/execute access to a privileged process, and within 60 seconds, the targeted privileged process initiates an outbound network connection or spawns an unexpected child process (e.g., cmd.exe, powershell.exe).",
            "data_sources": [
              "Windows Event ID 4656",
              "Sysmon Event ID 10",
              "Windows Event ID 5156",
              "Sysmon Event ID 3",
              "Windows Event ID 4688",
              "Sysmon Event ID 1",
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, Enterprise DNS Servers, Network Egress Points",
            "action": [
              "Symbolic: Create a rule that triggers on a handle request (Event ID 4656/Sysmon 10) to a privileged process from an unsigned source process (validated via Sysmon Event ID 1). Correlate by the target process's PID. If a network connection (Event ID 5156/Sysmon 3/Zeek conn.log) or process creation (Event ID 4688/Sysmon 1) event originates from that target PID within 60 seconds, generate a high-severity alert.",
              "Statistical: For each privileged process (e.g., lsass.exe), build a historical baseline of normal child processes and network destination IPs/ports over 30 days. Following a write-access handle request (Event ID 4656/Sysmon 10) to a privileged process, monitor for subsequent activity from the target's PID. If the target spawns a child process or connects to a destination IP that is statistically rare (e.g., in the bottom 1% of historical frequency), flag the sequence as a potential injection.",
              "Machine Learning: Use a time-series anomaly detection model (e.g., Prophet, LSTM) to monitor the volume of outbound bytes and the count of unique destination IPs for each critical process. A statistically significant, unexplained spike in either metric that is temporally correlated with a preceding write-access handle request (Event ID 4656/Sysmon 10) to that process should be classified as an anomaly."
            ]
          },
          {
            "description": "A critical system process that typically does not initiate network connections (e.g., lsass.exe, smss.exe, wininit.exe) is observed making an outbound network connection to an external IP address.",
            "data_sources": [
              "Windows Event ID 5156",
              "Sysmon Event ID 3",
              "Zeek conn.log",
              "Zeek dns.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Network Egress Points, Domain Controllers, DNS Servers",
            "action": [
              "Symbolic: Create a zero-tolerance rule: Alert on any network connection event (Windows Event ID 5156, Sysmon Event ID 3, or Zeek conn.log) where the source process is 'lsass.exe', 'smss.exe', 'wininit.exe', or 'csrss.exe' and the destination IP is external to the defined corporate network address space.",
              "Statistical: For system processes that may have legitimate but rare network activity (e.g., services.exe), monitor for connections that are statistical outliers. Use a Z-score calculation on the daily connection count per destination port. A score of $$ Z > 3 $$ to a non-standard port indicates a potential anomaly. Correlate with DNS lookups for domains with an age of less than 30 days in Zeek dns.log.",
              "Machine Learning: Implement a one-class SVM (Support Vector Machine) model trained only on legitimate network connections from system processes. Any new connection that falls outside the learned boundary of 'normal' is classified as an anomaly. Features for the model can include destination port, protocol, bytes sent, connection duration, and the JA3 hash from Zeek ssl.log."
            ]
          },
          {
            "description": "A process executing from a user-writable directory (e.g., C:\\Users\\*\\AppData\\*, C:\\ProgramData\\*, C:\\PerfLogs\\) or a masquerading path (e.g., C:\\Windows\\temp\\svchost.exe) requests a handle with full access rights (PROCESS_ALL_ACCESS) to a privileged process.",
            "data_sources": [
              "Windows Event ID 4656",
              "Sysmon Event ID 10",
              "Windows Event ID 4688",
              "Sysmon Event ID 1"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User Workstations, Terminal Servers, Application Servers",
            "action": [
              "Symbolic: Correlate handle request events (Event ID 4656/Sysmon 10) with process creation events (Event ID 4688/Sysmon 1) using the source Process ID. Alert if the source process path matches a regex for suspicious locations (e.g., `^C:\\\\Users\\\\.*`, `^C:\\\\ProgramData\\\\.*`, `^C:\\\\Temp\\\\.*`) and the handle request targets a privileged process with high-privilege access masks like PROCESS_ALL_ACCESS (0x1F0FFF).",
              "Statistical: Calculate the frequency of all source process paths that request handles to privileged processes. Paths that fall below a 5th percentile frequency threshold are considered rare. Alert when a process from a rare path requests write or execute access to a privileged process. This approach helps find outliers without predefining 'bad' paths.",
              "Machine Learning: Use a clustering algorithm (e.g., DBSCAN) on process execution events (Sysmon 1), using features like tokenized process path, parent process name, and command-line arguments. Identify clusters of anomalous execution behavior. If a process from an anomalous cluster subsequently requests a handle to a privileged process (Sysmon 10), raise a high-confidence alert."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk"
    ]
  },
  {
    "information_requirement": "Is the adversary attempting defense evasion using thread local storage callbacks?",
    "tactic_id": "TA0005",
    "tactic_name": "Defense Evasion",
    "indicators": [
      {
        "technique_id": "T1055.005",
        "name": "Thread Local Storage",
        "evidence": [
          {
            "description": "A process with a SHA256 hash matching a known-malicious indicator requests a handle with write or execute permissions to a commonly abused legitimate host process, such as explorer.exe, svchost.exe, or a web browser process (chrome.exe, firefox.exe), to mask its activity.",
            "data_sources": [
              "Windows Event ID 4656",
              "Sysmon Event ID 10",
              "Windows Event ID 4688",
              "Sysmon Event ID 1"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "All Enterprise Workstations and Servers, VDI Environments",
            "action": [
              "Symbolic: Upon a process creation event (Event ID 4688/Sysmon 1), check the executable's hash against a threat intelligence feed. If a match is found, create a high-priority watch on that Process ID. Generate an immediate alert if that PID is observed as the source in a handle request event (Event ID 4656/Sysmon 10) targeting common host processes (explorer.exe, svchost.exe) with write or execute access rights.",
              "Statistical: For each common injection target (explorer.exe, svchost.exe), build a profile of the source processes that legitimately request handles to it. Any handle request from a source process name that is statistically rare (e.g., not in the top 95% of frequent requesters) should be flagged for investigation, especially if it requests write access (e.g., GrantedAccess mask includes 0x20).",
              "Machine Learning: Train a Random Forest classifier to predict if a handle request is malicious. Features should include: source process name, source process path, parent of source process, command-line arguments of source process, signature status of source process, and the requested access mask. Use the model to score all requests to high-value injection targets like 'explorer.exe' and 'svchost.exe', alerting on scores above a tuned threshold."
            ]
          },
          {
            "description": "Following a handle request with write access to a target process (e.g., explorer.exe), that target process spawns an unusual child process, such as a command-line interpreter (cmd.exe, powershell.exe) or script interpreter (cscript.exe, wscript.exe).",
            "data_sources": [
              "Windows Event ID 4656",
              "Sysmon Event ID 10",
              "Windows Event ID 4688",
              "Sysmon Event ID 1"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User Workstations, Terminal Servers",
            "action": [
              "Symbolic: Create a rule that triggers when a write-access handle request (Event ID 4656/Sysmon 10) to a process like 'explorer.exe' is observed. If this is followed within 60 seconds by a process creation event (Event ID 4688/Sysmon 1) where the 'Parent Process ID' matches the 'Target Process ID' from the handle request, and the 'New Process Name' is a shell (cmd.exe, powershell.exe, pwsh.exe), generate an alert.",
              "Statistical: For each common process (explorer.exe, chrome.exe), generate a frequency distribution of its immediate child processes over a 30-day baseline period. Following a write-access handle request to one of these processes, if it spawns a child process that falls in the bottom 5th percentile of historical frequency, flag the parent-child relationship as anomalous and worthy of investigation.",
              "Machine Learning: Use a graph-based anomaly detection algorithm on process lineage data (Sysmon 1). Represent processes as nodes and parent-child relationships as directed edges with attributes (e.g., command line). Identify subgraphs that deviate structurally from the main process graph (e.g., explorer.exe -> powershell.exe -> rundll32.exe). Correlate the appearance of these anomalous subgraphs with preceding handle request events (Sysmon 10) to the root process of the subgraph."
            ]
          },
          {
            "description": "A common user-facing process (e.g., explorer.exe, chrome.exe) initiates a network connection to a suspicious destination, defined as an IP/domain with a poor reputation score, a newly registered domain (e.g., age < 30 days), or a destination with a high-entropy domain name suggestive of a Domain Generation Algorithm (DGA).",
            "data_sources": [
              "Windows Event ID 4688",
              "Sysmon Event ID 1",
              "Sysmon Event ID 3",
              "Zeek conn.log",
              "Zeek dns.log",
              "Zeek ssl.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User Workstations, Network Egress Points, DNS Servers",
            "action": [
              "Symbolic: Continuously enrich Zeek conn.log and dns.log data with threat intelligence feeds for IP/domain reputation and domain age. Generate an alert if a common user-facing process (explorer.exe, chrome.exe) initiates a connection to a destination that is on a blocklist, has a malicious reputation, or was registered within the last 30 days.",
              "Statistical: For each host, maintain a baseline of domains queried (from Zeek dns.log) over a rolling 30-day window. If a process like a browser connects to a domain not in this baseline ('first seen' for the host), calculate the domain's Shannon entropy. Alert on connections to 'first seen' domains with an entropy score in the top 5th percentile of all observed domains, indicating likely DGA.",
              "Machine Learning: Deploy a time-series model (e.g., LSTM autoencoder) for each host, trained on legitimate network traffic patterns (e.g., bytes out, packet count, connection frequency) from common applications. If the observed traffic significantly deviates from the forecasted model (i.e., reconstruction error is high), especially to new destinations or with unusual SSL/TLS fingerprints (JA3/JA3S from Zeek ssl.log), flag it as anomalous behavior potentially caused by code injection."
            ]
          },
          {
            "description": "A non-installer process (e.g., WINWORD.EXE, ACROBAT.EXE) writes a new executable file (.exe, .dll) to disk, and the same process subsequently requests a handle with write access to a common host process (e.g., svchost.exe), indicating a 'drop and inject' sequence.",
            "data_sources": [
              "Sysmon Event ID 11",
              "Windows Event ID 4656",
              "Sysmon Event ID 10",
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "User Workstations, Download Directories, Temporary File Locations",
            "action": [
              "Symbolic: Create a rule that triggers on a file creation event (Sysmon Event ID 11) where the created file is an executable (.dll, .exe) and the creating process (e.g., winword.exe, outlook.exe) is on a list of non-installers. If the same Process ID then generates a handle request (Event ID 4656/Sysmon 10) with write access to another process within 5 minutes, issue a high-severity alert.",
              "Statistical: Build a frequency table of which processes create executable files on disk (from Sysmon Event ID 11). Any process outside the top 95% of common 'creator' processes (e.g., a browser or office application creating a .dll) should be considered anomalous. Increase the anomaly score if the file is written to an unusual location (e.g., C:\\PerfLogs) and if it is followed by a process injection attempt from the same PID.",
              "Machine Learning: Train a Gradient Boosting classifier to identify dropper behavior. Features should include: the name of the process creating the file, the file extension, the target directory of the file write, file entropy, and a boolean indicating if the creating process subsequently attempts process injection within a 5-minute window. A leaf node indicating 'ProcessName=WINWORD.EXE' AND 'FileExtension=.dll' AND 'InjectionAttempt=True' would represent a high-confidence malicious sequence."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk"
    ]
  }
]