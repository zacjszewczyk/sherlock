[
  {
    "information_requirement": "Is the adversary maintaining persistence using AppCert DLLs?",
    "tactic_id": "TA0003",
    "tactic_name": "Persistence",
    "indicators": [
      {
        "technique_id": "T1546.009",
        "name": "AppCert DLLs",
        "evidence": [
          {
            "description": "The HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDLLs registry key is modified to include a DLL path or filename whose hash or name matches a known malicious indicator.",
            "data_sources": [
              "Windows Event ID 4657",
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, Tier 0 Servers, Executive Workstations",
            "action": [
              "Create a rule that triggers on any modification to `HKLM\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDLLs` (Windows Event ID 4657). Extract the new DLL path, retrieve the file hash, and compare the DLL name and hash against a threat intelligence feed of known malicious indicators. Generate a high-severity alert on any match.",
              "For each modification to the AppCertDLLs key, calculate the string entropy of the new DLL file path. Establish a baseline of entropy scores for legitimate AppCert DLLs in the environment (e.g., from known good software installations). Alert on any new DLL path with an entropy score exceeding the 95th percentile of the baseline, suggesting a randomized or obfuscated name.",
              "Train a classification model (e.g., Random Forest) on features from AppCertDLLs modification events, including the parent process name, path characteristics (length, special characters, entropy), and historical frequency of the writing process. Use the model to predict the likelihood that a modification is malicious and alert on high-probability events."
            ]
          },
          {
            "description": "A file creation event for a DLL (.dll) occurs in a world-writable directory (e.g., %TEMP%, C:\\Users\\Public, C:\\ProgramData), and within 5 minutes, a registry modification event points the AppCertDLLs key to this newly created file.",
            "data_sources": [
              "Windows Event ID 4663",
              "Windows Event ID 4657",
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Standard User Workstations, Multi-user Servers (e.g., Citrix, RDS)",
            "action": [
              "Create a correlation rule that triggers when a file creation event for an object ending in `.dll` (Windows Event ID 4663 with Object Type 'File') in a directory like `C:\\ProgramData` or `%TEMP%` is followed within 5 minutes by a registry modification (Windows Event ID 4657) to `AppCertDLLs` where the new value contains the path to that DLL. Match on the `Host` and `SubjectLogonId` fields.",
              "Establish a baseline of common processes that write DLLs to temporary directories. For any DLL write event in a temp directory followed by an AppCertDLLs modification, calculate the rarity of the parent process (ProcessName from Event ID 4688) performing this sequence. Alert if the process's frequency for this behavior falls below the 5th percentile, indicating it is an extremely rare action for that process.",
              "Use a sequence analysis model (e.g., Hidden Markov Model) to learn common event chains on endpoints. Define 'DLL write to temp' and 'AppCertDLLs mod' as states. Flag any transition between these states that has a low probability under the trained model, indicating an anomalous and potentially malicious sequence of actions."
            ]
          },
          {
            "description": "Within one hour of an AppCertDLLs registry modification, a common process (e.g., explorer.exe, svchost.exe) initiates an outbound network connection to a destination IP address not seen in the last 30 days, or spawns a command-line interpreter (e.g., cmd.exe, powershell.exe).",
            "data_sources": [
              "Windows Event ID 4657",
              "Windows Event ID 4688",
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "All Endpoints and Servers, Internet Gateway, DNS Servers",
            "action": [
              "After an alert for an AppCertDLLs modification (Event ID 4657), pivot to the affected host. Search for subsequent process creation events (Event ID 4688) where a common parent process (e.g., `explorer.exe`, `lsass.exe`) spawns a child process such as `cmd.exe`, `powershell.exe`, or `rundll32.exe`. Alert on this specific parent-child relationship if it is not on an approved allow list.",
              "For a host with a recent AppCertDLLs modification, monitor all outbound TLS connections (`Zeek conn.log`). For each connection, calculate the JA3 hash and compare it to a baseline of common JA3 hashes for that host and process. Alert if the JA3 hash is in the bottom 5% of observed hashes (i.e., highly rare), suggesting a non-standard client library was loaded.",
              "Implement a time-series anomaly detection model (e.g., LSTM) on key network metrics per host, such as bytes out, connection count, and destination port entropy. After an AppCertDLLs modification event, feed subsequent network data from that host into the model. Alert if the model flags a significant deviation from the forecasted behavior."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.2",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk"
    ]
  },
  {
    "information_requirement": "Has the adversary escalated privileges using AppCert DLLs?",
    "tactic_id": "TA0004",
    "tactic_name": "Privilege Escalation",
    "indicators": [
      {
        "technique_id": "T1546.009",
        "name": "AppCert DLLs",
        "evidence": [
          {
            "description": "An AppCertDLLs registry modification (Event ID 4657) occurs, and within 10 minutes on the same host, a user account creation event (Event ID 4720) or group membership change event (Event ID 4732/4728) adds a user to a privileged group (e.g., 'Administrators', 'Domain Admins').",
            "data_sources": [
              "Windows Event ID 4657",
              "Windows Event ID 4720",
              "Windows Event ID 4732",
              "Windows Event ID 4728"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, Identity and Access Management Systems, Critical Servers",
            "action": [
              "Create a correlation rule that triggers when an `AppCertDLLs` modification (Event ID 4657) is followed within 10 minutes on the same host by a user being added to a high-privilege group (Event IDs 4732, 4728). The rule should specifically check for target group names like 'Administrators', 'Domain Admins', or 'Enterprise Admins'.",
              "Maintain a baseline of which administrator accounts and processes typically perform privileged group modifications. Following an `AppCertDLLs` modification, if a subsequent privileged group change is initiated by a user or process that has never performed this action before (or does so with a frequency below the 1st percentile), generate an alert.",
              "Develop a risk scoring model for user accounts. An `AppCertDLLs` modification on a host associated with a user is a feature that increases their risk score. If that user's account is then used to perform a privileged action (like adding a user to an admin group), the combined risk score would cross a threshold and trigger a high-fidelity alert."
            ]
          },
          {
            "description": "Within 5 minutes of an AppCertDLLs registry modification, a new process is created (Event ID 4688) with SYSTEM integrity level (e.g., lsass.exe, wininit.exe) which then spawns a child process of cmd.exe or powershell.exe.",
            "data_sources": [
              "Windows Event ID 4657",
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, All Windows Servers, Privileged Access Workstations",
            "action": [
              "Create a rule that triggers when an `AppCertDLLs` modification (Event ID 4657) is followed by a process creation event (Event ID 4688) where the `ParentProcessName` is a high-integrity system process (e.g., `services.exe`, `lsass.exe`, `winlogon.exe`) and the `NewProcessName` is `cmd.exe` or `powershell.exe`.",
              "Profile all parent-child process relationships across the enterprise and calculate the conditional probability $$ P(Child | Parent) $$. Following an `AppCertDLLs` modification, if a parent-child creation event occurs where $$ P(Child | Parent) $$ is below a low threshold (e.g., <0.01%), flag it as a rare and suspicious process chain indicative of injected code execution.",
              "Use a graph-based anomaly detection algorithm on process lineage data. Represent processes as nodes and parent-child relationships as directed edges. After an `AppCertDLLs` modification, analyze the subgraph of newly created processes. Flag any new edges (parent-child relationships) that connect previously disconnected components of the process graph, indicating a malicious DLL has bridged two unrelated process trees."
            ]
          },
          {
            "description": "A registry modification to AppCertDLLs (Event ID 4657) is performed by a process whose parent is a common user application like WINWORD.EXE, EXCEL.EXE, CHROME.EXE, msedge.exe, or AcroRd32.exe.",
            "data_sources": [
              "Windows Event ID 4657",
              "Windows Event ID 4688"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "All User Endpoints, Virtual Desktop Infrastructure (VDI)",
            "action": [
              "Create a high-priority alert for any successful modification to `HKLM\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDLLs` (Event ID 4657) where the `ProcessName` that performed the change has a parent process (from Event ID 4688 with process command-line logging enabled) in a watchlist of common user applications (e.g., `outlook.exe`, `winword.exe`, browsers).",
              "For every process that modifies the `AppCertDLLs` key, track its integrity level from the event data. Establish a baseline; this modification should only be performed by high or system integrity processes (e.g., from installers like `msiexec.exe`). Alert if a modification is performed by a process running at a medium or low integrity level.",
              "Train a decision tree classifier to determine if a registry write is suspicious based on the process lineage. Features would include the process name, its parent, its grandparent, and their integrity levels. A write to `AppCertDLLs` by a process tree originating from a browser would be classified as highly suspicious."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.2",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk"
    ]
  }
]