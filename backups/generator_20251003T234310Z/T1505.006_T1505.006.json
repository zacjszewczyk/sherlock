[
  {
    "information_requirement": "Is an adversary maintaining persistence on ESXi hypervisors using malicious vSphere Installation Bundles (VIBs)?",
    "tactic_id": "TA0003",
    "tactic_name": "Persistence",
    "indicators": [
      {
        "technique_id": "T1505.006",
        "name": "vSphere Installation Bundles",
        "evidence": [
          {
            "description": "A file with a `.vib` or `.vgz` extension is transferred over the network to an ESXi host, and the file's SHA256 hash matches an entry on a threat intelligence feed of known-malicious VIBs.",
            "data_sources": [
              "Zeek files.log",
              "Zeek conn.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Network traffic sensors monitoring traffic to and from the ESXi management network (vmk0 interfaces) and vCenter servers.",
            "action": [
              "Symbolic: In Zeek files.log, for any file transfer where the filename ends in `.vib` or `.vgz`, extract the SHA256 hash. Correlate with Zeek conn.log to confirm the destination IP is a known ESXi host. Compare the extracted hash against a threat intelligence feed of malicious file hashes. Generate a high-severity alert on a match.",
              "Statistical: Analyze Zeek files.log and conn.log to build a historical baseline of source IPs that transfer VIB files to ESXi hosts. Calculate the frequency of each source IP. Flag any VIB transfer originating from a source IP that falls in the bottom 5th percentile of transfer frequency, as this indicates a rare and potentially unauthorized source.",
              "Machine Learning: Train a classification model (e.g., Random Forest) on VIB transfer events using features from Zeek logs such as file size, source/destination subnet, protocol, MIME type, time of day, and day of week. Label historical data as 'benign' (from known vCenter/management IPs) or 'malicious'. Use the trained model to classify new VIB transfers and alert on those predicted as 'malicious'."
            ]
          },
          {
            "description": "A command line executed on a vCenter server or administrative host contains `esxcli` arguments that bypass security controls, such as `software vib install --force`, `software vib install --no-sig-check`, or `software acceptance set --level=CommunitySupported`.",
            "data_sources": [
              "Windows Event ID 4688",
              "Linux auditd logs"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Command line logging on vCenter Server Appliances (VCSA), Windows-based vCenter servers, and administrative jump boxes with VMware PowerCLI or other management tools installed.",
            "action": [
              "Symbolic: Monitor Windows Event ID 4688 (Process Creation) and Linux auditd logs for command lines containing `esxcli` and any of the following strings: '--force', '--no-sig-check', or 'acceptance set --level=CommunitySupported'. Generate an immediate high-severity alert on any match.",
              "Statistical: For each administrative user, establish a baseline of `esxcli` command argument usage from historical command line logs. Calculate the rarity of each argument combination. Flag any execution of a VIB-related command (`software vib install`, `software acceptance set`) that uses an argument combination seen in less than 1% of that user's historical commands.",
              "Machine Learning: Employ a sequence analysis model (e.g., Hidden Markov Model) to learn normal sequences of `esxcli` commands from trusted change management records. A sequence such as `esxcli network firewall set --enabled false` -> `esxcli software vib install --force` -> `esxcli network firewall set --enabled true` would have a very low probability under a benign model and should be flagged as a highly anomalous and suspicious sequence of actions."
            ]
          },
          {
            "description": "An ESXi host initiates a DNS query for a low-reputation domain or establishes an outbound network connection to an external IP on an uncommon port, within 60 minutes of a VIB installation or a host reboot event.",
            "data_sources": [
              "Zeek conn.log",
              "Zeek dns.log",
              "VMware vCenter event logs"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "ESXi host management interfaces (vmk0), network perimeter firewalls, DNS server logs, and vCenter server event logs.",
            "action": [
              "Symbolic: Correlate vCenter reboot or VIB installation events with subsequent network logs. Alert if an ESXi host's IP queries a domain on a DNS blocklist (Zeek dns.log) or connects to a destination IP on a C2 threat feed (Zeek conn.log) within an hour of the event.",
              "Statistical: For each ESXi host, baseline the set of destination ports used for outbound connections. After a reboot or VIB install event, monitor for new connections. Flag any connection to a port that falls outside the 99.9th percentile of historically used ports for that specific host, indicating a statistically rare and potentially malicious connection.",
              "Machine Learning: Use time series analysis (e.g., SARIMA) to model the expected volume of outbound data (`orig_bytes` in Zeek conn.log) from each ESXi host. Generate an anomaly score when the observed traffic volume significantly deviates from the forecast. Raise an alert if a high anomaly score occurs within 60 minutes of a VIB installation or host reboot logged in vCenter."
            ]
          },
          {
            "description": "A VIB file is transferred to an ESXi host from a source IP address not present on an allowlist of approved vCenter servers, management hosts, or official VMware update repositories.",
            "data_sources": [
              "Zeek files.log",
              "Zeek conn.log",
              "Zeek http.log"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Network taps monitoring traffic between administrative subnets and the ESXi management network; perimeter firewall logs showing traffic to and from VMware update domains.",
            "action": [
              "Symbolic: Maintain an allowlist of authorized source IPs for VIB transfers (e.g., vCenter, update servers). Correlate Zeek files.log (for `.vib` or `.vgz` transfers) with Zeek conn.log. Generate an alert if the source IP of the transfer is not on the authorized allowlist.",
              "Statistical: Analyze the `User-Agent` string from Zeek http.log for VIB file downloads. Establish a baseline of legitimate user agents used by VMware tools. Flag any download where the user agent is rare or associated with scripting tools (e.g., `curl`, `wget`, `python-requests`), defined as any agent falling below a 1% frequency threshold among all VIB downloads.",
              "Machine Learning: Use a density-based clustering algorithm (e.g., DBSCAN) on network connection features (source IP, destination port, protocol, file size, JA3 hash) for all VIB file transfers. Benign, automated transfers from a central vCenter should form a dense cluster. Automatically flag any transfer that is classified as a noise point or outlier, as it represents a deviation from established patterns."
            ]
          },
          {
            "description": "An `esxcli software vib install` command is executed by a user account not belonging to the 'ESXi Admins' group, or the command is executed outside of a pre-defined maintenance window.",
            "data_sources": [
              "Windows Event ID 4688",
              "Linux auditd logs",
              "Active Directory security logs"
            ],
            "data_platforms": [
              "TBD"
            ],
            "nai": "Domain Controllers, administrative workstations, vCenter servers (Windows and VCSA), and change management databases or ticketing systems that define maintenance windows.",
            "action": [
              "Symbolic: For each `esxcli software vib install` command detected (Windows Event ID 4688 or Linux auditd), query Active Directory to verify the executing user's group membership. Cross-reference the event timestamp against a list of approved maintenance windows. Generate an alert if the user is not in an authorized group or if the activity occurs outside a maintenance window.",
              "Statistical: For each authorized administrator, model their typical activity hours using historical login and command execution data. Calculate the Z-score for the time of any `esxcli software vib install` command relative to the user's own baseline. Flag any command execution that is more than 3 standard deviations from the user's mean activity hour.",
              "Machine Learning: Train a classification model (e.g., a Gradient Boosting Machine) to predict if a VIB installation is 'authorized' or 'unauthorized'. Use features such as user account role, source hostname, time of day, day of week, and whether the activity was preceded by an anomalous login (e.g., impossible travel). Label training data using change management records. Deploy the model to score and flag new VIB installations in real-time."
            ]
          }
        ]
      }
    ],
    "last_updated": "2025-09-30",
    "version": "2.3",
    "date_created": "2025-05-04",
    "contributors": [
      "Zachary Szewczyk",
      "Ask Sage"
    ]
  }
]